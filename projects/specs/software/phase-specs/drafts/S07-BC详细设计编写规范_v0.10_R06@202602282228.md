# 1 总则

+   文档编号：S07
+   文档名称：BC详细设计编写规范
+   目的：规定BC详细设计文档的章节结构、内容要求和编写模板，指导各设计单元的详细设计编写
+   范围：BC详细设计文档（文档编号07-BC详细设计）
+   管理要点：12章正文结构、三表模型、五件套接口设计、追溯链设计、分版本展开策略
+   文档密级：【商密二级】 -- 外发必追责。

# 2 BC详细设计综述

## 2.1 BC详细设计在研发过程中的定位

BC详细设计是软件研发过程中的第7阶段文档，承接BC总体设计，为编码实现提供完整的技术蓝图。

```
┌─────────────────────────────────────────────────────────────┐
│           BC详细设计在研发过程中的定位                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   输入                    阶段7                 输出        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ 06-BC总体设计│───▶│              │───▶│ 07-BC详细设计│   │
│  │ 05-详细需求  │    │  BC详细设计  │    │              │   │
│  │              │    │              │    └──────┬───────┘   │
│  └──────────────┘    └──────────────┘           │           │
│                                                 ▼           │
│                                          ┌──────────────┐   │
│                                          │ 编码实现阶段 │   │
│                                          └──────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 2.2 BC详细设计的输入项

| 输入文档       | 提供内容                                                     | 使用方式                     |
| -------------- | ------------------------------------------------------------ | ---------------------------- |
| 06-BC总体设计  | BC边界、聚合划分、架构决策、技术选型、公共规范               | 作为设计约束，各章节引用     |
| 05-详细需求    | User Story、业务规则、场景描述                               | 作为需求来源，建立追溯链     |
| 04-系统设计    | 系统架构、BC间协作关系、数据隔离策略                         | 作为上下文约束，必要时引用   |
| 03-领域设计    | 领域模型概要、核心概念定义                                   | 作为领域知识背景，必要时引用 |

**表 2-1 输入项清单**

## 2.3 BC详细设计的输出内容

| 输出类别       | 核心产出                                                     | 交付形式                     |
| -------------- | ------------------------------------------------------------ | ---------------------------- |
| 领域模型       | 聚合根、实体、值对象的完整定义（属性、规则、方法）           | 三表模型（每聚合一组）       |
| 业务流程       | 端到端流程、跨组件协作时序、异常处理策略                     | 流程图 + 步骤表 + 异常处理表 |
| 接口契约       | RESTful API、RPC接口、消息接口的完整契约                     | 五件套（API）、降级策略（RPC）|
| 数据模型       | 数据库表结构、字段定义、索引设计、领域模型到数据模型的映射   | DDL + 映射表 + ER图          |
| 前端交互       | 页面结构、功能说明、搜索条件、列表字段、页面与接口映射       | 线框图 + 功能说明表          |
| 工程结构       | 包结构、核心类清单、模块划分                                 | 包路径表 + 核心类清单表      |
| 权限设计       | 权限点定义、角色权限矩阵、API权限映射、数据权限规则          | 权限清单表 + 矩阵表          |
| 测试设计       | 测试范围、关键测试用例、测试数据准备方案                     | 测试用例表                   |
| 任务分解       | Task清单、依赖关系、工作量估算                               | Task汇总表 + 依赖关系表      |

**表 2-2 输出内容清单**

## 2.4 裁剪规则

BC详细设计文档的裁剪应基于以下原则：

| 裁剪维度       | 裁剪建议                                                     |
| -------------- | ------------------------------------------------------------ |
| 按BC规模裁剪   | 小BC（< 3个聚合）：可合并"领域模型设计"和"应用层设计"为一章；可省略"后端工程结构设计"章节，在BC总体设计中统一定义 |
| 按版本裁剪     | 当前版本（如P1）：完整展开全部12章；未来版本（如P2、P3）：仅保留概述表和清单表，不展开详细定义 |
| 按设计单元裁剪 | 纯后端服务：可省略"前端交互设计"章节；纯前端应用：可省略"数据模型设计"和"后端工程结构设计"章节 |
| 按技术栈裁剪   | 非DDD架构：可简化"领域模型设计"章节，不强制使用三表模型；非微服务架构：可省略RPC接口设计部分 |

**表 2-3 裁剪建议**

裁剪后应在文档开头明确说明裁剪理由和影响范围。

---

# 第3章 设计约束

## 3.1 输出结构

| 小节               | 输出形式                     | 说明                                       |
| ------------------ | ---------------------------- | ------------------------------------------ |
| 2.1 架构约束引用   | 约束引用表                   | 引用BC总体设计中的架构决策，不重复定义     |
| 2.2 状态机定义     | 状态枚举表 + 转换规则表 + 图 | 宜提供，如适用                             |
| 2.3 并发与幂等策略 | 策略定义表                   | 统一方案，各接口不再逐一重复               |
| 2.4 安全约束       | 安全约束表                   | 引用BC总体设计安全设计，补充本设计单元细节 |

**表 3-1 各小节输出形式**

## 3.2 子节定义

### 3.2.1 架构约束引用表

| 列名               | 说明                                     |
| ------------------ | ---------------------------------------- |
| 约束项             | 架构决策名称（如"分层架构"、"数据隔离"） |
| 引用来源           | BC总体设计的具体章节号                   |
| 对本设计单元的约束 | 一句话说明该决策对本设计单元的具体影响   |

**表 3-2 架构约束引用表列定义**

### 3.2.2 状态机定义

状态机定义由三个产出物组成：状态枚举表、状态转换规则表、状态机图。

**状态枚举表标准列：**

| 列名     | 说明                             |
| -------- | -------------------------------- |
| 状态值   | 枚举常量名（如PENDING_APPROVAL） |
| 状态名称 | 中文名称                         |
| 说明     | 业务含义                         |
| 是否终态 | 是/否                            |

**表 3-3 状态枚举表列定义**

**状态转换规则表标准列：**

| 列名     | 说明                                      |
| -------- | ----------------------------------------- |
| 当前状态 | 转换前的状态值                            |
| 事件     | 触发转换的事件或操作                      |
| 目标状态 | 转换后的状态值                            |
| 守卫条件 | 转换执行的前置条件，无则填"-"             |
| 副作用   | 转换时触发的领域事件或附加操作，无则填"-" |

**表 3-4 状态转换规则表列定义**

状态机图使用ASCII图绘制，节点为状态，有向边为转换，边标签为"事件[守卫条件]"。

### 3.2.3 并发与幂等策略

乐观锁方案说明：指定乐观锁字段名（如version）、冲突检测机制、冲突时的处理方式（如抛出OptimisticLockException → 返回409）。

**幂等性保证表标准列：**

| 列名           | 说明                                            |
| -------------- | ----------------------------------------------- |
| 接口类型       | 写接口/消息消费                                 |
| 幂等键生成规则 | 幂等键的构成方式（如requestId、或业务字段组合） |
| 存储方式       | 幂等键的存储位置（如Redis、数据库唯一索引）     |
| 有效期         | 幂等键的过期时间                                |
| 重复请求处理   | 返回首次执行结果/直接返回成功/返回409           |

**表 3-5 幂等性保证表列定义**

长流程并发控制：如存在长流程（如审批、异步开通），说明分布式锁方案或状态机防重入策略。

### 3.2.4 安全约束表

| 列名     | 说明                                         |
| -------- | -------------------------------------------- |
| 约束项   | 安全要求名称（如"敏感字段加密"、"数据隔离"） |
| 涉及范围 | 受影响的实体、字段或接口                     |
| 实施方式 | 具体加密算法、隔离策略等                     |
| 引用来源 | BC总体设计的具体章节号                       |

**表 3-6 安全约束表列定义**

## 3.3 约束与规则

-   架构约束引用表应以引用为主，不重复BC总体设计已定义的内容；如BC总体设计仅给出概要，本章应补充完整细节
-   状态机属于设计决策，不是需求描述——状态有哪些、如何转换、哪些是终态，应在本章完整定义
-   如BC总体设计已给出完整的状态机定义，本章引用即可；如仅给出概要，本章应补充完整的转换规则表和状态机图
-   并发与幂等策略应给出统一方案，后续第8章接口设计中不再逐一重复说明，仅在需要偏离统一方案时标注差异
-   一个聚合根如有多个独立状态维度，每个维度独立定义状态机

## 3.4 粒度标准

状态机粒度判断：

-   聚合根级别的核心状态 → 应定义状态机
-   仅影响展示的标记型字段（如isRead） → 不需要状态机，在领域模型章节的属性表中说明即可

判断标准：该状态字段是否存在守卫条件约束的转换规则？存在 → 定义状态机；不存在 → 仅作属性处理。

## 3.5 典型示例

状态转换规则表示例：

| 当前状态  | 事件     | 目标状态  | 守卫条件             | 副作用               |
| --------- | -------- | --------- | -------------------- | -------------------- |
| DRAFT     | submit   | PENDING   | 必填字段已填写       | TenantSubmittedEvent |
| PENDING   | approve  | ACTIVE    | 审批人具有审批权限   | TenantApprovedEvent  |
| PENDING   | reject   | DRAFT     | 审批人具有审批权限   | TenantRejectedEvent  |
| ACTIVE    | suspend  | SUSPENDED | 操作人具有管理员权限 | TenantSuspendedEvent |
| SUSPENDED | activate | ACTIVE    | -                    | TenantActivatedEvent |

**表 3-7 状态转换规则表示例**

---


---

# 第4章 概述

## 4.1 输出结构

本章由五个小节组成，每节产出一个独立的信息块。各节的输出形式如下：

| 小节             | 输出形式   | 说明                                         |
| ---------------- | ---------- | -------------------------------------------- |
| 1.1 设计单元定位 | 定义表     | 键值对表格，每行一个定位属性                 |
| 1.2 版本范围     | 版本清单表 | 每行一个版本，标注核心交付内容和状态         |
| 1.3 业务边界     | 双清单表   | "范围内"和"范围外"各一张表                   |
| 1.4 场景索引     | 索引表     | 引用需求文档中的场景定义，不重复展开场景内容 |
| 1.5 术语表       | 术语表     | 仅本设计单元核心术语，与BC总体设计重复的引用 |

**表 4-1 各小节输出形式**

## 4.2 子节定义

### 4.2.1 设计单元定位表

定位表为键值对结构，包含以下字段：

| 字段         | 填写要求                                                           |
| ------------ | ------------------------------------------------------------------ |
| 所属BC       | BC编号 + BC名称                                                    |
| 子领域编号   | 大BC填子领域编号（如SD01），小BC填"本文档覆盖整个BC，无子领域划分" |
| 子领域名称   | 子领域中文名称                                                     |
| 一句话描述   | 不超过40字，说明该设计单元的核心职责                               |
| 核心关注问题 | 列出2~5个该设计单元要解决的关键问题                                |

**表 4-2 设计单元定位表字段定义**

### 4.2.2 版本范围表

| 列名         | 说明                                       |
| ------------ | ------------------------------------------ |
| 版本标识     | 如P1、P2、MVP等                            |
| 核心交付内容 | 一句话概括该版本的设计范围                 |
| 文档状态     | 当前版本标注"完整展开"，未来版本标注"概要" |

**表 4-3 版本范围表列定义**

### 4.2.3 业务边界表

**范围内清单表标准列：**

| 列名     | 说明                             |
| -------- | -------------------------------- |
| 序号     | 顺序编号                         |
| 业务能力 | 属于本设计单元职责的业务能力描述 |

**表 4-4 范围内清单表列定义**

**范围外清单表标准列：**

| 列名     | 说明                                      |
| -------- | ----------------------------------------- |
| 序号     | 顺序编号                                  |
| 业务能力 | 不属于本设计单元职责的业务能力描述        |
| 负责方   | 注明由哪个子领域（编号+名称）或哪个BC负责 |

**表 4-5 范围外清单表列定义**

### 4.2.4 场景索引表

| 列名         | 说明                                   |
| ------------ | -------------------------------------- |
| 场景编号     | 引用需求文档中的场景编号               |
| 场景名称     | 场景中文名称                           |
| 触发者       | 触发该场景的角色或系统                 |
| 版本归属     | 该场景归属的实施版本（如P1）           |
| 需求文档引用 | 需求文档章节号（如"BC详细需求 3.2节"） |

**表 4-6 场景索引表列定义**

### 4.2.5 术语表

| 列名     | 说明                                    |
| -------- | --------------------------------------- |
| 术语     | 中文术语名称                            |
| 英文     | 对应英文名称或缩写                      |
| 简要说明 | 一句话定义                              |
| 来源     | "本设计单元定义"或"引用BC总体设计X.X节" |

**表 4-7 术语表列定义**

## 4.3 约束与规则

-   设计单元定位中的所属BC、子领域编号/名称应与BC总体设计文档中的定义完全一致，不得自行新增或修改
-   场景索引表是引用而非定义——详细的场景描述属于BC详细需求文档的职责，本章不重复展开
-   术语表仅收录本设计单元的核心术语；与BC总体设计术语表重复的术语，在"来源"列标注引用即可，不重复定义
-   大BC应在定位表后补充一段文字，说明本子领域与其他子领域的依赖关系（依赖方向、依赖内容）
-   小BC应在子领域编号字段标注"本文档覆盖整个BC，无子领域划分"，并引用BC总体设计中的判定依据

## 4.4 典型示例

设计单元定位表示例：

| 字段         | 值                                                 |
| ------------ | -------------------------------------------------- |
| 所属BC       | BC-11 租户管理上下文                               |
| 子领域编号   | SD01                                               |
| 子领域名称   | 租户生命周期                                       |
| 一句话描述   | 管理租户从创建到停用的完整生命周期                 |
| 核心关注问题 | 租户如何创建、如何开通、状态如何流转、如何安全停用 |

**表 4-8 设计单元定位表示例**

---


---

# 第5章 业务流程设计

## 5.1 输出结构

本章由两部分组成：流程总览（5.1节）和各流程详细设计（5.2节起，每个流程一个小节）。

### 5.1.1 流程总览表

| 列名           | 说明                                       |
| -------------- | ------------------------------------------ |
| 流程编号       | 格式：FL-{设计单元缩写}-{序号}，如FL-TL-01 |
| 流程名称       | 简短中文名称                               |
| 流程层级       | 一级/二级（三级流程在接口设计章节体现）    |
| 触发场景       | 引用第4章场景索引中的场景编号              |
| 关联User Story | 引用需求文档中的User Story编号             |
| 版本归属       | 该流程归属的实施版本（如P1）               |

**表 5-1 流程清单表列定义**

### 5.1.2 单个流程的标准结构

每个流程按以下四部分依次编写：

| 部分       | 内容                                                 | 当前版本 | 未来版本   |
| ---------- | ---------------------------------------------------- | -------- | ---------- |
| 流程概述   | 流程目标、触发条件、结束条件                         | 必备     | 仅保留概述 |
| 流程图     | 一级流程用活动图/流程图，二级流程用时序图（ASCII图） | 必备     | 仅保留一级 |
| 步骤表     | 流程步骤的详细定义                                   | 必备     | 不展开     |
| 异常处理表 | 异常场景及处理策略                                   | 必备     | 不展开     |

**表 5-2 单个流程标准结构**

## 5.2 子节定义

### 5.2.1 流程概述

流程概述为一段文字，包含以下要素：
-   **流程目标：** 一句话说明该流程要达成的业务目标
-   **触发条件：** 何种事件或操作触发该流程
-   **结束条件：** 流程正常结束的标志

### 5.2.2 步骤表

| 列名         | 说明                                                 |
| ------------ | ---------------------------------------------------- |
| 步骤号       | 顺序编号（1、2、3…），分支用1a/1b表示                |
| 步骤名称     | 简短动宾结构（如"校验租户信息"）                     |
| 执行者       | 执行该步骤的组件或角色（如"租户聚合根"、"应用服务"） |
| 输入         | 该步骤的输入数据或前置条件                           |
| 输出         | 该步骤的输出数据或状态变更                           |
| 业务规则引用 | 引用领域模型中的规则编号（如TN-R-04），无则填"-"     |

**表 5-3 步骤表列定义**

### 5.2.3 异常处理表

| 列名     | 说明                                                  |
| -------- | ----------------------------------------------------- |
| 异常场景 | 异常的触发条件描述                                    |
| 检测时机 | 在哪个步骤检测到该异常（引用步骤号）                  |
| 处理策略 | 重试/补偿/回滚/告警/降级，需具体说明策略细节          |
| 补偿操作 | 需要执行的补偿动作（如回滚状态、释放资源），无则填"-" |
| 最终状态 | 异常处理后实体的目标状态                              |

**表 5-4 异常处理表列定义**

## 5.3 粒度标准

| 层级     | 判断标准                             | 图示工具      | 本章是否展开                    |
| -------- | ------------------------------------ | ------------- | ------------------------------- |
| 一级流程 | 端到端业务流程，涉及多个参与者或组件 | 流程图/活动图 | 展开                            |
| 二级流程 | 跨组件/跨服务协作，关注调用时序      | 时序图        | 展开                            |
| 三级流程 | 单接口内部处理步骤                   | 步骤表        | 不展开（在第8章接口设计中体现） |

**表 5-5 流程层级划分标准**

流程拆分判断：一个业务场景如果包含多个独立的触发时机或不同的参与者组合，应拆分为多个流程；如果所有步骤由同一事件触发并在同一事务中完成，应合并为一个流程。

## 5.4 约束与规则

-   步骤表中的"业务规则引用"列应引用规则编号，不得重复规则内容——规则的完整定义在第6章领域模型设计中
-   异常处理是流程设计的核心价值——正常流程通常直观，关键价值在于明确各类异常场景下的系统行为
-   流程图使用ASCII图绘制，遵循《C02-格式规范》的图块规范
-   未来版本的流程仅保留流程概述和一级流程图，不展开步骤表和异常处理表
-   流程编号格式为 FL-{设计单元缩写}-{序号}，设计单元缩写与BC总体设计中的子领域缩写一致
-   步骤表中的"执行者"应使用领域模型中定义的组件名称，保持术语一致

## 5.5 推导逻辑

流程设计的推导顺序：
1.   从第4章场景索引表出发，为每个场景建立场景→流程的映射，填写流程清单表
2.   确定每个流程的层级（一级/二级），选择对应的图示工具
3.   绘制流程图，识别参与者和关键步骤
4.   细化步骤表，在"业务规则引用"列中引用第6章将定义的规则编号
5.   针对每个步骤，识别可能的异常场景，填写异常处理表
6.   检查异常处理的完备性——每个外部调用、每个状态转换、每个业务规则校验都应有对应的异常处理

## 5.6 典型示例

异常处理表示例：

| 异常场景         | 检测时机 | 处理策略                      | 补偿操作     | 最终状态     |
| ---------------- | -------- | ----------------------------- | ------------ | ------------ |
| 租户名称重复     | 步骤2    | 拒绝操作，返回E-409001        | -            | 无变化       |
| 开通外部服务超时 | 步骤5    | 重试3次，间隔2s/4s/8s指数退避 | 标记为开通中 | PROVISIONING |
| 重试3次仍失败    | 步骤5    | 记录失败原因，发送告警通知    | 回滚为待开通 | PENDING      |
| 乐观锁冲突       | 步骤3    | 返回409，提示用户刷新后重试   | -            | 无变化       |

**表 5-6 异常处理表示例**

---

# 第6章 领域模型设计

## 6.1 输出结构

| 小节               | 输出形式                 | 说明                                 |
| ------------------ | ------------------------ | ------------------------------------ |
| 4.1 聚合概述       | 聚合清单表 + 聚合关系图  | 全局视图，展示聚合间关系             |
| 4.2 各聚合详细定义 | 三表模型（每聚合一组）   | 属性清单表 + 业务规则表 + 业务方法表 |
| 4.3 值对象定义     | 三表模型（每值对象一组） | 无独立业务方法时注明"由聚合根管理"   |
| 4.4 领域服务       | 服务清单表 + 方法定义    | 仅跨聚合操作或需基础设施编排的逻辑   |
| 4.5 领域事件清单   | 事件清单表               | Payload和消费方契约在第8章定义       |

**表 6-1 各小节输出形式**

## 6.2 子节定义

### 6.2.1 聚合清单表

| 列名       | 说明                                 |
| ---------- | ------------------------------------ |
| 聚合根     | 聚合根类名（英文，PascalCase）       |
| 包含实体   | 聚合内实体类名列表，无则填"-"        |
| 包含值对象 | 聚合内值对象类名列表                 |
| 核心不变式 | 一句话描述该聚合维护的业务不变性约束 |

**表 6-2 聚合清单表列定义**

聚合关系图使用ASCII图绘制，聚合用方框表示，聚合间用虚线箭头标注ID引用方向。

### 6.2.2 三表模型

每个聚合根和独立值对象均采用三表模型描述。

**属性清单表标准列：**

| 列名     | 说明                                        |
| -------- | ------------------------------------------- |
| 属性名   | 领域模型中的属性名（camelCase）             |
| 数据类型 | Java类型或值对象类型（如TenantName、Money） |
| 约束     | 必填/可选、长度限制、格式要求、唯一性约束   |
| 默认值   | 默认值或生成策略（如UUID、自增），无则填"-" |
| 业务含义 | 一句话说明该属性的业务语义                  |
| 版本     | 该属性首次引入的版本（如P1）                |

**表 6-3 属性清单表列定义**

**业务规则表标准列：**

| 列名     | 说明                                           |
| -------- | ---------------------------------------------- |
| 规则编号 | 格式：{实体缩写}-R-{序号}，如TN-R-01，全BC唯一 |
| 规则名称 | 简短的规则名（动宾结构）                       |
| 规则简述 | 规则的完整描述，使用"当…→…"或条件表达式        |
| 验证时机 | 创建/更新/状态变更/特定操作                    |
| 违反后果 | 拒绝操作并返回的错误码，或自动修正策略         |
| 版本     | 该规则首次生效的版本                           |

**表 6-4 业务规则表列定义**

**业务方法表标准列：**

| 列名     | 说明                                             |
| -------- | ------------------------------------------------ |
| 方法名   | 方法签名（如activate(OperatorId operator)）      |
| 方法简述 | 一句话描述方法职责                               |
| 关联规则 | 引用业务规则表中的规则编号（如TN-R-01, TN-R-03） |
| 异常     | 可能抛出的领域异常类名                           |
| 事件     | 方法执行成功后发布的领域事件，无则填"-"          |
| 版本     | 该方法首次引入的版本                             |

**表 6-5 业务方法表列定义**

### 6.2.3 值对象补充说明

值对象的三表模型与聚合根一致，区别在于：
-   无独立业务方法的值对象：业务方法表仅写一行，注明"由聚合根管理其生命周期"
-   值对象属性清单表中无需"版本"列，随所属聚合版本

### 6.2.4 领域服务清单表

| 列名         | 说明                                                  |
| ------------ | ----------------------------------------------------- |
| 服务名       | 领域服务类名（英文，PascalCase，以DomainService结尾） |
| 职责简述     | 一句话说明该服务存在的理由                            |
| 所协调的聚合 | 该服务涉及的聚合根列表                                |

**表 6-6 领域服务清单表列定义**

每个领域服务下方附方法定义表：

| 列名         | 说明                                 |
| ------------ | ------------------------------------ |
| 方法签名     | 完整方法签名（含入参类型和返回类型） |
| 业务语义     | 一句话说明业务场景                   |
| 所协调的聚合 | 该方法涉及的聚合根及操作             |
| 关联规则     | 引用业务规则编号                     |

**表 6-7 领域服务方法定义表列定义**

### 6.2.5 领域事件清单表

| 列名     | 说明                                               |
| -------- | -------------------------------------------------- |
| 事件名称 | 命名规则：{Aggregate}{Action}edEvent（过去式动词） |
| 触发时机 | 何时发布（如"租户创建成功后"）                     |
| 发布聚合 | 哪个聚合根的哪个方法触发                           |
| 消费方   | BC编号或子领域标识，多个消费方用逗号分隔           |
| 版本     | 事件版本号（v1, v2…）                              |

**表 6-8 领域事件清单表列定义**

每个事件的Payload字段表和消费方处理契约在第8章消息接口设计中定义，本章不展开。

## 6.3 粒度标准

聚合边界判断标准：

| 判断维度   | 应归入同一聚合           | 应拆分为独立聚合 |
| ---------- | ------------------------ | ---------------- |
| 事务一致性 | 必须在同一事务中保持一致 | 可接受最终一致性 |
| 生命周期   | 与聚合根同生同灭         | 有独立的生命周期 |
| 变更频率   | 与聚合根同频变更         | 变更频率显著不同 |
| 访问模式   | 总是与聚合根一起加载     | 经常独立访问     |

**表 6-9 聚合边界判断标准**

-   **业务规则粒度：** 一条规则对应一个可独立验证的业务约束；如果一条规则包含"且/或"连接的多个独立条件，应拆分为多条规则
-   **领域服务判断标准：** 业务逻辑不自然归属于任何一个聚合根时 → 领域服务；业务逻辑仅涉及单个聚合内部 → 聚合根方法

## 6.4 约束与规则

聚合设计应遵循五原则：

| 原则  | 名称           | 要求                                             |
| ----- | -------------- | ------------------------------------------------ |
| 原则1 | 业务不变性约束 | 聚合内对象共同维护一个业务不变性                 |
| 原则2 | 完整的业务概念 | 聚合代表一个完整的业务概念                       |
| 原则3 | 尽量小         | 只包含核心逻辑，实体数不超过5、值对象数不超过10  |
| 原则4 | ID引用其他聚合 | 跨聚合通过ID引用，禁止直接对象引用               |
| 原则5 | 边界不跨微服务 | 聚合内所有对象属于同一BC、同一微服务、同一数据库 |

**表 6-10 聚合设计五原则**

副作用隔离策略——领域层应保持纯净，不直接执行I/O操作：

| 副作用类型   | 领域层 | 应用层 | 基础设施层 |
| ------------ | ------ | ------ | ---------- |
| 数据库读写   | 禁止   | 协调   | 实现       |
| 外部服务调用 | 禁止   | 协调   | 实现       |
| 消息发送     | 禁止   | 协调   | 实现       |
| 缓存操作     | 禁止   | 协调   | 实现       |
| 领域事件收集 | 允许   | 收集   | 发布       |
| 业务计算     | 允许   | -      | -          |

**表 6-11 副作用隔离策略**

其他规则：
-   业务方法涉及跨聚合校验或外部依赖时，在业务方法表备注中注明"需应用层协调"
-   业务规则编号全BC唯一，各设计单元使用不同前缀
-   类名和属性名遵循BC总体设计附录B的编码规范
-   领域事件命名禁止使用过于泛化的名称
-   每个事件必须包含基础字段：eventId、eventVersion、occurredOn、aggregateId、aggregateType

## 6.5 典型示例

聚合清单表示例：

| 聚合根     | 包含实体 | 包含值对象                       | 核心不变式                 |
| ---------- | -------- | -------------------------------- | -------------------------- |
| Tenant     | -        | TenantName, ContactInfo, Address | 租户名称全局唯一且不可为空 |
| TenantPlan | -        | PlanQuota, BillingCycle          | 配额不可超过套餐上限       |

**表 6-12 聚合清单表示例**

业务规则表示例：

| 规则编号 | 规则名称     | 规则简述                               | 验证时机  | 违反后果     | 版本 |
| -------- | ------------ | -------------------------------------- | --------- | ------------ | ---- |
| TN-R-01  | 租户名称唯一 | 同一平台内租户名称不可重复             | 创建/更新 | 返回E-409001 | P1   |
| TN-R-02  | 停用前结清   | 租户停用前所有未结算账单应为已结清状态 | 状态变更  | 拒绝停用操作 | P1   |

**表 6-13 业务规则表示例**

---

# 第7章 应用层设计

## 7.1 输出结构

| 小节               | 输出形式   | 说明                                     |
| ------------------ | ---------- | ---------------------------------------- |
| 5.1 应用层职责说明 | 职责范围表 | 一次性说明承担和不承担的职责，后续不重复 |
| 5.2 应用服务清单   | 方法清单表 | 每个服务一组，含方法清单和协调步骤备注   |
| 5.3 命令对象设计   | 字段清单表 | 每个Command对象一张表                    |
| 5.4 查询对象设计   | 字段清单表 | 每个Query对象一张表                      |

**表 7-1 各小节输出形式**

## 7.2 子节定义

### 7.2.1 应用层职责范围表

标准职责划分：

| 职责类型   | 应用层承担                   | 应归属其他层                 |
| ---------- | ---------------------------- | ---------------------------- |
| 用例编排   | 协调领域对象完成业务用例     | -                            |
| 事务管理   | 定义事务边界                 | -                            |
| 权限校验   | 调用权限服务做前置校验       | -                            |
| DTO转换    | 入参转Command，出参转DTO     | -                            |
| 事件发布   | 事务提交后收集并发布领域事件 | -                            |
| 业务逻辑   | -                            | 领域层（聚合根、领域服务）   |
| 业务校验   | -                            | 领域层（业务规则）           |
| 数据持久化 | -                            | 基础设施层（Repository实现） |
| HTTP处理   | -                            | 接口层（Controller）         |

**表 7-2 标准职责划分**

### 7.2.2 应用服务方法清单表

| 列名     | 说明                                                |
| -------- | --------------------------------------------------- |
| 方法名   | 方法签名（如createTenant(CreateTenantCommand cmd)） |
| 方法简述 | 一句话说明业务场景                                  |
| 关联用例 | 对应的场景/用例编号（引用第4章场景索引）            |
| 事务类型 | 读写/只读                                           |
| 异常     | 可能的业务异常（自然语言简述）                      |

**表 7-3 方法清单表列定义**

复杂协调流程处理：当方法涉及跨聚合校验、外部服务调用或多步编排时，在方法清单表下方附协调步骤备注，格式为有序列表说明各步骤。

### 7.2.3 Command对象字段清单表

| 列名     | 说明                 |
| -------- | -------------------- |
| 字段名   | 属性名（camelCase）  |
| 数据类型 | Java类型             |
| 必填     | 是/否/系统注入       |
| 约束     | 格式、长度、范围限制 |
| 业务含义 | 字段用途说明         |

**表 7-4 Command字段清单表列定义**

Command对象命名规范：{动作}{聚合名}Command，如CreateTenantCommand、SuspendTenantCommand。

### 7.2.4 Query对象字段清单表

字段清单列定义与Command一致（字段名、数据类型、必填、约束、业务含义）。

Query对象命名规范：{聚合名}{条件}Query，如TenantListQuery、TenantDetailQuery。

## 7.3 粒度标准

-   **应用服务拆分标准：** 一个应用服务对应一个聚合根或一组高度关联的用例；如果一个服务的方法超过10个，应评估是否需要按用例群拆分
-   **Command/Query拆分标准：** 一个写操作对应一个Command对象；一个查询场景对应一个Query对象
-   版本展开标准：当前版本完整展开；未来版本仅保留方法名和简述，不展开Command/Query字段

## 7.4 约束与规则

-   应用服务方法是事务边界——一个方法对应一个用例，一个事务
-   应用层是"薄"层——如果应用服务方法中出现大量业务判断逻辑（if-else业务分支），说明业务逻辑泄漏到了应用层，应重构回领域层
-   系统注入字段（如operatorId、tenantId）在约束列标注"系统注入"，表示从安全上下文自动获取，前端不传入
-   本章不写Java接口代码或类代码，仅通过表格定义契约
-   每个应用服务方法应可追溯到第1章场景索引或第5章流程设计中的流程步骤

## 7.5 典型示例

应用服务方法清单表示例：

| 方法名                                   | 方法简述     | 关联用例 | 事务类型 | 异常           |
| ---------------------------------------- | ------------ | -------- | -------- | -------------- |
| createTenant(CreateTenantCommand cmd)    | 创建新租户   | SC-01    | 读写     | 租户名称重复   |
| suspendTenant(SuspendTenantCommand cmd)  | 停用租户     | SC-05    | 读写     | 存在未结清账单 |
| getTenantDetail(TenantDetailQuery query) | 查询租户详情 | SC-02    | 只读     | 租户不存在     |

**表 7-5 应用服务方法清单表示例**

---

# 第8章 接口设计

## 8.1 输出结构

| 小节                | 输出形式                             | 说明                                   |
| ------------------- | ------------------------------------ | -------------------------------------- |
| 6.1 接口总览        | 分类清单表                           | 按API/RPC/消息分类汇总，含领域方法追溯 |
| 6.2 RPC接口设计     | 方法清单表 + 契约 + 降级策略         | 跨BC内部调用，降级策略为必备内容       |
| 6.3 消息接口设计    | 概述表 + Payload表 + 消费方契约表    | 领域事件的完整契约                     |
| 6.4 RESTful API设计 | 五件套（概述表+请求+响应+Mock+备注） | 每个API独立小节                        |
| 6.5 专属错误码清单  | 分类错误码表                         | 仅本设计单元新增的错误码               |

**表 8-1 各小节输出形式**

## 8.2 子节定义

### 8.2.1 接口总览清单表

| 列名       | 说明                                                 |
| ---------- | ---------------------------------------------------- |
| 编号       | 接口编号（格式见6.2.6节编号规则）                    |
| 名称       | 简短中文名                                           |
| 类型       | API/RPC/消息                                         |
| 方法       | HTTP Method（API）、Java方法名（RPC）、Topic（消息） |
| 路径/Topic | RESTful路径、RPC接口类名、消息Topic名称              |
| 权限       | 权限代码（三段式），无则填"-"                        |
| 领域方法   | 对应的聚合方法或领域服务方法（如Tenant.create()）    |
| 版本       | 归属的实施版本（如P1）                               |

**表 8-2 接口总览清单表列定义**

### 8.2.2 RPC接口标准结构

**RPC方法清单表标准列：**

| 列名     | 说明                |
| -------- | ------------------- |
| 方法名   | Feign接口的方法签名 |
| 功能简述 | 一句话说明          |
| 入参     | 参数类型和名称      |
| 返回值   | 返回类型            |
| 异常     | 可能的业务异常      |

**表 8-3 RPC方法清单表列定义**

**RPC降级策略表标准列：**

| 列名       | 说明                                   |
| ---------- | -------------------------------------- |
| 方法名     | 与方法清单表对应                       |
| 降级条件   | 触发降级的条件（超时、异常类型、熔断） |
| 降级返回值 | 降级时的返回内容                       |
| 业务影响   | 降级对业务的影响说明                   |

**表 8-4 RPC降级策略表列定义**

### 8.2.3 消息接口标准结构

**消息概述表标准列：**

| 列名     | 说明                                |
| -------- | ----------------------------------- |
| 消息编号 | 格式：MSG-{设计单元缩写}-{序号}     |
| 消息名称 | 事件名称（与第6章领域事件清单一致） |
| Topic    | 消息Topic名称                       |
| 消费方   | 消费方BC编号或子领域标识            |
| 触发时机 | 何时发布                            |

**表 8-5 消息概述表列定义**

**Payload字段表标准列：**

| 列名     | 说明                               |
| -------- | ---------------------------------- |
| 字段名   | 事件Payload中的字段名（camelCase） |
| 数据类型 | Java类型                           |
| 必填     | 是/否                              |
| 业务含义 | 字段用途说明                       |

**表 8-6 Payload字段表列定义**

每个事件必须包含基础字段：eventId（String，幂等用）、eventVersion（String）、occurredOn（LocalDateTime）、aggregateId（对应聚合根ID类型）、aggregateType（String）。

**消费方处理契约表标准列：**

| 列名     | 说明                                       |
| -------- | ------------------------------------------ |
| 消费方   | 消费方标识                                 |
| 处理逻辑 | 消费方收到事件后的处理步骤简述             |
| 幂等策略 | 消费方如何保证幂等（如基于eventId去重）    |
| 失败处理 | 消费失败时的处理策略（重试次数、死信队列） |

**表 8-7 消费方处理契约表列定义**

### 8.2.4 RESTful API标准结构（五件套）

每个RESTful API由以下五部分组成：

**① 契约概述表（键值对结构）**

| 字段       | 说明                            |
| ---------- | ------------------------------- |
| API编号    | 接口编号                        |
| 路径       | RESTful路径（含路径参数占位符） |
| HTTP方法   | GET/POST/PUT/PATCH/DELETE       |
| 功能简述   | 一句话说明                      |
| 权限       | 权限代码（三段式）              |
| 领域方法   | 对应的聚合方法或应用服务方法    |
| 关联规则   | 引用业务规则编号                |
| 幂等性     | 是/否，是则说明幂等键           |
| 关联错误码 | 该接口可能返回的专属错误码列表  |

**表 8-8 契约概述表字段定义**

**② 请求契约表**

| 列名     | 说明                     |
| -------- | ------------------------ |
| 参数名   | 参数名称（camelCase）    |
| 位置     | path/query/header/body   |
| 数据类型 | Java类型                 |
| 必填     | 是/否/系统注入           |
| 约束     | 格式、长度、范围、枚举值 |
| 示例值   | 典型值                   |
| 业务含义 | 字段用途说明             |

**表 8-9 请求契约表列定义**

**③ 响应契约表**

| 列名     | 说明                    |
| -------- | ----------------------- |
| 参数名   | 响应字段名（camelCase） |
| 数据类型 | Java类型                |
| 必有     | 是/否                   |
| 示例值   | 典型值                  |
| 业务含义 | 字段用途说明            |

**表 8-10 响应契约表列定义**

**④ Mock示例**

包含三部分，均使用JSON代码块：
-   请求Mock：一个典型的请求示例
-   成功响应Mock：正常返回的完整响应
-   典型错误响应Mock：一个最常见的错误响应

**⑤ 备注**

可选段落，补充说明：分页参数约定、排序规则、特殊业务逻辑、与其他接口的调用顺序依赖等。

### 8.2.5 专属错误码清单表

| 列名       | 说明                                           |
| ---------- | ---------------------------------------------- |
| 错误码     | 格式：E-{HTTP状态码前缀}{业务序号}，如E-409001 |
| HTTP状态码 | 400/409/422/500等                              |
| 错误名称   | 简短中文名                                     |
| 错误描述   | 错误原因的完整描述                             |
| 触发条件   | 何种情况下返回该错误码                         |

**表 8-11 专属错误码清单表列定义**

按参数校验错误（400）、冲突错误（409）、业务逻辑错误（422）、基础设施错误（500）分类组织。

### 8.2.6 接口编号规则

| 接口类型      | 编号格式                  | 示例       |
| ------------- | ------------------------- | ---------- |
| API（供给侧） | P-{设计单元缩写}-{序号}   | P-TNT-01   |
| API（租户侧） | T-{设计单元缩写}-{序号}   | T-CFG-01   |
| API（公共）   | PUB-{设计单元缩写}-{序号} | PUB-TNT-01 |
| RPC           | RPC-{设计单元缩写}-{序号} | RPC-TNT-01 |
| 消息          | MSG-{设计单元缩写}-{序号} | MSG-TNT-01 |

**表 8-12 接口编号规则**

## 8.3 约束与规则

-   通用响应格式引用BC总体设计附录A的统一定义，本章不重复定义
-   接口版本管理策略引用BC总体设计的统一定义
-   通用错误码引用BC总体设计附录A，本章仅定义专属错误码
-   降级策略对RPC接口是必备内容，每个RPC方法都应有降级方案
-   消息接口的事件版本管理规则：新增可选字段向后兼容无需升级版本；删除或修改已有字段为破坏性变更，应新建事件类型并保留旧版本过渡期
-   当前版本的API应给出完整五件套；未来版本的API仅保留契约概述表
-   契约概述表中的"领域方法"和"关联规则"是追溯链的关键字段，不可省略

## 8.4 典型示例

契约概述表示例：

| 字段       | 值                    |
| ---------- | --------------------- |
| API编号    | P-TNT-01              |
| 路径       | POST /api/v1/tenants  |
| HTTP方法   | POST                  |
| 功能简述   | 创建新租户            |
| 权限       | tenant:tenant:create  |
| 领域方法   | Tenant.create()       |
| 关联规则   | TN-R-01, TN-R-03      |
| 幂等性     | 是，幂等键为requestId |
| 关联错误码 | E-409001, E-400101    |

**表 8-13 契约概述表示例**

---

# 第9章 数据模型设计

## 9.1 输出结构

| 小节                      | 输出形式                | 说明                                       |
| ------------------------- | ----------------------- | ------------------------------------------ |
| 7.1 领域模型-数据模型映射 | 映射关系表              | 本章核心，解释领域对象到数据库表的映射策略 |
| 7.2 表结构设计            | 字段定义表 + 索引设计表 | 每张表一组                                 |
| 7.3 表关系图              | ASCII ER图              | 标注表间外键或逻辑关联                     |
| 7.4 DDL脚本               | SQL代码块               | 宜提供，当前版本的建表SQL                  |

**表 9-1 各小节输出形式**

## 9.2 子节定义

### 9.2.1 领域模型-数据模型映射表

| 列名     | 说明                                                            |
| -------- | --------------------------------------------------------------- |
| 领域对象 | 聚合根/实体/值对象的类名（引用第6章定义）                       |
| 对象类型 | 聚合根/实体/值对象                                              |
| 映射方式 | 独立表/嵌入主表/JSON列/关联表                                   |
| 目标表   | 数据库表名                                                      |
| 说明     | 映射策略的补充说明（如"值对象字段平铺到主表的name_、phone_列"） |

**表 9-2 映射关系表列定义**

映射方式判断标准：

| 映射方式 | 适用场景                               |
| -------- | -------------------------------------- |
| 独立表   | 聚合根、有独立生命周期的实体           |
| 嵌入主表 | 值对象字段少于5个且无集合语义          |
| JSON列   | 值对象结构复杂但无需独立查询           |
| 关联表   | 值对象为集合类型（如List）或多对多关系 |

**表 9-3 映射方式判断标准**

### 9.2.2 字段定义表

| 列名     | 说明                                             |
| -------- | ------------------------------------------------ |
| 字段名   | 数据库列名（snake_case）                         |
| 数据类型 | MySQL数据类型（如VARCHAR(64)、BIGINT、DATETIME） |
| 可空     | YES/NO                                           |
| 默认值   | 默认值或AUTO_INCREMENT，无则填"-"                |
| 说明     | 字段业务含义，含枚举值说明                       |
| 版本     | 该字段首次引入的版本（如P1）                     |

**表 9-4 字段定义表列定义**

每张表应包含公共审计字段：created_by、created_at、updated_by、updated_at；如BC总体设计定义了逻辑删除规范，还应包含deleted标记字段；如使用乐观锁，应包含version字段。

### 9.2.3 索引设计表

| 列名     | 说明                                                |
| -------- | --------------------------------------------------- |
| 索引名   | 索引名称（如idx_tenant_name、uk_tenant_code）       |
| 索引字段 | 涉及的列，复合索引标注顺序（如"tenant_id, status"） |
| 类型     | 主键/唯一/普通/复合                                 |
| 说明     | 索引用途和使用场景（如"列表页按状态筛选"）          |

**表 9-5 索引设计表列定义**

### 9.2.4 表关系图

表关系图使用ASCII图绘制，遵循《C02-格式规范》的图块规范。表用方框表示，框内为表名；表间关系用连线标注，附关系类型（1:1、1:N、M:N）和关联字段名。

### 9.2.5 DDL脚本

DDL脚本使用SQL代码块，语言标识为`sql`。每张表的CREATE TABLE语句应包含：字段定义、主键、索引、表注释、字段注释。字符集和排序规则遵循BC总体设计的统一定义。

## 9.3 粒度标准

-   主表字段超过30个 → 评估拆分子表的必要性；拆分依据应与领域模型中的值对象边界对齐
-   高频访问字段和低频访问字段分布明显 → 考虑按访问频率拆分
-   索引设计粒度：每个查询场景应有对应索引，但单表索引数宜控制在5个以内

## 9.4 约束与规则

-   表命名和字段命名遵循BC总体设计附录B的编码规范
-   数据隔离遵循BC总体设计第5章的隔离架构
-   领域模型-数据模型映射表是本章的核心——它解释了为什么某些值对象的字段被平铺到主表
-   嵌入式值对象的字段命名应使用统一前缀（如contact_name、contact_phone）
-   枚举类型字段在说明列中列出所有枚举值（如"status: 0=草稿, 1=待审, 2=生效, 3=停用"）

## 9.5 典型示例

领域模型-数据模型映射表示例：

| 领域对象    | 对象类型 | 映射方式 | 目标表        | 说明                                |
| ----------- | -------- | -------- | ------------- | ----------------------------------- |
| Tenant      | 聚合根   | 独立表   | t_tenant      | 主表                                |
| TenantName  | 值对象   | 嵌入主表 | t_tenant      | 平铺为name列                        |
| ContactInfo | 值对象   | 嵌入主表 | t_tenant      | 平铺为contact_name、contact_phone列 |
| Address     | 值对象   | JSON列   | t_tenant      | 存储为address_json列，无需独立查询  |
| TenantPlan  | 聚合根   | 独立表   | t_tenant_plan | 通过tenant_id逻辑关联               |

**表 9-6 领域模型-数据模型映射表示例**

---

# 第10章 前端交互设计

## 10.1 输出结构

| 小节             | 输出形式                          | 说明                                     |
| ---------------- | --------------------------------- | ---------------------------------------- |
| 8.1 页面总览     | 页面清单表 + 页面导航结构图       | 页面全局视图，导航图是后续章节的组织锚点 |
| 8.2 页面详细设计 | 每页一组标准子节                  | 按导航结构分组，逐页展开                 |
| 8.3 汇总收尾     | 页面与接口映射表 + 功能操作汇总表 | 前端开发和测试的全局视图                 |

**表 10-1 各小节输出形式**

## 10.2 子节定义

### 10.2.1 页面清单表

| 列名     | 说明                                                 |
| -------- | ---------------------------------------------------- |
| 页面编号 | 格式：PG-{池}-{领域缩写}-{序号}（见8.2.7节编号规则） |
| 页面名称 | 简短中文名                                           |
| 用户群   | provider/ur/uc/公共                                  |
| 路由路径 | 前端路由path                                         |
| 说明     | 一句话描述用途或入口                                 |

**表 10-2 页面清单表列定义**

### 10.2.2 页面导航结构图

使用ASCII树状图，展示页面间的层级与导航关系。分组节点映射为后续详细设计的三级标题，页面节点映射为四级标题。页面节点格式：[页面编号] 页面名称。

### 10.2.3 单页面标准子节

每个页面按以下顺序编写：

| 序号 | 子节          | 标记 | 适用页面类型         | 输出形式                 |
| ---- | ------------- | ---- | -------------------- | ------------------------ |
| 1    | 页面说明      | 必选 | 全部                 | 列表（用途、入口、权限） |
| 2    | 页面布局      | 必选 | 全部                 | ASCII线框图              |
| 3    | 功能说明      | 必选 | 全部                 | 功能说明表               |
| 4    | 搜索条件      | 按需 | 列表页               | 搜索条件表               |
| 5    | 列表字段      | 按需 | 列表页               | 列表字段表               |
| 6    | 状态/标签展示 | 按需 | 列表页中有枚举状态列 | 枚举值-标签-颜色表       |
| 7    | 交互规则      | 按需 | 有特殊交互的页面     | 规则列表                 |
| 8    | 详情弹窗/抽屉 | 按需 | 列表行可展开详情时   | 弹窗字段布局或线框图     |

**表 10-3 单页面标准子节**

**功能说明表标准列（统一6列）：**

| 列名     | 说明                                                                    |
| -------- | ----------------------------------------------------------------------- |
| 功能编号 | 页面内唯一，格式F{两位序号}（F01、F02…）                                |
| 功能类型 | 展示/操作                                                               |
| 功能名称 | 功能的名称                                                              |
| 说明     | 展示类描述数据内容与加载时机，操作类描述触发行为                        |
| 关联API  | 对应的接口编号（如P-TNT-02），无则填"-"                                 |
| 前置条件 | 权限标识或交互条件（如tenant:tenant:create或"必填校验通过"），无则填"-" |

**表 10-4 功能说明表列定义**

**搜索条件表标准列（统一5列）：**

| 列名     | 说明                                |
| -------- | ----------------------------------- |
| 字段名   | 搜索框标签名                        |
| 组件类型 | Input/Select/DateRange/TreeSelect等 |
| 数据来源 | 用户输入/字典/接口                  |
| 默认值   | 空/全部/最近7天等                   |
| 说明     | 匹配方式（模糊/精确）、枚举值等     |

**表 10-5 搜索条件表列定义**

**列表字段表标准列（统一5列）：**

| 列名     | 说明                               |
| -------- | ---------------------------------- |
| 字段名   | 列标题                             |
| 列宽     | 建议宽度（px），可写auto           |
| 对齐     | 左/中/右                           |
| 是否排序 | 是/否                              |
| 说明     | 数据格式、截断规则、状态标签引用等 |

**表 10-6 列表字段表列定义**

**状态/标签展示表标准列：**

| 列名     | 说明                                          |
| -------- | --------------------------------------------- |
| 枚举值   | 后端返回的状态枚举值                          |
| 标签文本 | 前端展示的中文标签                            |
| 颜色     | 标签颜色标识（如success/warning/danger/info） |

**表 10-7 状态/标签展示表列定义**

### 10.2.4 汇总收尾

**页面与接口映射表标准列（统一3列）：**

| 列名     | 说明                                         |
| -------- | -------------------------------------------- |
| 页面编号 | 引用页面清单表中的编号                       |
| 页面功能 | 对应功能说明表中的功能名称                   |
| 调用接口 | 接口编号 + 简要名称（如"P-TNT-02 分页查询"） |

**表 10-8 页面与接口映射表列定义**

**功能操作汇总表标准列（统一6列）：**

| 列名     | 说明                                             |
| -------- | ------------------------------------------------ |
| 功能编号 | 全局唯一（页面编号:功能编号，如PG-P-TNT-01:F01） |
| 所属页面 | 页面编号                                         |
| 功能类型 | 展示/操作                                        |
| 功能名称 | 同功能说明表                                     |
| 关联API  | 同功能说明表                                     |
| 权限标识 | 从前置条件中提取权限部分                         |

**表 10-9 功能操作汇总表列定义**

### 10.2.5 节引导语

本章以固定两行引导语开头：
-   第一行："本节设计{设计单元名称}的前端页面，包括页面清单、页面结构和交互设计。"
-   第二行：一句话说明该设计单元前端的特点

### 10.2.6 页面布局（ASCII线框图）

线框图聚焦布局与区域划分，不在图上标注功能编号（功能编号仅在功能说明表中定义）。典型区域划分：顶部搜索区、操作按钮区、列表/表格区、分页区。

### 10.2.7 页面编号规则

| 段       | 取值               | 说明                       |
| -------- | ------------------ | -------------------------- |
| PG       | 固定前缀           | Page缩写                   |
| 池       | P/UR/UC/PUB        | 用户群缩写                 |
| 领域缩写 | 各设计单元约定缩写 | 见BC总体设计中的子领域编号 |
| 序号     | 两位数字，从01开始 | 页面顺序号                 |

**表 10-10 页面编号格式**

## 10.3 约束与规则

-   页面详细设计的章节结构应与导航结构图完全一致
-   功能说明表是追溯链的关键节点——通过"关联API"列连接后端接口设计，通过"前置条件"列连接权限设计
-   汇总收尾节不可省略，为前端开发和测试提供全局视图
-   本章是线框图级别的交互设计，不涉及前端技术栈、组件库选型等实现细节
-   当前版本完整展开，未来版本仅保留页面清单

---

# 第11章 后端工程结构设计

## 11.1 输出结构

| 小节           | 输出形式                | 说明                                 |
| -------------- | ----------------------- | ------------------------------------ |
| 9.1 模块划分   | 模块结构图 + 模块职责表 | 如BC总体设计已定义则引用，仅补充差异 |
| 9.2 包结构     | 包路径表                | 本设计单元的Java包路径和各包职责     |
| 9.3 核心类清单 | 核心类清单表            | 领域模型到代码的追溯桥梁             |

**表 11-1 各小节输出形式**

## 11.2 子节定义

### 11.2.1 模块划分

如BC总体设计已定义Maven/Gradle模块结构，本节引用即可，仅说明本设计单元在模块结构中的位置。

模块职责表标准列：

| 列名     | 说明                     |
| -------- | ------------------------ |
| 模块名   | Maven/Gradle模块名称     |
| 职责     | 一句话说明模块职责       |
| 依赖模块 | 该模块依赖的其他模块列表 |

**表 11-2 模块职责表列定义**

### 11.2.2 包结构表

| 列名   | 说明                            |
| ------ | ------------------------------- |
| 包路径 | 完整Java包路径                  |
| 所属层 | 接口层/应用层/领域层/基础设施层 |
| 职责   | 一句话说明该包存放的类类型      |

**表 11-3 包路径表列定义**

包结构应按DDD分层组织，典型结构如下：
-   **接口层：** controller、dto.request、dto.response
-   **应用层：** service、command、query、assembler
-   **领域层：** model.aggregate、model.entity、model.valueobject、event、service（领域服务）、repository（接口）
-   **基础设施层：** repository.impl、mapper、gateway、config

### 11.2.3 核心类清单表

| 列名     | 说明                                                             |
| -------- | ---------------------------------------------------------------- |
| 类名     | Java类名（PascalCase）                                           |
| 所在包   | 完整包路径或相对于基础包的路径                                   |
| 类型     | 聚合根/实体/值对象/领域服务/应用服务/Controller/Repository/DTO等 |
| 职责简述 | 一句话说明该类的核心职责                                         |

**表 11-4 核心类清单表列定义**

核心类清单应覆盖以下类型：聚合根、领域服务、应用服务、Controller、Repository接口、核心值对象。

## 11.3 约束与规则

-   如果BC的所有设计单元共享同一套Maven模块结构，模块划分在BC总体设计中定义一次即可，各设计单元仅描述包结构和核心类
-   核心类清单是"领域模型到代码"的追溯桥梁
-   类名和包路径遵循BC总体设计附录B的编码规范
-   包结构应体现DDD分层架构的依赖方向：接口层 → 应用层 → 领域层 ← 基础设施层（领域层不依赖外层）

## 11.4 典型示例

包路径表示例（以com.example.tenant.lifecycle为基础包）：

| 包路径               | 所属层     | 职责            |
| -------------------- | ---------- | --------------- |
| ...controller        | 接口层     | REST Controller |
| ...dto.request       | 接口层     | 请求DTO         |
| ...dto.response      | 接口层     | 响应DTO         |
| ...service           | 应用层     | 应用服务        |
| ...command           | 应用层     | 命令对象        |
| ...query             | 应用层     | 查询对象        |
| ...model.aggregate   | 领域层     | 聚合根          |
| ...model.valueobject | 领域层     | 值对象          |
| ...event             | 领域层     | 领域事件        |
| ...repository        | 领域层     | 仓储接口        |
| ...repository.impl   | 基础设施层 | 仓储实现        |
| ...mapper            | 基础设施层 | MyBatis Mapper  |

**表 11-5 包路径表示例**

---

# 第12章 权限设计

## 12.1 输出结构

| 小节              | 输出形式                  | 说明                                   |
| ----------------- | ------------------------- | -------------------------------------- |
| 10.1 权限点定义   | 权限点清单表              | 本设计单元新增的权限点，三段式命名     |
| 10.2 角色权限矩阵 | 勾选矩阵表                | 各预置角色与权限点的映射               |
| 10.3 API权限映射  | API权限汇总表             | 每个API对应的权限标识，与第8章交叉引用 |
| 10.4 数据权限规则 | 隔离规则表 + 可见性规则表 | 宜提供，存在数据隔离需求时必选         |
| 10.5 前端权限控制 | 页面按钮权限映射表        | 宜提供，有前端页面时必选               |

**表 12-1 各小节输出形式**

## 12.2 子节定义

### 12.2.1 权限点清单表

| 列名     | 说明                                                  |
| -------- | ----------------------------------------------------- |
| 权限编码 | 三段式命名：模块:资源:操作（如tenant:tenant:create）  |
| 权限名称 | 中文名称                                              |
| 模块     | 业务模块标识                                          |
| 资源     | 操作的资源类型                                        |
| 操作     | 具体操作（create/read/update/delete/export/manage等） |

**表 12-2 权限点清单表列定义**

### 12.2.2 角色权限矩阵

角色权限矩阵为交叉表结构：行为权限编码，列为角色名称，单元格填写"Y"（授予）或"-"（不授予）。角色定义引用BC总体设计第10章，本章不重复定义角色。

### 12.2.3 API权限映射汇总表

| 列名     | 说明                          |
| -------- | ----------------------------- |
| API编号  | 引用第8章接口总览中的接口编号 |
| API名称  | 简短中文名                    |
| HTTP方法 | GET/POST/PUT/PATCH/DELETE     |
| 路径     | RESTful路径                   |
| 权限标识 | 对应的权限编码（三段式）      |

**表 12-3 API权限映射汇总表列定义**

### 12.2.4 数据权限规则

**数据隔离规则表标准列：**

| 列名     | 说明                                         |
| -------- | -------------------------------------------- |
| 数据类型 | 需隔离的数据资源（如"租户数据"、"订单数据"） |
| 隔离维度 | 租户级/部门级/个人级                         |
| 隔离规则 | 具体的隔离描述                               |
| 实现方式 | 字段过滤条件（如tenant_id = ?）              |

**表 12-4 数据隔离规则表列定义**

**数据可见性规则表标准列：**

| 列名     | 说明                   |
| -------- | ---------------------- |
| 角色     | 角色名称或编码         |
| 可见范围 | 该角色能看到的数据范围 |
| 过滤条件 | SQL过滤条件            |
| 说明     | 补充说明               |

**表 12-5 数据可见性规则表列定义**

### 12.2.5 前端权限控制表

| 列名       | 说明                          |
| ---------- | ----------------------------- |
| 页面       | 页面编号（引用第10章页面清单） |
| 按钮/操作  | 受控的UI元素名称              |
| 所需权限   | 权限编码（三段式）            |
| 无权限处理 | 隐藏/禁用                     |

**表 12-6 页面按钮权限映射表列定义**

## 12.3 约束与规则

权限编码采用三段式命名：

| 段   | 说明           | 示例                                 |
| ---- | -------------- | ------------------------------------ |
| 模块 | 业务模块标识   | tenant, order, user                  |
| 资源 | 操作的资源类型 | tenant, config, role                 |
| 操作 | 具体操作       | create, read, update, delete, export |

**表 12-7 三段式命名规则**

其他规则：
-   权限命名规范和角色定义引用BC总体设计第10章，本章仅定义本设计单元新增的权限点和映射关系
-   路由级权限和按钮级权限的实现方式在BC总体设计中统一定义，本章仅定义映射关系
-   所有接口都应关联权限编码——API权限映射汇总表应覆盖第8章定义的全部API
-   数据权限规则中的过滤条件应与第9章数据模型中的字段定义一致

## 12.4 典型示例

角色权限矩阵示例：

| 权限编码              | 超级管理员 | 租户管理员 | 普通用户 |
| --------------------- | ---------- | ---------- | -------- |
| tenant:tenant:create  | Y          | -          | -        |
| tenant:tenant:read    | Y          | Y          | -        |
| tenant:tenant:update  | Y          | -          | -        |
| tenant:tenant:suspend | Y          | -          | -        |
| tenant:config:manage  | Y          | Y          | -        |

**表 12-8 角色权限矩阵示例**

---

# 第13章 单元测试设计

## 13.1 输出结构

| 小节                | 输出形式              | 说明                       |
| ------------------- | --------------------- | -------------------------- |
| 11.1 测试范围与策略 | 测试范围表 + 策略说明 | 覆盖范围、优先级、框架选型 |
| 11.2 关键测试用例   | 测试用例表            | 按测试类型分组的用例设计   |
| 11.3 测试数据准备   | 数据准备方案说明      | 测试夹具设计、数据构造方式 |

**表 13-1 各小节输出形式**

## 13.2 子节定义

### 13.2.1 测试范围表

| 列名     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 测试对象 | 被测类或组件名称（如Tenant聚合根、TenantApplicationService） |
| 测试类型 | 聚合不变式/业务规则/状态转换/应用服务编排                    |
| 优先级   | 高/中/低                                                     |
| 说明     | 为何需要测试该对象、重点关注的验证点                         |

**表 13-2 测试范围表列定义**

优先级判断标准：
-   **高：** 聚合根的业务规则验证、状态机转换、核心不变式
-   **中：** 应用服务的用例编排、领域服务的跨聚合协调
-   **低：** 值对象的自验证、DTO转换

测试策略说明应包含：测试框架选型（如JUnit 5 + Mockito）、覆盖率目标、测试分层策略（单元测试 vs 集成测试的边界）。

### 13.2.2 关键测试用例表

| 列名     | 说明                                           |
| -------- | ---------------------------------------------- |
| 用例编号 | 格式：TC-{设计单元缩写}-{序号}                 |
| 测试类型 | 不变式验证/规则验证/边界条件/状态转换/异常路径 |
| 被测对象 | 被测类和方法名                                 |
| 测试场景 | Given-When-Then格式的场景描述                  |
| 预期结果 | 期望的输出或行为                               |
| 关联规则 | 引用业务规则编号，无则填"-"                    |

**表 13-3 测试用例表列定义**

测试用例按以下类型分组编写：
-   **聚合不变式测试：** 验证聚合创建和修改后核心不变式是否成立
-   **业务规则测试：** 验证每条业务规则的正向和反向场景
-   **边界条件测试：** 验证字段约束的边界值（最大长度、空值、格式异常）
-   **状态转换测试：** 验证状态机的合法转换和非法转换拒绝
-   **异常路径测试：** 验证异常场景下的错误处理和状态回滚

### 13.2.3 测试数据准备方案

测试数据准备方案应说明：
-   **测试夹具设计：** 用于构造测试数据的Builder或Factory类命名和设计思路
-   **数据构造方式：** 直接构造领域对象/使用Test Builder/数据库初始化脚本
-   **数据清理策略：** 每个测试方法前后的数据隔离方式（如事务回滚、数据库清空）

## 13.3 约束与规则

-   测试分层策略和覆盖率目标遵循BC总体设计第11章，本章不重复定义全局策略
-   测试用例的场景描述应使用Given-When-Then格式
-   每条业务规则（第6章定义）至少对应一个正向用例和一个反向用例
-   状态机的每条转换规则（第2章定义）至少对应一个合法转换用例和一个非法转换用例
-   测试用例不写具体的测试代码，仅通过表格定义测试设计

## 13.4 典型示例

| 用例编号 | 测试类型   | 被测对象       | 测试场景                                                                | 预期结果               | 关联规则 |
| -------- | ---------- | -------------- | ----------------------------------------------------------------------- | ---------------------- | -------- |
| TC-TL-01 | 不变式验证 | Tenant.create  | Given 有效租户信息 When 创建租户 Then 租户状态为DRAFT                   | 状态=DRAFT，名称非空   | -        |
| TC-TL-02 | 规则验证   | Tenant.create  | Given 租户名称已存在 When 创建租户 Then 抛出异常                        | DuplicateNameException | TN-R-01  |
| TC-TL-03 | 状态转换   | Tenant.suspend | Given 租户状态为ACTIVE且无未结清账单 When 停用 Then 状态变更为SUSPENDED | 状态=SUSPENDED         | TN-R-02  |
| TC-TL-04 | 边界条件   | Tenant.create  | Given 租户名称长度=65字符 When 创建 Then 校验失败                       | 参数校验异常           | -        |

**表 13-4 测试用例表示例**

---

# 第14章 Task细化与工作量估算

## 14.1 输出结构

| 小节                    | 输出形式              | 说明                       |
| ----------------------- | --------------------- | -------------------------- |
| 12.1 Task清单           | Task汇总表            | 细化后的实现任务清单       |
| 12.2 Task依赖与开发顺序 | 依赖关系表 + 顺序建议 | 基于依赖关系的推荐实现顺序 |

**表 14-1 各小节输出形式**

## 14.2 子节定义

### 14.2.1 Task汇总表

| 列名           | 说明                                                 |
| -------------- | ---------------------------------------------------- |
| Task编号       | 格式：TK-{设计单元缩写}-{序号}，如TK-TL-01           |
| Task描述       | 动宾结构的任务描述（如"实现Tenant聚合根及业务规则"） |
| 对应User Story | 引用需求文档中的User Story编号                       |
| 所属聚合/服务  | 该Task涉及的聚合根或服务名称                         |
| Task类型       | 领域层/应用层/接口层/基础设施层/前端/测试            |
| 预估工时       | 人天（应控制在1~3个工作日内）                        |

**表 14-2 Task汇总表列定义**

### 14.2.2 Task依赖关系表

| 列名     | 说明                                      |
| -------- | ----------------------------------------- |
| Task编号 | 引用Task汇总表中的编号                    |
| 前置Task | 该Task依赖的前置Task编号列表，无则填"-"   |
| 可并行   | 是/否，标注该Task是否可与其他Task并行开发 |

**表 14-3 Task依赖关系表列定义**

开发顺序建议以文字段落形式说明，包含：推荐的实现顺序、可并行的Task组、关键路径说明。

## 14.3 粒度标准

| Task类型   | 典型Task                                           |
| ---------- | -------------------------------------------------- |
| 领域层     | 实现某聚合根及业务规则、实现某值对象、实现领域服务 |
| 应用层     | 实现某应用服务及Command/Query                      |
| 接口层     | 实现某组REST API、实现某RPC接口                    |
| 基础设施层 | 实现某Repository、配置消息队列、实现缓存策略       |
| 数据层     | 创建数据库表及索引、编写数据迁移脚本               |
| 前端       | 实现某页面及交互                                   |
| 测试       | 编写某聚合的单元测试、编写某接口的集成测试         |

**表 14-4 典型Task拆分方式**

## 14.4 约束与规则

-   Task清单应承接BC总体设计中的初步Task清单，在此基础上细化
-   每个Task应可追溯到User Story，"对应User Story"列不可为空
-   工作量估算粒度应控制在1~3个工作日内，超过3天的Task必须进一步拆分
-   依赖关系应体现DDD分层的自然依赖：领域层Task → 应用层Task → 接口层Task → 前端Task
-   基础设施层Task（如数据库建表）通常为最早启动的Task

## 14.5 推导逻辑

Task细化的推导顺序：
1.   从BC总体设计的初步Task清单出发，识别本设计单元相关的Task
2.   按DDD分层拆分每个初步Task为具体实现任务
3.   估算每个Task的工作量，超过3天的进一步拆分
4.   建立Task间的依赖关系
5.   识别可并行的Task组和关键路径

## 14.6 典型示例

Task汇总表示例：

| Task编号 | Task描述                     | 对应User Story | 所属聚合/服务 | Task类型   | 预估工时 |
| -------- | ---------------------------- | -------------- | ------------- | ---------- | -------- |
| TK-TL-01 | 创建t_tenant表及索引         | US-01          | Tenant        | 数据层     | 0.5      |
| TK-TL-02 | 实现Tenant聚合根及业务规则   | US-01          | Tenant        | 领域层     | 2        |
| TK-TL-03 | 实现TenantRepository         | US-01          | Tenant        | 基础设施层 | 1        |
| TK-TL-04 | 实现TenantApplicationService | US-01, US-02   | Tenant        | 应用层     | 1.5      |
| TK-TL-05 | 实现租户CRUD REST API        | US-01, US-02   | Tenant        | 接口层     | 1        |
| TK-TL-06 | 实现租户列表页及详情页       | US-02          | Tenant        | 前端       | 2        |
| TK-TL-07 | 编写Tenant聚合单元测试       | US-01          | Tenant        | 测试       | 1        |

**表 14-5 Task汇总表示例**

---

# 附录A 专属错误码定义

## A.1 输出结构

| 小节               | 输出形式     | 说明                                     |
| ------------------ | ------------ | ---------------------------------------- |
| A.1 错误码号段     | 号段说明     | 引用BC总体设计附录A的分段规划            |
| A.2 专属错误码清单 | 分类错误码表 | 按错误类型分组，仅本设计单元新增的错误码 |

**表 A-1 各小节输出形式**

## A.2 子节定义

### A.2.1 错误码号段

号段说明应包含：
-   本设计单元分配到的错误码号段范围（引用BC总体设计附录A的分段规划）
-   号段格式说明（如"本设计单元使用E-400100~E-400199、E-409100~E-409199、E-422100~E-422199号段"）

### A.2.2 专属错误码清单表

| 列名       | 说明                                           |
| ---------- | ---------------------------------------------- |
| 错误码     | 格式：E-{HTTP状态码前缀}{业务序号}，如E-409101 |
| HTTP状态码 | 400/409/422/500等                              |
| 错误名称   | 简短中文名（如"租户名称重复"）                 |
| 错误描述   | 面向开发者的错误原因描述                       |
| 触发条件   | 何种业务场景下返回该错误码                     |

**表 A-2 专属错误码清单表列定义**

错误码按以下分类分组：

| 分类         | HTTP状态码 | 说明                     |
| ------------ | ---------- | ------------------------ |
| 参数校验错误 | 400        | 请求参数格式或值校验失败 |
| 冲突错误     | 409        | 唯一性约束或乐观锁冲突   |
| 业务逻辑错误 | 422        | 业务规则校验失败         |
| 基础设施错误 | 500        | 依赖服务或基础设施故障   |

**表 A-3 错误码分类**

## A.3 约束与规则

错误码命名格式：

| 段   | 说明                                            |
| ---- | ----------------------------------------------- |
| E-   | 错误码固定前缀                                  |
| XX   | HTTP状态码前缀（40=客户端错误，50=服务端错误）  |
| YYYY | 业务错误序号（0001-9999），在分配号段内顺序编号 |

**表 A-4 错误码命名格式**

其他规则：
-   通用错误码引用BC总体设计附录A的定义，不重复列出
-   错误码段在BC总体设计中统一分配，禁止跨号段使用
-   每个错误码应可追溯到第6章业务规则表或第8章接口设计中的关联错误码字段
-   错误码应支持国际化（i18n），错误码作为消息Key
-   错误描述应面向开发者，说明错误原因而非用户提示语

## A.4 推导逻辑

错误码定义的推导顺序：
1.   从第6章业务规则表出发，每条规则的"违反后果"列中引用的错误码需要在此定义
2.   从第8章接口设计出发，每个API契约概述表的"关联错误码"列中引用的错误码需要在此定义
3.   检查是否有遗漏——第2章状态机定义中的非法转换、第5章异常处理表中的错误场景，也可能需要专属错误码
4.   按分类组织错误码，检查号段是否在分配范围内

## A.5 典型示例

专属错误码清单表示例（冲突错误类）：

| 错误码   | HTTP状态码 | 错误名称     | 错误描述                         | 触发条件                   |
| -------- | ---------- | ------------ | -------------------------------- | -------------------------- |
| E-409101 | 409        | 租户名称重复 | 该租户名称已被其他租户使用       | 创建或更新租户时名称已存在 |
| E-409102 | 409        | 租户编码重复 | 该租户编码已被使用               | 创建租户时编码已存在       |
| E-409103 | 409        | 数据已被修改 | 记录已被其他操作修改，请刷新重试 | 乐观锁版本冲突             |

**表 A-5 专属错误码清单表示例（冲突错误类）**

专属错误码清单表示例（业务逻辑错误类）：

| 错误码   | HTTP状态码 | 错误名称       | 错误描述                     | 触发条件                        |
| -------- | ---------- | -------------- | ---------------------------- | ------------------------------- |
| E-422101 | 422        | 租户状态不允许 | 当前租户状态不允许执行该操作 | 非法状态转换（如DRAFT直接激活） |
| E-422102 | 422        | 存在未结清账单 | 租户停用前需结清所有账单     | 停用时存在未结清账单            |

**表 A-6 专属错误码清单表示例（业务逻辑错误类）**

---

# 附录B 缓存与性能设计明细

## B.1 输出结构

| 小节             | 输出形式     | 说明                            |
| ---------------- | ------------ | ------------------------------- |
| B.1 缓存明细     | 缓存项清单表 | 具体缓存哪些数据、TTL、失效策略 |
| B.2 性能优化措施 | 优化方案表   | 针对性能目标的具体优化方案      |

**表 B-1 各小节输出形式**

## B.2 子节定义

### B.2.1 缓存项清单表

| 列名           | 说明                                              |
| -------------- | ------------------------------------------------- |
| 缓存项名称     | 缓存数据的业务名称（如"租户基本信息"）            |
| Key模板        | 缓存Key的模板格式（如"tenant:info:{tenantId}"）   |
| 数据来源       | 缓存数据的来源表或接口                            |
| 数据结构       | 缓存值的数据结构（String/Hash/List/Set等）        |
| TTL            | 过期时间（如30min、1h、永不过期）                 |
| 失效策略       | 主动失效/被动过期/定时刷新                        |
| 一致性保证方式 | 缓存与数据库的一致性策略（如"写时删除+读时回填"） |

**表 B-2 缓存项清单表列定义**

缓存Key模板应遵循BC总体设计第8章定义的Key命名规范（如前缀规则、分隔符）。

### B.2.2 性能优化措施表

| 列名     | 说明                                             |
| -------- | ------------------------------------------------ |
| 优化场景 | 需要优化的业务场景或接口（如"租户列表查询"）     |
| 性能目标 | 引用BC总体设计第9章的性能指标（如"P99 < 200ms"） |
| 优化方案 | 具体采用的优化手段                               |
| 实现要点 | 方案的关键实现细节                               |

**表 B-3 性能优化措施表列定义**

常见优化手段分类：

| 优化类型 | 典型手段                         |
| -------- | -------------------------------- |
| 查询优化 | 索引优化、查询拆分、读写分离     |
| 缓存优化 | 热点数据缓存、多级缓存、缓存预热 |
| 批量处理 | 批量插入、批量更新、游标分页     |
| 异步化   | 异步消息、异步任务、事件驱动     |
| 数据结构 | 冗余字段、预计算、物化视图       |

**表 B-4 常见优化手段分类**

## B.3 约束与规则

-   缓存Key命名规范和公共缓存策略引用BC总体设计第8章，本附录定义具体的缓存数据项和实现细节
-   性能目标引用BC总体设计第9章，本附录定义达成目标的具体优化方案
-   缓存失效策略应与第6章领域模型的写操作对应——每个修改聚合状态的业务方法都应检查是否需要同步失效相关缓存
-   一致性保证方式的选择标准：
    -   强一致性要求 → 写时删除缓存 + 读时回填
    -   最终一致性可接受 → 设置合理TTL + 异步刷新
    -   高并发读场景 → 缓存预热 + 多级缓存（本地缓存 + Redis）
-   性能优化措施应可追溯到具体的接口或查询场景，避免泛泛而谈

## B.4 典型示例

缓存项清单表示例：

| 缓存项名称   | Key模板                 | 数据来源      | 数据结构 | TTL   | 失效策略 | 一致性保证方式    |
| ------------ | ----------------------- | ------------- | -------- | ----- | -------- | ----------------- |
| 租户基本信息 | tenant:info:{tenantId}  | t_tenant      | Hash     | 30min | 写时删除 | 写时删除+读时回填 |
| 租户配额     | tenant:quota:{tenantId} | t_tenant_plan | String   | 5min  | 写时删除 | 写时删除+读时回填 |
| 租户列表缓存 | tenant:list:{queryHash} | t_tenant      | String   | 1min  | 被动过期 | 短TTL被动过期     |

**表 B-5 缓存项清单表示例**

性能优化措施表示例：

| 优化场景     | 性能目标    | 优化方案            | 实现要点                                 |
| ------------ | ----------- | ------------------- | ---------------------------------------- |
| 租户列表查询 | P99 < 200ms | 索引优化 + 结果缓存 | status+created_at复合索引，结果缓存1分钟 |
| 租户批量开通 | 单批次 < 5s | 批量插入 + 异步通知 | MyBatis批量insert，开通结果异步消息通知  |

**表 B-6 性能优化措施表示例**

---

## 修订记录

| 标记  | 日期       | 修订内容                                                                                     | 修订人 |
| ----- | ---------- | -------------------------------------------------------------------------------------------- | ------ |
| v0.10 | 2026-02-21 | 初始版本，合并全部14个子文档                                                                 | AI     |
| R.05  | 2026-02-28 | 依据S00进行修订：新增第1章总则和第2章综述；原第1-2章改为第4-3章；原第3-12章改为第5-14章 | AI     |
| R.06  | 2026-02-28 | 修正全文交叉引用：更新章节引用指向正确章节号                                                 | AI     |

**表 修订历史**
