# BC-51 外规采集 子领域详细设计

+   **文档编号**: BC-51-SD01
+   **文档名称**: 外规采集子领域详细设计
+   **版本**: V0.10
+   **状态**: 初稿
+   **所属子领域**: BC-51 外规采集
+   **所属微服务**: SVC-06 svc-content-collect
+   **编写规范**: 《（子）领域详细设计编写规范》V0.10
+   **变更历史**

    | 版本  | 日期       | 变更人 | 变更内容                                                                                                                                                   |
    | ----- | ---------- | ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | V0.10 | 2026-02-08 | 丁劲松 | 初稿，P1全量                                                                                                                                               |
    | V0.11 | 2026-02-09 | 丁劲松 | 重构FL-RA-04格式解析流程：                                                                                                                                 |
    |       |            |        | 引入Doc2X外部API，拆为六阶段（API解析→产物留存→人工比对校正→MD结构化拆分→再次校验→正式发布），支持图片管理；                                               |
    |       |            |        | 合并FL-RA-05人工审核流程至FL-RA-04阶段⑤⑥；原始文档状态机从3态扩展为6态；全文联动修订（状态机、领域模型、应用服务、接口、数据模型、页面设计、工程包结构等） |

# 1 概述

## 1.1 子领域定位

+   子领域基本信息如下表所示

    | 属性         | 内容                                                                                    |
    | ------------ | --------------------------------------------------------------------------------------- |
    | 所属BC       | BC-51 外规采集（Content Acquisition）                                                   |
    | 子领域编号   | BC-51-SD01                                                                              |
    | 子领域名称   | 外规采集（Regulation Acquisition）                                                      |
    | 一句话描述   | 负责外部合规要求的采集管理，包括人工录入、格式解析、人工审核，P2+扩展自动采集与变更监测 |
    | 核心关注问题 | 如何高效、准确地将分散在各监管机构的外规采集并结构化入库，为下游知识工程提供高质量原料  |
    | 所属架构域   | 供给侧域                                                                                |
    | 所属业务域   | 内容生产域                                                                              |
    | 对应微服务   | SVC-06 svc-content-collect                                                              |
    | 服务角色     | UP-01 外规采集员                                                                        |

    表 1.1-1 子领域定位

## 1.2 版本范围

+   本文档覆盖的版本范围如下表所示

    | 版本 | 核心交付内容                                                                              | 文档详细程度   |
    | ---- | ----------------------------------------------------------------------------------------- | -------------- |
    | P1   | 人工录入、格式解析（含Doc2X API解析、人工比对校正、结构化拆分、再次校验、正式发布六阶段） | 完整设计       |
    | P2+  | 外规源管理、爬虫调度、变更检测、工作管理（看板/统计/导出）                                | 待P2启动时补充 |

    表 1.2-1 版本范围

+   本文档聚焦P1版本，P2+能力在本文档中保留设计骨架但标注为P2+范围

## 1.3 业务边界

+   BC-51外规采集的业务边界如下表所示

    | 边界类型   | 内容                                                                               | 说明                    |
    | ---------- | ---------------------------------------------------------------------------------- | ----------------------- |
    | P1 范围内  | 人工录入：支持人工上传外规PDF文件，填写元数据                                      | SC-CP-01 外规采集入库   |
    | P1 范围内  | 格式解析：通过Doc2X API解析PDF，人工比对校正MD，结构化拆分入ES，再次校验后正式发布 | SC-CP-01 外规采集入库   |
    | P2+ 范围内 | 外规源管理：配置外规采集源，支持官网、数据库、API等多种来源                        | SC-CP-01 外规采集入库   |
    | P2+ 范围内 | 爬虫调度：定时爬取外规更新，支持增量采集与全量采集                                 | SC-CP-01 外规采集入库   |
    | P2+ 范围内 | 变更检测：检测外规版本变更，生成变更差异报告                                       | EP-CP-01 变更监测       |
    | P2+ 范围内 | 工作管理：采集任务看板、进度跟踪、质量统计、报告导出                               | SC-CP-01 工作管理场景组 |
    | 范围外     | 外规解析映射：外规条款拆解为要求点、映射到控制点                                   | BC-52 知识工程负责      |
    | 范围外     | 租户分发：将处理后的知识数据推送至租户                                             | BC-53 运营分发负责      |
    | 范围外     | 6库存储管理：6库节点属性CRUD、版本管理                                             | BC-40 知识实体负责      |
    | 范围外     | 文件存储：文件上传、下载、预览、版本控制                                           | BC-13 文件管理负责      |

    表 1.3-1 业务边界

## 1.4 场景索引

+   BC-51涉及的业务场景索引如下表所示

    | 场景编号    | 场景名称                                | 触发者           | 版本 | 需求文档章节参考  |
    | ----------- | --------------------------------------- | ---------------- | ---- | ----------------- |
    | SC-CP-01-01 | 人工录入采集                            | UP-01 外规采集员 | P1   | 宏观需求 EP-CP-01 |
    | SC-CP-01-02 | 格式解析与校验                          | 系统+UP-01       | P1   | 宏观需求 EP-CP-01 |
    | SC-CP-01-03 | 解析结果人工审核（已合并至SC-CP-01-02） | UP-01 外规采集员 | P1   | 宏观需求 EP-CP-01 |
    | SC-CP-01    | 外规采集入库                            | UP-01 外规采集员 | P2+  | 宏观需求 EP-CP-01 |
    | SC-CP-01-04 | 外规变更监测                            | 系统定时任务     | P2+  | 宏观需求 EP-CP-01 |
    | SC-CP-01-05 | 采集工作管理                            | UP-01 外规采集员 | P2+  | 宏观需求 EP-CP-01 |

    表 1.4-1 场景索引

## 1.5 术语表

+   本子领域核心术语如下表所示

    | 术语       | 英文                      | 说明                                                                     |
    | ---------- | ------------------------- | ------------------------------------------------------------------------ |
    | 外规       | External Regulation       | 外部合规要求的统称，包括法规、标准、指引、通知、公告等                   |
    | 外规源     | Regulation Source         | 外规的采集来源，可以是监管机构官网、法律数据库、API接口等（P2+）         |
    | 采集任务   | Collection Task           | 从外规源获取外规内容的执行单元，包含爬取配置和执行记录                   |
    | 原始文档   | Raw Document              | 从外规源采集或人工上传的原始文件，未经结构化处理                         |
    | 结构化内容 | Structured Content        | 对原始文档进行解析后的段落级结构化数据，每个最小段落为一条独立记录       |
    | 内容节点   | Content Node              | 结构化内容的最小存储单元，对应原文中每个换行分隔的段落、标题、表格或图形 |
    | 人工审核   | Manual Review             | UP-01对解析结果进行校正与确认的操作，不存在驳回，直接校正后通过          |
    | 变更快照   | Change Snapshot           | 外规变更前后的内容快照，用于生成差异报告（P2+）                          |
    | 变更差异   | Change Diff               | 两个版本外规之间的差异记录，标识新增、修改、删除的条款（P2+）            |
    | 采集执行器 | Collection Executor       | XXL-JOB中运行采集任务的组件，内嵌于svc-content-collect微服务（P2+）      |
    | 排序分类   | Sort Category             | 外规的编码排序规则预定义枚举，分为法规类、标准类、自定义类               |
    | 等同采用   | Identical Adoption（IDT） | 国家标准等同采用国际标准，技术内容完全一致                               |
    | 修改采用   | Modified Adoption（MOD）  | 国家标准修改采用国际标准，技术内容有差异                                 |
    | 条容器     | Article Container         | 法规中"条"的特殊目录节点，显示时条标题与第一款内容合并展示               |

    表 1.5-1 术语表

# 2 设计约束

## 2.1 架构约束引用

+   本子领域设计需遵守的架构约束来自BC-51总体设计和概要设计，相关约束如下表所示

    | 约束来源 | 约束项         | 约束内容                                                        |
    | -------- | -------------- | --------------------------------------------------------------- |
    | 概要设计 | 技术栈约束     | 后端采用Spring Boot 3.x + Spring Cloud，前端采用Vue 3 + Arco    |
    | 概要设计 | 数据存储约束   | MySQL 8.0作为事务型数据存储，ES作为外规文档主存储与全文检索引擎 |
    | 概要设计 | 消息中间件约束 | 采用Kafka，消息格式遵循CloudEvents规范                          |
    | 概要设计 | 服务通信约束   | BC内部同步调用，BC间异步消息解耦                                |
    | 概要设计 | 分层架构约束   | 采用六边形架构，核心领域与技术设施解耦                          |
    | 概要设计 | 文件存储约束   | 文件存储通过BC-13文件管理服务，底层使用MinIO                    |
    | 概要设计 | 任务调度约束   | 分布式任务调度采用XXL-JOB                                       |
    | 概要设计 | 认证授权约束   | 通过BC-10用户管理服务统一认证授权，JWT Token机制                |
    | 概要设计 | 部署约束       | 容器化部署，支持Kubernetes编排                                  |

    表 2.1-1 架构约束引用

## 2.2 状态机定义

### 2.2.1 外规源状态机

+   外规源（RegulationSource）生命周期状态机定义如下表所示

    | 状态   | 英文     | 说明                       | 是否终态 |
    | ------ | -------- | -------------------------- | -------- |
    | 草稿   | DRAFT    | 新建外规源，配置未完成     | 否       |
    | 启用   | ENABLED  | 配置完成，可参与采集调度   | 否       |
    | 停用   | DISABLED | 暂时停止采集，保留历史数据 | 否       |
    | 已归档 | ARCHIVED | 永久停用并归档             | 是       |

    表 2.2.1-1 外规源状态枚举

+   外规源状态转换规则如下表所示

    | 当前状态 | 目标状态 | 触发动作 | 前置条件                         | 操作者           |
    | -------- | -------- | -------- | -------------------------------- | ---------------- |
    | DRAFT    | ENABLED  | 启用     | 必填字段校验通过，连通性测试通过 | UP-01 外规采集员 |
    | ENABLED  | DISABLED | 停用     | 无正在执行的采集任务             | UP-01 外规采集员 |
    | DISABLED | ENABLED  | 重新启用 | 连通性测试通过                   | UP-01 外规采集员 |
    | DISABLED | ARCHIVED | 归档     | 无关联的未完成采集任务           | UP-01 外规采集员 |

    表 2.2.1-2 外规源状态转换规则

+   外规源状态机如下图所示

    ```
    ┌──────────────────────────────────────────────┐
    │                     外规源状态机             │
    ├──────────────────────────────────────────────┤
    │                                              │
    │   ┌──────┐   启用    ┌────────┐              │
    │   │ DRAFT│──────────▶│ENABLED │              │
    │   └──────┘           └──┬─────┘              │
    │                         │  ▲                 │
    │                   停用  │  │ 重新启用        │
    │                         ▼  │                 │
    │                      ┌──────────┐            │
    │                      │ DISABLED │            │
    │                      └────┬─────┘            │
    │                           │                  │
    │                     归档  │                  │
    │                           ▼                  │
    │                      ┌──────────┐            │
    │                      │ ARCHIVED │  ← 终态    │
    │                      └──────────┘            │
    │                                              │
    └──────────────────────────────────────────────┘
    ```

    图 2.2.1-1 外规源状态机

### 2.2.2 采集任务状态机

+   采集任务（CollectionTask）执行状态机定义如下表所示

    | 状态     | 英文      | 说明                                                                  | 是否终态 |
    | -------- | --------- | --------------------------------------------------------------------- | -------- |
    | 待执行   | PENDING   | 任务已创建，等待调度执行                                              | 否       |
    | 执行中   | RUNNING   | 正在执行采集                                                          | 否       |
    | 采集成功 | COLLECTED | 采集完成，原始文档已存储                                              | 否       |
    | 解析中   | PARSING   | 正在进行格式解析（含API解析、人工校正、结构化拆分、校验、发布等阶段） | 否       |
    | 已完成   | COMPLETED | 原始文档已正式发布（APPROVED），数据已入库                            | 是       |
    | 失败     | FAILED    | 采集或解析过程中发生错误                                              | 否       |
    | 已取消   | CANCELLED | 手动取消                                                              | 是       |

    表 2.2.2-1 采集任务状态枚举

+   采集任务状态转换规则如下表所示

    | 当前状态  | 目标状态  | 触发动作           | 前置条件                                             | 触发者          |
    | --------- | --------- | ------------------ | ---------------------------------------------------- | --------------- |
    | PENDING   | RUNNING   | 调度器触发执行     | 外规源状态为ENABLED                                  | 系统（XXL-JOB） |
    | PENDING   | CANCELLED | 手动取消           | 无                                                   | UP-01           |
    | RUNNING   | COLLECTED | 采集完成           | 原始文档已上传至BC-13                                | 系统            |
    | RUNNING   | FAILED    | 采集失败           | 超时或网络异常                                       | 系统            |
    | COLLECTED | PARSING   | 触发解析           | 原始文档可读                                         | 系统            |
    | PARSING   | COMPLETED | 解析完成           | 原始文档已正式发布（APPROVED）                       | 系统            |
    | PARSING   | FAILED    | 解析失败           | 文档格式不支持或解析异常                             | 系统            |
    | FAILED    | PENDING   | 重试（AUTO任务）   | 手动确认可重试，任务类型为AUTO                       | UP-01           |
    | FAILED    | COLLECTED | 重试（MANUAL任务） | 手动确认可重试，任务类型为MANUAL，重试后自动触发解析 | UP-01           |
    | FAILED    | CANCELLED | 放弃               | 手动放弃                                             | UP-01           |

    表 2.2.2-2 采集任务状态转换规则

+   采集任务状态机如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │                        采集任务状态机                                  │
    ├────────────────────────────────────────────────────────────────────────┤
    │                                                                        │
    │   ┌─────────┐  调度触发  ┌─────────┐  采集完成  ┌──────────┐           │
    │   │ PENDING │──────────▶ │ RUNNING │──────────▶ │COLLECTED │           │
    │   └────┬────┘            └────┬────┘          ▲ └────┬─────┘           │
    │        │                      │               │      │                 │
    │   取消 │                失败  │    MANUAL重试  │ 触发解析              │
    │        ▼                      ▼               │      ▼                 │
    │   ┌─────────┐          ┌─────────┐          ┌──────────┐               │
    │   │CANCELLED│          │ FAILED  │          │ PARSING  │               │
    │   └─────────┘          └────┬────┘          └────┬─────┘               │
    │     ← 终态        AUTO重试│ │ ▲ 放弃        成功 │  │ 失败             │
    │                           │ │ │                  │  │                  │
    │                   ┌───────┘ │ │                  │  └────▶ FAILED      │
    │                   ▼         │ │                  ▼                     │
    │                PENDING  CANCELLED  COLLECTED ┌───────────┐             │
    │                                              │ COMPLETED │ ← 终态      │
    │                                              └───────────┘             │
    │                                                                        │
    │   说明：FAILED重试时，AUTO任务回到PENDING，MANUAL任务回到COLLECTED     │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.2.2-1 采集任务状态机

### 2.2.3 变更监测任务状态机

+   变更监测任务（ChangeMonitorTask）状态机定义如下表所示

    | 状态       | 英文            | 说明                           | 是否终态 |
    | ---------- | --------------- | ------------------------------ | -------- |
    | 待检测     | PENDING         | 等待定时调度执行检测           | 否       |
    | 检测中     | DETECTING       | 正在与外规源对比检测变更       | 否       |
    | 无变更     | NO_CHANGE       | 检测完成，外规无变更           | 是       |
    | 有变更     | CHANGED         | 检测到外规内容变更             | 否       |
    | 差异生成中 | DIFF_GENERATING | 正在生成变更差异报告           | 否       |
    | 已通知     | NOTIFIED        | 差异报告已生成，已通知相关人员 | 是       |
    | 检测失败   | FAILED          | 检测过程异常                   | 否       |

    表 2.2.3-1 变更监测任务状态枚举

+   变更监测任务状态转换规则如下表所示

    | 当前状态        | 目标状态        | 触发动作     | 前置条件         | 触发者          |
    | --------------- | --------------- | ------------ | ---------------- | --------------- |
    | PENDING         | DETECTING       | 定时调度触发 | 外规源ENABLED    | 系统（XXL-JOB） |
    | DETECTING       | NO_CHANGE       | 检测无变更   | 内容哈希值一致   | 系统            |
    | DETECTING       | CHANGED         | 检测到变更   | 内容哈希值不一致 | 系统            |
    | DETECTING       | FAILED          | 检测失败     | 网络异常或超时   | 系统            |
    | CHANGED         | DIFF_GENERATING | 触发差异生成 | 自动触发         | 系统            |
    | DIFF_GENERATING | NOTIFIED        | 差异生成完成 | 差异报告已保存   | 系统            |
    | DIFF_GENERATING | FAILED          | 差异生成失败 | 解析异常         | 系统            |
    | FAILED          | PENDING         | 重试         | 手动确认         | UP-01           |

    表 2.2.3-2 变更监测任务状态转换规则

### 2.2.4 原始文档状态机

+   原始文档（RawDocument）状态机定义如下表所示

    | 状态       | 英文            | 说明                                                  | 是否终态 |
    | ---------- | --------------- | ----------------------------------------------------- | -------- |
    | 待解析     | RAW             | 文档已创建，等待格式解析                              | 否       |
    | MD已就绪   | MD_READY        | Doc2X API解析完成，MD文件和图片已存储至BC-13          | 否       |
    | MD已校正   | MD_CORRECTED    | UP-01完成MD人工比对校正（含图片管理），等待结构化拆分 | 否       |
    | JSON已就绪 | JSON_READY      | MD结构化拆分完成，ContentNode已写入ES，等待再次校验   | 否       |
    | 待发布     | PENDING_PUBLISH | UP-01完成JSON再次校验（含图片管理），等待正式发布确认 | 否       |
    | 已通过     | APPROVED        | UP-01确认正式发布，可供下游BC-52使用                  | 是       |

    表 2.2.4-1 原始文档状态枚举

+   原始文档状态转换规则如下表所示

    | 当前状态        | 目标状态        | 触发动作          | 前置条件                        | 触发者 |
    | --------------- | --------------- | ----------------- | ------------------------------- | ------ |
    | RAW             | MD_READY        | API解析并留存完成 | MD文件和图片已上传至BC-13       | 系统   |
    | RAW             | RAW             | 更新元数据        | 文档存在                        | UP-01  |
    | MD_READY        | MD_CORRECTED    | 人工比对校正完成  | UP-01提交校正后的MD和图片变更   | UP-01  |
    | MD_CORRECTED    | JSON_READY      | 结构化拆分完成    | ContentNode已成功写入ES         | 系统   |
    | JSON_READY      | PENDING_PUBLISH | 再次校验完成      | UP-01提交校验后的JSON和图片变更 | UP-01  |
    | PENDING_PUBLISH | APPROVED        | 正式发布          | UP-01确认发布                   | UP-01  |
    | MD_READY        | RAW             | 重新解析          | UP-01要求重新调用API解析        | UP-01  |
    | JSON_READY      | MD_READY        | 回退至MD编辑      | UP-01在校验阶段发现需重新校正MD | UP-01  |

    表 2.2.4-2 原始文档状态转换规则

+   原始文档状态机如下图所示

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │                           原始文档状态机                                     │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │   ┌─────┐  API解析完成  ┌──────────┐  人工校正  ┌──────────────┐             │
    │   │ RAW │──────────────▶│ MD_READY │──────────▶ │ MD_CORRECTED │             │
    │   └──┬──┘               └────┬─────┘ ▲        ▲ └──────┬───────┘             │
    │      │                       │       │        │        │                     │
    │      └──┐ 更新元数据   重新解析  回退至MD编辑 │    拆分完成                  │
    │         │ （自循环）         │       │        │        │                     │
    │         └──▶ RAW  ◀──────────┘       │        │        ▼                     │
    │                                      │        │  ┌────────────┐              │
    │                                      └────────┼──│ JSON_READY │              │
    │                                               │  └─────┬──────┘              │
    │                                               │        │                     │
    │                                               │   校验完成                   │
    │                                               │        ▼                     │
    │                                              ┌─────────────────┐             │
    │                                              │ PENDING_PUBLISH │             │
    │                                              └────────┬────────┘             │
    │                                                       │                      │
    │                                                  正式发布                    │
    │                                                       ▼                      │
    │                                                ┌──────────┐                  │
    │                                                │ APPROVED │  ← 终态          │
    │                                                └──────────┘                  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.2.4-1 原始文档状态机

+   **说明**：原始文档状态机与采集任务状态机的关联关系为：采集任务PARSING期间，原始文档经历RAW→MD_READY→MD_CORRECTED→JSON_READY→PENDING_PUBLISH的多阶段流转；原始文档APPROVED时，采集任务状态同步变为COMPLETED。

## 2.3 并发与幂等策略

+   BC-51的并发与幂等策略如下表所示

    | 策略类型   | 策略内容                                                              | 适用范围                       |
    | ---------- | --------------------------------------------------------------------- | ------------------------------ |
    | 乐观锁     | 所有聚合根写操作使用version字段做乐观锁，冲突时返回E-409001           | 全部写接口                     |
    | 幂等性     | 人工录入通过fileId + regulationName组合判重，重复提交返回已有任务ID   | P-RA-09 人工录入创建任务（P1） |
    | 幂等性     | 采集任务通过taskId + sourceId + 采集时间戳组合保证幂等                | 爬虫调度触发（P2+）            |
    | 幂等性     | 变更监测通过monitorTaskId保证幂等，同一外规源同一调度周期内不重复检测 | 变更监测调度（P2+）            |
    | 幂等性     | 领域事件通过eventId保证消费方幂等处理                                 | 事件发布与消费                 |
    | 并发控制   | 同一外规源同时只能有一个采集任务执行，通过Redis分布式锁保证           | 采集任务执行（P2+）            |
    | 长流程控制 | 采集任务执行超时30分钟自动标记为FAILED                                | 采集任务执行（P2+）            |

    表 2.3-1 并发与幂等策略

## 2.4 安全约束

+   BC-51的安全约束如下表所示

    | 约束类型 | 约束内容                                                   |
    | -------- | ---------------------------------------------------------- |
    | 访问控制 | 所有接口需通过BC-10认证授权，仅UP-01角色可操作             |
    | 数据加密 | 外规源的访问凭证（API Key、账号密码）采用AES-256加密存储   |
    | 敏感日志 | 外规源凭证字段在日志中脱敏处理，仅展示前4位                |
    | 文件安全 | 上传的外规文件通过BC-13文件管理服务进行病毒扫描            |
    | 爬虫合规 | 爬虫采集遵循robots.txt协议，设置合理的请求频率和User-Agent |
    | 数据隔离 | BC-51数据为供给侧平台级数据，无租户隔离需求                |

    表 2.4-1 安全约束

# 3 业务流程设计

## 3.1 流程层级说明

+   本子领域的流程设计采用三层流程结构

    | 层级     | 适用场景                     | 图示工具      | 主要读者     |
    | -------- | ---------------------------- | ------------- | ------------ |
    | 一级流程 | 端到端业务流程总览           | 流程图/活动图 | 架构师、产品 |
    | 二级流程 | 跨组件/跨服务协作流程        | 时序图        | 架构师、开发 |
    | 三级流程 | 单个接口或方法内部的处理步骤 | 步骤表        | 开发、测试   |

    表 3.1-1 流程层级定义

+   一级流程和关键二级流程在本章描述，三级流程在接口设计（第6章）中作为接口处理逻辑的一部分体现

## 3.2 流程总览

+   BC-51外规采集子领域的流程清单如下表所示

    | 流程编号 | 流程名称             | 触发场景                    | 版本 | 流程层级  |
    | -------- | -------------------- | --------------------------- | ---- | --------- |
    | FL-RA-03 | 人工录入流程         | UP-01手动上传外规文件       | P1   | 一级+二级 |
    | FL-RA-04 | 格式解析流程         | 采集完成自动触发            | P1   | 一级+二级 |
    | FL-RA-08 | 端到端外规入库总流程 | 综合FL-RA-03~04的端到端流程 | P1   | 一级      |
    | FL-RA-01 | 外规源配置流程       | UP-01新建/编辑外规源        | P2+  | 一级+二级 |
    | FL-RA-02 | 自动采集流程         | XXL-JOB定时触发             | P2+  | 一级+二级 |
    | FL-RA-06 | 变更监测流程         | XXL-JOB定时触发             | P2+  | 一级+二级 |
    | FL-RA-07 | 采集任务管理流程     | UP-01分配/跟踪采集任务      | P2+  | 一级      |

    表 3.2-1 流程清单

## 3.3 FL-RA-08 端到端外规入库总流程

### 3.3.1 流程概述

+   端到端外规入库总流程是BC-51的核心一级流程，串联从人工上传到正式发布通知下游的完整链路
+   P1范围内包含人工上传、格式解析（含API解析、人工比对校正、结构化拆分、再次校验、正式发布六个阶段）两个环节
+   触发条件：UP-01外规采集员上传外规文件
+   结束条件：原始文档状态变为APPROVED，发布RegulationCollectedEvent领域事件通知BC-52
+   预计耗时：单条外规从上传到正式发布约1~3小时

### 3.3.2 流程图

+   端到端外规入库总流程如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────────────┐
    │                        FL-RA-08 端到端外规入库总流程（P1）                     │
    ├────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                │
    │  UP-01外规采集员            svc-content-collect          外部系统              │
    │  ─────────────────          ──────────────────          ─────────              │
    │                                                                                │
    │  ┌─────────────┐                                                               │
    │  │2a.人工上传  │                                                               │
    │  │  (FL-RA-03) │                                                               │
    │  └──────┬──────┘                                                               │
    │         │                                                                      │
    │         ▼                                                                      │
    │                            ┌───────────────────────────────────────────┐       │
    │                            │ FL-RA-04 格式解析流程（六阶段）           │       │
    │                            │                                           │       │
    │                            │ ① API解析PDF→压缩包（Doc2X）              │       │
    │                            │         ↓                                 │       │
    │                            │ ② 解析产物留存（MD+图片→BC-13）           │       │
    │                            │         ↓                                 │       │
    │  ┌─────────────┐           │ ③ 人工比对与MD规范化（UP-01校正+图片管理）│       │
    │  │UP-01校正确认│◀───────── │         ↓                                 │       │
    │  │  +图片管理  │           │ ④ MD结构化拆分入ES                        │       │
    │  └──────┬──────┘           │         ↓                                 │       │
    │         │                  │ ⑤ 再次校验（UP-01校验JSON+图片管理）      │       │
    │  ┌──────┴──────┐           │         ↓                                 │       │
    │  │UP-01校验确认│◀───────── │ ⑥ 正式发布（UP-01确认发布）               │       │
    │  └─────────────┘           └───────────────────┬───────────────────────┘       │
    │                                                │                               │
    │                                                ▼                               │
    │  ┌──────────────────────────┐     ┌──────────────────────────┐                 │
    │  │ 7.数据入库               │────▶│ 8.发布领域事件           │                 │
    │  │ 更新文档状态为APPROVED   │     │ RegulationCollected      │                 │
    │  │ 结构化内容已存储至ES     │     │ 通知BC-52知识工程        │                 │
    │  └──────────────────────────┘     └──────────────────────────┘                 │
    │                                                                                │
    └────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.3.2-1 端到端外规入库总流程

### 3.3.3 流程步骤

+   端到端外规入库总流程步骤如下表所示

    | 步骤号 | 步骤名称           | 执行者     | 输入               | 输出                                     | 业务规则引用 |
    | ------ | ------------------ | ---------- | ------------------ | ---------------------------------------- | ------------ |
    | 2a     | 人工上传           | UP-01      | 外规文件、元数据   | 原始文档、采集任务                       | RD-R-01      |
    | 5      | 格式解析（六阶段） | 系统+UP-01 | 原始PDF文档        | 结构化内容（段落级ContentNode）+关联图片 | RD-R-05      |
    | 7      | 数据入库           | 系统       | 已校验的结构化内容 | 文档状态（APPROVED）                     | RD-R-03      |
    | 8      | 发布领域事件       | 系统       | 文档记录ID         | RegulationCollectedEvent事件             | -            |

    表 3.3.3-1 端到端外规入库流程步骤

### 3.3.4 异常处理

+   端到端外规入库流程的异常处理如下表所示

    | 异常场景            | 检测时机 | 处理策略                                   | 补偿操作                         |
    | ------------------- | -------- | ------------------------------------------ | -------------------------------- |
    | 文件上传至BC-13失败 | 步骤2a   | 采集任务标记为FAILED，记录文件服务异常日志 | 清理已下载的临时文件             |
    | 格式不支持          | 步骤5    | 采集任务标记为FAILED，记录不支持的格式类型 | 保留原始文档供后续人工处理       |
    | 解析异常            | 步骤5    | 采集任务标记为FAILED，记录解析错误详情     | 保留原始文档供后续人工处理       |
    | 入库写入失败        | 步骤7    | 记录数据库异常                             | 事务回滚，不发布领域事件         |
    | 领域事件发布失败    | 步骤8    | 本地事件表记录待发送，异步重试             | 定时任务扫描本地事件表，重试发布 |

    表 3.3.4-1 端到端外规入库流程异常处理

## 3.4 FL-RA-01 外规源配置流程

### 3.4.1 流程概述

+   外规源配置流程是UP-01外规采集员新建和管理外规源的流程
+   触发条件：UP-01在供给侧后台发起新建外规源操作
+   结束条件：外规源创建成功（DRAFT状态）或启用成功（ENABLED状态）
+   预计耗时：5~15分钟

### 3.4.2 流程图

+   外规源配置流程时序图如下图所示

    ```
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │                    FL-RA-01 外规源配置流程（时序图）                             │
    ├──────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                  │
    │  UP-01        bff-provider     svc-content-collect    BC-13文件管理   外规源URL  │
    │   │                │                  │                   │              │       │
    │   │ 1.新建外规源   │                  │                   │              │       │
    │   │───────────────▶│                  │                   │              │       │
    │   │                │ 2.创建外规源     │                   │              │       │
    │   │                │─────────────────▶│                   │              │       │
    │   │                │                  │ 3.校验必填字段    │              │       │
    │   │                │                  │ 4.校验URL格式     │              │       │
    │   │                │                  │ 5.校验名称唯一性  │              │       │
    │   │                │  6.返回外规源ID  │                   │              │       │
    │   │                │◀─────────────────│                   │              │       │
    │   │  7.返回成功    │                  │                   │              │       │
    │   │◀───────────────│                  │                   │              │       │
    │   │                │                  │                   │              │       │
    │   │ 8.启用外规源   │                  │                   │              │       │
    │   │───────────────▶│                  │                   │              │       │
    │   │                │ 9.启用请求       │                   │              │       │
    │   │                │─────────────────▶│                   │              │       │
    │   │                │                  │ 10.连通性测试     │              │       │
    │   │                │                  │─────────────────────────────────▶│       │
    │   │                │                  │  11.HTTP HEAD请求                │       │
    │   │                │                  │◀─────────────────────────────────│       │
    │   │                │                  │ 12.更新状态ENABLED│              │       │
    │   │                │                  │ 13.注册XXL-JOB任务│              │       │
    │   │                │ 14.返回启用成功  │                   │              │       │
    │   │                │◀─────────────────│                   │              │       │
    │   │ 15.返回成功    │                  │                   │              │       │
    │   │◀───────────────│                  │                   │              │       │
    │                                                                                  │
    └──────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.4.2-1 外规源配置流程时序图

### 3.4.3 流程步骤

+   外规源配置流程步骤如下表所示

    | 步骤号 | 步骤名称       | 执行者       | 输入                                | 输出              | 业务规则引用 |
    | ------ | -------------- | ------------ | ----------------------------------- | ----------------- | ------------ |
    | 1~2    | 新建外规源     | UP-01 → 系统 | 名称、类型、URL、采集频率、访问凭证 | 外规源（DRAFT）   | RS-R-01      |
    | 3      | 校验必填字段   | 系统         | 外规源创建请求                      | 校验结果          | RS-R-01      |
    | 4      | 校验URL格式    | 系统         | 外规源URL                           | 校验结果          | RS-R-03      |
    | 5      | 校验名称唯一性 | 系统         | 外规源名称                          | 校验结果          | RS-R-04      |
    | 8~9    | 启用外规源     | UP-01 → 系统 | 外规源ID                            | 启用请求          | RS-R-02      |
    | 10~11  | 连通性测试     | 系统         | 外规源URL、访问凭证                 | 连通性结果        | RS-R-05      |
    | 12     | 更新状态       | 系统         | 连通性结果                          | 外规源（ENABLED） | RS-R-02      |
    | 13     | 注册定时任务   | 系统         | 外规源ID、采集频率                  | XXL-JOB任务ID     | CT-R-01      |

    表 3.4.3-1 外规源配置流程步骤

### 3.4.4 异常处理

+   外规源配置流程的异常处理如下表所示

    | 异常场景            | 检测时机 | 处理策略                                      | 补偿操作          |
    | ------------------- | -------- | --------------------------------------------- | ----------------- |
    | 必填字段缺失        | 步骤3    | 拒绝创建，返回具体缺失字段信息                | 无需补偿          |
    | URL格式不合法       | 步骤4    | 拒绝创建，返回URL格式错误提示                 | 无需补偿          |
    | 外规源名称重复      | 步骤5    | 拒绝创建，返回名称已存在错误（E-409001）      | 无需补偿          |
    | 连通性测试超时      | 步骤10   | 拒绝启用，返回连通性测试失败信息，建议检查URL | 外规源保持DRAFT   |
    | 连通性测试HTTP非2xx | 步骤10   | 拒绝启用，返回HTTP状态码及提示                | 外规源保持DRAFT   |
    | XXL-JOB注册失败     | 步骤13   | 记录告警日志，外规源状态回滚至DRAFT           | 回滚ENABLED→DRAFT |

    表 3.4.4-1 外规源配置流程异常处理

## 3.5 FL-RA-02 自动采集流程

### 3.5.1 流程概述

+   自动采集流程由XXL-JOB定时触发，从已启用的外规源爬取外规内容
+   触发条件：XXL-JOB按外规源配置的采集频率触发
+   结束条件：采集任务状态变为COLLECTED（等待后续解析流程）
+   预计耗时：单次采集5~15分钟，取决于外规源响应速度和文档大小

### 3.5.2 流程图

+   自动采集流程时序图如下图所示

    ```
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                    FL-RA-02 自动采集流程（时序图）                              │
    ├─────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                 │
    │  XXL-JOB       svc-content-collect    Redis         BC-13文件管理   外规源      │
    │   │                  │                  │               │              │        │
    │   │ 1.触发采集任务   │                  │               │              │        │
    │   │─────────────────▶│                  │               │              │        │
    │   │                  │ 2.获取分布式锁   │               │              │        │
    │   │                  │─────────────────▶│               │              │        │
    │   │                  │  3.锁获取结果    │               │              │        │
    │   │                  │◀─────────────────│               │              │        │
    │   │                  │                  │               │              │        │
    │   │                  │  [获取锁成功]    │               │              │        │
    │   │                  │ 4.创建采集任务   │               │              │        │
    │   │                  │ PENDING→RUNNING  │               │              │        │
    │   │                  │                  │               │              │        │
    │   │                  │ 5.发送HTTP请求   │               │              │        │
    │   │                  │────────────────────────────────────────────────▶│        │
    │   │                  │  6.返回文档内容  │               │              │        │
    │   │                  │◀────────────────────────────────────────────────│        │
    │   │                  │                  │               │              │        │
    │   │                  │ 7.上传原始文档   │               │              │        │
    │   │                  │─────────────────────────────────▶│              │        │
    │   │                  │  8.返回文件ID    │               │              │        │
    │   │                  │◀─────────────────────────────────│              │        │
    │   │                  │                  │               │              │        │
    │   │                  │ 9.更新任务状态   │               │              │        │
    │   │                  │ RUNNING→COLLECTED│               │              │        │
    │   │                  │                  │               │              │        │
    │   │                  │ 10.释放分布式锁  │               │              │        │
    │   │                  │─────────────────▶│               │              │        │
    │   │                  │                  │               │              │        │
    │   │                  │ 11.自动触发解析  │               │              │        │
    │   │                  │ (FL-RA-04)       │               │              │        │
    │   │                  │                  │               │              │        │
    │   │ 12.执行结果回调  │                  │               │              │        │
    │   │◀─────────────────│                  │               │              │        │
    │                                                                                 │
    └─────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.5.2-1 自动采集流程时序图

### 3.5.3 流程步骤

+   自动采集流程步骤如下表所示

    | 步骤号 | 步骤名称     | 执行者  | 输入                    | 输出                  | 业务规则引用 |
    | ------ | ------------ | ------- | ----------------------- | --------------------- | ------------ |
    | 1      | 触发采集任务 | XXL-JOB | 外规源ID、任务配置      | 调度触发信号          | CT-R-01      |
    | 2~3    | 获取分布式锁 | 系统    | 外规源ID                | 锁获取结果            | CT-R-03      |
    | 4      | 创建采集任务 | 系统    | 外规源配置信息          | 采集任务（RUNNING）   | CT-R-02      |
    | 5~6    | 发送HTTP请求 | 系统    | 外规源URL、请求头、凭证 | 原始文档内容          | CT-R-04      |
    | 7~8    | 上传原始文档 | 系统    | 文档内容、元数据        | BC-13文件ID           | CT-R-05      |
    | 9      | 更新任务状态 | 系统    | 采集结果                | 采集任务（COLLECTED） | -            |
    | 10     | 释放分布式锁 | 系统    | 锁Key                   | 锁释放结果            | -            |
    | 11     | 触发格式解析 | 系统    | 采集任务ID              | 解析流程启动          | -            |

    表 3.5.3-1 自动采集流程步骤

### 3.5.4 异常处理

+   自动采集流程的异常处理如下表所示

    | 异常场景               | 检测时机 | 处理策略                                               | 补偿操作                      |
    | ---------------------- | -------- | ------------------------------------------------------ | ----------------------------- |
    | 分布式锁获取失败       | 步骤2    | 说明同一外规源已有任务执行中，跳过本次采集             | 无需补偿，XXL-JOB记录跳过日志 |
    | 外规源HTTP请求超时     | 步骤5    | 自动重试3次（指数退避：10s/30s/60s），均失败标记FAILED | 释放分布式锁                  |
    | 外规源HTTP返回非2xx    | 步骤5    | 记录HTTP状态码，标记FAILED                             | 释放分布式锁                  |
    | 外规源返回空内容       | 步骤6    | 记录警告日志，标记FAILED                               | 释放分布式锁                  |
    | 文件上传BC-13失败      | 步骤7    | 自动重试2次，均失败后标记FAILED                        | 清理临时文件，释放分布式锁    |
    | 数据库写入失败         | 步骤4/9  | 标记FAILED，记录数据库异常                             | 释放分布式锁                  |
    | 任务执行超时（>30min） | 全程     | XXL-JOB超时中断，标记FAILED                            | 释放分布式锁                  |

    表 3.5.4-1 自动采集流程异常处理

## 3.6 FL-RA-03 人工录入流程

### 3.6.1 流程概述

+   人工录入流程是UP-01外规采集员手动上传外规文件并填写元数据的流程，用于处理无法自动爬取的外规
+   触发条件：UP-01在供给侧后台发起人工录入操作（上传文件+填写元数据+确认提交）
+   结束条件：采集任务状态变为COLLECTED，原始文档已创建并异步触发格式解析（FL-RA-04）
+   预计耗时：3~10分钟

### 3.6.2 流程图

+   人工录入流程时序图如下图所示

    ```
    ┌─────────────────────────────────────────────────────────────────────┐
    │                    FL-RA-03 人工录入流程（时序图）                  │
    ├─────────────────────────────────────────────────────────────────────┤
    │                                                                     │
    │  UP-01        bff-provider     svc-content-collect    BC-13文件管理 │
    │   │                │                  │                   │         │
    │   │ 1.上传外规文件 │                  │                   │         │
    │   │───────────────▶│                  │                   │         │
    │   │                │ 2.文件上传       │                   │         │
    │   │                │─────────────────────────────────────▶│         │
    │   │                │  3.病毒扫描+存储 │                   │         │
    │   │                │  4.返回文件ID    │                   │         │
    │   │                │◀─────────────────────────────────────│         │
    │   │ 5.返回文件ID   │                  │                   │         │
    │   │◀───────────────│                  │                   │         │
    │   │                │                  │                   │         │
    │   │ 6.提交录入     │                  │                   │         │
    │   │  (文件ID+元数据)                  │                   │         │
    │   │───────────────▶│                  │                   │         │
    │   │                │ 7.创建采集任务   │                   │         │
    │   │                │   (含元数据)     │                   │         │
    │   │                │─────────────────▶│                   │         │
    │   │                │                  │ 8.校验文件格式    │         │
    │   │                │                  │  支持PDF          │         │
    │   │                │                  │ 9.创建任务        │         │
    │   │                │                  │  直接COLLECTED    │         │
    │   │                │                  │ 10.创建文档+元数据│         │
    │   │                │                  │ 11.异步触发解析   │         │
    │   │                │                  │  (FL-RA-04)       │         │
    │   │                │ 12.返回任务ID    │                   │         │
    │   │                │◀─────────────────│                   │         │
    │   │ 13.返回成功    │                  │                   │         │
    │   │◀───────────────│                  │                   │         │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2-1 人工录入流程时序图

### 3.6.3 流程步骤

+   人工录入流程步骤如下表所示

    | 步骤号 | 步骤名称             | 执行者 | 输入                                         | 输出                                  | 业务规则引用 |
    | ------ | -------------------- | ------ | -------------------------------------------- | ------------------------------------- | ------------ |
    | 1~4    | 上传外规文件         | UP-01  | 外规文件（PDF）                              | BC-13文件ID                           | RD-R-01      |
    | 5      | 返回文件ID           | 系统   | BC-13存储结果                                | 文件ID返回UP-01                       | -            |
    | 6      | 提交录入（含元数据） | UP-01  | 文件ID、名称、发布机构、发布日期、外规类型等 | 创建请求                              | RD-R-04      |
    | 7~10   | 创建采集任务+文档    | 系统   | 文件ID、文件格式信息、外规元数据             | 采集任务（COLLECTED）+原始文档（RAW） | CT-R-06      |
    | 11     | 异步触发格式解析     | 系统   | 采集任务ID                                   | 解析流程启动（FL-RA-04）              | -            |
    | 12~13  | 返回成功             | 系统   | taskId、documentId                           | UP-01跳转至任务详情页                 | -            |

    表 3.6.3-1 人工录入流程步骤

### 3.6.4 异常处理

+   人工录入流程的异常处理如下表所示

    | 异常场景              | 检测时机 | 处理策略                                            | 补偿操作            |
    | --------------------- | -------- | --------------------------------------------------- | ------------------- |
    | 文件格式不支持        | 步骤6    | 拒绝创建任务，返回支持格式提示（P1仅支持PDF）       | BC-13中已存文件保留 |
    | 文件大小超限（>50MB） | 步骤2    | 拒绝上传，返回文件大小限制提示                      | 无需补偿            |
    | 文件病毒扫描不通过    | 步骤3    | 拒绝存储，返回安全风险提示                          | BC-13自动清理文件   |
    | BC-13文件服务不可用   | 步骤2    | 返回服务不可用错误，建议稍后重试                    | 无需补偿            |
    | 外规名称重复          | 步骤7    | 返回名称已存在警告，UP-01确认后可继续（作为新版本） | 无需补偿            |

    表 3.6.4-1 人工录入流程异常处理

## 3.7 FL-RA-04 格式解析流程

### 3.7.1 流程概述

+   格式解析流程对采集到的原始PDF文档进行结构化解析，经过"外部API解析→人工比对校正→JSON转换入库→再次校验→正式发布"六个阶段，最终生成高质量的结构化内容并存入ES
+   本流程为人机协同流程，系统负责外部API调用和格式转换，UP-01外规采集员负责比对校正和发布确认
+   触发条件：采集任务状态变为COLLECTED后自动触发步骤1（API解析）；后续步骤由UP-01手动驱动
+   结束条件：UP-01确认正式发布后，原始文档状态变为APPROVED，采集任务状态变为COMPLETED
+   预计耗时：API解析约1~5分钟；人工比对与校正约30~120分钟（取决于外规复杂度）；总计约1~3小时

+   流程的六个阶段概述如下：

    | 阶段 | 阶段名称           | 执行者 | 说明                                                                                                 | 版本 |
    | ---- | ------------------ | ------ | ---------------------------------------------------------------------------------------------------- | ---- |
    | ①    | API解析PDF→压缩包  | 系统   | 调用Doc2X外部API（https://v2.doc2x.noedgeai.com）将PDF解析，返回压缩包（含MD文件 + images目录）      | P1   |
    | ②    | 解析产物留存       | 系统   | 解压压缩包，将MD文件和images目录中的图片分别持久化存储至BC-13文件管理，关联原始文档                  | P1   |
    | ③    | 人工比对与MD规范化 | UP-01  | UP-01对照原始PDF逐页比对MD内容，修正解析错误，规范化MD格式；可上传/替换图片，可删除错误的图片关联    | P1   |
    | ④    | MD结构化拆分入ES   | 系统   | 将校正后的MD按段落级粒度拆分为ContentNode记录（每个最小段落一条），以JSON格式写入ES索引              | P1   |
    | ⑤    | 再次校验           | UP-01  | UP-01检查JSON结构化内容的完整性和准确性，校验图片引用是否正确；可上传/替换图片，可删除错误的图片关联 | P1   |
    | ⑥    | 正式发布           | UP-01  | UP-01确认发布，系统更新文档状态为APPROVED并发布领域事件                                              | P1   |

    表 3.7.1-1 格式解析流程阶段概述

### 3.7.2 流程图

+   格式解析流程时序图如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────────────────────────────┐
    │                          FL-RA-04 格式解析流程（时序图）                                       │
    ├────────────────────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                                │
    │  采集任务触发   svc-content-collect     Doc2X API       BC-13文件管理     UP-01外规采集员      │
    │   │                   │                   │                │                 │                 │
    │   │ 1.COLLECTED触发   │                   │                │                 │                 │
    │   │──────────────────▶│                   │                │                 │                 │
    │   │                   │ 2.更新状态PARSING │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │                   │ 3.下载原始PDF     │                │                 │                 │
    │   │                   │──────────────────────────────────▶ │                 │                 │
    │   │                   │ 4.返回PDF文件     │                │                 │                 │
    │   │                   │◀────────────────────────────────── │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ① API解析PDF→压缩包                │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │ 5.上传PDF请求解析 │                │                 │                 │
    │   │              │    │──────────────────▶│                │                 │                 │
    │   │              │    │ 6.返回压缩包      │                │                 │                 │
    │   │              │    │  (含MD文件+images目录)             │                 │                 │
    │   │              │    │◀──────────────────│                │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ② 解析产物留存    │                │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │ 7.解压压缩包      │                │                 │                 │
    │   │              │    │  ├─ 提取MD文件    │                │                 │                 │
    │   │              │    │  └─ 提取images/*  │                │                 │                 │
    │   │              │    │ 8.上传MD文件至BC-13                │                 │                 │
    │   │              │    │──────────────────────────────────▶ │                 │                 │
    │   │              │    │ 9.上传图片至BC-13 │                │                 │                 │
    │   │              │    │  (逐张上传images目录中的图片)      │                 │                 │
    │   │              │    │──────────────────────────────────▶ │                 │                 │
    │   │              │    │ 10.返回MD文件ID+图片文件ID列表     │                 │                 │
    │   │              │    │◀────────────────────────────────── │                 │                 │
    │   │              │    │ 11.关联MD和图片至原始文档          │                 │                 │
    │   │              │    │ 12.更新状态MD_READY                │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ③ 人工比对与MD规范化               │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │                   │                │  13.打开比对视图│                 │
    │   │              │    │◀─────────────────────────────────────────────────────│                 │
    │   │              │    │ 14.返回PDF+MD+图片列表             │                 │                 │
    │   │              │    │─────────────────────────────────────────────────────▶│                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │                   │                │  15.UP-01对照PDF│                 │
    │   │              │    │                   │                │     校正MD内容  │                 │
    │   │              │    │                   │                │  (P1:文本编辑器 │                 │
    │   │              │    │                   │                │   P2+:MD编辑器) │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │                   │                │  16.管理图片    │                 │
    │   │              │    │                   │                │  ├─ 上传新图片  │                 │
    │   │              │    │                   │                │  ├─ 替换已有图片│                 │
    │   │              │    │                   │                │  └─ 删除错误图片关联              │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │ 17.提交校正后MD+图片变更           │                 │                 │
    │   │              │    │◀─────────────────────────────────────────────────────│                 │
    │   │              │    │ 18.保存校正MD+处理图片变更         │                 │                 │
    │   │              │    │──────────────────────────────────▶ │                 │                 │
    │   │              │    │ 19.更新状态MD_CORRECTED            │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ④ MD结构化拆分入ES│                │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │ 20.读取校正后MD   │                │                 │                 │
    │   │              │    │ 21.段落级结构化拆分                │                 │                 │
    │   │              │    │  ├─ 识别标题层次  │                │                 │                 │
    │   │              │    │  ├─ 拆分章节/条款 │                │                 │                 │
    │   │              │    │  ├─ 提取表格/附录 │                │                 │                 │
    │   │              │    │  ├─ 关联图片引用  │                │                 │                 │
    │   │              │    │  └─ 每小段落→1条ContentNode        │                 │                 │
    │   │              │    │ 22.JSON写入ES索引 │                │                 │                 │
    │   │              │    │ 23.更新状态JSON_READY              │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ⑤ 再次校验        │                │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │                   │                │  24.打开校验视图│                 │
    │   │              │    │◀─────────────────────────────────────────────────────│                 │
    │   │              │    │ 25.返回JSON内容+图片引用           │                 │                 │
    │   │              │    │  (P1:文本编辑器展示JSON            │                 │                 │
    │   │              │    │   P2+:可视化编辑,JSON转页面展示)   │                 │                 │
    │   │              │    │─────────────────────────────────────────────────────▶│                 │
    │   │              │    │                   │                │  26.UP-01校验   │                 │
    │   │              │    │                   │                │     并修正JSON  │                 │
    │   │              │    │                   │                │  27.管理图片    │                 │
    │   │              │    │                   │                │  ├─ 上传/替换图片                 │
    │   │              │    │                   │                │  └─ 删除错误图片关联              │
    │   │              │    │ 28.提交校验结果+图片变更           │                 │                 │
    │   │              │    │◀─────────────────────────────────────────────────────│                 │
    │   │              │    │ 29.更新JSON至ES+处理图片变更       │                 │                 │
    │   │              │    │ 30.更新状态PENDING_PUBLISH         │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    │   │              ┌────┤ ⑥ 正式发布        │                │                 │                 │
    │   │              │    │                   │                │                 │                 │
    │   │              │    │                   │                │  31.确认发布    │                 │
    │   │              │    │◀─────────────────────────────────────────────────────│                 │
    │   │              │    │ 32.更新文档APPROVED                │                 │                 │
    │   │              │    │ 33.更新任务COMPLETED               │                 │                 │
    │   │              │    │ 34.发布RegulationCollectedEvent    │                 │                 │
    │   │              └────┤                   │                │                 │                 │
    │   │                   │                   │                │                 │                 │
    └────────────────────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.7.2-1 格式解析流程时序图

### 3.7.3 流程步骤

+   格式解析流程步骤如下表所示

    | 步骤号 | 阶段                 | 步骤名称            | 执行者 | 输入                     | 输出                                                      | 业务规则引用 |
    | ------ | -------------------- | ------------------- | ------ | ------------------------ | --------------------------------------------------------- | ------------ |
    | 1~2    | -                    | 触发解析            | 系统   | 采集任务ID               | 采集任务（PARSING）                                       | -            |
    | 3~4    | -                    | 下载原始PDF         | 系统   | BC-13文件ID              | 原始PDF文件字节流                                         | -            |
    | 5~6    | ① API解析PDF→压缩包  | 调用Doc2X API解析   | 系统   | PDF文件                  | 压缩包（含MD文件 + images目录）                           | RD-R-10      |
    | 7      | ② 解析产物留存       | 解压压缩包          | 系统   | 压缩包                   | MD文件 + 图片文件列表                                     | -            |
    | 8~9    | ② 解析产物留存       | 上传MD和图片至BC-13 | 系统   | MD文件、图片文件列表     | MD文件ID + 图片文件ID列表（BC-13）                        | RD-R-11      |
    | 10~12  | ② 解析产物留存       | 关联产物并更新状态  | 系统   | MD文件ID、图片文件ID列表 | 原始文档（MD_READY），MD和图片关联记录已建立              | -            |
    | 13~14  | ③ 人工比对与MD规范化 | 打开比对视图        | UP-01  | 文档ID                   | 左栏PDF + 右栏可编辑MD + 图片列表                         | -            |
    | 15     | ③ 人工比对与MD规范化 | 校正MD内容          | UP-01  | PDF原文 + API生成的MD    | 校正后的MD内容                                            | RD-R-12      |
    | 16     | ③ 人工比对与MD规范化 | 管理图片            | UP-01  | 当前图片列表             | 上传新图片/替换已有图片/删除错误的图片关联                | RD-R-14      |
    | 17~19  | ③ 人工比对与MD规范化 | 提交校正并保存      | UP-01  | 校正后MD + 图片变更      | 原始文档（MD_CORRECTED），图片变更已同步BC-13             | RD-R-11      |
    | 20     | ④ MD结构化拆分入ES   | 读取校正后MD        | 系统   | 校正后的MD文件           | MD文本内容                                                | -            |
    | 21     | ④ MD结构化拆分入ES   | 段落级结构化拆分    | 系统   | MD文本内容               | ContentNode记录集合（每个最小段落为一条记录，含图片引用） | RD-R-05      |
    | 22     | ④ MD结构化拆分入ES   | 写入ES索引          | 系统   | ContentNode记录集合      | idx_structured_content ES文档集合                         | RD-R-03      |
    | 23     | ④ MD结构化拆分入ES   | 更新状态            | 系统   | 写入结果                 | 原始文档（JSON_READY）                                    | -            |
    | 24~25  | ⑤ 再次校验           | 打开校验视图        | UP-01  | 文档ID                   | JSON结构化内容 + 图片引用（可编辑展示）                   | -            |
    | 26     | ⑤ 再次校验           | 校验并修正JSON      | UP-01  | JSON结构化内容           | 校验通过的JSON内容                                        | RD-R-13      |
    | 27     | ⑤ 再次校验           | 管理图片            | UP-01  | 当前图片引用列表         | 上传/替换图片、删除错误的图片关联                         | RD-R-14      |
    | 28~30  | ⑤ 再次校验           | 提交校验结果        | UP-01  | 校验后JSON + 图片变更    | 原始文档（PENDING_PUBLISH），图片变更已同步               | RD-R-03      |
    | 31     | ⑥ 正式发布           | 确认发布            | UP-01  | 文档ID                   | -                                                         | -            |
    | 32~33  | ⑥ 正式发布           | 更新状态            | 系统   | 发布确认                 | 文档（APPROVED）、任务（COMPLETED）                       | -            |
    | 34     | ⑥ 正式发布           | 发布领域事件        | 系统   | 文档ID                   | RegulationCollectedEvent                                  | -            |

    表 3.7.3-1 格式解析流程步骤

+   **阶段③编辑器选型说明**：P1版本使用普通文本编辑器（如textarea）编辑MD内容，UP-01直接以纯文本方式修改；P2+版本可引入专业MD编辑器（如支持实时预览的Markdown编辑器组件），提升编辑效率和可视化体验。图片管理功能在比对视图中以独立面板展示，支持上传、替换和删除操作

+   **阶段⑤编辑器选型说明**：P1版本使用普通文本编辑器展示和编辑JSON内容，UP-01直接以纯文本方式校验修正；P2+版本可引入可视化编辑方案——将JSON结构化内容渲染为页面形式展示（如树形目录+条款内容的可视化视图），UP-01在可视化界面上直接校验和编辑。图片以缩略图形式内嵌展示在关联的ContentNode旁，支持就地上传、替换和删除图片关联

+   **图片管理操作说明**：阶段③和阶段⑤均支持以下图片管理操作，图片统一存储于BC-13文件管理，通过文件ID与原始文档关联

    | 操作         | 说明                                                                                     | 触发场景                                          |
    | ------------ | ---------------------------------------------------------------------------------------- | ------------------------------------------------- |
    | 上传新图片   | UP-01上传本地图片文件，系统存入BC-13并生成文件ID，UP-01在MD或JSON中插入图片引用          | API解析遗漏图片、PDF中图片未被识别                |
    | 替换已有图片 | UP-01选择已关联的图片进行替换，系统上传新图片至BC-13，更新文件ID引用，原图片标记为可清理 | API解析出的图片质量差、图片内容识别错误           |
    | 删除图片关联 | UP-01删除MD或JSON中的图片引用，解除图片与原始文档的关联关系，图片文件标记为可清理        | API错误地将非图片内容识别为图片、图片与上下文无关 |

    表 3.7.3-2 图片管理操作说明

### 3.7.4 异常处理

+   格式解析流程的异常处理如下表所示

    | 异常场景                  | 检测时机  | 处理策略                                                                     | 补偿操作                           |
    | ------------------------- | --------- | ---------------------------------------------------------------------------- | ---------------------------------- |
    | BC-13文件下载失败         | 步骤3     | 自动重试2次，均失败后标记FAILED                                              | 采集任务PARSING→FAILED             |
    | Doc2X API调用失败         | 步骤5     | 自动重试2次（含超时重试），均失败后标记FAILED                                | 记录API响应码和错误信息            |
    | Doc2X API返回空内容或乱码 | 步骤6     | 标记FAILED，记录API返回内容摘要供排查                                        | 保留原始PDF供人工处理              |
    | 压缩包解压失败            | 步骤7     | 标记FAILED，记录压缩包格式异常详情                                           | 保留原始压缩包供排查               |
    | 压缩包中缺少MD文件        | 步骤7     | 标记FAILED，记录压缩包内容清单                                               | 保留原始PDF供重新请求API解析       |
    | MD或图片上传BC-13失败     | 步骤8~9   | 自动重试2次，均失败后标记FAILED，本地暂存文件                                | 支持手动重新上传                   |
    | PDF加密或损坏             | 步骤5     | Doc2X API返回解析失败，标记FAILED，记录异常详情                              | 保留原始文档供人工处理             |
    | 图片上传/替换失败         | 步骤16/27 | 提示UP-01操作失败，允许重试或跳过该图片继续其他操作                          | 不影响MD/JSON主体校正流程          |
    | MD结构化拆分失败          | 步骤21    | 标记FAILED，记录拆分异常详情（如MD格式不规范导致段落识别失败）               | 保留校正后MD文件，支持重新触发拆分 |
    | 图片引用解析失败          | 步骤21    | 记录无法解析的图片引用，标记为待人工确认，不阻塞拆分流程                     | 在阶段⑤校验时由UP-01处理           |
    | JSON写入ES失败            | 步骤22    | 标记FAILED，记录ES写入异常                                                   | 事务回滚，支持重试                 |
    | 人工比对发现严重解析错误  | 步骤15    | UP-01可选择：（a）手动校正后继续；（b）标记FAILED请求重新解析                | 保留原始PDF和当前MD供参考          |
    | JSON校验发现结构性错误    | 步骤26    | UP-01可选择：（a）手动修正JSON后继续；（b）回退至MD_READY重新进入阶段③校正MD | 回退时保留当前JSON版本供参考       |
    | 领域事件发布失败          | 步骤34    | 写入本地事件表，异步重试                                                     | 文档状态已为APPROVED               |

    表 3.7.4-1 格式解析流程异常处理

## 3.8 FL-RA-05 人工审核流程（已合并至FL-RA-04）

+   **本流程已合并**：原FL-RA-05人工审核流程的校正与发布职能已整合至FL-RA-04格式解析流程的阶段③~⑥，不再作为独立流程存在
+   原FL-RA-05的核心能力对应关系如下：
    -   原"刷新审核列表"→ FL-RA-04阶段③/⑤打开比对或校验视图，对应接口P-RA-29查询文档处理列表（6.4.19节）、P-RA-30查询文档处理详情（6.4.20节）
    -   原"校正结构化内容"→ FL-RA-04阶段③人工比对校正MD + 管理图片（步骤15~19），对应接口P-RA-32提交MD校正（6.4.22节）；FL-RA-04阶段⑤校验并修正JSON + 管理图片（步骤26~27），对应接口P-RA-33提交JSON校验（6.4.23节）
    -   原"确认通过并发布事件"→ FL-RA-04阶段⑥正式发布（步骤31~34），对应接口P-RA-31正式发布确认（6.4.21节）
    -   图片管理操作：对应接口P-RA-35上传图片（6.4.25节）、P-RA-36替换图片（6.4.26节）、P-RA-37删除图片关联（6.4.27节）
    -   回退操作：FL-RA-04阶段⑤可回退至阶段③，对应接口P-RA-34回退至MD编辑（6.4.24节）

## 3.9 FL-RA-06 变更监测流程

### 3.9.1 流程概述

+   变更监测流程由XXL-JOB定时触发，检测已入库外规是否发生版本变更
+   触发条件：XXL-JOB按外规源的变更监测频率定时触发
+   结束条件：变更监测任务状态变为NO_CHANGE或NOTIFIED
+   预计耗时：单次检测1~5分钟

### 3.9.2 流程图

+   变更监测流程时序图如下图所示

    ```
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                    FL-RA-06 变更监测流程（时序图）                              │
    ├─────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                 │
    │  XXL-JOB    svc-content-collect   外规源URL     BC-12消息通知    Kafka          │
    │   │               │                 │               │              │            │
    │   │ 1.触发监测    │                 │               │              │            │
    │   │──────────────▶│                 │               │              │            │
    │   │               │ 2.创建监测任务  │               │              │            │
    │   │               │ PENDING→DETECTING               │              │            │
    │   │               │                 │               │              │            │
    │   │               │ 3.获取当前页面  │               │              │            │
    │   │               │────────────────▶│               │              │            │
    │   │               │ 4.返回页面内容  │               │              │            │
    │   │               │◀────────────────│               │              │            │
    │   │               │                 │               │              │            │
    │   │               │ 5.计算内容哈希  │               │              │            │
    │   │               │ 6.与上次哈希对比│               │              │            │
    │   │               │                 │               │              │            │
    │   │               │ [哈希一致]      │               │              │            │
    │   │               │ 7a.标记NO_CHANGE│               │              │            │
    │   │               │                 │               │              │            │
    │   │               │ [哈希不一致]    │               │              │            │
    │   │               │ 7b.标记CHANGED  │               │              │            │
    │   │               │ 8.生成变更快照  │               │              │            │
    │   │               │ 9.DIFF_GENERATING               │              │            │
    │   │               │ 10.逐段对比生成差异             │              │            │
    │   │               │ 11.保存差异报告 │               │              │            │
    │   │               │ 12.发送通知     │               │              │            │
    │   │               │────────────────────────────────▶│              │            │
    │   │               │                 │               │              │            │
    │   │               │ 13.发布变更事件 │               │              │            │
    │   │               │───────────────────────────────────────────────▶│            │
    │   │               │                 │  RegulationChanged           │            │
    │   │               │ 14.标记NOTIFIED │               │              │            │
    │   │               │                 │               │              │            │
    │   │ 15.执行结果   │                 │               │              │            │
    │   │◀──────────────│                 │               │              │            │
    │                                                                                 │
    └─────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.9.2-1 变更监测流程时序图

### 3.9.3 流程步骤

+   变更监测流程步骤如下表所示

    | 步骤号 | 步骤名称       | 执行者  | 输入               | 输出                           | 业务规则引用 |
    | ------ | -------------- | ------- | ------------------ | ------------------------------ | ------------ |
    | 1      | 触发监测       | XXL-JOB | 外规源ID           | 监测任务（DETECTING）          | CM-R-01      |
    | 3~4    | 获取当前页面   | 系统    | 外规源URL          | 当前页面内容                   | CM-R-02      |
    | 5      | 计算内容哈希   | 系统    | 页面内容           | SHA-256哈希值                  | CM-R-03      |
    | 6      | 与上次哈希对比 | 系统    | 当前哈希、历史哈希 | 对比结果                       | CM-R-03      |
    | 7a     | 标记无变更     | 系统    | 对比结果（一致）   | 监测任务（NO_CHANGE）          | -            |
    | 7b~8   | 标记有变更     | 系统    | 对比结果（不一致） | 变更快照记录                   | CM-R-04      |
    | 9~11   | 生成差异报告   | 系统    | 前后两版内容       | 差异报告（新增/修改/删除条款） | CM-R-05      |
    | 12     | 发送通知       | 系统    | 差异报告、外规信息 | BC-12通知请求                  | CM-R-06      |
    | 13     | 发布变更事件   | 系统    | 外规ID、变更类型   | RegulationChangedEvent事件     | -            |
    | 14     | 标记已通知     | 系统    | 通知发送结果       | 监测任务（NOTIFIED）           | -            |

    表 3.9.3-1 变更监测流程步骤

### 3.9.4 异常处理

+   变更监测流程的异常处理如下表所示

    | 异常场景                | 检测时机 | 处理策略                               | 补偿操作                 |
    | ----------------------- | -------- | -------------------------------------- | ------------------------ |
    | 外规源页面获取失败      | 步骤3    | 自动重试3次，均失败后标记FAILED        | 发送采集员告警通知       |
    | 外规源页面结构变更      | 步骤5    | 哈希变化但非内容变更，记录结构变更警告 | 标记为需人工确认         |
    | 差异生成超时（>10分钟） | 步骤10   | 标记FAILED，记录超时详情               | 保留变更快照供后续重试   |
    | BC-12通知服务不可用     | 步骤12   | 标记差异报告为"待通知"，异步重试通知   | 不影响NOTIFIED状态转换   |
    | 领域事件发布失败        | 步骤13   | 写入本地事件表，异步重试               | 监测任务状态已为NOTIFIED |
    | 外规源已被停用          | 步骤1    | 跳过本次监测，记录跳过日志             | 无需补偿                 |

    表 3.9.4-1 变更监测流程异常处理

## 3.10 FL-RA-07 采集任务管理流程

### 3.10.1 流程概述

+   采集任务管理流程是UP-01外规采集员分配、跟踪和管理采集工作的流程
+   触发条件：UP-01在供给侧后台查看或操作采集任务
+   结束条件：任务分配完成或任务状态被更新
+   预计耗时：1~5分钟

### 3.10.2 流程图

+   采集任务管理一级流程如下图所示

    ```
    ┌─────────────────────────────────────────────────────────────────────┐
    │                    FL-RA-07 采集任务管理流程（一级）                │
    ├─────────────────────────────────────────────────────────────────────┤
    │                                                                     │
    │  ┌───────────┐                                                      │
    │  │ UP-01     │                                                      │
    │  │ 外规采集员│                                                      │
    │  └─────┬─────┘                                                      │
    │        │                                                            │
    │        ├─────▶ 查看任务看板 ──▶ 按状态/优先级/来源筛选              │
    │        │                                                            │
    │        ├─────▶ 手动创建采集任务 ──▶ 指定外规源和目标URL             │
    │        │                                                            │
    │        ├─────▶ 重试失败任务 ──▶ AUTO任务→PENDING / MANUAL任务→COLLECTED│
    │        │                                                            │
    │        ├─────▶ 取消任务 ──▶ 任务状态→CANCELLED                      │
    │        │                                                            │
    │        ├─────▶ 查看采集统计 ──▶ 按时段/来源/状态统计                │
    │        │                                                            │
    │        └─────▶ 导出采集报告 ──▶ 按条件导出Excel报告                 │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
    ```

    图 3.10.2-1 采集任务管理流程

### 3.10.3 流程步骤

+   采集任务管理核心操作步骤如下表所示

    | 步骤号 | 步骤名称         | 执行者 | 输入              | 输出                                   | 业务规则引用 |
    | ------ | ---------------- | ------ | ----------------- | -------------------------------------- | ------------ |
    | 1      | 查看任务看板     | UP-01  | 筛选条件          | 任务列表                               | -            |
    | 2      | 手动创建采集任务 | UP-01  | 外规源ID、目标URL | 采集任务（PENDING）                    | CT-R-07      |
    | 3      | 重试失败任务     | UP-01  | 采集任务ID        | AUTO任务→PENDING，MANUAL任务→COLLECTED | CT-R-08      |
    | 4      | 取消任务         | UP-01  | 采集任务ID        | 采集任务（CANCELLED）                  | CT-R-09      |
    | 5      | 查看采集统计     | UP-01  | 统计条件          | 统计数据                               | -            |
    | 6      | 导出采集报告     | UP-01  | 导出条件          | Excel文件                              | -            |

    表 3.10.3-1 采集任务管理流程步骤

### 3.10.4 异常处理

+   采集任务管理流程的异常处理如下表所示

    | 异常场景                  | 检测时机 | 处理策略                             | 补偿操作 |
    | ------------------------- | -------- | ------------------------------------ | -------- |
    | 重试非FAILED状态的任务    | 步骤3    | 拒绝操作，返回"仅FAILED状态可重试"   | 无需补偿 |
    | 取消非PENDING状态的任务   | 步骤4    | 拒绝操作，返回"仅PENDING状态可取消"  | 无需补偿 |
    | 取消正在执行中的任务      | 步骤4    | 拒绝操作，返回"RUNNING状态不可取消"  | 无需补偿 |
    | 导出数据量过大（>10万条） | 步骤6    | 返回数据量超限提示，建议缩小筛选范围 | 无需补偿 |

    表 3.10.4-1 采集任务管理流程异常处理

# 4 领域模型设计

## 4.1 聚合概述

+   BC-51外规采集子领域划分为4个聚合（P1实现2个，P2+实现2个），聚合清单如下表所示

    | 聚合编号 | 聚合名称     | 聚合根            | 核心不变性约束                                       | 实体数 | 值对象数 | 版本 |
    | -------- | ------------ | ----------------- | ---------------------------------------------------- | ------ | -------- | ---- |
    | AGG-01   | 外规源聚合   | RegulationSource  | 外规源配置的完整性与状态一致性                       | 1      | 3        | P2+  |
    | AGG-02   | 采集任务聚合 | CollectionTask    | 采集任务状态机的完整性，单任务内所有步骤的事务一致性 | 1      | 4        | P1   |
    | AGG-03   | 原始文档聚合 | RawDocument       | 原始文档与结构化内容的一一对应关系，审核状态一致性   | 1+1    | 6        | P1   |
    | AGG-04   | 变更监测聚合 | ChangeMonitorTask | 变更检测结果与差异报告的一致性                       | 1      | 3        | P2+  |

    表 4.1-1 聚合清单

+   聚合间关系如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                          BC-51 聚合关系图                                  │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │   ┌──────────────────┐                                                     │
    │   │ AGG-01 (P2+)     │                                                     │
    │   │ RegulationSource │                                                     │
    │   │ (外规源聚合)     │                                                     │
    │   └────────┬─────────┘                                                     │
    │            │ sourceId引用                                                  │
    │            ▼                                                               │
    │   ┌──────────────────┐     taskId引用    ┌──────────────────┐              │
    │   │ AGG-02 (P1)      │──────────────────▶│ AGG-03 (P1)      │              │
    │   │ CollectionTask   │                   │ RawDocument      │              │
    │   │ (采集任务聚合)   │                   │ (原始文档聚合)   │              │
    │   └──────────────────┘                   └──────────────────┘              │
    │                                                                            │
    │   ┌──────────────────┐                                                     │
    │   │ AGG-04 (P2+)     │     sourceId引用 AGG-01                             │
    │   │ ChangeMonitorTask│     regulationId引用 AGG-03                         │
    │   │ (变更监测聚合)   │                                                     │
    │   └──────────────────┘                                                     │
    │                                                                            │
    │   说明：聚合间通过ID引用，不直接对象引用（遵循聚合设计原则4）              │
    │   原AGG-05验证任务聚合已取消，审核能力收归AGG-03 RawDocument               │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.1-1 聚合关系图

+   各聚合的设计决策记录：
    -   **AGG-01 外规源聚合（P2+）**：核心不变性约束是外规源配置的完整性，包括URL合法性、凭证有效性、采集频率合理性，这些属性必须在同一事务中保持一致
    -   **AGG-02 采集任务聚合**：核心不变性约束是状态机转换的合法性，每次状态变更必须遵循状态转换规则表。P1阶段仅人工录入创建任务，P2+扩展自动采集
    -   **AGG-03 原始文档聚合**：独立于采集任务聚合，因为原始文档可独立变化（如重新解析），且文档与采集任务是多对一关系（同一外规可多次采集）。审核能力内置于本聚合，通过ReviewInfo值对象记录审核信息
    -   **AGG-04 变更监测聚合（P2+）**：独立于采集任务聚合，因为变更监测有独立的状态机和生命周期
    -   **原AGG-05 验证任务聚合**：已取消。审核不再作为独立聚合，改为RawDocument聚合内的状态流转和ReviewInfo值对象。审核模式为"校正即通过"，无驳回流程，无需独立的领取/释放/超时机制

## 4.2 AGG-01 外规源聚合（RegulationSource）

### 4.2.1 聚合根：RegulationSource

**（1）属性清单表**

+   RegulationSource聚合根属性如下表所示

    | 属性名            | 数据类型         | 约束                  | 默认值       | 业务含义                     | 版本 |
    | ----------------- | ---------------- | --------------------- | ------------ | ---------------------------- | ---- |
    | sourceId          | String           | 必填，唯一，UUID格式  | 系统自动生成 | 外规源唯一标识               | P2+  |
    | sourceName        | String           | 必填，长度2~100，唯一 | -            | 外规源名称                   | P2+  |
    | sourceType        | SourceType       | 必填                  | -            | 外规源类型（枚举值对象）     | P2+  |
    | sourceUrl         | Url              | 必填                  | -            | 外规源访问地址（值对象）     | P2+  |
    | credential        | SourceCredential | 可选                  | null         | 访问凭证（值对象，加密存储） | P2+  |
    | collectSchedule   | CollectSchedule  | 必填                  | -            | 采集调度配置（值对象）       | P2+  |
    | status            | SourceStatus     | 必填                  | DRAFT        | 外规源状态                   | P2+  |
    | description       | String           | 可选，长度≤500        | null         | 外规源描述说明               | P2+  |
    | publisherName     | String           | 可选，长度≤200        | null         | 发布机构名称                 | P2+  |
    | lastCollectTime   | LocalDateTime    | 可选                  | null         | 最近一次成功采集时间         | P2+  |
    | lastMonitorTime   | LocalDateTime    | 可选                  | null         | 最近一次变更监测时间         | P2+  |
    | totalCollectCount | Integer          | 可选                  | 0            | 累计成功采集次数             | P2+  |
    | xxlJobId          | Long             | 可选                  | null         | XXL-JOB注册的任务ID          | P2+  |
    | version           | Integer          | 必填                  | 0            | 乐观锁版本号                 | P2+  |
    | createdBy         | String           | 必填，系统注入        | 当前操作人ID | 创建人                       | P2+  |
    | createdAt         | LocalDateTime    | 必填，系统注入        | 当前时间     | 创建时间                     | P2+  |
    | updatedBy         | String           | 必填，系统注入        | 当前操作人ID | 最后修改人                   | P2+  |
    | updatedAt         | LocalDateTime    | 必填，系统注入        | 当前时间     | 最后修改时间                 | P2+  |

    表 4.2.1-1 RegulationSource属性清单

**（2）业务规则表**

+   RegulationSource业务规则如下表所示

    | 规则编号 | 规则名称           | 规则简述                                                                      | 验证时机  | 违反后果     | 版本 |
    | -------- | ------------------ | ----------------------------------------------------------------------------- | --------- | ------------ | ---- |
    | RS-R-01  | 外规源创建校验     | 创建外规源时sourceName、sourceType、sourceUrl、collectSchedule为必填字段      | 创建      | 拒绝操作     | P2+  |
    | RS-R-02  | 外规源启用前置条件 | 启用外规源前必须通过连通性测试，仅DRAFT和DISABLED状态可启用                   | 状态变更  | 拒绝操作     | P2+  |
    | RS-R-03  | URL格式校验        | sourceUrl必须是合法的HTTP/HTTPS URL格式                                       | 创建/更新 | 拒绝操作     | P2+  |
    | RS-R-04  | 名称唯一性校验     | sourceName在全局范围内唯一（需应用层协调）                                    | 创建/更新 | 拒绝操作     | P2+  |
    | RS-R-05  | 连通性测试规则     | 连通性测试发送HTTP HEAD请求，超时时间10秒，返回2xx视为通过                    | 启用      | 拒绝启用     | P2+  |
    | RS-R-06  | 停用前置条件       | 停用外规源时，如有正在执行的采集任务（RUNNING状态），拒绝停用                 | 状态变更  | 拒绝操作     | P2+  |
    | RS-R-07  | 归档前置条件       | 归档外规源时，不得有未完成的采集任务（PENDING/RUNNING/COLLECTED/PARSING状态） | 状态变更  | 拒绝操作     | P2+  |
    | RS-R-08  | 采集频率限制       | 采集频率不得高于每小时1次，不得低于每月1次                                    | 创建/更新 | 拒绝操作     | P2+  |
    | RS-R-09  | 凭证加密存储       | credential中的敏感字段（apiKey、password）必须经AES-256加密后存储             | 创建/更新 | 系统自动加密 | P2+  |

    表 4.2.1-2 RegulationSource业务规则

**（3）业务方法表**

+   RegulationSource业务方法如下表所示

    | 方法名                            | 方法简述                                | 关联规则         | 异常                            | 事件                | 版本 |
    | --------------------------------- | --------------------------------------- | ---------------- | ------------------------------- | ------------------- | ---- |
    | create(command)                   | 创建外规源，状态初始化为DRAFT           | RS-R-01, RS-R-03 | InvalidSourceException          | -                   | P2+  |
    | update(command)                   | 更新外规源基本信息                      | RS-R-03, RS-R-08 | InvalidSourceException          | -                   | P2+  |
    | enable()                          | 启用外规源，DRAFT/DISABLED→ENABLED      | RS-R-02          | IllegalStateTransitionException | SourceEnabledEvent  | P2+  |
    | disable()                         | 停用外规源，ENABLED→DISABLED            | RS-R-06          | IllegalStateTransitionException | SourceDisabledEvent | P2+  |
    | archive()                         | 归档外规源，DISABLED→ARCHIVED           | RS-R-07          | IllegalStateTransitionException | SourceArchivedEvent | P2+  |
    | recordCollectSuccess(collectTime) | 记录采集成功，更新lastCollectTime和计数 | -                | -                               | -                   | P2+  |
    | recordMonitorTime(monitorTime)    | 记录变更监测时间                        | -                | -                               | -                   | P2+  |
    | bindXxlJobId(jobId)               | 绑定XXL-JOB任务ID                       | -                | -                               | -                   | P2+  |

    表 4.2.1-3 RegulationSource业务方法

### 4.2.2 值对象：SourceType

+   SourceType为枚举值对象，表示外规源类型

    | 枚举值      | 说明                               |
    | ----------- | ---------------------------------- |
    | GOV_WEBSITE | 政府/监管机构官方网站              |
    | LAW_DB      | 法律数据库（如北大法宝、威科先行） |
    | API         | 第三方数据API接口                  |
    | RSS         | RSS订阅源                          |
    | MANUAL      | 人工录入（无自动采集能力）         |

    表 4.2.2-1 SourceType枚举值

+   由聚合根管理其生命周期

### 4.2.3 值对象：Url

**（1）属性清单表**

+   Url值对象属性如下表所示

    | 属性名 | 数据类型 | 约束                                | 默认值 | 业务含义      | 版本 |
    | ------ | -------- | ----------------------------------- | ------ | ------------- | ---- |
    | value  | String   | 必填，合法HTTP/HTTPS URL，≤2000字符 | -      | URL地址字符串 | P2+  |

    表 4.2.3-1 Url属性清单

+   值对象检查：不可变（final字段）、构造函数验证URL格式合法性、基于value判断相等、无副作用方法、创建即合法
+   由聚合根管理其生命周期

### 4.2.4 值对象：SourceCredential

**（1）属性清单表**

+   SourceCredential值对象属性如下表所示

    | 属性名       | 数据类型       | 约束                            | 默认值 | 业务含义                                   | 版本 |
    | ------------ | -------------- | ------------------------------- | ------ | ------------------------------------------ | ---- |
    | credType     | CredentialType | 必填                            | -      | 凭证类型（NONE/API_KEY/BASIC_AUTH/OAUTH2） | P2+  |
    | apiKey       | String         | credType=API_KEY时必填，≤500    | null   | API密钥（加密存储）                        | P2+  |
    | username     | String         | credType=BASIC_AUTH时必填，≤100 | null   | 用户名                                     | P2+  |
    | password     | String         | credType=BASIC_AUTH时必填，≤200 | null   | 密码（加密存储）                           | P2+  |
    | tokenUrl     | String         | credType=OAUTH2时必填，≤2000    | null   | OAuth2 Token获取地址                       | P2+  |
    | clientId     | String         | credType=OAUTH2时必填，≤200     | null   | OAuth2 ClientID                            | P2+  |
    | clientSecret | String         | credType=OAUTH2时必填，≤500     | null   | OAuth2 ClientSecret（加密）                | P2+  |

    表 4.2.4-1 SourceCredential属性清单

+   值对象检查：不可变、构造函数根据credType验证必填字段、基于所有属性判断相等、无副作用、创建即合法
+   由聚合根管理其生命周期

### 4.2.5 值对象：CollectSchedule

**（1）属性清单表**

+   CollectSchedule值对象属性如下表所示

    | 属性名         | 数据类型           | 约束                 | 默认值   | 业务含义             | 版本 |
    | -------------- | ------------------ | -------------------- | -------- | -------------------- | ---- |
    | collectCron    | String             | 必填，合法Cron表达式 | -        | 采集调度Cron表达式   | P2+  |
    | monitorCron    | String             | 必填，合法Cron表达式 | -        | 变更监测Cron表达式   | P2+  |
    | retryCount     | Integer            | 必填，0~5            | 3        | 失败重试次数         | P2+  |
    | timeoutMinutes | Integer            | 必填，5~60           | 30       | 任务超时时间（分钟） | P2+  |
    | requestHeaders | Map<String,String> | 可选                 | 空Map    | 自定义HTTP请求头     | P2+  |
    | userAgent      | String             | 可选，≤500           | 系统默认 | 自定义User-Agent     | P2+  |

    表 4.2.5-1 CollectSchedule属性清单

+   值对象检查：不可变、构造函数验证Cron合法性和超时范围、基于所有属性判断相等、无副作用、创建即合法
+   由聚合根管理其生命周期

## 4.3 AGG-02 采集任务聚合（CollectionTask）

### 4.3.1 聚合根：CollectionTask

**（1）属性清单表**

+   CollectionTask聚合根属性如下表所示

    | 属性名        | 数据类型      | 约束                 | 默认值       | 业务含义                             | 版本 |
    | ------------- | ------------- | -------------------- | ------------ | ------------------------------------ | ---- |
    | taskId        | String        | 必填，唯一，UUID格式 | 系统自动生成 | 采集任务唯一标识                     | P1   |
    | sourceId      | String        | 可选，引用AGG-01     | null         | 所属外规源ID（人工录入时可为空）     | P1   |
    | taskType      | TaskType      | 必填                 | -            | 任务类型（AUTO/MANUAL）              | P1   |
    | status        | TaskStatus    | 必填                 | PENDING      | 任务当前状态                         | P1   |
    | targetUrl     | String        | 可选，≤2000          | null         | 本次采集的目标URL（可覆盖外规源URL） | P1   |
    | triggerInfo   | TriggerInfo   | 必填                 | -            | 触发信息（值对象）                   | P1   |
    | collectResult | CollectResult | 可选                 | null         | 采集结果（值对象）                   | P1   |
    | parseResult   | ParseResult   | 可选                 | null         | 解析结果（值对象）                   | P1   |
    | failureInfo   | FailureInfo   | 可选                 | null         | 失败信息（值对象）                   | P1   |
    | retryCount    | Integer       | 可选                 | 0            | 已重试次数                           | P1   |
    | priority      | Integer       | 必填，1~5            | 3            | 任务优先级（1最高）                  | P1   |
    | version       | Integer       | 必填                 | 0            | 乐观锁版本号                         | P1   |
    | createdBy     | String        | 必填，系统注入       | 当前操作人ID | 创建人（系统任务为system）           | P1   |
    | createdAt     | LocalDateTime | 必填，系统注入       | 当前时间     | 创建时间                             | P1   |
    | updatedAt     | LocalDateTime | 必填，系统注入       | 当前时间     | 最后修改时间                         | P1   |

    表 4.3.1-1 CollectionTask属性清单

**（2）业务规则表**

+   CollectionTask业务规则如下表所示

    | 规则编号 | 规则名称             | 规则简述                                                                                                                                 | 验证时机        | 违反后果     | 版本 |
    | -------- | -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | --------------- | ------------ | ---- |
    | CT-R-01  | 定时任务注册规则     | 外规源启用时自动注册XXL-JOB定时任务，停用时暂停任务，归档时删除任务                                                                      | 外规源状态变更  | 系统自动处理 | P2+  |
    | CT-R-02  | 任务创建规则         | 自动采集时sourceId必须存在且外规源为ENABLED状态；人工录入时sourceId可选                                                                  | 创建            | 拒绝操作     | P1   |
    | CT-R-03  | 并发控制规则         | 同一外规源同时只允许一个RUNNING状态的采集任务，通过Redis分布式锁保证                                                                     | PENDING→RUNNING | 跳过本次采集 | P2+  |
    | CT-R-04  | HTTP采集规则         | 采集请求遵循robots.txt协议，请求间隔≥2秒，超时时间取外规源配置值                                                                         | 执行采集        | 记录日志     | P2+  |
    | CT-R-05  | 文件上传规则         | 采集到的原始文档必须上传至BC-13文件管理服务，文件大小≤50MB                                                                               | 采集完成        | 标记FAILED   | P1   |
    | CT-R-06  | 人工录入任务创建规则 | 人工录入直接创建COLLECTED状态任务，跳过PENDING和RUNNING阶段                                                                              | 创建            | -            | P1   |
    | CT-R-07  | 手动创建任务规则     | 手动创建采集任务时必须指定有效的sourceId，targetUrl可选                                                                                  | 创建            | 拒绝操作     | P2+  |
    | CT-R-08  | 重试规则             | 仅FAILED状态任务可重试，retryCount+1。AUTO任务重试时状态回到PENDING等待调度；MANUAL任务重试时状态回到COLLECTED并自动触发解析（FL-RA-04） | 重试            | 拒绝操作     | P1   |
    | CT-R-09  | 取消规则             | 仅PENDING状态任务可取消，RUNNING及之后状态不可取消                                                                                       | 取消            | 拒绝操作     | P1   |
    | CT-R-10  | 状态转换合法性       | 状态变更必须遵循采集任务状态机定义的转换规则表（见2.2.2节）                                                                              | 所有状态变更    | 拒绝操作     | P1   |

    表 4.3.1-2 CollectionTask业务规则

**（3）业务方法表**

+   CollectionTask业务方法如下表所示

    | 方法名                               | 方法简述                                                 | 关联规则         | 异常                            | 事件               | 版本 |
    | ------------------------------------ | -------------------------------------------------------- | ---------------- | ------------------------------- | ------------------ | ---- |
    | createAuto(sourceId, triggerInfo)    | 创建自动采集任务（PENDING）                              | CT-R-02, CT-R-10 | InvalidTaskException            | -                  | P2+  |
    | createManual(sourceId, fileId, meta) | 创建人工录入任务（COLLECTED）                            | CT-R-06          | InvalidTaskException            | -                  | P1   |
    | startRunning()                       | 开始执行，PENDING→RUNNING                                | CT-R-03, CT-R-10 | IllegalStateTransitionException | -                  | P2+  |
    | markCollected(collectResult)         | 采集完成，RUNNING→COLLECTED                              | CT-R-05, CT-R-10 | IllegalStateTransitionException | -                  | P1   |
    | startParsing()                       | 开始解析，COLLECTED→PARSING                              | CT-R-10          | IllegalStateTransitionException | -                  | P1   |
    | markCompleted(parseResult)           | 解析完成，PARSING→COMPLETED                              | CT-R-10          | IllegalStateTransitionException | TaskCompletedEvent | P1   |
    | markFailed(failureInfo)              | 标记失败                                                 | CT-R-10          | IllegalStateTransitionException | -                  | P1   |
    | retry()                              | 重试，AUTO任务FAILED→PENDING，MANUAL任务FAILED→COLLECTED | CT-R-08, CT-R-10 | IllegalStateTransitionException | -                  | P1   |
    | cancel()                             | 取消任务，PENDING→CANCELLED                              | CT-R-09, CT-R-10 | IllegalStateTransitionException | -                  | P1   |

    表 4.3.1-3 CollectionTask业务方法

### 4.3.2 值对象：TriggerInfo

**（1）属性清单表**

+   TriggerInfo值对象属性如下表所示

    | 属性名      | 数据类型      | 约束            | 默认值   | 业务含义                           | 版本 |
    | ----------- | ------------- | --------------- | -------- | ---------------------------------- | ---- |
    | triggerType | TriggerType   | 必填            | -        | 触发类型（SCHEDULED/MANUAL/RETRY） | P1   |
    | triggeredBy | String        | 必填            | -        | 触发者（用户ID或system）           | P1   |
    | triggeredAt | LocalDateTime | 必填            | 当前时间 | 触发时间                           | P1   |
    | xxlJobLogId | Long          | SCHEDULED时可选 | null     | XXL-JOB日志ID                      | P1   |

    表 4.3.2-1 TriggerInfo属性清单

+   由聚合根管理其生命周期

### 4.3.3 值对象：CollectResult

**（1）属性清单表**

+   CollectResult值对象属性如下表所示

    | 属性名         | 数据类型      | 约束 | 默认值 | 业务含义                         | 版本 |
    | -------------- | ------------- | ---- | ------ | -------------------------------- | ---- |
    | fileId         | String        | 必填 | -      | BC-13文件管理返回的文件ID        | P1   |
    | fileName       | String        | 必填 | -      | 原始文件名                       | P1   |
    | fileSize       | Long          | 必填 | -      | 文件大小（字节）                 | P1   |
    | mimeType       | String        | 必填 | -      | 文件MIME类型                     | P1   |
    | contentHash    | String        | 必填 | -      | 文件内容SHA-256哈希值            | P1   |
    | collectedAt    | LocalDateTime | 必填 | -      | 采集完成时间                     | P1   |
    | httpStatusCode | Integer       | 可选 | null   | HTTP响应状态码（自动采集时记录） | P1   |
    | responseTimeMs | Long          | 可选 | null   | HTTP响应耗时（毫秒）             | P1   |

    表 4.3.3-1 CollectResult属性清单

+   由聚合根管理其生命周期

### 4.3.4 值对象：ParseResult

**（1）属性清单表**

+   ParseResult值对象属性如下表所示

    | 属性名       | 数据类型       | 约束 | 默认值 | 业务含义                                 | 版本 |
    | ------------ | -------------- | ---- | ------ | ---------------------------------------- | ---- |
    | documentId   | String         | 必填 | -      | 关联的RawDocument聚合ID                  | P1   |
    | parsedFormat | String         | 必填 | -      | 解析源格式（固定为PDF，由Doc2X API解析） | P1   |
    | mdFileId     | String         | 必填 | -      | API解析生成的MD文件ID（BC-13）           | P1   |
    | imageFileIds | List\<String\> | 可选 | 空列表 | API解析提取的图片文件ID列表（BC-13）     | P1   |
    | sectionCount | Integer        | 必填 | -      | 结构化拆分后的章节数量                   | P1   |
    | clauseCount  | Integer        | 必填 | -      | 结构化拆分后的条款数量                   | P1   |
    | qualityScore | Integer        | 必填 | -      | 质量评分（0~100）                        | P1   |
    | parsedAt     | LocalDateTime  | 必填 | -      | API解析完成时间                          | P1   |
    | parseTimeMs  | Long           | 必填 | -      | API解析耗时（毫秒）                      | P1   |

    表 4.3.4-1 ParseResult属性清单

+   由聚合根管理其生命周期

### 4.3.5 值对象：FailureInfo

**（1）属性清单表**

+   FailureInfo值对象属性如下表所示

    | 属性名       | 数据类型      | 约束        | 默认值 | 业务含义                         | 版本 |
    | ------------ | ------------- | ----------- | ------ | -------------------------------- | ---- |
    | failedAt     | LocalDateTime | 必填        | -      | 失败时间                         | P1   |
    | failedStep   | String        | 必填，≤50   | -      | 失败步骤（COLLECTING/PARSING等） | P1   |
    | errorCode    | String        | 必填，≤20   | -      | 错误码                           | P1   |
    | errorMessage | String        | 必填，≤1000 | -      | 错误信息                         | P1   |
    | stackTrace   | String        | 可选，≤5000 | null   | 异常堆栈（仅开发调试用）         | P1   |

    表 4.3.5-1 FailureInfo属性清单

+   由聚合根管理其生命周期

## 4.4 AGG-03 原始文档聚合（RawDocument）

### 4.4.1 聚合根：RawDocument

**（1）属性清单表**

+   RawDocument聚合根属性如下表所示

    | 属性名            | 数据类型          | 约束                 | 默认值       | 业务含义                                                                                               | 版本 |
    | ----------------- | ----------------- | -------------------- | ------------ | ------------------------------------------------------------------------------------------------------ | ---- |
    | documentId        | String            | 必填，唯一，UUID格式 | 系统自动生成 | 原始文档唯一标识                                                                                       | P1   |
    | taskId            | String            | 必填，引用AGG-02     | -            | 关联的采集任务ID                                                                                       | P1   |
    | sourceId          | String            | 可选，引用AGG-01     | null         | 来源外规源ID（人工录入时可为空）                                                                       | P1   |
    | regulationMeta    | RegulationMeta    | 必填                 | -            | 外规元数据（值对象）                                                                                   | P1   |
    | fileRef           | FileReference     | 必填                 | -            | 原始PDF文件引用信息（值对象）                                                                          | P1   |
    | mdFileId          | String            | 可选                 | null         | Doc2X API解析生成的MD文件ID（BC-13），MD_READY后有值                                                   | P1   |
    | imageFileIds      | List\<String\>    | 可选                 | 空列表       | Doc2X API解析提取的图片文件ID列表（BC-13），人工阶段可增删                                             | P1   |
    | structuredContent | StructuredContent | 可选                 | null         | 结构化内容（值对象），实际存储为T-04 idx_structured_content中的ContentNode文档集合，详见4.4.8节和7.5节 | P1   |
    | qualityScore      | Integer           | 可选，0~100          | null         | 解析质量评分                                                                                           | P1   |
    | status            | DocumentStatus    | 必填                 | RAW          | 文档状态（RAW/MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED），详见2.2.4节状态机定义       | P1   |
    | reviewInfo        | ReviewInfo        | 可选                 | null         | 审核信息（值对象）                                                                                     | P1   |
    | version           | Integer           | 必填                 | 0            | 乐观锁版本号                                                                                           | P1   |
    | createdAt         | LocalDateTime     | 必填，系统注入       | 当前时间     | 创建时间                                                                                               | P1   |
    | updatedAt         | LocalDateTime     | 必填，系统注入       | 当前时间     | 最后修改时间                                                                                           | P1   |

    表 4.4.1-1 RawDocument属性清单

**（2）业务规则表**

+   RawDocument业务规则如下表所示

    | 规则编号 | 规则名称          | 规则简述                                                                                                                                 | 验证时机      | 违反后果   | 版本 |
    | -------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ------------- | ---------- | ---- |
    | RD-R-01  | 支持文件格式      | 支持的文件格式为PDF，其他格式拒绝                                                                                                        | 创建          | 拒绝操作   | P1   |
    | RD-R-02  | 外部API解析       | 通过Doc2X外部API（https://v2.doc2x.noedgeai.com）进行PDF文档解析，返回压缩包（含MD文件+images目录）                                      | 解析          | 标记FAILED | P1   |
    | RD-R-03  | 结构化内容存储    | 结构化内容以段落级颗粒度存储于ES索引（idx_structured_content），每个ContentNode为一条独立ES文档                                          | 拆分完成      | -          | P1   |
    | RD-R-04  | 外规元数据完整性  | 人工录入时regulationName和publishOrgs为必填                                                                                              | 创建/更新     | 拒绝操作   | P1   |
    | RD-R-05  | 结构化提取规则    | MD结构化拆分时保留标题层次（最多6级）、章节结构、条款编号、附录和表格，每个最小段落为一条ContentNode记录，含图片引用                     | 拆分          | 部分提取   | P1   |
    | RD-R-06  | 质量评分规则      | 评分维度：结构完整度(40%)、内容提取率(40%)、格式规范度(20%)                                                                              | 拆分完成      | -          | P1   |
    | RD-R-07  | 审核校正规则      | 审核时UP-01可直接修改结构化内容（目录树、条款、附录等），确认后文档状态变为APPROVED                                                      | 审核确认      | -          | P1   |
    | RD-R-08  | 附件排序规则      | 同一文档下的附件按sortOrder字段升序排列，sortOrder由创建顺序自动生成                                                                     | 创建/更新     | -          | P1   |
    | RD-R-09  | 版本链一致性      | 同一外规的多次采集形成版本链，通过regulationMeta.regulationCode关联，版本号递增                                                          | 创建          | -          | P1   |
    | RD-R-10  | Doc2X API调用规则 | API调用超时30秒，失败自动重试2次（间隔5秒），返回压缩包需校验完整性（含MD文件且非空）                                                    | 解析          | 标记FAILED | P1   |
    | RD-R-11  | 解析产物留存规则  | API返回的MD文件和images目录中的图片均须上传至BC-13持久化存储，通过Attachment值对象关联至原始文档                                         | 解析完成      | 标记FAILED | P1   |
    | RD-R-12  | 人工比对校正规则  | UP-01须对照原始PDF逐页比对MD内容，修正解析错误和格式问题；P1使用普通文本编辑器，P2+可使用MD编辑器                                        | 人工校正      | -          | P1   |
    | RD-R-13  | JSON校验规则      | UP-01须校验结构化拆分后的JSON完整性和准确性，包括章节层次、条款内容、图片引用；P1使用文本编辑器，P2+可使用可视化编辑器（JSON转页面展示） | 再次校验      | -          | P1   |
    | RD-R-14  | 图片管理规则      | 人工校正和再次校验阶段均支持上传新图片、替换已有图片、删除错误的图片关联；图片统一存储于BC-13，通过文件ID关联                            | 人工校正/校验 | -          | P1   |

    表 4.4.1-2 RawDocument业务规则

**（3）业务方法表**

+   RawDocument业务方法如下表所示

    | 方法名                                                | 方法简述                                         | 关联规则                  | 异常                     | 事件                  | 版本 |
    | ----------------------------------------------------- | ------------------------------------------------ | ------------------------- | ------------------------ | --------------------- | ---- |
    | create(taskId, sourceId, meta, fileRef)               | 创建原始文档记录                                 | RD-R-01, RD-R-04          | InvalidDocumentException | -                     | P1   |
    | applyParseProducts(mdFileId, imageFileIds)            | 关联API解析产物（MD+图片），状态→MD_READY        | RD-R-11                   | ParseException           | -                     | P1   |
    | submitMdCorrection(correctedMdFileId, imageChanges)   | 提交MD校正结果和图片变更，状态→MD_CORRECTED      | RD-R-12, RD-R-14          | IllegalStateException    | -                     | P1   |
    | applyStructuredContent(content, qualityScore)         | 填充结构化内容和质量评分，状态→JSON_READY        | RD-R-03, RD-R-05, RD-R-06 | ParseException           | -                     | P1   |
    | submitJsonVerification(verifiedContent, imageChanges) | 提交JSON校验结果和图片变更，状态→PENDING_PUBLISH | RD-R-13, RD-R-14          | IllegalStateException    | -                     | P1   |
    | confirmPublish(userId)                                | 正式发布，状态→APPROVED                          | RD-R-07                   | IllegalStateException    | DocumentApprovedEvent | P1   |
    | updateMeta(meta)                                      | 更新外规元数据                                   | RD-R-04                   | InvalidDocumentException | -                     | P1   |
    | rollbackToRaw()                                       | 回退至RAW状态，重新触发API解析                   | -                         | IllegalStateException    | -                     | P1   |
    | rollbackToMdReady()                                   | 从JSON_READY回退至MD_READY，重新开放MD编辑       | -                         | IllegalStateException    | -                     | P1   |

    表 4.4.1-3 RawDocument业务方法

### 4.4.2 值对象：RegulationMeta

**（1）属性清单表**

+   RegulationMeta值对象属性如下表所示

    | 属性名                 | 数据类型               | 约束          | 默认值     | 业务含义                                                                                                  | 版本 |
    | ---------------------- | ---------------------- | ------------- | ---------- | --------------------------------------------------------------------------------------------------------- | ---- |
    | regulationName         | String                 | 必填，≤500    | -          | 外规名称                                                                                                  | P1   |
    | regulationCode         | String                 | 可选，≤100    | null       | 外规编号（如"银发〔2024〕15号"、"GB/T 38600-2020"）                                                       | P1   |
    | publishOrgs            | List\<String\>         | 必填，至少1项 | -          | 发文机构数组（支持联合发文，如["中国人民银行", "银保监会"]）                                              | P1   |
    | publishDate            | LocalDate              | 可选          | null       | 发布日期                                                                                                  | P1   |
    | effectiveDate          | LocalDate              | 可选          | null       | 生效日期                                                                                                  | P1   |
    | expiryDate             | LocalDate              | 可选          | null       | 失效/废止日期                                                                                             | P1   |
    | regulationType         | String                 | 可选，≤50     | null       | 外规类型（法律/行政法规/部门规章/规范性文件/国家标准/行业标准/地方标准/团体标准/企业标准/指引/通知/公告） | P1   |
    | industryTags           | List\<String\>         | 可选          | 空列表     | 行业标签                                                                                                  | P1   |
    | sortCategory           | SortCategory           | 必填          | REGULATION | 编码排序规则枚举（REGULATION法规类/STANDARD标准类/CUSTOM自定义类）                                        | P1   |
    | sortWeight             | Integer                | 可选          | 100        | 排序权重（同类别内自定义排序，数值越小越靠前）                                                            | P1   |
    | language               | String                 | 必填          | zh-CN      | 语言（zh-CN简体中文/zh-TW繁体中文/en英文/ja日文/other其他）                                               | P1   |
    | equivalentIntlStandard | EquivalentIntlStandard | 可选          | null       | 等同国际标准信息（仅sortCategory=STANDARD时有意义）                                                       | P1   |

    表 4.4.2-1 RegulationMeta属性清单

+   由聚合根管理其生命周期

### 4.4.3 值对象：FileReference

**（1）属性清单表**

+   FileReference值对象属性如下表所示

    | 属性名      | 数据类型 | 约束         | 默认值 | 业务含义              | 版本 |
    | ----------- | -------- | ------------ | ------ | --------------------- | ---- |
    | fileId      | String   | 必填         | -      | BC-13文件管理的文件ID | P1   |
    | fileName    | String   | 必填，≤500   | -      | 原始文件名            | P1   |
    | fileSize    | Long     | 必填         | -      | 文件大小（字节）      | P1   |
    | mimeType    | String   | 必填，≤100   | -      | MIME类型              | P1   |
    | contentHash | String   | 必填，64字符 | -      | SHA-256哈希值         | P1   |

    表 4.4.3-1 FileReference属性清单

+   由聚合根管理其生命周期

### 4.4.4 值对象：Attachment

**（1）属性清单表**

+   Attachment值对象属性如下表所示

    | 属性名           | 数据类型         | 约束        | 默认值   | 业务含义                                                                                                        | 版本 |
    | ---------------- | ---------------- | ----------- | -------- | --------------------------------------------------------------------------------------------------------------- | ---- |
    | attachmentId     | String           | 必填，UUID  | 自动生成 | 附件唯一ID                                                                                                      | P1   |
    | attachmentNo     | String           | 可选，≤50   | null     | 附件编号（保留原文格式，如"附件1"、"附录A"、"Annex I"）                                                         | P1   |
    | attachmentName   | String           | 必填，≤500  | -        | 附件名称/标题                                                                                                   | P1   |
    | attachmentNature | AttachmentNature | 必填        | ANNEX    | 附件性质枚举（APPENDIX附录/ANNEX附件/SUPPLEMENT补充/AMENDMENT修正案/INTERPRETATION释义/FORM表格样式/OTHER其他） | P1   |
    | sourcePosition   | String           | 可选，≤200  | null     | 原文位置描述（如"第三章第15条后"、"正文末尾"）                                                                  | P1   |
    | fileRef          | FileReference    | 必填        | -        | 附件文件引用（复用FileReference值对象）                                                                         | P1   |
    | sortOrder        | Integer          | 必填        | -        | 排序序号（从1开始，决定附件显示顺序）                                                                           | P1   |
    | isStructured     | Boolean          | 必填        | false    | 是否已完成结构化解析                                                                                            | P1   |
    | description      | String           | 可选，≤1000 | null     | 附件说明/摘要                                                                                                   | P1   |

    表 4.4.4-1 Attachment属性清单

+   由聚合根管理其生命周期

### 4.4.5 值对象：VersionRecord

**（1）属性清单表**

+   VersionRecord值对象属性如下表所示

    | 属性名            | 数据类型          | 约束        | 默认值   | 业务含义                                                                                             | 版本 |
    | ----------------- | ----------------- | ----------- | -------- | ---------------------------------------------------------------------------------------------------- | ---- |
    | versionNo         | String            | 必填，≤100  | -        | 版本号（如"2020版"、"第二次修订"、"V2.0"）                                                           | P1   |
    | changeType        | VersionChangeType | 必填        | -        | 变更类型枚举（INITIAL初始发布/REVISION修订/AMENDMENT修正/SUPERSEDE替代/ABOLISH废止/REISSUE重新发布） | P1   |
    | changeDate        | LocalDate         | 可选        | null     | 变更日期                                                                                             | P1   |
    | changeDescription | String            | 可选，≤2000 | null     | 变更说明                                                                                             | P1   |
    | relatedDocumentId | String            | 可选        | null     | 关联的历史版本documentId（指向前一版本或替代版本）                                                   | P1   |
    | operator          | String            | 可选        | null     | 操作人                                                                                               | P1   |
    | operatedAt        | LocalDateTime     | 必填        | 当前时间 | 操作时间                                                                                             | P1   |

    表 4.4.5-1 VersionRecord属性清单

+   由聚合根管理其生命周期

### 4.4.6 值对象：EquivalentIntlStandard

**（1）属性清单表**

+   EquivalentIntlStandard值对象属性如下表所示

    | 属性名              | 数据类型     | 约束        | 默认值 | 业务含义                                          | 版本 |
    | ------------------- | ------------ | ----------- | ------ | ------------------------------------------------- | ---- |
    | intlStandardCode    | String       | 必填，≤100  | -      | 国际标准编号（如"ISO 9001:2015"、"IEC 61508"）    | P1   |
    | intlStandardName    | String       | 可选，≤500  | null   | 国际标准名称                                      | P1   |
    | adoptionType        | AdoptionType | 必填        | -      | 采用类型枚举（IDT等同采用/MOD修改采用/NEQ非等效） | P1   |
    | adoptionDescription | String       | 可选，≤2000 | null   | 采用说明（修改采用时说明修改内容）                | P1   |

    表 4.4.6-1 EquivalentIntlStandard属性清单

+   由聚合根管理其生命周期
+   IDT（identical）：技术内容完全一致
+   MOD（modified）：技术内容有修改，需在adoptionDescription中说明差异
+   NEQ（not equivalent）：仅参考，技术内容有重大差异

### 4.4.7 值对象：ReviewInfo

**（1）属性清单表**

+   ReviewInfo值对象属性如下表所示

    | 属性名     | 数据类型      | 约束        | 默认值 | 业务含义     | 版本 |
    | ---------- | ------------- | ----------- | ------ | ------------ | ---- |
    | reviewedBy | String        | 必填        | -      | 审核人用户ID | P1   |
    | reviewedAt | LocalDateTime | 必填        | -      | 审核时间     | P1   |
    | comment    | String        | 可选，≤1000 | null   | 审核备注     | P1   |

    表 4.4.7-1 ReviewInfo属性清单

+   由聚合根管理其生命周期

### 4.4.8 实体：ContentNode

+   ContentNode是结构化内容的最小存储单元，每条ES文档对应一个ContentNode实例。

**（1）属性清单表**

+   ContentNode实体属性如下表所示

    | 属性名             | 数据类型       | 约束                 | 默认值   | 业务含义                                                                                                    | 版本 |
    | ------------------ | -------------- | -------------------- | -------- | ----------------------------------------------------------------------------------------------------------- | ---- |
    | contentId          | String         | 必填，唯一，UUID格式 | 自动生成 | 内容记录唯一标识                                                                                            | P1   |
    | documentId         | String         | 必填                 | -        | 所属文档ID（关联RawDocument.documentId）                                                                    | P1   |
    | attachmentId       | String         | 可选                 | null     | 所属附件ID（属于附件时关联Attachment.attachmentId，主件内容为空）                                           | P1   |
    | parentId           | String         | 可选                 | null     | 父节点contentId（顶级节点为空）                                                                             | P1   |
    | depth              | Integer        | 必填                 | 0        | 层级深度（从0开始，0=顶级章节/编/篇）                                                                       | P1   |
    | sortOrder          | Integer        | 必填                 | 1        | 兄弟节点间的排序序号（同一parentId下的排序，从1开始）                                                       | P1   |
    | path               | String         | 必填                 | -        | 物化路径（如"/root/ch1/sec2/art5"），便于范围查询和层级过滤                                                 | P1   |
    | contentType        | ContentType    | 必填                 | -        | 内容类别枚举（TOC目录/PARAGRAPH文本段落/TABLE表格/FIGURE图形/FORMULA公式/NOTE注释/ARTICLE_CONTAINER条容器） | P1   |
    | isArticleContainer | Boolean        | 必填                 | false    | 是否为法规"条"容器。为true时表示此节点是法规中的"条"，显示时其标题应与第一个子款内容合并展示                | P1   |
    | clauseNumber       | String         | 可选                 | null     | 条款号（如"第一条"、"第15条"、"3.2.1"、"Article 5"）                                                        | P1   |
    | headingText        | String         | 可选                 | null     | 标题/章节名（如"总则"、"资本充足率管理"）。TOC和ARTICLE_CONTAINER类型使用                                   | P1   |
    | elementTitle       | String         | 可选                 | null     | 表格/图形标题（如"表1 风险权重表"、"图2-1 流程示意图"）。仅TABLE或FIGURE类型使用                            | P1   |
    | textContent        | String         | 可选                 | null     | 段落正文。对于TOC/ARTICLE_CONTAINER类型可为空（仅有标题）                                                   | P1   |
    | rawHtml            | String         | 可选                 | null     | 原始HTML内容（保留格式信息，不索引，仅存储）                                                                | P1   |
    | tableData          | String(JSON)   | 可选                 | null     | 表格结构化数据（JSON对象，含行列信息）。仅TABLE类型使用                                                     | P1   |
    | figureUrl          | String         | 可选                 | null     | 图形文件引用（BC-13文件ID或URL）。仅FIGURE类型使用                                                          | P1   |
    | normalizedTags     | List\<String\> | 可选                 | 空列表   | 归一化标签（如["资本要求", "风险管理"]），由下游BC-52知识工程回写或人工标注                                 | P1   |
    | semanticType       | String         | 可选                 | null     | 语义类型标签（如"定义"、"要求"、"例外"、"处罚"、"过渡条款"），辅助知识工程提取                              | P1   |
    | charCount          | Integer        | 可选                 | null     | 本段落字符数                                                                                                | P1   |
    | isLeaf             | Boolean        | 必填                 | true     | 是否叶子节点（无子节点）                                                                                    | P1   |
    | childrenCount      | Integer        | 必填                 | 0        | 子节点数量                                                                                                  | P1   |
    | version            | Integer        | 必填                 | 0        | 乐观锁版本号                                                                                                | P1   |
    | createdAt          | LocalDateTime  | 必填，系统注入       | 当前时间 | 创建时间                                                                                                    | P1   |
    | updatedAt          | LocalDateTime  | 必填，系统注入       | 当前时间 | 最后修改时间                                                                                                | P1   |

    表 4.4.8-1 ContentNode属性清单

**（2）法规"条"容器的显示规则**

+   法规中的"条"（Article）具有特殊的显示约定——条的标题（如"第十五条"）与第一款的内容在显示时合并为一行
+   数据模型上，"条"为一个isArticleContainer=true的ARTICLE_CONTAINER节点，其下的每一款为独立的PARAGRAPH子节点
+   前端渲染时：取该节点的clauseNumber，拼接sortOrder=1的第一个子节点的textContent，渲染为一行；第二款起正常缩进换行显示

**（3）ContentNode类别枚举说明**

+   ContentNode的contentType枚举说明如下表所示

    | 枚举值            | 含义         | 可有子节点 | textContent | headingText  | elementTitle | 典型示例                        |
    | ----------------- | ------------ | ---------- | ----------- | ------------ | ------------ | ------------------------------- |
    | TOC               | 目录/标题    | 是         | 通常为空    | 必填         | -            | "第一章 总则"、"3.2 术语和定义" |
    | PARAGRAPH         | 文本段落     | 否（叶子） | 必填        | -            | -            | 每一个换行分隔的自然段          |
    | TABLE             | 表格         | 否（叶子） | 可有        | -            | 有（表标题） | "表1 风险权重系数表"            |
    | FIGURE            | 图形         | 否（叶子） | 可有        | -            | 有（图标题） | "图2-1 审批流程图"              |
    | FORMULA           | 公式         | 否（叶子） | 有          | -            | -            | 数学公式                        |
    | NOTE              | 注释/备注    | 否（叶子） | 有          | -            | -            | "注：本条所称..."               |
    | ARTICLE_CONTAINER | 法规"条"容器 | 是         | 通常为空    | 有（条标题） | -            | "第十五条"                      |

    表 4.4.8-2 ContentNode类别枚举说明

## 4.5 AGG-04 变更监测聚合（ChangeMonitorTask）

### 4.5.1 聚合根：ChangeMonitorTask

**（1）属性清单表**

+   ChangeMonitorTask聚合根属性如下表所示

    | 属性名         | 数据类型       | 约束                 | 默认值       | 业务含义               | 版本 |
    | -------------- | -------------- | -------------------- | ------------ | ---------------------- | ---- |
    | monitorTaskId  | String         | 必填，唯一，UUID格式 | 系统自动生成 | 监测任务唯一标识       | P2+  |
    | sourceId       | String         | 必填，引用AGG-01     | -            | 所属外规源ID           | P2+  |
    | regulationId   | String         | 可选，引用AGG-03     | null         | 关联的已入库外规文档ID | P2+  |
    | status         | MonitorStatus  | 必填                 | PENDING      | 监测任务状态           | P2+  |
    | previousHash   | String         | 可选，64字符         | null         | 上次内容哈希值         | P2+  |
    | currentHash    | String         | 可选，64字符         | null         | 本次内容哈希值         | P2+  |
    | changeSnapshot | ChangeSnapshot | 可选                 | null         | 变更快照（值对象）     | P2+  |
    | changeDiff     | ChangeDiff     | 可选                 | null         | 变更差异（值对象）     | P2+  |
    | detectionInfo  | DetectionInfo  | 可选                 | null         | 检测信息（值对象）     | P2+  |
    | version        | Integer        | 必填                 | 0            | 乐观锁版本号           | P2+  |
    | createdAt      | LocalDateTime  | 必填，系统注入       | 当前时间     | 创建时间               | P2+  |
    | updatedAt      | LocalDateTime  | 必填，系统注入       | 当前时间     | 最后修改时间           | P2+  |

    表 4.5.1-1 ChangeMonitorTask属性清单

**（2）业务规则表**

+   ChangeMonitorTask业务规则如下表所示

    | 规则编号 | 规则名称     | 规则简述                                                                 | 验证时机 | 违反后果 | 版本 |
    | -------- | ------------ | ------------------------------------------------------------------------ | -------- | -------- | ---- |
    | CM-R-01  | 监测触发条件 | 仅对ENABLED状态的外规源执行变更监测                                      | 触发     | 跳过本次 | P2+  |
    | CM-R-02  | 页面获取规则 | 获取外规源页面时复用外规源的凭证和请求头配置                             | 检测     | -        | P2+  |
    | CM-R-03  | 哈希对比规则 | 使用SHA-256算法计算页面内容哈希，忽略空白字符和时间戳变化                | 检测     | -        | P2+  |
    | CM-R-04  | 变更快照规则 | 检测到变更时保存前后两版内容快照，快照保留最近10个版本                   | 有变更   | -        | P2+  |
    | CM-R-05  | 差异生成规则 | 逐段对比生成差异报告，标识新增/修改/删除的条款，输出统一差异格式         | 差异生成 | -        | P2+  |
    | CM-R-06  | 通知规则     | 变更差异报告生成后，通过BC-12消息通知服务通知UP-01外规采集员和相关UP角色 | 已通知   | -        | P2+  |

    表 4.5.1-2 ChangeMonitorTask业务规则

**（3）业务方法表**

+   ChangeMonitorTask业务方法如下表所示

    | 方法名                                   | 方法简述                              | 关联规则         | 异常                            | 事件                   | 版本 |
    | ---------------------------------------- | ------------------------------------- | ---------------- | ------------------------------- | ---------------------- | ---- |
    | create(sourceId, previousHash)           | 创建监测任务（PENDING）               | CM-R-01          | -                               | -                      | P2+  |
    | startDetecting()                         | 开始检测，PENDING→DETECTING           | -                | IllegalStateTransitionException | -                      | P2+  |
    | markNoChange(currentHash, detectionInfo) | 无变更，DETECTING→NO_CHANGE           | CM-R-03          | -                               | -                      | P2+  |
    | markChanged(currentHash, snapshot)       | 有变更，DETECTING→CHANGED             | CM-R-03, CM-R-04 | -                               | -                      | P2+  |
    | startDiffGenerating()                    | 开始差异生成，CHANGED→DIFF_GENERATING | -                | IllegalStateTransitionException | -                      | P2+  |
    | markNotified(changeDiff)                 | 已通知，DIFF_GENERATING→NOTIFIED      | CM-R-05, CM-R-06 | -                               | RegulationChangedEvent | P2+  |
    | markFailed(errorMessage)                 | 标记失败                              | -                | -                               | -                      | P2+  |
    | retry()                                  | 重试，FAILED→PENDING                  | -                | IllegalStateTransitionException | -                      | P2+  |

    表 4.5.1-3 ChangeMonitorTask业务方法

### 4.5.2 值对象：ChangeSnapshot、ChangeDiff、DetectionInfo

+   ChangeSnapshot值对象属性如下表所示

    | 属性名          | 数据类型      | 约束 | 默认值 | 业务含义                 | 版本 |
    | --------------- | ------------- | ---- | ------ | ------------------------ | ---- |
    | previousContent | String(TEXT)  | 必填 | -      | 变更前内容（可压缩存储） | P2+  |
    | currentContent  | String(TEXT)  | 必填 | -      | 变更后内容（可压缩存储） | P2+  |
    | snapshotAt      | LocalDateTime | 必填 | -      | 快照时间                 | P2+  |

    表 4.5.2-1 ChangeSnapshot属性清单

+   ChangeDiff值对象属性如下表所示

    | 属性名          | 数据类型      | 约束 | 默认值 | 业务含义                         | 版本 |
    | --------------- | ------------- | ---- | ------ | -------------------------------- | ---- |
    | addedClauses    | String(JSON)  | 必填 | -      | 新增条款列表（JSON）             | P2+  |
    | modifiedClauses | String(JSON)  | 必填 | -      | 修改条款列表（JSON，含前后对比） | P2+  |
    | deletedClauses  | String(JSON)  | 必填 | -      | 删除条款列表（JSON）             | P2+  |
    | addedCount      | Integer       | 必填 | -      | 新增条款数                       | P2+  |
    | modifiedCount   | Integer       | 必填 | -      | 修改条款数                       | P2+  |
    | deletedCount    | Integer       | 必填 | -      | 删除条款数                       | P2+  |
    | diffGeneratedAt | LocalDateTime | 必填 | -      | 差异生成时间                     | P2+  |

    表 4.5.2-2 ChangeDiff属性清单

+   DetectionInfo值对象属性如下表所示

    | 属性名         | 数据类型      | 约束 | 默认值 | 业务含义               | 版本 |
    | -------------- | ------------- | ---- | ------ | ---------------------- | ---- |
    | detectedAt     | LocalDateTime | 必填 | -      | 检测时间               | P2+  |
    | responseTimeMs | Long          | 必填 | -      | 外规源响应耗时（毫秒） | P2+  |
    | httpStatusCode | Integer       | 必填 | -      | HTTP响应状态码         | P2+  |

    表 4.5.2-3 DetectionInfo属性清单

+   以上三个值对象均由聚合根管理其生命周期

## 4.6 领域服务

+   BC-51领域服务清单如下表所示

    | 服务名称                 | 职责说明                                                                    | 涉及聚合       | 版本 |
    | ------------------------ | --------------------------------------------------------------------------- | -------------- | ---- |
    | DocumentParseService     | 协调解析流程，编排Doc2X API调用、压缩包解压、MD和图片留存、MD结构化拆分入ES | AGG-02, AGG-03 | P1   |
    | RegulationCollectService | 协调采集流程，编排采集任务创建、HTTP请求、文件上传、状态更新                | AGG-01, AGG-02 | P2+  |
    | ChangeMonitorService     | 协调变更监测流程，编排页面获取、哈希对比、差异生成、通知                    | AGG-01, AGG-04 | P2+  |

    表 4.7-1 领域服务清单

+   **说明**：上述领域服务涉及跨聚合操作和基础设施编排（HTTP请求、文件服务调用），因此作为领域服务而非聚合根方法。领域服务中的业务决策（如哈希对比、质量评分）委托给对应聚合根或值对象执行，领域服务仅负责编排协调。P1阶段仅实现DocumentParseService。

## 4.7 领域事件

+   BC-51领域事件清单如下表所示

    | 事件名称                 | 触发时机                         | 发布聚合 | 消费方                       | 版本      |
    | ------------------------ | -------------------------------- | -------- | ---------------------------- | --------- |
    | RegulationCollectedEvent | 文档审核通过（APPROVED）         | AGG-03   | BC-52 知识工程               | v1        |
    | RegulationChangedEvent   | 变更监测差异报告生成（NOTIFIED） | AGG-04   | BC-31合规管理, BC-53运营分发 | v1（P2+） |

    表 4.8-1 领域事件清单

### 4.7.1 RegulationCollectedEvent

+   RegulationCollectedEvent事件字段如下表所示

    | 字段名         | 数据类型      | 必填 | 业务含义                     |
    | -------------- | ------------- | ---- | ---------------------------- |
    | eventId        | String        | 是   | 事件唯一标识（幂等用）       |
    | eventVersion   | String        | 是   | 事件版本号（v1）             |
    | occurredOn     | LocalDateTime | 是   | 事件发生时间                 |
    | aggregateId    | String        | 是   | 原始文档ID（documentId）     |
    | aggregateType  | String        | 是   | RawDocument                  |
    | documentId     | String        | 是   | 原始文档ID                   |
    | sourceId       | String        | 否   | 外规源ID（人工录入时可为空） |
    | regulationName | String        | 是   | 外规名称                     |
    | regulationCode | String        | 否   | 外规编号                     |
    | publishOrgs    | List<String>  | 是   | 发文机构数组                 |
    | publishDate    | LocalDate     | 否   | 发布日期                     |
    | fileId         | String        | 是   | BC-13文件ID                  |
    | contentHash    | String        | 是   | 内容哈希值                   |
    | qualityScore   | Integer       | 是   | 解析质量评分                 |

    表 4.7.1-1 RegulationCollectedEvent事件字段

### 4.7.2 RegulationChangedEvent

+   RegulationChangedEvent事件字段如下表所示

    | 字段名         | 数据类型      | 必填 | 业务含义                    |
    | -------------- | ------------- | ---- | --------------------------- |
    | eventId        | String        | 是   | 事件唯一标识（幂等用）      |
    | eventVersion   | String        | 是   | 事件版本号（v1）            |
    | occurredOn     | LocalDateTime | 是   | 事件发生时间                |
    | aggregateId    | String        | 是   | 监测任务ID（monitorTaskId） |
    | aggregateType  | String        | 是   | ChangeMonitorTask           |
    | sourceId       | String        | 是   | 外规源ID                    |
    | regulationId   | String        | 否   | 关联的已入库外规ID          |
    | regulationName | String        | 是   | 外规名称                    |
    | changeType     | String        | 是   | 变更类型（CONTENT_CHANGE）  |
    | addedCount     | Integer       | 是   | 新增条款数                  |
    | modifiedCount  | Integer       | 是   | 修改条款数                  |
    | deletedCount   | Integer       | 是   | 删除条款数                  |
    | diffSummary    | String        | 是   | 变更摘要（≤500字符）        |

    表 4.7.2-1 RegulationChangedEvent事件字段

+   **内部领域事件与外部集成事件的区别说明**：
    -   **内部领域事件**：通过Spring ApplicationEvent在服务进程内发布，用于服务内部的异步协调。包括DocumentApprovedEvent（正式发布，触发外部事件发布）、TaskCompletedEvent（任务完成）等。这些事件不出服务边界，不写入本地事件表，不发送至Kafka。
    -   **外部集成事件**：通过Outbox模式（本地事件表T-09 + Kafka）发布，用于跨BC通信。即上表中的RegulationCollectedEvent和RegulationChangedEvent。
    -   **转换关系**：内部事件触发应用服务编排外部事件的发布。例如：RawDocument.approveWithCorrection()产生内部DocumentApprovedEvent → 应用服务监听后将RegulationCollectedEvent写入本地事件表 → 异步发布至Kafka通知BC-52。

# 5 应用层设计

## 5.1 应用层职责说明

+   应用层是领域层与接口层之间的协调层，负责用例编排、事务管理和DTO转换
+   BC-51应用层承担与不承担的职责如下表所示

    | 职责类型   | 应用层承担                                     | 应归属其他层                 |
    | ---------- | ---------------------------------------------- | ---------------------------- |
    | 用例编排   | ✓ 协调领域对象完成采集、解析、审核、监测等用例 | -                            |
    | 事务管理   | ✓ 定义事务边界，一个方法对应一个用例           | -                            |
    | 权限校验   | ✓ 调用BC-10权限服务做前置校验                  | -                            |
    | DTO转换    | ✓ 入参转Command，出参转DTO                     | -                            |
    | 事件发布   | ✓ 事务提交后收集并发布领域事件至Kafka          | -                            |
    | 分布式锁   | ✓ 采集任务执行前获取/释放Redis分布式锁         | -                            |
    | 外部调用   | ✓ 协调调用BC-13文件服务、BC-12通知服务         | -                            |
    | 业务逻辑   | ✗                                              | 领域层（聚合根、领域服务）   |
    | 业务校验   | ✗                                              | 领域层（业务规则）           |
    | 数据持久化 | ✗                                              | 基础设施层（Repository实现） |
    | HTTP处理   | ✗                                              | 接口层（Controller）         |

    表 5.1-1 应用层职责边界

## 5.2 应用服务清单

+   BC-51包含2个应用服务（P1），P2+扩展2个，各服务职责如下表所示

    | 服务名称                      | 职责                                                 | 涉及聚合       | 版本 |
    | ----------------------------- | ---------------------------------------------------- | -------------- | ---- |
    | CollectionTaskAppService      | 采集任务管理与执行编排                               | AGG-02, AGG-03 | P1   |
    | DocumentParseReviewAppService | 格式解析六阶段人工交互（比对、校验、发布）及图片管理 | AGG-03         | P1   |
    | RegulationSourceAppService    | 外规源生命周期管理                                   | AGG-01         | P2+  |
    | ChangeMonitorAppService       | 变更监测任务管理与执行编排                           | AGG-01, AGG-04 | P2+  |

    表 5.2-1 应用服务清单

### 5.2.1 RegulationSourceAppService

+   RegulationSourceAppService方法清单如下表所示

    | 方法名                    | 方法简述                     | 关联用例          | 事务 | 异常                                               |
    | ------------------------- | ---------------------------- | ----------------- | ---- | -------------------------------------------------- |
    | createSource(command)     | 创建外规源                   | FL-RA-01 步骤1~5  | 读写 | 名称重复（E-409001）、URL格式错误（E-400101）      |
    | updateSource(command)     | 更新外规源基本信息           | FL-RA-01          | 读写 | 外规源不存在（E-404001）、乐观锁冲突（E-409001）   |
    | enableSource(command)     | 启用外规源                   | FL-RA-01 步骤8~13 | 读写 | 连通性测试失败（E-422001）、状态不允许（E-422002） |
    | disableSource(command)    | 停用外规源                   | FL-RA-01          | 读写 | 有运行中任务（E-422003）、状态不允许（E-422002）   |
    | archiveSource(command)    | 归档外规源                   | FL-RA-01          | 读写 | 有未完成任务（E-422004）、状态不允许（E-422002）   |
    | getSourceDetail(query)    | 查询外规源详情               | -                 | 只读 | 外规源不存在（E-404001）                           |
    | listSources(query)        | 分页查询外规源列表           | -                 | 只读 | -                                                  |
    | testConnectivity(command) | 测试外规源连通性（独立操作） | FL-RA-01          | 只读 | 连通性测试超时（E-422005）                         |

    表 5.2.1-1 RegulationSourceAppService方法清单

+   **enableSource复杂协调说明**：
    1.   加载外规源聚合，校验当前状态为DRAFT或DISABLED
    2.   调用连通性测试（HTTP HEAD请求，超时10秒）
    3.   连通性通过后，调用聚合根enable()方法更新状态
    4.   调用XXL-JOB注册定时采集任务和定时监测任务
    5.   将XXL-JOB任务ID绑定到外规源
    6.   持久化并发布SourceEnabledEvent

### 5.2.2 CollectionTaskAppService

+   CollectionTaskAppService方法清单如下表所示

    | 方法名                           | 方法简述                    | 关联用例 | 事务 | 异常                                               | 版本 |
    | -------------------------------- | --------------------------- | -------- | ---- | -------------------------------------------------- | ---- |
    | createManualTask(command)        | 人工录入创建采集任务        | FL-RA-03 | 读写 | 文件格式不支持（E-400102）、文件不存在（E-404002） | P1   |
    | getTaskDetail(query)             | 查询采集任务详情            | -        | 只读 | 任务不存在（E-404003）                             | P1   |
    | listTasks(query)                 | 分页查询采集任务列表        | -        | 只读 | -                                                  | P1   |
    | retryTask(command)               | 重试失败任务                | -        | 读写 | 非FAILED状态（E-422007）                           | P1   |
    | cancelTask(command)              | 取消待执行任务              | -        | 读写 | 非PENDING状态（E-422008）                          | P1   |
    | updateRegulationMeta(command)    | 更新外规元数据（后续修改）  | -        | 读写 | 文档不存在（E-404004）                             | P1   |
    | executeScheduledCollect(command) | 执行定时采集（XXL-JOB调用） | FL-RA-02 | 读写 | 分布式锁获取失败（跳过）、采集超时（E-500502）     | P2+  |
    | triggerManualCollect(command)    | 手动触发单次采集            | FL-RA-07 | 读写 | 外规源不存在或未启用（E-422006）                   | P2+  |
    | getTaskStatistics(query)         | 查询采集任务统计数据        | FL-RA-07 | 只读 | -                                                  | P2+  |
    | exportTaskReport(query)          | 导出采集报告                | FL-RA-07 | 只读 | 数据量超限（E-422009）                             | P2+  |

    表 5.2.2-1 CollectionTaskAppService方法清单

+   **createManualTask复杂协调说明**：
    1.   校验文件存在性（调用BC-13查询文件信息）
    2.   校验文件格式为PDF
    3.   创建采集任务聚合（状态直接为COLLECTED，taskType=MANUAL）
    4.   创建原始文档聚合（关联taskId，填充文件引用和元数据）
    5.   持久化聚合变更（事务提交）
    6.   事务提交后，通过Spring ApplicationEvent发布内部事件，异步触发DocumentParseService执行解析流程阶段①②（FL-RA-04：调用Doc2X API解析PDF→压缩包，解压后留存MD文件和图片至BC-13，更新原始文档状态→MD_READY）
    7.   阶段①②完成后：原始文档进入MD_READY状态，等待UP-01在比对视图中执行后续人工阶段（③~⑥）
    8.   解析异常时：标记采集任务FAILED，记录FailureInfo，UP-01可通过P-RA-11重试
    9.   返回taskId和documentId

+   **retryTask复杂协调说明**：
    1.   加载采集任务聚合，校验状态为FAILED
    2.   判断任务类型（taskType）：
         -   **AUTO任务**：调用retry()将状态回到PENDING，等待XXL-JOB调度器重新触发执行
         -   **MANUAL任务**：调用retry()将状态回到COLLECTED（因为人工录入任务无需重复采集步骤，文件已在BC-13中），然后通过Spring ApplicationEvent异步触发DocumentParseService重新执行解析流程（FL-RA-04）
    3.   retryCount+1，持久化聚合变更

+   **updateRegulationMeta复杂协调说明**：
+   该方法用于后续修改已录入文档的元数据（如修正外规名称、补充发布日期等），不再是首次元数据提交入口
    1.   加载原始文档聚合，校验文档存在
    2.   更新元数据（regulationName、publishOrgs、publishDate等）
    3.   持久化聚合变更（事务提交）

### 5.2.3 ChangeMonitorAppService

+   ChangeMonitorAppService方法清单如下表所示

    | 方法名                           | 方法简述                        | 关联用例 | 事务 | 异常                                       |
    | -------------------------------- | ------------------------------- | -------- | ---- | ------------------------------------------ |
    | executeScheduledMonitor(command) | 执行定时变更监测（XXL-JOB调用） | FL-RA-06 | 读写 | 外规源未启用（跳过）、检测超时（E-500503） |
    | getMonitorTaskDetail(query)      | 查询监测任务详情                | -        | 只读 | 任务不存在（E-404005）                     |
    | listMonitorTasks(query)          | 分页查询监测任务列表            | -        | 只读 | -                                          |
    | retryMonitorTask(command)        | 重试失败的监测任务              | FL-RA-06 | 读写 | 非FAILED状态（E-422010）                   |
    | getChangeDiffDetail(query)       | 查询变更差异报告详情            | -        | 只读 | 报告不存在（E-404006）                     |
    | listChangeDiffs(query)           | 分页查询变更差异列表            | -        | 只读 | -                                          |

    表 5.2.3-1 ChangeMonitorAppService方法清单

+   **executeScheduledMonitor复杂协调说明**：
    1.   加载外规源聚合，校验状态为ENABLED，否则跳过
    2.   创建变更监测任务聚合（PENDING→DETECTING）
    3.   调用领域服务ChangeMonitorService获取外规源当前页面
    4.   计算SHA-256哈希，与上次哈希对比
    5.   哈希一致：标记NO_CHANGE，记录检测信息
    6.   哈希不一致：标记CHANGED，保存变更快照
    7.   触发差异报告生成（CHANGED→DIFF_GENERATING→NOTIFIED）
    8.   调用BC-12消息通知服务发送变更通知
    9.   发布RegulationChangedEvent领域事件至Kafka
    10.   更新外规源的lastMonitorTime

### 5.2.4 DocumentParseReviewAppService

+   DocumentParseReviewAppService方法清单如下表所示（原DocumentReviewAppService，因FL-RA-04流程重构而扩展）

    | 方法名                          | 方法简述                                 | 关联用例           | 事务 | 异常                                                   |
    | ------------------------------- | ---------------------------------------- | ------------------ | ---- | ------------------------------------------------------ |
    | listMdReadyDocuments(query)     | 查询MD已就绪文档列表（待人工比对）       | FL-RA-04 阶段③     | 只读 | -                                                      |
    | getMdCompareDetail(query)       | 查询比对详情（PDF+MD+图片列表）          | FL-RA-04 阶段③     | 只读 | 文档不存在（E-404004）                                 |
    | submitMdCorrection(command)     | 提交MD校正结果和图片变更，触发结构化拆分 | FL-RA-04 阶段③→④   | 读写 | 非MD_READY状态（E-422011）                             |
    | listJsonReadyDocuments(query)   | 查询JSON已就绪文档列表（待再次校验）     | FL-RA-04 阶段⑤     | 只读 | -                                                      |
    | getJsonVerifyDetail(query)      | 查询校验详情（JSON结构化内容+图片引用）  | FL-RA-04 阶段⑤     | 只读 | 文档不存在（E-404004）                                 |
    | submitJsonVerification(command) | 提交JSON校验结果和图片变更               | FL-RA-04 阶段⑤     | 读写 | 非JSON_READY状态（E-422011）                           |
    | confirmPublish(command)         | 正式发布，更新APPROVED并发布领域事件     | FL-RA-04 阶段⑥     | 读写 | 非PENDING_PUBLISH状态（E-422011）                      |
    | rollbackToMdReady(command)      | 从JSON_READY回退至MD_READY               | FL-RA-04 阶段⑤回退 | 读写 | 非JSON_READY状态（E-422011）                           |
    | uploadImage(command)            | 上传新图片至BC-13并关联至文档            | FL-RA-04 阶段③⑤    | 读写 | 文档状态不允许（E-422011）、文件上传失败（E-500500）   |
    | replaceImage(command)           | 替换已有图片                             | FL-RA-04 阶段③⑤    | 读写 | 文档状态不允许（E-422011）、原图片不存在（E-404004）   |
    | removeImageRef(command)         | 删除错误的图片关联                       | FL-RA-04 阶段③⑤    | 读写 | 文档状态不允许（E-422011）、图片关联不存在（E-404004） |

    表 5.2.4-1 DocumentParseReviewAppService方法清单

+   **submitMdCorrection复杂协调说明**：
    1.   加载原始文档聚合，校验状态为MD_READY
    2.   处理图片变更（上传新图片至BC-13、替换已有图片、删除错误关联）
    3.   保存校正后的MD文件至BC-13，调用聚合根submitMdCorrection()方法，状态→MD_CORRECTED
    4.   持久化聚合变更
    5.   异步触发DocumentParseService执行结构化拆分（FL-RA-04阶段④：MD→ContentNode→ES），完成后状态→JSON_READY

+   **confirmPublish复杂协调说明**：
    1.   加载原始文档聚合，校验状态为PENDING_PUBLISH
    2.   调用聚合根confirmPublish(userId)方法，状态→APPROVED
    3.   同步更新采集任务状态→COMPLETED
    4.   发布RegulationCollectedEvent领域事件至Kafka
    5.   持久化聚合变更

## 5.3 命令对象设计

+   BC-51 Command对象清单如下表所示

    | Command名称                   | 关联方法                | 说明                   | 版本 |
    | ----------------------------- | ----------------------- | ---------------------- | ---- |
    | CreateManualTaskCommand       | createManualTask        | 人工录入创建任务       | P1   |
    | RetryTaskCommand              | retryTask               | 重试失败任务           | P1   |
    | CancelTaskCommand             | cancelTask              | 取消任务               | P1   |
    | UpdateRegulationMetaCommand   | updateRegulationMeta    | 更新外规元数据         | P1   |
    | SubmitMdCorrectionCommand     | submitMdCorrection      | 提交MD校正和图片变更   | P1   |
    | SubmitJsonVerificationCommand | submitJsonVerification  | 提交JSON校验和图片变更 | P1   |
    | ConfirmPublishCommand         | confirmPublish          | 正式发布确认           | P1   |
    | UploadImageCommand            | uploadImage             | 上传新图片             | P1   |
    | ReplaceImageCommand           | replaceImage            | 替换已有图片           | P1   |
    | RemoveImageRefCommand         | removeImageRef          | 删除图片关联           | P1   |
    | RollbackToMdReadyCommand      | rollbackToMdReady       | 回退至MD编辑阶段       | P1   |
    | CreateSourceCommand           | createSource            | 创建外规源             | P2+  |
    | UpdateSourceCommand           | updateSource            | 更新外规源             | P2+  |
    | EnableSourceCommand           | enableSource            | 启用外规源             | P2+  |
    | DisableSourceCommand          | disableSource           | 停用外规源             | P2+  |
    | ArchiveSourceCommand          | archiveSource           | 归档外规源             | P2+  |
    | TestConnectivityCommand       | testConnectivity        | 测试连通性             | P2+  |
    | ExecuteCollectCommand         | executeScheduledCollect | 执行定时采集           | P2+  |
    | TriggerManualCollectCommand   | triggerManualCollect    | 手动触发采集           | P2+  |
    | ExecuteMonitorCommand         | executeScheduledMonitor | 执行定时监测           | P2+  |
    | RetryMonitorCommand           | retryMonitorTask        | 重试监测任务           | P2+  |

    表 5.3-1 Command对象清单

### 5.3.1 CreateManualTaskCommand

+   CreateManualTaskCommand字段清单如下表所示

    | 字段名         | 数据类型     | 必填 | 约束                 | 业务含义             |
    | -------------- | ------------ | ---- | -------------------- | -------------------- |
    | sourceId       | String       | 否   | 存在时引用已有外规源 | 外规源ID（可选关联） |
    | fileId         | String       | 是   | BC-13文件ID          | 已上传的外规文件ID   |
    | regulationName | String       | 是   | ≤500                 | 外规名称             |
    | regulationCode | String       | 否   | ≤100                 | 外规编号             |
    | publishOrgs    | List<String> | 是   | 至少1项，每项≤200    | 发文机构数组         |
    | publishDate    | LocalDate    | 否   | -                    | 发布日期             |
    | effectiveDate  | LocalDate    | 否   | -                    | 生效日期             |
    | regulationType | String       | 否   | ≤50                  | 外规类型             |
    | industryTags   | List<String> | 否   | -                    | 行业标签             |
    | priority       | Integer      | 否   | 1~5，默认3           | 任务优先级           |
    | operatorId     | String       | 是   | 系统注入             | 操作人ID             |

    表 5.3.1-1 CreateManualTaskCommand字段清单

### 5.3.2 SubmitMdCorrectionCommand

+   SubmitMdCorrectionCommand字段清单如下表所示

    | 字段名       | 数据类型        | 必填 | 约束     | 业务含义                       |
    | ------------ | --------------- | ---- | -------- | ------------------------------ |
    | documentId   | String          | 是   | UUID格式 | 原始文档ID                     |
    | mdContent    | String          | 是   | -        | 校正后的MD文本内容             |
    | imageChanges | ImageChangeList | 否   | -        | 图片变更列表（上传/替换/删除） |
    | operatorId   | String          | 是   | 系统注入 | 操作人ID                       |

    表 5.3.2-1 SubmitMdCorrectionCommand字段清单

### 5.3.3 SubmitJsonVerificationCommand

+   SubmitJsonVerificationCommand字段清单如下表所示

    | 字段名          | 数据类型        | 必填 | 约束     | 业务含义                       |
    | --------------- | --------------- | ---- | -------- | ------------------------------ |
    | documentId      | String          | 是   | UUID格式 | 原始文档ID                     |
    | verifiedContent | Object          | 是   | -        | 校验后的JSON结构化内容         |
    | imageChanges    | ImageChangeList | 否   | -        | 图片变更列表（上传/替换/删除） |
    | comment         | String          | 否   | ≤1000    | 校验备注                       |
    | operatorId      | String          | 是   | 系统注入 | 操作人ID                       |

    表 5.3.3-1 SubmitJsonVerificationCommand字段清单

### 5.3.4 ConfirmPublishCommand

+   ConfirmPublishCommand字段清单如下表所示

    | 字段名     | 数据类型 | 必填 | 约束     | 业务含义     |
    | ---------- | -------- | ---- | -------- | ------------ |
    | documentId | String   | 是   | UUID格式 | 原始文档ID   |
    | comment    | String   | 否   | ≤1000    | 发布备注     |
    | version    | Integer  | 是   | -        | 乐观锁版本号 |
    | operatorId | String   | 是   | 系统注入 | 操作人ID     |

    表 5.3.4-1 ConfirmPublishCommand字段清单

## 5.4 查询对象设计

+   BC-51 Query对象清单如下表所示

    | Query名称              | 关联方法                                      | 说明                   | 版本 |
    | ---------------------- | --------------------------------------------- | ---------------------- | ---- |
    | TaskDetailQuery        | getTaskDetail                                 | 采集任务详情查询       | P1   |
    | TaskListQuery          | listTasks                                     | 采集任务列表查询       | P1   |
    | DocumentListQuery      | listMdReadyDocuments / listJsonReadyDocuments | 文档列表查询（按状态） | P1   |
    | DocumentDetailQuery    | getMdCompareDetail / getJsonVerifyDetail      | 文档详情查询           | P1   |
    | SourceDetailQuery      | getSourceDetail                               | 外规源详情查询         | P2+  |
    | SourceListQuery        | listSources                                   | 外规源列表查询         | P2+  |
    | TaskStatisticsQuery    | getTaskStatistics                             | 采集统计查询           | P2+  |
    | TaskExportQuery        | exportTaskReport                              | 报告导出查询           | P2+  |
    | MonitorTaskDetailQuery | getMonitorTaskDetail                          | 监测任务详情查询       | P2+  |
    | MonitorTaskListQuery   | listMonitorTasks                              | 监测任务列表查询       | P2+  |
    | ChangeDiffDetailQuery  | getChangeDiffDetail                           | 变更差异详情查询       | P2+  |
    | ChangeDiffListQuery    | listChangeDiffs                               | 变更差异列表查询       | P2+  |

    表 5.4-1 Query对象清单

### 5.4.1 TaskListQuery

+   TaskListQuery字段清单如下表所示

    | 字段名      | 数据类型      | 必填 | 约束          | 业务含义            |
    | ----------- | ------------- | ---- | ------------- | ------------------- |
    | keyword     | String        | 否   | ≤100          | 任务ID/外规名称搜索 |
    | sourceId    | String        | 否   | UUID格式      | 外规源ID筛选        |
    | taskType    | String        | 否   | AUTO/MANUAL   | 任务类型筛选        |
    | status      | String        | 否   | 枚举值        | 任务状态筛选        |
    | priority    | Integer       | 否   | 1~5           | 优先级筛选          |
    | createdFrom | LocalDateTime | 否   | -             | 创建时间起始        |
    | createdTo   | LocalDateTime | 否   | -             | 创建时间结束        |
    | pageNum     | Integer       | 是   | ≥1            | 页码                |
    | pageSize    | Integer       | 是   | 1~100，默认20 | 每页条数            |

    表 5.4.1-1 TaskListQuery字段清单

### 5.4.2 DocumentListQuery

+   DocumentListQuery字段清单如下表所示

    | 字段名   | 数据类型 | 必填 | 约束                                                      | 业务含义         |
    | -------- | -------- | ---- | --------------------------------------------------------- | ---------------- |
    | keyword  | String   | 否   | ≤100                                                      | 外规名称模糊搜索 |
    | status   | String   | 否   | MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED | 文档状态筛选     |
    | pageNum  | Integer  | 是   | ≥1                                                        | 页码             |
    | pageSize | Integer  | 是   | 1~100，默认20                                             | 每页条数         |

    表 5.4.2-1 DocumentListQuery字段清单

# 6 接口设计

## 6.0 通用响应格式

+   BC-51所有接口遵循统一响应格式（引用BC总体设计定义）

    ```json
    {
      "code": 0,
      "message": "success",
      "data": { },
      "timestamp": "2026-02-08T10:30:00Z"
    }
    ```

+   分页响应data结构：

    ```json
    {
      "list": [],
      "total": 100,
      "pageNum": 1,
      "pageSize": 20
    }
    ```

+   错误响应可选字段：field、value、suggestion、details、retryAfter

## 6.1 接口总览

### 6.1.1 RESTful API清单

+   BC-51 RESTful API清单如下表所示

    | API编号 | API名称          | 方法   | 路径                                                         | 权限                             | 领域方法                                                                        | 版本 |
    | ------- | ---------------- | ------ | ------------------------------------------------------------ | -------------------------------- | ------------------------------------------------------------------------------- | ---- |
    | P-RA-09 | 人工录入创建任务 | POST   | /api/v1/provider/tasks/manual                                | provider:content:task:create     | CollectionTask.createManual() + RawDocument.create()                            | P1   |
    | P-RA-11 | 重试失败任务     | POST   | /api/v1/provider/tasks/{taskId}/retry                        | provider:content:task:manage     | CollectionTask.retry()                                                          | P1   |
    | P-RA-12 | 取消任务         | POST   | /api/v1/provider/tasks/{taskId}/cancel                       | provider:content:task:manage     | CollectionTask.cancel()                                                         | P1   |
    | P-RA-13 | 查询任务详情     | GET    | /api/v1/provider/tasks/{taskId}                              | provider:content:task:read       | -（查询服务）                                                                   | P1   |
    | P-RA-14 | 查询任务列表     | GET    | /api/v1/provider/tasks                                       | provider:content:task:read       | -（查询服务）                                                                   | P1   |
    | P-RA-17 | 更新外规元数据   | PUT    | /api/v1/provider/documents/{documentId}/meta                 | provider:content:document:update | CollectionTaskAppService.updateRegulationMeta() → RawDocument.updateMeta()      | P1   |
    | P-RA-29 | 查询文档处理列表 | GET    | /api/v1/provider/documents/parse-review                      | provider:content:review:read     | DocumentParseReviewAppService.listMdReadyDocuments() / listJsonReadyDocuments() | P1   |
    | P-RA-30 | 查询文档处理详情 | GET    | /api/v1/provider/documents/{documentId}/parse-review         | provider:content:review:read     | DocumentParseReviewAppService.getMdCompareDetail() / getJsonVerifyDetail()      | P1   |
    | P-RA-31 | 正式发布确认     | POST   | /api/v1/provider/documents/{documentId}/publish              | provider:content:review:manage   | DocumentParseReviewAppService.confirmPublish()                                  | P1   |
    | P-RA-32 | 提交MD校正       | POST   | /api/v1/provider/documents/{documentId}/md-correction        | provider:content:review:manage   | DocumentParseReviewAppService.submitMdCorrection()                              | P1   |
    | P-RA-33 | 提交JSON校验     | POST   | /api/v1/provider/documents/{documentId}/json-verification    | provider:content:review:manage   | DocumentParseReviewAppService.submitJsonVerification()                          | P1   |
    | P-RA-34 | 回退至MD编辑     | POST   | /api/v1/provider/documents/{documentId}/rollback-to-md       | provider:content:review:manage   | DocumentParseReviewAppService.rollbackToMdReady()                               | P1   |
    | P-RA-35 | 上传图片         | POST   | /api/v1/provider/documents/{documentId}/images               | provider:content:review:manage   | DocumentParseReviewAppService.uploadImage()                                     | P1   |
    | P-RA-36 | 替换图片         | PUT    | /api/v1/provider/documents/{documentId}/images/{imageFileId} | provider:content:review:manage   | DocumentParseReviewAppService.replaceImage()                                    | P1   |
    | P-RA-37 | 删除图片关联     | DELETE | /api/v1/provider/documents/{documentId}/images/{imageFileId} | provider:content:review:manage   | DocumentParseReviewAppService.removeImageRef()                                  | P1   |
    | P-RA-01 | 创建外规源       | POST   | /api/v1/provider/sources                                     | provider:content:source:create   | RegulationSource.create()                                                       | P2+  |
    | P-RA-02 | 更新外规源       | PUT    | /api/v1/provider/sources/{sourceId}                          | provider:content:source:update   | RegulationSource.update()                                                       | P2+  |
    | P-RA-03 | 启用外规源       | POST   | /api/v1/provider/sources/{sourceId}/enable                   | provider:content:source:manage   | RegulationSource.enable()                                                       | P2+  |
    | P-RA-04 | 停用外规源       | POST   | /api/v1/provider/sources/{sourceId}/disable                  | provider:content:source:manage   | RegulationSource.disable()                                                      | P2+  |
    | P-RA-05 | 归档外规源       | POST   | /api/v1/provider/sources/{sourceId}/archive                  | provider:content:source:manage   | RegulationSource.archive()                                                      | P2+  |
    | P-RA-06 | 查询外规源详情   | GET    | /api/v1/provider/sources/{sourceId}                          | provider:content:source:read     | -（查询服务）                                                                   | P2+  |
    | P-RA-07 | 查询外规源列表   | GET    | /api/v1/provider/sources                                     | provider:content:source:read     | -（查询服务）                                                                   | P2+  |
    | P-RA-08 | 测试连通性       | POST   | /api/v1/provider/sources/{sourceId}/test                     | provider:content:source:manage   | -（应用服务）                                                                   | P2+  |
    | P-RA-10 | 手动触发采集     | POST   | /api/v1/provider/tasks/trigger                               | provider:content:task:create     | CollectionTask.createAuto()                                                     | P2+  |
    | P-RA-15 | 查询采集统计     | GET    | /api/v1/provider/tasks/statistics                            | provider:content:task:read       | -（查询服务）                                                                   | P2+  |
    | P-RA-16 | 导出采集报告     | GET    | /api/v1/provider/tasks/export                                | provider:content:task:export     | -（查询服务）                                                                   | P2+  |
    | P-RA-18 | 查询监测任务列表 | GET    | /api/v1/provider/monitors                                    | provider:content:monitor:read    | -（查询服务）                                                                   | P2+  |
    | P-RA-19 | 查询监测任务详情 | GET    | /api/v1/provider/monitors/{monitorTaskId}                    | provider:content:monitor:read    | -（查询服务）                                                                   | P2+  |
    | P-RA-20 | 查询变更差异列表 | GET    | /api/v1/provider/monitors/diffs                              | provider:content:monitor:read    | -（查询服务）                                                                   | P2+  |
    | P-RA-21 | 查询变更差异详情 | GET    | /api/v1/provider/monitors/diffs/{monitorTaskId}              | provider:content:monitor:read    | -（查询服务）                                                                   | P2+  |
    | P-RA-22 | 重试监测任务     | POST   | /api/v1/provider/monitors/{monitorTaskId}/retry              | provider:content:monitor:manage  | ChangeMonitorTask.retry()                                                       | P2+  |

    表 6.1.1-1 RESTful API清单

### 6.1.2 RPC接口清单

+   BC-51 RPC接口清单如下表所示

    | 接口编号  | 接口名称             | 调用方 | 说明                               | 版本 |
    | --------- | -------------------- | ------ | ---------------------------------- | ---- |
    | RPC-RA-01 | 查询外规采集状态     | BC-52  | 知识工程查询外规是否已采集入库     | P1   |
    | RPC-RA-02 | 批量查询原始文档信息 | BC-52  | 知识工程批量获取已入库外规文档信息 | P1   |

    表 6.1.2-1 RPC接口清单

### 6.1.3 消息接口清单

+   BC-51 消息接口清单如下表所示

    | 接口编号  | 消息名称         | 方向 | Topic                      | 消费方         | 版本 |
    | --------- | ---------------- | ---- | -------------------------- | -------------- | ---- |
    | MSG-RA-01 | 外规采集完成事件 | 发布 | topic-regulation-collected | BC-52 知识工程 | P1   |
    | MSG-RA-02 | 外规变更通知事件 | 发布 | topic-regulation-changed   | BC-31, BC-53   | P2+  |

    表 6.1.3-1 消息接口清单

## 6.2 RPC接口设计

### 6.2.1 RPC-RA-01 查询外规采集状态

+   RPC接口定义如下表所示

    | 属性      | 内容                                                                         |
    | --------- | ---------------------------------------------------------------------------- |
    | 接口编号  | RPC-RA-01                                                                    |
    | Feign接口 | ContentCollectFeignClient                                                    |
    | 方法签名  | RegulationStatusDTO getRegulationStatus(String documentId)                   |
    | 调用方    | BC-52 知识工程                                                               |
    | 功能简述  | 根据文档ID查询外规的采集入库状态                                             |
    | 超时控制  | 3秒                                                                          |
    | 重试策略  | 幂等接口，最多重试2次                                                        |
    | 降级策略  | 降级条件：超时或服务不可用；降级返回：null；业务影响：知识工程跳过该文档处理 |

    表 6.2.1-1 RPC-RA-01接口定义

+   请求参数：

    | 参数名     | 位置 | 类型   | 必填 | 说明       |
    | ---------- | ---- | ------ | ---- | ---------- |
    | documentId | Path | String | 是   | 原始文档ID |

    表 6.2.1-2 RPC-RA-01请求参数

+   响应DTO（RegulationStatusDTO）：

    | 字段名         | 类型          | 必有 | 说明                                                                      |
    | -------------- | ------------- | ---- | ------------------------------------------------------------------------- |
    | documentId     | String        | 是   | 原始文档ID                                                                |
    | status         | String        | 是   | 文档状态（RAW/MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED） |
    | regulationName | String        | 是   | 外规名称                                                                  |
    | qualityScore   | Integer       | 否   | 解析质量评分                                                              |
    | approvedAt     | LocalDateTime | 否   | 审核通过时间（仅APPROVED状态有值）                                        |

    表 6.2.1-3 RPC-RA-01响应DTO

### 6.2.2 RPC-RA-02 批量查询原始文档信息

+   RPC接口定义如下表所示

    | 属性      | 内容                                                                                   |
    | --------- | -------------------------------------------------------------------------------------- |
    | 接口编号  | RPC-RA-02                                                                              |
    | Feign接口 | ContentCollectFeignClient                                                              |
    | 方法签名  | List<RawDocumentDTO> batchGetDocuments(List<String> documentIds)                       |
    | 调用方    | BC-52 知识工程                                                                         |
    | 功能简述  | 批量获取已入库的原始文档基本信息和结构化内容摘要                                       |
    | 超时控制  | 5秒                                                                                    |
    | 重试策略  | 幂等接口，最多重试2次                                                                  |
    | 降级策略  | 降级条件：超时或服务不可用；降级返回：空列表；业务影响：知识工程批量处理降级为逐条处理 |

    表 6.2.2-1 RPC-RA-02接口定义

+   请求参数：

    | 参数名      | 位置 | 类型         | 必填 | 约束       | 说明       |
    | ----------- | ---- | ------------ | ---- | ---------- | ---------- |
    | documentIds | Body | List<String> | 是   | 1~50个元素 | 文档ID列表 |

    表 6.2.2-2 RPC-RA-02请求参数

+   响应DTO（RawDocumentDTO）：

    | 字段名         | 类型         | 必有 | 说明         |
    | -------------- | ------------ | ---- | ------------ |
    | documentId     | String       | 是   | 原始文档ID   |
    | regulationName | String       | 是   | 外规名称     |
    | regulationCode | String       | 否   | 外规编号     |
    | publishOrgs    | List<String> | 是   | 发文机构数组 |
    | publishDate    | LocalDate    | 否   | 发布日期     |
    | fileId         | String       | 是   | BC-13文件ID  |
    | contentHash    | String       | 是   | 内容哈希值   |
    | sectionCount   | Integer      | 否   | 章节数量     |
    | clauseCount    | Integer      | 否   | 条款数量     |
    | qualityScore   | Integer      | 否   | 质量评分     |
    | status         | String       | 是   | 文档状态     |

    表 6.2.2-3 RPC-RA-02响应DTO

## 6.3 消息接口设计

### 6.3.1 MSG-RA-01 外规采集完成事件

+   消息概述如下表所示

    | 属性     | 内容                                          |
    | -------- | --------------------------------------------- |
    | 消息编号 | MSG-RA-01                                     |
    | 消息名称 | RegulationCollectedEvent                      |
    | Topic    | topic-regulation-collected                    |
    | 消费方   | BC-52 知识工程                                |
    | 触发时机 | 文档审核通过后（RawDocument状态变为APPROVED） |
    | 消息格式 | JSON + CloudEvents规范                        |
    | 投递保证 | At Least Once                                 |

    表 6.3.1-1 MSG-RA-01消息概述

+   Payload字段表（完整定义见4.7.1节RegulationCollectedEvent事件字段表，此处不重复）

+   消费方处理契约如下表所示

    | 消费方         | 处理逻辑                                                            | 幂等策略                      | 失败处理                        |
    | -------------- | ------------------------------------------------------------------- | ----------------------------- | ------------------------------- |
    | BC-52 知识工程 | 接收事件后启动外规解析映射流程：下载原始文档→NLP条款拆解→要求点提取 | 基于eventId去重，重复事件跳过 | 重试3次后进入死信队列，人工处理 |

    表 6.3.1-2 MSG-RA-01消费方处理契约

### 6.3.2 MSG-RA-02 外规变更通知事件

+   消息概述如下表所示

    | 属性     | 内容                                           |
    | -------- | ---------------------------------------------- |
    | 消息编号 | MSG-RA-02                                      |
    | 消息名称 | RegulationChangedEvent                         |
    | Topic    | topic-regulation-changed                       |
    | 消费方   | BC-31 合规管理、BC-53 运营分发                 |
    | 触发时机 | 变更监测检测到外规内容变更并完成差异报告生成后 |
    | 消息格式 | JSON + CloudEvents规范                         |
    | 投递保证 | At Least Once                                  |

    表 6.3.2-1 MSG-RA-02消息概述

+   Payload字段表（完整定义见4.7.2节RegulationChangedEvent事件字段表，此处不重复）

+   消费方处理契约如下表所示

    | 消费方         | 处理逻辑                                                   | 幂等策略                      | 失败处理                        |
    | -------------- | ---------------------------------------------------------- | ----------------------------- | ------------------------------- |
    | BC-31 合规管理 | 接收事件后触发已订阅该外规的租户差距重新评估，更新合规状态 | 基于eventId去重，重复事件跳过 | 重试3次后进入死信队列，人工处理 |
    | BC-53 运营分发 | 接收事件后生成外规变更通知，推送至已订阅该外规的租户       | 基于eventId去重，重复事件跳过 | 重试3次后进入死信队列，人工处理 |

    表 6.3.2-2 MSG-RA-02消费方处理契约

## 6.4 RESTful API接口设计

### 6.4.1 P-RA-01 创建外规源

+   接口概述如下表所示

    | 属性      | 内容                                             |
    | --------- | ------------------------------------------------ |
    | 接口编号  | P-RA-01                                          |
    | 方法/路径 | POST /api/v1/provider/sources                    |
    | 权限码    | provider:content:source:create                   |
    | 频率限制  | 10次/分钟/用户                                   |
    | 应用方法  | RegulationSourceAppService.createSource(command) |

    表 6.4.1-1 P-RA-01接口概述

+   请求Body：

    | 字段名                  | 类型    | 必填 | 约束                                    | 说明         |
    | ----------------------- | ------- | ---- | --------------------------------------- | ------------ |
    | sourceName              | String  | 是   | 2~100字符                               | 外规源名称   |
    | sourceType              | String  | 是   | 枚举：GOV_WEBSITE/LAW_DB/API/RSS/MANUAL | 外规源类型   |
    | sourceUrl               | String  | 是   | 合法HTTP/HTTPS URL，≤2000               | 外规源URL    |
    | description             | String  | 否   | ≤500                                    | 描述说明     |
    | publisherName           | String  | 否   | ≤200                                    | 发布机构名称 |
    | credential              | Object  | 否   | -                                       | 访问凭证     |
    | credential.credType     | String  | 否   | NONE/API_KEY/BASIC_AUTH/OAUTH2          | 凭证类型     |
    | credential.apiKey       | String  | 否   | credType=API_KEY时必填，≤500            | API密钥      |
    | credential.username     | String  | 否   | credType=BASIC_AUTH时必填，≤100         | 用户名       |
    | credential.password     | String  | 否   | credType=BASIC_AUTH时必填，≤200         | 密码         |
    | credential.tokenUrl     | String  | 否   | credType=OAUTH2时必填，≤2000            | Token URL    |
    | credential.clientId     | String  | 否   | credType=OAUTH2时必填，≤200             | ClientID     |
    | credential.clientSecret | String  | 否   | credType=OAUTH2时必填，≤500             | ClientSecret |
    | schedule                | Object  | 是   | -                                       | 采集调度配置 |
    | schedule.collectCron    | String  | 是   | 合法Cron表达式                          | 采集Cron     |
    | schedule.monitorCron    | String  | 是   | 合法Cron表达式                          | 监测Cron     |
    | schedule.retryCount     | Integer | 否   | 0~5，默认3                              | 重试次数     |
    | schedule.timeoutMinutes | Integer | 否   | 5~60，默认30                            | 超时分钟     |
    | schedule.requestHeaders | Object  | 否   | Key-Value对                             | 自定义请求头 |
    | schedule.userAgent      | String  | 否   | ≤500                                    | 自定义UA     |

    表 6.4.1-2 P-RA-01请求Body

+   响应Body（data部分）：

    | 字段名   | 类型   | 必有 | 说明                 |
    | -------- | ------ | ---- | -------------------- |
    | sourceId | String | 是   | 新建外规源ID（UUID） |

    表 6.4.1-3 P-RA-01响应Body

+   处理逻辑：
    1.   接口层校验请求参数格式（@Valid）
    2.   转换为CreateSourceCommand，注入operatorId
    3.   调用RegulationSourceAppService.createSource(command)
    4.   应用服务内部：校验名称唯一性（数据库查询）→ 构建聚合根（触发领域校验RS-R-01/RS-R-03/RS-R-08）→ 持久化 → 返回sourceId

+   异常映射：

    | 异常场景       | HTTP状态码 | 错误码   | 错误信息             |
    | -------------- | ---------- | -------- | -------------------- |
    | 名称重复       | 409        | E-409001 | 外规源名称已存在     |
    | URL格式错误    | 400        | E-400101 | URL格式不合法        |
    | 必填字段缺失   | 400        | E-400001 | 参数校验失败         |
    | Cron表达式非法 | 400        | E-400104 | Cron表达式格式不合法 |
    | 采集频率超限   | 400        | E-400105 | 采集频率超出允许范围 |

    表 6.4.1-4 P-RA-01异常映射

### 6.4.2 P-RA-02 更新外规源

+   接口概述如下表所示

    | 属性      | 内容                                             |
    | --------- | ------------------------------------------------ |
    | 接口编号  | P-RA-02                                          |
    | 方法/路径 | PUT /api/v1/provider/sources/{sourceId}          |
    | 权限码    | provider:content:source:update                   |
    | 应用方法  | RegulationSourceAppService.updateSource(command) |

    表 6.4.2-1 P-RA-02接口概述

+   路径参数：

    | 参数名   | 类型   | 必填 | 说明     |
    | -------- | ------ | ---- | -------- |
    | sourceId | String | 是   | 外规源ID |

    表 6.4.2-2 P-RA-02路径参数

+   请求Body：与P-RA-01创建接口相同字段（sourceName、sourceType、sourceUrl等），额外增加version字段（Integer，必填，乐观锁版本号）

+   响应Body（data部分）：无（HTTP 200即成功）

+   异常映射：

    | 异常场景     | HTTP状态码 | 错误码   | 错误信息             |
    | ------------ | ---------- | -------- | -------------------- |
    | 外规源不存在 | 404        | E-404001 | 外规源不存在         |
    | 乐观锁冲突   | 409        | E-409001 | 数据已被其他用户修改 |
    | 名称重复     | 409        | E-409001 | 外规源名称已存在     |

    表 6.4.2-3 P-RA-02异常映射

### 6.4.3 P-RA-03 启用外规源

+   接口概述如下表所示

    | 属性      | 内容                                             |
    | --------- | ------------------------------------------------ |
    | 接口编号  | P-RA-03                                          |
    | 方法/路径 | POST /api/v1/provider/sources/{sourceId}/enable  |
    | 权限码    | provider:content:source:manage                   |
    | 应用方法  | RegulationSourceAppService.enableSource(command) |

    表 6.4.3-1 P-RA-03接口概述

+   路径参数：sourceId（String，必填）

+   请求Body：无

+   响应Body（data部分）：无（HTTP 200即成功）

+   处理逻辑：
    1.   加载外规源聚合，校验当前状态为DRAFT或DISABLED
    2.   执行连通性测试（HTTP HEAD，超时10秒）
    3.   连通性通过后调用聚合根enable()
    4.   注册XXL-JOB定时采集和监测任务
    5.   绑定jobId，持久化，发布SourceEnabledEvent

+   异常映射：

    | 异常场景        | HTTP状态码 | 错误码   | 错误信息                 |
    | --------------- | ---------- | -------- | ------------------------ |
    | 连通性测试失败  | 422        | E-422001 | 外规源连通性测试失败     |
    | 状态不允许启用  | 422        | E-422002 | 当前状态不允许执行此操作 |
    | XXL-JOB注册失败 | 500        | E-500504 | 调度任务注册失败         |

    表 6.4.3-2 P-RA-03异常映射

### 6.4.4 P-RA-04 停用外规源

+   接口概述如下表所示

    | 属性      | 内容                                              |
    | --------- | ------------------------------------------------- |
    | 接口编号  | P-RA-04                                           |
    | 方法/路径 | POST /api/v1/provider/sources/{sourceId}/disable  |
    | 权限码    | provider:content:source:manage                    |
    | 应用方法  | RegulationSourceAppService.disableSource(command) |

    表 6.4.4-1 P-RA-04接口概述

+   路径参数：sourceId（String，必填）

+   请求Body：无

+   异常映射：

    | 异常场景         | HTTP状态码 | 错误码   | 错误信息                       |
    | ---------------- | ---------- | -------- | ------------------------------ |
    | 有运行中采集任务 | 422        | E-422003 | 存在运行中的采集任务，无法停用 |
    | 状态不允许停用   | 422        | E-422002 | 当前状态不允许执行此操作       |

    表 6.4.4-2 P-RA-04异常映射

### 6.4.5 P-RA-05 归档外规源

+   接口概述如下表所示

    | 属性      | 内容                                              |
    | --------- | ------------------------------------------------- |
    | 接口编号  | P-RA-05                                           |
    | 方法/路径 | POST /api/v1/provider/sources/{sourceId}/archive  |
    | 权限码    | provider:content:source:manage                    |
    | 应用方法  | RegulationSourceAppService.archiveSource(command) |

    表 6.4.5-1 P-RA-05接口概述

+   路径参数：sourceId（String，必填）

+   请求Body：无

+   异常映射：

    | 异常场景         | HTTP状态码 | 错误码   | 错误信息                       |
    | ---------------- | ---------- | -------- | ------------------------------ |
    | 有未完成采集任务 | 422        | E-422004 | 存在未完成的采集任务，无法归档 |
    | 状态不允许归档   | 422        | E-422002 | 当前状态不允许执行此操作       |

    表 6.4.5-2 P-RA-05异常映射

### 6.4.6 P-RA-06 查询外规源详情

+   接口概述如下表所示

    | 属性      | 内容                                    |
    | --------- | --------------------------------------- |
    | 接口编号  | P-RA-06                                 |
    | 方法/路径 | GET /api/v1/provider/sources/{sourceId} |
    | 权限码    | provider:content:source:read            |

    表 6.4.6-1 P-RA-06接口概述

+   响应Body（data部分，SourceDetailDTO）：

    | 字段名            | 类型    | 必有 | 说明                 |
    | ----------------- | ------- | ---- | -------------------- |
    | sourceId          | String  | 是   | 外规源ID             |
    | sourceName        | String  | 是   | 外规源名称           |
    | sourceType        | String  | 是   | 外规源类型           |
    | sourceUrl         | String  | 是   | 外规源URL            |
    | description       | String  | 否   | 描述说明             |
    | publisherName     | String  | 否   | 发布机构名称         |
    | credential        | Object  | 否   | 凭证信息（脱敏输出） |
    | schedule          | Object  | 是   | 调度配置             |
    | status            | String  | 是   | 当前状态             |
    | lastCollectTime   | String  | 否   | 最近采集时间         |
    | lastMonitorTime   | String  | 否   | 最近监测时间         |
    | totalCollectCount | Integer | 是   | 累计采集次数         |
    | version           | Integer | 是   | 版本号（编辑回写用） |
    | createdBy         | String  | 是   | 创建人               |
    | createdAt         | String  | 是   | 创建时间             |
    | updatedAt         | String  | 是   | 最后修改时间         |

    表 6.4.6-2 P-RA-06响应Body

+   **凭证脱敏规则**：apiKey仅返回后4位，password返回"****"，clientSecret仅返回后4位

### 6.4.7 P-RA-07 查询外规源列表

+   接口概述如下表所示

    | 属性      | 内容                         |
    | --------- | ---------------------------- |
    | 接口编号  | P-RA-07                      |
    | 方法/路径 | GET /api/v1/provider/sources |
    | 权限码    | provider:content:source:read |

    表 6.4.7-1 P-RA-07接口概述

+   请求Query参数：

    | 参数名     | 类型    | 必填 | 默认值 | 说明             |
    | ---------- | ------- | ---- | ------ | ---------------- |
    | keyword    | String  | 否   | -      | 名称/URL模糊搜索 |
    | sourceType | String  | 否   | -      | 外规源类型筛选   |
    | status     | String  | 否   | -      | 状态筛选         |
    | pageNum    | Integer | 否   | 1      | 页码             |
    | pageSize   | Integer | 否   | 20     | 每页条数（≤100） |

    表 6.4.7-2 P-RA-07请求参数

+   响应Body（data部分为分页结构，list元素为SourceListItemDTO）：

    | 字段名            | 类型    | 必有 | 说明         |
    | ----------------- | ------- | ---- | ------------ |
    | sourceId          | String  | 是   | 外规源ID     |
    | sourceName        | String  | 是   | 外规源名称   |
    | sourceType        | String  | 是   | 外规源类型   |
    | sourceUrl         | String  | 是   | 外规源URL    |
    | status            | String  | 是   | 当前状态     |
    | lastCollectTime   | String  | 否   | 最近采集时间 |
    | totalCollectCount | Integer | 是   | 累计采集次数 |
    | createdAt         | String  | 是   | 创建时间     |

    表 6.4.7-3 P-RA-07响应列表项

### 6.4.8 P-RA-08 测试连通性

+   接口概述如下表所示

    | 属性      | 内容                                                 |
    | --------- | ---------------------------------------------------- |
    | 接口编号  | P-RA-08                                              |
    | 方法/路径 | POST /api/v1/provider/sources/{sourceId}/test        |
    | 权限码    | provider:content:source:manage                       |
    | 应用方法  | RegulationSourceAppService.testConnectivity(command) |

    表 6.4.8-1 P-RA-08接口概述

+   响应Body（data部分，ConnectivityResultDTO）：

    | 字段名         | 类型    | 必有 | 说明             |
    | -------------- | ------- | ---- | ---------------- |
    | connected      | Boolean | 是   | 是否连通         |
    | statusCode     | Integer | 否   | HTTP响应状态码   |
    | responseTimeMs | Long    | 否   | 响应耗时（毫秒） |
    | errorMessage   | String  | 否   | 失败时的错误信息 |

    表 6.4.8-2 P-RA-08响应Body

### 6.4.9 P-RA-09 人工录入创建任务

+   接口概述如下表所示

    | 属性      | 内容                                               |
    | --------- | -------------------------------------------------- |
    | 接口编号  | P-RA-09                                            |
    | 方法/路径 | POST /api/v1/provider/tasks/manual                 |
    | 权限码    | provider:content:task:create                       |
    | 应用方法  | CollectionTaskAppService.createManualTask(command) |

    表 6.4.9-1 P-RA-09接口概述

+   请求Body：

    | 字段名         | 类型         | 必填 | 约束              | 说明         |
    | -------------- | ------------ | ---- | ----------------- | ------------ |
    | sourceId       | String       | 否   | UUID              | 关联外规源ID |
    | fileId         | String       | 是   | -                 | BC-13文件ID  |
    | regulationName | String       | 是   | ≤500              | 外规名称     |
    | regulationCode | String       | 否   | ≤100              | 外规编号     |
    | publishOrgs    | List<String> | 是   | 至少1项，每项≤200 | 发文机构数组 |
    | publishDate    | String       | 否   | yyyy-MM-dd        | 发布日期     |
    | effectiveDate  | String       | 否   | yyyy-MM-dd        | 生效日期     |
    | regulationType | String       | 否   | ≤50               | 外规类型     |
    | industryTags   | List<String> | 否   | -                 | 行业标签     |
    | priority       | Integer      | 否   | 1~5，默认3        | 优先级       |

    表 6.4.9-2 P-RA-09请求Body

+   响应Body（data部分）：

    | 字段名     | 类型   | 必有 | 说明       |
    | ---------- | ------ | ---- | ---------- |
    | taskId     | String | 是   | 采集任务ID |
    | documentId | String | 是   | 原始文档ID |

    表 6.4.9-3 P-RA-09响应Body

+   处理逻辑：
    1.   校验fileId在BC-13中存在且文件格式受支持（P1仅支持PDF，P2+扩展Word/HTML等格式）
    2.   幂等判重：根据fileId + regulationName组合查询是否已存在采集任务，若已存在则直接返回已有的taskId和documentId（幂等返回，不重复创建）
    3.   创建采集任务（直接COLLECTED状态），关联请求中的元数据
    4.   创建原始文档记录，关联fileId，填充元数据（regulationName、publishOrgs等）
    5.   事务提交后，通过Spring ApplicationEvent发布内部事件，异步触发格式解析流程（FL-RA-04）
    6.   返回taskId和documentId，前端跳转至PG-05任务详情页可观察解析进度

+   异常映射：

    | 异常场景         | HTTP状态码 | 错误码   | 错误信息                                           |
    | ---------------- | ---------- | -------- | -------------------------------------------------- |
    | 文件不存在       | 404        | E-404002 | 文件不存在或已被删除                               |
    | 文件格式不支持   | 400        | E-400102 | 不支持的文件格式                                   |
    | 重复提交（幂等） | 200        | -        | 返回已有taskId和documentId（非异常，正常幂等返回） |

    表 6.4.9-4 P-RA-09异常映射

### 6.4.10 P-RA-10 手动触发采集

+   接口概述如下表所示

    | 属性      | 内容                                                   |
    | --------- | ------------------------------------------------------ |
    | 接口编号  | P-RA-10                                                |
    | 方法/路径 | POST /api/v1/provider/tasks/trigger                    |
    | 权限码    | provider:content:task:create                           |
    | 应用方法  | CollectionTaskAppService.triggerManualCollect(command) |

    表 6.4.10-1 P-RA-10接口概述

+   请求Body：

    | 字段名    | 类型    | 必填 | 约束  | 说明                        |
    | --------- | ------- | ---- | ----- | --------------------------- |
    | sourceId  | String  | 是   | UUID  | 外规源ID                    |
    | targetUrl | String  | 否   | ≤2000 | 可选覆盖URL（单次采集指定） |
    | priority  | Integer | 否   | 1~5   | 任务优先级                  |

    表 6.4.10-2 P-RA-10请求Body

+   响应Body（data部分）：

    | 字段名 | 类型   | 必有 | 说明       |
    | ------ | ------ | ---- | ---------- |
    | taskId | String | 是   | 采集任务ID |

    表 6.4.10-3 P-RA-10响应Body

+   异常映射：

    | 异常场景     | HTTP状态码 | 错误码   | 错误信息                   |
    | ------------ | ---------- | -------- | -------------------------- |
    | 外规源不存在 | 404        | E-404001 | 外规源不存在               |
    | 外规源未启用 | 422        | E-422006 | 外规源未启用，无法执行采集 |

    表 6.4.10-4 P-RA-10异常映射

### 6.4.11 P-RA-11 重试失败任务

+   接口概述如下表所示

    | 属性      | 内容                                        |
    | --------- | ------------------------------------------- |
    | 接口编号  | P-RA-11                                     |
    | 方法/路径 | POST /api/v1/provider/tasks/{taskId}/retry  |
    | 权限码    | provider:content:task:manage                |
    | 应用方法  | CollectionTaskAppService.retryTask(command) |

    表 6.4.11-1 P-RA-11接口概述

+   路径参数：taskId（String，必填）

+   请求Body：无

+   响应Body：无（HTTP 200即成功）

+   异常映射：

    | 异常场景     | HTTP状态码 | 错误码   | 错误信息                 |
    | ------------ | ---------- | -------- | ------------------------ |
    | 任务不存在   | 404        | E-404003 | 采集任务不存在           |
    | 非FAILED状态 | 422        | E-422007 | 仅FAILED状态的任务可重试 |

    表 6.4.11-2 P-RA-11异常映射

### 6.4.12 P-RA-12 取消任务

+   接口概述如下表所示

    | 属性      | 内容                                         |
    | --------- | -------------------------------------------- |
    | 接口编号  | P-RA-12                                      |
    | 方法/路径 | POST /api/v1/provider/tasks/{taskId}/cancel  |
    | 权限码    | provider:content:task:manage                 |
    | 应用方法  | CollectionTaskAppService.cancelTask(command) |

    表 6.4.12-1 P-RA-12接口概述

+   路径参数：taskId（String，必填）

+   异常映射：

    | 异常场景      | HTTP状态码 | 错误码   | 错误信息                  |
    | ------------- | ---------- | -------- | ------------------------- |
    | 任务不存在    | 404        | E-404003 | 采集任务不存在            |
    | 非PENDING状态 | 422        | E-422008 | 仅PENDING状态的任务可取消 |

    表 6.4.12-2 P-RA-12异常映射

+   **P1使用说明**：P1阶段仅有MANUAL类型任务，创建时直接为COLLECTED状态（跳过PENDING），因此P1阶段该接口实际不会被调用。取消操作在P2+阶段的AUTO类型任务（PENDING状态等待调度）中生效。P1阶段保留该接口定义以确保API完整性

### 6.4.13 P-RA-13 查询任务详情

+   接口概述如下表所示

    | 属性      | 内容                                |
    | --------- | ----------------------------------- |
    | 接口编号  | P-RA-13                             |
    | 方法/路径 | GET /api/v1/provider/tasks/{taskId} |
    | 权限码    | provider:content:task:read          |

    表 6.4.13-1 P-RA-13接口概述

+   响应Body（data部分，TaskDetailDTO）：

    | 字段名        | 类型    | 必有 | 说明                                       |
    | ------------- | ------- | ---- | ------------------------------------------ |
    | taskId        | String  | 是   | 采集任务ID                                 |
    | sourceId      | String  | 否   | 外规源ID（人工录入任务可为空）             |
    | sourceName    | String  | 否   | 外规源名称（人工录入任务可为空，冗余展示） |
    | taskType      | String  | 是   | 任务类型                                   |
    | status        | String  | 是   | 当前状态                                   |
    | targetUrl     | String  | 否   | 采集目标URL                                |
    | priority      | Integer | 是   | 优先级                                     |
    | triggerInfo   | Object  | 是   | 触发信息                                   |
    | collectResult | Object  | 否   | 采集结果                                   |
    | parseResult   | Object  | 否   | 解析结果                                   |
    | failureInfo   | Object  | 否   | 失败信息                                   |
    | retryCount    | Integer | 是   | 已重试次数                                 |
    | documentId    | String  | 否   | 关联文档ID（COLLECTED后有值）              |
    | createdBy     | String  | 是   | 创建人                                     |
    | createdAt     | String  | 是   | 创建时间                                   |
    | updatedAt     | String  | 是   | 最后修改时间                               |

    表 6.4.13-2 P-RA-13响应Body

### 6.4.14 P-RA-14 查询任务列表

+   接口概述如下表所示

    | 属性      | 内容                       |
    | --------- | -------------------------- |
    | 接口编号  | P-RA-14                    |
    | 方法/路径 | GET /api/v1/provider/tasks |
    | 权限码    | provider:content:task:read |

    表 6.4.14-1 P-RA-14接口概述

+   请求Query参数：

    | 参数名      | 类型    | 必填 | 默认值 | 说明                 |
    | ----------- | ------- | ---- | ------ | -------------------- |
    | keyword     | String  | 否   | -      | 任务ID/外规名称搜索  |
    | sourceId    | String  | 否   | -      | 外规源ID筛选         |
    | taskType    | String  | 否   | -      | AUTO/MANUAL筛选      |
    | status      | String  | 否   | -      | 状态筛选             |
    | priority    | Integer | 否   | -      | 优先级筛选           |
    | createdFrom | String  | 否   | -      | 创建起始（ISO-8601） |
    | createdTo   | String  | 否   | -      | 创建结束（ISO-8601） |
    | pageNum     | Integer | 否   | 1      | 页码                 |
    | pageSize    | Integer | 否   | 20     | 每页条数（≤100）     |

    表 6.4.14-2 P-RA-14请求参数

+   响应Body（data部分为分页结构，list元素为TaskListItemDTO）：

    | 字段名     | 类型    | 必有 | 说明                             |
    | ---------- | ------- | ---- | -------------------------------- |
    | taskId     | String  | 是   | 采集任务ID                       |
    | sourceId   | String  | 否   | 外规源ID（人工录入任务可为空）   |
    | sourceName | String  | 否   | 外规源名称（人工录入任务可为空） |
    | taskType   | String  | 是   | 任务类型                         |
    | status     | String  | 是   | 当前状态                         |
    | priority   | Integer | 是   | 优先级                           |
    | retryCount | Integer | 是   | 已重试次数                       |
    | createdAt  | String  | 是   | 创建时间                         |
    | updatedAt  | String  | 是   | 最后修改时间                     |

    表 6.4.14-3 P-RA-14响应列表项

### 6.4.15 P-RA-15 查询采集统计

+   接口概述如下表所示

    | 属性      | 内容                                  |
    | --------- | ------------------------------------- |
    | 接口编号  | P-RA-15                               |
    | 方法/路径 | GET /api/v1/provider/tasks/statistics |
    | 权限码    | provider:content:task:read            |

    表 6.4.15-1 P-RA-15接口概述

+   请求Query参数：sourceId（可选）、periodType（必填：TODAY/WEEK/MONTH/CUSTOM）、startDate（可选）、endDate（可选）

+   响应Body（data部分，TaskStatisticsDTO）：

    | 字段名           | 类型    | 必有 | 说明                 |
    | ---------------- | ------- | ---- | -------------------- |
    | totalCount       | Integer | 是   | 总任务数             |
    | pendingCount     | Integer | 是   | PENDING数            |
    | runningCount     | Integer | 是   | RUNNING数            |
    | completedCount   | Integer | 是   | COMPLETED数          |
    | failedCount      | Integer | 是   | FAILED数             |
    | cancelledCount   | Integer | 是   | CANCELLED数          |
    | autoCount        | Integer | 是   | 自动采集任务数       |
    | manualCount      | Integer | 是   | 人工录入任务数       |
    | avgCollectTimeMs | Long    | 是   | 平均采集耗时（毫秒） |
    | successRate      | Double  | 是   | 采集成功率（0~1）    |

    表 6.4.15-2 P-RA-15响应Body

### 6.4.16 P-RA-16 导出采集报告

+   接口概述如下表所示

    | 属性      | 内容                                                              |
    | --------- | ----------------------------------------------------------------- |
    | 接口编号  | P-RA-16                                                           |
    | 方法/路径 | GET /api/v1/provider/tasks/export                                 |
    | 权限码    | provider:content:task:export                                      |
    | 响应类型  | application/vnd.openxmlformats-officedocument.spreadsheetml.sheet |

    表 6.4.16-1 P-RA-16接口概述

+   请求Query参数：与P-RA-14任务列表查询相同筛选参数

+   响应：Excel文件流（HTTP 200 + Content-Disposition头）

+   异常映射：

    | 异常场景   | HTTP状态码 | 错误码   | 错误信息                 |
    | ---------- | ---------- | -------- | ------------------------ |
    | 数据量超限 | 422        | E-422009 | 导出数据量超过10万条上限 |

    表 6.4.16-2 P-RA-16异常映射

### 6.4.17 P-RA-17 更新外规元数据

+   接口概述如下表所示

    | 属性      | 内容                                                   |
    | --------- | ------------------------------------------------------ |
    | 接口编号  | P-RA-17                                                |
    | 方法/路径 | PUT /api/v1/provider/documents/{documentId}/meta       |
    | 权限码    | provider:content:document:update                       |
    | 应用方法  | CollectionTaskAppService.updateRegulationMeta(command) |

    表 6.4.17-1 P-RA-17接口概述

+   请求Body：

    | 字段名         | 类型         | 必填 | 约束              | 说明         |
    | -------------- | ------------ | ---- | ----------------- | ------------ |
    | regulationName | String       | 是   | ≤500              | 外规名称     |
    | regulationCode | String       | 否   | ≤100              | 外规编号     |
    | publishOrgs    | List<String> | 是   | 至少1项，每项≤200 | 发文机构数组 |
    | publishDate    | String       | 否   | yyyy-MM-dd        | 发布日期     |
    | effectiveDate  | String       | 否   | yyyy-MM-dd        | 生效日期     |
    | regulationType | String       | 否   | ≤50               | 外规类型     |
    | industryTags   | List<String> | 否   | -                 | 行业标签     |
    | version        | Integer      | 是   | -                 | 乐观锁版本号 |

    表 6.4.17-2 P-RA-17请求Body

+   处理逻辑：
    1.   校验documentId对应的原始文档存在
    2.   更新元数据字段（乐观锁校验version）
    3.   持久化聚合变更，返回成功
+   **说明**：P-RA-17用于后续修改已录入文档的元数据（如修正外规名称、补充发布日期等）。首次创建时元数据已通过P-RA-09一并提交，解析流程由P-RA-09创建时异步触发。

+   异常映射：

    | 异常场景   | HTTP状态码 | 错误码   | 错误信息             |
    | ---------- | ---------- | -------- | -------------------- |
    | 文档不存在 | 404        | E-404004 | 原始文档不存在       |
    | 乐观锁冲突 | 409        | E-409001 | 数据已被修改，请刷新 |

    表 6.4.17-3 P-RA-17异常映射

### 6.4.18 P-RA-18~P-RA-22 监测相关接口

+   监测任务列表、详情、变更差异列表、差异详情、重试监测任务接口的设计模式与采集任务接口类似，此处列出关键差异

    | 接口编号 | 响应DTO核心字段                                                                                   |
    | -------- | ------------------------------------------------------------------------------------------------- |
    | P-RA-18  | monitorTaskId、sourceId、sourceName、status、previousHash、currentHash、createdAt                 |
    | P-RA-19  | P-RA-18全部字段 + changeSnapshot、changeDiff、detectionInfo                                       |
    | P-RA-20  | monitorTaskId、sourceId、regulationName、addedCount、modifiedCount、deletedCount、diffGeneratedAt |
    | P-RA-21  | P-RA-20全部字段 + addedClauses(JSON)、modifiedClauses(JSON)、deletedClauses(JSON)详细内容         |
    | P-RA-22  | 无响应Body，异常：非FAILED状态（E-422010）                                                        |

    表 6.4.18-1 P-RA-18~P-RA-22关键差异

### 6.4.19 P-RA-29 查询文档处理列表

+   接口概述如下表所示

    | 属性      | 内容                                                                                      |
    | --------- | ----------------------------------------------------------------------------------------- |
    | 接口编号  | P-RA-29                                                                                   |
    | 方法/路径 | GET /api/v1/provider/documents/parse-review                                               |
    | 权限码    | provider:content:review:read                                                              |
    | 应用方法  | DocumentParseReviewAppService.listMdReadyDocuments(query) / listJsonReadyDocuments(query) |

    表 6.4.19-1 P-RA-29接口概述

+   请求Query参数：

    | 参数名   | 类型    | 必填 | 默认值 | 说明                                                          |
    | -------- | ------- | ---- | ------ | ------------------------------------------------------------- |
    | keyword  | String  | 否   | -      | 外规名称模糊搜索                                              |
    | status   | String  | 否   | -      | MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED筛选 |
    | pageNum  | Integer | 否   | 1      | 页码                                                          |
    | pageSize | Integer | 否   | 20     | 每页条数                                                      |

    表 6.4.19-2 P-RA-29请求参数

+   响应Body（data部分为分页结构，list元素为DocumentListItemDTO）：

    | 字段名         | 类型         | 必有 | 说明           |
    | -------------- | ------------ | ---- | -------------- |
    | documentId     | String       | 是   | 原始文档ID     |
    | taskId         | String       | 是   | 关联采集任务ID |
    | regulationName | String       | 是   | 外规名称       |
    | publishOrgs    | List<String> | 是   | 发文机构数组   |
    | qualityScore   | Integer      | 否   | 解析质量评分   |
    | status         | String       | 是   | 文档状态       |
    | imageCount     | Integer      | 否   | 关联图片数量   |
    | createdAt      | String       | 是   | 创建时间       |

    表 6.4.19-3 P-RA-29响应列表项

### 6.4.20 P-RA-30 查询文档处理详情

+   接口概述如下表所示

    | 属性      | 内容                                                                                 |
    | --------- | ------------------------------------------------------------------------------------ |
    | 接口编号  | P-RA-30                                                                              |
    | 方法/路径 | GET /api/v1/provider/documents/{documentId}/parse-review                             |
    | 权限码    | provider:content:review:read                                                         |
    | 应用方法  | DocumentParseReviewAppService.getMdCompareDetail(query) / getJsonVerifyDetail(query) |

    表 6.4.20-1 P-RA-30接口概述

+   响应Body（data部分，DocumentParseReviewDetailDTO）：

    | 字段名                | 类型           | 必有 | 说明                                           |
    | --------------------- | -------------- | ---- | ---------------------------------------------- |
    | documentId            | String         | 是   | 原始文档ID                                     |
    | taskId                | String         | 是   | 关联采集任务ID                                 |
    | regulationName        | String         | 是   | 外规名称                                       |
    | status                | String         | 是   | 文档状态                                       |
    | fileId                | String         | 是   | 原始PDF文件ID（BC-13）                         |
    | mdFileId              | String         | 否   | MD文件ID（BC-13），MD_READY后有值              |
    | mdContent             | String         | 否   | MD文本内容（MD_READY/MD_CORRECTED时返回）      |
    | imageFiles            | List\<Object\> | 否   | 关联图片列表（含fileId、fileName、previewUrl） |
    | structuredContent     | Object         | 否   | JSON结构化内容（JSON_READY后有值）             |
    | qualityScore          | Integer        | 否   | 解析质量评分                                   |
    | reviewInfo            | Object         | 否   | 审核信息（已发布时有值）                       |
    | reviewInfo.reviewedBy | String         | 否   | 审核人                                         |
    | reviewInfo.reviewedAt | String         | 否   | 审核时间                                       |
    | reviewInfo.comment    | String         | 否   | 审核备注                                       |
    | createdAt             | String         | 是   | 创建时间                                       |

    表 6.4.20-2 P-RA-30响应Body

### 6.4.21 P-RA-31 正式发布确认

+   接口概述如下表所示

    | 属性      | 内容                                                  |
    | --------- | ----------------------------------------------------- |
    | 接口编号  | P-RA-31                                               |
    | 方法/路径 | POST /api/v1/provider/documents/{documentId}/publish  |
    | 权限码    | provider:content:review:manage                        |
    | 应用方法  | DocumentParseReviewAppService.confirmPublish(command) |

    表 6.4.21-1 P-RA-31接口概述

+   请求Body：

    | 字段名  | 类型    | 必填 | 约束  | 说明         |
    | ------- | ------- | ---- | ----- | ------------ |
    | comment | String  | 否   | ≤1000 | 发布备注     |
    | version | Integer | 是   | -     | 乐观锁版本号 |

    表 6.4.21-2 P-RA-31请求Body

+   响应Body：无（HTTP 200即成功）

+   处理逻辑：
    1.   校验文档状态为PENDING_PUBLISH
    2.   校验version与当前文档版本一致（乐观锁）
    3.   调用RawDocument.confirmPublish(userId)
    4.   更新状态为APPROVED，记录ReviewInfo
    5.   同步更新采集任务状态→COMPLETED
    6.   发布RegulationCollectedEvent到Kafka

+   异常映射：

    | 异常场景              | HTTP状态码 | 错误码   | 错误信息                 |
    | --------------------- | ---------- | -------- | ------------------------ |
    | 文档不存在            | 404        | E-404004 | 原始文档不存在           |
    | 非PENDING_PUBLISH状态 | 422        | E-422011 | 当前状态不允许执行此操作 |
    | 乐观锁冲突            | 409        | E-409001 | 数据已被其他用户修改     |

    表 6.4.21-3 P-RA-31异常映射

### 6.4.22 P-RA-32 提交MD校正

+   接口概述如下表所示

    | 属性      | 内容                                                       |
    | --------- | ---------------------------------------------------------- |
    | 接口编号  | P-RA-32                                                    |
    | 方法/路径 | POST /api/v1/provider/documents/{documentId}/md-correction |
    | 权限码    | provider:content:review:manage                             |
    | 应用方法  | DocumentParseReviewAppService.submitMdCorrection(command)  |

    表 6.4.22-1 P-RA-32接口概述

+   路径参数：

    | 参数名     | 类型   | 必填 | 说明       |
    | ---------- | ------ | ---- | ---------- |
    | documentId | String | 是   | 原始文档ID |

    表 6.4.22-2 P-RA-32路径参数

+   请求Body：

    | 字段名       | 类型           | 必填 | 约束 | 说明                                                   |
    | ------------ | -------------- | ---- | ---- | ------------------------------------------------------ |
    | mdContent    | String         | 是   | -    | 校正后的MD文本内容                                     |
    | imageChanges | List\<Object\> | 否   | -    | 图片变更列表（含新增、替换、删除操作，结构见下方说明） |
    | version      | Integer        | 是   | -    | 乐观锁版本号                                           |

    表 6.4.22-3 P-RA-32请求Body

+   imageChanges元素结构：

    | 字段名         | 类型   | 必填 | 说明                                            |
    | -------------- | ------ | ---- | ----------------------------------------------- |
    | action         | String | 是   | 操作类型：ADD/REPLACE/REMOVE                    |
    | imageFileId    | String | 条件 | 已有图片文件ID（REPLACE和REMOVE时必填）         |
    | newImageFileId | String | 条件 | 新图片文件ID（ADD和REPLACE时必填，来自P-RA-35） |

+   响应Body：无（HTTP 200即成功）

+   处理逻辑：
    1.   校验文档状态为MD_READY
    2.   校验version与当前文档版本一致（乐观锁）
    3.   处理图片变更（上传新图片至BC-13、替换已有图片、删除错误关联）
    4.   保存校正后的MD文件至BC-13
    5.   调用RawDocument.submitMdCorrection()，状态→MD_CORRECTED
    6.   持久化聚合变更
    7.   异步触发DocumentParseService执行结构化拆分（FL-RA-04阶段④：MD→ContentNode→ES），完成后状态→JSON_READY

+   异常映射：

    | 异常场景       | HTTP状态码 | 错误码   | 错误信息                 |
    | -------------- | ---------- | -------- | ------------------------ |
    | 文档不存在     | 404        | E-404004 | 原始文档不存在           |
    | 非MD_READY状态 | 422        | E-422011 | 当前状态不允许执行此操作 |
    | 乐观锁冲突     | 409        | E-409001 | 数据已被其他用户修改     |

    表 6.4.22-4 P-RA-32异常映射

### 6.4.23 P-RA-33 提交JSON校验

+   接口概述如下表所示

    | 属性      | 内容                                                           |
    | --------- | -------------------------------------------------------------- |
    | 接口编号  | P-RA-33                                                        |
    | 方法/路径 | POST /api/v1/provider/documents/{documentId}/json-verification |
    | 权限码    | provider:content:review:manage                                 |
    | 应用方法  | DocumentParseReviewAppService.submitJsonVerification(command)  |

    表 6.4.23-1 P-RA-33接口概述

+   路径参数：

    | 参数名     | 类型   | 必填 | 说明       |
    | ---------- | ------ | ---- | ---------- |
    | documentId | String | 是   | 原始文档ID |

    表 6.4.23-2 P-RA-33路径参数

+   请求Body：

    | 字段名          | 类型           | 必填 | 约束 | 说明                                      |
    | --------------- | -------------- | ---- | ---- | ----------------------------------------- |
    | verifiedContent | Object         | 是   | -    | 校验后的JSON结构化内容（ContentNode集合） |
    | imageChanges    | List\<Object\> | 否   | -    | 图片变更列表（结构同P-RA-32）             |
    | version         | Integer        | 是   | -    | 乐观锁版本号                              |

    表 6.4.23-3 P-RA-33请求Body

+   响应Body：无（HTTP 200即成功）

+   处理逻辑：
    1.   校验文档状态为JSON_READY
    2.   校验version与当前文档版本一致（乐观锁）
    3.   处理图片变更
    4.   更新ES中的结构化内容（idx_structured_content）
    5.   调用RawDocument.submitJsonVerification()，状态→PENDING_PUBLISH
    6.   持久化聚合变更

+   异常映射：

    | 异常场景         | HTTP状态码 | 错误码   | 错误信息                 |
    | ---------------- | ---------- | -------- | ------------------------ |
    | 文档不存在       | 404        | E-404004 | 原始文档不存在           |
    | 非JSON_READY状态 | 422        | E-422011 | 当前状态不允许执行此操作 |
    | 乐观锁冲突       | 409        | E-409001 | 数据已被其他用户修改     |

    表 6.4.23-4 P-RA-33异常映射

### 6.4.24 P-RA-34 回退至MD编辑

+   接口概述如下表所示

    | 属性      | 内容                                                        |
    | --------- | ----------------------------------------------------------- |
    | 接口编号  | P-RA-34                                                     |
    | 方法/路径 | POST /api/v1/provider/documents/{documentId}/rollback-to-md |
    | 权限码    | provider:content:review:manage                              |
    | 应用方法  | DocumentParseReviewAppService.rollbackToMdReady(command)    |

    表 6.4.24-1 P-RA-34接口概述

+   路径参数：

    | 参数名     | 类型   | 必填 | 说明       |
    | ---------- | ------ | ---- | ---------- |
    | documentId | String | 是   | 原始文档ID |

    表 6.4.24-2 P-RA-34路径参数

+   请求Body：

    | 字段名  | 类型    | 必填 | 约束 | 说明         |
    | ------- | ------- | ---- | ---- | ------------ |
    | version | Integer | 是   | -    | 乐观锁版本号 |

    表 6.4.24-3 P-RA-34请求Body

+   响应Body：无（HTTP 200即成功）

+   处理逻辑：
    1.   校验文档状态为JSON_READY
    2.   校验version与当前文档版本一致（乐观锁）
    3.   调用RawDocument.rollbackToMdReady()，状态→MD_READY
    4.   保留当前JSON版本供参考（不删除ES中已有的结构化内容）
    5.   持久化聚合变更
    6.   UP-01可在PG-10重新进入MD比对校正模式

+   异常映射：

    | 异常场景         | HTTP状态码 | 错误码   | 错误信息                 |
    | ---------------- | ---------- | -------- | ------------------------ |
    | 文档不存在       | 404        | E-404004 | 原始文档不存在           |
    | 非JSON_READY状态 | 422        | E-422011 | 当前状态不允许执行此操作 |
    | 乐观锁冲突       | 409        | E-409001 | 数据已被其他用户修改     |

    表 6.4.24-4 P-RA-34异常映射

### 6.4.25 P-RA-35 上传图片

+   接口概述如下表所示

    | 属性      | 内容                                                |
    | --------- | --------------------------------------------------- |
    | 接口编号  | P-RA-35                                             |
    | 方法/路径 | POST /api/v1/provider/documents/{documentId}/images |
    | 权限码    | provider:content:review:manage                      |
    | 应用方法  | DocumentParseReviewAppService.uploadImage(command)  |

    表 6.4.25-1 P-RA-35接口概述

+   路径参数：

    | 参数名     | 类型   | 必填 | 说明       |
    | ---------- | ------ | ---- | ---------- |
    | documentId | String | 是   | 原始文档ID |

    表 6.4.25-2 P-RA-35路径参数

+   请求Body（multipart/form-data）：

    | 字段名 | 类型          | 必填 | 约束               | 说明     |
    | ------ | ------------- | ---- | ------------------ | -------- |
    | file   | MultipartFile | 是   | ≤10MB，JPG/PNG/GIF | 图片文件 |

    表 6.4.25-3 P-RA-35请求Body

+   响应Body（data部分）：

    | 字段名      | 类型   | 必有 | 说明                 |
    | ----------- | ------ | ---- | -------------------- |
    | imageFileId | String | 是   | BC-13返回的文件ID    |
    | fileName    | String | 是   | 原始文件名           |
    | previewUrl  | String | 是   | 图片预览URL（BC-13） |

    表 6.4.25-4 P-RA-35响应Body

+   处理逻辑：
    1.   校验文档存在，且状态为MD_READY、MD_CORRECTED、JSON_READY或PENDING_PUBLISH之一（人工阶段均可操作图片）
    2.   上传图片至BC-13文件管理
    3.   将返回的文件ID关联至原始文档的imageFileIds列表
    4.   返回imageFileId供UP-01在MD或JSON中插入图片引用

+   异常映射：

    | 异常场景       | HTTP状态码 | 错误码   | 错误信息         |
    | -------------- | ---------- | -------- | ---------------- |
    | 文档不存在     | 404        | E-404004 | 原始文档不存在   |
    | 文件上传失败   | 500        | E-500500 | 文件服务调用失败 |
    | 文件格式不支持 | 400        | E-400102 | 不支持的文件格式 |

    表 6.4.25-5 P-RA-35异常映射

### 6.4.26 P-RA-36 替换图片

+   接口概述如下表所示

    | 属性      | 内容                                                             |
    | --------- | ---------------------------------------------------------------- |
    | 接口编号  | P-RA-36                                                          |
    | 方法/路径 | PUT /api/v1/provider/documents/{documentId}/images/{imageFileId} |
    | 权限码    | provider:content:review:manage                                   |
    | 应用方法  | DocumentParseReviewAppService.replaceImage(command)              |

    表 6.4.26-1 P-RA-36接口概述

+   路径参数：

    | 参数名      | 类型   | 必填 | 说明               |
    | ----------- | ------ | ---- | ------------------ |
    | documentId  | String | 是   | 原始文档ID         |
    | imageFileId | String | 是   | 待替换的图片文件ID |

    表 6.4.26-2 P-RA-36路径参数

+   请求Body（multipart/form-data）：

    | 字段名 | 类型          | 必填 | 约束               | 说明       |
    | ------ | ------------- | ---- | ------------------ | ---------- |
    | file   | MultipartFile | 是   | ≤10MB，JPG/PNG/GIF | 新图片文件 |

    表 6.4.26-3 P-RA-36请求Body

+   响应Body（data部分）：

    | 字段名         | 类型   | 必有 | 说明                   |
    | -------------- | ------ | ---- | ---------------------- |
    | newImageFileId | String | 是   | 新图片的BC-13文件ID    |
    | fileName       | String | 是   | 新图片文件名           |
    | previewUrl     | String | 是   | 新图片预览URL（BC-13） |

    表 6.4.26-4 P-RA-36响应Body

+   处理逻辑：
    1.   校验文档存在，且状态为MD_READY、MD_CORRECTED、JSON_READY或PENDING_PUBLISH之一
    2.   校验imageFileId存在于文档的imageFileIds列表中
    3.   上传新图片至BC-13
    4.   更新文档imageFileIds列表：将旧imageFileId替换为newImageFileId
    5.   原图片标记为可清理（不立即删除，BC-13定期清理）

+   异常映射：

    | 异常场景     | HTTP状态码 | 错误码   | 错误信息                   |
    | ------------ | ---------- | -------- | -------------------------- |
    | 文档不存在   | 404        | E-404004 | 原始文档不存在             |
    | 原图片不存在 | 404        | E-404004 | 图片不存在或未关联至此文档 |
    | 文件上传失败 | 500        | E-500500 | 文件服务调用失败           |

    表 6.4.26-5 P-RA-36异常映射

### 6.4.27 P-RA-37 删除图片关联

+   接口概述如下表所示

    | 属性      | 内容                                                                |
    | --------- | ------------------------------------------------------------------- |
    | 接口编号  | P-RA-37                                                             |
    | 方法/路径 | DELETE /api/v1/provider/documents/{documentId}/images/{imageFileId} |
    | 权限码    | provider:content:review:manage                                      |
    | 应用方法  | DocumentParseReviewAppService.removeImageRef(command)               |

    表 6.4.27-1 P-RA-37接口概述

+   路径参数：

    | 参数名      | 类型   | 必填 | 说明               |
    | ----------- | ------ | ---- | ------------------ |
    | documentId  | String | 是   | 原始文档ID         |
    | imageFileId | String | 是   | 待删除的图片文件ID |

    表 6.4.27-2 P-RA-37路径参数

+   请求Body：无

+   响应Body：无（HTTP 200即成功）

+   处理逻辑：
    1.   校验文档存在，且状态为MD_READY、MD_CORRECTED、JSON_READY或PENDING_PUBLISH之一
    2.   校验imageFileId存在于文档的imageFileIds列表中
    3.   从文档imageFileIds列表中移除该imageFileId
    4.   图片文件标记为可清理
    5.   UP-01需自行在MD或JSON中移除对应的图片引用

+   异常映射：

    | 异常场景       | HTTP状态码 | 错误码   | 错误信息       |
    | -------------- | ---------- | -------- | -------------- |
    | 文档不存在     | 404        | E-404004 | 原始文档不存在 |
    | 图片关联不存在 | 404        | E-404004 | 图片关联不存在 |

    表 6.4.27-3 P-RA-37异常映射

# 7 数据模型设计

## 7.1 数据模型总览

### 7.1.1 存储选型

+   BC-51数据存储选型如下表所示

    | 存储类型     | 技术选型     | 用途                                                   | 数据量级预估  | 版本 |
    | ------------ | ------------ | ------------------------------------------------------ | ------------- | ---- |
    | 关系型数据库 | MySQL 8.0    | 事务型数据：采集任务、本地事件发布                     | 百万级（3年） | P1   |
    | 文档搜索引擎 | ES 7.x       | 外规清单主存储与全文检索、结构化内容段落级主存储与检索 | 千万级（3年） | P1   |
    | 文件存储     | BC-13（OSS） | 原始外规文档文件                                       | TB级（3年）   | P1   |
    | 消息队列     | Kafka        | 领域事件发布与消费                                     | -             | P1   |
    | 缓存         | Redis 6.x    | 分布式锁、热点数据缓存                                 | 千级Key       | P2+  |

    表 7.1.1-1 存储选型

+   **设计决策：ES作为外规清单与结构化内容的主存储**
    -   外规清单（T-03）的核心使用场景为多维筛选、全文检索、聚合统计，ES天然支持
    -   结构化内容（T-04）改为段落级颗粒度后，单个法规可产生数百至上千条记录，段落级检索是下游BC-52知识工程的核心输入需求
    -   消除原MySQL→ES双写的数据一致性问题
    -   ES写入采用`refresh=wait_for`确保写入后立即可查
    -   审核通过时，采集任务状态更新（MySQL）与ES文档写入在同一应用事务中编排，ES写入失败则任务标记FAILED
    -   解析完成时，结构化内容批量写入T-04索引、RawDocument状态更新写入T-03索引、采集任务状态更新写入MySQL(T-02)，同样在应用层事务中编排：ES写入失败则采集任务标记FAILED，保留原始文档供重试
    -   ES集群至少2副本，启用快照（Snapshot）定期备份至OSS

### 7.1.2 数据库实例与Schema

+   BC-51属于供给侧后台服务，数据存储于平台库 `clarisphere_platform`
+   MySQL字符集：utf8mb4，排序规则：utf8mb4_general_ci
+   MySQL时区：Asia/Shanghai（UTC+8）
+   ES索引前缀：`idx_`，索引别名用于版本迁移（如`idx_raw_document_v1` → 别名`idx_raw_document`）

### 7.1.3 数据存储清单

+   BC-51数据存储清单如下表所示

    | 编号 | 名称                   | 存储引擎 | 聚合     | 说明                 | 预估行数（3年） | 版本 |
    | ---- | ---------------------- | -------- | -------- | -------------------- | --------------- | ---- |
    | T-01 | regulation_source      | MySQL    | AGG-01   | 外规源主表           | 1,000           | P2+  |
    | T-02 | collection_task        | MySQL    | AGG-02   | 采集任务主表         | 500,000         | P1   |
    | T-03 | idx_raw_document       | ES       | AGG-03   | 外规清单索引（ES）   | 200,000         | P1   |
    | T-04 | idx_structured_content | ES       | AGG-03   | 结构化内容索引（ES） | 2,000,000       | P1   |
    | T-05 | change_monitor_task    | MySQL    | AGG-04   | 变更监测任务主表     | 1,000,000       | P2+  |
    | T-06 | change_snapshot        | MySQL    | AGG-04   | 变更快照表           | 50,000          | P2+  |
    | T-09 | domain_event_publish   | MySQL    | 基础设施 | 本地事件发布表       | 500,000         | P1   |

    表 7.1.3-1 数据存储清单

### 7.1.4 ER关系图

+   BC-51实体关系图如下所示

    ```
    ┌──────────────────────────────────────────────────────────────────────────────────┐
    │                          BC-51 ER关系图                                          │
    ├──────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                  │
    │   regulation_source (T-01, P2+, MySQL)                                           │
    │   ┌─────────────────────┐                                                        │
    │   │ PK source_id        │                                                        │
    │   │    source_name      │                                                        │
    │   │    source_type      │                                                        │
    │   │    source_url       │                                                        │
    │   │    status           │                                                        │
    │   │    ...              │                                                        │
    │   └──────────┬──────────┘                                                        │
    │              │ 1                                                                 │
    │              │                                                                   │
    │      ┌───────┴────────┐                                                          │
    │      │ N              │ N                                                        │
    │      ▼                ▼                                                          │
    │   collection_task   change_monitor_task (P2+, MySQL)                             │
    │   (T-02, MySQL)     (T-05)                                                       │
    │   ┌────────────┐    ┌──────────────────┐                                         │
    │   │PK task_id  │    │PK monitor_task_id│                                         │
    │   │FK source_id│    │FK source_id      │                                         │
    │   │   status   │    │   status         │                                         │
    │   │   ...      │    │   ...            │                                         │
    │   └─────┬──────┘    └────────┬─────────┘                                         │
    │         │ 1                  │ 1                                                 │
    │         │                    │                                                   │
    │         ▼                    ▼                                                   │
    │   idx_raw_document     change_snapshot (P2+, MySQL)                              │
    │   (T-03, ES)           (T-06)                                                    │
    │   ┌──────────────────┐ ┌──────────────────┐                                      │
    │   │PK document_id    │ │PK snapshot_id    │                                      │
    │   │FK task_id        │ │FK monitor_task_id│                                      │
    │   │FK source_id      │ │   ...            │                                      │
    │   │   publish_orgs[] │ └──────────────────┘                                      │
    │   │   attachments[]  │                                                           │
    │   │   version_history│                                                           │
    │   │   is_effective   │                                                           │
    │   │   sort_category  │                                                           │
    │   │   language       │                                                           │
    │   │   status         │                                                           │
    │   │   ...            │                                                           │
    │   └─────┬────────────┘                                                           │
    │         │ 1                                                                      │
    │         │                                                                        │
    │         ▼ N                                                                      │
    │   idx_structured_content                                                         │
    │   (T-04, ES)                                                                     │
    │   ┌──────────────────┐                                                           │
    │   │PK content_id     │                                                           │
    │   │FK document_id    │                                                           │
    │   │FK parent_id      │                                                           │
    │   │   content_type   │                                                           │
    │   │   clause_number  │                                                           │
    │   │   text_content   │                                                           │
    │   │   sort_order     │                                                           │
    │   │   ...            │                                                           │
    │   └──────────────────┘                                                           │
    │                                                                                  │
    │   说明：T-03与T-04存储于ES，T-03与T-04为1:N关系（一个文档N个段落级记录）         │
    │   原T-07 verification_task和T-08 reject_record已取消                             │
    │   审核信息通过idx_raw_document的review字段存储                                   │
    │                                                                                  │
    └──────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.1.4-1 ER关系图

## 7.2 T-01 regulation_source 外规源表

### 7.2.1 字段定义

+   regulation_source表字段定义如下表所示

    | 序号 | 字段名              | 类型     | 长度 | 可空 | 默认值            | 说明                                            |
    | ---- | ------------------- | -------- | ---- | ---- | ----------------- | ----------------------------------------------- |
    | 1    | source_id           | VARCHAR  | 36   | NO   | -                 | PK，外规源ID，UUID                              |
    | 2    | source_name         | VARCHAR  | 100  | NO   | -                 | 外规源名称                                      |
    | 3    | source_type         | VARCHAR  | 20   | NO   | -                 | 外规源类型（GOV_WEBSITE/LAW_DB/API/RSS/MANUAL） |
    | 4    | source_url          | VARCHAR  | 2000 | NO   | -                 | 外规源URL                                       |
    | 5    | description         | VARCHAR  | 500  | YES  | NULL              | 描述说明                                        |
    | 6    | publisher_name      | VARCHAR  | 200  | YES  | NULL              | 发布机构名称                                    |
    | 7    | cred_type           | VARCHAR  | 20   | NO   | 'NONE'            | 凭证类型（NONE/API_KEY/BASIC_AUTH/OAUTH2）      |
    | 8    | cred_api_key        | VARCHAR  | 500  | YES  | NULL              | API密钥（AES-256加密存储）                      |
    | 9    | cred_username       | VARCHAR  | 100  | YES  | NULL              | 用户名                                          |
    | 10   | cred_password       | VARCHAR  | 200  | YES  | NULL              | 密码（AES-256加密存储）                         |
    | 11   | cred_token_url      | VARCHAR  | 2000 | YES  | NULL              | OAuth2 Token URL                                |
    | 12   | cred_client_id      | VARCHAR  | 200  | YES  | NULL              | OAuth2 ClientID                                 |
    | 13   | cred_client_secret  | VARCHAR  | 500  | YES  | NULL              | OAuth2 ClientSecret（AES-256加密存储）          |
    | 14   | collect_cron        | VARCHAR  | 50   | NO   | -                 | 采集调度Cron表达式                              |
    | 15   | monitor_cron        | VARCHAR  | 50   | NO   | -                 | 变更监测Cron表达式                              |
    | 16   | retry_count         | INT      | -    | NO   | 3                 | 失败重试次数                                    |
    | 17   | timeout_minutes     | INT      | -    | NO   | 30                | 任务超时时间（分钟）                            |
    | 18   | request_headers     | JSON     | -    | YES  | NULL              | 自定义HTTP请求头（JSON对象）                    |
    | 19   | user_agent          | VARCHAR  | 500  | YES  | NULL              | 自定义User-Agent                                |
    | 20   | status              | VARCHAR  | 20   | NO   | 'DRAFT'           | 状态（DRAFT/ENABLED/DISABLED/ARCHIVED）         |
    | 21   | last_collect_time   | DATETIME | -    | YES  | NULL              | 最近成功采集时间                                |
    | 22   | last_monitor_time   | DATETIME | -    | YES  | NULL              | 最近变更监测时间                                |
    | 23   | total_collect_count | INT      | -    | NO   | 0                 | 累计成功采集次数                                |
    | 24   | xxl_job_id          | BIGINT   | -    | YES  | NULL              | XXL-JOB任务ID                                   |
    | 25   | version             | INT      | -    | NO   | 0                 | 乐观锁版本号                                    |
    | 26   | created_by          | VARCHAR  | 36   | NO   | -                 | 创建人ID                                        |
    | 27   | created_at          | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 创建时间                                        |
    | 28   | updated_by          | VARCHAR  | 36   | NO   | -                 | 最后修改人ID                                    |
    | 29   | updated_at          | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 最后修改时间                                    |
    | 30   | is_deleted          | TINYINT  | 1    | NO   | 0                 | 逻辑删除标记（0未删除，1已删除）                |

    表 7.2.1-1 regulation_source字段定义

### 7.2.2 索引定义

+   regulation_source索引定义如下表所示

    | 索引名                | 索引类型 | 字段                    | 说明                     |
    | --------------------- | -------- | ----------------------- | ------------------------ |
    | PRIMARY               | 主键     | source_id               | 主键                     |
    | uk_source_name        | 唯一     | source_name, is_deleted | 名称唯一（逻辑删除感知） |
    | idx_source_status     | 普通     | status                  | 状态查询                 |
    | idx_source_type       | 普通     | source_type             | 类型查询                 |
    | idx_source_created_at | 普通     | created_at              | 创建时间排序             |

    表 7.2.2-1 regulation_source索引定义

### 7.2.3 领域模型映射

+   regulation_source与领域模型的映射关系如下表所示

    | 领域对象         | 映射方式     | 说明                                                            |
    | ---------------- | ------------ | --------------------------------------------------------------- |
    | RegulationSource | 主表直接映射 | 聚合根属性与表字段一一对应                                      |
    | SourceType       | 枚举值列存储 | source_type字段存储枚举name                                     |
    | Url              | 值对象扁平化 | source_url字段存储Url.value                                     |
    | SourceCredential | 值对象扁平化 | cred_type/cred_api_key/cred_username等字段平铺存储              |
    | CollectSchedule  | 值对象扁平化 | collect_cron/monitor_cron/retry_count/timeout_minutes等字段平铺 |

    表 7.2.3-1 regulation_source领域模型映射

## 7.3 T-02 collection_task 采集任务表

### 7.3.1 字段定义

+   collection_task表字段定义如下表所示

    | 序号 | 字段名           | 类型     | 长度 | 可空 | 默认值            | 说明                                                                 |
    | ---- | ---------------- | -------- | ---- | ---- | ----------------- | -------------------------------------------------------------------- |
    | 1    | task_id          | VARCHAR  | 36   | NO   | -                 | PK，采集任务ID，UUID                                                 |
    | 2    | source_id        | VARCHAR  | 36   | YES  | NULL              | FK，外规源ID（人工录入时可为空）                                     |
    | 3    | task_type        | VARCHAR  | 10   | NO   | -                 | 任务类型（AUTO/MANUAL）                                              |
    | 4    | status           | VARCHAR  | 20   | NO   | 'PENDING'         | 状态（PENDING/RUNNING/COLLECTED/PARSING/COMPLETED/FAILED/CANCELLED） |
    | 5    | target_url       | VARCHAR  | 2000 | YES  | NULL              | 本次采集目标URL                                                      |
    | 6    | priority         | TINYINT  | -    | NO   | 3                 | 优先级（1~5，1最高）                                                 |
    | 7    | trigger_type     | VARCHAR  | 20   | NO   | -                 | 触发类型（SCHEDULED/MANUAL/RETRY）                                   |
    | 8    | triggered_by     | VARCHAR  | 36   | NO   | -                 | 触发者（用户ID或system）                                             |
    | 9    | triggered_at     | DATETIME | -    | NO   | -                 | 触发时间                                                             |
    | 10   | xxl_job_log_id   | BIGINT   | -    | YES  | NULL              | XXL-JOB日志ID                                                        |
    | 11   | file_id          | VARCHAR  | 64   | YES  | NULL              | BC-13文件ID                                                          |
    | 12   | file_name        | VARCHAR  | 500  | YES  | NULL              | 原始文件名                                                           |
    | 13   | file_size        | BIGINT   | -    | YES  | NULL              | 文件大小（字节）                                                     |
    | 14   | mime_type        | VARCHAR  | 100  | YES  | NULL              | MIME类型                                                             |
    | 15   | content_hash     | VARCHAR  | 64   | YES  | NULL              | SHA-256哈希值                                                        |
    | 16   | collected_at     | DATETIME | -    | YES  | NULL              | 采集完成时间                                                         |
    | 17   | http_status_code | INT      | -    | YES  | NULL              | HTTP响应状态码                                                       |
    | 18   | response_time_ms | BIGINT   | -    | YES  | NULL              | HTTP响应耗时（毫秒）                                                 |
    | 19   | document_id      | VARCHAR  | 36   | YES  | NULL              | 关联原始文档ID                                                       |
    | 20   | parsed_format    | VARCHAR  | 20   | YES  | NULL              | 解析源格式（固定PDF，由Doc2X API解析）                               |
    | 21   | md_file_id       | VARCHAR  | 64   | YES  | NULL              | API解析生成的MD文件ID（BC-13）                                       |
    | 22   | image_file_ids   | VARCHAR  | 2000 | YES  | NULL              | API解析提取的图片文件ID列表（JSON数组）                              |
    | 23   | section_count    | INT      | -    | YES  | NULL              | 章节数量                                                             |
    | 24   | clause_count     | INT      | -    | YES  | NULL              | 条款数量                                                             |
    | 25   | quality_score    | INT      | -    | YES  | NULL              | 质量评分（0~100）                                                    |
    | 26   | parsed_at        | DATETIME | -    | YES  | NULL              | API解析完成时间                                                      |
    | 27   | parse_time_ms    | BIGINT   | -    | YES  | NULL              | API解析耗时（毫秒）                                                  |
    | 28   | failed_at        | DATETIME | -    | YES  | NULL              | 失败时间                                                             |
    | 29   | failed_step      | VARCHAR  | 50   | YES  | NULL              | 失败步骤                                                             |
    | 30   | error_code       | VARCHAR  | 20   | YES  | NULL              | 错误码                                                               |
    | 31   | error_message    | VARCHAR  | 1000 | YES  | NULL              | 错误信息                                                             |
    | 32   | stack_trace      | TEXT     | -    | YES  | NULL              | 异常堆栈（开发调试）                                                 |
    | 33   | retry_count      | INT      | -    | NO   | 0                 | 已重试次数                                                           |
    | 34   | version          | INT      | -    | NO   | 0                 | 乐观锁版本号                                                         |
    | 35   | created_by       | VARCHAR  | 36   | NO   | -                 | 创建人ID                                                             |
    | 36   | created_at       | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 创建时间                                                             |
    | 37   | updated_at       | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 最后修改时间                                                         |

    表 7.3.1-1 collection_task字段定义

### 7.3.2 索引定义

+   collection_task索引定义如下表所示

    | 索引名                   | 索引类型 | 字段              | 说明                        |
    | ------------------------ | -------- | ----------------- | --------------------------- |
    | PRIMARY                  | 主键     | task_id           | 主键                        |
    | idx_task_source_id       | 普通     | source_id         | 按外规源查询                |
    | idx_task_status          | 普通     | status            | 状态筛选                    |
    | idx_task_type_status     | 联合     | task_type, status | 类型+状态联合筛选           |
    | idx_task_source_status   | 联合     | source_id, status | 外规源+状态查同源运行中任务 |
    | idx_task_created_at      | 普通     | created_at        | 创建时间排序                |
    | idx_task_priority_status | 联合     | priority, status  | 优先级+状态排序             |
    | idx_task_content_hash    | 普通     | content_hash      | 内容哈希去重                |

    表 7.3.2-1 collection_task索引定义

### 7.3.3 领域模型映射

+   collection_task与领域模型的映射关系如下表所示

    | 领域对象       | 映射方式     | 说明                                                  |
    | -------------- | ------------ | ----------------------------------------------------- |
    | CollectionTask | 主表直接映射 | 聚合根属性与表字段一一对应                            |
    | TriggerInfo    | 值对象扁平化 | trigger_type/triggered_by/triggered_at/xxl_job_log_id |
    | CollectResult  | 值对象扁平化 | file_id~response_time_ms（序号11~18）                 |
    | ParseResult    | 值对象扁平化 | document_id~parse_time_ms（序号19~27）                |
    | FailureInfo    | 值对象扁平化 | failed_at~stack_trace（序号28~32）                    |

    表 7.3.3-1 collection_task领域模型映射

## 7.4 T-03 idx_raw_document 外规清单索引（ES）

### 7.4.1 索引设置

+   idx_raw_document索引设置如下所示

    ```json
    {
      "settings": {
        "number_of_shards": 3,
        "number_of_replicas": 2,
        "analysis": {
          "analyzer": {
            "ik_smart_analyzer": {
              "type": "custom",
              "tokenizer": "ik_smart"
            },
            "ik_max_word_analyzer": {
              "type": "custom",
              "tokenizer": "ik_max_word"
            }
          }
        }
      }
    }
    ```

### 7.4.2 字段定义

+   idx_raw_document索引字段定义如下表所示

    | 序号 | 字段名                   | ES类型          | 分词器/格式                          | 可空 | 说明                                                                                                                      |
    | ---- | ------------------------ | --------------- | ------------------------------------ | ---- | ------------------------------------------------------------------------------------------------------------------------- |
    | 1    | document_id              | keyword         | -                                    | NO   | PK，外规文档唯一ID，UUID，同时作为ES _id                                                                                  |
    | 2    | task_id                  | keyword         | -                                    | NO   | 关联采集任务ID                                                                                                            |
    | 3    | source_id                | keyword         | -                                    | YES  | 来源外规源ID（人工录入时为空）                                                                                            |
    | 4    | regulation_name          | text + keyword  | text子字段ik_max_word，keyword子字段 | NO   | 外规名称                                                                                                                  |
    | 5    | regulation_code          | keyword         | -                                    | YES  | 外规编号（如"银发〔2024〕15号"、"GB/T 38600-2020"）                                                                       |
    | 6    | publish_orgs             | keyword（数组） | -                                    | NO   | 发文机构数组（支持联合发文）                                                                                              |
    | 7    | publish_date             | date            | yyyy-MM-dd                           | YES  | 发布日期                                                                                                                  |
    | 8    | effective_date           | date            | yyyy-MM-dd                           | YES  | 生效日期                                                                                                                  |
    | 9    | expiry_date              | date            | yyyy-MM-dd                           | YES  | 失效/废止日期                                                                                                             |
    | 10   | regulation_type          | keyword         | -                                    | YES  | 外规类型（法律/行政法规/部门规章/规范性文件/国家标准/行业标准/地方标准/团体标准/企业标准/指引/通知/公告）                 |
    | 11   | industry_tags            | keyword（数组） | -                                    | YES  | 行业标签                                                                                                                  |
    | 12   | is_effective             | boolean         | -                                    | NO   | 当前是否有效（快速过滤）                                                                                                  |
    | 13   | effective_status         | keyword         | -                                    | NO   | 有效性状态枚举（EFFECTIVE现行有效/ABOLISHED已废止/SUPERSEDED已被替代/DRAFT_EXPOSURE征求意见稿/NOT_YET_EFFECTIVE尚未生效） |
    | 14   | sort_category            | keyword         | -                                    | NO   | 编码排序规则（REGULATION法规类/STANDARD标准类/CUSTOM自定义类）                                                            |
    | 15   | sort_weight              | integer         | -                                    | YES  | 排序权重（同类别内自定义排序，数值越小越靠前，默认100）                                                                   |
    | 16   | language                 | keyword         | -                                    | NO   | 语言（zh-CN简体中文/zh-TW繁体中文/en英文/ja日文/other其他）                                                               |
    | 17   | equivalent_intl_standard | object          | -                                    | YES  | 等同国际标准信息（仅标准类外规使用），见7.4.3嵌套结构定义                                                                 |
    | 18   | attachments              | nested          | -                                    | YES  | 附件列表（嵌套对象数组），见7.4.3嵌套结构定义                                                                             |
    | 19   | attachment_count         | integer         | -                                    | NO   | 附件数量（冗余字段，便于排序和筛选，默认0）                                                                               |
    | 20   | version_history          | nested          | -                                    | YES  | 版本历史记录（嵌套对象数组），见7.4.3嵌套结构定义                                                                         |
    | 21   | current_version_no       | keyword         | -                                    | YES  | 当前版本号（如"2024修订版"、"第三版"）                                                                                    |
    | 22   | superseded_by            | keyword         | -                                    | YES  | 被替代文档ID（指向新版本的document_id）                                                                                   |
    | 23   | supersedes               | keyword         | -                                    | YES  | 替代的文档ID（指向旧版本的document_id）                                                                                   |
    | 24   | file_id                  | keyword         | -                                    | NO   | BC-13文件管理的文件ID（主件）                                                                                             |
    | 25   | file_name                | keyword         | -                                    | NO   | 原始文件名                                                                                                                |
    | 26   | file_size                | long            | -                                    | NO   | 文件大小（字节）                                                                                                          |
    | 27   | mime_type                | keyword         | -                                    | NO   | MIME类型                                                                                                                  |
    | 28   | content_hash             | keyword         | -                                    | NO   | 主件SHA-256哈希值                                                                                                         |
    | 29   | md_file_id               | keyword         | -                                    | YES  | Doc2X API解析生成的MD文件ID（BC-13），MD_READY后有值                                                                      |
    | 30   | image_file_ids           | keyword（数组） | -                                    | YES  | 关联图片文件ID列表（BC-13），人工阶段可增删                                                                               |
    | 31   | quality_score            | integer         | -                                    | YES  | 解析质量评分（0~100）                                                                                                     |
    | 32   | status                   | keyword         | -                                    | NO   | 文档状态（RAW/MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED），详见2.2.4节状态机定义                          |
    | 33   | reviewed_by              | keyword         | -                                    | YES  | 审核人用户ID                                                                                                              |
    | 34   | reviewed_at              | date            | yyyy-MM-dd'T'HH:mm:ss                | YES  | 审核时间                                                                                                                  |
    | 35   | review_comment           | text            | ik_smart                             | YES  | 审核备注                                                                                                                  |
    | 36   | version                  | integer         | -                                    | NO   | 乐观锁版本号（配合ES _version机制）                                                                                       |
    | 37   | created_at               | date            | yyyy-MM-dd'T'HH:mm:ss                | NO   | 创建时间                                                                                                                  |
    | 38   | updated_at               | date            | yyyy-MM-dd'T'HH:mm:ss                | NO   | 最后修改时间                                                                                                              |
    | 39   | created_by               | keyword         | -                                    | YES  | 创建人                                                                                                                    |
    | 40   | updated_by               | keyword         | -                                    | YES  | 最后修改人                                                                                                                |

    表 7.4.2-1 idx_raw_document字段定义

### 7.4.3 嵌套结构定义

**（1）equivalent_intl_standard（等同国际标准）**

+   等同国际标准嵌套对象字段定义如下表所示

    | 字段名               | ES类型           | 可空 | 说明                                              |
    | -------------------- | ---------------- | ---- | ------------------------------------------------- |
    | intl_standard_code   | keyword          | NO   | 国际标准编号（如"ISO 9001:2015"、"IEC 61508"）    |
    | intl_standard_name   | text（ik_smart） | YES  | 国际标准名称                                      |
    | adoption_type        | keyword          | NO   | 采用类型枚举（IDT等同采用/MOD修改采用/NEQ非等效） |
    | adoption_description | text             | YES  | 采用说明（修改采用时说明修改内容）                |

    表 7.4.3-1 equivalent_intl_standard嵌套结构

**（2）attachments（附件列表）**

+   附件嵌套对象字段定义如下表所示

    | 字段名            | ES类型                       | 可空 | 说明                                                                                                            |
    | ----------------- | ---------------------------- | ---- | --------------------------------------------------------------------------------------------------------------- |
    | attachment_id     | keyword                      | NO   | 附件唯一ID，UUID                                                                                                |
    | attachment_no     | keyword                      | YES  | 附件编号（保留原文格式，如"附件1"、"附录A"、"Annex I"）                                                         |
    | attachment_name   | text（ik_max_word）+ keyword | NO   | 附件名称/标题                                                                                                   |
    | attachment_nature | keyword                      | NO   | 附件性质枚举（APPENDIX附录/ANNEX附件/SUPPLEMENT补充/AMENDMENT修正案/INTERPRETATION释义/FORM表格样式/OTHER其他） |
    | source_position   | keyword                      | YES  | 原文位置描述（如"第三章第15条后"、"正文末尾"）                                                                  |
    | file_id           | keyword                      | NO   | BC-13文件管理的文件ID                                                                                           |
    | file_name         | keyword                      | NO   | 附件文件名                                                                                                      |
    | file_size         | long                         | NO   | 附件文件大小（字节）                                                                                            |
    | mime_type         | keyword                      | NO   | MIME类型                                                                                                        |
    | content_hash      | keyword                      | NO   | 附件SHA-256哈希值                                                                                               |
    | sort_order        | integer                      | NO   | 排序序号（从1开始，决定附件显示顺序）                                                                           |
    | is_structured     | boolean                      | NO   | 是否已完成结构化解析（默认false）                                                                               |
    | description       | text（ik_smart）             | YES  | 附件说明/摘要                                                                                                   |

    表 7.4.3-2 attachments嵌套结构

+   附件不设置独立索引表，统一挂在外规清单文档下作为nested嵌套对象
+   有附件的外规可通过`attachment_count > 0`筛选，通过`attachment_count`排序

**（3）version_history（版本历史）**

+   版本历史嵌套对象字段定义如下表所示

    | 字段名              | ES类型                        | 可空 | 说明                                                                                                 |
    | ------------------- | ----------------------------- | ---- | ---------------------------------------------------------------------------------------------------- |
    | version_no          | keyword                       | NO   | 版本号（如"2020版"、"第二次修订"、"V2.0"）                                                           |
    | change_type         | keyword                       | NO   | 变更类型枚举（INITIAL初始发布/REVISION修订/AMENDMENT修正/SUPERSEDE替代/ABOLISH废止/REISSUE重新发布） |
    | change_date         | date（yyyy-MM-dd）            | YES  | 变更日期                                                                                             |
    | change_description  | text（ik_smart）              | YES  | 变更说明                                                                                             |
    | related_document_id | keyword                       | YES  | 关联的历史版本document_id                                                                            |
    | operator            | keyword                       | YES  | 操作人                                                                                               |
    | operated_at         | date（yyyy-MM-dd'T'HH:mm:ss） | NO   | 操作时间                                                                                             |

    表 7.4.3-3 version_history嵌套结构

+   每次外规发生版本变化时，在当前文档的version_history数组中追加一条记录
+   跨文档版本链通过superseded_by/supersedes字段查询

### 7.4.4 ES Mapping

+   idx_raw_document完整Mapping定义如下所示

    ```json
    {
      "mappings": {
        "properties": {
          "document_id": { "type": "keyword" },
          "task_id": { "type": "keyword" },
          "source_id": { "type": "keyword" },
          "regulation_name": {
            "type": "text",
            "analyzer": "ik_max_word",
            "search_analyzer": "ik_smart",
            "fields": {
              "keyword": { "type": "keyword", "ignore_above": 500 }
            }
          },
          "regulation_code": { "type": "keyword" },
          "publish_orgs": { "type": "keyword" },
          "publish_date": { "type": "date", "format": "yyyy-MM-dd" },
          "effective_date": { "type": "date", "format": "yyyy-MM-dd" },
          "expiry_date": { "type": "date", "format": "yyyy-MM-dd" },
          "regulation_type": { "type": "keyword" },
          "industry_tags": { "type": "keyword" },
          "is_effective": { "type": "boolean" },
          "effective_status": { "type": "keyword" },
          "sort_category": { "type": "keyword" },
          "sort_weight": { "type": "integer" },
          "language": { "type": "keyword" },
          "equivalent_intl_standard": {
            "type": "object",
            "properties": {
              "intl_standard_code": { "type": "keyword" },
              "intl_standard_name": { "type": "text", "analyzer": "ik_smart" },
              "adoption_type": { "type": "keyword" },
              "adoption_description": { "type": "text" }
            }
          },
          "attachments": {
            "type": "nested",
            "properties": {
              "attachment_id": { "type": "keyword" },
              "attachment_no": { "type": "keyword" },
              "attachment_name": {
                "type": "text",
                "analyzer": "ik_max_word",
                "fields": { "keyword": { "type": "keyword" } }
              },
              "attachment_nature": { "type": "keyword" },
              "source_position": { "type": "keyword" },
              "file_id": { "type": "keyword" },
              "file_name": { "type": "keyword" },
              "file_size": { "type": "long" },
              "mime_type": { "type": "keyword" },
              "content_hash": { "type": "keyword" },
              "sort_order": { "type": "integer" },
              "is_structured": { "type": "boolean" },
              "description": { "type": "text", "analyzer": "ik_smart" }
            }
          },
          "attachment_count": { "type": "integer" },
          "version_history": {
            "type": "nested",
            "properties": {
              "version_no": { "type": "keyword" },
              "change_type": { "type": "keyword" },
              "change_date": { "type": "date", "format": "yyyy-MM-dd" },
              "change_description": { "type": "text", "analyzer": "ik_smart" },
              "related_document_id": { "type": "keyword" },
              "operator": { "type": "keyword" },
              "operated_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" }
            }
          },
          "current_version_no": { "type": "keyword" },
          "superseded_by": { "type": "keyword" },
          "supersedes": { "type": "keyword" },
          "file_id": { "type": "keyword" },
          "file_name": { "type": "keyword" },
          "file_size": { "type": "long" },
          "mime_type": { "type": "keyword" },
          "content_hash": { "type": "keyword" },
          "quality_score": { "type": "integer" },
          "status": { "type": "keyword" },
          "reviewed_by": { "type": "keyword" },
          "reviewed_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" },
          "review_comment": { "type": "text", "analyzer": "ik_smart" },
          "version": { "type": "integer" },
          "created_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" },
          "updated_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" },
          "created_by": { "type": "keyword" },
          "updated_by": { "type": "keyword" }
        }
      }
    }
    ```

### 7.4.5 领域模型映射

+   idx_raw_document与领域模型的映射关系如下表所示

    | 领域对象               | 映射方式          | 说明                                                     |
    | ---------------------- | ----------------- | -------------------------------------------------------- |
    | RawDocument            | ES文档直接映射    | document_id即ES_id，聚合根属性与索引字段一一对应         |
    | RegulationMeta         | 值对象扁平化      | regulation_name~equivalent_intl_standard（序号4~17）     |
    | FileReference          | 值对象扁平化      | file_id~content_hash（序号24~28）                        |
    | Attachment             | ES nested嵌套对象 | attachments数组（序号18）                                |
    | VersionRecord          | ES nested嵌套对象 | version_history数组（序号20）                            |
    | EquivalentIntlStandard | ES object嵌套对象 | equivalent_intl_standard（序号17）                       |
    | ReviewInfo             | 值对象扁平化      | reviewed_by/reviewed_at/review_comment（序号31~33）      |
    | ContentNode            | 独立ES索引存储    | 见T-04 idx_structured_content索引（1:N关系，段落级记录） |

    表 7.4.5-1 idx_raw_document领域模型映射

### 7.4.6 典型查询场景

+   idx_raw_document典型查询场景如下表所示

    | 场景             | ES查询方式                                  | 说明                   |
    | ---------------- | ------------------------------------------- | ---------------------- |
    | 按名称全文搜索   | match on regulation_name                    | ik_max_word分词        |
    | 按编号精确查询   | term on regulation_code                     | keyword精确匹配        |
    | 按发文机构筛选   | terms on publish_orgs                       | 数组字段支持多值匹配   |
    | 按排序分类分组   | terms aggregation on sort_category          | 法规类/标准类/自定义类 |
    | 筛选有附件的外规 | range on attachment_count（gt: 0）          | 冗余字段加速           |
    | 按有效性过滤     | term on is_effective / effective_status     | 快速过滤现行有效       |
    | 按语言过滤       | term on language                            | 中文/英文              |
    | 查询等同国际标准 | exists on equivalent_intl_standard          | 仅标准类               |
    | 版本链查询       | term on superseded_by / supersedes          | 文档间版本关联         |
    | 附件内搜索       | nested query on attachments.attachment_name | 嵌套查询               |

    表 7.4.6-1 idx_raw_document典型查询场景

## 7.5 T-04 idx_structured_content 结构化内容索引（ES）

### 7.5.1 设计说明

+   结构化内容采用段落级颗粒度存储，原文中每一个换行分隔的段落（即最小颗粒度的段落）都是一条独立的ES文档记录
+   通过parent_id + depth + sort_order构建文档的层级目录树
+   每条记录明确标识内容类别（目录、文本段落、表格、图形、公式、注释、条容器）
+   法规中的"条"是一种特殊的目录容器（ARTICLE_CONTAINER），显示时"条"的标题与第一款内容合并展示

### 7.5.2 索引设置

+   idx_structured_content索引设置如下所示

    ```json
    {
      "settings": {
        "number_of_shards": 5,
        "number_of_replicas": 2,
        "analysis": {
          "analyzer": {
            "ik_smart_analyzer": {
              "type": "custom",
              "tokenizer": "ik_smart"
            },
            "ik_max_word_analyzer": {
              "type": "custom",
              "tokenizer": "ik_max_word"
            }
          }
        }
      }
    }
    ```

+   **分片数说明**：结构化内容预计3年达到2000万条记录（平均每个外规100个段落 × 20万外规），5个分片确保单分片不超过400万文档

### 7.5.3 字段定义

+   idx_structured_content索引字段定义如下表所示

    | 序号 | 字段名               | ES类型                   | 分词器/格式                          | 可空 | 说明                                                                             |
    | ---- | -------------------- | ------------------------ | ------------------------------------ | ---- | -------------------------------------------------------------------------------- |
    | 1    | content_id           | keyword                  | -                                    | NO   | PK，结构化内容记录ID，UUID，同时作为ES _id                                       |
    | 2    | document_id          | keyword                  | -                                    | NO   | 所属文档ID（关联idx_raw_document.document_id）                                   |
    | 3    | attachment_id        | keyword                  | -                                    | YES  | 所属附件ID（属于附件时关联attachments.attachment_id，主件内容为空）              |
    | 4    | parent_id            | keyword                  | -                                    | YES  | 父节点content_id（顶级节点为空）                                                 |
    | 5    | depth                | integer                  | -                                    | NO   | 层级深度（从0开始，0=顶级章节/编/篇）                                            |
    | 6    | sort_order           | integer                  | -                                    | NO   | 兄弟节点间的排序序号（同一parent_id下排序，从1开始）                             |
    | 7    | path                 | keyword                  | -                                    | NO   | 物化路径（如"/root/ch1/sec2/art5"），便于范围查询和层级过滤                      |
    | 8    | content_type         | keyword                  | -                                    | NO   | 内容类别枚举（TOC/PARAGRAPH/TABLE/FIGURE/FORMULA/NOTE/ARTICLE_CONTAINER）        |
    | 9    | is_article_container | boolean                  | -                                    | NO   | 是否为法规"条"容器（默认false）。为true时显示需与第一个子款内容合并展示          |
    | 10   | clause_number        | keyword                  | -                                    | YES  | 条款号（如"第一条"、"第15条"、"3.2.1"、"Article 5"）                             |
    | 11   | heading_text         | text + keyword           | text子字段ik_max_word，keyword子字段 | YES  | 标题/章节名（如"总则"、"资本充足率管理"）。TOC和ARTICLE_CONTAINER类型使用        |
    | 12   | element_title        | text + keyword           | text子字段ik_max_word，keyword子字段 | YES  | 表格/图形标题（如"表1 风险权重表"、"图2-1 流程示意图"）。仅TABLE或FIGURE类型使用 |
    | 13   | text_content         | text                     | ik_max_word（索引）/ik_smart（搜索） | YES  | 段落正文。对于TOC/ARTICLE_CONTAINER类型可为空                                    |
    | 14   | raw_html             | text（index: false）     | -                                    | YES  | 原始HTML内容（保留格式信息，不索引，仅存储）                                     |
    | 15   | table_data           | object（enabled: false） | -                                    | YES  | 表格结构化数据（JSON对象，含行列信息）。仅TABLE类型使用，不索引仅存储            |
    | 16   | figure_url           | keyword                  | -                                    | YES  | 图形文件引用（BC-13文件ID或URL）。仅FIGURE类型使用                               |
    | 17   | normalized_tags      | keyword（数组）          | -                                    | YES  | 归一化标签（如["资本要求", "风险管理"]），由下游BC-52回写或人工标注              |
    | 18   | semantic_type        | keyword                  | -                                    | YES  | 语义类型标签（如"定义"、"要求"、"例外"、"处罚"、"过渡条款"），辅助知识工程提取   |
    | 19   | char_count           | integer                  | -                                    | YES  | 本段落字符数                                                                     |
    | 20   | is_leaf              | boolean                  | -                                    | NO   | 是否叶子节点（默认true）                                                         |
    | 21   | children_count       | integer                  | -                                    | NO   | 子节点数量（默认0）                                                              |
    | 22   | version              | integer                  | -                                    | NO   | 乐观锁版本号                                                                     |
    | 23   | created_at           | date                     | yyyy-MM-dd'T'HH:mm:ss                | NO   | 创建时间                                                                         |
    | 24   | updated_at           | date                     | yyyy-MM-dd'T'HH:mm:ss                | NO   | 最后修改时间                                                                     |

    表 7.5.3-1 idx_structured_content字段定义

### 7.5.4 ES Mapping

+   idx_structured_content完整Mapping定义如下所示

    ```json
    {
      "mappings": {
        "properties": {
          "content_id": { "type": "keyword" },
          "document_id": { "type": "keyword" },
          "attachment_id": { "type": "keyword" },
          "parent_id": { "type": "keyword" },
          "depth": { "type": "integer" },
          "sort_order": { "type": "integer" },
          "path": { "type": "keyword" },
          "content_type": { "type": "keyword" },
          "is_article_container": { "type": "boolean" },
          "clause_number": { "type": "keyword" },
          "heading_text": {
            "type": "text",
            "analyzer": "ik_max_word",
            "search_analyzer": "ik_smart",
            "fields": {
              "keyword": { "type": "keyword", "ignore_above": 500 }
            }
          },
          "element_title": {
            "type": "text",
            "analyzer": "ik_max_word",
            "search_analyzer": "ik_smart",
            "fields": {
              "keyword": { "type": "keyword", "ignore_above": 300 }
            }
          },
          "text_content": {
            "type": "text",
            "analyzer": "ik_max_word",
            "search_analyzer": "ik_smart"
          },
          "raw_html": { "type": "text", "index": false },
          "table_data": { "type": "object", "enabled": false },
          "figure_url": { "type": "keyword" },
          "normalized_tags": { "type": "keyword" },
          "semantic_type": { "type": "keyword" },
          "char_count": { "type": "integer" },
          "is_leaf": { "type": "boolean" },
          "children_count": { "type": "integer" },
          "version": { "type": "integer" },
          "created_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" },
          "updated_at": { "type": "date", "format": "yyyy-MM-dd'T'HH:mm:ss" }
        }
      }
    }
    ```

### 7.5.5 内容类别枚举说明

+   idx_structured_content的content_type枚举说明如下表所示

    | 枚举值            | 含义         | 可有子节点 | text_content | heading_text | element_title | 典型示例                        |
    | ----------------- | ------------ | ---------- | ------------ | ------------ | ------------- | ------------------------------- |
    | TOC               | 目录/标题    | 是         | 通常为空     | 必填         | -             | "第一章 总则"、"3.2 术语和定义" |
    | PARAGRAPH         | 文本段落     | 否（叶子） | 必填         | -            | -             | 每一个换行分隔的自然段          |
    | TABLE             | 表格         | 否（叶子） | 可有         | -            | 有（表标题）  | "表1 风险权重系数表"            |
    | FIGURE            | 图形         | 否（叶子） | 可有         | -            | 有（图标题）  | "图2-1 审批流程图"              |
    | FORMULA           | 公式         | 否（叶子） | 有           | -            | -             | 数学公式                        |
    | NOTE              | 注释/备注    | 否（叶子） | 有           | -            | -             | "注：本条所称..."               |
    | ARTICLE_CONTAINER | 法规"条"容器 | 是         | 通常为空     | 有（条标题） | -             | "第十五条"                      |

    表 7.5.5-1 content_type枚举说明

### 7.5.6 法规"条"容器数据结构示例

+   以"第十五条 商业银行应当按照本办法的规定..."为例，数据结构如下所示

    ```
    content_id: "c-100"
    content_type: ARTICLE_CONTAINER
    is_article_container: true
    clause_number: "第十五条"
    heading_text: "第十五条"
    text_content: null
    parent_id: "c-050"  (指向"第三章")
    depth: 2
    sort_order: 5
    children_count: 3
    is_leaf: false

        ├── content_id: "c-101"
        │   content_type: PARAGRAPH
        │   clause_number: null
        │   text_content: "商业银行应当按照本办法的规定，建立全面风险管理体系。"
        │   parent_id: "c-100"
        │   depth: 3
        │   sort_order: 1
        │
        ├── content_id: "c-102"
        │   content_type: PARAGRAPH
        │   text_content: "全面风险管理体系应当包括以下要素：..."
        │   parent_id: "c-100"
        │   depth: 3
        │   sort_order: 2
        │
        └── content_id: "c-103"
            content_type: PARAGRAPH
            text_content: "商业银行应当根据本行实际情况..."
            parent_id: "c-100"
            depth: 3
            sort_order: 3
    ```

+   **前端渲染规则**：遇到is_article_container=true的节点时，取该节点clauseNumber拼接sortOrder=1的第一个子节点textContent渲染为一行，第二款起正常缩进换行显示

### 7.5.7 领域模型映射

+   idx_structured_content与领域模型的映射关系如下表所示

    | 领域对象    | 映射方式       | 说明                                                        |
    | ----------- | -------------- | ----------------------------------------------------------- |
    | ContentNode | ES文档直接映射 | content_id即ES_id，每个段落/标题/表格/图形为一个ContentNode |

    表 7.5.7-1 idx_structured_content领域模型映射

### 7.5.8 典型查询场景

+   idx_structured_content典型查询场景如下表所示

    | 场景                 | ES查询方式                                               | 说明             |
    | -------------------- | -------------------------------------------------------- | ---------------- |
    | 全文检索条款内容     | match on text_content，filter by document_id             | 段落级精准命中   |
    | 获取某文档完整目录树 | term on document_id + content_type=TOC，sort by path     | 重建目录         |
    | 获取某章节下所有内容 | prefix on path（如"/root/ch1/"）                         | 物化路径范围查询 |
    | 获取某节点直接子节点 | term on parent_id，sort by sort_order                    | 一级子节点       |
    | 按归一化标签聚合     | terms aggregation on normalized_tags                     | 知识图谱辅助     |
    | 查找所有表格         | term on content_type=TABLE                               | 按类型过滤       |
    | 跨文档条款搜索       | match on text_content（不加document_id过滤）             | 全库段落级检索   |
    | 查找法规"条"容器     | term on is_article_container=true，filter by document_id | 法规条文结构     |

    表 7.5.8-1 idx_structured_content典型查询场景

## 7.6 T-05 change_monitor_task 变更监测任务表

### 7.6.1 字段定义

+   change_monitor_task表字段定义如下表所示

    | 序号 | 字段名            | 类型     | 长度 | 可空 | 默认值            | 说明                                                                        |
    | ---- | ----------------- | -------- | ---- | ---- | ----------------- | --------------------------------------------------------------------------- |
    | 1    | monitor_task_id   | VARCHAR  | 36   | NO   | -                 | PK，监测任务ID，UUID                                                        |
    | 2    | source_id         | VARCHAR  | 36   | NO   | -                 | FK，外规源ID                                                                |
    | 3    | regulation_id     | VARCHAR  | 36   | YES  | NULL              | 关联的已入库外规文档ID                                                      |
    | 4    | status            | VARCHAR  | 20   | NO   | 'PENDING'         | 状态（PENDING/DETECTING/CHANGED/NO_CHANGE/DIFF_GENERATING/NOTIFIED/FAILED） |
    | 5    | previous_hash     | VARCHAR  | 64   | YES  | NULL              | 上次内容哈希值                                                              |
    | 6    | current_hash      | VARCHAR  | 64   | YES  | NULL              | 本次内容哈希值                                                              |
    | 7    | detected_at       | DATETIME | -    | YES  | NULL              | 检测时间                                                                    |
    | 8    | response_time_ms  | BIGINT   | -    | YES  | NULL              | 外规源响应耗时                                                              |
    | 9    | http_status_code  | INT      | -    | YES  | NULL              | HTTP响应状态码                                                              |
    | 10   | added_count       | INT      | -    | YES  | NULL              | 新增条款数                                                                  |
    | 11   | modified_count    | INT      | -    | YES  | NULL              | 修改条款数                                                                  |
    | 12   | deleted_count     | INT      | -    | YES  | NULL              | 删除条款数                                                                  |
    | 13   | added_clauses     | LONGTEXT | -    | YES  | NULL              | 新增条款详情（JSON）                                                        |
    | 14   | modified_clauses  | LONGTEXT | -    | YES  | NULL              | 修改条款详情（JSON，含前后对比）                                            |
    | 15   | deleted_clauses   | LONGTEXT | -    | YES  | NULL              | 删除条款详情（JSON）                                                        |
    | 16   | diff_generated_at | DATETIME | -    | YES  | NULL              | 差异生成时间                                                                |
    | 17   | error_message     | VARCHAR  | 1000 | YES  | NULL              | 失败时的错误信息                                                            |
    | 18   | version           | INT      | -    | NO   | 0                 | 乐观锁版本号                                                                |
    | 19   | created_at        | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 创建时间                                                                    |
    | 20   | updated_at        | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 最后修改时间                                                                |

    表 7.6.1-1 change_monitor_task字段定义

### 7.6.2 索引定义

+   change_monitor_task索引定义如下表所示

    | 索引名                    | 索引类型 | 字段              | 说明                |
    | ------------------------- | -------- | ----------------- | ------------------- |
    | PRIMARY                   | 主键     | monitor_task_id   | 主键                |
    | idx_monitor_source_id     | 普通     | source_id         | 按外规源查询        |
    | idx_monitor_status        | 普通     | status            | 状态筛选            |
    | idx_monitor_source_status | 联合     | source_id, status | 外规源+状态联合查询 |
    | idx_monitor_created_at    | 普通     | created_at        | 创建时间排序        |

    表 7.6.2-1 change_monitor_task索引定义

### 7.6.3 领域模型映射

+   change_monitor_task与领域模型的映射关系如下表所示

    | 领域对象          | 映射方式     | 说明                                          |
    | ----------------- | ------------ | --------------------------------------------- |
    | ChangeMonitorTask | 主表直接映射 | 聚合根属性一一对应                            |
    | DetectionInfo     | 值对象扁平化 | detected_at/response_time_ms/http_status_code |
    | ChangeDiff        | 值对象扁平化 | added_count~diff_generated_at（序号10~16）    |
    | ChangeSnapshot    | 独立表存储   | 见T-06（大字段拆分）                          |

    表 7.6.3-1 change_monitor_task领域模型映射

## 7.7 T-06 change_snapshot 变更快照表

### 7.7.1 字段定义

+   change_snapshot表字段定义如下表所示

    | 序号 | 字段名           | 类型     | 长度 | 可空 | 默认值            | 说明                     |
    | ---- | ---------------- | -------- | ---- | ---- | ----------------- | ------------------------ |
    | 1    | snapshot_id      | VARCHAR  | 36   | NO   | -                 | PK，快照ID，UUID         |
    | 2    | monitor_task_id  | VARCHAR  | 36   | NO   | -                 | FK，关联监测任务ID       |
    | 3    | source_id        | VARCHAR  | 36   | NO   | -                 | 外规源ID（冗余便于查询） |
    | 4    | previous_content | LONGTEXT | -    | NO   | -                 | 变更前内容（可压缩存储） |
    | 5    | current_content  | LONGTEXT | -    | NO   | -                 | 变更后内容（可压缩存储） |
    | 6    | snapshot_at      | DATETIME | -    | NO   | -                 | 快照时间                 |
    | 7    | created_at       | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 创建时间                 |

    表 7.7.1-1 change_snapshot字段定义

### 7.7.2 索引定义

+   change_snapshot索引定义如下表所示

    | 索引名                    | 索引类型 | 字段            | 说明           |
    | ------------------------- | -------- | --------------- | -------------- |
    | PRIMARY                   | 主键     | snapshot_id     | 主键           |
    | idx_snapshot_monitor_task | 普通     | monitor_task_id | 按监测任务查询 |
    | idx_snapshot_source_id    | 普通     | source_id       | 按外规源查询   |
    | idx_snapshot_created_at   | 普通     | created_at      | 创建时间排序   |

    表 7.7.2-1 change_snapshot索引定义

+   **数据清理策略**：每个外规源保留最近10条快照记录，超出部分由定时任务清理

## 7.8 T-09 domain_event_publish 本地事件发布表

### 7.8.1 字段定义

+   domain_event_publish表字段定义如下表所示

    | 序号 | 字段名         | 类型     | 长度 | 可空 | 默认值            | 说明                                 |
    | ---- | -------------- | -------- | ---- | ---- | ----------------- | ------------------------------------ |
    | 1    | event_id       | VARCHAR  | 36   | NO   | -                 | PK，事件ID，UUID                     |
    | 2    | aggregate_id   | VARCHAR  | 36   | NO   | -                 | 聚合根ID                             |
    | 3    | aggregate_type | VARCHAR  | 50   | NO   | -                 | 聚合根类型                           |
    | 4    | event_type     | VARCHAR  | 100  | NO   | -                 | 事件类型（全限定类名）               |
    | 5    | event_version  | VARCHAR  | 10   | NO   | 'v1'              | 事件版本号                           |
    | 6    | payload        | JSON     | -    | NO   | -                 | 事件负载（JSON）                     |
    | 7    | topic          | VARCHAR  | 200  | NO   | -                 | Kafka Topic                          |
    | 8    | status         | VARCHAR  | 20   | NO   | 'PENDING'         | 发布状态（PENDING/PUBLISHED/FAILED） |
    | 9    | retry_count    | INT      | -    | NO   | 0                 | 重试次数                             |
    | 10   | max_retry      | INT      | -    | NO   | 5                 | 最大重试次数                         |
    | 11   | next_retry_at  | DATETIME | -    | YES  | NULL              | 下次重试时间                         |
    | 12   | published_at   | DATETIME | -    | YES  | NULL              | 成功发布时间                         |
    | 13   | error_message  | VARCHAR  | 1000 | YES  | NULL              | 最近一次发布失败的错误信息           |
    | 14   | occurred_on    | DATETIME | -    | NO   | -                 | 事件发生时间                         |
    | 15   | created_at     | DATETIME | -    | NO   | CURRENT_TIMESTAMP | 创建时间                             |

    表 7.8.1-1 domain_event_publish字段定义

### 7.8.2 索引定义

+   domain_event_publish索引定义如下表所示

    | 索引名                 | 索引类型 | 字段                         | 说明                        |
    | ---------------------- | -------- | ---------------------------- | --------------------------- |
    | PRIMARY                | 主键     | event_id                     | 主键                        |
    | idx_event_status_retry | 联合     | status, next_retry_at        | 定时任务扫描待发布/重试事件 |
    | idx_event_aggregate    | 联合     | aggregate_type, aggregate_id | 按聚合查询事件              |
    | idx_event_created_at   | 普通     | created_at                   | 创建时间排序                |

    表 7.8.2-1 domain_event_publish索引定义

+   **数据清理策略**：PUBLISHED状态的事件记录保留30天，超出部分由定时任务归档至冷存储或删除

## 7.9 Redis缓存设计

+   BC-51 Redis Key设计如下表所示

    | Key模式                             | 数据类型 | TTL   | 说明               | 版本 |
    | ----------------------------------- | -------- | ----- | ------------------ | ---- |
    | collect:lock:{sourceId}             | String   | 30min | 采集任务分布式锁   | P2+  |
    | monitor:lock:{sourceId}             | String   | 10min | 变更监测分布式锁   | P2+  |
    | source:detail:{sourceId}            | Hash     | 10min | 外规源详情缓存     | P2+  |
    | source:list:page:{hash}             | String   | 5min  | 外规源列表分页缓存 | P2+  |
    | task:statistics:{periodType}:{date} | Hash     | 5min  | 采集统计数据缓存   | P2+  |

    表 7.9-1 Redis Key设计

+   **P1阶段说明**：P1阶段不使用Redis，无分布式锁和缓存需求。P2+引入自动采集和工作管理后启用Redis。

+   **缓存策略（P2+）**：
    -   写操作后主动失效相关缓存（Cache Aside模式）
    -   分布式锁使用Redisson实现，支持可重入和自动续期
    -   缓存穿透防护：空结果缓存60秒
    -   缓存击穿防护：热点Key使用互斥锁加载

## 7.10 ES索引设计

+   BC-51的ES索引设计已整合至T-03和T-04的定义中，ES作为外规清单与结构化内容的主存储引擎
+   原idx_regulation_document辅助查询索引不再需要，其字段已完全覆盖在idx_raw_document（T-03）中
+   数据写入策略：文档审核通过（APPROVED）后，应用层同步写入ES索引，采用`refresh=wait_for`确保写入后立即可查。ES为主数据源
+   索引版本管理：通过索引别名（alias）管理Mapping版本迁移，如`idx_raw_document_v1` → 别名`idx_raw_document`

# 8 前端交互设计

## 8.1 页面总览

### 8.1.1 页面清单

+   BC-51前端页面清单如下表所示

    | 页面编号 | 页面名称        | 路由                                         | 入口                  | 权限                           | 版本 |
    | -------- | --------------- | -------------------------------------------- | --------------------- | ------------------------------ | ---- |
    | PG-05    | 采集任务详情    | /provider/tasks/:taskId                      | PG-06操作后跳转       | provider:content:task:read     | P1   |
    | PG-06    | 人工录入        | /provider/tasks/manual                       | 供给侧后台 > 人工录入 | provider:content:task:create   | P1   |
    | PG-09    | 文档处理工作台  | /provider/documents/parse-review             | 供给侧后台 > 文档处理 | provider:content:review:read   | P1   |
    | PG-10    | 文档比对与校验  | /provider/documents/:documentId/parse-review | PG-09列表行点击       | provider:content:review:read   | P1   |
    | PG-01    | 外规源管理      | /provider/sources                            | 供给侧后台 > 外规采集 | provider:content:source:read   | P2+  |
    | PG-02    | 外规源详情      | /provider/sources/:sourceId                  | PG-01列表行点击       | provider:content:source:read   | P2+  |
    | PG-03    | 新建/编辑外规源 | /provider/sources/create 或 /:sourceId/edit  | PG-01操作按钮         | provider:content:source:create | P2+  |
    | PG-04    | 采集任务看板    | /provider/tasks                              | 供给侧后台 > 采集任务 | provider:content:task:read     | P2+  |
    | PG-07    | 变更监测        | /provider/monitors                           | 供给侧后台 > 变更监测 | provider:content:monitor:read  | P2+  |
    | PG-08    | 变更差异详情    | /provider/monitors/:monitorTaskId/diff       | PG-07列表行点击       | provider:content:monitor:read  | P2+  |
    | PG-11    | 采集统计仪表盘  | /provider/dashboard                          | 供给侧后台 > 数据概览 | provider:content:task:read     | P2+  |

    表 8.1.1-1 前端页面清单

### 8.1.2 页面导航结构

+   BC-51前端导航结构如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────┐
    │                    供给侧后台 左侧导航菜单                      │
    ├────────────────────────────────────────────────────────────────┤
    │                                                                │
    │   📋 外规采集（P1）                                           │
    │   ├── 人工录入 (PG-06)                                        │
    │   └── 文档处理工作台 (PG-09)                                  │
    │                                                                │
    │   📋 外规采集（P2+）                                          │
    │   ├── 外规源管理 (PG-01)                                      │
    │   ├── 采集任务 (PG-04)                                        │
    │   └── 变更监测 (PG-07)                                        │
    │                                                                │
    │   📊 数据概览（P2+）                                          │
    │   └── 采集统计仪表盘 (PG-11)                                  │
    │                                                                │
    └────────────────────────────────────────────────────────────────┘
    ```

    图 8.1.2-1 导航结构

## 8.2 PG-01 外规源管理页面

### 8.2.1 页面布局

+   外规源管理页面布局如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 外规采集 > 外规源管理                            │
    ├────────────────────────────────────────────────────────────────────────┤
    │ ┌──────────────────────────────────────────────────────────────────┐  │
    │ │ 搜索区                                                          │  │
    │ │ [关键词输入框____] [类型下拉▼] [状态下拉▼] [搜索] [重置]        │  │
    │ └──────────────────────────────────────────────────────────────────┘  │
    │                                                                      │
    │ ┌──────────────────────────────────────────────────────────────────┐  │
    │ │ 操作栏                                            [+ 新建外规源] │  │
    │ ├──────────────────────────────────────────────────────────────────┤  │
    │ │ 名称        │ 类型   │ URL       │ 状态   │ 最近采集 │ 操作     │  │
    │ ├─────────────┼────────┼───────────┼────────┼──────────┼──────────┤  │
    │ │ 银保监官网  │政府网站│https://...│ 已启用 │ 2h前     │ 详情 ⋮  │  │
    │ │ 北大法宝    │法律数据│https://...│ 草稿   │ -        │ 详情 ⋮  │  │
    │ │ ...         │ ...    │ ...       │ ...    │ ...      │ ...      │  │
    │ ├──────────────────────────────────────────────────────────────────┤  │
    │ │                        < 1 2 3 ... 10 >                         │  │
    │ └──────────────────────────────────────────────────────────────────┘  │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.2.1-1 外规源管理页面布局

### 8.2.2 交互说明

+   外规源管理页面交互说明如下表所示

    | 交互编号 | 触发元素              | 交互行为                                                              | 调用接口 |
    | -------- | --------------------- | --------------------------------------------------------------------- | -------- |
    | IA-01    | 搜索按钮              | 根据筛选条件刷新列表，重置页码为1                                     | P-RA-07  |
    | IA-02    | 重置按钮              | 清空所有筛选条件，重新加载列表                                        | P-RA-07  |
    | IA-03    | "+ 新建外规源"按钮    | 跳转至PG-03新建外规源页面                                             | -        |
    | IA-04    | 列表行"详情"链接      | 跳转至PG-02外规源详情页面                                             | -        |
    | IA-05    | 操作列"⋮"更多菜单     | 弹出下拉菜单：编辑/启用/停用/归档/测试连通性                          | -        |
    | IA-06    | 更多菜单 > 启用       | 二次确认弹窗"确认启用该外规源？启用后将自动注册采集任务"→调用启用接口 | P-RA-03  |
    | IA-07    | 更多菜单 > 停用       | 二次确认弹窗"确认停用？停用后自动采集将暂停"→调用停用接口             | P-RA-04  |
    | IA-08    | 更多菜单 > 归档       | 二次确认弹窗"确认归档？归档后不可恢复"→调用归档接口                   | P-RA-05  |
    | IA-09    | 更多菜单 > 测试连通性 | 发送测试请求，Loading状态→成功Toast/失败Toast（含HTTP状态码和耗时）   | P-RA-08  |
    | IA-10    | 分页器                | 切换页码，保持筛选条件                                                | P-RA-07  |

    表 8.2.2-1 外规源管理页面交互说明

### 8.2.3 状态徽标映射

+   外规源状态在列表中的展示样式如下表所示

    | 状态值   | 中文显示 | 徽标颜色 | 可用操作               |
    | -------- | -------- | -------- | ---------------------- |
    | DRAFT    | 草稿     | 灰色     | 编辑、启用             |
    | ENABLED  | 已启用   | 绿色     | 编辑、停用、测试连通性 |
    | DISABLED | 已停用   | 橙色     | 编辑、启用、归档       |
    | ARCHIVED | 已归档   | 红色     | 无（只读）             |

    表 8.2.3-1 外规源状态徽标映射

## 8.3 PG-03 新建/编辑外规源页面

### 8.3.1 页面布局

+   新建/编辑外规源页面布局如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 外规源管理 > 新建外规源                          │
    ├────────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  ┌── 基本信息 ──────────────────────────────────────────────────┐    │
    │  │ 外规源名称 *  [____________________________]                  │    │
    │  │ 外规源类型 *  [政府网站 ▼]                                    │    │
    │  │ 外规源URL  *  [____________________________]  [测试连通性]   │    │
    │  │ 发布机构      [____________________________]                  │    │
    │  │ 描述说明      [____________________________]                  │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  ┌── 访问凭证 ──────────────────────────────────────────────────┐    │
    │  │ 凭证类型      [无需凭证 ▼]                                    │    │
    │  │                                                                │    │
    │  │ [当 credType=API_KEY 时显示]                                   │    │
    │  │ API密钥  *    [____________________________]                   │    │
    │  │                                                                │    │
    │  │ [当 credType=BASIC_AUTH 时显示]                                │    │
    │  │ 用户名   *    [____________________________]                   │    │
    │  │ 密码     *    [____________________________]                   │    │
    │  │                                                                │    │
    │  │ [当 credType=OAUTH2 时显示]                                    │    │
    │  │ Token URL *   [____________________________]                   │    │
    │  │ Client ID *   [____________________________]                   │    │
    │  │ Client Secret* [____________________________]                  │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  ┌── 采集调度配置 ──────────────────────────────────────────────┐    │
    │  │ 采集频率 *    [每天一次 ▼] 或 自定义Cron [______________]     │    │
    │  │ 监测频率 *    [每天一次 ▼] 或 自定义Cron [______________]     │    │
    │  │ 重试次数      [3 ▼]                                           │    │
    │  │ 超时时间      [30 ▼] 分钟                                     │    │
    │  │ 自定义请求头  [+ 添加请求头]                                   │    │
    │  │   Key [________]  Value [________]  [删除]                    │    │
    │  │ User-Agent    [____________________________]                   │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │                                   [取消]  [保存草稿]  [保存并启用]   │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.3.1-1 新建/编辑外规源页面布局

### 8.3.2 交互说明

+   新建/编辑外规源页面交互说明如下表所示

    | 交互编号 | 触发元素         | 交互行为                                                               | 调用接口        |
    | -------- | ---------------- | ---------------------------------------------------------------------- | --------------- |
    | IA-11    | 凭证类型下拉     | 根据选择动态显示/隐藏对应凭证字段                                      | -               |
    | IA-12    | 采集频率下拉     | 预设选项：每小时/每6小时/每天/每周/自定义；选择自定义时展示Cron输入框  | -               |
    | IA-13    | "测试连通性"按钮 | 仅在URL已填写时可点击，发送测试请求，展示结果Toast                     | P-RA-08         |
    | IA-14    | "+ 添加请求头"   | 新增一行Key-Value输入行                                                | -               |
    | IA-15    | "保存草稿"按钮   | 前端校验通过后调用创建/更新接口，外规源保持DRAFT状态                   | P-RA-01/P-RA-02 |
    | IA-16    | "保存并启用"按钮 | 前端校验→创建/更新→自动调用启用接口；启用失败时保留DRAFT并提示失败原因 | P-RA-01+P-RA-03 |
    | IA-17    | "取消"按钮       | 二次确认弹窗（仅表单有修改时）→返回列表页                              | -               |

    表 8.3.2-1 新建/编辑外规源页面交互说明

### 8.3.3 前端校验规则

+   新建外规源前端校验规则如下表所示

    | 字段         | 校验规则                       | 校验时机      | 提示信息                |
    | ------------ | ------------------------------ | ------------- | ----------------------- |
    | 外规源名称   | 必填，2~100字符                | blur + submit | 请输入2~100字符的名称   |
    | 外规源类型   | 必填                           | submit        | 请选择外规源类型        |
    | 外规源URL    | 必填，HTTP/HTTPS URL格式       | blur + submit | 请输入合法的HTTP(S) URL |
    | 采集频率Cron | 合法Cron表达式（自定义模式下） | blur + submit | Cron表达式格式不正确    |
    | 监测频率Cron | 合法Cron表达式（自定义模式下） | blur + submit | Cron表达式格式不正确    |
    | API密钥      | credType=API_KEY时必填         | submit        | 请输入API密钥           |
    | 用户名/密码  | credType=BASIC_AUTH时必填      | submit        | 请输入用户名/密码       |
    | OAuth2字段   | credType=OAUTH2时各字段必填    | submit        | 请填写完整OAuth2配置    |

    表 8.3.3-1 新建外规源前端校验规则

## 8.4 PG-04 采集任务看板页面

### 8.4.1 页面布局

+   采集任务看板页面布局如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 采集任务                                         │
    ├────────────────────────────────────────────────────────────────────────┤
    │ ┌── 统计卡片区 ───────────────────────────────────────────────────┐  │
    │ │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │  │
    │ │  │ 待执行  │ │ 执行中  │ │ 已完成  │ │ 已失败  │ │ 成功率  │  │  │
    │ │  │   12    │ │    3    │ │   856   │ │   15    │ │  96.2%  │  │  │
    │ │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │  │
    │ └────────────────────────────────────────────────────────────────────┘  │
    │                                                                      │
    │ ┌── 筛选区 ──────────────────────────────────────────────────────┐  │
    │ │ [关键词____] [外规源▼] [类型▼] [状态▼] [优先级▼]              │  │
    │ │ [创建起始____] ~ [创建结束____]                                │  │
    │ │ [搜索] [重置]                          [手动触发] [人工录入]   │  │
    │ └────────────────────────────────────────────────────────────────┘  │
    │                                                                      │
    │ ┌── 任务列表 ────────────────────────────────────────────────────┐  │
    │ │ 任务ID  │外规源│类型│状态  │优先级│重试│创建时间    │操作     │  │
    │ ├─────────┼──────┼────┼──────┼──────┼────┼────────────┼─────────┤  │
    │ │ a1b2... │银保监│自动│●已完成│ P3  │ 0  │2026-02-08  │详情     │  │
    │ │ c3d4... │北大法│手动│●解析中│ P2  │ 0  │2026-02-08  │详情     │  │
    │ │ e5f6... │证监会│自动│●已失败│ P3  │ 2  │2026-02-07  │详情 重试│  │
    │ │ ...     │ ...  │ .. │ ...  │ ... │ .. │ ...        │ ...     │  │
    │ ├──────────────────────────────────────────────────────────────────┤  │
    │ │                    < 1 2 3 ... 50 >        [导出Excel]          │  │
    │ └────────────────────────────────────────────────────────────────────┘  │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.4.1-1 采集任务看板页面布局

### 8.4.2 交互说明

+   采集任务看板页面交互说明如下表所示

    | 交互编号 | 触发元素         | 交互行为                                           | 调用接口 |
    | -------- | ---------------- | -------------------------------------------------- | -------- |
    | IA-20    | 统计卡片         | 页面加载时请求统计数据（默认TODAY时段）            | P-RA-15  |
    | IA-21    | 统计卡片点击     | 点击某状态卡片，自动设置状态筛选条件并刷新列表     | P-RA-14  |
    | IA-22    | "手动触发"按钮   | 弹出Modal：选择外规源→可选填覆盖URL→确认后创建任务 | P-RA-10  |
    | IA-23    | "人工录入"按钮   | 跳转至PG-06人工录入页面                            | -        |
    | IA-24    | 列表行"详情"链接 | 跳转至PG-05采集任务详情页                          | -        |
    | IA-25    | 列表行"重试"按钮 | 仅FAILED状态显示，二次确认后调用重试接口           | P-RA-11  |
    | IA-26    | "导出Excel"按钮  | 按当前筛选条件导出Excel，超10万条提示缩小范围      | P-RA-16  |

    表 8.4.2-1 采集任务看板页面交互说明

### 8.4.3 状态徽标映射

+   采集任务状态在列表中的展示样式如下表所示

    | 状态值    | 中文显示 | 徽标颜色 | 可用操作 |
    | --------- | -------- | -------- | -------- |
    | PENDING   | 待执行   | 灰色     | 取消     |
    | RUNNING   | 采集中   | 蓝色动画 | 无       |
    | COLLECTED | 已采集   | 蓝色     | 无       |
    | PARSING   | 解析中   | 蓝色动画 | 无       |
    | COMPLETED | 已完成   | 绿色     | 无       |
    | FAILED    | 已失败   | 红色     | 重试     |
    | CANCELLED | 已取消   | 灰色     | 无       |

    表 8.4.3-1 采集任务状态徽标映射

## 8.5 PG-05 采集任务详情页面

### 8.5.1 页面布局

+   采集任务详情页面布局如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 采集任务 > 任务详情                               │
    ├────────────────────────────────────────────────────────────────────────┤
    │                                                                        │
    │  ┌── 任务头部 ──────────────────────────────────────────────────┐      │
    │  │ 任务ID: a1b2c3d4    状态: ●已完成(绿色)    优先级: P3        │      │
    │  │ 外规源: 银保监官网   类型: 自动采集         触发: 定时调度   │      │
    │  │ 创建时间: 2026-02-08 08:00:00                                │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 流程时间线 ────────────────────────────────────────────────┐      │
    │  │  ○ 创建 ──── ● 采集中 ──── ● 已采集 ──── ● 解析中            │      │
    │  │  08:00:00    08:00:02      08:02:15       08:02:16           │      │
    │  │                                                              │      │
    │  │  ──── ● 已完成                                               │      │
    │  │        08:05:30                                              │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── Tab区 ─────────────────────────────────────────────────────┐      │
    │  │ [采集结果] [解析结果] [审核信息] [失败信息]                  │      │
    │  │                                                              │      │
    │  │ 采集结果:                                                    │      │
    │  │ 文件名: regulation_2024_15.pdf   文件大小: 2.3MB             │      │
    │  │ MIME类型: application/pdf        内容哈希: sha256:a1b2...    │      │
    │  │ HTTP状态: 200                    响应耗时: 1,250ms           │      │
    │  │ 采集时间: 2026-02-08 08:02:15    [下载原始文件]              │      │
    │  │                                                              │      │
    │  │ 解析结果:                                                    │      │
    │  │ 格式: PDF    章节: 12    条款: 85    质量评分: 92/100        │      │
    │  │ 解析耗时: 3,140ms                                            │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 操作区（按状态条件显示） ──────────────────────────────────┐      │
    │  │ [重试] ← 仅FAILED状态显示    [取消] ← 仅PENDING状态显示      │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.5.1-1 采集任务详情页面布局

### 8.5.2 交互说明

+   采集任务详情页面交互说明如下表所示

    | 交互编号 | 触发元素           | 交互行为                                                                                                                                     | 调用接口      |
    | -------- | ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
    | IA-30    | 页面加载           | 请求任务详情数据                                                                                                                             | P-RA-13       |
    | IA-31    | "下载原始文件"链接 | 调用BC-13文件下载接口，浏览器下载文件                                                                                                        | BC-13文件接口 |
    | IA-32    | Tab切换            | 前端本地切换，无接口请求（数据一次性加载）                                                                                                   | -             |
    | IA-33    | 失败信息Tab        | 仅FAILED状态显示：展示错误码、错误信息、失败步骤                                                                                             | -             |
    | IA-34    | "重试"按钮         | 仅FAILED状态显示。二次确认弹窗→调用重试接口→成功Toast"已重新提交，正在解析"→刷新页面                                                         | P-RA-11       |
    | IA-35    | "取消"按钮         | 仅PENDING状态显示（P1阶段MANUAL任务不经过PENDING状态，此按钮在P2+ AUTO任务中生效）。二次确认弹窗→调用取消接口→成功Toast"任务已取消"→刷新页面 | P-RA-12       |

    表 8.5.2-1 采集任务详情页面交互说明

## 8.6 PG-06 人工录入页面

### 8.6.1 页面布局

+   人工录入页面布局如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 采集任务 > 人工录入                               │
    ├────────────────────────────────────────────────────────────────────────┤
    │                                                                        │
    │  ┌── 步骤条 ────────────────────────────────────────────────────┐      │
    │  │  ① 上传文件  ──────  ② 填写元数据  ──────  ③ 确认提交        │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 步骤1: 上传文件 ───────────────────────────────────────────┐      │
    │  │                                                              │      │
    │  │        ┌───────────────────────────────┐                     │      │
    │  │        │     📄                        │                    │    │  
    │  │        │  点击或拖拽上传外规文件        │                    │      │
    │  │        │  支持 PDF                     │                    │      │
    │  │        │  （P2+扩展Word/HTML等格式）   │                    │      │
    │  │        │  单文件不超过 50MB              │                   │      │
    │  │        └───────────────────────────────┘                     │      │
    │  │                                                              │      │
    │  │  关联外规源（可选）  [请选择外规源 ▼]                        │      │
    │  │  优先级              [P3-普通 ▼]                             │      │
    │  │                                                              │      │
    │  │                                               [下一步]       │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 步骤2: 填写元数据 ─────────────────────────────────────────┐      │
    │  │  外规名称 *    [____________________________]                │      │
    │  │  外规编号      [____________________________]                │      │
    │  │  发布机构 *    [____________________________]                │      │
    │  │  发布日期      [日期选择器____]                              │      │
    │  │  生效日期      [日期选择器____]                              │      │
    │  │  外规类型      [法规 ▼]                                      │      │
    │  │  行业标签      [标签选择器，支持多选]                        │      │
    │  │                                                              │      │
    │  │                                     [上一步]  [下一步]       │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 步骤3: 确认提交 ───────────────────────────────────────────┐      │
    │  │  文件: regulation_2024_15.pdf (2.3MB)                        │      │
    │  │  外规名称: 商业银行资本管理办法                              │      │
    │  │  发布机构: 中国银保监会                                      │      │
    │  │  发布日期: 2024-03-15                                        │      │
    │  │  ...                                                         │      │
    │  │                                     [上一步]  [确认提交]     │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    │  ┌── 我的录入记录 ──────────────────────────────────────────────┐      │
    │  │  最近录入的采集任务（当前用户创建，按创建时间倒序，最多20条）│      │
    │  │ 外规名称         │状态     │质量评分│创建时间      │操作     │      │
    │  ├──────────────────┼─────────┼────────┼──────────────┼─────────┤      │
    │  │商业银行资本管理..│●已完成  │  92    │2026-02-08    │[详情]   │      │
    │  │证券公司风险管理..│●已失败  │  -     │2026-02-08    │[详情][重试]    │
    │  │ ...              │ ...     │ ...    │ ...          │ ...     │      │
    │  └──────────────────────────────────────────────────────────────┘      │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.6.1-1 人工录入页面布局

### 8.6.2 交互说明

+   人工录入页面交互说明如下表所示

    | 交互编号 | 触发元素       | 交互行为                                                               | 调用接口      |
    | -------- | -------------- | ---------------------------------------------------------------------- | ------------- |
    | IA-40    | 文件拖拽/点击  | 文件选择后上传至BC-13，显示上传进度条，完成后显示文件名和大小          | BC-13上传接口 |
    | IA-41    | 步骤1"下一步"  | 校验文件已上传→进入步骤2                                               | -             |
    | IA-42    | 步骤2"下一步"  | 校验必填字段（外规名称、发布机构）→进入步骤3                           | -             |
    | IA-43    | "确认提交"按钮 | 调用人工录入接口→成功后跳转至PG-05任务详情页→Toast"提交成功，正在解析" | P-RA-09       |
    | IA-44    | 页面加载       | 同时请求当前用户的录入记录列表（taskType=MANUAL，createdBy=当前用户）  | P-RA-14       |
    | IA-45    | 录入记录"详情" | 跳转至PG-05任务详情页                                                  | -             |
    | IA-46    | 录入记录"重试" | 仅FAILED状态显示。二次确认→调用重试接口→刷新列表                       | P-RA-11       |

    表 8.6.2-1 人工录入页面交互说明

## 8.7 PG-07 变更监测页面

### 8.7.1 页面布局

+   变更监测页面布局说明：
    -   顶部：面包屑导航
    -   筛选区：外规源下拉、状态下拉（有变更/无变更/全部）、检测时间范围、搜索/重置按钮
    -   列表区：监测任务ID、外规源名称、状态、检测时间、变更摘要（新增/修改/删除条款数）、操作（查看差异）
    -   点击"查看差异"跳转至PG-08变更差异详情页

### 8.7.2 交互说明

+   变更监测页面交互说明如下表所示

    | 交互编号 | 触发元素       | 交互行为                                 | 调用接口 |
    | -------- | -------------- | ---------------------------------------- | -------- |
    | IA-50    | 页面加载       | 请求监测任务列表（默认显示有变更的任务） | P-RA-18  |
    | IA-51    | "查看差异"链接 | 跳转至PG-08变更差异详情页                | -        |
    | IA-52    | "重试"按钮     | 仅FAILED状态显示，确认后重试             | P-RA-22  |

    表 8.7.2-1 变更监测页面交互说明

## 8.8 PG-08 变更差异详情页面

### 8.8.1 页面布局

+   变更差异详情页面布局如下图所示

    ```
    ┌───────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 变更监测 > 变更差异详情                      │
    ├───────────────────────────────────────────────────────────────────┤
    │                                                                   │
    │  ┌── 变更概要 ─────────────────────────────────────────────────┐  │
    │  │ 外规源: 银保监官网    外规: 商业银行资本管理办法            │  │
    │  │ 检测时间: 2026-02-08 06:00:00                               │  │
    │  │ 变更摘要: 新增 3 条款  |  修改 5 条款  |  删除 1 条款       │  │
    │  └─────────────────────────────────────────────────────────────┘  │
    │                                                                   │
    │  ┌── 差异对比视图 ─────────────────────────────────────────────┐  │
    │  │ [Tab: 新增(3)]  [修改(5)]  [删除(1)]                        │  │
    │  │                                                             │  │
    │  │ 修改条款 #1: 第三章 第15条                                  │  │
    │  │ ┌─── 修改前 ──────────────┬─── 修改后 ──────────────┐       │  │
    │  │ │ 商业银行应当按照本办法  │ 商业银行应当按照本办法  │       │  │
    │  │ │ 规定计提 [-8%] 的资本   │ 规定计提 [+10.5%] 的资本│       │  │
    │  │ │ 充足率...               │ 充足率...               │       │  │
    │  │ └─────────────────────────┴─────────────────────────┘       │  │
    │  │                                                             │  │
    │  │ 修改条款 #2: 第五章 第28条                                  │  │
    │  │ ┌─── 修改前 ──────────────┬─── 修改后 ──────────────┐       │  │
    │  │ │ ...                     │ ...                     │       │  │
    │  │ └─────────────────────────┴─────────────────────────┘       │  │
    │  └─────────────────────────────────────────────────────────────┘  │
    │                                                                   │
    └───────────────────────────────────────────────────────────────────┘
    ```

    图 8.8.1-1 变更差异详情页面布局

### 8.8.2 交互说明

+   变更差异详情页面交互说明如下表所示

    | 交互编号 | 触发元素 | 交互行为                                                       | 调用接口 |
    | -------- | -------- | -------------------------------------------------------------- | -------- |
    | IA-55    | 页面加载 | 请求变更差异详情                                               | P-RA-21  |
    | IA-56    | Tab切换  | 前端本地切换新增/修改/删除条款视图                             | -        |
    | IA-57    | 差异高亮 | 修改条款使用左右对比视图，新增内容绿色高亮，删除内容红色删除线 | -        |

    表 8.8.2-1 变更差异详情页面交互说明

## 8.9 PG-09 文档处理工作台页面

### 8.9.1 页面布局

+   文档处理工作台页面布局如下图所示

    ```
    ┌───────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 文档处理工作台                                   │
    ├───────────────────────────────────────────────────────────────────────┤
    │ ┌── Tab ─────────────────────────────────────────────────────────┐    │
    │ │ [待比对(3)]  [待校验(5)]  [待发布(2)]  [已发布(45)]            │    │
    │ └────────────────────────────────────────────────────────────────┘    │
    │                                                                       │
    │ ┌── 搜索区 ──────────────────────────────────────────────────────┐    │
    │ │ [外规名称____]  [搜索]  [重置]                                 │    │
    │ └────────────────────────────────────────────────────────────────┘    │
    │                                                                       │
    │ ┌── 文档列表 ──────────────────────────────────────────────────┐     │
    │ │ 外规名称         │发布机构│状态      │图片数│创建时间 │操作   │     │
    │ ├──────────────────┼────────┼──────────┼──────┼─────────┼───────┤     │
    │ │商业银行资本管理..│银保监会│MD已就绪  │  5   │02-08    │[比对] │     │
    │ │证券公司监督管理..│证监会  │JSON已就绪│  3   │02-08    │[校验] │     │
    │ │保险资金运用管理..│银保监会│待发布    │  0   │02-07    │[发布] │     │
    │ │ ...              │ ...    │ ...      │ ...  │ ...     │ ...   │     │
    │ └────────────────────────────────────────────────────────────────┘    │
    │                                                                       │
    │  说明: 待比对=MD_READY  待校验=JSON_READY  待发布=PENDING_PUBLISH     │
    └───────────────────────────────────────────────────────────────────────┘
    ```

    图 8.9.1-1 文档处理工作台页面布局

### 8.9.2 交互说明

+   文档处理工作台页面交互说明如下表所示

    | 交互编号 | 触发元素   | 交互行为                                                                                                    | 调用接口 |
    | -------- | ---------- | ----------------------------------------------------------------------------------------------------------- | -------- |
    | IA-60    | 页面加载   | 请求文档列表（默认status=MD_READY，即"待比对"Tab）                                                          | P-RA-29  |
    | IA-61    | Tab切换    | 待比对：status=MD_READY；待校验：status=JSON_READY；待发布：status=PENDING_PUBLISH；已发布：status=APPROVED | P-RA-29  |
    | IA-62    | "比对"按钮 | 跳转至PG-10 MD比对校正视图（status=MD_READY时显示）                                                         | -        |
    | IA-62a   | "校验"按钮 | 跳转至PG-10 JSON校验视图（status=JSON_READY时显示）                                                         | -        |
    | IA-62b   | "发布"按钮 | 弹出发布确认弹窗（status=PENDING_PUBLISH时显示）                                                            | P-RA-31  |
    | IA-63    | 搜索按钮   | 根据外规名称筛选刷新列表                                                                                    | P-RA-29  |

    表 8.9.2-1 文档处理工作台页面交互说明

## 8.10 PG-10 文档比对与校验视图页面

### 8.10.1 页面布局

+   文档比对与校验视图页面布局如下图所示。根据文档当前状态，页面自动切换为"MD比对校正模式"或"JSON校验模式"

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │ 面包屑: 供给侧后台 > 文档处理工作台 > 文档比对与校验                   │
    │ 外规: 商业银行资本管理办法   状态: MD已就绪 / JSON已就绪              │
    ├───────────────────────────────┬────────────────────────────────────────┤
    │                               │                                        │
    │  ┌── 左侧: 原始PDF预览 ───┐  │  ┌── 右侧: 可编辑内容 ──────────────┐  │
    │  │                         │  │  │                                  │  │
    │  │  [PDF在线预览器]        │  │  │ 【MD比对模式】(status=MD_READY)  │  │
    │  │                         │  │  │  P1: 纯文本编辑器（textarea）   │  │
    │  │  ┌───────────────────┐  │  │  │  P2+: MD编辑器（实时预览）      │  │
    │  │  │                   │  │  │  │                                  │  │
    │  │  │  原始PDF内容      │  │  │  │ 【JSON校验模式】(status=JSON_)  │  │
    │  │  │  PDF.js渲染       │  │  │  │  P1: 纯文本JSON编辑器           │  │
    │  │  │                   │  │  │  │  P2+: 可视化树形编辑器          │  │
    │  │  │                   │  │  │  │                                  │  │
    │  │  └───────────────────┘  │  │  └──────────────────────────────────┘  │
    │  │                         │  │                                        │
    │  └─────────────────────────┘  │  ┌── 图片管理面板 ──────────────────┐  │
    │                               │  │ [上传图片] [查看全部图片(5)]     │  │
    │                               │  │ ┌────┐ ┌────┐ ┌────┐            │  │
    │                               │  │ │img1│ │img2│ │img3│ ...        │  │
    │                               │  │ │[替]│ │[替]│ │[删]│            │  │
    │                               │  │ └────┘ └────┘ └────┘            │  │
    │                               │  └──────────────────────────────────┘  │
    │                               │                                        │
    ├───────────────────────────────┴────────────────────────────────────────┤
    │                                                                        │
    │  ┌── 操作区 ────────────────────────────────────────────────────────┐  │
    │  │  备注: [____________________________________]                    │  │
    │  │                                                                  │  │
    │  │  [返回列表]  [回退至MD编辑]             [提交校正/校验 ✓]         │  │
    │  └──────────────────────────────────────────────────────────────────┘  │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.10.1-1 文档比对与校验视图页面布局

### 8.10.2 交互说明

+   文档比对与校验视图页面交互说明如下表所示

    | 交互编号 | 触发元素             | 交互行为                                                            | 调用接口                                              |
    | -------- | -------------------- | ------------------------------------------------------------------- | ----------------------------------------------------- |
    | IA-70    | 页面加载             | 请求文档详情（含原始PDF URL、MD内容或JSON结构化内容、图片列表）     | P-RA-30                                               |
    | IA-71    | 左侧文档预览         | 通过iframe嵌入BC-13文件预览服务（PDF.js渲染）                       | BC-13预览接口                                         |
    | IA-72    | 右侧内容编辑         | MD模式：直接编辑MD文本；JSON模式：编辑JSON结构化内容                | -                                                     |
    | IA-73    | 左右联动滚动         | 点击右侧内容时，尝试在左侧PDF中定位对应区域（通过关键词匹配）       | -                                                     |
    | IA-74    | "上传图片"按钮       | 选择本地图片文件→上传至BC-13→返回fileId→插入图片引用到MD/JSON中     | P-RA-35                                               |
    | IA-74a   | 图片缩略图"替换"按钮 | 选择新图片→上传至BC-13→替换原图片fileId引用→更新MD/JSON中的图片引用 | P-RA-36                                               |
    | IA-74b   | 图片缩略图"删除"按钮 | 二次确认弹窗→删除图片关联→移除MD/JSON中的图片引用                   | P-RA-37                                               |
    | IA-75    | "提交校正/校验"按钮  | 收集编辑内容+图片变更→二次确认弹窗→调用提交接口→成功Toast→返回列表  | P-RA-32/P-RA-33（MD模式用P-RA-32，JSON模式用P-RA-33） |
    | IA-75a   | "回退至MD编辑"按钮   | 仅JSON_READY状态显示，二次确认→回退状态至MD_READY→刷新为MD编辑模式  | P-RA-34                                               |
    | IA-76    | "返回列表"按钮       | 如有未保存的修改，弹出"确认离开？修改将丢失"提示→确认后返回PG-09    | -                                                     |

    表 8.10.2-1 文档比对与校验视图页面交互说明

## 8.11 PG-11 采集统计仪表盘页面

### 8.11.1 页面布局

+   采集统计仪表盘页面布局说明：
    -   顶部：时间范围选择器（今日/近7日/近30日/自定义）
    -   第一行：核心指标卡片（总采集次数、成功率、平均耗时、活跃外规源数、待审核数）
    -   第二行左：采集趋势折线图（每日采集次数，成功/失败分线）
    -   第二行右：外规源采集分布饼图（按外规源类型分组）
    -   第三行左：任务状态分布环形图
    -   第三行右：采集耗时分布柱状图（0~5s/5~15s/15~30s/>30s各区间占比）

### 8.11.2 交互说明

+   采集统计仪表盘页面交互说明如下表所示

    | 交互编号 | 触发元素     | 交互行为                                               | 调用接口 |
    | -------- | ------------ | ------------------------------------------------------ | -------- |
    | IA-80    | 页面加载     | 请求默认时段（近7日）统计数据                          | P-RA-15  |
    | IA-81    | 时间范围切换 | 按选择的时段重新请求统计数据，刷新所有图表             | P-RA-15  |
    | IA-82    | 图表区域点击 | 折线图点击某日→跳转至PG-04任务列表（自动设置日期筛选） | -        |

    表 8.11.2-1 采集统计仪表盘页面交互说明

## 8.12 通用交互规范

+   BC-51前端通用交互规范如下表所示

    | 规范项   | 规范内容                                                                   |
    | -------- | -------------------------------------------------------------------------- |
    | 加载状态 | 列表加载：骨架屏Skeleton；按钮操作：按钮Loading状态+禁用防重复提交         |
    | 空状态   | 列表无数据：展示空状态插图+引导文案（如"暂无外规源，立即创建"）            |
    | 错误处理 | 网络错误：全局Toast提示；业务错误：表单字段红色提示+错误信息               |
    | 二次确认 | 所有不可逆操作（归档、删除、审核通过）均需二次确认弹窗                     |
    | 权限控制 | 无权限的操作按钮不显示（非灰色禁用），菜单项根据权限动态渲染               |
    | 响应式   | 最小支持宽度1280px，表格列自适应，超宽字段省略号+Tooltip                   |
    | 时间格式 | 列表中使用相对时间（"5分钟前"），详情中使用绝对时间（yyyy-MM-dd HH:mm:ss） |
    | 分页默认 | 默认pageSize=20，可选10/20/50/100                                          |

    表 8.12-1 通用交互规范

# 9 后端工程结构设计

## 9.1 工程概述

### 9.1.1 微服务归属

+   BC-51外规采集子领域归属于SVC-06 svc-content-collect微服务
+   该微服务仅包含BC-51一个子领域，采用标准DDD四层架构
+   技术栈：Spring Boot 3.x + MyBatis-Plus + Kafka + Redis + ES + XXL-JOB

### 9.1.2 工程模块划分

+   svc-content-collect工程模块划分如下表所示

    | 模块名称                           | 模块类型    | 职责说明                                                            |
    | ---------------------------------- | ----------- | ------------------------------------------------------------------- |
    | svc-content-collect-api            | API契约     | Feign接口定义、DTO、事件常量、枚举类（被下游BC-52依赖）             |
    | svc-content-collect-app            | Spring Boot | 启动模块，含Main类、配置文件、部署配置                              |
    | svc-content-collect-interfaces     | 接口层      | Controller、BFF适配器、XXL-JOB Handler、Kafka Consumer              |
    | svc-content-collect-application    | 应用层      | 应用服务、Command/Query对象、DTO组装器                              |
    | svc-content-collect-domain         | 领域层      | 聚合根、实体、值对象、领域服务、领域事件、Repository接口            |
    | svc-content-collect-infrastructure | 基础设施层  | Repository实现、MyBatis Mapper、Redis工具、ES客户端、外部服务适配器 |

    表 9.1.2-1 工程模块划分

### 9.1.3 模块依赖关系

+   模块依赖关系如下图所示

    ```
    ┌────────────────────────────────────────────────────────────────────────┐
    │                        模块依赖关系图                                  │
    ├────────────────────────────────────────────────────────────────────────┤
    │                                                                        │
    │   svc-content-collect-app (启动模块)                                   │
    │   │                                                                    │
    │   ├──▶ svc-content-collect-interfaces (接口层)                         │
    │   │    │                                                               │
    │   │    ├──▶ svc-content-collect-application (应用层)                   │
    │   │    │    │                                                          │
    │   │    │    ├──▶ svc-content-collect-domain (领域层)                   │
    │   │    │    │    │                                                     │
    │   │    │    │    └──▶ svc-content-collect-api (API契约)                │
    │   │    │    │                                                          │
    │   │    │    └──▶ svc-content-collect-api (API契约)                     │
    │   │    │                                                               │
    │   │    └──▶ svc-content-collect-api (API契约)                          │
    │   │                                                                    │
    │   └──▶ svc-content-collect-infrastructure (基础设施层)                 │
    │        │                                                               │
    │        ├──▶ svc-content-collect-domain (领域层)                        │
    │        └──▶ svc-content-collect-api (API契约)                          │
    │                                                                        │
    │   外部依赖:                                                            │
    │   svc-content-collect-api ◀── BC-52 svc-content-engineer (Feign调用)   │
    │                                                                        │
    │   依赖原则:                                                            │
    │   ● 领域层不依赖基础设施层（依赖倒置）                                 │
    │   ● 接口层不直接依赖基础设施层                                         │
    │   ● API契约模块无Spring框架依赖，仅含纯Java对象                        │
    │                                                                        │
    └────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.1.3-1 模块依赖关系图

## 9.2 各模块包结构

### 9.2.1 svc-content-collect-api

+   API契约模块包结构如下所示

    ```
    com.clarisphere.content.collect.api
    ├── client/
    │   └── ContentCollectFeignClient.java          // Feign接口定义
    ├── dto/
    │   ├── RegulationStatusDTO.java                // RPC-RA-01 响应DTO
    │   └── RawDocumentDTO.java                     // RPC-RA-02 响应DTO
    ├── event/
    │   ├── RegulationCollectedEvent.java           // 外规采集完成事件
    │   ├── RegulationChangedEvent.java             // 外规变更通知事件
    │   └── EventTopics.java                        // Topic常量定义
    └── enums/
        ├── SourceType.java                         // 外规源类型枚举
        ├── TaskType.java                           // 任务类型枚举
        ├── TaskStatus.java                         // 采集任务状态枚举
        ├── MonitorStatus.java                      // 监测任务状态枚举
        └── DocumentStatus.java                     // 文档状态枚举
    ```

    图 9.2.1-1 API契约模块包结构

### 9.2.2 svc-content-collect-interfaces

+   接口层模块包结构如下所示

    ```
    com.clarisphere.content.collect.interfaces
    ├── rest/
    │   ├── SourceController.java                   // P-RA-01~P-RA-08 外规源管理（P2+）
    │   ├── TaskController.java                     // P-RA-09~P-RA-17 采集任务管理
    │   ├── MonitorController.java                  // P-RA-18~P-RA-22 变更监测管理（P2+）
    │   └── DocumentParseReviewController.java      // P-RA-29~P-RA-31 文档解析审核管理（含图片管理接口）
    ├── rpc/
    │   └── ContentCollectFeignProvider.java         // Feign接口实现（RPC-RA-01/02）
    ├── job/
    │   ├── CollectJobHandler.java                  // XXL-JOB 定时采集Handler（P2+）
    │   ├── MonitorJobHandler.java                  // XXL-JOB 定时监测Handler（P2+）
    │   ├── EventPublishJobHandler.java             // XXL-JOB 事件重试发布Handler
    │   └── SnapshotCleanupJobHandler.java          // XXL-JOB 快照清理Handler（P2+）
    ├── consumer/
    │   └── (无，BC-51仅发布事件不消费外部事件)
    ├── assembler/
    │   ├── SourceAssembler.java                    // 外规源 请求↔Command/DTO 转换（P2+）
    │   ├── TaskAssembler.java                      // 采集任务 请求↔Command/DTO 转换
    │   ├── MonitorAssembler.java                   // 监测任务 请求↔DTO 转换（P2+）
    │   └── ReviewAssembler.java                    // 文档审核 请求↔Command/DTO 转换
    └── vo/
        ├── request/
        │   ├── CreateSourceRequest.java            // P-RA-01 请求体（P2+）
        │   ├── UpdateSourceRequest.java            // P-RA-02 请求体（P2+）
        │   ├── CreateManualTaskRequest.java        // P-RA-09 请求体
        │   ├── TriggerCollectRequest.java          // P-RA-10 请求体（P2+）
        │   ├── ApproveWithCorrectionRequest.java   // P-RA-31 请求体（兼容，改为发布确认）
        │   ├── SubmitMdCorrectionRequest.java      // 提交MD校正请求体
        │   └── SubmitJsonVerificationRequest.java   // 提交JSON校验请求体
        └── response/
            ├── SourceDetailResponse.java           // P-RA-06 响应体（P2+）
            ├── SourceListItemResponse.java         // P-RA-07 列表项（P2+）
            ├── TaskDetailResponse.java             // P-RA-13 响应体
            ├── TaskListItemResponse.java           // P-RA-14 列表项
            ├── TaskStatisticsResponse.java         // P-RA-15 响应体（P2+）
            ├── ConnectivityResultResponse.java     // P-RA-08 响应体（P2+）
            ├── MonitorTaskListItemResponse.java    // P-RA-18 列表项（P2+）
            ├── ChangeDiffDetailResponse.java       // P-RA-21 响应体（P2+）
            ├── ReviewListItemResponse.java         // P-RA-29 列表项（改为DocumentListItemResponse）
            └── ReviewDetailResponse.java           // P-RA-30 响应体（改为DocumentParseReviewDetailResponse）
    ```

    图 9.2.2-1 接口层模块包结构

### 9.2.3 svc-content-collect-application

+   应用层模块包结构如下所示

    ```
    com.clarisphere.content.collect.application
    ├── service/
    │   ├── RegulationSourceAppService.java         // 外规源应用服务（P2+）
    │   ├── CollectionTaskAppService.java           // 采集任务应用服务
    │   ├── ChangeMonitorAppService.java            // 变更监测应用服务（P2+）
    │   └── DocumentParseReviewAppService.java      // 文档解析审核应用服务（含六阶段人工交互）
    ├── command/
    │   ├── CreateSourceCommand.java                // P2+
    │   ├── UpdateSourceCommand.java                // P2+
    │   ├── EnableSourceCommand.java                // P2+
    │   ├── DisableSourceCommand.java               // P2+
    │   ├── ArchiveSourceCommand.java               // P2+
    │   ├── TestConnectivityCommand.java            // P2+
    │   ├── ExecuteCollectCommand.java              // P2+
    │   ├── CreateManualTaskCommand.java
    │   ├── TriggerManualCollectCommand.java        // P2+
    │   ├── RetryTaskCommand.java
    │   ├── CancelTaskCommand.java
    │   ├── UpdateRegulationMetaCommand.java
    │   ├── SubmitMdCorrectionCommand.java          // 提交MD校正和图片变更
    │   ├── SubmitJsonVerificationCommand.java      // 提交JSON校验和图片变更
    │   ├── ConfirmPublishCommand.java              // 正式发布确认
    │   ├── UploadImageCommand.java                 // 上传新图片
    │   ├── ReplaceImageCommand.java                // 替换已有图片
    │   ├── RemoveImageRefCommand.java              // 删除图片关联
    │   ├── RollbackToMdReadyCommand.java            // 回退至MD编辑阶段
    │   ├── ExecuteMonitorCommand.java              // P2+
    │   └── RetryMonitorCommand.java                // P2+
    ├── query/
    │   ├── SourceDetailQuery.java                  // P2+
    │   ├── SourceListQuery.java                    // P2+
    │   ├── TaskDetailQuery.java
    │   ├── TaskListQuery.java
    │   ├── TaskStatisticsQuery.java                // P2+
    │   ├── TaskExportQuery.java                    // P2+
    │   ├── MonitorTaskDetailQuery.java             // P2+
    │   ├── MonitorTaskListQuery.java               // P2+
    │   ├── ChangeDiffDetailQuery.java              // P2+
    │   ├── ChangeDiffListQuery.java                // P2+
    │   ├── DocumentListQuery.java                  // 文档列表查询（按状态筛选）
    │   └── DocumentDetailQuery.java                // 文档详情查询（MD比对/JSON校验）
    ├── dto/
    │   ├── SourceDetailDTO.java                    // P2+
    │   ├── SourceListItemDTO.java                  // P2+
    │   ├── TaskDetailDTO.java
    │   ├── TaskListItemDTO.java
    │   ├── TaskStatisticsDTO.java                  // P2+
    │   ├── ConnectivityResultDTO.java              // P2+
    │   ├── MonitorTaskDetailDTO.java               // P2+
    │   ├── MonitorTaskListItemDTO.java             // P2+
    │   ├── ChangeDiffDetailDTO.java                // P2+
    │   ├── DocumentListItemDTO.java                // 文档列表项（含状态、图片数量）
    │   └── DocumentParseReviewDetailDTO.java       // 文档详情（含MD/JSON内容、图片列表）
    └── event/
        └── DomainEventPublisher.java               // 领域事件发布协调器
    ```

    图 9.2.3-1 应用层模块包结构

### 9.2.4 svc-content-collect-domain

+   领域层模块包结构如下所示

    ```
    com.clarisphere.content.collect.domain
    ├── source/                                      // AGG-01 外规源聚合（P2+）
    │   ├── RegulationSource.java                   // 聚合根
    │   ├── SourceType.java                         // 枚举值对象（复用api模块）
    │   ├── Url.java                                // 值对象
    │   ├── SourceCredential.java                   // 值对象
    │   ├── CollectSchedule.java                    // 值对象
    │   ├── SourceStatus.java                       // 状态枚举
    │   ├── RegulationSourceRepository.java         // Repository接口
    │   └── event/
    │       ├── SourceEnabledEvent.java             // 内部事件
    │       ├── SourceDisabledEvent.java
    │       └── SourceArchivedEvent.java
    ├── task/                                        // AGG-02 采集任务聚合
    │   ├── CollectionTask.java                     // 聚合根
    │   ├── TaskType.java                           // 枚举
    │   ├── TaskStatus.java                         // 状态枚举
    │   ├── TriggerType.java                        // 枚举
    │   ├── TriggerInfo.java                        // 值对象
    │   ├── CollectResult.java                      // 值对象
    │   ├── ParseResult.java                        // 值对象
    │   ├── FailureInfo.java                        // 值对象
    │   ├── CollectionTaskRepository.java           // Repository接口
    │   └── event/
    │       └── TaskCompletedEvent.java             // 内部事件
    ├── document/                                    // AGG-03 原始文档聚合
    │   ├── RawDocument.java                        // 聚合根
    │   ├── DocumentStatus.java                     // 状态枚举（RAW/MD_READY/MD_CORRECTED/JSON_READY/PENDING_PUBLISH/APPROVED）
    │   ├── RegulationMeta.java                     // 值对象
    │   ├── FileReference.java                      // 值对象
    │   ├── StructuredContent.java                  // 值对象
    │   ├── ReviewInfo.java                         // 值对象（审核信息）
    │   ├── RawDocumentRepository.java              // Repository接口
    │   └── event/
    │       └── DocumentApprovedEvent.java          // 正式发布事件（触发RegulationCollectedEvent发布）
    ├── monitor/                                     // AGG-04 变更监测聚合（P2+）
    │   ├── ChangeMonitorTask.java                  // 聚合根
    │   ├── MonitorStatus.java                      // 状态枚举
    │   ├── ChangeSnapshot.java                     // 值对象
    │   ├── ChangeDiff.java                         // 值对象
    │   ├── DetectionInfo.java                      // 值对象
    │   ├── ChangeMonitorTaskRepository.java        // Repository接口
    │   └── event/
    │       └── RegulationChangedEvent.java         // 跨BC事件
    ├── service/                                     // 领域服务
    │   ├── DocumentParseService.java               // 解析流程领域服务（P1）
    │   ├── RegulationCollectService.java           // 采集流程领域服务（P2+）
    │   └── ChangeMonitorService.java               // 变更监测领域服务（P2+）
    ├── gateway/                                     // 防腐层接口
    │   ├── FileStorageGateway.java                 // BC-13 文件管理防腐层
    │   ├── Doc2xParseGateway.java                  // Doc2X API解析防腐层（P1）
    │   ├── NotificationGateway.java                // BC-12 消息通知防腐层（P2+）
    │   ├── HttpCrawlerGateway.java                 // HTTP爬虫防腐层（P2+）
    │   └── SchedulerGateway.java                   // XXL-JOB调度防腐层（P2+）
    └── shared/                                      // 领域层共享
        ├── DomainEvent.java                        // 领域事件基类
        ├── AggregateRoot.java                      // 聚合根基类
        └── DomainException.java                    // 领域异常基类
    ```

    图 9.2.4-1 领域层模块包结构

### 9.2.5 svc-content-collect-infrastructure

+   基础设施层模块包结构如下所示

    ```
    com.clarisphere.content.collect.infrastructure
    ├── persistence/
    │   ├── mapper/
    │   │   ├── CollectionTaskMapper.java           // MyBatis-Plus Mapper（P1）
    │   │   ├── DomainEventPublishMapper.java       // P1
    │   │   ├── RegulationSourceMapper.java         // P2+
    │   │   ├── ChangeMonitorTaskMapper.java        // P2+
    │   │   └── ChangeSnapshotMapper.java           // P2+
    │   ├── entity/
    │   │   ├── CollectionTaskDO.java               // 数据库实体（DO）（P1）
    │   │   ├── DomainEventPublishDO.java           // P1
    │   │   ├── RegulationSourceDO.java             // P2+
    │   │   ├── ChangeMonitorTaskDO.java            // P2+
    │   │   └── ChangeSnapshotDO.java               // P2+
    │   ├── converter/
    │   │   ├── TaskConverter.java                  // 聚合根 ↔ DO 转换器（P1）
    │   │   ├── DocumentConverter.java              // 聚合根 ↔ ES文档 转换器（P1）
    │   │   ├── SourceConverter.java                // P2+
    │   │   └── MonitorConverter.java               // P2+
    │   └── repository/
    │       ├── CollectionTaskRepositoryImpl.java   // Repository接口实现（P1）
    │       ├── RawDocumentRepositoryImpl.java      // P1
    │       ├── RegulationSourceRepositoryImpl.java // P2+
    │       └── ChangeMonitorTaskRepositoryImpl.java// P2+
    ├── gateway/
    │   ├── FileStorageGatewayImpl.java             // BC-13 文件管理适配器（P1）
    │   ├── NotificationGatewayImpl.java            // BC-12 消息通知适配器（P2+）
    │   ├── HttpCrawlerGatewayImpl.java             // HTTP爬虫实现（P2+）
    │   └── SchedulerGatewayImpl.java               // XXL-JOB调度适配器（P2+）
    ├── event/
    │   ├── KafkaEventPublisher.java                // Kafka事件发布实现（P1）
    │   ├── LocalEventStoreImpl.java                // 本地事件表存储实现（P1）
    │   └── EventRetryScheduler.java                // 事件重试调度器（P1）
    ├── cache/                                       // P2+
    │   ├── RedisDistributedLock.java               // Redis分布式锁工具
    │   └── SourceCacheManager.java                 // 外规源缓存管理
    ├── search/
    │   ├── RawDocumentEsRepository.java           // T-03 外规清单ES操作封装（P1）
    │   ├── StructuredContentEsRepository.java     // T-04 结构化内容ES操作封装（P1）
    │   └── EsIndexInitializer.java                 // ES索引初始化（P1）
    ├── parser/
    │   ├── Doc2xApiGateway.java                  // Doc2X外部API网关封装（P1）
    │   ├── ParseProductHandler.java              // 解压压缩包、提取MD和图片（P1）
    │   ├── MdStructuredParser.java               // MD→ContentNode段落级结构化拆分（P1）
    │   └── QualityScoreCalculator.java             // 质量评分计算器（P1）
    └── config/
        ├── MyBatisPlusConfig.java                  // MyBatis-Plus配置（P1）
        ├── KafkaConfig.java                        // Kafka配置（P1）
        ├── ElasticsearchConfig.java                // ES配置（P1）
        ├── RedisConfig.java                        // Redis配置（P2+）
        ├── OkHttpConfig.java                       // HTTP客户端配置（P2+）
        └── XxlJobConfig.java                       // XXL-JOB配置（P2+）
    ```

    图 9.2.5-1 基础设施层模块包结构

## 9.3 关键类职责说明

### 9.3.1 防腐层Gateway接口

+   领域层定义的Gateway接口与基础设施层实现的对应关系如下表所示

    | Gateway接口         | 实现类                  | 外部依赖          | 方法概述                                                                     |
    | ------------------- | ----------------------- | ----------------- | ---------------------------------------------------------------------------- |
    | FileStorageGateway  | FileStorageGatewayImpl  | BC-13 Feign客户端 | upload(bytes, meta)、download(fileId)、getPreviewUrl(fileId)                 |
    | Doc2xParseGateway   | Doc2xApiGateway         | Doc2X REST API    | uploadPdf(bytes)、pollTaskStatus(taskId)、downloadResult(taskId)             |
    | NotificationGateway | NotificationGatewayImpl | BC-12 Feign客户端 | sendChangeNotification(recipients, diff)                                     |
    | HttpCrawlerGateway  | HttpCrawlerGatewayImpl  | OkHttpClient      | fetchPage(url, headers, credential, timeout)、testConnectivity(url, timeout) |
    | SchedulerGateway    | SchedulerGatewayImpl    | XXL-JOB Admin API | registerJob(config)、pauseJob(jobId)、removeJob(jobId)                       |

    表 9.3.1-1 防腐层Gateway接口与实现

### 9.3.2 文档解析器

+   文档解析采用外部API方式，通过Doc2X API网关将PDF转为MD+图片压缩包，替代本地解析器

    | 组件类              | 职责                                                                            | 依赖                                   |
    | ------------------- | ------------------------------------------------------------------------------- | -------------------------------------- |
    | Doc2xApiGateway     | 封装Doc2X API调用（https://v2.doc2x.noedgeai.com），上传PDF、轮询任务、下载结果 | RestTemplate / WebClient               |
    | ParseProductHandler | 解压API返回的压缩包，提取MD文件和images目录中的图片，分别上传至BC-13            | BC-13文件管理SDK                       |
    | MdStructuredParser  | 将校正后的MD文件按段落级粒度拆分为ContentNode记录集合，解析标题层次和图片引用   | 自研（基于MD语法规则的结构化拆分逻辑） |

    表 9.3.2-1 文档解析组件

### 9.3.3 XXL-JOB Handler

+   BC-51注册的XXL-JOB定时任务如下表所示

    | Handler类                 | 任务名称          | 默认Cron     | 执行策略 | 说明                             | 版本 |
    | ------------------------- | ----------------- | ------------ | -------- | -------------------------------- | ---- |
    | EventPublishJobHandler    | eventRetryPublish | 0 */1* ** ?  | 单机执行 | 扫描PENDING/FAILED事件，重试发布 | P1   |
    | CollectJobHandler         | collectTask       | 按外规源配置 | 分片广播 | 遍历ENABLED外规源，逐个执行采集  | P2+  |
    | MonitorJobHandler         | monitorTask       | 按外规源配置 | 分片广播 | 遍历ENABLED外规源，逐个执行监测  | P2+  |
    | SnapshotCleanupJobHandler | snapshotCleanup   | 0 0 3 ** ?   | 单机执行 | 清理超出保留数量的变更快照       | P2+  |

    表 9.3.3-1 XXL-JOB Handler清单

### 9.3.4 事件发布机制

+   BC-51采用本地事件表（Transactional Outbox Pattern）保证事件发布的可靠性，流程如下：

    1.   **业务事务内**：聚合根操作完成后，将领域事件写入domain_event_publish表（status=PENDING），与业务数据在同一数据库事务中提交
    2.   **事务提交后**：Spring @TransactionalEventListener监听事务提交事件，尝试同步发送Kafka消息
    3.   **同步发送成功**：更新domain_event_publish表status=PUBLISHED
    4.   **同步发送失败**：不影响业务事务，事件保持PENDING状态
    5.   **定时补偿**：EventPublishJobHandler每1分钟扫描PENDING和FAILED（retry_count < max_retry）的事件，重新发送
    6.   **最终失败**：retry_count达到max_retry后标记为FAILED，触发告警，需人工介入

## 9.4 配置文件结构

### 9.4.1 application.yml 关键配置项

+   关键配置项说明如下表所示

    | 配置分组   | 配置Key                              | 默认值                              | 说明              |
    | ---------- | ------------------------------------ | ----------------------------------- | ----------------- |
    | server     | server.port                          | 8086                                | 服务端口          |
    | datasource | spring.datasource.url                | jdbc:mysql://...                    | MySQL连接地址     |
    | redis      | spring.redis.host                    | localhost                           | Redis地址         |
    | kafka      | spring.kafka.bootstrap-servers       | localhost:9092                      | Kafka集群地址     |
    | es         | spring.elasticsearch.uris            | http://localhost:9200               | ES地址            |
    | xxl-job    | xxl.job.admin.addresses              | http://localhost:8080/xxl-job-admin | XXL-JOB Admin地址 |
    | xxl-job    | xxl.job.executor.appname             | svc-content-collect                 | 执行器名称        |
    | collect    | collect.lock.timeout-minutes         | 30                                  | 采集分布式锁超时  |
    | collect    | collect.http.connect-timeout-seconds | 10                                  | HTTP连接超时      |
    | collect    | collect.http.read-timeout-seconds    | 60                                  | HTTP读取超时      |
    | collect    | collect.retry.max-count              | 3                                   | 采集最大重试次数  |
    | collect    | collect.file.max-size-mb             | 50                                  | 最大文件大小      |
    | monitor    | monitor.lock.timeout-minutes         | 10                                  | 监测分布式锁超时  |
    | event      | event.retry.max-count                | 5                                   | 事件最大重试次数  |
    | event      | event.retry.interval-seconds         | 60                                  | 事件重试间隔      |
    | encrypt    | encrypt.aes-key                      | (配置中心管理)                      | AES-256加密密钥   |

    表 9.4.1-1 关键配置项

### 9.4.2 多环境配置

+   多环境配置文件说明如下表所示

    | 环境     | Profile | 配置文件                         | 说明                    |
    | -------- | ------- | -------------------------------- | ----------------------- |
    | 本地开发 | local   | application-local.yml            | 本地MySQL/Redis/Kafka   |
    | 开发联调 | dev     | application-dev.yml              | 开发环境配置            |
    | 测试环境 | test    | application-test.yml             | 测试环境配置            |
    | 预发布   | staging | application-staging.yml          | 预发布环境配置          |
    | 生产     | prod    | application-prod.yml（配置中心） | 敏感配置走Nacos配置中心 |

    表 9.4.2-1 多环境配置

## 9.5 构建与部署

### 9.5.1 Maven构建

+   Maven模块继承关系：

    ```
    svc-content-collect (pom, 父POM)
    ├── svc-content-collect-api          (jar)
    ├── svc-content-collect-domain       (jar)
    ├── svc-content-collect-application  (jar)
    ├── svc-content-collect-interfaces   (jar)
    ├── svc-content-collect-infrastructure (jar)
    └── svc-content-collect-app          (spring-boot jar, 可执行)
    ```

+   构建命令：`mvn clean package -pl svc-content-collect-app -am`

### 9.5.2 Docker部署

+   Dockerfile关键配置如下表所示

    | 配置项   | 值                                                       |
    | -------- | -------------------------------------------------------- |
    | 基础镜像 | eclipse-temurin:17-jre-alpine                            |
    | JVM参数  | -Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 |
    | 健康检查 | /actuator/health, interval=30s, timeout=5s               |
    | 暴露端口 | 8086（HTTP）、9086（管理端口）                           |
    | 日志挂载 | /app/logs → 宿主机日志目录                               |

    表 9.5.2-1 Docker部署配置

### 9.5.3 数据库迁移

+   数据库迁移采用Flyway，迁移脚本位于svc-content-collect-app模块：
+   迁移脚本写入平台库 `clarisphere_platform`，Flyway history表前缀为 `bc51_`以避免与其他BC冲突

    ```
    src/main/resources/db/migration/
    ├── V1.0.0__create_collection_task.sql        // P1
    ├── V1.0.3__create_domain_event_publish.sql   // P1
    ├── V2.0.0__create_regulation_source.sql      // P2+
    ├── V2.0.1__create_change_monitor_task.sql    // P2+
    └── V2.0.2__create_change_snapshot.sql        // P2+
    ```

+   **ES索引初始化**：T-03（idx_raw_document）和T-04（idx_structured_content）为ES索引，不通过Flyway管理。索引Mapping由 `EsIndexInitializer.java` 在服务启动时自动创建或更新，通过索引别名（alias）实现版本迁移（详见7.10节）

# 10 权限设计

## 10.1 权限模型概述

+   BC-51权限设计基于BC-10用户管理子领域提供的RBAC权限模型
+   权限粒度：资源级权限码，格式为四段式 `{用户侧}:{限界上下文}:{资源}:{操作}`
+   BC-51属于供给侧后台，用户侧固定为 `provider`，限界上下文为 `content`
+   权限码格式：`provider:content:{resource}:{action}`
+   权限校验方式：应用服务入口处通过注解 `@RequirePermission` 校验，由BC-10 SDK拦截实现
+   数据权限：BC-51 P1阶段无多租户数据隔离需求（供给侧后台仅平台运营人员使用），暂不设计行级数据权限

## 10.2 权限码清单

+   BC-51权限码清单如下表所示

    | 权限码                           | 说明                     | 关联接口                                                      | 版本 |
    | -------------------------------- | ------------------------ | ------------------------------------------------------------- | ---- |
    | provider:content:task:create     | 创建采集任务             | P-RA-09                                                       | P1   |
    | provider:content:task:read       | 查看采集任务             | P-RA-13, P-RA-14                                              | P1   |
    | provider:content:task:manage     | 管理采集任务             | P-RA-11, P-RA-12                                              | P1   |
    | provider:content:document:update | 更新外规元数据           | P-RA-17                                                       | P1   |
    | provider:content:review:read     | 查看文档处理列表及详情   | P-RA-29, P-RA-30                                              | P1   |
    | provider:content:review:manage   | 文档校正、发布与图片管理 | P-RA-31, P-RA-32, P-RA-33, P-RA-34, P-RA-35, P-RA-36, P-RA-37 | P1   |
    | provider:content:source:create   | 创建外规源               | P-RA-01                                                       | P2+  |
    | provider:content:source:update   | 更新外规源               | P-RA-02                                                       | P2+  |
    | provider:content:source:read     | 查看外规源               | P-RA-06, P-RA-07                                              | P2+  |
    | provider:content:source:manage   | 管理外规源状态           | P-RA-03, P-RA-04, P-RA-05, P-RA-08                            | P2+  |
    | provider:content:task:export     | 导出采集报告             | P-RA-16                                                       | P2+  |
    | provider:content:monitor:read    | 查看变更监测             | P-RA-18, P-RA-19, P-RA-20, P-RA-21                            | P2+  |
    | provider:content:monitor:manage  | 管理变更监测             | P-RA-22                                                       | P2+  |

    表 10.2-1 权限码清单

## 10.3 角色权限映射

+   BC-51角色与权限的映射关系如下表所示

    | 角色编号 | 角色名称       | 角色说明              | P1拥有权限码                                                                                                                                                                           |
    | -------- | -------------- | --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | ROLE-01  | 外规采集管理员 | 拥有BC-51全部操作权限 | provider:content:task:*, provider:content:document:*, provider:content:review:*（P2+追加provider:content:source:*, provider:content:monitor:*）                                        |
    | ROLE-02  | 外规采集员     | 日常采集和审核操作    | provider:content:task:create, provider:content:task:read, provider:content:task:manage, provider:content:document:update, provider:content:review:read, provider:content:review:manage |
    | ROLE-03  | 外规采集只读   | 仅查看权限            | provider:content:task:read, provider:content:review:read                                                                                                                               |

    表 10.3-1 角色权限映射

+   **角色与UP角色对应关系**：
    -   ROLE-01 外规采集管理员 → UP-01 外规采集员（高级）
    -   ROLE-02 外规采集员 → UP-01 外规采集员（普通）
    -   ROLE-03 外规采集只读 → 运营管理人员（查看用）

## 10.4 接口权限矩阵

+   BC-51 P1接口与角色的权限矩阵如下表所示

    | 接口编号 | 接口名称         | 外规采集管理员 | 外规采集员 | 外规采集只读 |
    | -------- | ---------------- | -------------- | ---------- | ------------ |
    | P-RA-09  | 人工录入         | ✓              | ✓          | ✗            |
    | P-RA-11  | 重试失败任务     | ✓              | ✓          | ✗            |
    | P-RA-12  | 取消任务         | ✓              | ✓          | ✗            |
    | P-RA-13  | 查询任务详情     | ✓              | ✓          | ✓            |
    | P-RA-14  | 查询任务列表     | ✓              | ✓          | ✓            |
    | P-RA-17  | 更新外规元数据   | ✓              | ✓          | ✗            |
    | P-RA-29  | 查询文档处理列表 | ✓              | ✓          | ✓            |
    | P-RA-30  | 查询文档处理详情 | ✓              | ✓          | ✓            |
    | P-RA-31  | 正式发布确认     | ✓              | ✓          | ✗            |
    | P-RA-32  | 提交MD校正       | ✓              | ✓          | ✗            |
    | P-RA-33  | 提交JSON校验     | ✓              | ✓          | ✗            |
    | P-RA-34  | 回退至MD编辑     | ✓              | ✓          | ✗            |
    | P-RA-35  | 上传图片         | ✓              | ✓          | ✗            |
    | P-RA-36  | 替换图片         | ✓              | ✓          | ✗            |
    | P-RA-37  | 删除图片关联     | ✓              | ✓          | ✗            |

    表 10.4-1 P1接口权限矩阵

+   P2+接口权限矩阵待P2启动时补充

+   **数据隔离说明**：P1阶段ROLE-02（外规采集员）拥有task:manage权限，可重试和取消采集任务。当前P1无多租户数据隔离需求，所有采集员可操作所有任务。后续如需限制"仅操作自己创建的任务"，可通过BC-10 SDK的行级数据权限实现（createdBy = 当前用户ID）。

## 10.5 权限校验实现

+   权限校验在各层的实现方式如下表所示

    | 校验层级 | 校验方式                                                                  | 说明                               |
    | -------- | ------------------------------------------------------------------------- | ---------------------------------- |
    | 网关层   | BFF Gateway统一校验JWT Token有效性                                        | 仅校验登录态，不校验细粒度权限     |
    | 接口层   | Controller方法注解 `@RequirePermission("provider:content:source:create")` | 声明式权限校验，四段式权限码       |
    | 应用层   | 应用服务方法内按需调用BC-10 SDK校验数据权限                               | P1阶段暂不实现数据权限             |
    | 领域层   | 不做权限校验（领域纯净性）                                                | 权限属于横切关注点，不侵入领域逻辑 |

    表 10.5-1 权限校验实现

# 附录A 错误码表

## 附录A.0 说明

+   错误码表全局定义本BC的所有错误码，避免分散在各API中
+   错误码采用统一编号规则，便于前端统一处理和国际化
+   各API通过"关联错误码"字段引用本节定义的错误码编号

### A.0.1 设计原则

+   错误码设计应遵循以下原则：

    | 原则     | 说明                                         |
    | -------- | -------------------------------------------- |
    | 唯一性   | 每个错误码全局唯一，跨BC不重复（可加BC前缀） |
    | 自解释性 | 错误信息能让用户理解问题，避免技术术语       |
    | 可追溯性 | 错误码能关联到具体的业务规则或校验逻辑       |
    | 可国际化 | 错误信息支持i18n，错误码作为消息Key          |
    | 安全性   | 不暴露敏感信息（如SQL、堆栈、内部路径）      |

    表 A.0.1-1 错误码设计原则

### A.0.2 错误码命名规范

+   错误码采用"E-"前缀加6位数字：`E-XXXYYY`
    -   E-：错误码前缀，便于识别
    -   XXX：HTTP状态码（400、401、403、404、409、422、429、500、503）
    -   YYY：业务错误序号（000-999）

### A.0.3 错误码分段规划

+   错误码按HTTP状态码和业务类型分段，便于管理和扩展

    | 错误码范围        | HTTP状态码 | 错误类型         | 说明                                      |
    | ----------------- | ---------- | ---------------- | ----------------------------------------- |
    | E-400001~E-400099 | 400        | 通用参数校验错误 | BC-10统一定义，缺失、格式、长度等通用校验 |
    | E-400100~E-400199 | 400        | 外规采集参数错误 | BC-51参数校验（如文件格式、URL格式）      |
    | E-404001~E-404099 | 404        | 通用资源不存在   | BC-10统一定义                             |
    | E-404002~E-404099 | 404        | 外规采集资源错误 | BC-51资源不存在（任务、文档、外规源等）   |
    | E-409001~E-409099 | 409        | 通用冲突错误     | BC-10统一定义（含乐观锁）                 |
    | E-422001~E-422099 | 422        | 外规采集业务错误 | BC-51业务逻辑不允许                       |
    | E-500001~E-500099 | 500        | 通用系统错误     | BC-10统一定义                             |
    | E-500500~E-500599 | 500        | 外规采集系统错误 | BC-51内部错误、依赖服务故障               |

    表 A.0.3-1 BC-51错误码分段规划

+   **分段分配原则**：
    -   BC-10通用错误码：E-400001~E-400099、E-404001、E-409001、E-500001等，BC-51直接复用
    -   BC-51自定义错误码：参数校验类使用E-400100~E-400199，资源不存在类使用E-404002~E-404099，业务逻辑类使用E-422001~E-422099，系统错误类使用E-500500~E-500599
    -   新增业务场景需要新错误码时，按A.0.5节规范申请并更新本附录

+   错误码与API契约表关联说明

    +   错误码管理遵循以下原则：
        -   **全局统一定义**：所有错误码在本附录中集中定义，各接口设计章节不再重复维护错误码表
        -   **契约表引用**：各API契约概述表通过"关联错误码"字段引用本附录中的错误码编号
        -   **扩展规范**：新增业务场景需要新错误码时，按A.0.5节规范申请并更新本附录

    +   **API契约概述表示例**：

        | 属性           | 值                                         |
        | -------------- | ------------------------------------------ |
        | API编号        | P-RA-09                                    |
        | 接口路径       | POST /api/v1/provider/tasks/manual         |
        | 功能简述       | 人工录入创建采集任务                       |
        | 所需权限       | provider:content:task:create               |
        | 关联功能       | FL-RA-03 人工录入流程                      |
        | 关联领域       | CollectionTask.createManual()              |
        | 关联规则       | RD-R-01, RD-R-04                           |
        | 幂等性         | 否（每次创建新任务）                       |
        | **关联错误码** | **E-400001, E-400102, E-404002, E-500500** |

        表 A.0.3.1-1 API契约概述表示例

    +   **开发人员使用指南**：
        1.   设计新接口时，先查阅本附录确定可复用的错误码
        2.   在API契约概述表的"关联错误码"字段列出所有可能返回的错误码
        3.   如需新增错误码，按A.0.5节流程申请
        4.   前端开发人员根据契约表中的关联错误码实现对应的错误处理逻辑

### A.0.4 通用错误码引用

+   以下通用错误码由BC-10统一定义，BC-51直接复用，不再重复定义
+   BC-51引用的通用错误码如下表所示

    | 错误码   | HTTP状态码 | 错误名称            | BC-51引用场景              |
    | -------- | ---------- | ------------------- | -------------------------- |
    | E-400001 | 400        | PARAM_INVALID       | 请求参数不满足@Valid约束   |
    | E-400010 | 400        | FILE_TYPE_INVALID   | 上传文件格式不支持         |
    | E-400011 | 400        | FILE_SIZE_EXCEEDED  | 上传文件大小超限           |
    | E-400014 | 400        | PAGE_PARAM_INVALID  | 分页参数无效               |
    | E-401001 | 401        | NOT_LOGGED_IN       | 未登录                     |
    | E-401002 | 401        | TOKEN_EXPIRED       | Token已过期                |
    | E-403001 | 403        | PERMISSION_DENIED   | 无操作权限                 |
    | E-404001 | 404        | RESOURCE_NOT_FOUND  | 通用资源不存在             |
    | E-409001 | 409        | OPTIMISTIC_LOCK     | 数据已被修改（乐观锁冲突） |
    | E-429001 | 429        | RATE_LIMIT_EXCEEDED | 请求过于频繁               |
    | E-500001 | 500        | INTERNAL_ERROR      | 系统内部错误               |

    表 A.0.4-1 BC-51引用的通用错误码

### A.0.5 自定义错误码扩展规范

+   当通用错误码无法覆盖业务场景时，按以下规范自定义

+   **何时需要自定义**

    | 场景                       | 是否自定义 | 说明                   |
    | -------------------------- | ---------- | ---------------------- |
    | 现有错误码完全匹配         | 否         | 直接复用               |
    | 错误信息需要调整           | 否         | 通过参数化消息定制     |
    | 新业务规则的校验失败       | 是         | 需要新增业务错误码     |
    | 前端需要区分处理的细分场景 | 是         | 同类错误需不同UI处理时 |

    表 A.0.5-1 自定义错误码判断标准

+   **自定义流程**

    | 步骤 | 操作                     | 责任人   |
    | ---- | ------------------------ | -------- |
    | 1    | 确认无法复用现有错误码   | 开发人员 |
    | 2    | 在模块对应的分段申请编号 | 开发人员 |
    | 3    | 更新错误码表并提交评审   | 开发人员 |
    | 4    | 架构师/Tech Lead评审     | 架构师   |
    | 5    | 通知前端同步更新         | 开发人员 |

    表 A.0.5-2 自定义错误码流程

+   **HTTP状态码选择指南**

    | HTTP状态码 | 适用场景                         | 示例                       |
    | ---------- | -------------------------------- | -------------------------- |
    | 400        | 请求格式错误、参数缺失、格式不对 | 必填字段为空、邮箱格式错误 |
    | 422        | 请求格式正确，但业务逻辑不允许   | 余额不足、状态不允许操作   |
    | 409        | 资源冲突、并发冲突               | 编码重复、乐观锁冲突       |

    表 A.0.5-3 HTTP状态码选择指南

+   **错误码命名规范**

    | 规则   | 说明                                   | 示例                         |
    | ------ | -------------------------------------- | ---------------------------- |
    | 前缀   | 统一使用"E-"前缀                       | E-400500                     |
    | HTTP段 | 第1-3位对应HTTP状态码                  | 400、401、403、404、409、422 |
    | 序号段 | 第4-6位为业务序号，按A.0.3分段规划分配 | 500~599（BC-51段）           |
    | 名称   | 全大写，下划线分隔，语义清晰           | FILE_FORMAT_UNSUPPORTED      |

    表 A.0.5-4 错误码命名规范

+   **与API契约表集成要点**：
    -   新增错误码后，必须更新所有引用该错误码的API契约概述表
    -   API契约概述表的"关联错误码"字段应列出所有可能返回的错误码，不遗漏
    -   建议建立错误码与API的双向追溯索引

### A.0.6 错误响应格式规范

+   错误响应统一格式如下：

    ```json
    {
      "code": 400500,
      "message": "不支持的文件格式",
      "data": {
        "field": "file",
        "value": "document.xlsx",
        "suggestion": "请上传PDF、Word或HTML格式的文件"
      },
      "timestamp": 1706000000000,
      "traceId": "trace-xxx-001"
    }
    ```

+   **响应字段说明**

    | 字段      | 类型   | 必有 | 说明                                                                                            |
    | --------- | ------ | ---- | ----------------------------------------------------------------------------------------------- |
    | code      | Number | 是   | 错误码（去掉E-前缀的数字部分），前端使用 `E-${code}` 作为 i18n 资源 key                         |
    | message   | String | 是   | 用户友好的错误信息                                                                              |
    | data      | Object | 否   | 错误详情，帮助定位问题                                                                          |
    | timestamp | Number | 是   | 错误发生时间戳                                                                                  |
    | traceId   | String | 是   | 分布式链路追踪ID，由网关或APM框架生成，格式为UUID或32位十六进制字符串，跨服务传递，便于排查问题 |

    表 A.0.6-1 错误响应字段说明

+   **data字段可选内容**

    | 字段           | 类型   | 说明                       |
    | -------------- | ------ | -------------------------- |
    | field          | String | 出错的字段名               |
    | value          | Any    | 出错的字段值               |
    | suggestion     | String | 建议的解决方案             |
    | details        | Array  | 多字段校验错误时的详情列表 |
    | allowedValues  | Array  | 允许的枚举值列表           |
    | min / max      | Number | 允许的最小/最大值          |
    | retryAfter     | Number | 限流时建议的重试等待秒数   |
    | currentVersion | Number | 乐观锁冲突时的当前版本     |

    表 A.0.6-2 data字段可选内容

### A.0.7 前端错误处理指南

+   **HTTP状态码处理策略**

    | HTTP状态码 | 处理策略                          |
    | ---------- | --------------------------------- |
    | 400        | 显示错误信息，高亮出错字段        |
    | 401        | 跳转登录页（可尝试刷新Token）     |
    | 403        | 显示无权限提示，隐藏/禁用操作按钮 |
    | 404        | 显示资源不存在提示，返回列表页    |
    | 409        | 显示冲突提示，引导刷新页面        |
    | 422        | 显示业务错误信息，引导用户修正    |
    | 429        | 显示限流提示和倒计时              |
    | 500/503    | 显示"系统繁忙"提示，提供重试按钮  |

    表 A.0.7-1 HTTP状态码处理策略

### A.0.8 错误码国际化

+   错误码支持国际化（i18n），错误信息从资源文件读取

+   **资源文件示例**

    ```properties
    # error_messages.properties (中文)
    E-400001=参数校验失败
    E-400500=不支持的文件格式
    E-422500=当前状态不允许执行此操作

    # error_messages_en.properties (英文)
    E-400001=Parameter validation failed
    E-400500=Unsupported file format
    E-422500=Operation not allowed in current state
    ```

## 附录A.1 错误码枚举名称映射

+   本节提供BC-51自定义错误码与Java枚举名称的映射关系，方便开发人员编码时引用
+   所有错误码的完整定义（含触发场景、建议处理）见A.2节错误码清单
+   BC-10通用错误码（E-400001、E-409001、E-500001等）由平台统一定义，BC-51直接复用

### A.1.1 P1 错误码枚举映射

+   P1阶段使用的BC-51自定义错误码枚举映射如下表所示

    | 错误码   | Java枚举名称              | 错误描述                  |
    | -------- | ------------------------- | ------------------------- |
    | E-400102 | FILE_FORMAT_UNSUPPORTED   | 不支持的文件格式          |
    | E-404002 | FILE_NOT_FOUND            | 文件不存在或已被删除      |
    | E-404003 | COLLECTION_TASK_NOT_FOUND | 采集任务不存在            |
    | E-404004 | RAW_DOCUMENT_NOT_FOUND    | 原始文档不存在            |
    | E-422007 | TASK_RETRY_NOT_ALLOWED    | 仅FAILED状态的任务可重试  |
    | E-422008 | TASK_CANCEL_NOT_ALLOWED   | 仅PENDING状态的任务可取消 |
    | E-422011 | REVIEW_STATUS_NOT_ALLOWED | 当前状态不允许审核操作    |
    | E-500500 | FILE_SERVICE_FAILED       | 文件服务调用失败          |
    | E-500501 | EVENT_PUBLISH_FAILED      | 领域事件发布失败          |

    表 A.1.1-1 P1错误码枚举映射

### A.1.2 P2+ 错误码枚举映射

+   P2+阶段新增的BC-51自定义错误码枚举映射如下表所示

    | 错误码   | Java枚举名称                | 错误描述                       |
    | -------- | --------------------------- | ------------------------------ |
    | E-400101 | SOURCE_URL_INVALID          | URL格式不合法                  |
    | E-400104 | CRON_EXPRESSION_INVALID     | Cron表达式格式不合法           |
    | E-400105 | COLLECT_FREQUENCY_EXCEEDED  | 采集频率超出允许范围           |
    | E-404001 | REGULATION_SOURCE_NOT_FOUND | 外规源不存在                   |
    | E-404005 | MONITOR_TASK_NOT_FOUND      | 监测任务不存在                 |
    | E-404006 | CHANGE_DIFF_NOT_FOUND       | 变更差异报告不存在             |
    | E-409002 | SOURCE_NAME_DUPLICATE       | 外规源名称已存在               |
    | E-422001 | CONNECTIVITY_TEST_FAILED    | 外规源连通性测试失败           |
    | E-422002 | STATUS_TRANSITION_INVALID   | 当前状态不允许执行此操作       |
    | E-422003 | SOURCE_HAS_RUNNING_TASKS    | 存在运行中的采集任务，无法停用 |
    | E-422004 | SOURCE_HAS_PENDING_TASKS    | 存在未完成的采集任务，无法归档 |
    | E-422005 | CONNECTIVITY_TEST_TIMEOUT   | 连通性测试超时                 |
    | E-422006 | SOURCE_NOT_ENABLED          | 外规源未启用，无法执行采集     |
    | E-422009 | EXPORT_SIZE_EXCEEDED        | 导出数据量超过10万条上限       |
    | E-422010 | MONITOR_RETRY_NOT_ALLOWED   | 仅FAILED状态的监测任务可重试   |
    | E-500502 | COLLECT_TASK_TIMEOUT        | 采集任务执行超时               |
    | E-500503 | MONITOR_TASK_TIMEOUT        | 变更监测执行超时               |
    | E-500504 | SCHEDULER_REGISTER_FAILED   | 调度任务注册失败               |

    表 A.1.2-1 P2+错误码枚举映射

## A.2 错误码清单

+   BC-51完整错误码清单如下表所示

    | 错误码   | HTTP状态码 | 错误信息                       | 触发场景                                      | 建议处理                     | 版本 |
    | -------- | ---------- | ------------------------------ | --------------------------------------------- | ---------------------------- | ---- |
    | E-400001 | 400        | 参数校验失败                   | 请求参数不满足@Valid约束                      | 检查请求参数                 | P1   |
    | E-400102 | 400        | 不支持的文件格式               | 上传文件非PDF（P1仅支持PDF，P2+扩展其他格式） | 转换为PDF格式后重新上传      | P1   |
    | E-404002 | 404        | 文件不存在或已被删除           | fileId在BC-13中不存在                         | 重新上传文件                 | P1   |
    | E-404003 | 404        | 采集任务不存在                 | taskId对应的采集任务记录不存在                | 检查任务ID                   | P1   |
    | E-404004 | 404        | 原始文档不存在                 | documentId对应的文档记录不存在                | 检查文档ID                   | P1   |
    | E-409001 | 409        | 数据已被其他用户修改           | 乐观锁冲突（version不匹配）                   | 刷新页面后重试               | P1   |
    | E-422002 | 422        | 当前状态不允许执行此操作       | 外规源状态机转换不合法                        | 检查当前状态是否满足前置条件 | P2+  |
    | E-422007 | 422        | 仅FAILED状态的任务可重试       | 对非FAILED状态的采集任务调用重试              | 仅对失败任务执行重试         | P1   |
    | E-422008 | 422        | 仅PENDING状态的任务可取消      | 对非PENDING状态的采集任务调用取消             | 仅对待执行任务执行取消       | P1   |
    | E-422011 | 422        | 文档状态不允许此操作           | 对不符合当前操作要求状态的文档执行操作        | 检查文档状态                 | P1   |
    | E-500500 | 500        | 文件服务调用失败               | BC-13文件管理服务不可用                       | 检查BC-13服务状态            | P1   |
    | E-500501 | 500        | 领域事件发布失败               | Kafka不可用（已写入本地事件表，异步重试）     | 系统自动重试，无需人工干预   | P1   |
    | E-400101 | 400        | URL格式不合法                  | sourceUrl非合法HTTP/HTTPS URL                 | 修正URL格式                  | P2+  |
    | E-400104 | 400        | Cron表达式格式不合法           | 采集/监测Cron表达式无法解析                   | 修正Cron表达式               | P2+  |
    | E-400105 | 400        | 采集频率超出允许范围           | 采集频率高于每小时或低于每月                  | 调整采集频率                 | P2+  |
    | E-404001 | 404        | 外规源不存在                   | sourceId对应的外规源记录不存在                | 检查外规源ID                 | P2+  |
    | E-404005 | 404        | 监测任务不存在                 | monitorTaskId对应的监测任务不存在             | 检查监测任务ID               | P2+  |
    | E-404006 | 404        | 变更差异报告不存在             | 请求的监测任务无变更差异数据                  | 确认该任务已检测到变更       | P2+  |
    | E-422001 | 422        | 外规源连通性测试失败           | HTTP HEAD请求超时或返回非2xx                  | 检查URL和网络连通性          | P2+  |
    | E-422003 | 422        | 存在运行中的采集任务，无法停用 | 停用外规源时有RUNNING状态的采集任务           | 等待采集完成后再停用         | P2+  |
    | E-422004 | 422        | 存在未完成的采集任务，无法归档 | 归档外规源时有未完成的采集任务                | 完成或取消所有任务后再归档   | P2+  |
    | E-422005 | 422        | 连通性测试超时                 | 独立测试连通性操作超时（10秒）                | 检查URL和目标服务器状态      | P2+  |
    | E-422006 | 422        | 外规源未启用，无法执行采集     | 手动触发采集时外规源非ENABLED状态             | 先启用外规源                 | P2+  |
    | E-422009 | 422        | 导出数据量超过10万条上限       | 导出采集报告时筛选结果超10万条                | 缩小筛选范围后重新导出       | P2+  |
    | E-422010 | 422        | 仅FAILED状态的监测任务可重试   | 对非FAILED状态的监测任务调用重试              | 仅对失败任务执行重试         | P2+  |
    | E-500502 | 500        | 采集任务执行超时               | 采集任务执行超过30分钟                        | 系统自动标记FAILED，可重试   | P2+  |
    | E-500503 | 500        | 变更监测执行超时               | 监测任务执行超过10分钟                        | 系统自动标记FAILED，可重试   | P2+  |
    | E-500504 | 500        | 调度任务注册失败               | XXL-JOB Admin不可用或注册异常                 | 检查XXL-JOB服务状态          | P2+  |

    表 A.2-1 错误码清单

# 附录B 业务规则索引

+   BC-51全部业务规则的快速索引如下表所示

    | 规则编号 | 规则名称             | 所属聚合 | 定义章节 | 版本 |
    | -------- | -------------------- | -------- | -------- | ---- |
    | CT-R-02  | 任务创建规则         | AGG-02   | 4.3.1    | P1   |
    | CT-R-05  | 文件上传规则         | AGG-02   | 4.3.1    | P1   |
    | CT-R-06  | 人工录入任务创建规则 | AGG-02   | 4.3.1    | P1   |
    | CT-R-08  | 重试规则             | AGG-02   | 4.3.1    | P1   |
    | CT-R-09  | 取消规则             | AGG-02   | 4.3.1    | P1   |
    | CT-R-10  | 状态转换合法性       | AGG-02   | 4.3.1    | P1   |
    | RD-R-01  | 支持文件格式         | AGG-03   | 4.4.1    | P1   |
    | RD-R-02  | 外部API解析          | AGG-03   | 4.4.1    | P1   |
    | RD-R-03  | 结构化内容存储       | AGG-03   | 4.4.1    | P1   |
    | RD-R-04  | 外规元数据完整性     | AGG-03   | 4.4.1    | P1   |
    | RD-R-05  | 结构化提取规则       | AGG-03   | 4.4.1    | P1   |
    | RD-R-06  | 质量评分规则         | AGG-03   | 4.4.1    | P1   |
    | RD-R-07  | 审核校正规则         | AGG-03   | 4.4.1    | P1   |
    | RD-R-08  | 附件排序规则         | AGG-03   | 4.4.1    | P1   |
    | RD-R-09  | 版本链一致性         | AGG-03   | 4.4.1    | P1   |
    | RD-R-10  | Doc2X API调用规则    | AGG-03   | 4.4.1    | P1   |
    | RD-R-11  | 解析产物留存规则     | AGG-03   | 4.4.1    | P1   |
    | RD-R-12  | 人工比对校正规则     | AGG-03   | 4.4.1    | P1   |
    | RD-R-13  | JSON校验规则         | AGG-03   | 4.4.1    | P1   |
    | RD-R-14  | 图片管理规则         | AGG-03   | 4.4.1    | P1   |
    | RS-R-01  | 外规源创建校验       | AGG-01   | 4.2.1    | P2+  |
    | RS-R-02  | 外规源启用前置条件   | AGG-01   | 4.2.1    | P2+  |
    | RS-R-03  | URL格式校验          | AGG-01   | 4.2.1    | P2+  |
    | RS-R-04  | 名称唯一性校验       | AGG-01   | 4.2.1    | P2+  |
    | RS-R-05  | 连通性测试规则       | AGG-01   | 4.2.1    | P2+  |
    | RS-R-06  | 停用前置条件         | AGG-01   | 4.2.1    | P2+  |
    | RS-R-07  | 归档前置条件         | AGG-01   | 4.2.1    | P2+  |
    | RS-R-08  | 采集频率限制         | AGG-01   | 4.2.1    | P2+  |
    | RS-R-09  | 凭证加密存储         | AGG-01   | 4.2.1    | P2+  |
    | CT-R-01  | 定时任务注册规则     | AGG-02   | 4.3.1    | P2+  |
    | CT-R-03  | 并发控制规则         | AGG-02   | 4.3.1    | P2+  |
    | CT-R-04  | HTTP采集规则         | AGG-02   | 4.3.1    | P2+  |
    | CT-R-07  | 手动创建任务规则     | AGG-02   | 4.3.1    | P2+  |
    | CM-R-01  | 监测触发条件         | AGG-04   | 4.5.1    | P2+  |
    | CM-R-02  | 页面获取规则         | AGG-04   | 4.5.1    | P2+  |
    | CM-R-03  | 哈希对比规则         | AGG-04   | 4.5.1    | P2+  |
    | CM-R-04  | 变更快照规则         | AGG-04   | 4.5.1    | P2+  |
    | CM-R-05  | 差异生成规则         | AGG-04   | 4.5.1    | P2+  |
    | CM-R-06  | 通知规则             | AGG-04   | 4.5.1    | P2+  |

    表 B-1 业务规则索引

# 附录C 版本规划追溯矩阵

+   BC-51各设计元素与版本规划的追溯矩阵如下表所示

    | 设计元素类型        | P1设计数量 | P2+新增 | 说明                                                                                                                                                                                      |
    | ------------------- | ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | 聚合                | 2          | 2       | P1: AGG-02采集任务、AGG-03原始文档；P2+: AGG-01外规源、AGG-04变更监测                                                                                                                     |
    | 实体（聚合根）      | 2          | 2       | 同上。另AGG-03含1个实体ContentNode（非聚合根）                                                                                                                                            |
    | 值对象              | 10         | 6       | P1: Task系4(TriggerInfo/CollectResult/ParseResult/FailureInfo)+Doc系6(RegulationMeta/FileReference/Attachment/VersionRecord/EquivalentIntlStandard/ReviewInfo)；P2+: Source系3+Monitor系3 |
    | 领域服务            | 1          | 2       | P1: DocumentParseService；P2+: RegulationCollectService、ChangeMonitorService                                                                                                             |
    | 领域事件            | 1          | 1       | P1: RegulationCollectedEvent；P2+: RegulationChangedEvent                                                                                                                                 |
    | 业务规则            | 20         | 17      | P1: CT-R-02/05/06/08/09/10 + RD-R-01~14；P2+: 其余                                                                                                                                        |
    | 应用服务            | 2          | 2       | P1: CollectionTaskAppService、DocumentParseReviewAppService；P2+: RegulationSourceAppService、ChangeMonitorAppService                                                                     |
    | 应用服务方法        | 17         | 14      | P1: 6+11方法（CollectionTaskAppService 6 + DocumentParseReviewAppService 11）；P2+: 其余方法                                                                                              |
    | RESTful API         | 15         | 10      | P1: P-RA-09/11/12/13/14/17/29/30/31/32/33/34/35/36/37；P2+: 其余                                                                                                                          |
    | RPC接口             | 2          | 0       | 供BC-52调用的2个Feign接口                                                                                                                                                                 |
    | 消息接口            | 1          | 1       | P1: MSG-RA-01；P2+: MSG-RA-02                                                                                                                                                             |
    | 数据存储（表/索引） | 4          | 3       | P1: T-02/03/04/09；P2+: T-01/05/06                                                                                                                                                        |
    | 前端页面            | 4          | 7       | P1: PG-05/06/09/10；P2+: PG-01/02/03/04/07/08/11                                                                                                                                          |
    | 权限码              | 6          | 7       | P1: task:create/read/manage + document:update + review:read/manage；P2+: 其余                                                                                                             |
    | 错误码              | 11         | 17      | P1: E-400001/400102/404002/404003/404004/409001/422007/422008/422011/500500/500501；P2+: 其余                                                                                             |

    表 C-1 版本规划追溯矩阵

+   **说明**：P1阶段聚焦人工录入和格式解析（含Doc2X API解析、人工比对校正、结构化拆分、再次校验、正式发布六阶段）两个核心流程的最小可用设计。原FL-RA-05人工审核流程已合并至FL-RA-04格式解析流程的阶段⑤⑥。P2+阶段扩展自动采集、变更监测、工作管理等能力。
