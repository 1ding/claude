# 概要设计

+   **文档版本**: V0.30
+   **编制日期**: 2026-01-31
+   **文档状态**: 草稿
+   **所属项目**: ClariSphere(透管云)
+   **适用阶段**: 阶段3 概要设计（依据《透管云产品研发过程规范》V1.1）
+   **变更历史**：版本变更历史如下表所示

    | 版本  | 日期       | 变更内容                                                             | 变更人 |
    | ----- | ---------- | -------------------------------------------------------------------- | ------ |
    | V0.10 | 2026-01-12 | 初始版本                                                             | 丁劲松 |
    | V0.20 | 2026-01-13 | 基于新需求（增加个人用户），架构做了对应调整                         | 丁劲松 |
    |       |            | 1. 消费侧拆分为A(企业租户)和B(个人用户)两个独立架构                  |        |
    |       |            | 2. 新增第9章消费侧B架构(个人用户)                                    |        |
    |       |            | 3. 知识中台架构增加UC访问网关和配额管控                              |        |
    |       |            | 4. 共用服务层新增支付中心，多服务增加UC能力                          |        |
    |       |            | 5. 数据持久化层、基础设施层、非功能性架构增加UC支持                  |        |
    | V0.21 | 2026-01-15 | 基于BRS第2册V0.21更新角色职责划分                                    | 丁劲松 |
    |       |            | 1. 变更监测职责从UP-01调整至UP-07                                    |        |
    |       |            | 2. UP-01新增人工验证与入库、工作管理场景组                           |        |
    |       |            | 3. 供给侧架构新增变更监测服务模块                                    |        |
    |       |            | 4. 内容采集服务扩展人工验证和工作管理能力                            |        |
    | V0.22 | 2026-01-18 | 基于"6库3图1包"架构优化知识中台设计                                  | 丁劲松 |
    |       |            | 1. 拆分svc-knowledge-core为svc-knowledge-entity和svc-knowledge-graph |        |
    |       |            | 2. 删除svc-template-mgr，模板管理职责迁移至svc-package-registry      |        |
    |       |            | 3. 场景点库/控制点库增加行业标签(industry_tag)                       |        |
    |       |            | 4. 存储层新增MySQL存储6库节点属性，Neo4j专注3图关系                  |        |
    |       |            | 5. 总体架构图、知识中台架构图、数据分布策略同步更新                  |        |
    | V0.30 | 2026-01-31 | 完全重写，对齐研发过程规范V0.1要求                                   | 丁劲松 |
    |       |            | • 新增架构概述章节（设计原则、架构风格、AD记录）                     |        |
    |       |            | • 重构领域划分（核心域/支撑域/通用域）                               |        |
    |       |            | • 完善上下文映射（增加映射模式、集成方式）                           |        |
    |       |            | • 新增技术选型章节（技术栈、引入计划）                               |        |
    |       |            | • 新增数据架构章节（数据分布、同步机制）                             |        |
    |       |            | • 新增非功能架构章节（性能、安全、可用性）                           |        |
    |       |            | • 新增Epic到BC映射章节（38个Epic完整映射）                           |        |

    表 0-1 文档变更记录

+   **文档密级**：【机密】 -- 外发必追责。

# 1 架构概述

+   本章描述透管云系统的架构设计原则、架构风格和关键技术决策

## 1.1 文档目的与范围

+   本文档是透管云产品的概要设计文档（High-Level Design，HLD）
+   依据《透管云产品研发过程规范》V1.1第5章"阶段3：概要设计"的要求编制
+   本文档的核心目标包括：
    -   完成系统总体架构设计，明确分层结构与组件职责
    -   划分限界上下文（BC），明确各BC的业务边界与职责
    -   设计BC之间的协作关系和集成模式
    -   完成技术选型，明确技术栈与基础设施
    -   建立Epic到BC的映射关系，确保需求可追溯

## 1.2 输入文档

+   本文档的编制依据如下表所示

    | 输入文档               | 版本  | 关键内容                                           |
    | ---------------------- | ----- | -------------------------------------------------- |
    | 产品战略-战略规划      | V0.30 | 商业模式、6期版本路线图、价值主张                  |
    | 产品战略-核心术语      | V0.22 | 6库3图1包产品架构、四维度七层级                    |
    | 产品宏观需求规格说明书 | V0.10 | 38个Epic、21个直接用户角色+5个外部相关方、38个场景 |
    | 透管云产品研发过程规范 | V1.1  | 概要设计阶段的输入输出与评审要点                   |

    表 1.2-1 输入文档清单

## 1.3 架构设计原则

+   透管云架构设计遵循以下核心原则

    | 原则       | 说明                                                     |
    | ---------- | -------------------------------------------------------- |
    | 双边平台   | 供给侧与消费侧通过共用数据层连接，实现内容生产与消费分离 |
    | 领域驱动   | 采用DDD方法论，按业务能力划分限界上下文                  |
    | 分层解耦   | 严格的分层架构，层间通过标准接口交互，降低耦合度         |
    | 服务化     | 业务能力以微服务形式提供，支持独立部署与演进             |
    | 数据驱动   | 6库3图作为核心数据资产，驱动双边业务价值创造             |
    | 安全优先   | 全链路安全防护，满足等保三级及以上要求                   |
    | 多租户隔离 | 消费侧A采用多租户架构，确保租户数据严格隔离              |
    | 渐进演进   | 架构支持按P1-P6版本渐进式交付，避免大爆炸式上线          |

    表 1.3-1 架构设计原则

## 1.4 架构风格

+   透管云采用"双边平台+微服务"的混合架构风格
+   架构风格选型依据如下表所示

    | 架构风格   | 应用范围   | 选型理由                                         |
    | ---------- | ---------- | ------------------------------------------------ |
    | 双边平台   | 整体架构   | 匹配"供给侧生产+消费侧消费+知识中台连接"商业模式 |
    | 微服务架构 | 核心业务域 | 支持独立部署、独立扩展、技术异构                 |
    | 事件驱动   | 跨BC协作   | 解耦BC间依赖，支持异步处理与最终一致性           |
    | CQRS       | 知识中台   | 读写分离，优化高频查询性能                       |
    | BFF模式    | 前端聚合层 | 按角色场景聚合接口，减少前端调用复杂度           |
    | 六边形架构 | BC内部设计 | 核心领域与技术设施解耦，便于测试与替换           |

    表 1.4-1 架构风格选型

## 1.5 关键架构决策

+   本节记录架构设计过程中的关键决策及其依据

### 1.5.1 AD-01 双边平台架构

+   决策记录如下表所示

    | 决策项   | 内容                                                               |
    | -------- | ------------------------------------------------------------------ |
    | 决策编号 | AD-01                                                              |
    | 决策主题 | 采用双边平台架构                                                   |
    | 决策内容 | 将系统划分为供给侧、知识中台、消费侧A、消费侧B四个独立架构域       |
    | 决策依据 | 商业模式要求供给侧统一生产内容，消费侧差异化消费                   |
    | 备选方案 | 单体应用、传统三层架构                                             |
    | 决策理由 | 单体应用无法支撑多租户与个人用户的差异化需求；三层架构无法体现双边 |
    | 决策影响 | 需要设计跨域数据同步机制，增加架构复杂度                           |
    | 决策状态 | 已批准                                                             |

    表 1.5.1-1 AD-01决策记录

### 1.5.2 AD-02 知识中台数据分层存储

+   决策记录如下表所示

    | 决策项   | 内容                                                          |
    | -------- | ------------------------------------------------------------- |
    | 决策编号 | AD-02                                                         |
    | 决策主题 | 知识中台采用多模态数据分层存储                                |
    | 决策内容 | 6库节点属性存MySQL，3图关系存Neo4j，全文检索用ES，文件存MinIO |
    | 决策依据 | 不同数据类型有不同的访问模式和性能要求                        |
    | 备选方案 | 全部存Neo4j、全部存MySQL+JSON                                 |
    | 决策理由 | Neo4j关系查询强但属性查询弱；MySQL属性查询强但关系遍历弱      |
    | 决策影响 | 需要设计跨存储的数据一致性保障机制                            |
    | 决策状态 | 已批准                                                        |

    表 1.5.2-1 AD-02决策记录

### 1.5.3 AD-03 消费侧A多租户隔离策略

+   决策记录如下表所示

    | 决策项   | 内容                                                             |
    | -------- | ---------------------------------------------------------------- |
    | 决策编号 | AD-03                                                            |
    | 决策主题 | 消费侧A采用Schema级租户隔离                                      |
    | 决策内容 | 每个企业租户独立Schema，共享数据库实例，支持按需升级为独立数据库 |
    | 决策依据 | 平衡隔离性、成本与运维复杂度                                     |
    | 备选方案 | 行级隔离（tenant_id字段）、独立数据库实例                        |
    | 决策理由 | 行级隔离安全性不足；独立实例成本过高                             |
    | 决策影响 | 需要动态数据源路由，DDL变更需全租户同步                          |
    | 决策状态 | 已批准                                                           |

    表 1.5.3-1 AD-03决策记录

### 1.5.4 AD-04 BFF聚合层按场景聚类

+   决策记录如下表所示

    | 决策项   | 内容                                                                 |
    | -------- | -------------------------------------------------------------------- |
    | 决策编号 | AD-04                                                                |
    | 决策主题 | BFF聚合层按交互特征聚类而非按角色拆分                                |
    | 决策内容 | 将21个直接用户角色的接口需求聚合为5个BFF集群，按交互模式而非角色划分 |
    | 决策依据 | 避免BFF服务过度碎片化，降低运维复杂度                                |
    | 备选方案 | 每角色一个BFF、统一网关直连微服务                                    |
    | 决策理由 | 21个BFF运维成本过高；直连微服务前端调用复杂度过高                    |
    | 决策影响 | 同一BFF需处理多角色权限，接口需角色标识                              |
    | 决策状态 | 已批准                                                               |

    表 1.5.4-1 AD-04决策记录

## 1.6 架构约束

+   架构设计需遵守以下约束条件

    | 约束类型 | 约束内容                                   |
    | -------- | ------------------------------------------ |
    | 技术约束 | 后端采用Spring Cloud技术栈，前端采用Vue 3  |
    | 技术约束 | 数据库主选MySQL 8.0，图数据库选Neo4j       |
    | 技术约束 | 容器化部署，支持Kubernetes编排             |
    | 合规约束 | 满足等保三级要求                           |
    | 合规约束 | 符合《数据安全法》《个人信息保护法》要求   |
    | 业务约束 | 支持私有化部署和SaaS两种交付模式           |
    | 业务约束 | 消费侧A支持100+企业租户，单租户1000+用户   |
    | 业务约束 | 消费侧B支持10万+个人用户                   |
    | 团队约束 | 研发团队熟悉Spring Cloud、Vue、MySQL技术栈 |

    表 1.6-1 架构约束清单

## 1.7 与上下游文档的关系

+   本文档在研发文档体系中的位置如下图所示

    ```graph
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │                         概要设计文档的上下游关系                             │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─────────────────────────────────────────────────────────────────────────┐ │
    │  │                          上游输入                                       │ │
    │  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │ │
    │  │  │ 01-产品战略       │  │ 01-核心术语       │  │ 02-宏观需求       │    │ │
    │  │  │ 战略规划          │  │ 6库3图1包         │  │ 38 Epic           │    │ │
    │  │  │ 商业模式          │  │ 四维度七层级      │  │ 21+5 角色         │    │ │
    │  │  │ 版本路线图        │  │ 术语定义          │  │ 38 场景           │    │ │
    │  │  └─────────┬─────────┘  └─────────┬─────────┘  └─────────┬─────────┘    │ │
    │  └────────────┼──────────────────────┼──────────────────────┼──────────────┘ │
    │               │                      │                      │                │
    │               ▼                      ▼                      ▼                │
    │  ┌─────────────────────────────────────────────────────────────────────────┐ │
    │  │                     03-概要设计-整体架构（本文档）                      │ │
    │  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                │ │
    │  │  │ 总体架构      │  │ BC划分        │  │ Epic→BC映射   │                │ │
    │  │  │ 技术选型      │  │ 上下文映射    │  │ 微服务清单    │                │ │
    │  │  └───────────────┘  └───────────────┘  └───────────────┘                │ │
    │  └─────────────────────────────────┬───────────────────────────────────────┘ │
    │                                    │                                         │
    │                                    ▼                                         │
    │  ┌─────────────────────────────────────────────────────────────────────────┐ │
    │  │                          下游输出                                       │ │
    │  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │ │
    │  │  │ 需求规格-BCxx     │  │ 详细设计-BCxx     │  │ 接口文档-BCxx     │    │ │
    │  │  │ BC级Feature       │  │ 领域模型          │  │ API规格           │    │ │
    │  │  │ BC级Story         │  │ 数据模型          │  │ 契约定义          │    │ │
    │  │  └───────────────────┘  └───────────────────┘  └───────────────────┘    │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 1.7-1 概要设计文档的上下游关系

# 2 总体架构

+   本章描述透管云系统的总体架构设计，包括分层架构、核心组件和部署视图

## 2.1 架构全景图

+   透管云采用"双边平台+八层分层"的总体架构
+   双边平台包括：
    -   **供给侧**：合规内容工厂，负责6库3图1包的生产与分发
    -   **消费侧**
        -   **消费侧A**：企业租户，执行合规治理闭环
        -   **消费侧B**：个人用户，进行知识消费与学习
+   知识中台作为双边连接的枢纽，是唯一的合规知识数据源
+   总体架构分层如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                        透管云总体架构分层视图                              │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ L1 前端交互层                                                        │  │
    │  │ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐          │  │
    │  │ │ 供给侧后台 │ │ 租户工作台 │ │  个人门户  │ │  移动端App │          │  │
    │  │ └────────────┘ └────────────┘ └────────────┘ └────────────┘          │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L2 网关接入层                                                        │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │  │
    │  │ │ 身份认证 │ │ 租户路由 │ │ 限流熔断 │ │ 协议转换 │ │ 安全审计 │     │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L3 BFF聚合层                                                         │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │  │
    │  │ │ 治理BFF  │ │ 设计BFF  │ │ 作业BFF  │ │ 供给BFF  │ │ 知识BFF  │     │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L4 核心业务域                                                        │  │
    │  │ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │  │
    │  │ │ 供给侧域     │ │ 知识中台域   │ │ 消费侧A域    │ │ 消费侧B域    │  │  │
    │  │ │ (内容生产)   │ │ (6库3图1包)  │ │ (企业治理)   │ │ (知识消费)   │  │  │
    │  │ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L5 南向适配层                                                        │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ Agent    │ │ API采集  │ │ 配置解析 │ │ 日志采集 │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L6 共用服务层                                                        │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │
    │  │ │ 认证   │ │ 权限   │ │ 审计   │ │ 消息   │ │ 文件   │ │ 支付   │    │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L7 数据服务层                                                        │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │
    │  │ │ MySQL  │ │ Neo4j  │ │ ES     │ │ Redis  │ │ MinIO  │ │ Kafka  │    │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │  │
    │  └──────────────────────────────────┬───────────────────────────────────┘  │
    │  ┌──────────────────────────────────▼───────────────────────────────────┐  │
    │  │ L8 基础设施层                                                        │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐               │  │
    │  │ │ K8s    │ │ Docker │ │ Nacos  │ │ 监控   │ │ 日志   │               │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.1-1 透管云总体架构分层视图

## 2.2 分层职责说明

+   各层职责定义如下表所示

    | 层级 | 层名称     | 核心职责                                             |
    | ---- | ---------- | ---------------------------------------------------- |
    | L1   | 前端交互层 | 多端触达，按角色提供差异化UI                         |
    | L2   | 网关接入层 | 统一入口，身份认证、租户路由、限流熔断、安全审计     |
    | L3   | BFF聚合层  | 场景化接口适配，聚合多个微服务数据，减少前端调用次数 |
    | L4   | 核心业务域 | 业务能力实现，按限界上下文划分微服务                 |
    | L5   | 南向适配层 | 对接租户IT环境，采集证据数据                         |
    | L6   | 共用服务层 | 跨域共用能力，认证、权限、审计、消息、文件、支付     |
    | L7   | 数据服务层 | 多模态数据存储，关系型、图、搜索、缓存、对象、消息   |
    | L8   | 基础设施层 | 容器编排、服务注册、配置中心、监控告警、日志中心     |

    表 2.2-1 分层职责说明

## 2.3 双边平台数据流

+   供给侧、消费侧之间的数据流转关系如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                          双边平台数据流视图                                │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌─────────────────────────────────────────────────────────────────────┐   │
    │  │                        供给侧（内容生产）                           │   │
    │  │  ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐               │   │
    │  │  │ 外规   │───▶│ 解析   │───▶│ 映射   │───▶│ 封装   │               │   │
    │  │  │ 采集   │    │ 标注   │    │ 构建   │    │ 发布   │               │   │
    │  │  └────────┘    └────────┘    └────────┘    └───┬────┘               │   │
    │  └────────────────────────────────────────────────┼────────────────────┘   │
    │                                                   │                        │
    │                                                   ▼ 发布/更新              │
    │  ┌─────────────────────────────────────────────────────────────────────┐   │
    │  │                     知识中台（6库3图1包）                           │   │
    │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │   │
    │  │  │ 外规库 │ │要求点库│ │场景点库│ │控制点库│ │验证规则│ │责任点库│  │   │
    │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │   │
    │  │  ┌───────────────────────────────────────────────────────────────┐  │   │
    │  │  │  3图：责任分配基准图 / 外规要求解析图 / 要求落实责任图        │  │   │
    │  │  └───────────────────────────────────────────────────────────────┘  │   │
    │  │  ┌───────────────────────────────────────────────────────────────┐  │   │
    │  │  │  1包：合规包（行业解决方案封装）                              │  │   │
    │  │  └───────────────────────────────────────────────────────────────┘  │   │
    │  └───────────────────────┬─────────────────────────┬───────────────────┘   │
    │                          │                         │                       │
    │             订阅/增量推送│                         │只读/配额检索          │
    │                          ▼                         ▼                       │
    │  ┌──────────────────────────────────┐ ┌──────────────────────────────────┐ │
    │  │      消费侧A（企业租户）         │ │      消费侧B（个人用户）         │ │
    │  │  ┌────────────────────────────┐  │ │  ┌────────────────────────────┐  │ │
    │  │  │ 租户私有库（映射+定制）    │  │ │  │ 只读访问（配额管控）       │  │ │
    │  │  └────────────────────────────┘  │ │  └────────────────────────────┘  │ │
    │  │  ┌────────────────────────────┐  │ │  ┌────────────────────────────┐  │ │
    │  │  │ 合规治理闭环               │  │ │  │ 知识检索与消费             │  │ │
    │  │  │ 评估→整改→验证→报告        │  │ │  │ 搜索→浏览→下载→收藏        │  │ │
    │  │  └────────────────────────────┘  │ │  └────────────────────────────┘  │ │
    │  └──────────────────────────────────┘ └──────────────────────────────────┘ │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.3-1 双边平台数据流视图

## 2.4 核心组件说明

### 2.4.1 L1 前端交互层

+   前端交互层按用户群体划分为四类应用

    | 应用名称   | 目标用户      | 技术选型     | 核心功能                               |
    | ---------- | ------------- | ------------ | -------------------------------------- |
    | 供给侧后台 | UP-01至UP-09  | Vue 3 + Arco | 内容采集、知识工程、运营分发、平台运维 |
    | 租户工作台 | UR-01至UR-10  | Vue 3 + Arco | 合规管理、验证检查、治理监督、风险管理 |
    | 个人门户   | UC-01、UC-02  | Vue 3 + Arco | 知识搜索、知识浏览、下载收藏、用户转化 |
    | 移动端App  | UR角色+UC角色 | Uni-App      | 待办提醒、移动审批、知识速查、证据采集 |

    表 2.4.1-1 前端应用清单

### 2.4.2 L2 网关接入层

+   网关接入层基于APISIX或Spring Cloud Gateway实现
+   网关核心能力如下表所示

    | 能力     | 说明                                                  |
    | -------- | ----------------------------------------------------- |
    | 身份认证 | JWT Token验证，支持OAuth2.0、OIDC、LDAP等多种认证方式 |
    | 租户路由 | 根据租户ID路由到对应Schema，UC用户无租户上下文        |
    | 配额管控 | UC-01用户每日下载配额3次，Redis计数器实现             |
    | 限流熔断 | 基于令牌桶算法限流，Sentinel实现熔断降级              |
    | 协议转换 | HTTP/HTTPS、WebSocket协议支持                         |
    | 安全审计 | 全量请求日志，敏感操作审计追踪                        |

    表 2.4.2-1 网关核心能力

### 2.4.3 L3 BFF聚合层

+   BFF聚合层按交互特征划分为5个集群
+   BFF集群划分如下表所示

    | BFF集群 | 交互特征 | 服务角色                                             | 核心场景                               |
    | ------- | -------- | ---------------------------------------------------- | -------------------------------------- |
    | 治理BFF | 决策驱动 | UR-01 CISO、UR-07 风险经理                           | 驾驶舱、审批、报告、风险评估           |
    | 设计BFF | 强交互   | UR-02 安全架构师、UR-03 制度编写者、UR-04 方案制定者 | 架构规划、制度编写、方案制定           |
    | 作业BFF | 流程驱动 | UR-05 落地执行人、UR-06 合规经理、UR-08 审计人员     | 策略执行、证据采集、合规评估、审计检查 |
    | 供给BFF | 批量处理 | UP-01至UP-09                                         | 内容采集、知识工程、运营分发           |
    | 知识BFF | 检索密集 | UC-01 知识访客、UC-02 专业用户                       | 知识搜索、知识浏览、下载收藏、用户转化 |
    | 安全BFF | 运营监控 | UR-09 安全经理、UR-10 制度管理员                     | 安全策略、事件管理、运营监控、制度发布 |

    表 2.4.3-1 BFF集群划分

### 2.4.4 L5 南向适配层

+   南向适配层负责对接租户IT环境，采集证据数据
+   适配器类型如下表所示

    | 适配器类型 | 采集方式        | 适用场景                         |
    | ---------- | --------------- | -------------------------------- |
    | Agent探针  | 部署在目标主机  | 操作系统配置、进程信息、文件属性 |
    | API采集器  | 调用目标系统API | 云平台、安全设备、中间件         |
    | 配置解析器 | 解析配置文件    | 数据库配置、应用配置             |
    | 日志采集器 | 对接日志系统    | 审计日志、操作日志               |

    表 2.4.4-1 适配器类型

+   南向适配层架构

    +   南向适配层负责与租户IT系统对接，实现证据采集自动化
    +   南向适配层架构如下图所示

        ```graph
        ┌────────────────────────────────────────────────────────────────────────────┐
        │                         南向适配层架构                                     │
        ├────────────────────────────────────────────────────────────────────────────┤
        │                                                                            │
        │  ┌──────────────────────────────────────────────────────────────────────┐  │
        │  │ 适配器管理                                                           │  │
        │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
        │  │  │ 适配器注册 │ │ 适配器配置 │ │ 适配器监控 │ │ 适配器调度 │         │  │
        │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │  │
        │  └──────────────────────────────────────────────────────────────────────┘  │
        │                                                                            │
        │  ┌──────────────────────────────────────────────────────────────────────┐  │
        │  │ 适配器类型                                                           │  │
        │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
        │  │  │ Agent采集  │ │ API采集    │ │ 日志采集   │ │ 配置采集   │         │  │
        │  │  │ (部署Agent)│ │ (调用API)  │ │ (Syslog)   │ │ (CMDB/扫描)│         │  │
        │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │  │
        │  └──────────────────────────────────────────────────────────────────────┘  │
        │                                                                            │
        │  ┌──────────────────────────────────────────────────────────────────────┐  │
        │  │ 支持的数据源类型（P1-P2阶段）                                        │  │
        │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
        │  │  │ 操作系统   │ │ 数据库     │ │ 云平台     │ │ 安全设备   │         │  │
        │  │  │ Linux/Win  │ │ MySQL/PG   │ │ AWS/阿里云 │ │ 防火墙/WAF │         │  │
        │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │  │
        │  └──────────────────────────────────────────────────────────────────────┘  │
        │                                                                            │
        └────────────────────────────────────────────────────────────────────────────┘
        ```

        图 2.x.x-1 南向适配层架构

    +   **南向适配层核心能力**：

        | 能力       | 说明                                      | 对应Epic |
        | ---------- | ----------------------------------------- | -------- |
        | Agent采集  | 部署轻量级Agent到租户服务器，定时采集证据 | EP-EX-02 |
        | API采集    | 调用租户系统API获取配置和状态数据         | EP-EX-02 |
        | 日志采集   | 接收租户系统推送的Syslog日志              | EP-EX-02 |
        | 配置解析   | 解析采集到的配置文件，提取关键配置项      | EP-EX-02 |
        | 适配器扩展 | 支持自定义适配器开发，适配更多数据源      | EP-EX-02 |

        表 2.x.x-1 南向适配层核心能力

    +   **与BC-32验证检查的协作**：
        -   南向适配层为BC-32提供证据采集基础设施
        -   BC-32定义验证规则和采集策略
        -   南向适配层执行采集任务，将证据数据返回BC-32
        -   BC-32执行验证规则，判断控制点执行情况

### 2.4.5 L6 共用服务层

+   共用服务层提供跨域共用能力
+   共用服务清单如下表所示

    | 服务名称 | 服务职责                                                       | 服务范围        | 对应基础性需求       |
    | -------- | -------------------------------------------------------------- | --------------- | -------------------- |
    | 认证中心 | 统一身份认证，支持本地认证、SSO、LDAP等多种认证协议            | 全平台          | BF-01 统一身份认证   |
    | 权限中心 | 统一权限管理，RBAC+ABAC混合模型，功能权限+数据权限             | 全平台          | BF-02 统一权限框架   |
    | 审计中心 | 统一审计日志，登录日志+操作日志+数据变更日志，支持合规报告导出 | 全平台          | BF-04 统一审计日志   |
    | 消息中心 | 统一消息通知，支持站内信、邮件、短信、企业微信等多渠道推送     | 全平台          | BF-05 消息通知中心   |
    | 文件中心 | 统一文件管理，上传下载、版本控制、预览、病毒扫描               | 全平台          | BF-06 文件与附件管理 |
    | 支付中心 | 统一支付管理，订阅计费与账单                                   | 消费侧A+消费侧B | -                    |
    | 租户中心 | 租户生命周期管理，开通、配置、计费、数据源路由                 | 消费侧A         | BF-03 多租户架构     |

    表 2.4.5-1 共用服务清单

## 2.5 部署视图

+   透管云支持两种部署模式：SaaS多租户部署和私有化独立部署

### 2.5.1 SaaS多租户部署

+   SaaS部署架构如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                        SaaS多租户部署架构                                  │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                         公有云环境                                   │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                      Kubernetes集群                            │  │  │
    │  │  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │  │  │
    │  │  │  │ 网关节点 │    │ BFF节点  │    │ 业务节点 │    │ 共用服务 │  │  │  │
    │  │  │  │ (3+)     │    │ (5+)     │    │ (10+)    │    │ (5+)     │  │  │  │
    │  │  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                      数据层（多租户隔离）                      │  │  │
    │  │  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │  │  │
    │  │  │  │ MySQL主从│    │ Neo4j    │    │ ES集群   │    │ Redis集群│  │  │  │
    │  │  │  │ (Schema) │    │ (公共)   │    │ (公共)   │    │ (公共)   │  │  │  │
    │  │  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  租户隔离策略：                                                            │
    │  • 知识中台（6库3图）：全租户共享，只读访问                                │
    │  • 租户私有数据：Schema级隔离，每租户独立Schema                            │
    │  • 个人用户数据：统一Schema，user_id字段隔离                               │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.5.1-1 SaaS多租户部署架构

### 2.5.2 私有化独立部署

+   私有化部署架构如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                        私有化独立部署架构                                  │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                       客户私有环境                                   │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                    应用集群                                    │  │  │
    │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │  │  │
    │  │  │  │ 网关     │  │ 业务服务 │  │ 共用服务 │                      │  │  │
    │  │  │  └──────────┘  └──────────┘  └──────────┘                      │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                    数据层（独立部署）                          │  │  │
    │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │  │  │
    │  │  │  │ MySQL    │  │ Neo4j    │  │ ES       │  │ Redis    │        │  │  │
    │  │  │  │ (独立)   │  │ (独立)   │  │ (独立)   │  │ (独立)   │        │  │  │
    │  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                               ▲                                            │
    │                               │ 数据同步（单向）                           │
    │  ┌────────────────────────────┴─────────────────────────────────────────┐  │
    │  │                    透管云SaaS（知识中台）                            │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │  6库3图1包 ──▶ 增量推送 ──▶ 客户私有知识库                     │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  私有化特点：                                                              │
    │  • 应用与数据完全部署在客户环境                                            │
    │  • 知识中台数据通过订阅同步至客户私有库                                    │
    │  • 支持完全离线运行（离线包更新）                                          │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.5.2-1 私有化独立部署架构

## 2.6 与宏观需求的对应关系

+   总体架构与宏观需求的业务生态系统严格对应
+   对应关系如下表所示

    | 宏观需求（生态位置）       | 总体架构（架构域） | 核心职责                             | 对应场景               |
    | -------------------------- | ------------------ | ------------------------------------ | ---------------------- |
    | 供给侧：合规知识流水线     | 供给侧域           | 内容采集→知识工程→运营分发           | SC-CP-01~09（9个场景） |
    | 知识中台：6库3图1包数据层  | 知识中台域         | 6库节点存储、3图关系管理、合规包仓库 | -                      |
    | 消费侧A：企业合规治理闭环  | 消费侧A域          | 主线：决策→规划→建设→执行            | SC-DC/PL/BD/EX（9个）  |
    |                            |                    | 贯穿：合规+风险+安全+审计            | SC-CM/RM/SM/AU（16个） |
    | 消费侧B：个人知识消费+转化 | 消费侧B域          | 搜索→浏览→下载→收藏→转化             | SC-KC-01~04（4个）     |

    表 2.6-1 总体架构与宏观需求对应关系

# 3 领域划分

+   本章基于领域驱动设计（DDD）方法论，识别透管云的核心域、支撑域和通用域

## 3.1 领域划分原则

+   领域划分遵循以下原则

    | 原则         | 说明                                         |
    | ------------ | -------------------------------------------- |
    | 业务价值导向 | 核心域承载核心竞争力，应投入最多资源         |
    | 变化频率     | 变化频繁的领域独立划分，避免影响稳定领域     |
    | 团队边界     | 领域边界应与团队边界对齐，减少跨团队协调成本 |
    | 通用能力下沉 | 与业务无关的通用能力下沉为通用域，实现复用   |

    表 3.1-1 领域划分原则

## 3.2 领域全景图

+   透管云领域划分全景如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                          透管云领域划分全景图                              │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                         核心域 (Core Domain)                         │  │
    │  │                      【核心竞争力，最高优先级】                      │  │
    │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
    │  │  │ 知识工程域   │  │ 合规管理域   │  │ 验证检查域   │                │  │
    │  │  │ 6库3图1包    │  │ 外规→控制    │  │ 证据→验证    │                │  │
    │  │  │ 【最核心】   │  │ 【差异化】   │  │ 【差异化】   │                │  │
    │  │  └──────────────┘  └──────────────┘  └──────────────┘                │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                       支撑域 (Supporting Domain)                     │  │
    │  │                      【支撑核心业务，中等优先级】                    │  │
    │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
    │  │  │ 治理监督域 │ │ 风险管理域 │ │ 内容生产域 │ │ 知识消费域 │         │  │
    │  │  │ 决策+审计  │ │ 识别+评估  │ │ 采集+发布  │ │ 检索+转化  │         │  │
    │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                        通用域 (Generic Domain)                       │  │
    │  │                      【通用能力，可外购或复用】                      │  │
    │  │  ┌────────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │  │
    │  │  │ 用户管理   │ │   租户   │ │  消息    │ │  文件    │ │  支付    │  │  │
    │  │  │ (IAM)      │ │   管理   │ │  通知    │ │  管理    │ │  计费    │  │  │
    │  │  │ 用户+认证+ │ │          │ │          │ │          │ │          │  │  │
    │  │  │ 授权+组织  │ │          │ │          │ │          │ │          │  │  │
    │  │  └────────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```
    图 3.2-1 透管云领域划分全景图

## 3.3 核心域定义

+   核心域是透管云的核心竞争力所在，承载最关键的业务价值

### 3.3.1 知识工程域

+   知识工程域定义如下表所示

    | 属性     | 内容                                                            |
    | -------- | --------------------------------------------------------------- |
    | 域名称   | 知识工程域（Knowledge Engineering Domain）                      |
    | 域类型   | 核心域                                                          |
    | 核心职责 | 管理6库3图1包核心数据资产，提供知识查询、图谱遍历、版本管理服务 |
    | 业务价值 | 透管云最核心的数据资产，是"管理透明化"能力的基础                |
    | 核心概念 | 外规、要求点、场景点、控制点、验证规则、责任点、合规包          |
    | 变化频率 | 中（外规更新驱动）                                              |
    | 复杂度   | 高（多模态存储、图谱关系、版本管理）                            |

    表 3.3.1-1 知识工程域定义

+   知识工程域的核心能力如下表所示

    | 能力        | 说明                                                       |
    | ----------- | ---------------------------------------------------------- |
    | 6库节点管理 | 外规库、要求点库、场景点库、控制点库、验证规则库、责任点库 |
    | 3图关系管理 | 责任分配基准图、外规要求解析图、要求落实责任图             |
    | 合规包管理  | 合规包定义、依赖管理、行业包、模板动态组装                 |
    | 知识检索    | 全文检索、向量检索、图谱遍历、混合排序                     |
    | 版本时光机  | 任意版本回溯、变更历史追踪、影响范围分析                   |

    表 3.3.1-2 知识工程域核心能力

### 3.3.2 合规管理域

+   合规管理域定义如下表所示

    | 属性     | 内容                                                       |
    | -------- | ---------------------------------------------------------- |
    | 域名称   | 合规管理域（Compliance Management Domain）                 |
    | 域类型   | 核心域                                                     |
    | 核心职责 | 实现从外规要求到控制措施的映射落地，管理合规评估与差距分析 |
    | 业务价值 | 解决"要求↔落实双向追溯"核心痛点，是合规中心的核心          |
    | 核心概念 | 合规评估、差距分析、整改计划、合规报告、外规订阅           |
    | 变化频率 | 高（业务驱动，频繁变化）                                   |
    | 复杂度   | 高（多维度映射、状态流转、报告生成）                       |

    表 3.3.2-1 合规管理域定义

+   合规管理域的核心能力如下表所示

    | 能力     | 说明                                      |
    | -------- | ----------------------------------------- |
    | 新规应对 | 新规解读、差距识别、整改计划生成          |
    | 制度追溯 | 制度条款→外规依据的双向追溯，僵尸制度识别 |
    | 合规评估 | 合规状态评估、量化评分、趋势分析          |
    | 差距分析 | 现状与目标的差距识别、优先级排序          |
    | 外规订阅 | 外规变更订阅、影响推送、主动监测          |

    表 3.3.2-2 合规管理域核心能力

### 3.3.3 验证检查域

+   验证检查域定义如下表所示

    | 属性     | 内容                                                     |
    | -------- | -------------------------------------------------------- |
    | 域名称   | 验证检查域（Verification Domain）                        |
    | 域类型   | 核心域                                                   |
    | 核心职责 | 管理证据采集、自动化验证、持续监测，实现控制点的技术验证 |
    | 业务价值 | 解决"检查应对拷问"痛点，从人工验证升级为自动化持续验证   |
    | 核心概念 | 证据、验证规则、验证结果、采集任务、适配器               |
    | 变化频率 | 中（技术驱动）                                           |
    | 复杂度   | 高（多源采集、规则引擎、适配器管理）                     |

    表 3.3.3-1 验证检查域定义

+   验证检查域的核心能力如下表所示

    | 能力       | 说明                                         |
    | ---------- | -------------------------------------------- |
    | 证据采集   | 自动化采集、人工上传、批量导入               |
    | 规则执行   | 验证规则解析、规则执行、结果判定             |
    | 持续监测   | 定时检查、变更触发、异常告警                 |
    | 适配器管理 | Agent探针、API采集器、配置解析器、日志采集器 |
    | 证据链管理 | 证据关联、证据完整性、证据时效性             |

    表 3.3.3-2 验证检查域核心能力

## 3.4 支撑域定义

+   支撑域为核心域提供必要的业务支撑能力

### 3.4.1 治理监督域

+   治理监督域定义如下表所示

    | 属性     | 内容                                                     |
    | -------- | -------------------------------------------------------- |
    | 域名称   | 治理监督域（Governance Domain）                          |
    | 域类型   | 支撑域                                                   |
    | 核心职责 | 支撑CISO、风险经理等决策者的战略监控、绩效汇报、审计监督 |
    | 业务价值 | 解决"管理汇报哑口"痛点，提供数据驱动的决策支持           |
    | 核心概念 | 驾驶舱、KPI指标、审计计划、审计发现、整改跟踪、任务督办  |
    | 变化频率 | 低（相对稳定）                                           |
    | 复杂度   | 中                                                       |

    表 3.4.1-1 治理监督域定义

### 3.4.2 风险管理域

+   风险管理域定义如下表所示

    | 属性     | 内容                                             |
    | -------- | ------------------------------------------------ |
    | 域名称   | 风险管理域（Risk Management Domain）             |
    | 域类型   | 支撑域                                           |
    | 核心职责 | 支撑风险识别、风险评估、风险应对的全流程管理     |
    | 业务价值 | 构建风险中心能力，实现风险的系统化管理           |
    | 核心概念 | 风险登记、风险评估、风险等级、风险应对、风险监控 |
    | 变化频率 | 中                                               |
    | 复杂度   | 中                                               |

    表 3.4.2-1 风险管理域定义

### 3.4.3 安全管理域

+   安全管理域定义如下表所示

    | 属性     | 内容                                                               |
    | -------- | ------------------------------------------------------------------ |
    | 域名称   | 安全管理域（Security Management Domain）                           |
    | 域类型   | 支撑域                                                             |
    | 核心职责 | 支撑安全策略制定、安全事件管理、安全运营监控、应急响应的全流程管理 |
    | 业务价值 | 构建统一的安全运营中心能力，实现安全管理的系统化、可视化           |
    | 核心概念 | 安全策略、安全事件、安全态势、应急预案、SIEM集成                   |
    | 变化频率 | 中                                                                 |
    | 复杂度   | 中                                                                 |

    表 3.4.3-1 安全管理域定义

### 3.4.4 内容生产域

+   内容生产域定义如下表所示

    | 属性     | 内容                                                     |
    | -------- | -------------------------------------------------------- |
    | 域名称   | 内容生产域（Content Production Domain）                  |
    | 域类型   | 支撑域                                                   |
    | 核心职责 | 支撑供给侧的外规采集、解析映射、方案封装、质检发布       |
    | 业务价值 | 构建合规内容工厂，实现6库3图1包的高效生产                |
    | 核心概念 | 采集任务、解析结果、映射关系、合规包、质检审核、发布版本 |
    | 变化频率 | 中                                                       |
    | 复杂度   | 高（AI辅助、流水线作业）                                 |

    表 3.4.4-1 内容生产域定义

### 3.4.5 知识消费域

+   知识消费域定义如下表所示

    | 属性     | 内容                                                 |
    | -------- | ---------------------------------------------------- |
    | 域名称   | 知识消费域（Knowledge Consumption Domain）           |
    | 域类型   | 支撑域                                               |
    | 核心职责 | 支撑个人用户的知识检索、图谱浏览、模板下载、付费转化 |
    | 业务价值 | 构建PLG获客入口，实现个人用户到企业客户的转化        |
    | 核心概念 | 知识检索、个人收藏、下载配额、付费订阅、企业转化     |
    | 变化频率 | 高（运营驱动）                                       |
    | 复杂度   | 中                                                   |

    表 3.4.5-1 知识消费域定义

## 3.5 通用域定义

+   通用域提供与业务无关的通用技术能力，可复用或外购

### 3.5.1 通用域清单

+   通用域清单如下表所示

    | 域名称     | 核心职责                                                    | 复用策略   | 对应基础性需求    |
    | ---------- | ----------------------------------------------------------- | ---------- | ----------------- |
    | 用户管理域 | 统一身份认证、用户管理、权限管理、组织架构、审计日志（IAM） | 自研       | FD-01/02/04/05/07 |
    | 租户管理域 | 租户生命周期管理，开通、配置、计费、数据源管理、AD/LDAP同步 | 自研       | FD-03/06          |
    | 消息通知域 | 统一消息通知，支持站内信、邮件、短信、企业微信等多渠道推送  | 自研+集成  | FD-08             |
    | 文件管理域 | 统一文件管理，上传下载、版本控制、预览、病毒扫描            | 自研+MinIO | FD-09             |
    | 支付计费域 | 统一支付管理，订阅计费与账单                                | 集成第三方 | -                 |
    | 系统运维域 | 任务调度、系统监控告警、数据备份恢复、数据字典管理          | 自研       | FD-10/11/12/13    |

    表 3.5.1-1 通用域清单

### 3.5.2 通用域与核心域的关系

+   通用域为核心域和支撑域提供基础能力支撑
+   关系如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                      通用域与业务域的依赖关系                              │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    核心域 + 支撑域                                   │  │
    │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
    │  │  │ 知识工程   │ │ 合规管理   │ │ 验证检查   │ │ 治理监督   │ ...     │  │
    │  │  └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘         │  │
    │  └────────┼──────────────┼──────────────┼──────────────┼────────────────┘  │
    │           │              │              │              │                   │
    │           │  依赖        │  依赖        │  依赖        │  依赖             │
    │           ▼              ▼              ▼              ▼                   │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                         通用域                                       │  │
    │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │  │
    │  │  │ 身份   │ │ 权限   │ │ 租户   │ │ 消息   │ │ 文件   │ │ 审计   │   │  │
    │  │  │ 认证   │ │ 管理   │ │ 管理   │ │ 通知   │ │ 管理   │ │ 日志   │   │  │
    │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘   │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  依赖方向：核心域/支撑域 ──依赖──▶ 通用域                                  │
    │  通用域不应依赖核心域或支撑域                                              │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.5.2-1 通用域与业务域的依赖关系

## 3.6 领域与架构域的映射

+   领域与总体架构中的架构域映射关系如下表所示

    | 域类型 | 领域名称   | 架构域     | 部署位置                   |
    | ------ | ---------- | ---------- | -------------------------- |
    | 核心域 | 知识工程域 | 知识中台域 | 知识中台                   |
    | 核心域 | 合规管理域 | 消费侧A域  | 消费侧A                    |
    | 核心域 | 验证检查域 | 消费侧A域  | 消费侧A + 南向适配层       |
    | 支撑域 | 治理监督域 | 消费侧A域  | 消费侧A                    |
    | 支撑域 | 风险管理域 | 消费侧A域  | 消费侧A                    |
    | 支撑域 | 安全管理域 | 消费侧A域  | 消费侧A                    |
    | 支撑域 | 内容生产域 | 供给侧域   | 供给侧                     |
    | 支撑域 | 知识消费域 | 消费侧B域  | 消费侧B                    |
    | 通用域 | 用户管理域 | 共用服务层 | 全平台（UP/UR/UC三用户群） |
    | 通用域 | 租户管理域 | 共用服务层 | 消费侧A                    |
    | 通用域 | 消息通知域 | 共用服务层 | 全平台                     |
    | 通用域 | 文件管理域 | 共用服务层 | 全平台                     |
    | 通用域 | 支付计费域 | 共用服务层 | 消费侧A + 消费侧B          |
    | 通用域 | 系统运维域 | 共用服务层 | 全平台                     |

    表 3.6-1 领域与架构域映射关系

## 3.7 领域优先级与投资策略

+   不同类型领域的投资策略如下表所示

    | 领域类型 | 投资策略                               | 团队配置            |
    | -------- | -------------------------------------- | ------------------- |
    | 核心域   | 最高优先级，自主研发，投入最优资源     | 资深工程师+领域专家 |
    | 支撑域   | 中等优先级，自主研发为主，可适度外包   | 中级工程师          |
    | 通用域   | 复用优先，优先采用成熟方案，仅定制集成 | 初中级工程师        |

    表 3.7-1 领域投资策略

# 4 限界上下文

+   本章定义透管云的限界上下文（Bounded Context，BC），明确各BC的职责边界和核心能力

## 4.1 BC划分原则

+   BC划分遵循以下原则

    | 原则         | 说明                                           |
    | ------------ | ---------------------------------------------- |
    | 单一职责     | 每个BC聚焦单一业务能力，避免职责混杂           |
    | 高内聚低耦合 | BC内部高度内聚，BC之间松散耦合                 |
    | 独立部署     | 每个BC可独立部署、独立扩展、独立演进           |
    | 团队对齐     | BC边界与团队边界对齐，实现康威定律正向应用     |
    | 语言边界     | BC内部使用统一的领域语言，BC之间通过防腐层转换 |

    表 4.1-1 BC划分原则

## 4.2 BC全景图

+   透管云共划分为16个限界上下文
+   BC全景图如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         透管云限界上下文全景图                             │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    供给侧 BC（3个）                                  │  │
    │  │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐            │  │
    │  │  │ BC-51          │ │ BC-52          │ │ BC-53          │            │  │
    │  │  │ 内容采集       │ │ 知识工程       │ │ 运营分发       │            │  │
    │  │  └────────────────┘ └────────────────┘ └────────────────┘            │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    知识中台 BC（2个）                                │  │
    │  │  ┌────────────────────────────┐ ┌────────────────────────────┐       │  │
    │  │  │ BC-40 知识实体             │ │ BC-41 知识图谱             │       │  │
    │  │  │ 6库节点属性管理            │ │ 3图关系+合规包+检索        │       │  │
    │  │  └────────────────────────────┘ └────────────────────────────┘       │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    消费侧A BC（6个）                                 │  │
    │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │
    │  │  │ BC-31    │ │ BC-32    │ │ BC-33    │ │ BC-34    │ │ BC-35    │    │  │
    │  │  │ 合规管理 │ │ 验证检查 │ │ 治理监督 │ │ 风险管理 │ │ 租户落地 │    │  │
    │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘    │  │
    │  │  ┌──────────┐                                                        │  │
    │  │  │ BC-36    │                                                        │  │
    │  │  │ 安全管理 │                                                        │  │
    │  │  └──────────┘                                                        │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    消费侧B BC（1个）                                 │  │
    │  │  ┌────────────────────────────────────────────────────────────────┐  │  │
    │  │  │ BC-20 知识消费                                                 │  │  │
    │  │  │ 智能搜索+图谱浏览+模板下载+收藏管理+配额管控+转化              │  │  │
    │  │  └────────────────────────────────────────────────────────────────┘  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                    通用域 BC（4个）                                  │  │
    │  │  ┌──────────────────────────┐ ┌────────────────┐ ┌──────────────┐    │  │
    │  │  │ BC-10 用户管理(IAM)      │ │ BC-11          │ │ BC-12        │    │  │
    │  │  │ 用户+认证+授权+组织+审计 │ │ 租户管理       │ │ 消息通知     │    │  │
    │  │  │【支撑FD-01~07】          │ │【支撑FD-03/06】│ │【支撑FD-08】 │    │  │
    │  │  └──────────────────────────┘ └────────────────┘ └──────────────┘    │  │
    │  │  ┌──────────────┐  ┌──────────────┐                                  │  │
    │  │  │ BC-13        │  │ BC-14        │                                  │  │
    │  │  │ 文件管理     │  │ 工作流管理   │                                  │  │
    │  │  │【支撑FD-09】 │  │              │                                  │  │
    │  │  └──────────────┘  └──────────────┘                                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2-1 透管云限界上下文全景图

## 4.3 BC清单汇总

+   BC清单汇总如下表所示

    | BC编号 | BC名称   | 所属域     | 架构域     | 核心职责                                 | 对应Epic                       |
    | ------ | -------- | ---------- | ---------- | ---------------------------------------- | ------------------------------ |
    | BC-10  | 用户管理 | 用户管理域 | 通用服务层 | 用户管理、认证、授权、组织架构、审计日志 | 基础性需求FD-01/02/04/05/07/10 |
    | BC-11  | 租户管理 | 租户管理域 | 通用服务层 | 租户生命周期、数据源、配置、计费         | 基础性需求FD-03/06             |
    | BC-12  | 消息通知 | 消息通知域 | 通用服务层 | 站内信、邮件、短信、企业微信推送         | 基础性需求FD-08                |
    | BC-13  | 文件管理 | 文件管理域 | 通用服务层 | 文件上传、下载、预览、版本控制、病毒扫描 | 基础性需求FD-09                |
    | BC-20  | 知识消费 | 知识消费域 | 消费侧B域  | 知识搜索、知识浏览、下载收藏、用户转化   | EP-KC-01~04                    |
    | BC-31  | 合规管理 | 合规管理域 | 消费侧A域  | 新规应对、制度追溯、合规总览、合规评估   | EP-CM-01~07                    |
    | BC-32  | 验证检查 | 验证检查域 | 消费侧A域  | 证据采集、规则执行、持续监测、整改管理   | EP-EX-01~03, EP-CM-07部分      |
    | BC-33  | 治理监督 | 治理监督域 | 消费侧A域  | 战略监控、绩效汇报、审计检查、任务督办   | EP-DC-01/02, EP-AU-01~03       |
    | BC-34  | 风险管理 | 风险管理域 | 消费侧A域  | 风险识别、风险评估、风险应对             | EP-RM-01~03                    |
    | BC-35  | 租户落地 | 合规管理域 | 消费侧A域  | 场景映射、控制定制、资产管理、岗位映射   | EP-PL-01, EP-BD-01~03          |
    | BC-36  | 安全管理 | 安全管理域 | 消费侧A域  | 安全策略、安全事件、安全运营、应急响应   | EP-SM-01~03                    |
    | BC-40  | 知识实体 | 知识工程域 | 知识中台域 | 6库节点属性管理、版本控制                | EP-CP-02部分                   |
    | BC-41  | 知识图谱 | 知识工程域 | 知识中台域 | 3图关系管理、合规包仓库、智能检索        | EP-CP-03/04部分                |
    | BC-51  | 内容采集 | 内容生产域 | 供给侧域   | 外规采集入库、变更监测、工作管理         | EP-CP-01                       |
    | BC-52  | 知识工程 | 内容生产域 | 供给侧域   | 外规解析、映射管理、质检发布             | EP-CP-02~05                    |
    | BC-53  | 运营分发 | 内容生产域 | 供给侧域   | 租户开通、数据推送、运营监控             | EP-CP-06~09                    |

    表 4.3-1 BC清单汇总

## 4.4 供给侧BC定义

### 4.4.1 BC-51 内容采集

+   BC定义如下表所示

    | 属性       | 内容                                                         |
    | ---------- | ------------------------------------------------------------ |
    | BC编号     | BC-51                                                        |
    | BC名称     | 内容采集（Content Acquisition）                              |
    | 所属域     | 内容生产域                                                   |
    | 核心职责   | 外规采集入库、控制点架构维护、变更监测                       |
    | 范围内     | 外规源管理、爬虫调度、人工录入、格式识别、变更检测、工作管理 |
    | 范围外     | 外规解析映射（BC-52）、租户分发（BC-53）                     |
    | 上游依赖   | 无                                                           |
    | 下游被依赖 | BC-52 知识工程                                               |
    | 服务角色   | UP-01 外规采集员                                             |

    表 4.4.1-1 BC-51定义

+   BC-51核心能力如下表所示

    | 能力       | 说明                                            | 对应场景要素            |
    | ---------- | ----------------------------------------------- | ----------------------- |
    | 外规源管理 | 配置外规采集源，支持官网、数据库、API等多种来源 | SC-CP-01 外规采集入库   |
    | 爬虫调度   | 定时爬取外规更新，支持增量采集与全量采集        | SC-CP-01 外规采集入库   |
    | 人工录入   | 支持人工上传外规文件，OCR识别与格式转换         | SC-CP-01 外规采集入库   |
    | 格式识别   | 识别PDF、Word、HTML等格式，提取结构化内容       | SC-CP-01 外规采集入库   |
    | 变更检测   | 检测外规版本变更，生成变更差异报告              | EP-CP-01 变更监测       |
    | 工作管理   | 采集任务分配、进度跟踪、质量统计                | SC-CP-01 工作管理场景组 |
    | 人工验证   | AI解析结果的人工校验与确认                      | SC-CP-01 人工验证场景组 |

    表 4.4.1-2 BC-51核心能力

### 4.4.2 BC-52 知识工程

+   BC定义如下表所示

    | 属性       | 内容                                                                   |
    | ---------- | ---------------------------------------------------------------------- |
    | BC编号     | BC-52                                                                  |
    | BC名称     | 知识工程（Knowledge Engineering）                                      |
    | 所属域     | 内容生产域                                                             |
    | 核心职责   | 外规解析映射、方案封装、质检审核                                       |
    | 范围内     | 智能解析、映射规则、AI辅助标注、合规包设计、质量检查、发布审批         |
    | 范围外     | 外规采集（BC-51）、租户分发（BC-53）、6库存储（BC-40）                 |
    | 上游依赖   | BC-51 内容采集、BC-40 知识实体                                         |
    | 下游被依赖 | BC-40 知识实体、BC-41 知识图谱                                         |
    | 服务角色   | UP-02 控制架构师、UP-03 外规解析师、UP-04 方案设计师、UP-05 质量审核员 |

    表 4.4.2-1 BC-52定义

+   BC-52核心能力如下表所示

    | 能力       | 说明                               |
    | ---------- | ---------------------------------- |
    | 智能解析   | NLP驱动的外规条款拆解，提取要求点  |
    | 映射规则   | 要求点→控制点的映射规则配置与执行  |
    | AI辅助标注 | 基于向量相似度的智能推荐，人工确认 |
    | 合规包设计 | 合规包定义、依赖管理、行业包配置   |
    | 质量检查   | 完整性校验、准确性审核、一致性检查 |
    | 发布审批   | 发布流程管理、版本控制、回滚支持   |

    表 4.4.2-2 BC-52核心能力

### 4.4.3 BC-53 运营分发

+   BC定义如下表所示

    | 属性       | 内容                                                                   |
    | ---------- | ---------------------------------------------------------------------- |
    | BC编号     | BC-53                                                                  |
    | BC名称     | 运营分发（Operation Distribution）                                     |
    | 所属域     | 内容生产域                                                             |
    | 核心职责   | 租户开通管理、数据推送服务、运营监控                                   |
    | 范围内     | 租户订阅、增量推送、同步监控、运营大屏、用户运营                       |
    | 范围外     | 内容生产（BC-51/BC-52）、租户业务（BC-31~BC-10）                       |
    | 上游依赖   | BC-40 知识实体、BC-41 知识图谱、BC-11 租户管理                         |
    | 下游被依赖 | BC-35 租户落地                                                         |
    | 服务角色   | UP-06 租户运营员、UP-07 数据服务员、UP-08 平台管理员、UP-09 运营管理员 |

    表 4.4.3-1 BC-53定义

## 4.5 知识中台BC定义

### 4.5.1 BC-40 知识实体

+   BC定义如下表所示

    | 属性       | 内容                                                           |
    | ---------- | -------------------------------------------------------------- |
    | BC编号     | BC-40                                                          |
    | BC名称     | 知识实体（Knowledge Entity）                                   |
    | 所属域     | 知识工程域                                                     |
    | 核心职责   | 管理6库节点属性，提供节点CRUD、版本管理、行业标签服务          |
    | 范围内     | 外规库、要求点库、场景点库、控制点库、验证规则库、责任点库     |
    | 范围外     | 3图关系管理（BC-41）、全文检索（BC-41）                        |
    | 上游依赖   | BC-52 知识工程（写入）                                         |
    | 下游被依赖 | BC-41 知识图谱、BC-31 合规管理、BC-32 验证检查、BC-20 知识消费 |
    | 服务角色   | 无直接角色（内部服务）                                         |

    表 4.5.1-1 BC-40定义

+   BC-40管理的6库定义如下表所示

    | 库名称     | 数据规模 | 核心属性                                         |
    | ---------- | -------- | ------------------------------------------------ |
    | 外规库     | 2000+    | 外规编号、名称、发布机构、生效日期、条款结构     |
    | 要求点库   | 50000+   | 要求编号、要求内容、来源外规、适用场景、强制等级 |
    | 场景点库   | 20000+   | 场景编号、场景名称、行业标签、业务域、适用系统   |
    | 控制点库   | 100000+  | 控制编号、控制描述、控制类型、行业标签、实施指引 |
    | 验证规则库 | 10000+   | 规则编号、规则表达式、检查方式、预期结果、适配器 |
    | 责任点库   | 动态生成 | 责任编号、控制点、场景点、RACISV角色、执行周期   |

    表 4.5.1-2 6库定义

### 4.5.2 BC-41 知识图谱

+   BC定义如下表所示

    | 属性       | 内容                                                                           |
    | ---------- | ------------------------------------------------------------------------------ |
    | BC编号     | BC-41                                                                          |
    | BC名称     | 知识图谱（Knowledge Graph）                                                    |
    | 所属域     | 知识工程域                                                                     |
    | 核心职责   | 管理3图关系、合规包仓库、智能检索、版本时光机、六链验证查询                    |
    | 范围内     | 图关系管理、路径推演、影响分析、合规包、全文检索、向量检索、六链穿透查询       |
    | 范围外     | 6库节点属性（BC-40）                                                           |
    | 上游依赖   | BC-40 知识实体、BC-52 知识工程                                                 |
    | 下游被依赖 | BC-31 合规管理、BC-32 验证检查、BC-33 治理监督、BC-35 租户落地、BC-20 知识消费 |
    | 服务角色   | 无直接角色（内部服务）                                                         |

    表 4.5.2-1 BC-41定义

+   BC-41管理的3图定义如下表所示

    | 图名称         | 关系类型                           | 核心能力           |
    | -------------- | ---------------------------------- | ------------------ |
    | 责任分配基准图 | 控制点+场景点→责任点               | RACISV责任动态生成 |
    | 外规要求解析图 | 外规→条款→要求点+场景点            | 外规拆解、语义归一 |
    | 要求落实责任图 | 要求点+场景点→控制点+场景点→责任点 | 双向追溯、影响分析 |

    表 4.5.2-2 3图定义

+   **六链验证查询能力**：BC-41作为知识中台的图谱服务，承担六链验证的底层查询能力，具体接口归属如下表所示

    | 六链          | 查询能力           | 接口提供方 | 调用方BFF      |
    | ------------- | ------------------ | ---------- | -------------- |
    | L1 治理穿透链 | 战略→目标→指标追溯 | BC-41      | bff-governance |
    | L2 合规落地链 | 外规→要求→控制追溯 | BC-41      | bff-workspace  |
    | L3 制度溯源链 | 制度→外规依据追溯  | BC-41      | bff-workspace  |
    | L4 技术落地链 | 控制→证据→验证追溯 | BC-41      | bff-workspace  |
    | L5 责任落实链 | 控制→责任→人员追溯 | BC-41      | bff-governance |
    | L6 风险防控链 | 风险→控制→缓释追溯 | BC-41      | bff-governance |

    表 4.5.2-3 六链验证查询接口归属

+   **说明**：六链查询由BC-41提供OHS接口，消费侧BC（BC-31/BC-33/BC-34）通过调用BC-41接口实现业务场景封装，BFF层根据角色场景选择合适的消费侧BC进行聚合

## 4.6 消费侧A BC定义

### 4.6.1 BC-31 合规管理

+   BC定义如下表所示

    | 属性       | 内容                                                       |
    | ---------- | ---------------------------------------------------------- |
    | BC编号     | BC-31                                                      |
    | BC名称     | 合规管理（Compliance Management）                          |
    | 所属域     | 合规管理域                                                 |
    | 核心职责   | 新规应对、制度追溯、合规评估、差距分析、外规订阅、检查应对 |
    | 范围内     | 合规评估、差距分析、整改计划、合规报告、外规订阅、监管检查 |
    | 范围外     | 证据采集（BC-32）、风险评估（BC-34）、租户映射（BC-10）    |
    | 上游依赖   | BC-40 知识实体、BC-41 知识图谱、BC-35 租户落地             |
    | 下游被依赖 | BC-32 验证检查、BC-33 治理监督                             |
    | 服务角色   | UR-06 合规经理                                             |

    表 4.6.1-1 BC-31定义

+   BC-31核心能力如下表所示

    | 能力     | 说明                                           |
    | -------- | ---------------------------------------------- |
    | 新规应对 | 新规解读、与现有制度差距识别、整改计划自动生成 |
    | 制度追溯 | 制度条款→外规依据双向追溯、僵尸制度识别        |
    | 合规评估 | 合规状态量化评估、评分模型、趋势分析           |
    | 差距分析 | 现状与目标差距识别、优先级排序、整改建议       |
    | 外规订阅 | 关注领域外规订阅、变更推送、影响预警           |
    | 检查应对 | 检查材料一键生成、证据包组装、监管问答支持     |

    表 4.6.1-2 BC-31核心能力

### 4.6.2 BC-32 验证检查

+   BC定义如下表所示

    | 属性       | 内容                                                                   |
    | ---------- | ---------------------------------------------------------------------- |
    | BC编号     | BC-32                                                                  |
    | BC名称     | 验证检查（Verification）                                               |
    | 所属域     | 验证检查域                                                             |
    | 核心职责   | 策略执行、证据采集、规则执行、持续监测、整改管理                       |
    | 范围内     | 策略执行、证据采集、验证执行、持续监测、整改跟踪、适配器管理           |
    | 范围外     | 合规评估（BC-31）、审计检查（BC-33）、安全事件管理（BC-36）            |
    | 上游依赖   | BC-40 知识实体（验证规则）、BC-31 合规管理、BC-35 租户落地             |
    | 下游被依赖 | BC-31 合规管理、BC-33 治理监督、BC-36 安全管理（验证失败触发安全事件） |
    | 服务角色   | UR-05 落地执行人                                                       |

    表 4.6.2-1 BC-32定义

### 4.6.3 BC-33 治理监督

+   BC定义如下表所示

    | 属性       | 内容                                                                       |
    | ---------- | -------------------------------------------------------------------------- |
    | BC编号     | BC-33                                                                      |
    | BC名称     | 治理监督（Governance）                                                     |
    | 所属域     | 治理监督域                                                                 |
    | 核心职责   | 战略监控、绩效汇报、审计检查、责任问责、任务督办                           |
    | 范围内     | 驾驶舱、KPI指标、审计计划、审计发现、整改跟踪、任务督办                    |
    | 范围外     | 合规评估（BC-31）、证据采集（BC-32）、安全事件处置（BC-36）                |
    | 上游依赖   | BC-31 合规管理、BC-32 验证检查、BC-34 风险管理、BC-36 安全管理             |
    | 下游被依赖 | 无                                                                         |
    | 服务角色   | UR-01 CISO、UR-06 合规经理、UR-07 风险经理、UR-08 审计人员、UR-09 安全经理 |

    表 4.6.3-1 BC-33定义

### 4.6.4 BC-34 风险管理

+   BC定义如下表所示

    | 属性       | 内容                                                     |
    | ---------- | -------------------------------------------------------- |
    | BC编号     | BC-34                                                    |
    | BC名称     | 风险管理（Risk Management）                              |
    | 所属域     | 风险管理域                                               |
    | 核心职责   | 风险识别、风险评估、风险应对、风险监控                   |
    | 范围内     | 风险登记、风险评估、风险等级、风险应对、风险热图         |
    | 范围外     | 合规评估（BC-31）、控制验证（BC-32）、安全运营（BC-36）  |
    | 上游依赖   | BC-31 合规管理、BC-32 验证检查                           |
    | 下游被依赖 | BC-33 治理监督、BC-36 安全管理（风险数据供安全态势分析） |
    | 服务角色   | UR-07 风险经理                                           |

    表 4.6.4-1 BC-34定义

### 4.6.5 BC-35 租户落地

+   BC定义如下表所示

    | 属性       | 内容                                                                   |
    | ---------- | ---------------------------------------------------------------------- |
    | BC编号     | BC-35                                                                  |
    | BC名称     | 租户落地（Tenant Deployment）                                          |
    | 所属域     | 合规管理域                                                             |
    | 核心职责   | 租户私有映射、资产管理、制度编写、岗位角色映射                         |
    | 范围内     | 租户资产、租户场景、租户控制、租户制度、租户岗位、租户角色             |
    | 范围外     | 知识中台数据（BC-40/BC-41）、合规评估（BC-31）、安全策略运营（BC-36）  |
    | 上游依赖   | BC-53 运营分发、BC-40 知识实体、BC-41 知识图谱、BC-10 用户管理         |
    | 下游被依赖 | BC-31 合规管理、BC-32 验证检查、BC-36 安全管理（安全策略基础配置）     |
    | 服务角色   | UR-02 安全架构师、UR-03 制度编写者、UR-04 方案制定者、UR-10 制度管理员 |

    表 4.6.5-1 BC-35定义

+   BC-35核心能力如下表所示

    | 能力         | 说明                                         |
    | ------------ | -------------------------------------------- |
    | 租户资产     | 租户IT资产登记、资产分类、资产与场景关联     |
    | 租户场景     | 标准场景点→租户场景的映射与定制              |
    | 租户控制     | 标准控制点→租户控制的映射与定制              |
    | 租户制度     | 租户内部制度管理、制度与控制点关联           |
    | 岗位角色映射 | 标准角色点→租户岗位/人员的映射，实现责任到人 |
    | 安全策略模板 | 提供安全策略基础配置和模板，供BC-36运营使用  |

    表 4.6.5-2 BC-35核心能力

+   **说明**：BC-35的组织架构数据来源于BC-10用户管理上下文，BC-35负责将知识中台的标准角色点映射到租户的实际岗位和人员

### 4.6.6 BC-36 安全管理

+   BC定义如下表所示

    | 属性       | 内容                                                                 |
    | ---------- | -------------------------------------------------------------------- |
    | BC编号     | BC-36                                                                |
    | BC名称     | 安全管理（Security Management）                                      |
    | 所属域     | 安全管理域                                                           |
    | 核心职责   | 安全策略管理、安全事件管理、安全运营监控、应急响应管理               |
    | 范围内     | 安全策略制定发布、安全事件采集分类响应、安全态势感知、应急预案与演练 |
    | 范围外     | 控制验证执行（BC-32）、风险评估分析（BC-34）、审计检查（BC-33）      |
    | 上游依赖   | BC-32 验证检查、BC-34 风险管理、BC-35 租户落地                       |
    | 下游被依赖 | BC-33 治理监督                                                       |
    | 服务角色   | UR-09 安全经理、UR-01 CISO                                           |

    表 4.6.6-1 BC-36定义

+   BC-36核心能力如下表所示

    | 能力         | 说明                                                 | 对应场景/Epic |
    | ------------ | ---------------------------------------------------- | ------------- |
    | 安全策略管理 | 安全策略制定、发布、版本管理，策略与制度、控制点关联 | EP-SM-01      |
    | 安全事件管理 | 安全事件采集、分类、响应处置、闭环跟踪               | EP-SM-02      |
    | 安全运营监控 | 安全态势感知、安全指标监控、安全趋势分析             | EP-SM-03      |
    | 应急响应管理 | 应急预案管理、应急演练、事件升级、恢复跟踪           | EP-SM-01~03   |
    | SIEM集成     | 对接企业SIEM/SOC系统，统一安全事件源                 | EP-SM-02      |

    表 4.6.6-2 BC-36核心能力

+   **BC-36与BC-32/BC-34/BC-35的职责边界说明**：
    -   BC-35 租户落地：负责安全策略的基础配置（策略模板、策略与制度关联），不负责策略的运营执行
    -   BC-32 验证检查：负责控制点的技术验证执行，安全事件作为验证失败的触发结果传递给BC-36
    -   BC-34 风险管理：负责风险的识别、评估、应对，安全事件可能产生新的风险项，由BC-36通知BC-34
    -   BC-36 安全管理：负责安全策略的运营执行、安全事件的全生命周期管理、安全态势的整体监控

### 4.6.7 BC-37 制度管理

+   BC定义如下表所示

    | 属性       | 内容                                                           |
    | ---------- | -------------------------------------------------------------- |
    | BC编号     | BC-37                                                          |
    | BC名称     | 制度管理（Policy Management）                                  |
    | 所属域     | 合规管理域                                                     |
    | 核心职责   | 制度版本管理、制度生命周期管理、制度发布审批、制度检索         |
    | 范围内     | 制度版本、制度发布、制度审批、制度废止、制度检索、制度分类     |
    | 范围外     | 制度编写（BC-35）、制度追溯分析（BC-31）                       |
    | 上游依赖   | BC-35 租户落地（制度编写完成后提交发布）                       |
    | 下游被依赖 | BC-31 合规管理（制度追溯查询）、BC-32 验证检查（制度执行验证） |
    | 服务角色   | UR-03 制度编写者、UR-10 制度管理员                             |
    | 所属微服务 | svc-policy                                                     |

    表 4.6.7-1 BC-37定义

+   BC-37核心能力如下表所示

    | 能力         | 说明                                       | 对应Epic |
    | ------------ | ------------------------------------------ | -------- |
    | 制度版本管理 | 制度版本创建、版本历史、版本对比、版本回滚 | EP-BD-02 |
    | 制度发布审批 | 制度发布申请、审批流程、发布执行           | EP-BD-02 |
    | 制度生命周期 | 草稿→审批→生效→修订→废止的完整生命周期管理 | EP-BD-02 |
    | 制度检索     | 制度全文检索、制度分类浏览、制度标签筛选   | EP-BD-02 |
    | 制度废止     | 制度废止申请、废止审批、废止记录           | EP-BD-02 |

    表 4.6.7-2 BC-37核心能力

+   **BC-35与BC-37的职责边界说明**：
    -   BC-35 租户落地：负责制度内容的编写、制度与控制点的关联、制度模板管理
    -   BC-37 制度管理：负责制度的版本管理、发布审批、生命周期管理、制度检索
    -   协作关系：BC-35完成制度编写后，提交到BC-37进行发布审批和版本管理

## 4.7 消费侧B BC定义

### 4.7.1 BC-20 知识消费

+   BC定义如下表所示

    | 属性       | 内容                                                       |
    | ---------- | ---------------------------------------------------------- |
    | BC编号     | BC-20                                                      |
    | BC名称     | 知识消费（Knowledge Consumption）                          |
    | 所属域     | 知识消费域                                                 |
    | 核心职责   | 知识检索、图谱浏览、模板下载、个人知识库、付费转化         |
    | 范围内     | 智能搜索、图谱浏览、模板下载、收藏管理、配额管控、转化引导 |
    | 范围外     | 知识中台数据管理（BC-40/BC-41）                            |
    | 上游依赖   | BC-40 知识实体、BC-41 知识图谱、BC-10 用户管理             |
    | 下游被依赖 | 无                                                         |
    | 服务角色   | UC-01 知识访客、UC-02 专业个人                             |

    表 4.7.1-1 BC-20定义

+   **说明**：BC-20的个人用户（UC用户群）由BC-10用户管理上下文统一管理

## 4.8 通用域BC定义

### 4.8.1 BC-10 用户管理

+   BC定义如下表所示

    | 属性       | 内容                                                                                    |
    | ---------- | --------------------------------------------------------------------------------------- |
    | BC编号     | BC-10                                                                                   |
    | BC名称     | 用户管理（Identity and Access Management, IAM）                                         |
    | 所属域     | 用户管理域                                                                              |
    | 核心职责   | 统一身份认证、用户管理、权限管理、组织架构、审计日志                                    |
    | 范围内     | 用户CRUD、登录认证、Token管理、SSO/LDAP集成、角色权限、组织岗位、审计                   |
    | 范围外     | 租户生命周期管理（BC-11）、租户数据库创建（BC-11）、业务数据权限                        |
    | 上游依赖   | 无（基础服务）                                                                          |
    | 下游被依赖 | BC-51~BC-34, BC-11, BC-35（OHS模式）                                                    |
    | 服务角色   | 所有21个直接用户角色（UP-01~09、UR-01~10、UC-01~02）                                    |
    | 所属微服务 | svc-iam                                                                                 |
    | 所属数据库 | clarisphere_platform（UP）、clarisphere_<tenant_code>（UR）、clarisphere_consumer（UC） |

    表 4.8.1-1 BC-10定义

+   BC-10包含四个子领域，如下表所示

    | 子领域   | 英文名称       | 核心职责                                   |
    | -------- | -------------- | ------------------------------------------ |
    | 用户管理 | User           | 用户生命周期、账号信息、组织架构、岗位人员 |
    | 认证管理 | Authentication | 身份验证、凭证管理、Token签发、会话管理    |
    | 授权管理 | Authorization  | 角色定义、权限分配、功能权限、数据权限     |
    | 审计管理 | Audit          | 登录日志、操作日志、安全事件               |
    | 配置管理 | Configuration  | 平台配置、租户配置、配置热更新、配置审计   |
    | 字典管理 | Dictionary     | 系统码表、业务枚举、多语言标签、字典缓存   |

    表 4.8.1-2 BC-10子领域划分

+   BC-10核心能力如下表所示

    | 能力       | 说明                                                            | 对应基础性需求 |
    | ---------- | --------------------------------------------------------------- | -------------- |
    | 用户管理   | 用户注册、信息维护、状态管理、账号注销、用户与人员分离设计      | FD-01          |
    | 多用户群   | 支持UP（运营用户群）、UR（租户用户群）、UC（C端用户群）三类用户 | FD-01          |
    | 认证方式   | 本地认证（账密+MFA）、SSO单点登录（OAuth2/OIDC）、LDAP认证      | FD-01/07       |
    | Token管理  | JWT签发、刷新Token、Token黑名单、会话管理、并发控制             | FD-01          |
    | 角色权限   | RBAC+ABAC混合模型、预置角色与自定义角色、功能权限+数据权限      | FD-02          |
    | 组织架构   | 部门管理、岗位管理、人员管理、汇报关系                          | FD-01          |
    | 审计日志   | 登录日志、操作日志、安全事件、日志查询导出、日志防篡改          | FD-04          |
    | 系统配置   | 平台级配置、租户级配置、配置热更新、配置审计                    | FD-05          |
    | 数据字典   | 系统码表管理、业务枚举定义、多语言标签                          | FD-10          |
    | 多租户隔离 | 租户级数据隔离、动态数据源路由、租户上下文传递                  | FD-03          |
    | 密码策略   | 密码复杂度、有效期、历史密码检查，各用户群差异化配置            | FD-01          |

    表 4.8.1-3 BC-10核心能力

+   BC-10与BC-11的协作关系如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                    BC-10与BC-11协作关系                                    │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────┐      ┌──────────────────────────┐            │
    │  │ BC-11 租户管理           │      │ BC-10 用户管理           │            │
    │  │                          │      │                          │            │
    │  │ • 租户生命周期管理       │      │ • 用户认证与授权         │            │
    │  │ • 租户数据库创建/删除    │      │ • 用户账号管理           │            │
    │  │ • 数据源连接池管理       │      │ • 角色权限模型           │            │
    │  │ • 租户环境配置           │      │ • 组织架构管理           │            │
    │  │ • AD/LDAP用户同步        │      │ • 审计日志               │            │
    │  │                          │      │ • 租户IAM表初始化        │            │
    │  └────────────┬─────────────┘      └──────────────▲───────────┘            │
    │               │                                   │                        │
    │               │ 4. 调用IAM表初始化接口            │                        │
    │               └───────────────────────────────────┘                        │
    │                                                                            │
    │  租户开通流程：                                                            │
    │  1. BC-11：创建租户记录                                                    │
    │  2. BC-11：创建租户数据库                                                  │
    │  3. BC-11：创建并注册数据源连接池                                          │
    │  4. BC-11 → BC-10：调用IAM表初始化接口                                     │
    │  5. BC-10：创建IAM表结构、初始化预置角色和权限、创建租户管理员             │
    │  6. BC-11：更新租户状态为"已初始化"                                        │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.8.1-1 BC-10与BC-11协作关系

### 4.8.2 BC-11 租户管理

+   BC定义如下表所示

    | 属性       | 内容                                                            |
    | ---------- | --------------------------------------------------------------- |
    | BC编号     | BC-11                                                           |
    | BC名称     | 租户管理（Tenant Management）                                   |
    | 所属域     | 租户管理域                                                      |
    | 核心职责   | 租户生命周期管理，包括开通、配置、数据源、计费、停用            |
    | 范围内     | 租户开通、租户配置、数据源管理、订阅管理、计费账单、AD/LDAP同步 |
    | 范围外     | 用户认证授权（BC-10）、租户业务数据（BC-31~BC-34, BC-35）       |
    | 上游依赖   | 无                                                              |
    | 下游被依赖 | BC-53 运营分发、BC-10 用户管理、BC-35 租户落地、所有消费侧A BC  |
    | 服务角色   | UP-06 租户运营员                                                |
    | 所属微服务 | svc-tenant                                                      |

    表 4.8.2-1 BC-11定义

+   BC-11核心能力如下表所示

    | 能力        | 说明                                           | 对应需求 |
    | ----------- | ---------------------------------------------- | -------- |
    | 租户开通    | 租户创建、租户信息维护、租户状态管理           | FD-06    |
    | 数据库管理  | 租户数据库创建、删除、备份恢复                 | FD-06    |
    | 数据源管理  | 连接池创建、销毁、动态路由注册                 | FD-03    |
    | 租户配置    | 邮箱域名、SSO配置、LDAP配置、功能开关          | FD-06    |
    | 订阅管理    | 订阅计划、功能模块订阅                         | FD-06    |
    | 计费账单    | 计费规则、账单生成、支付对接（V3.0）           | -        |
    | AD/LDAP同步 | 从企业目录同步用户到租户数据库                 | FD-07    |
    | 数据导出    | 租户数据导出为标准格式（JSON/Excel），支持加密 | FD-13    |
    | 数据导入    | 从标准格式导入租户数据，支持增量/全量模式      | FD-13    |
    | 租户迁移    | 跨环境租户数据迁移，支持SaaS→私有化场景        | FD-13    |

    表 4.8.2-2 BC-11核心能力

### 4.8.3 BC-12 消息通知

+   BC定义如下表所示

    | 属性       | 内容                                                   |
    | ---------- | ------------------------------------------------------ |
    | BC编号     | BC-12                                                  |
    | BC名称     | 消息通知（Notification）                               |
    | 所属域     | 消息通知域                                             |
    | 核心职责   | 统一消息通知，支持多渠道推送                           |
    | 范围内     | 站内信、邮件、短信、企业微信、钉钉、消息模板、消息订阅 |
    | 范围外     | 业务事件产生（各业务BC）                               |
    | 上游依赖   | 无                                                     |
    | 下游被依赖 | 所有业务BC                                             |
    | 服务角色   | 所有角色                                               |
    | 所属微服务 | svc-notify                                             |

    表 4.8.3-1 BC-12定义

+   BC-12核心能力如下表所示

    | 能力     | 说明                           | 对应基础性需求 |
    | -------- | ------------------------------ | -------------- |
    | 站内信   | 系统通知、业务提醒、待办通知   | FD-08          |
    | 邮件通知 | 邮件模板、SMTP配置、发送记录   | FD-08          |
    | 短信通知 | 短信模板、渠道对接、发送记录   | FD-08          |
    | 企业微信 | 企业微信应用消息、机器人消息   | FD-08          |
    | 消息订阅 | 用户订阅偏好、免打扰设置       | FD-08          |
    | 消息模板 | 模板定义、变量替换、多语言支持 | FD-08          |

    表 4.8.3-2 BC-12核心能力

### 4.8.4 BC-13 文件管理

+   BC定义如下表所示

    | 属性       | 内容                                             |
    | ---------- | ------------------------------------------------ |
    | BC编号     | BC-13                                            |
    | BC名称     | 文件管理（File Management）                      |
    | 所属域     | 文件管理域                                       |
    | 核心职责   | 统一文件管理，上传下载与版本控制                 |
    | 范围内     | 文件上传、文件下载、文件预览、版本管理、文件分类 |
    | 范围外     | 业务附件关联（各业务BC）                         |
    | 上游依赖   | 无                                               |
    | 下游被依赖 | BC-51 内容采集、BC-32 验证检查、BC-20 知识消费   |
    | 服务角色   | 所有角色                                         |
    | 所属微服务 | svc-file                                         |

    表 4.8.4-1 BC-13定义

+   BC-13核心能力如下表所示

    | 能力     | 说明                                   | 对应基础性需求 |
    | -------- | -------------------------------------- | -------------- |
    | 文件上传 | 分片上传、断点续传、格式校验、大小限制 | FD-09          |
    | 文件下载 | 范围下载、下载限速、下载记录           | FD-09          |
    | 文件预览 | Office预览、PDF预览、图片预览          | FD-09          |
    | 版本管理 | 文件版本历史、版本回滚、版本对比       | FD-09          |
    | 文件分类 | 业务分类、标签管理、目录结构           | FD-09          |
    | 安全控制 | 访问权限、病毒扫描、敏感词检测         | FD-09          |

    表 4.8.4-2 BC-13核心能力

# 5 上下文映射

+   本章定义限界上下文之间的协作关系和集成模式

## 5.1 上下文映射模式

+   BC之间的集成采用以下映射模式

    | 模式         | 英文                  | 适用场景                                |
    | ------------ | --------------------- | --------------------------------------- |
    | 合作关系     | Partnership           | 两个BC紧密协作，共同演进                |
    | 共享内核     | Shared Kernel         | 两个BC共享部分模型，需同步变更          |
    | 客户-供应商  | Customer-Supplier     | 下游BC依赖上游BC，上游优先满足下游需求  |
    | 遵奉者       | Conformist            | 下游BC完全遵从上游BC的模型，无议价能力  |
    | 防腐层       | Anti-Corruption Layer | 下游BC通过转换层隔离上游BC的模型差异    |
    | 开放主机服务 | Open Host Service     | 上游BC提供标准化API，支持多个下游BC接入 |
    | 发布语言     | Published Language    | 定义标准的数据交换格式                  |
    | 各行其道     | Separate Ways         | BC之间无直接集成，独立演进              |

    表 5.1-1 上下文映射模式

## 5.2 上下文映射全景图

+   15个BC之间的映射关系如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                       上下文映射全景图                                     │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌─────────────────────────── 供给侧 ───────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌──────────┐  CS/OHS  ┌──────────┐  CS/OHS  ┌──────────┐            │  │
    │  │  │ BC-51    │─────────▶│ BC-52    │─────────▶│ BC-53    │            │  │
    │  │  │ 内容采集 │          │ 知识工程 │          │ 运营分发 │            │  │
    │  │  └──────────┘          └────┬─────┘          └────┬─────┘            │  │
    │  │                             │                     │                  │  │
    │  └─────────────────────────────┼─────────────────────┼──────────────────┘  │
    │                                │ CS/OHS              │ CS/OHS              │
    │                                ▼                     ▼                     │
    │  ┌─────────────────────────── 知识中台 ─────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌────────────────────┐  SK   ┌────────────────────┐                 │  │
    │  │  │ BC-40              │◀─────▶│ BC-41              │                 │  │
    │  │  │ 知识实体（6库）    │       │ 知识图谱（3图）    │                 │  │
    │  │  └─────────┬──────────┘       └─────────┬──────────┘                 │  │
    │  │            │                            │                            │  │
    │  └────────────┼────────────────────────────┼────────────────────────────┘  │
    │               │ OHS                        │ OHS                           │
    │               ▼                            ▼                               │
    │  ┌─────────────────────────── 消费侧A ──────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌──────────┐         ┌──────────┐         ┌──────────┐              │  │
    │  │  │ BC-35    │  CS     │ BC-31    │  CS     │ BC-32    │              │  │
    │  │  │ 租户落地 │────────▶│ 合规管理 │◀───────▶│ 验证检查 │              │  │
    │  │  └────┬─────┘         └────┬─────┘         └────┬─────┘              │  │
    │  │       │                    │                    │                    │  │
    │  │       │   ┌────────────────┼────────────────┐   │                    │  │
    │  │       │   ▼                ▼                ▼   ▼                    │  │
    │  │       │  ┌──────────┐ ┌──────────┐ ┌──────────┐                      │  │
    │  │       │  │ BC-33    │ │ BC-34    │ │ BC-36    │                      │  │
    │  │       │  │ 治理监督 │ │ 风险管理 │ │ 安全管理 │                      │  │
    │  │       │  └──────────┘ └──────────┘ └──────────┘                      │  │
    │  │       │       ▲                         ▲                            │  │
    │  │       │       └─────────────────────────┘ CS                         │  │
    │  │       │                                                              │  │
    │  └───────┼──────────────────────────────────────────────────────────────┘  │
    │          │ ACL                                                             │
    │          ▼                                                                 │
    │  ┌─────────────────────────── 消费侧B ──────────────────────────────────┐  │
    │  │  ┌──────────────────────────────────────────────────────────────┐    │  │
    │  │  │ BC-20 知识消费                                               │    │  │
    │  │  └──────────────────────────────────────────────────────────────┘    │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌─────────────────────────── 通用域 ───────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌────────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐     │  │
    │  │  │ BC-10          │ │ BC-11      │ │ BC-12      │ │ BC-13      │     │  │
    │  │  │ 用户管理       │ │ 租户管理   │ │ 消息通知   │ │ 文件管理   │     │  │
    │  │  │ (认证+授权+    │ │            │ │            │ │            │     │  │
    │  │  │  组织+审计)    │ │            │ │            │ │            │     │  │
    │  │  └────────────────┘ └────────────┘ └────────────┘ └────────────┘     │  │
    │  │                                                                      │  │
    │  │  所有业务BC通过OHS依赖通用域BC                                       │  │
    │  │                                                                      │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  图例：CS=客户-供应商  OHS=开放主机服务  SK=共享内核  ACL=防腐层           │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2-1 上下文映射全景图

## 5.3 核心映射关系定义

### 5.3.1 供给侧内部映射

+   供给侧BC之间的映射关系如下表所示

    | 上游BC         | 下游BC         | 映射模式    | 集成方式 | 说明                       |
    | -------------- | -------------- | ----------- | -------- | -------------------------- |
    | BC-51 内容采集 | BC-52 知识工程 | 客户-供应商 | 异步消息 | 采集完成后通知知识工程处理 |
    | BC-52 知识工程 | BC-53 运营分发 | 客户-供应商 | 异步消息 | 发布审核通过后通知运营分发 |
    | BC-52 知识工程 | BC-40 知识实体 | 客户-供应商 | 同步API  | 知识工程写入6库节点数据    |
    | BC-52 知识工程 | BC-41 知识图谱 | 客户-供应商 | 同步API  | 知识工程写入3图关系数据    |

    表 5.3.1-1 供给侧内部映射

### 5.3.2 知识中台内部映射

+   知识中台BC之间的映射关系如下表所示

    | 上游BC         | 下游BC         | 映射模式 | 集成方式 | 说明                         |
    | -------------- | -------------- | -------- | -------- | ---------------------------- |
    | BC-40 知识实体 | BC-41 知识图谱 | 共享内核 | 内部调用 | 共享节点ID，图谱引用实体属性 |
    | BC-41 知识图谱 | BC-40 知识实体 | 共享内核 | 内部调用 | 图谱查询时获取节点详细属性   |

    表 5.3.2-1 知识中台内部映射

+   **共享内核（Shared Kernel）详细说明**：

    BC-40与BC-41采用共享内核模式，共享内容如下表所示

    | 共享类型   | 共享内容                                  | 变更协调机制                 |
    | ---------- | ----------------------------------------- | ---------------------------- |
    | 共享实体ID | 6库节点ID（外规ID、要求点ID、控制点ID等） | 任何ID生成规则变更需双方确认 |
    | 共享枚举   | 节点状态枚举（草稿/已发布/已废弃）        | 枚举值变更需同步修改两个BC   |
    | 共享DTO    | 节点基础信息DTO（ID、名称、状态、版本）   | DTO字段变更需双方同步发布    |
    | 共享事件   | 节点变更事件（KnowledgeNodeChanged）      | 事件格式变更需双方确认兼容性 |

    表 5.3.2-2 BC-40与BC-41共享内核内容

+   **共享内核版本协调机制**：
    -   共享内核代码独立为公共模块（knowledge-shared）
    -   任何共享内核变更需要BC-40和BC-41团队双方评审
    -   共享内核版本采用语义化版本号，MAJOR版本变更需同步发布
    -   共享内核变更需在两个BC的集成测试中同时验证

### 5.3.3 知识中台与消费侧映射

+   知识中台与消费侧之间的映射关系如下表所示

    | 上游BC         | 下游BC         | 映射模式     | 集成方式 | 说明                         |
    | -------------- | -------------- | ------------ | -------- | ---------------------------- |
    | BC-40 知识实体 | BC-31 合规管理 | 开放主机服务 | 同步API  | 提供要求点、控制点查询服务   |
    | BC-40 知识实体 | BC-32 验证检查 | 开放主机服务 | 同步API  | 提供验证规则查询服务         |
    | BC-40 知识实体 | BC-35 租户落地 | 开放主机服务 | 同步API  | 提供标准场景点、控制点查询   |
    | BC-40 知识实体 | BC-20 知识消费 | 开放主机服务 | 同步API  | 提供知识检索服务（配额管控） |
    | BC-41 知识图谱 | BC-31 合规管理 | 开放主机服务 | 同步API  | 提供追溯路径、影响分析服务   |
    | BC-41 知识图谱 | BC-35 租户落地 | 开放主机服务 | 同步API  | 提供合规包订阅、映射模板服务 |
    | BC-41 知识图谱 | BC-20 知识消费 | 开放主机服务 | 同步API  | 提供图谱浏览服务（深度限制） |
    | BC-53 运营分发 | BC-35 租户落地 | 客户-供应商  | 异步消息 | 推送订阅内容增量更新         |

    表 5.3.3-1 知识中台与消费侧映射

+   **BC-31与BC-35双向协作说明**：

    BC-31（合规管理）与BC-35（租户落地）存在双向数据依赖，协作关系如下表所示

    | 数据流向      | 协作场景         | 数据内容                | 集成方式 |
    | ------------- | ---------------- | ----------------------- | -------- |
    | BC-35 → BC-31 | 新规应对差距分析 | 租户现有制度数据        | 同步API  |
    | BC-35 → BC-31 | 制度追溯查询     | 租户制度与外规关联数据  | 同步API  |
    | BC-31 → BC-35 | 制度编写依据     | 外规要求点、控制点推荐  | 同步API  |
    | BC-31 → BC-35 | 差距整改建议     | 需要补充的制度/控制建议 | 同步API  |

    表 5.3.3-2 BC-31与BC-35协作关系

### 5.3.4 消费侧A内部映射

+   消费侧A BC之间的映射关系如下表所示

    | 上游BC         | 下游BC         | 映射模式    | 集成方式     | 说明                           |
    | -------------- | -------------- | ----------- | ------------ | ------------------------------ |
    | BC-35 租户落地 | BC-31 合规管理 | 客户-供应商 | 同步API      | 提供租户场景、控制、制度数据   |
    | BC-35 租户落地 | BC-32 验证检查 | 客户-供应商 | 同步API      | 提供租户资产、配置数据         |
    | BC-35 租户落地 | BC-36 安全管理 | 客户-供应商 | 同步API      | 提供安全策略基础配置和模板     |
    | BC-31 合规管理 | BC-32 验证检查 | 合作关系    | 同步API+事件 | 合规评估触发验证，验证结果回写 |
    | BC-31 合规管理 | BC-33 治理监督 | 客户-供应商 | 同步API      | 提供合规状态数据供驾驶舱展示   |
    | BC-31 合规管理 | BC-36 安全管理 | 客户-供应商 | 同步API      | 合规要求关联安全策略           |
    | BC-32 验证检查 | BC-31 合规管理 | 合作关系    | 异步事件     | 验证结果事件通知合规状态更新   |
    | BC-32 验证检查 | BC-33 治理监督 | 客户-供应商 | 同步API      | 提供验证结果供审计检查         |
    | BC-32 验证检查 | BC-36 安全管理 | 客户-供应商 | 异步事件     | 验证失败触发安全事件           |
    | BC-31 合规管理 | BC-34 风险管理 | 客户-供应商 | 同步API      | 合规差距转化为风险项           |
    | BC-32 验证检查 | BC-34 风险管理 | 客户-供应商 | 异步事件     | 验证失败触发风险登记           |
    | BC-34 风险管理 | BC-33 治理监督 | 客户-供应商 | 同步API      | 提供风险数据供驾驶舱展示       |
    | BC-34 风险管理 | BC-36 安全管理 | 客户-供应商 | 同步API      | 提供风险数据供安全态势分析     |
    | BC-36 安全管理 | BC-33 治理监督 | 客户-供应商 | 同步API      | 提供安全态势数据供驾驶舱展示   |

    表 5.3.4-1 消费侧A内部映射

### 5.3.5 通用域映射

+   通用域BC与业务BC之间的映射关系如下表所示

    | 上游BC         | 下游BC         | 映射模式     | 集成方式 | 说明                             |
    | -------------- | -------------- | ------------ | -------- | -------------------------------- |
    | BC-10 用户管理 | 所有业务BC     | 开放主机服务 | 同步API  | 提供认证、授权、用户信息查询服务 |
    | BC-10 用户管理 | BC-35 租户落地 | 客户-供应商  | 同步API  | 提供组织架构（部门、岗位、人员） |
    | BC-11 租户管理 | BC-53 运营分发 | 客户-供应商  | 同步API  | 提供租户订阅信息                 |
    | BC-11 租户管理 | BC-10 用户管理 | 客户-供应商  | 同步API  | 租户开通时调用IAM初始化接口      |
    | BC-11 租户管理 | 消费侧A所有BC  | 开放主机服务 | 同步API  | 提供租户上下文、数据源路由       |
    | BC-12 消息通知 | 所有业务BC     | 开放主机服务 | 异步消息 | 接收消息发送请求                 |
    | BC-13 文件管理 | 所有业务BC     | 开放主机服务 | 同步API  | 提供文件上传下载服务             |

    表 5.3.5-1 通用域映射

+   **BC-10与BC-11协作说明**：
    -   BC-11租户管理负责租户生命周期管理（开通、配置、计费）
    -   BC-10用户管理负责IAM能力（用户、认证、授权、组织、审计）
    -   租户开通流程：BC-11创建租户数据库 → BC-11调用BC-10初始化IAM表 → BC-10创建预置角色和管理员
    -   组织架构数据由BC-10管理，BC-35租户落地通过API获取用于责任映射

## 5.4 集成方式说明

### 5.4.1 同步API集成

+   同步API集成适用于实时性要求高的场景
+   技术实现方案如下表所示

    | 技术要素 | 选型                      |
    | -------- | ------------------------- |
    | 通信协议 | HTTP/HTTPS + RESTful      |
    | 数据格式 | JSON                      |
    | 服务发现 | Nacos                     |
    | 负载均衡 | Spring Cloud LoadBalancer |
    | 熔断降级 | Sentinel                  |
    | 超时控制 | 默认3秒，可配置           |
    | 重试策略 | 幂等接口最多重试2次       |

    表 5.4.1-1 同步API技术方案

### 5.4.2 异步消息集成

+   异步消息集成适用于解耦和削峰场景
+   技术实现方案如下表所示

    | 技术要素   | 选型                          |
    | ---------- | ----------------------------- |
    | 消息中间件 | RocketMQ / Kafka              |
    | 消息格式   | JSON + CloudEvents规范        |
    | 消息可靠性 | 至少一次投递（At Least Once） |
    | 消费模式   | 集群消费                      |
    | 死信处理   | 死信队列 + 人工干预           |
    | 消息追踪   | 消息ID + TraceId关联          |

    表 5.4.2-1 异步消息技术方案

### 5.4.3 事件驱动集成

+   事件驱动集成适用于BC间状态变更通知
+   核心领域事件定义如下表所示

    | 事件名称              | 发布BC | 订阅BC              | 事件说明         | 对应场景/Epic     |
    | --------------------- | ------ | ------------------- | ---------------- | ----------------- |
    | RegulationCollected   | BC-51  | BC-52               | 外规采集完成     | SC-CP-01/EP-CP-01 |
    | KnowledgePublished    | BC-52  | BC-53, BC-40, BC-41 | 知识发布审核通过 | SC-CP-05/EP-CP-05 |
    | SubscriptionUpdated   | BC-53  | BC-35               | 订阅内容增量更新 | SC-CP-07/EP-CP-07 |
    | ComplianceAssessed    | BC-31  | BC-32, BC-33        | 合规评估完成     | SC-CM-04/EP-CM-04 |
    | VerificationCompleted | BC-32  | BC-31, BC-33, BC-34 | 验证检查完成     | SC-EX-02/EP-EX-02 |
    | VerificationFailed    | BC-32  | BC-36               | 验证失败触发事件 | SC-EX-02/EP-SM-02 |
    | RiskIdentified        | BC-34  | BC-33, BC-36        | 新风险识别       | SC-RM-01/EP-RM-01 |
    | TenantCreated         | BC-11  | BC-53, BC-10, BC-35 | 租户开通完成     | SC-CP-06/EP-CP-06 |
    | OrganizationChanged   | BC-10  | BC-35, BC-36        | 组织架构变更     | FD-01（组织架构） |
    | RegulationChanged     | BC-51  | BC-31, BC-53        | 外规版本变更     | SC-CM-05/EP-CM-05 |
    | RemediationCompleted  | BC-32  | BC-31, BC-33        | 整改闭环完成     | SC-EX-03/EP-EX-03 |
    | AuditFindingCreated   | BC-33  | BC-32               | 审计发现问题     | SC-AU-01/EP-AU-01 |
    | SecurityEventCreated  | BC-36  | BC-33, BC-34        | 安全事件创建     | SC-SM-02/EP-SM-02 |
    | SecurityEventClosed   | BC-36  | BC-33               | 安全事件闭环     | SC-SM-02/EP-SM-02 |
    | SecurityPolicyChanged | BC-36  | BC-32, BC-35        | 安全策略变更     | SC-SM-01/EP-SM-01 |

    表 5.4.3-1 核心领域事件

## 5.5 防腐层设计

+   以下场景需要设计防腐层（ACL）

### 5.5.1 消费侧B防腐层

+   BC-20知识消费与知识中台之间设置防腐层
+   防腐层职责如下表所示

    | 职责     | 说明                                                    |
    | -------- | ------------------------------------------------------- |
    | 配额校验 | 在调用知识中台API前校验UC用户配额                       |
    | 结果裁剪 | 根据用户类型（UC-01知识访客/UC-02专业用户）裁剪返回数据 |
    | 深度限制 | UC-01知识访客图谱浏览限制2层，UC-02专业用户不限制       |
    | 下载限制 | UC-01知识访客每日下载配额3次，UC-02专业用户按订阅配额   |
    | 模型转换 | 将知识中台模型转换为消费侧B简化模型                     |

    表 5.5.1-1 消费侧B防腐层职责

### 5.5.2 租户落地防腐层

+   BC-35租户落地与知识中台之间设置防腐层
+   防腐层职责如下表所示

    | 职责     | 说明                                   |
    | -------- | -------------------------------------- |
    | 订阅过滤 | 根据租户订阅范围过滤知识中台数据       |
    | 模型映射 | 将标准模型映射为租户私有模型           |
    | 增量同步 | 处理知识中台增量更新，合并到租户私有库 |
    | 版本兼容 | 处理知识中台版本升级的兼容性问题       |

    表 5.5.2-1 租户落地防腐层职责

## 5.6 数据一致性策略

+   跨BC的数据一致性采用最终一致性模型
+   一致性策略如下表所示

    | 场景          | 一致性要求 | 实现策略                         |
    | ------------- | ---------- | -------------------------------- |
    | 知识发布      | 最终一致   | 发布事件 + 异步同步 + 补偿机制   |
    | 租户订阅同步  | 最终一致   | 增量推送 + 版本号校验 + 全量重建 |
    | 合规评估-验证 | 最终一致   | 双向事件 + 状态机 + 超时告警     |
    | 组织架构变更  | 最终一致   | 变更事件 + 异步通知 + 缓存刷新   |
    | 审计日志      | 最终一致   | 异步写入 + 本地缓存 + 批量提交   |

    表 5.6-1 数据一致性策略

## 5.7 BC间调用矩阵

+   BC间调用关系矩阵如下表所示（行为调用方，列为被调用方）

    | 调用方＼被调用方 | BC-40 | BC-41 | BC-31 | BC-32 | BC-33 | BC-34 | BC-35 | BC-36 | BC-10 | BC-11 | BC-12 | BC-13 |
    | ---------------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
    | BC-51 内容采集   |       |       |       |       |       |       |       |       | ✓     |       |       | ✓     |
    | BC-52 知识工程   | ✓     | ✓     |       |       |       |       |       |       | ✓     |       |       |       |
    | BC-53 运营分发   | ✓     | ✓     |       |       |       |       |       |       | ✓     | ✓     | ✓     |       |
    | BC-31 合规管理   | ✓     | ✓     |       | ✓     |       |       | ✓     | ✓     | ✓     |       | ✓     |       |
    | BC-32 验证检查   | ✓     |       | ✓     |       |       |       | ✓     | ✓     | ✓     |       | ✓     | ✓     |
    | BC-33 治理监督   |       |       | ✓     | ✓     |       | ✓     |       | ✓     | ✓     |       | ✓     |       |
    | BC-34 风险管理   |       |       | ✓     | ✓     |       |       |       | ✓     | ✓     |       | ✓     |       |
    | BC-36 安全管理   |       |       | ✓     | ✓     | ✓     | ✓     | ✓     |       | ✓     |       | ✓     |       |
    | BC-20 知识消费   | ✓     | ✓     |       |       |       |       |       |       | ✓     |       |       |       |
    | BC-35 租户落地   | ✓     | ✓     |       |       |       |       |       |       | ✓     | ✓     |       | ✓     |

    表 5.7-1 BC间调用矩阵

+   **矩阵说明**：
    -   BC-10用户管理：被所有业务BC调用，提供认证、授权、用户信息、组织架构服务
    -   BC-11租户管理：被BC-53运营分发、BC-35租户落地调用，提供租户上下文
    -   BC-12消息通知：被需要发送通知的BC调用
    -   BC-13文件管理：被需要文件上传下载的BC调用
    -   BC-40/BC-41：作为知识中台核心，被消费侧BC广泛调用
    -   BC-36安全管理：统一承载EP-SM-01~03，与BC-32/BC-34/BC-35协作，向BC-33提供安全态势数据

# 6 微服务架构

+   本章定义透管云的微服务划分、服务职责和部署规划

## 6.1 微服务划分原则

+   微服务划分遵循以下原则

    | 原则     | 说明                                                   |
    | -------- | ------------------------------------------------------ |
    | BC对齐   | 原则上一个BC对应一个或多个微服务，不跨BC拆分           |
    | 单一职责 | 每个微服务聚焦单一业务能力                             |
    | 独立部署 | 每个微服务可独立构建、测试、部署                       |
    | 数据自治 | 每个微服务拥有独立的数据存储，不直接访问其他服务数据库 |
    | 适度拆分 | 避免过度拆分导致分布式复杂度过高                       |

    表 6.1-1 微服务划分原则

## 6.2 微服务全景图

+   透管云共规划24个微服务
+   微服务全景图如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         透管云微服务全景图                                 │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ BFF层（5个）                                                         │  │
    │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │
    │  │  │ bff-     │ │ bff-     │ │ bff-     │ │ bff-     │ │ bff-     │    │  │
    │  │  │governance│ │designer  │ │workspace │ │provider  │ │knowledge │    │  │
    │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘    │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 供给侧服务（4个）                                                    │  │
    │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │  │
    │  │  │ svc-       │ │ svc-       │ │ svc-       │ │ svc-       │         │  │
    │  │  │ content-   │ │ engineer   │ │ publish    │ │ operate    │         │  │
    │  │  │ collect    │ │            │ │            │ │            │         │  │
    │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 知识中台服务（3个）                                                  │  │
    │  │  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐      │  │
    │  │  │ svc-knowledge-   │ │ svc-knowledge-   │ │ svc-search-      │      │  │
    │  │  │ entity           │ │ graph            │ │ engine           │      │  │
    │  │  └──────────────────┘ └──────────────────┘ └──────────────────┘      │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 消费侧A服务（7个）                                                   │  │
    │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │  │
    │  │  │svc-    │ │svc-    │ │svc-    │ │svc-    │ │svc-    │ │svc-    │   │  │
    │  │  │compli- │ │verify  │ │evidence│ │gover-  │ │risk    │ │tenant- │   │  │
    │  │  │ance    │ │        │ │        │ │nance   │ │        │ │deploy  │   │  │
    │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘   │  │
    │  │  ┌────────┐                                                          │  │
    │  │  │svc-    │                                                          │  │
    │  │  │security│                                                          │  │
    │  │  └────────┘                                                          │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 消费侧B服务（1个）                                                   │  │
    │  │  ┌────────────────────────┐                                          │  │
    │  │  │ svc-knowledge-consumer │                                          │  │
    │  │  └────────────────────────┘                                          │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 通用域服务（4个）                                                    │  │
    │  │  ┌────────────────┐ ┌────────┐ ┌────────┐ ┌────────┐                 │  │
    │  │  │ svc-iam        │ │svc-    │ │svc-    │ │svc-    │                 │  │
    │  │  │ (用户+认证+    │ │tenant  │ │notify  │ │file    │                 │  │
    │  │  │  授权+组织+    │ │        │ │        │ │        │                 │  │
    │  │  │  审计)         │ │        │ │        │ │        │                 │  │
    │  │  └────────────────┘ └────────┘ └────────┘ └────────┘                 │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2-1 透管云微服务全景图

## 6.3 微服务清单

+   24个微服务的清单如下表所示

    | 服务编号 | 服务名称               | 所属BC | 服务职责                           | 对应需求                      |
    | -------- | ---------------------- | ------ | ---------------------------------- | ----------------------------- |
    | SVC-01   | bff-governance         | -      | 治理监督BFF，聚合决策层接口        | EP-DC-01/02, EP-AU-*, EP-SM-* |
    | SVC-02   | bff-designer           | -      | 设计规划BFF，聚合架构制度接口      | EP-PL-01, EP-BD-*             |
    | SVC-03   | bff-workspace          | -      | 作业执行BFF，聚合任务执行接口      | EP-EX-*, EP-CM-*              |
    | SVC-04   | bff-provider           | -      | 供给侧BFF，聚合内容生产接口        | EP-CP-01~09                   |
    | SVC-05   | bff-knowledge          | -      | 知识消费BFF，聚合知识检索接口      | EP-KC-01~04                   |
    | SVC-06   | svc-content-collect    | BC-51  | 内容采集服务，外规采集与变更监测   | EP-CP-01                      |
    | SVC-07   | svc-engineer           | BC-52  | 知识工程服务，架构维护解析映射质检 | EP-CP-02~05                   |
    | SVC-08   | svc-publish            | BC-52  | 发布管理服务，版本控制与发布审批   | EP-CP-05                      |
    | SVC-09   | svc-operate            | BC-53  | 运营分发服务，租户分发与运营监控   | EP-CP-06~09                   |
    | SVC-10   | svc-knowledge-entity   | BC-40  | 知识实体服务，6库节点CRUD          | EP-CP-02~05内嵌               |
    | SVC-11   | svc-knowledge-graph    | BC-41  | 知识图谱服务，3图关系与合规包      | EP-CP-02~05内嵌               |
    | SVC-12   | svc-search-engine      | BC-41  | 智能检索服务，全文与向量检索       | EP-CP-02~05内嵌               |
    | SVC-13   | svc-compliance         | BC-31  | 合规管理服务，评估与差距分析       | EP-CM-01~07                   |
    | SVC-14   | svc-verify             | BC-32  | 验证检查服务，规则执行与持续监测   | EP-EX-01~03                   |
    | SVC-15   | svc-evidence           | BC-32  | 证据采集服务，多源采集与证据链     | EP-EX-02                      |
    | SVC-16   | svc-governance         | BC-33  | 治理监督服务，驾驶舱与审计         | EP-DC-01/02, EP-AU-01~03      |
    | SVC-17   | svc-risk               | BC-34  | 风险管理服务，识别评估与应对       | EP-RM-01~03                   |
    | SVC-18   | svc-iam                | BC-10  | 用户管理服务，认证授权组织审计配置 | FD-01/02/04/05/07/10          |
    | SVC-19   | svc-tenant             | BC-11  | 租户管理服务，租户生命周期与数据源 | FD-03/06                      |
    | SVC-20   | svc-knowledge-consumer | BC-20  | 知识消费服务，搜索浏览下载转化     | EP-KC-01~04                   |
    | SVC-21   | svc-tenant-deploy      | BC-35  | 租户落地服务，场景映射与岗位分配   | EP-PL-01, EP-BD-01~03         |
    | SVC-22   | svc-notify             | BC-12  | 消息通知服务，多渠道推送           | FD-08                         |
    | SVC-23   | svc-file               | BC-13  | 文件管理服务，上传下载预览版本     | FD-09                         |
    | SVC-24   | svc-security           | BC-36  | 安全管理服务，策略事件运营应急     | EP-SM-01~03                   |

    表 6.3-1 微服务清单

## 6.4 核心微服务详细设计

### 6.4.1 SVC-10 知识实体服务

+   服务详细设计如下表所示

    | 属性     | 内容                                                          |
    | -------- | ------------------------------------------------------------- |
    | 服务名称 | svc-knowledge-entity                                          |
    | 所属BC   | BC-40 知识实体                                                |
    | 核心职责 | 管理6库节点数据，提供节点CRUD、批量查询、版本管理服务         |
    | 技术栈   | Spring Boot 3.x + Spring Data Elasticsearch                   |
    | 数据存储 | Elasticsearch（6库节点主存储）、MySQL（版本元数据、配置数据） |
    | 接口协议 | RESTful API + gRPC（内部高性能调用）                          |
    | 部署实例 | 2-4个                                                         |

    表 6.4.1-1 知识实体服务设计

### 6.4.2 SVC-11 知识图谱服务

+   服务详细设计如下表所示

    | 属性     | 内容                                        |
    | -------- | ------------------------------------------- |
    | 服务名称 | svc-knowledge-graph                         |
    | 所属BC   | BC-41 知识图谱                              |
    | 核心职责 | 管理3图关系、合规包仓库、图谱遍历、影响分析 |
    | 技术栈   | Spring Boot 3.x + Spring Data Neo4j         |
    | 数据存储 | Neo4j（3图关系边）、MySQL（合规包元数据）   |
    | 接口协议 | RESTful API + GraphQL（复杂图查询）         |
    | 部署实例 | 2-3个                                       |

    表 6.4.2-1 知识图谱服务设计

### 6.4.3 SVC-13 合规管理服务

+   服务详细设计如下表所示

    | 属性     | 内容                                                                           |
    | -------- | ------------------------------------------------------------------------------ |
    | 服务名称 | svc-compliance                                                                 |
    | 所属BC   | BC-31 合规管理                                                                 |
    | 核心职责 | 新规应对、制度追溯、合规总览、合规评估、差距分析、外规订阅、检查应对、持续监测 |
    | 技术栈   | Spring Boot 3.x + MyBatis-Plus                                                 |
    | 数据存储 | MySQL（租户Schema隔离）                                                        |
    | 接口协议 | RESTful API                                                                    |
    | 部署实例 | 2-4个                                                                          |

    表 6.4.3-1 合规管理服务设计

### 6.4.4 SVC-18 用户管理服务（IAM）

+   服务详细设计如下表所示

    | 属性       | 内容                                                                           |
    | ---------- | ------------------------------------------------------------------------------ |
    | 服务名称   | svc-iam                                                                        |
    | 所属BC     | BC-10 用户管理                                                                 |
    | 核心职责   | 用户管理、身份认证、权限授权、组织架构、审计日志、系统配置                     |
    | 技术栈     | Spring Boot 3.x + MyBatis-Plus + Sa-Token                                      |
    | 数据存储   | MySQL（clarisphere_platform、clarisphere_<tenant_code>、clarisphere_consumer） |
    | 接口协议   | RESTful API                                                                    |
    | 部署实例   | 3-4个                                                                          |
    | 微服务端口 | 8084                                                                           |

    表 6.4.4-1 用户管理服务设计

+   SVC-18包含四个子领域模块，如下表所示

    | 子领域模块 | 模块职责                                     | 对应基础性需求 |
    | ---------- | -------------------------------------------- | -------------- |
    | 用户管理   | 用户CRUD、密码管理、状态管理、用户与人员分离 | FD-01          |
    | 认证管理   | 登录认证、MFA、Token签发/刷新/撤销、会话管理 | FD-01/07       |
    | 授权管理   | 角色管理、权限管理、角色分配、数据权限       | FD-02          |
    | 组织管理   | 部门管理、岗位管理、人员管理、汇报关系       | FD-01          |
    | 审计管理   | 登录日志、操作日志、安全事件、日志查询导出   | FD-04          |
    | 配置管理   | 平台配置、租户配置、配置热更新、配置审计     | FD-05          |
    | 字典管理   | 字典类型、字典条目、字典缓存、前端组件集成   | FD-10          |

    表 6.4.4-2 SVC-18子领域模块

+   **字典管理模块详细设计**：

    | 能力项       | 能力描述                                          |
    | ------------ | ------------------------------------------------- |
    | 字典类型管理 | 系统字典/业务字典分类，支持层级结构               |
    | 字典条目管理 | 条目CRUD、排序、启用/禁用、父子关系               |
    | 字典缓存     | Redis缓存字典数据，支持按租户隔离，变更时自动刷新 |
    | 多语言支持   | 字典标签支持多语言，与FD-14国际化需求联动         |
    | 前端组件集成 | 提供标准API供前端下拉框、级联选择器等组件调用     |
    | 字典引用检查 | 删除/禁用字典前检查业务数据引用，防止数据不一致   |

    表 6.4.4-3 字典管理模块能力

### 6.4.5 SVC-24 安全管理服务

+   服务详细设计如下表所示

    | 属性     | 内容                                                   |
    | -------- | ------------------------------------------------------ |
    | 服务名称 | svc-security                                           |
    | 所属BC   | BC-36 安全管理                                         |
    | 核心职责 | 安全策略管理、安全事件管理、安全运营监控、应急响应管理 |
    | 技术栈   | Spring Boot 3.x + MyBatis-Plus                         |
    | 数据存储 | MySQL（租户Schema隔离）                                |
    | 接口协议 | RESTful API                                            |
    | 部署实例 | 2-3个                                                  |

    表 6.4.5-1 安全管理服务设计

+   SVC-24核心模块如下表所示

    | 模块名称     | 模块职责                                       | 对应Epic    |
    | ------------ | ---------------------------------------------- | ----------- |
    | 安全策略模块 | 安全策略制定、发布、版本管理，策略与控制点关联 | EP-SM-01    |
    | 安全事件模块 | 安全事件采集、分类、响应处置、闭环跟踪         | EP-SM-02    |
    | 安全监控模块 | 安全态势感知、安全指标监控、安全趋势分析       | EP-SM-03    |
    | 应急响应模块 | 应急预案管理、应急演练、事件升级、恢复跟踪     | EP-SM-01~03 |
    | SIEM集成模块 | 对接企业SIEM/SOC系统，统一安全事件源           | EP-SM-02    |

    表 6.4.5-2 安全管理服务核心模块

+   **SVC-24与其他服务的协作关系**：
    -   SVC-14（svc-verify）：接收验证失败事件，创建安全事件
    -   SVC-17（svc-risk）：获取风险数据，支撑安全态势分析；安全事件可能产生新的风险项
    -   SVC-21（svc-tenant-deploy）：获取安全策略基础配置和模板
    -   SVC-16（svc-governance）：提供安全态势数据，供治理驾驶舱展示
    -   SVC-22（svc-notify）：安全事件触发告警通知

## 6.5 BFF层设计

### 6.5.1 BFF设计原则

+   BFF层设计遵循以下原则

    | 原则     | 说明                                          |
    | -------- | --------------------------------------------- |
    | 场景聚合 | 按用户场景聚合后端服务接口，减少前端调用次数  |
    | 数据裁剪 | 根据前端需要裁剪返回数据，减少网络传输        |
    | 协议适配 | 处理前端特有的协议需求，如WebSocket、文件上传 |
    | 缓存优化 | 对高频查询进行本地缓存，提升响应速度          |
    | 权限过滤 | 根据当前用户角色过滤返回数据和功能入口        |

    表 6.5.1-1 BFF设计原则

### 6.5.2 BFF与角色映射

+   5个BFF与21个角色的映射关系如下表所示

    | BFF服务        | 服务角色                                                           | 交互特征 | 核心场景                       |
    | -------------- | ------------------------------------------------------------------ | -------- | ------------------------------ |
    | bff-governance | UR-01 CISO、UR-07 风险经理、UR-08 审计人员                         | 决策驱动 | SC-DC-01/02、SC-AU-01、SC-RM-* |
    | bff-designer   | UR-02 安全架构师、UR-03 制度编写者、UR-04 方案制定者               | 强交互   | SC-PL-01、SC-BD-01/02/03       |
    | bff-workspace  | UR-05 落地执行人、UR-06 合规经理、UR-09 安全经理、UR-10 制度管理员 | 流程驱动 | SC-EX-*、SC-CM-*、SC-SM-*      |
    | bff-provider   | UP-01~UP-09（供给侧9个角色）                                       | 批量处理 | SC-CP-01~09                    |
    | bff-knowledge  | UC-01 知识访客、UC-02 专业用户                                     | 检索密集 | SC-KC-01~04                    |

    表 6.5.2-1 BFF与角色映射

## 6.6 服务部署规划

### 6.6.1 服务分组与实例规划

+   微服务按重要性分组，规划部署实例数如下表所示

    | 服务分组   | 包含服务                                       | 最小实例 | 生产实例 |
    | ---------- | ---------------------------------------------- | -------- | -------- |
    | 核心服务组 | svc-knowledge-entity, svc-knowledge-graph      | 2        | 4        |
    | 核心服务组 | svc-compliance, svc-verify                     | 2        | 4        |
    | 业务服务组 | svc-governance, svc-risk, svc-tenant-deploy    | 2        | 3        |
    | 业务服务组 | svc-content-collect, svc-engineer, svc-publish | 2        | 3        |
    | 通用服务组 | svc-iam, svc-tenant                            | 3        | 4        |
    | 通用服务组 | svc-notify, svc-file                           | 2        | 2        |
    | BFF服务组  | bff-governance, bff-designer, bff-workspace    | 2        | 3        |
    | BFF服务组  | bff-provider, bff-knowledge                    | 2        | 4        |

    表 6.6.1-1 服务实例规划

### 6.6.2 服务资源配置

+   微服务资源配置建议如下表所示

    | 服务类型     | CPU请求 | CPU限制 | 内存请求 | 内存限制 |
    | ------------ | ------- | ------- | -------- | -------- |
    | BFF服务      | 500m    | 2000m   | 512Mi    | 2Gi      |
    | 核心业务服务 | 500m    | 2000m   | 1Gi      | 4Gi      |
    | 普通业务服务 | 250m    | 1000m   | 512Mi    | 2Gi      |
    | 通用域服务   | 250m    | 1000m   | 512Mi    | 2Gi      |

    表 6.6.2-1 服务资源配置

## 6.7 服务治理

### 6.7.1 服务注册与发现

+   服务注册与发现采用Nacos
+   配置要点如下表所示

    | 配置项   | 配置值                              |
    | -------- | ----------------------------------- |
    | 注册中心 | Nacos 2.x集群                       |
    | 服务分组 | 按环境分组（dev/test/staging/prod） |
    | 健康检查 | TCP端口检查，间隔5秒                |
    | 元数据   | 版本号、部署时间、实例标签          |

    表 6.7.1-1 服务注册配置

### 6.7.2 服务熔断与降级

+   服务熔断降级采用Sentinel
+   策略配置如下表所示

    | 策略类型 | 配置说明                                   |
    | -------- | ------------------------------------------ |
    | 熔断策略 | 慢调用比例>50%且响应时间>1s，触发熔断5秒   |
    | 熔断策略 | 异常比例>50%，触发熔断5秒                  |
    | 降级策略 | 核心服务降级返回缓存数据                   |
    | 降级策略 | 非核心服务降级返回默认值或空               |
    | 限流策略 | 按QPS限流，核心接口1000QPS，普通接口500QPS |

    表 6.7.2-1 熔断降级策略

### 6.7.3 服务链路追踪

+   服务链路追踪采用SkyWalking
+   追踪范围如下表所示

    | 追踪类型 | 追踪内容         |
    | -------- | ---------------- |
    | HTTP调用 | 所有REST API调用 |
    | RPC调用  | gRPC内部调用     |
    | 数据库   | MySQL、Neo4j查询 |
    | 缓存     | Redis操作        |
    | 消息队列 | Kafka生产消费    |

    表 6.7.3-1 链路追踪范围

# 7 技术选型

+   本章定义透管云的技术栈选型及选型依据

## 7.1 技术选型原则

+   技术选型遵循以下原则

    | 原则       | 说明                                         |
    | ---------- | -------------------------------------------- |
    | 团队熟悉   | 优先选择团队熟悉的技术栈，降低学习成本       |
    | 生态成熟   | 优先选择生态成熟、社区活跃的技术             |
    | 国产化友好 | 考虑国产化替代需求，避免强依赖海外商业软件   |
    | 云原生     | 优先选择云原生技术，支持容器化部署和弹性扩展 |
    | 成本可控   | 优先选择开源或低成本方案，控制技术成本       |

    表 7.1-1 技术选型原则

## 7.2 技术全景图

+   透管云技术全景图如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         透管云技术全景图                                   │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 前端技术                                                             │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │
    │  │ │ Vue 3  │ │ Arco   │ │ Pinia  │ │ Axios  │ │ G6/D3  │ │ Uni-App│    │  │
    │  │ │        │ │ Design │ │        │ │        │ │ 图可视 │ │ 移动端 │    │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 后端框架                                                             │  │
    │  │ ┌────────┐ ┌─────────┐ ┌────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐ │  │
    │  │ │ Spring │ │ Spring  │ │ MyBatis│ │ Spring  │ │ Sa-     │ │ Hutool │ │  │
    │  │ │ Boot 3 │ │ Cloud   │ │ Plus   │ │ Security│ │ Token   │ │        │ │  │
    │  │ └────────┘ └─────────┘ └────────┘ └─────────┘ └─────────┘ └────────┘ │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 数据存储                                                             │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │
    │  │ │ MySQL  │ │ Neo4j  │ │ Elastic│ │ Redis  │ │ MinIO  │ │ Rocket │    │  │
    │  │ │ 8.0    │ │ 5.x    │ │ search │ │ 7.x    │ │        │ │ MQ     │    │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 微服务治理                                                           │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐               │  │
    │  │ │ Nacos  │ │Sentinel│ │ Sky    │ │ Seata  │ │ APISIX │               │  │
    │  │ │ 注册   │ │ 熔断   │ │ Walking│ │ 分布式 │ │ 网关   │               │  │
    │  │ │ 配置   │ │ 限流   │ │ 链路   │ │ 事务   │ │        │               │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ DevOps与基础设施                                                     │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │  │
    │  │ │ K8s    │ │ Docker │ │ GitLab │ │Jenkins │ │Prometh-│ │ Grafana│    │  │
    │  │ │        │ │        │ │ CI/CD  │ │        │ │ eus    │ │        │    │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘    │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ AI与智能化                                                           │  │
    │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐                          │  │
    │  │ │ HanLP  │ │ BERT   │ │ FAISS  │ │ Paddle │                          │  │
    │  │ │ NLP    │ │ 语义   │ │ 向量   │ │ OCR    │                          │  │
    │  │ └────────┘ └────────┘ └────────┘ └────────┘                          │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2-1 透管云技术全景图

## 7.3 前端技术选型

+   前端技术选型如下表所示

    | 技术领域   | 选型        | 版本 | 选型理由                            |
    | ---------- | ----------- | ---- | ----------------------------------- |
    | 框架       | Vue 3       | 3.4+ | 团队熟悉，生态成熟，Composition API |
    | UI组件库   | Arco Design | 2.x  | 字节出品，企业级组件丰富，设计美观  |
    | 状态管理   | Pinia       | 2.x  | Vue 3官方推荐，TypeScript友好       |
    | HTTP客户端 | Axios       | 1.x  | 生态成熟，拦截器灵活                |
    | 图可视化   | AntV G6     | 5.x  | 阿里出品，知识图谱可视化能力强      |
    | 图表       | ECharts     | 5.x  | 开源免费，图表类型丰富              |
    | 富文本     | WangEditor  | 5.x  | 开源免费，功能完善                  |
    | 移动端     | Uni-App     | 3.x  | 跨端开发，支持App、小程序、H5       |
    | 构建工具   | Vite        | 5.x  | 构建速度快，开发体验好              |

    表 7.3-1 前端技术选型

## 7.4 后端技术选型

+   后端技术选型如下表所示

    | 技术领域     | 选型                 | 版本   | 选型理由                    |
    | ------------ | -------------------- | ------ | --------------------------- |
    | 基础框架     | Spring Boot          | 3.2+   | 企业级标准，生态完善        |
    | 微服务框架   | Spring Cloud         | 2023.x | 与Spring Boot配套，组件丰富 |
    | 微服务框架   | Spring Cloud Alibaba | 2023.x | 阿里组件集成，国产化友好    |
    | ORM框架      | MyBatis-Plus         | 3.5+   | 简化开发，代码生成          |
    | 图数据库驱动 | Spring Data Neo4j    | 7.x    | 与Spring生态集成            |
    | 安全框架     | Spring Security      | 6.x    | 企业级安全标准              |
    | 认证框架     | Sa-Token             | 1.37+  | 国产轻量级，功能完善        |
    | 工具库       | Hutool               | 5.8+   | 国产工具库，功能全面        |
    | JSON处理     | Jackson              | 2.16+  | Spring默认，性能好          |
    | API文档      | Knife4j              | 4.x    | Swagger增强，界面美观       |

    表 7.4-1 后端技术选型

## 7.5 数据存储选型

+   数据存储选型如下表所示

    | 技术领域   | 选型          | 版本 | 选型理由                             |
    | ---------- | ------------- | ---- | ------------------------------------ |
    | 关系数据库 | MySQL         | 8.0+ | 稳定可靠，团队熟悉，国产化可替换TiDB |
    | 图数据库   | Neo4j         | 5.x  | 图查询性能优秀，Cypher语言成熟       |
    | 搜索引擎   | Elasticsearch | 8.x  | 全文检索标准，向量检索支持           |
    | 缓存       | Redis         | 7.x  | 高性能，数据结构丰富                 |
    | 对象存储   | MinIO         | 最新 | S3兼容，私有化友好                   |
    | 消息队列   | Kafka         | 3.x  | 高吞吐量，生态成熟，分布式可靠       |
    | 时序数据库 | TDengine      | 3.x  | 可选，用于监控指标存储，国产化       |

    表 7.5-1 数据存储选型

+   **Neo4j引入时机说明**：

    | 阶段  | 3图存储方案         | 说明                                   |
    | ----- | ------------------- | -------------------------------------- |
    | P1-P2 | MySQL关联表         | 使用MySQL存储3图关系，满足MVP验证需求  |
    | P3    | 引入Neo4j，数据迁移 | 完成3图从MySQL到Neo4j的迁移            |
    | P4+   | Neo4j为主存储       | 充分发挥图数据库的图遍历和路径分析能力 |

    表 7.5-2 Neo4j引入时机

+   **技术决策说明**：
    -   P1-P2阶段3图关系相对简单（节点数<10万，关系数<50万），MySQL可满足性能需求
    -   P3阶段随着数据规模增长和六链查询复杂度提升，引入Neo4j以获得更好的图遍历性能
    -   迁移方案：双写过渡期 → 数据校验 → 切换读流量 → 下线MySQL图表

+   数据存储职责分工

    | 存储引擎      | 存储内容                                       | 访问模式   |
    | ------------- | ---------------------------------------------- | ---------- |
    | MySQL         | 合规包元数据、版本管理、业务数据、租户私有数据 | OLTP读写   |
    | Neo4j         | 3图关系边、路径查询                            | 图遍历查询 |
    | Elasticsearch | 6库节点全量数据（主存储）、向量索引、知识检索  | 全文检索   |
    | Redis         | 会话缓存、热点数据、配额计数器、分布式锁       | 高频读写   |
    | MinIO         | 外规原文件、证据附件、导出文件                 | 大文件存取 |
    | Kafka         | 领域事件、异步任务、日志采集                   | 消息传递   |

    表 7.5-3 数据存储职责分工

## 7.6 微服务治理选型

+   微服务治理选型如下表所示

    | 技术领域   | 选型         | 版本 | 选型理由                       |
    | ---------- | ------------ | ---- | ------------------------------ |
    | API网关    | APISIX       | 3.x  | 高性能，插件丰富，国产化       |
    | 注册中心   | Nacos        | 2.x  | 阿里出品，注册配置一体         |
    | 配置中心   | Nacos        | 2.x  | 与注册中心统一，降低运维复杂度 |
    | 熔断限流   | Sentinel     | 1.8+ | 阿里出品，功能完善，控制台友好 |
    | 链路追踪   | SkyWalking   | 9.x  | 国产化，APM能力强              |
    | 分布式事务 | Seata        | 2.x  | 阿里出品，AT模式简单           |
    | 服务调用   | OpenFeign    | 4.x  | 声明式调用，与Spring Cloud集成 |
    | 负载均衡   | LoadBalancer | 4.x  | Spring Cloud官方，替代Ribbon   |

    表 7.6-1 微服务治理选型

## 7.7 DevOps与基础设施选型

+   DevOps与基础设施选型如下表所示

    | 技术领域   | 选型         | 版本  | 选型理由                     |
    | ---------- | ------------ | ----- | ---------------------------- |
    | 容器运行时 | Docker       | 24.x  | 容器化标准                   |
    | 容器编排   | Kubernetes   | 1.28+ | 云原生标准                   |
    | CI/CD      | GitLab CI    | 最新  | 与GitLab集成，Pipeline功能强 |
    | CI/CD      | Jenkins      | 最新  | 可选，传统CI/CD工具          |
    | 制品仓库   | Harbor       | 2.x   | Docker镜像仓库，企业级       |
    | 监控       | Prometheus   | 2.x   | 云原生监控标准               |
    | 可视化     | Grafana      | 10.x  | 监控可视化标准               |
    | 日志       | ELK Stack    | 8.x   | 日志收集分析标准             |
    | 告警       | AlertManager | 0.26+ | Prometheus配套告警           |

    表 7.7-1 DevOps与基础设施选型

## 7.8 AI与智能化选型

+   AI与智能化选型如下表所示

    | 技术领域   | 选型         | 版本 | 选型理由                       |
    | ---------- | ------------ | ---- | ------------------------------ |
    | NLP引擎    | HanLP        | 2.x  | 国产化，中文处理能力强         |
    | 语义模型   | BERT         | -    | 语义理解，条款相似度计算       |
    | 大语言模型 | ChatGLM/通义 | -    | 可选，国产大模型，外规解读辅助 |
    | 向量检索   | FAISS        | 最新 | Facebook出品，高性能向量检索   |
    | OCR        | PaddleOCR    | 最新 | 百度出品，国产化，识别率高     |
    | 文档解析   | Apache Tika  | 2.x  | 多格式文档解析                 |

    表 7.8-1 AI与智能化选型

+   AI能力用于辅助外规解析、智能推荐等场景
+   AI技术选型如下表所示

    | 能力场景 | P1-P2方案          | P5+方案            | 说明                       |
    | -------- | ------------------ | ------------------ | -------------------------- |
    | 外规解析 | 规则引擎+人工审核  | LLM辅助+人工确认   | P1以人工为主，P5引入AI辅助 |
    | 智能推荐 | 基于标签的协同过滤 | 向量相似度+LLM排序 | P1简单推荐，P5深度推荐     |
    | 问答交互 | 关键词检索+FAQ     | RAG+LLM对话        | P1检索为主，P5对话式交互   |
    | 风险预测 | 规则引擎+统计模型  | ML模型+异常检测    | P1规则预警，P5智能预测     |

    表 7.x-1 AI能力技术选型

+   **P1阶段AI策略**：
    -   外规解析（EP-CP-03）：采用规则引擎提取结构化信息，人工审核确认
    -   智能推荐：基于行业标签和场景标签的简单协同过滤
    -   不依赖外部大模型API，降低P1阶段技术复杂度和成本

+   **P5阶段AI规划**：
    -   引入向量数据库（如Milvus）支撑语义检索
    -   集成LLM API（如通义千问/文心一言）辅助外规解析和智能问答
    -   部署ML模型进行风险预测和异常检测

## 7.9 技术选型矩阵

+   技术选型按P1-P6版本的引入计划如下表所示

    | 技术          | P1  | P2  | P3  | P4  | P5  | P6  | 说明                 |
    | ------------- | --- | --- | --- | --- | --- | --- | -------------------- |
    | Vue 3         | ✓   |     |     |     |     |     | 首版即用             |
    | Spring Boot 3 | ✓   |     |     |     |     |     | 首版即用             |
    | MySQL         | ✓   |     |     |     |     |     | 首版即用             |
    | Neo4j         |     |     | ✓   |     |     |     | 知识图谱核心         |
    | Elasticsearch | ✓   |     |     |     |     |     | 全文检索核心         |
    | Redis         | ✓   |     |     |     |     |     | 缓存必需             |
    | Nacos         | ✓   |     |     |     |     |     | 服务治理基础         |
    | APISIX        |     | ✓   |     |     |     |     | P2引入网关           |
    | Sentinel      |     | ✓   |     |     |     |     | P2引入熔断限流       |
    | SkyWalking    |     | ✓   |     |     |     |     | P2引入链路追踪       |
    | Kafka         |     | ✓   |     |     |     |     | P2引入消息队列       |
    | Seata         |     |     | ✓   |     |     |     | P3按需引入分布式事务 |
    | FAISS         |     |     |     | ✓   |     |     | P4引入向量检索       |
    | ChatGLM       |     |     |     |     | ✓   |     | P5引入AI增强         |

    表 7.9-1 技术引入计划

## 7.10 技术风险与应对

+   技术选型风险与应对措施如下表所示

    | 风险项                | 风险等级 | 应对措施                            |
    | --------------------- | -------- | ----------------------------------- |
    | Neo4j社区版功能限制   | 中       | 预研NebulaGraph作为备选，接口层抽象 |
    | Elasticsearch许可变更 | 低       | 预研OpenSearch作为备选              |
    | 大模型API稳定性       | 中       | 本地部署ChatGLM，降低对外部API依赖  |
    | 国产化替代要求        | 中       | MySQL可替换TiDB，中间件选国产方案   |
    | 技术栈升级兼容性      | 低       | 制定升级计划，充分测试后灰度发布    |

    表 7.10-1 技术风险与应对

+   **Neo4j社区版功能限制详细说明**：

    | 功能限制       | 社区版现状   | 对透管云的影响                 | 应对策略                         |
    | -------------- | ------------ | ------------------------------ | -------------------------------- |
    | 集群模式       | 不支持       | 无法水平扩展，存在单点故障风险 | P1-P3采用主从复制，P4+评估企业版 |
    | 热备份         | 不支持       | 备份期间需停机或只读           | 业务低峰期执行备份，控制停机窗口 |
    | 在线索引创建   | 不支持       | 索引变更需停机                 | 版本发布窗口统一执行DDL          |
    | 细粒度访问控制 | 不支持       | 无法按角色限制图数据访问       | 应用层实现数据权限过滤           |
    | 多数据库       | 支持（4.0+） | 无影响                         | -                                |

    表 7.10-2 Neo4j社区版功能限制

+   **切换到NebulaGraph的触发条件**：
    -   单节点查询QPS持续超过1000且无法通过读写分离缓解
    -   图数据节点数超过1000万且深度遍历（>3层）响应时间超过5秒
    -   客户明确要求国产化数据库
    -   Neo4j许可政策变更导致商业风险

# 8 数据架构

+   本章定义透管云的数据架构设计，包括数据分布策略、数据模型概览和数据治理

## 8.1 数据架构原则

+   数据架构遵循以下原则

    | 原则               | 说明                                                       | 对应架构决策/基础需求 |
    | ------------------ | ---------------------------------------------------------- | --------------------- |
    | 单一数据源         | 知识中台作为合规知识的唯一数据源（Single Source of Truth） | AD-01 双边平台架构    |
    | ES为6库主存储      | 需要全文搜索的6库数据以ES为主存储，避免MySQL→ES同步复杂度  | AD-02 多模态存储      |
    | 3图分阶段存储      | P1-P2阶段3图存MySQL，P3起引入Neo4j存储复杂图关系           | AD-02 多模态存储      |
    | ES Index级隔离     | 6库各库独立ES Index，租户制度库等租户数据也使用独立Index   | AD-02 多模态存储      |
    | 租户数据Schema隔离 | 消费侧A租户业务数据采用MySQL Schema级别隔离                | AD-03 多租户隔离      |
    | IAM三库隔离        | UP/UR/UC三用户群采用独立数据库存储                         | FD-01/03              |
    | 读写分离           | 知识中台采用CQRS模式，优化读写性能                         | AD-02 多模态存储      |
    | 数据版本化         | 核心数据支持版本管理，支持历史追溯                         | -                     |
    | 审计数据不可篡改   | 审计日志只增不改不删，支持日志归档                         | FD-04                 |

    表 8.1-1 数据架构原则

+   **3图分阶段存储的设计理由**：
    -   P1-P2阶段关系较简单，MySQL的关联表足以支撑，无需引入Neo4j复杂度
    -   P3起引入Neo4j，用于复杂图谱遍历、路径推演、影响分析等场景
    -   采用渐进式引入策略，降低早期版本的技术风险和运维成本

+   **ES为主存储的设计理由**：
    -   6库数据的核心访问模式是全文搜索（外规检索、控制点搜索、要求点匹配等）
    -   若采用MySQL为主存储+同步ES的方案，会引入数据一致性、同步延迟、双写复杂度等问题
    -   ES原生支持版本管理、分词搜索、向量检索，更适合知识库场景
    -   MySQL仅用于存储元数据、配置数据和需要事务保障的业务数据

+   **ES作为主存储的数据一致性保障**：
    -   **写入策略**：采用同步写入（wait_for_active_shards=1），确保至少一个副本写入成功
    -   **失败重试**：写入失败时采用指数退避重试策略（最多3次，间隔1s/2s/4s）
    -   **补偿机制**：重试仍失败时写入死信队列，由定时任务异步补偿
    -   **版本控制**：利用ES乐观锁（_version）防止并发写入冲突
    -   **元数据同步**：合规包元数据同时写入MySQL和ES，MySQL作为事务源，ES通过事件异步同步
    -   **一致性校验**：定时任务比对MySQL元数据与ES数据的一致性，发现差异自动修复

## 8.2 数据分布全景图

+   透管云数据分布全景如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         透管云数据分布全景图                               │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     知识中台数据（全局共享）                         │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │              Elasticsearch（6库主存储，Index级隔离）            │ │  │
    │  │  │  ┌───────────┐ ┌───────────┐ ┌────────────┐ ┌───────────┐       │ │  │
    │  │  │  │idx_reg    │ │idx_require│ │idx_scenario│ │idx_control│       │ │  │
    │  │  │  │外规库     │ │要求点库   │ │场景点库    │ │控制点库   │       │ │  │
    │  │  │  │(主存储)   │ │(主存储)   │ │(主存储)    │ │(主存储)   │       │ │  │
    │  │  │  └───────────┘ └───────────┘ └────────────┘ └───────────┘       │ │  │
    │  │  │  ┌───────────┐ ┌───────────┐                                    │ │  │
    │  │  │  │idx_rule   │ │idx_resp   │                                    │ │  │
    │  │  │  │验证规则库 │ │责任点库   │                                    │ │  │
    │  │  │  │(主存储)   │ │(主存储)   │                                    │ │  │
    │  │  │  └───────────┘ └───────────┘                                    │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │              MySQL（元数据+配置+P1-P2阶段3图关系）              │ │  │
    │  │  │  ┌────────────┐ ┌───────────┐ ┌───────────┐                     │ │  │
    │  │  │  │t_package   │ │t_version  │ │t_relation │                     │ │  │
    │  │  │  │合规包元数据│ │版本管理   │ │3图关系    │                     │ │  │
    │  │  │  │            │ │           │ │(P1-P2)    │                     │ │  │
    │  │  │  └────────────┘ └───────────┘ └───────────┘                     │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │              Neo4j（P3起引入，3图关系）                         │ │  │
    │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │ │  │
    │  │  │  │ REQUIRES    │ │ MAPS_TO     │ │ ASSIGNS     │                │ │  │
    │  │  │  │ 外规→要求   │ │ 要求→控制   │ │ 控制→责任   │                │ │  │
    │  │  │  │ (P3起)      │ │ (P3起)      │ │ (P3起)      │                │ │  │
    │  │  │  └─────────────┘ └─────────────┘ └─────────────┘                │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     租户私有数据                                     │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │          MySQL - Schema: clarisphere_<tenant_code>              │ │  │
    │  │  │  ┌─────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │  │
    │  │  │  │t_asset  │ │t_mapping│ │t_assess  │ │t_evidence│ │t_remediat│ │ │  │
    │  │  │  │租户资产 │ │租户映射 │ │合规评估  │ │证据数据  │ │整改数据  │ │ │  │
    │  │  │  └─────────┘ └─────────┘ └──────────┘ └──────────┘ └──────────┘ │ │  │
    │  │  │  ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │ │  │
    │  │  │  │t_org_*  │ │t_position│ │t_employee│ │t_iam_*   │             │ │  │
    │  │  │  │组织架构 │ │岗位      │ │人员      │ │IAM数据   │             │ │  │
    │  │  │  └─────────┘ └──────────┘ └──────────┘ └──────────┘             │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │          Elasticsearch - Index: idx_<tenant_code>_policy        │ │  │
    │  │  │  ┌───────────────────────┐                                      │ │  │
    │  │  │  │租户制度库（全文检索） │                                      │ │  │
    │  │  │  └───────────────────────┘                                      │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     平台与个人用户数据                               │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │          MySQL - Schema: clarisphere_platform                   │ │  │
    │  │  │  ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐              │ │  │
    │  │  │  │t_tenant │ │t_iam_*   │ │t_config  │ │t_audit_*│              │ │  │
    │  │  │  │租户信息 │ │UP用户IAM │ │系统配置  │ │审计日志 │              │ │  │
    │  │  │  └─────────┘ └──────────┘ └──────────┘ └─────────┘              │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
    │  │  │          MySQL - Schema: clarisphere_consumer                   │ │  │
    │  │  │  ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐              │ │  │
    │  │  │  │t_uc_user│ │t_bookmark│ │t_download│ │t_quota  │              │ │  │
    │  │  │  │UC用户   │ │收藏记录  │ │下载记录  │ │配额使用 │              │ │  │
    │  │  │  └─────────┘ └──────────┘ └──────────┘ └─────────┘              │ │  │
    │  │  └─────────────────────────────────────────────────────────────────┘ │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     共用数据（全局）                                 │  │
    │  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐               │  │
    │  │  │ Redis         │ │ MinIO         │ │ Kafka         │               │  │
    │  │  │ 会话/缓存/锁  │ │ 文件/附件     │ │ 事件/消息     │               │  │
    │  │  └───────────────┘ └───────────────┘ └───────────────┘               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.2-1 透管云数据分布全景图

+   **数据存储策略说明**：

    | 数据类型     | 主存储引擎     | 辅助存储      | 说明                                     | 对应BC/需求     |
    | ------------ | -------------- | ------------- | ---------------------------------------- | --------------- |
    | 6库知识数据  | Elasticsearch  | -             | 全文搜索为主要访问模式，ES为唯一存储     | BC-40           |
    | 3图关系数据  | MySQL（P1-P2） | Neo4j（P3起） | 渐进式引入，降低早期复杂度               | BC-41           |
    | 合规包元数据 | MySQL          | -             | 需要事务保障                             | BC-41           |
    | 租户业务数据 | MySQL          | -             | Schema级隔离                             | BC-31~35        |
    | 租户制度数据 | MySQL + ES     | -             | MySQL为主，ES用于全文检索（Index隔离）   | BC-35           |
    | IAM数据      | MySQL          | -             | 三库隔离：UP平台库、UR租户库、UC消费者库 | BC-10, FD-01/03 |
    | 审计日志     | MySQL + ES     | -             | MySQL为主存储，ES用于高效查询            | BC-10, FD-04    |
    | 系统配置     | MySQL          | -             | 平台配置和租户配置分层存储               | BC-10, FD-05    |
    | 会话与缓存   | Redis          | -             | Token、会话、热点缓存、配额计数          | BC-10, FD-01    |
    | 文件与附件   | MinIO          | -             | 对象存储，支持版本控制                   | BC-13, FD-09    |
    | 消息队列     | RocketMQ/Kafka | -             | 事件消息、异步通知                       | BC-12, FD-08    |

    表 8.2-1 数据存储策略

+   **IAM数据三库隔离设计**：

    | 用户群 | 数据库Schema         | 存储内容                | 说明                 |
    | ------ | -------------------- | ----------------------- | -------------------- |
    | UP     | clarisphere_platform | 平台运营用户的IAM数据   | 平台运营方的内部用户 |
    | UR     | clarisphere_<tenant> | 租户用户的IAM数据       | 每个租户独立数据库   |
    | UC     | clarisphere_consumer | 个人消费者用户的IAM数据 | 独立的C端用户库      |

    表 8.2-2 IAM数据三库隔离设计

+   **说明**：此设计与宏观需求FD-03多租户架构中的"用户数据存储架构"（表6.2.3-4）保持一致

## 8.3 知识中台数据模型

### 8.3.1 6库数据模型（Elasticsearch为主存储）

+   6库以Elasticsearch为主存储引擎，采用Index级别隔离
+   6库ES Index设计概览如下表所示

    | Index名称       | 所属库     | 用途说明                         | 分片数 | 数据规模 |
    | --------------- | ---------- | -------------------------------- | ------ | -------- |
    | idx_regulation  | 外规库     | 外规元数据与全文内容存储         | 3      | 2000+    |
    | idx_clause      | 外规库     | 外规条款结构化存储               | 3      | -        |
    | idx_requirement | 要求点库   | 要求点内容与来源追溯             | 5      | 50000+   |
    | idx_scenario    | 场景点库   | 场景定义与行业标签               | 3      | 20000+   |
    | idx_control     | 控制点库   | 控制措施与实施指引               | 5      | 100000+  |
    | idx_rule        | 验证规则库 | 验证规则表达式与适配器配置       | 3      | 10000+   |
    | idx_resp        | 责任点库   | 控制点+场景+RACISV角色的责任分配 | 3      | 动态生成 |

    表 8.3.1-1 6库ES Index设计

+   **ES存储设计说明**：
    -   采用IK分词器支持中文全文检索
    -   keyword类型用于精确匹配、排序、聚合
    -   text类型用于全文检索
    -   分片数根据数据规模预估设置，后续可动态调整
    -   每个Index配置1个副本，保障高可用

### 8.3.2 3图关系模型（分阶段存储）

+   3图采用分阶段存储策略：P1-P2阶段使用MySQL关联表，P3起引入Neo4j

#### 8.3.2.1 P1-P2阶段：MySQL关联表

+   3图关系在P1-P2阶段使用MySQL关联表存储，表结构如下

    | 关系类型        | 说明                 |
    | --------------- | -------------------- |
    | 外规条款-要求点 | 条款对应哪些要求点   |
    | 要求点-场景点   | 要求点适用哪些场景   |
    | 要求点-控制点   | 要求点映射哪些控制点 |
    | 控制点-场景点   | 控制点适用哪些场景   |
    | 控制点-责任点   | 控制点的责任分配     |
    | 控制点-验证规则 | 控制点对应的验证规则 |

    表 8.3.2-1 P1-P2阶段3图关系表

+   **P1-P2阶段设计理由**：
    -   早期关系较简单，JOIN查询可满足需求
    -   避免引入Neo4j增加技术栈复杂度
    -   降低早期版本的运维成本

#### 8.3.2.2 P3起：Neo4j图数据库

+   P3起引入Neo4j存储复杂图关系，关系类型定义如下表所示

    | 关系类型    | 起点类型         | 终点类型       | 属性                     | 使用场景       |
    | ----------- | ---------------- | -------------- | ------------------------ | -------------- |
    | CONTAINS    | Regulation       | Clause         | sort_order               | 外规结构遍历   |
    | REQUIRES    | Clause           | Requirement    | relevance_score          | 要求点追溯     |
    | APPLIES_TO  | Requirement      | Scenario       | -                        | 场景匹配       |
    | MAPS_TO     | Requirement      | Control        | mapping_type, confidence | 双向追溯       |
    | IMPLEMENTS  | Control          | Scenario       | -                        | 控制点适用场景 |
    | ASSIGNS     | Control+Scenario | Responsibility | racisv_role              | 责任分配       |
    | VERIFIED_BY | Control          | VerifyRule     | -                        | 验证规则关联   |

    表 8.3.2.2-1 P3起Neo4j关系类型

+   **P3引入Neo4j的触发条件**：
    -   需要3层以上的关系路径查询
    -   需要影响范围分析（外规变更→哪些控制点受影响）
    -   需要反向追溯（控制点→依据哪些外规要求）
    -   MySQL关联查询性能无法满足需求

+   **数据迁移策略**：
    -   P3版本发布前完成MySQL→Neo4j的数据迁移
    -   迁移期间保持双写，待验证稳定后切换读源
    -   保留MySQL关联表作为备份，3个版本后废弃

+   图数据模型示例如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         知识图谱关系模型示例                               │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌─────────────┐                                                           │
    │  │ Regulation  │                                                           │
    │  │ 数据安全法  │                                                           │
    │  └──────┬──────┘                                                           │
    │         │ CONTAINS                                                         │
    │         ▼                                                                  │
    │  ┌─────────────┐                                                           │
    │  │ Clause      │                                                           │
    │  │ 第27条      │                                                           │
    │  └──────┬──────┘                                                           │
    │         │ REQUIRES                                                         │
    │         ▼                                                                  │
    │  ┌─────────────┐      APPLIES_TO      ┌─────────────┐                      │
    │  │ Requirement │─────────────────────▶│ Scenario    │                      │
    │  │ 数据分类分级│                      │ 金融数据处理│                      │
    │  └──────┬──────┘                      └─────────────┘                      │
    │         │ MAPS_TO                            │                             │
    │         ▼                                    │ IMPLEMENTS                  │
    │  ┌─────────────┐                             │                             │
    │  │ Control     │◀────────────────────────────┘                             │
    │  │ 数据分级策略│                                                           │
    │  └──────┬──────┘                                                           │
    │         │ ASSIGNS (R角色)                                                  │
    │         ▼                                                                  │
    │  ┌─────────────┐                                                           │
    │  │Responsibility│                                                          │
    │  │ 数据管理员  │                                                           │
    │  └─────────────┘                                                           │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.3.2.2-1 知识图谱关系模型示例（P3起生效）

### 8.3.3 租户级ES索引设计

+   除6库共享Index外，租户私有数据也采用ES存储，实现Index级隔离
+   租户级ES Index设计如下表所示

    | Index名称模式              | 数据类型 | 核心字段                                        | 说明             |
    | -------------------------- | -------- | ----------------------------------------------- | ---------------- |
    | idx_{tenant_code}_policy   | 租户制度 | id, name, content, control_ids, status, version | 租户制度全文检索 |
    | idx_{tenant_code}_asset    | 租户资产 | id, name, type, scenario_ids, description       | 资产搜索（可选） |
    | idx_{tenant_code}_evidence | 证据数据 | id, control_id, asset_id, content, created_at   | 证据搜索（P4起） |

    表 8.3.3-1 租户级ES Index设计

+   **Index命名规范**：
    -   6库共享Index：`idx_{库名}`，如`idx_regulation`、`idx_control`
    -   租户私有Index：`idx_{tenant_code}_{数据类型}`，如`idx_acme_policy`
    -   索引别名：使用别名支持无缝切换，如`idx_regulation_read`指向当前活跃索引

+   **Index生命周期管理**：
    -   租户开通时自动创建对应的ES Index
    -   租户注销时归档并延迟删除Index（保留30天）
    -   定期执行Index优化（force merge）

+   **向量检索支持（P4起）**：

    | Index名称       | 向量字段     | 维度 | 用途             |
    | --------------- | ------------ | ---- | ---------------- |
    | idx_regulation  | content_vec  | 768  | 外规语义相似检索 |
    | idx_control     | guidance_vec | 768  | 控制点智能推荐   |
    | idx_requirement | content_vec  | 768  | 要求点语义匹配   |

    表 8.3.3-2 向量检索Index扩展（P4起）

## 8.4 租户数据模型

### 8.4.1 租户隔离策略

+   租户数据隔离采用Schema级隔离
+   隔离策略如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         租户数据隔离策略                                   │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     MySQL实例                                        │  │
    │  │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐            │  │
    │  │  │ Schema:        │ │ Schema:        │ │ Schema:        │            │  │
    │  │  │ tenant_001     │ │ tenant_002     │ │ tenant_003     │            │  │
    │  │  │ ┌────────────┐ │ │ ┌────────────┐ │ │ ┌────────────┐ │            │  │
    │  │  │ │ t_asset    │ │ │ │ t_asset    │ │ │ │ t_asset    │ │            │  │
    │  │  │ │ t_policy   │ │ │ │ t_policy   │ │ │ │ t_policy   │ │            │  │
    │  │  │ │ t_mapping  │ │ │ │ t_mapping  │ │ │ │ t_mapping  │ │            │  │
    │  │  │ │ ...        │ │ │ │ ...        │ │ │ │ ...        │ │            │  │
    │  │  │ └────────────┘ │ │ └────────────┘ │ │ └────────────┘ │            │  │
    │  │  └────────────────┘ └────────────────┘ └────────────────┘            │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  隔离特点：                                                                │
    │  • 每个租户独立Schema，表结构相同                                          │
    │  • 动态数据源路由，根据tenant_id切换Schema                                 │
    │  • 大客户可升级为独立数据库实例                                            │
    │  • DDL变更需全租户同步执行                                                 │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.4.1-1 租户数据隔离策略

### 8.4.2 租户核心表结构

+   租户私有核心表如下表所示

    | 表名              | 说明         | 核心字段                                    |
    | ----------------- | ------------ | ------------------------------------------- |
    | t_tenant_asset    | 租户资产     | id, name, type, scenario_ids, status        |
    | t_tenant_scenario | 租户场景映射 | id, std_scenario_id, custom_name, status    |
    | t_tenant_control  | 租户控制映射 | id, std_control_id, custom_impl, status     |
    | t_tenant_policy   | 租户制度     | id, name, content, control_ids, version     |
    | t_assessment      | 合规评估     | id, name, scope, status, score, assess_date |
    | t_gap             | 差距项       | id, assessment_id, control_id, gap_desc     |
    | t_evidence        | 证据数据     | id, control_id, asset_id, file_id, status   |
    | t_remediation     | 整改任务     | id, gap_id, assignee, due_date, status      |

    表 8.4.2-1 租户核心表结构

### 8.4.3 组织架构表结构

+   组织架构相关表如下表所示

    | 表名            | 说明               | 核心字段                                     |
    | --------------- | ------------------ | -------------------------------------------- |
    | t_department    | 部门               | id, parent_id, code, name, level, sort_order |
    | t_position      | 岗位               | id, dept_id, code, name, responsibilities    |
    | t_employee      | 人员               | id, user_id, name, email, phone, status      |
    | t_emp_position  | 人员岗位关联       | id, employee_id, position_id, is_primary     |
    | t_position_duty | 岗位职责（责任点） | id, position_id, responsibility_id, racisv   |
    | t_report_line   | 汇报关系           | id, employee_id, manager_id, line_type       |

    表 8.4.3-1 组织架构表结构

## 8.5 数据同步机制

### 8.5.1 知识中台到租户同步

+   知识中台数据同步到租户的机制如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                     知识中台到租户数据同步机制                             │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────┐                                  ┌──────────────┐        │
    │  │ 知识中台     │                                  │ 租户私有库   │        │
    │  │ (6库3图)     │                                  │              │        │
    │  └──────┬───────┘                                  └──────▲───────┘        │
    │         │                                                 │                │
    │         │ 1. 发布事件                                     │ 4. 写入        │
    │         ▼                                                 │                │
    │  ┌──────────────┐     2. 消费      ┌──────────────┐       │                │
    │  │ Kafka        │─────────────────▶│ 同步服务     │───────┘                │
    │  │ 发布Topic    │                  │ (svc-operate)│                        │
    │  └──────────────┘                  └──────┬───────┘                        │
    │                                           │                                │
    │                                           │ 3. 订阅过滤                    │
    │                                           ▼                                │
    │                                    ┌──────────────┐                        │
    │                                    │ 租户订阅配置 │                        │
    │                                    │ (合规包范围) │                        │
    │                                    └──────────────┘                        │
    │                                                                            │
    │  同步策略：                                                                │
    │  • 增量同步：基于版本号的增量推送，减少数据量                              │
    │  • 全量重建：首次订阅或数据异常时全量同步                                  │
    │  • 订阅过滤：根据租户订阅的合规包范围过滤数据                              │
    │  • 幂等处理：基于版本号的幂等写入，防止重复                                │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 8.5.1-1 知识中台到租户数据同步机制

### 8.5.2 供给侧到知识中台数据同步

+   供给侧BC（BC-51/52/53）到知识中台BC（BC-40/41）的数据同步机制如下表所示

    | 同步场景     | 源BC  | 目标BC   | 同步触发     | 同步方式 | 一致性保障         |
    | ------------ | ----- | -------- | ------------ | -------- | ------------------ |
    | 外规入库     | BC-51 | BC-52    | 采集完成事件 | 异步消息 | 事件驱动+幂等消费  |
    | 知识工程产出 | BC-52 | BC-40    | API调用      | 同步写入 | 分布式事务（Saga） |
    | 关系数据产出 | BC-52 | BC-41    | API调用      | 同步写入 | 分布式事务（Saga） |
    | 发布审核通过 | BC-52 | BC-40/41 | 发布事件     | 异步消息 | 事件驱动+状态机    |

    表 8.5.2-1 供给侧到知识中台数据同步

+   **数据同步流程图**：
    ```
    BC-51(内容采集) --[RegulationCollected事件]--> BC-52(知识工程)
                                                      |
                                                      v
                                            [解析、映射、质检]
                                                      |
                    +----------------+----------------+
                    |                |                |
                    v                v                v
               BC-40(6库)      BC-41(3图)      BC-53(分发)
                    |                |                |
                    +-------+--------+                |
                            |                         |
                            v                         v
                     知识中台数据              租户订阅推送
    ```

### 8.5.3 租户到知识中台反馈数据同步

+   租户使用反馈数据回流知识中台的同步机制如下表所示

    | 反馈类型 | 源BC     | 目标BC | 反馈内容              | 同步方式 | 用途               |
    | -------- | -------- | ------ | --------------------- | -------- | ------------------ |
    | 使用统计 | BC-31/35 | BC-53  | 控制点/合规包使用次数 | 异步消息 | 运营监控、推荐优化 |
    | 质量反馈 | BC-31    | BC-53  | 内容错误/改进建议     | 异步消息 | 内容质量持续改进   |
    | 定制需求 | BC-35    | BC-53  | 新控制点/新场景需求   | 异步消息 | 产品规划、内容扩展 |

    表 8.5.3-1 租户反馈数据同步

### 8.5.4 数据版本管理

+   核心数据版本管理策略如下表所示

    | 数据类型      | 版本策略                            | 保留策略         |
    | ------------- | ----------------------------------- | ---------------- |
    | 外规          | 每次发布新版本，保留完整历史版本    | 永久保留         |
    | 要求点/控制点 | 主版本+修订版本，重大变更创建新版本 | 保留最近10个版本 |
    | 合规包        | 语义化版本（Major.Minor.Patch）     | 保留最近5个版本  |
    | 租户制度      | 每次修改创建新版本                  | 永久保留         |
    | 合规评估      | 每次评估创建新记录                  | 永久保留         |

    表 8.5.4-1 数据版本管理策略

## 8.6 数据治理

### 8.6.1 数据质量规则

+   数据质量规则如下表所示

    | 规则类型 | 规则说明               | 适用数据       |
    | -------- | ---------------------- | -------------- |
    | 完整性   | 必填字段不为空         | 所有主数据     |
    | 唯一性   | 编码字段全局唯一       | 外规、控制点等 |
    | 一致性   | 引用关系存在且有效     | 所有关联数据   |
    | 时效性   | 数据更新时间在有效期内 | 外规、验证结果 |
    | 准确性   | 数据内容符合业务规则   | 映射关系、评估 |

    表 8.6.1-1 数据质量规则

### 8.6.2 数据备份策略

+   数据备份策略如下表所示

    | 数据类型      | 备份频率  | 保留周期 | 备份方式           | 对应需求 |
    | ------------- | --------- | -------- | ------------------ | -------- |
    | MySQL         | 每日全量  | 30天     | mysqldump + binlog | FD-13    |
    | Neo4j         | 每日全量  | 30天     | neo4j-admin dump   | FD-13    |
    | Elasticsearch | 每日快照  | 14天     | Snapshot API       | FD-13    |
    | Redis         | 每小时RDB | 7天      | RDB + AOF          | FD-13    |
    | MinIO         | 实时同步  | 永久     | 跨区域复制         | FD-13    |
    | 审计日志      | 实时写入  | 按配置   | 异步写入+定期归档  | FD-04    |

    表 8.6.2-1 数据备份策略

### 8.6.3 数据安全策略

+   数据安全策略如下表所示

    | 安全措施 | 说明                           |
    | -------- | ------------------------------ |
    | 传输加密 | 全链路HTTPS/TLS加密            |
    | 存储加密 | 敏感字段AES-256加密存储        |
    | 访问控制 | 基于角色的数据权限控制         |
    | 数据脱敏 | 日志、测试环境数据脱敏         |
    | 审计追踪 | 敏感数据访问全量审计           |
    | 租户隔离 | Schema级别强隔离，防止数据泄露 |

    表 8.6.3-1 数据安全策略

# 9 非功能架构

+   本章定义透管云的非功能性需求架构设计，包括性能、安全、可用性、可扩展性等

## 9.1 非功能需求概览

+   非功能需求分类及优先级如下表所示

    | 需求分类 | 优先级 | 说明                       | 对应基础性需求        |
    | -------- | ------ | -------------------------- | --------------------- |
    | 安全性   | P0     | 合规类系统对安全性要求极高 | FD-01/02/04/05        |
    | 可用性   | P0     | 业务连续性保障             | FD-11/12/13           |
    | 性能     | P1     | 用户体验保障               | -                     |
    | 可扩展性 | P1     | 支撑业务增长               | FD-03（多租户架构）   |
    | 可维护性 | P2     | 降低运维成本               | FD-10/11/12           |
    | 可观测性 | P2     | 问题快速定位               | FD-12（系统监控告警） |
    | 国际化   | P3     | 多语言多时区支持           | FD-14（国际化本地化） |

    表 9.1-1 非功能需求分类

## 9.2 性能架构

### 9.2.1 性能目标

+   性能目标如下表所示

    | 指标类型 | 指标项          | 目标值 | 说明         |
    | -------- | --------------- | ------ | ------------ |
    | 响应时间 | 页面加载        | ≤3秒   | 首屏加载     |
    | 响应时间 | API响应（P95）  | ≤500ms | 普通查询接口 |
    | 响应时间 | API响应（P99）  | ≤1秒   | 复杂查询接口 |
    | 响应时间 | 图谱遍历（3层） | ≤2秒   | 知识图谱查询 |
    | 吞吐量   | 并发用户        | 1000+  | 单租户峰值   |
    | 吞吐量   | QPS             | 5000+  | 系统整体     |
    | 吞吐量   | TPS             | 500+   | 写操作       |

    表 9.2.1-1 性能目标

+   **与宏观需求性能指标差异说明**：
    -   页面加载目标：宏观需求表7.1.3-1定义P1基线为<3s（首屏渲染），本设计采用≤3s，一致
    -   API响应时间：宏观需求表7.2.1-1定义简单查询<500ms（目标）、<1s（最大容忍），本设计P95目标为≤500ms，一致
    -   并发用户数：宏观需求表7.2.2-1定义SaaS标准版1000+，本设计采用单租户峰值1000+，一致
    -   本设计性能目标为P1-P6全版本目标，P1阶段可按宏观需求表7.1.3-1的基线值执行（并发用户100+）

### 9.2.2 性能优化策略

+   性能优化策略如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         性能优化策略全景图                                 │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ L1 前端优化                                                          │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │  │
    │  │ │ 代码分割 │ │ 懒加载   │ │ CDN加速  │ │ 资源压缩 │ │ 缓存策略 │     │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ L2 网关优化                                                          │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ 限流     │ │ 缓存     │ │ 压缩     │ │ 连接池   │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ L3 应用层优化                                                        │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │  │
    │  │ │ 本地缓存 │ │ 异步处理 │ │ 批量操作 │ │ 连接池   │ │ JVM调优  │     │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ L4 数据层优化                                                        │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │  │
    │  │ │ 索引优化 │ │ 读写分离 │ │ 分库分表 │ │ Redis缓存│ │ ES预热   │     │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.2.2-1 性能优化策略全景图

+   各层性能优化措施如下表所示

    | 优化层级 | 优化措施                           | 预期效果        |
    | -------- | ---------------------------------- | --------------- |
    | 前端     | 路由懒加载、组件按需引入、图片压缩 | 首屏减少50%     |
    | 前端     | 静态资源CDN、浏览器缓存            | 加载提速60%     |
    | 网关     | 热点API结果缓存（5分钟）           | 减少后端压力70% |
    | 应用层   | 本地缓存Caffeine、二级缓存Redis    | 响应减少30%     |
    | 应用层   | 异步消息解耦、批量写入             | 吞吐提升50%     |
    | 数据层   | MySQL索引优化、慢SQL治理           | 查询提速40%     |
    | 数据层   | 读写分离、连接池优化               | 并发提升100%    |

    表 9.2.2-1 性能优化措施

### 9.2.3 缓存架构

+   多级缓存架构如下表所示

    | 缓存层级 | 缓存类型   | 缓存内容                 | TTL       |
    | -------- | ---------- | ------------------------ | --------- |
    | L1       | 浏览器缓存 | 静态资源、API响应        | 1小时-1天 |
    | L2       | CDN缓存    | 静态资源、公共API        | 1天       |
    | L3       | 网关缓存   | 热点API响应              | 5分钟     |
    | L4       | 本地缓存   | 配置数据、元数据         | 10分钟    |
    | L5       | Redis缓存  | 会话、热点数据、分布式锁 | 按需配置  |

    表 9.2.3-1 多级缓存架构

## 9.3 安全架构

### 9.3.1 安全架构全景

+   安全架构全景如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         透管云安全架构全景图                               │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 边界安全                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ WAF      │ │ DDoS防护 │ │ 黑白名单 │ │ 地域限制 │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 接入安全                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ 身份认证 │ │ MFA      │ │ Token    │ │ 会话管理 │                  │  │
    │  │ │ OAuth2   │ │ 多因素   │ │ JWT      │ │ 超时控制 │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 访问控制                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ RBAC     │ │ ABAC     │ │ 数据权限 │ │ 租户隔离 │                  │  │
    │  │ │ 角色权限 │ │ 属性权限 │ │ 行级控制 │ │ Schema   │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 数据安全                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ 传输加密 │ │ 存储加密 │ │ 数据脱敏 │ │ 审计日志 │                  │  │
    │  │ │ TLS 1.3  │ │ AES-256  │ │ 动态脱敏 │ │ 全量记录 │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 应用安全                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ 输入校验 │ │ SQL注入  │ │ XSS防护  │ │ CSRF防护 │                  │  │
    │  │ │          │ │ 防护     │ │          │ │          │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.3.1-1 透管云安全架构全景图

### 9.3.2 认证授权设计

+   认证授权机制如下表所示

    | 安全层面 | 机制                  | 实现方式                       | 对应需求/角色                   |
    | -------- | --------------------- | ------------------------------ | ------------------------------- |
    | 身份认证 | 用户名密码 + MFA      | Sa-Token + TOTP                | FD-01（UP强制/UR可配/UC不强制） |
    | 身份认证 | 企业SSO集成           | OAuth2.0 / OIDC                | FD-07（仅UR用户群）             |
    | 身份认证 | LDAP/AD同步           | Spring LDAP                    | FD-07（仅UR用户群）             |
    | 身份认证 | 社交登录              | 企业微信/钉钉等                | FD-01（仅UC用户群）             |
    | 会话管理 | 会话超时、并发控制    | Sa-Token                       | FD-01（UP:1/UR:3/UC:5）         |
    | 授权模型 | RBAC角色权限          | 角色→权限→资源                 | FD-02                           |
    | 授权模型 | 预置角色 + 自定义角色 | 预置不可改/自定义              | FD-02（仅UR支持自定义）         |
    | 数据权限 | 五级数据权限范围      | 本人/本部门/及下级/全部/自定义 | FD-02                           |
    | 数据权限 | 租户数据隔离          | Schema动态路由                 | FD-03                           |

    表 9.3.2-1 认证授权机制

### 9.3.3 权限模型设计

+   RBAC+ABAC混合权限模型如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                       RBAC+ABAC混合权限模型                                │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌─────────────────────────── RBAC层 ───────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌────────┐     1:N     ┌────────┐     N:M     ┌────────┐            │  │
    │  │  │ 用户   │────────────▶│ 角色   │────────────▶│ 权限   │            │  │
    │  │  │        │             │        │             │        │            │  │
    │  │  └────────┘             └────────┘             └───┬────┘            │  │
    │  │                                                    │                 │  │
    │  │                                                    ▼                 │  │
    │  │                                              ┌────────┐              │  │
    │  │                                              │ 资源   │              │  │
    │  │                                              │ (菜单/ │              │  │
    │  │                                              │  按钮/ │              │  │
    │  │                                              │  API)  │              │  │
    │  │                                              └────────┘              │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌─────────────────────────── ABAC层 ───────────────────────────────────┐  │
    │  │                                                                      │  │
    │  │  ┌────────────┐    ┌────────────┐    ┌────────────┐                  │  │
    │  │  │ 主体属性   │    │ 资源属性   │    │ 环境属性   │                  │  │
    │  │  │ • 部门     │    │ • 数据分类 │    │ • 时间     │                  │  │
    │  │  │ • 岗位     │    │ • 敏感等级 │    │ • IP地址   │                  │  │
    │  │  │ • 职级     │    │ • 所属租户 │    │ • 设备类型 │                  │  │
    │  │  └─────┬──────┘    └─────┬──────┘    └─────┬──────┘                  │  │
    │  │        │                 │                 │                         │  │
    │  │        └─────────────────┼─────────────────┘                         │  │
    │  │                          ▼                                           │  │
    │  │                    ┌───────────┐                                     │  │
    │  │                    │ 策略引擎  │                                     │  │
    │  │                    │ (动态评估)│                                     │  │
    │  │                    └───────────┘                                     │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.3.3-1 RBAC+ABAC混合权限模型

### 9.3.4 审计日志设计

+   审计日志设计如下表所示

    | 日志类型     | 记录内容                                   | 保留期限 |
    | ------------ | ------------------------------------------ | -------- |
    | 登录日志     | 用户ID、登录时间、IP、设备、结果           | 1年      |
    | 操作日志     | 用户ID、操作类型、操作对象、操作时间、结果 | 2年      |
    | 数据变更日志 | 用户ID、表名、主键、变更前后值、时间       | 3年      |
    | 敏感访问日志 | 用户ID、访问资源、访问时间、访问结果       | 3年      |
    | 系统日志     | 服务名、日志级别、内容、时间、TraceId      | 30天     |

    表 9.3.4-1 审计日志设计

## 9.4 可用性架构

### 9.4.1 可用性目标

+   可用性目标如下表所示

    | 指标           | 目标值 | 说明                  |
    | -------------- | ------ | --------------------- |
    | 系统可用性     | 99.9%  | 年度停机时间≤8.76小时 |
    | 核心服务可用性 | 99.95% | 年度停机时间≤4.38小时 |
    | RTO            | ≤4小时 | 恢复时间目标          |
    | RPO            | ≤1小时 | 恢复点目标            |

    表 9.4.1-1 可用性目标

### 9.4.2 高可用架构

+   高可用架构设计如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         高可用架构设计                                     │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 接入层高可用                                                         │  │
    │  │ ┌──────────┐ ┌──────────┐                                            │  │
    │  │ │ DNS轮询  │ │ LB集群   │  多活部署，自动故障转移                    │  │
    │  │ └──────────┘ └──────────┘                                            │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 应用层高可用                                                         │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐                               │  │
    │  │ │ 多实例   │ │ 无状态   │ │ 健康检查 │  K8s自动调度、故障自愈        │  │
    │  │ │ 部署     │ │ 设计     │ │ 自愈     │                               │  │
    │  │ └──────────┘ └──────────┘ └──────────┘                               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 数据层高可用                                                         │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │  │
    │  │ │ MySQL    │ │ Neo4j    │ │ ES集群   │ │ Redis    │                  │  │
    │  │ │ 主从复制 │ │ 因果集群 │ │ 多副本   │ │ 哨兵集群 │                  │  │
    │  │ └──────────┘ └──────────┘ └──────────┘ └──────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │ 容灾设计                                                             │  │
    │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐                               │  │
    │  │ │ 同城双活 │ │ 异地灾备 │ │ 数据备份 │  RPO≤1小时，RTO≤4小时         │  │
    │  │ └──────────┘ └──────────┘ └──────────┘                               │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.4.2-1 高可用架构设计

### 9.4.3 容错与降级策略

+   容错与降级策略如下表所示

    | 故障场景       | 容错策略                  | 降级方案         |
    | -------------- | ------------------------- | ---------------- |
    | 单服务实例故障 | K8s自动重启、负载均衡剔除 | 无感知           |
    | 依赖服务超时   | 熔断器打开，快速失败      | 返回缓存数据     |
    | 数据库主库故障 | 自动切换从库              | 只读模式         |
    | Redis故障      | 哨兵自动切换              | 降级到本地缓存   |
    | ES集群故障     | 副本自动选举              | 降级到数据库查询 |
    | 消息队列故障   | 本地缓存+重试             | 同步处理         |

    表 9.4.3-1 容错与降级策略

## 9.5 可扩展性架构

### 9.5.1 水平扩展能力

+   各层水平扩展能力如下表所示

    | 架构层级   | 扩展方式           | 扩展上限  |
    | ---------- | ------------------ | --------- |
    | 网关层     | K8s HPA自动扩缩容  | 无限制    |
    | BFF层      | K8s HPA自动扩缩容  | 无限制    |
    | 业务服务层 | K8s HPA自动扩缩容  | 无限制    |
    | MySQL      | 读写分离、分库分表 | 1000+租户 |
    | Neo4j      | 因果集群读扩展     | 10亿节点  |
    | ES         | 分片扩展           | PB级      |
    | Redis      | 集群分片           | TB级      |

    表 9.5.1-1 水平扩展能力

### 9.5.2 租户扩展策略

+   租户规模扩展策略如下表所示

    | 租户规模     | 数据库策略               | 应用策略           |
    | ------------ | ------------------------ | ------------------ |
    | <100租户     | 单MySQL实例，Schema隔离  | 共享集群           |
    | 100-500租户  | MySQL主从，读写分离      | 共享集群，按需扩容 |
    | 500-1000租户 | 多MySQL实例，租户分组    | 多集群部署         |
    | >1000租户    | 分库分表，大客户独立实例 | 区域化部署         |

    表 9.5.2-1 租户扩展策略

## 9.6 可观测性架构

### 9.6.1 可观测性三支柱

+   可观测性三支柱设计如下表所示

    | 支柱    | 技术选型   | 覆盖范围                     |
    | ------- | ---------- | ---------------------------- |
    | Metrics | Prometheus | 系统指标、应用指标、业务指标 |
    | Logging | ELK Stack  | 应用日志、访问日志、审计日志 |
    | Tracing | SkyWalking | 分布式链路追踪、服务拓扑     |

    表 9.6.1-1 可观测性三支柱

### 9.6.2 监控告警设计

+   监控告警分级如下表所示

    | 告警级别    | 触发条件                 | 响应要求     |
    | ----------- | ------------------------ | ------------ |
    | P0 Critical | 核心服务不可用、数据丢失 | 5分钟内响应  |
    | P1 High     | 服务降级、响应超时>5秒   | 15分钟内响应 |
    | P2 Medium   | 错误率>1%、响应超时>2秒  | 1小时内响应  |
    | P3 Low      | 资源使用率>80%、慢查询   | 工作时间处理 |

    表 9.6.2-1 监控告警分级

### 9.6.3 关键监控指标

+   关键监控指标如下表所示

    | 指标分类   | 指标名称         | 告警阈值      |
    | ---------- | ---------------- | ------------- |
    | 系统指标   | CPU使用率        | >80%持续5分钟 |
    | 系统指标   | 内存使用率       | >85%持续5分钟 |
    | 系统指标   | 磁盘使用率       | >90%          |
    | 应用指标   | API错误率        | >1%持续5分钟  |
    | 应用指标   | API P95响应时间  | >1秒持续5分钟 |
    | 应用指标   | JVM GC时间       | >500ms/分钟   |
    | 业务指标   | 登录失败率       | >10%持续5分钟 |
    | 业务指标   | 知识检索响应时间 | >2秒持续5分钟 |
    | 数据库指标 | 慢查询数量       | >10个/分钟    |
    | 数据库指标 | 连接池使用率     | >80%          |

    表 9.6.3-1 关键监控指标

## 9.7 基础性需求覆盖矩阵

+   基础性需求与BC/微服务的覆盖关系如下表所示

    | 需求编号 | 需求名称         | 主责BC | 主责微服务 | 实现版本 |
    | -------- | ---------------- | ------ | ---------- | -------- |
    | FD-01    | 统一身份认证     | BC-10  | svc-iam    | P1       |
    | FD-02    | 统一权限框架     | BC-10  | svc-iam    | P1       |
    | FD-03    | 多租户架构       | BC-11  | svc-tenant | P1       |
    | FD-04    | 统一审计日志     | BC-10  | svc-iam    | P1       |
    | FD-05    | 系统配置管理     | BC-10  | svc-iam    | P1       |
    | FD-06    | 租户生命周期管理 | BC-11  | svc-tenant | P1       |
    | FD-07    | 企业IAM集成      | BC-10  | svc-iam    | P2       |
    | FD-08    | 消息通知中心     | BC-12  | svc-notify | P1       |
    | FD-09    | 文件与附件管理   | BC-13  | svc-file   | P1       |
    | FD-10    | 数据字典管理     | BC-10  | svc-iam    | P1       |
    | FD-11    | 任务调度引擎     | -      | XXL-JOB    | P2       |
    | FD-12    | 系统监控告警     | -      | 基础设施   | P2       |
    | FD-13    | 数据备份恢复     | -      | 运维工具   | P2       |
    | FD-14    | 国际化本地化     | 全BC   | 全微服务   | P6       |

    表 9.7-1 基础性需求覆盖矩阵

+   **说明**：
    -   FD-11~13为运维基础设施，不归属特定BC
    -   FD-14为横切关注点，需要全部BC和微服务支持

## 9.8 兼容性架构

+   兼容性架构对标宏观需求NF-05兼容性需求，定义系统的兼容性支持范围

### 9.8.1 浏览器兼容性

+   浏览器兼容性支持如下表所示

    | 浏览器  | 最低版本 | 兼容等级 | 说明                    |
    | ------- | -------- | -------- | ----------------------- |
    | Chrome  | 90+      | 完全兼容 | 推荐浏览器              |
    | Firefox | 88+      | 完全兼容 | 全功能支持              |
    | Safari  | 14+      | 完全兼容 | macOS/iOS Safari        |
    | Edge    | 90+      | 完全兼容 | Chromium内核版本        |
    | IE      | 不支持   | -        | 不支持Internet Explorer |

    表 9.8.1-1 浏览器兼容性支持

### 9.8.2 移动端兼容性

+   移动端兼容性支持如下表所示

    | 平台    | 最低版本 | 支持方式  | 说明                   |
    | ------- | -------- | --------- | ---------------------- |
    | iOS     | 13+      | 响应式Web | Safari Mobile          |
    | Android | 8+       | 响应式Web | Chrome Mobile          |
    | 移动App | -        | P5规划    | 原生App（iOS/Android） |

    表 9.8.2-1 移动端兼容性支持

+   **响应式设计要求**：
    -   支持屏幕分辨率范围：1920×1080 至 1366×768
    -   移动端支持竖屏和横屏模式
    -   关键操作流程在移动端可完成

### 9.8.3 API版本兼容性

+   API版本兼容策略如下表所示

    | 兼容策略   | 说明                                    |
    | ---------- | --------------------------------------- |
    | 版本号规范 | 采用语义化版本号（SemVer）              |
    | 向后兼容   | API向后兼容至少2个主版本                |
    | 废弃声明   | 废弃API提前2个版本声明，给出迁移指引    |
    | 版本路由   | API路径包含版本号，如/api/v1/、/api/v2/ |

    表 9.8.3-1 API版本兼容策略

### 9.8.4 系统集成兼容性

+   系统集成兼容性支持如下表所示

    | 集成类型 | 支持协议/标准            | 对应需求 |
    | -------- | ------------------------ | -------- |
    | 身份认证 | SAML2.0/OAuth2.0/OIDC    | FD-07    |
    | 目录服务 | LDAP v3/Active Directory | FD-07    |
    | 邮件服务 | SMTP/SMTPS               | FD-08    |
    | 消息推送 | 企业微信/钉钉API         | FD-08    |
    | 日志对接 | Syslog/REST API          | FD-12    |
    | 数据交换 | REST/GraphQL             | -        |

    表 9.8.4-1 系统集成兼容性支持

## 9.9 可维护性架构

+   可维护性架构对标宏观需求NF-06可维护性需求，定义系统的维护和演进能力

### 9.9.1 模块化设计

+   模块化设计要求如下表所示

    | 要求项   | 设计措施                                 |
    | -------- | ---------------------------------------- |
    | 松耦合   | 微服务架构，BC间通过API/事件通信         |
    | 高内聚   | 单一职责原则，每个微服务聚焦单一业务能力 |
    | 接口规范 | RESTful API + OpenAPI 3.0规范            |
    | 依赖管理 | Maven/Gradle依赖管理，禁止循环依赖       |

    表 9.9.1-1 模块化设计要求

### 9.9.2 可测试性设计

+   可测试性设计要求如下表所示

    | 测试类型 | 覆盖率要求     | 工具/框架                         |
    | -------- | -------------- | --------------------------------- |
    | 单元测试 | >80%           | JUnit 5 + Mockito                 |
    | 集成测试 | >90%关键接口   | Spring Boot Test + TestContainers |
    | E2E测试  | 核心流程全覆盖 | Playwright / Cypress              |
    | 性能测试 | P1关键场景     | JMeter / Gatling                  |

    表 9.9.2-1 可测试性设计要求

### 9.9.3 可修改性设计

+   可修改性设计要求如下表所示

    | 设计要素   | 设计措施                                     |
    | ---------- | -------------------------------------------- |
    | 配置外部化 | Spring Cloud Config + Nacos配置中心          |
    | 特性开关   | 支持功能特性的动态开关，支持灰度发布         |
    | 策略模式   | 业务规则采用策略模式，支持运行时切换         |
    | 数据字典   | 枚举值、状态码等通过数据字典管理，减少硬编码 |

    表 9.9.3-1 可修改性设计要求

## 9.10 任务调度架构

+   本节定义FD-11任务调度引擎的技术架构，支撑证据采集、外规监测等定时任务场景

### 9.10.1 任务调度技术选型

+   任务调度技术选型如下表所示

    | 技术领域 | 选型       | 版本 | 选型理由                                 |
    | -------- | ---------- | ---- | ---------------------------------------- |
    | 调度引擎 | XXL-JOB    | 2.4+ | 开源免费、分布式、可视化控制台、社区活跃 |
    | 备选方案 | PowerJob   | 4.x  | 国产开源、支持工作流、备选               |
    | 任务执行 | 内嵌执行器 | -    | 各微服务内嵌XXL-JOB执行器，任务就近执行  |

    表 9.10.1-1 任务调度技术选型

### 9.10.2 任务调度架构图

+   任务调度架构如下图所示

    ```graph
    ┌────────────────────────────────────────────────────────────────────────────┐
    │                         任务调度架构                                       │
    ├────────────────────────────────────────────────────────────────────────────┤
    │                                                                            │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     XXL-JOB 调度中心                                 │  │
    │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                 │  │
    │  │  │ 任务管理 │ │ 调度触发 │ │ 执行日志 │ │ 告警通知 │                 │  │
    │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘                 │  │
    │  └─────────────────────────────┬────────────────────────────────────────┘  │
    │                                │ RPC调用                                   │
    │                                ▼                                           │
    │  ┌──────────────────────────────────────────────────────────────────────┐  │
    │  │                     微服务内嵌执行器                                 │  │
    │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                  │  │
    │  │  │ svc-verify   │ │ svc-         │ │ svc-operate  │                  │  │
    │  │  │ 证据采集任务 │ │ compliance   │ │ 数据推送任务 │                  │  │
    │  │  │              │ │ 外规监测任务 │ │              │                  │  │
    │  │  └──────────────┘ └──────────────┘ └──────────────┘                  │  │
    │  └──────────────────────────────────────────────────────────────────────┘  │
    │                                                                            │
    └────────────────────────────────────────────────────────────────────────────┘
    ```

    图 9.10.2-1 任务调度架构

### 9.10.3 核心定时任务清单

+   核心定时任务与场景的关联如下表所示

    | 任务编号 | 任务名称     | 关联场景              | 调度周期    | 执行服务       | 实现版本 |
    | -------- | ------------ | --------------------- | ----------- | -------------- | -------- |
    | JOB-01   | 证据自动采集 | SC-EX-02 证据采集留存 | 每日02:00   | svc-verify     | P2       |
    | JOB-02   | 外规变更检测 | SC-CM-05 外规订阅监测 | 每日06:00   | svc-compliance | P2       |
    | JOB-03   | 合规状态刷新 | SC-CM-07 持续合规监测 | 每小时      | svc-compliance | P2       |
    | JOB-04   | 数据推送同步 | SC-CP-07 数据推送服务 | 实时+每日   | svc-operate    | P2       |
    | JOB-05   | 报告自动生成 | SC-CM-04 合规评估报告 | 每月1日     | svc-compliance | P2       |
    | JOB-06   | 证书到期检查 | SC-SM-03 安全运营监控 | 每日08:00   | svc-governance | P4       |
    | JOB-07   | 账号清理任务 | FD-01 统一身份认证    | 每日03:00   | svc-iam        | P2       |
    | JOB-08   | 日志归档任务 | FD-04 统一审计日志    | 每周日02:00 | svc-iam        | P2       |
    | JOB-09   | 任务逾期提醒 | SC-AU-03 任务分配督办 | 每日09:00   | svc-governance | P4       |
    | JOB-10   | 整改逾期告警 | SC-EX-03 整改闭环管理 | 每日09:00   | svc-verify     | P2       |

    表 9.10.3-1 核心定时任务清单

### 9.10.4 任务执行策略

+   任务执行策略如下表所示

    | 策略项   | 策略描述                                               |
    | -------- | ------------------------------------------------------ |
    | 路由策略 | 采用"一致性哈希"路由，同一租户任务固定路由到同一执行器 |
    | 失败重试 | 失败自动重试3次，间隔10秒                              |
    | 超时控制 | 单任务执行超时30分钟自动终止                           |
    | 阻塞处理 | 采用"丢弃后续调度"策略，防止任务堆积                   |
    | 分片广播 | 大数据量任务支持分片执行，提升处理效率                 |
    | 任务依赖 | 支持子任务依赖，如"外规检测→差距分析→通知推送"         |

    表 9.10.4-1 任务执行策略

## 9.11 国际化本地化预留

+   本节定义FD-14国际化本地化的架构预留设计，计划在P6版本实现

### 9.11.1 国际化架构预留

+   国际化架构预留如下表所示

    | 预留项      | 预留方式                                         | 当前状态     |
    | ----------- | ------------------------------------------------ | ------------ |
    | 前端文本    | 所有展示文本使用i18n key，不硬编码中文           | P1起执行     |
    | 后端消息    | 异常信息、提示消息使用消息码，配置多语言资源文件 | P1起执行     |
    | 数据字典    | 字典标签支持多语言字段（label_zh/label_en）      | P1表结构预留 |
    | 时区处理    | 统一使用UTC存储，展示时按用户时区转换            | P1起执行     |
    | 日期格式    | 日期格式配置化，支持不同地区习惯                 | P3配置化     |
    | 货币单位    | 计费模块货币单位配置化                           | P3配置化     |
    | 6库内容翻译 | 预留翻译字段，P6起支持外规、控制点多语言版本     | P6实现       |

    表 9.11.1-1 国际化架构预留

### 9.11.2 本地化扩展点

+   本地化扩展点如下表所示

    | 扩展点       | 扩展方式                                    | 实现版本 |
    | ------------ | ------------------------------------------- | -------- |
    | 语言包加载   | 前端按需加载语言包，支持动态切换            | P6       |
    | 资源文件管理 | 后端多语言资源文件统一管理，支持热更新      | P6       |
    | RTL布局支持  | 预留从右到左（RTL）布局能力，支持阿拉伯语等 | P6       |
    | 法规本地化   | 不同地区外规库独立管理，支持跨境合规场景    | P6       |

    表 9.11.2-1 本地化扩展点

+   **P1-P5阶段执行规范**：
    -   前端开发：所有中文文本必须使用i18n函数包装，禁止硬编码
    -   后端开发：异常消息和业务提示使用MessageSource，不直接返回中文字符串
    -   数据库设计：涉及展示的标签字段预留多语言列或采用JSON存储
    -   API设计：响应中的展示文本与数据分离，文本通过code关联多语言资源

# 10 Epic到BC映射

+   本章定义宏观需求38个Epic与16个BC的映射关系，明确各BC的业务职责边界
+   **说明**：宏观需求中的Epic编号采用语义化命名（如EP-CP-01），本章表格中简化为序号（如EP-01）以便阅读

## 10.1 映射原则

+   Epic到BC映射遵循以下原则

    | 原则         | 说明                               |
    | ------------ | ---------------------------------- |
    | 主责明确     | 每个Epic有且仅有一个主责BC         |
    | 协作清晰     | 协作BC的参与方式和边界明确定义     |
    | 职责内聚     | 同一业务域的Epic尽量归属同一BC     |
    | 避免循环依赖 | Epic实现路径不应产生BC间的循环依赖 |

    表 10.1-1 映射原则

## 10.2 Epic清单回顾

+   宏观需求共定义38个Epic，按业务域分布如下表所示

    | 业务域   | Epic数量 | 宏观需求编号                                                                                        |
    | -------- | -------- | --------------------------------------------------------------------------------------------------- |
    | 供给侧   | 9        | EP-CP-01~09                                                                                         |
    | 消费侧A  | 25       | EP-DC-01/02, EP-PL-01, EP-BD-01~03, EP-EX-01~03, EP-CM-01~07, EP-RM-01~03, EP-SM-01~03, EP-AU-01~03 |
    | 消费侧B  | 4        | EP-KC-01~04                                                                                         |
    | **合计** | **38**   | -                                                                                                   |

    表 10.2-1 Epic分布

## 10.3 Epic到BC映射总览

+   38个Epic到BC的映射关系如下表所示（BC编号已更新）

    | 宏观需求编号 | Epic名称         | 主责BC | 协作BC              | 对应场景 |
    | ------------ | ---------------- | ------ | ------------------- | -------- |
    | EP-CP-01     | 外规采集入库     | BC-51  | BC-13               | SC-CP-01 |
    | EP-CP-02     | 控制点架构维护   | BC-52  | BC-40               | SC-CP-02 |
    | EP-CP-03     | 外规解析映射     | BC-52  | BC-40, BC-41        | SC-CP-03 |
    | EP-CP-04     | 合规包方案封装   | BC-52  | BC-41               | SC-CP-04 |
    | EP-CP-05     | 内容质检发布     | BC-52  | BC-40, BC-41        | SC-CP-05 |
    | EP-CP-06     | 租户生命周期管理 | BC-53  | BC-11, BC-35        | SC-CP-06 |
    | EP-CP-07     | 数据服务能力     | BC-53  | BC-40, BC-41, BC-35 | SC-CP-07 |
    | EP-CP-08     | 运营数据监控     | BC-53  | BC-10               | SC-CP-08 |
    | EP-CP-09     | 用户运营管理     | BC-53  | BC-10               | SC-CP-09 |
    | EP-DC-01     | 战略监控         | BC-33  | BC-31, BC-32, BC-34 | SC-DC-01 |
    | EP-DC-02     | 绩效汇报         | BC-33  | BC-31, BC-32        | SC-DC-02 |
    | EP-PL-01     | 架构规划能力     | BC-35  | BC-40, BC-41, BC-10 | SC-PL-01 |
    | EP-BD-01     | 制度编写         | BC-35  | BC-31               | SC-BD-01 |
    | EP-BD-02     | 制度管理能力     | BC-37  | BC-31, BC-35        | SC-BD-02 |
    | EP-BD-03     | 方案制定         | BC-35  | BC-40, BC-10        | SC-BD-03 |
    | EP-EX-01     | 策略执行         | BC-32  | BC-35, BC-31        | SC-EX-01 |
    | EP-EX-02     | 证据采集能力     | BC-32  | BC-40, BC-35        | SC-EX-02 |
    | EP-EX-03     | 整改闭环管理     | BC-32  | BC-31, BC-12        | SC-EX-03 |
    | EP-CM-01     | 新规应对         | BC-31  | BC-40, BC-41, BC-35 | SC-CM-01 |
    | EP-CM-02     | 制度追溯         | BC-31  | BC-35, BC-41        | SC-CM-02 |
    | EP-CM-03     | 合规总览         | BC-31  | BC-33               | SC-CM-03 |
    | EP-CM-04     | 合规评估         | BC-31  | BC-32, BC-35        | SC-CM-04 |
    | EP-CM-05     | 外规监测         | BC-31  | BC-53, BC-41        | SC-CM-05 |
    | EP-CM-06     | 检查应对         | BC-31  | BC-32, BC-13        | SC-CM-06 |
    | EP-CM-07     | 持续监测         | BC-31  | BC-32, BC-12        | SC-CM-07 |
    | EP-RM-01     | 风险识别登记     | BC-34  | BC-31, BC-32        | SC-RM-01 |
    | EP-RM-02     | 风险评估分析     | BC-34  | BC-31               | SC-RM-02 |
    | EP-RM-03     | 风险应对跟踪     | BC-34  | BC-33               | SC-RM-03 |
    | EP-SM-01     | 安全策略管理     | BC-36  | BC-35, BC-31, BC-12 | SC-SM-01 |
    | EP-SM-02     | 安全事件管理     | BC-36  | BC-32, BC-33, BC-12 | SC-SM-02 |
    | EP-SM-03     | 安全运营监控     | BC-36  | BC-33, BC-32, BC-34 | SC-SM-03 |
    | EP-AU-01     | 审计检查         | BC-33  | BC-32, BC-10        | SC-AU-01 |
    | EP-AU-02     | 责任问责能力     | BC-33  | BC-32               | SC-AU-02 |
    | EP-AU-03     | 任务分配督办     | BC-33  | BC-12               | SC-AU-03 |
    | EP-KC-01     | 知识搜索         | BC-20  | BC-40, BC-41        | SC-KC-01 |
    | EP-KC-02     | 知识浏览         | BC-20  | BC-41               | SC-KC-02 |
    | EP-KC-03     | 下载收藏         | BC-20  | BC-41, BC-13        | SC-KC-03 |
    | EP-KC-04     | 用户转化         | BC-20  | BC-11, BC-53        | SC-KC-04 |

    表 10.3-1 Epic到BC映射总览

## 10.4 研发阶段映射

+   Epic按P1-P6研发阶段的实现优先级如下表所示

    | 阶段 | Epic范围（宏观需求编号）                                     | 涉及BC                                            | 技术里程碑                   |
    | ---- | ------------------------------------------------------------ | ------------------------------------------------- | ---------------------------- |
    | P1   | EP-CP-01~06, EP-PL-01, EP-BD-01~02, EP-CM-01~03, FD-01~10    | BC-51~53, BC-40~41, BC-10~13, BC-31, BC-35, BC-37 | ES主存储+合规核心流程        |
    | P2   | EP-CP-07~09, EP-CM-04~07, EP-EX-01~03, 基础性需求FD-11~13    | BC-53(增强), BC-31(增强), BC-32                   | 运营监控+合规增强+验证检查   |
    | P3   | EP-KC-01~04, EP-BD-03, EP-AU-01                              | BC-20, BC-35(增强)                                | 消费侧B+方案制定             |
    | P4   | EP-DC-01~02, EP-PL-01, EP-RM-01~03, EP-SM-01~03, EP-AU-02~03 | BC-33, BC-34, BC-36, BC-35(增强)                  | 治理驾驶舱+风险管理+安全管理 |
    | P5   | 既有Epic增强（AI辅助）                                       | BC-31/32/33/34/36(增强)                           | AI增强+移动端                |
    | P6   | 既有Epic增强（行业方案）, FD-14                              | 全平台(增强)                                      | 行业解决方案+国际化          |

    表 10.4-1 研发阶段映射

+   **P1最小闭环流程**如下图所示
    ```graph
        ┌─────────────────────────────────────────────────────────────────────────────────────┐
        │                              P1 最小闭环流程                                        │
        ├─────────────────────────────────────────────────────────────────────────────────────┤
        │                                                                                     │
        │  ┌───────────────────────────────── 供给侧 ──────────────────────────────────────┐  │
        │  │                                                                               │  │
        │  │   ┌────────────┐      ┌────────────┐      ┌────────────┐                      │  │
        │  │   │ BC-51      │      │ BC-52      │      │ BC-53      │                      │  │
        │  │   │ 内容采集   │─────▶│ 知识工程   │─────▶│ 运营分发   │                      │  │
        │  │   │            │      │            │      │ (基础分发) │                      │  │
        │  │   └────────────┘      └─────┬──────┘      └──────┬─────┘                      │  │
        │  │                             │                    │                            │  │
        │  └─────────────────────────────┼────────────────────┼────────────────────────────┘  │
        │                                │                    │                               │
        │                                ▼                    │                               │
        │  ┌───────────────────────────── 知识中台 ────────────────────────────────────────┐  │
        │  │                                                                               │  │
        │  │   ┌────────────┐      ┌────────────┐                                          │  │
        │  │   │ BC-40      │◀────▶│ BC-41      │                                          │  │
        │  │   │ 知识实体   │      │ 知识图谱   │                                          │  │
        │  │   │ (6库)      │      │ (3图)      │                                          │  │
        │  │   └─────┬──────┘      └──────┬─────┘                                          │  │
        │  │         │                    │                                                │  │
        │  └─────────┼────────────────────┼────────────────────────────────────────────────┘  │
        │            │                    │                                                   │
        │            └─────────┬──────────┘                                                   │
        │                      │ OHS                                                          │
        │                      ▼                                                              │
        │  ┌───────────────────────────────── 消费侧A ─────────────────────────────────────┐  │
        │  │                                                                               │  │
        │  │   ┌────────────┐      ┌────────────┐      ┌────────────┐      ┌────────────┐  │  │
        │  │   │ BC-11      │      │ BC-10      │      │ BC-35      │      │ BC-31      │  │  │
        │  │   │ 租户管理   │─────▶│ 用户管理   │◀─────│ 租户落地   │─────▶│ 合规管理   │  │  │
        │  │   │ (开通)     │      │ (IAM)      │      │ (映射)     │      │ (评估)     │  │  │
        │  │   └────────────┘      └────────────┘      └─────┬──────┘      └──────┬─────┘  │  │
        │  │                                                 │                    │        │  │
        │  │                                                 └────────────────────┘        │  │
        │  │                                                      双向协作                 │  │
        │  └───────────────────────────────────────────────────────────────────────────────┘  │
        │                                                                                     │
        │  ┌───────────────────────────────────────────────────────────────────────────────┐  │
        │  │  P1验收标准：                                                                 │  │
        │  │  ✓ 能采集外规并解析入库（BC-51 → BC-52 → BC-40/41）[EP-CP-01~05]              │  │
        │  │  ✓ 能开通租户并初始化IAM（BC-11 → BC-10）[EP-CP-06, FD-03/06]                 │  │
        │  │  ✓ 能将知识分发到租户（BC-53 → BC-35）[EP-CP-07]                              │  │
        │  │  ✓ 租户能完成架构规划、场景映射和岗位责任分配（BC-35）[EP-PL-01]              │  │
        │  │  ✓ 租户能完成制度编写（BC-35）和发布管理（BC-37）[EP-BD-01~02]                │  │
        │  │  ✓ 租户能完成新规差距分析和制度追溯（BC-31）[EP-CM-01~03]                     │  │
        │  │  ✓ 用户能登录（含MFA）并按权限访问（BC-10）[FD-01/02]                         │  │
        │  │  ✓ 支持站内信、邮件、短信通知（BC-12）[FD-08]                                 │  │
        │  │  ✓ 支持文件上传下载预览（BC-13）[FD-09]                                       │  │
        │  └───────────────────────────────────────────────────────────────────────────────┘  │
        │                                                                                     │
        └─────────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 10.4-1 P1最小闭环流程

+   **P1阶段BC能力范围**：

    | BC             | P1实现范围                                                 | P2+增强            | 对应需求           |
    | -------------- | ---------------------------------------------------------- | ------------------ | ------------------ |
    | BC-51 内容采集 | 外规采集、人工录入、变更检测、人工验证                     | -                  | EP-CP-01           |
    | BC-52 知识工程 | 控制点架构、解析映射、合规包封装、质检发布                 | -                  | EP-CP-02~05        |
    | BC-53 运营分发 | 租户生命周期管理、基础分发（订阅、推送）                   | 运营监控、用户运营 | EP-CP-06~09        |
    | BC-40 知识实体 | 6库CRUD、版本管理                                          | -                  | EP-CP-02~05内嵌    |
    | BC-41 知识图谱 | 3图关系、合规包仓库、智能检索                              | -                  | EP-CP-02~05内嵌    |
    | BC-10 用户管理 | 用户管理、认证（MFA）、授权、组织架构、审计、系统配置      | SSO/LDAP集成       | FD-01/02/04/05/07  |
    | BC-11 租户管理 | 租户开通、数据库创建、基础配置、数据源管理                 | 计费账单、AD同步   | FD-03/06           |
    | BC-12 消息通知 | 站内信、邮件、短信推送                                     | 企业微信/钉钉      | FD-08              |
    | BC-13 文件管理 | 文件上传、下载、预览、版本管理                             | -                  | FD-09              |
    | BC-31 合规管理 | 新规差距分析、制度追溯查询、合规总览（基础）               | 合规评估、检查应对 | EP-CM-01~03        |
    | BC-35 租户落地 | 架构规划、场景映射、控制定制、资产管理、制度编写、岗位映射 | 方案制定           | EP-PL-01, EP-BD-01 |
    | BC-37 制度管理 | 制度版本管理、制度发布审批、制度生命周期、制度检索         | -                  | EP-BD-02           |

    表 10.4-2 P1阶段BC能力范围

+   **关键技术决策与版本对应**：
    -   P1-P2：6库使用ES为唯一存储，3图使用MySQL关联表
    -   P3：引入Neo4j，完成3图从MySQL到Neo4j的迁移
    -   P4：ES增加向量字段，支持语义检索

+   **P1验收标准（业务价值维度）**：

    | 验收项         | 验收标准                       | 对应困境             |
    | -------------- | ------------------------------ | -------------------- |
    | 外规采集入库   | 完成50+核心外规的结构化入库    | -                    |
    | 控制点架构建立 | 建立1000+控制点的标准库        | -                    |
    | 新规差距分析   | 能完成新规与现有制度的差距分析 | 困境一：新规比对地狱 |
    | 制度追溯查询   | 能查询制度条款的外规依据       | 困境一、困境二       |
    | 合规状态总览   | 能展示租户合规状态全景仪表盘   | 困境三：管理汇报哑口 |
    | 租户开通       | 完成3+种子客户的租户开通       | -                    |
    | 基础性需求     | FD-01~10全部可用               | -                    |

    表 10.4-x P1验收标准（业务价值维度）

+   **P1解决困境映射**：
    -   **困境一（新规比对地狱）**：通过EP-CM-01新规应对+EP-CM-02制度追溯，实现新规与现有制度的自动差距分析
    -   **困境三（管理汇报哑口）**：通过EP-CM-03合规总览，提供数据驱动的合规状态仪表盘
    -   困境二、四在P2-P4阶段逐步解决

# 11 部署架构

+   本章定义透管云的部署模式和环境差异配置

## 11.1 部署模式概述

+   透管云支持4种部署模式，满足不同客户需求

    | 部署模式   | 目标客户           | 资源隔离度 | 定制化程度 | 运维责任       |
    | ---------- | ------------------ | ---------- | ---------- | -------------- |
    | SaaS标准版 | 中小企业           | 共享资源   | 低         | 平台方全责     |
    | SaaS专属版 | 中大型企业         | 专属资源   | 中         | 平台方全责     |
    | 私有云部署 | 大型企业/金融机构  | 完全隔离   | 高         | 客户自主或委托 |
    | 混合云部署 | 有合规特殊要求客户 | 按需配置   | 高         | 平台+客户共同  |

    表 11.1-1 部署模式概述

## 11.2 部署模式差异配置

+   不同部署模式的差异配置如下表所示

    | 配置项   | SaaS标准版          | SaaS专属版       | 私有云部署   |
    | -------- | ------------------- | ---------------- | ------------ |
    | 数据库   | 共享实例+Schema隔离 | 专属实例         | 客户自有实例 |
    | ES集群   | 共享集群+Index隔离  | 专属集群         | 客户自有集群 |
    | 对象存储 | 共享MinIO+目录隔离  | 专属Bucket       | 客户自有存储 |
    | 网络隔离 | VPC内隔离           | 独立VPC          | 客户网络环境 |
    | SSL证书  | 平台泛域名证书      | 可自定义域名证书 | 客户自有证书 |
    | 认证集成 | 标准OAuth/OIDC      | 支持客户SSO/LDAP | 完全定制     |
    | 备份策略 | 平台统一策略        | 可定制备份周期   | 客户自主     |
    | 监控告警 | 平台统一监控        | 专属监控面板     | 客户自有监控 |
    | 版本升级 | 平台统一升级        | 协商升级窗口     | 客户自主决定 |

    表 11.2-1 部署模式差异配置

## 11.3 私有化部署最小资源要求

+   私有化部署最小资源要求如下表所示

    | 资源类型   | 最小配置                       | 推荐配置                        |
    | ---------- | ------------------------------ | ------------------------------- |
    | 应用服务器 | 4核8G × 3台                    | 8核16G × 5台                    |
    | 数据库     | MySQL 8.0，4核8G × 2台（主从） | MySQL 8.0，8核32G × 2台（主从） |
    | ES集群     | 3节点，4核8G × 3台             | 5节点，8核16G × 5台             |
    | Redis      | 4核8G × 2台（哨兵模式）        | 6节点集群                       |
    | MinIO      | 4核8G × 4台                    | 8核16G × 4台                    |
    | 网络带宽   | 100Mbps                        | 1Gbps                           |
    | 磁盘空间   | SSD 500GB（系统）+ 2TB（数据） | SSD 1TB（系统）+ 5TB（数据）    |

    表 11.3-1 私有化部署最小资源要求

# 附录

## 附录A 术语表

+   本文档使用的核心术语定义如下表所示

    | 术语       | 英文                                      | 定义                                                       |
    | ---------- | ----------------------------------------- | ---------------------------------------------------------- |
    | 外规       | External Regulation                       | 外部合规要求的统称，包括法规、标准、指引等                 |
    | 要求点     | Requirement Point                         | 从外规中拆解出的具体合规要求                               |
    | 场景点     | Scenario Point                            | 业务场景与技术场景的抽象，控制点的适用范围                 |
    | 控制点     | Control Point                             | 满足合规要求的具体控制措施                                 |
    | 验证规则   | Verification Rule                         | 用于验证控制点执行情况的检查规则                           |
    | 责任点     | Responsibility Point                      | 控制点+场景点+RACISV角色的组合，责任到人                   |
    | 合规包     | Compliance Package                        | 面向特定行业/场景的控制点集合封装                          |
    | 6库        | Six Repositories                          | 外规库、要求点库、场景点库、控制点库、验证规则库、责任点库 |
    | 3图        | Three Graphs                              | 责任分配基准图、外规要求解析图、要求落实责任图             |
    | RACISV     | -                                         | 责任分配模型：R执行、A批准、C咨询、I知会、S支持、V验证     |
    | BC         | Bounded Context                           | 限界上下文，DDD中的核心概念                                |
    | BFF        | Backend For Frontend                      | 前端专用后端，聚合层服务                                   |
    | IAM        | Identity and Access Management            | 身份与访问管理，统一管理用户认证和授权                     |
    | UP         | User Pool - Platform                      | 运营用户群，平台运营人员，含UP-01~09共9个角色              |
    | UR         | User Pool - Tenant                        | 租户用户群，企业租户内的用户，含UR-01~10共10个角色         |
    | UC         | User Pool - Consumer                      | C端用户群，个人消费者用户，含UC-01~02共2个角色             |
    | 外部相关方 | External Stakeholder                      | 与系统有交互但非直接用户，含EX-01~05共5个角色              |
    | OHS        | Open Host Service                         | 开放主机服务，DDD上下文映射模式                            |
    | ACL        | Anti-Corruption Layer                     | 防腐层，DDD上下文映射模式                                  |
    | Index      | ES Index                                  | Elasticsearch索引，ES中的数据存储单元                      |
    | XXL-JOB    | -                                         | 分布式任务调度平台，支持可视化管理和故障转移               |
    | 执行器     | Executor                                  | XXL-JOB中运行任务的组件，内嵌于各微服务                    |
    | 死信队列   | Dead Letter Queue                         | 存储处理失败消息的队列，用于后续人工处理或自动重试         |
    | 安全事件   | Security Event                            | 安全相关的异常事件，需要响应处置                           |
    | 安全策略   | Security Policy                           | 组织的安全管理规定和要求的集合                             |
    | 安全态势   | Security Posture                          | 组织整体安全状况的综合评估和可视化展示                     |
    | SIEM       | Security Information and Event Management | 安全信息和事件管理系统，用于安全日志收集和分析             |

    表 A-1 术语表

## 附录B 参考文档

+   本文档参考的输入文档如下表所示

    | 文档编号   | 文档名称                  | 版本  | 引用章节                                 |
    | ---------- | ------------------------- | ----- | ---------------------------------------- |
    | DOC-00     | 研发过程规范              | V0.10 | 全文                                     |
    | DOC-01a    | 产品战略-战略规划         | V0.30 | 第1章（架构概述）                        |
    | DOC-01b    | 产品战略-核心术语         | V0.22 | 附录A（术语表）                          |
    | DOC-02     | 宏观需求                  | V0.10 | 第3-10章（角色、场景、Epic、基础性需求） |
    | DOC-03-OLD | 概要设计-整体架构（原版） | V0.22 | 历史参考                                 |

    表 B-1 参考文档

## 附录C 缩略语

+   本文档使用的缩略语如下表所示

    | 缩略语 | 全称                                     | 说明                         |
    | ------ | ---------------------------------------- | ---------------------------- |
    | DDD    | Domain-Driven Design                     | 领域驱动设计                 |
    | CQRS   | Command Query Responsibility Segregation | 命令查询职责分离             |
    | API    | Application Programming Interface        | 应用程序接口                 |
    | REST   | Representational State Transfer          | 表述性状态转移               |
    | JWT    | JSON Web Token                           | JSON网络令牌                 |
    | RBAC   | Role-Based Access Control                | 基于角色的访问控制           |
    | ABAC   | Attribute-Based Access Control           | 基于属性的访问控制           |
    | SSO    | Single Sign-On                           | 单点登录                     |
    | MFA    | Multi-Factor Authentication              | 多因素认证                   |
    | SaaS   | Software as a Service                    | 软件即服务                   |
    | K8s    | Kubernetes                               | 容器编排平台                 |
    | CI/CD  | Continuous Integration/Delivery          | 持续集成/交付                |
    | RTO    | Recovery Time Objective                  | 恢复时间目标                 |
    | RPO    | Recovery Point Objective                 | 恢复点目标                   |
    | QPS    | Queries Per Second                       | 每秒查询数                   |
    | TPS    | Transactions Per Second                  | 每秒事务数                   |
    | IAM    | Identity and Access Management           | 身份与访问管理               |
    | OIDC   | OpenID Connect                           | 基于OAuth2的身份认证协议     |
    | LDAP   | Lightweight Directory Access Protocol    | 轻量目录访问协议             |
    | ES     | Elasticsearch                            | 分布式搜索引擎               |
    | i18n   | Internationalization                     | 国际化（i和n之间有18个字母） |
    | L10n   | Localization                             | 本地化（L和n之间有10个字母） |
    | RTL    | Right-to-Left                            | 从右到左的文字排版方向       |
    | UTC    | Coordinated Universal Time               | 协调世界时                   |
    | DLQ    | Dead Letter Queue                        | 死信队列                     |

    表 C-1 缩略语
