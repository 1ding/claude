# 文档信息

+   **文档版本**: V0.10
+   **编制日期**: 2026-02-03
+   **文档状态**: 草案
+   **所属项目**: ClariSphere(透管云)
+   **限界上下文**: BC-11 租户管理上下文 (Tenant Operations)
+   **版本变更历史**: 如下表所示

    | 版本  | 日期       | 变更内容 | 变更人 |
    | ----- | ---------- | -------- | ------ |
    | V0.10 | 2026-02-03 | 初始版本 | 丁劲松 |

# 1 概述

## 1.1 上下文定位

+   **BC归属信息**

    | 属性       | 值                                                         |
    | ---------- | ---------------------------------------------------------- |
    | BC编号     | BC-11                                                      |
    | BC名称     | 租户管理上下文                                             |
    | BC英文名   | Tenant Operations                                          |
    | 所属域     | 通用域                                                     |
    | 上下文类型 | 通用子域                                                   |
    | 所属微服务 | svc-tenant                                                 |
    | 微服务端口 | 8085                                                       |
    | 所属数据库 | clarisphere_platform                                       |
    | 代码包路径 | com.clarisphere.tenant                                     |
    | 上游依赖   | 无（基础服务）                                             |
    | 下游被依赖 | BC-10（认证配置查询、审计日志）、BC-01~BC-09（租户上下文） |

+   与BC-10的职责边界

    +   **BC-11（租户管理上下文）职责**
        +   租户生命周期管理：租户创建、审批、激活、暂停、恢复、注销
        +   租户数据库管理：数据库创建、删除
        +   租户数据源管理：连接池创建、销毁、动态路由注册
        +   租户配置管理：基本信息、邮箱域名、认证方式选择
        +   企业IAM集成配置：SSO配置（SAML/OIDC）、LDAP/AD配置
        +   租户商业化：套餐管理、订阅管理、计费与账单（P3-P5）
        +   租户运维：配额管理、用量统计、监控告警（P2-P4）
        +   租户分析：活跃度分析、流失预警、运营报表（P4-P6）

    +   **BC-10（用户管理上下文）职责**
        +   用户认证执行：基于BC-11的配置执行本地认证、SSO认证、LDAP认证
        +   用户账号管理：用户CRUD、密码管理、状态管理
        +   角色权限模型：RBAC实现、角色与权限关联
        +   租户IAM表初始化：为租户数据库创建IAM表结构和预置数据
        +   组织架构管理：部门、岗位、人员、任职关系
        +   操作审计管理：审计日志记录、安全审计日志

    +   **认证配置与执行的分工**

        ```
        ┌────────────────────────────────────────────────────────────────┐
        │                    认证配置与执行分工                          │
        ├────────────────────────────────────────────────────────────────┤
        │                                                                │
        │   BC-11（配置管理）                    BC-10（执行认证+审计）  │
        │   ┌─────────────────────┐            ┌─────────────────────┐   │
        │   │                     │            │                     │   │
        │   │ • 存储SSO配置       │  ──查询──▶ │ • 执行SSO认证流程   │   │
        │   │   - IdP元数据       │            │   - SAML断言处理    │   │
        │   │   - SP配置          │            │   - OIDC Token验证  │   │
        │   │   - 属性映射        │            │                     │   │
        │   │                     │            │                     │   │
        │   │ • 存储LDAP配置      │  ──查询──▶ │ • 执行LDAP认证      │   │
        │   │   - 服务器地址      │            │   - LDAP绑定验证    │   │
        │   │   - 绑定DN/密码     │            │   - 用户信息查询    │   │
        │   │   - 搜索过滤器      │            │                     │   │
        │   │                     │            │                     │   │
        │   │ • 认证方式选择      │  ──查询──▶ │ • 路由到对应认证器  │   │
        │   │   - 本地/SSO/LDAP   │            │                     │   │
        │   │                     │            │                     │   │
        │   └─────────────────────┘            └─────────────────────┘   │
        │                                                                │
        └────────────────────────────────────────────────────────────────┘
        ```

        图 1.1-1 认证配置与执行分工

    +   **租户开通协作流程**（P1为平台管理员直接开通，P2增加试用申请→审批→开通路径）
        1.   BC-11：创建租户记录（platform_tenant表），P1状态直接为"创建中"（跳过待审批），P2支持"待审批"
        2.   BC-11：P1直接进入创建流程，P2审批通过后状态变为"创建中"
        3.   BC-11：创建租户数据库（clarisphere_t<tenant_id>）
        4.   BC-11：创建并注册数据源连接池
        5.   BC-11：更新租户状态为"初始化中"（INITIALIZING）
        6.   BC-11：调用BC-10的内部接口 /internal/iam/tenant/init-tables
        7.   BC-10：创建IAM表结构（iam_user、platform_role等）
        8.   BC-10：初始化预置角色和权限
        9.   BC-10：创建租户管理员账号
        10.   BC-10：返回初始化结果给BC-11
        11.   BC-11：更新租户状态为"已激活"或"试用中"
        12.   BC-11：发布TenantActivated领域事件

    +   **接口调用关系**
        +   BC-11 → BC-10：租户IAM表初始化（内部接口）
        +   BC-10 → BC-11：根据tenant_id查询租户认证配置（内部接口，用于登录时获取SSO/LDAP配置）
        +   BC-10 → BC-11：根据tenant_id查询租户邮箱域名（内部接口，用于注册时校验）
        +   BC-10 → BC-11：根据tenant_id查询租户状态（内部接口，用于登录时校验租户是否有效）
        +   BC-10 → BC-11：根据tenant_code解析tenant_id（内部接口，用于登录时将tenant_code\username转换为tenant_id）
        +   BC-11 → 企业IdP：SSO配置连通测试 / IdP元数据获取（外部调用，P1）
        +   BC-11 → 企业LDAP：LDAP连接测试（外部调用，P1）

## 1.2 核心价值

+   **租户生命周期**: 提供租户从申请到注销的全生命周期管理能力
+   **企业IAM整合**: 支持与企业现有身份体系（SSO/LDAP/AD）无缝集成，P1核心能力
+   **多租户隔离**: 实现租户级数据库隔离，保障数据安全和隐私
+   **商业化运营**: 支持套餐订阅、计费账单、配额管理等商业化能力（P3-P5）
+   **运营分析**: 提供租户活跃度、流失预警等运营决策支持（P4-P6）

## 1.3 业务边界

+   **范围内**
    +   租户生命周期管理：创建、审批、激活、暂停、恢复、注销
    +   租户数据库与数据源管理：数据库创建/删除、连接池管理、动态路由
    +   租户配置管理：基本信息、邮箱域名、认证方式选择
    +   企业IAM集成配置：SSO配置（SAML/OIDC）、LDAP/AD配置
    +   租户商业化：套餐定义、订阅管理、计费与账单、发票管理（P3-P5）
    +   租户运维：配额管理、用量统计、监控告警、备份恢复（P2-P5）
    +   租户分析：活跃度分析、使用趋势、流失预警、运营报表（P4-P6）

+   **范围外**（由其他上下文负责）
    +   用户认证执行：SSO认证流程、LDAP认证流程（BC-10用户管理上下文）
    +   用户账号管理：用户CRUD、密码管理（BC-10用户管理上下文）
    +   角色权限管理：角色定义、权限分配（BC-10用户管理上下文）
    +   组织架构管理：部门、岗位、人员（BC-10用户管理上下文）
    +   操作审计管理：审计日志记录、安全审计（BC-10用户管理上下文）
    +   业务数据管理：各业务域数据（BC-01~BC-09业务上下文）
    +   企业IdP管理：IdP配置维护（由租户企业自行维护）
    +   支付网关对接：实际支付处理（第三方支付服务）
    +   财务核算：收入确认、财务报表（财务系统）

## 1.4 上下文协作关系

+   **提供服务给**
    +   BC-10（用户管理上下文）：租户认证配置查询、租户状态查询
    +   所有业务上下文（BC-01 ~ BC-09）：租户上下文信息
    +   网关层：租户路由、租户状态校验
    +   前端应用：租户配置管理界面

+   **依赖服务**
    +   BC-10（用户管理上下文）：租户IAM表初始化
    +   企业IdP（外部）：SSO认证（SAML/OIDC）
    +   企业LDAP（外部）：LDAP连接与认证
    +   支付网关（外部）：支付处理（P4）

+   **集成模式**
    +   开放主机服务 (OHS)：提供标准RESTful API
    +   发布语言 (PL)：使用标准JSON格式
    +   领域事件：发布租户生命周期事件供其他BC订阅

## 1.5 用户视角

+   BC-11同时服务两类用户，各自的核心关注点和操作范围不同。

### 1.5.1 UP视角（供给侧 - 平台运营方）

+   UP视角用户包括平台管理员、运营人员、财务人员、运维人员，核心职责如下表所示。

    | 角色       | 核心职责                 | 主要操作                             |
    | ---------- | ------------------------ | ------------------------------------ |
    | 平台管理员 | 租户全生命周期管控       | 租户创建、审批、暂停、注销           |
    | 运营人员   | 租户商业化运营、数据分析 | 套餐定义、配额分配、活跃度分析、报表 |
    | 财务人员   | 计费与账单管理           | 账单审核、发票开具、欠费处理         |
    | 运维人员   | 租户运维保障             | 资源监控、健康检查、备份恢复         |

    表 1.5.1-1 UP视角用户角色

+   UP视角API路径：`/api/v1/provider/tenant/**`

### 1.5.2 UR视角（消费侧 - 租户管理员）

+   UR视角用户为租户超级管理员，核心职责如下表所示。

    | 角色       | 核心职责                             | 主要操作                               |
    | ---------- | ------------------------------------ | -------------------------------------- |
    | 租户管理员 | 租户自身配置管理、订阅管理、用量查看 | 基本信息、认证配置、套餐升级、账单查看 |

    表 1.5.2-1 UR视角用户角色

+   UR视角API路径：`/api/v1/tenant/settings/**`

### 1.5.3 双视角对比

+   同一功能在不同视角下的操作差异如下表所示。

    | 功能领域     | UP视角（平台运营方）       | UR视角（租户管理员）         |
    | ------------ | -------------------------- | ---------------------------- |
    | 租户生命周期 | 创建、审批、强制暂停、注销 | -（无权限）                  |
    | 租户配置     | 查看所有租户配置           | 管理本租户配置（SSO/LDAP等） |
    | 订阅管理     | 套餐定义、定价策略         | 查看套餐、升级/续费          |
    | 计费账单     | 账单生成、审核、欠费处理   | 账单查看、发票申请           |
    | 配额管理     | 配额分配、全局监控         | 配额查看、用量查看           |
    | 数据分析     | 全局分析、运营报表         | -（无权限）                  |

    表 1.5.3-1 双视角功能对比

## 1.6 版本规划概览

+   BC-11按P1及P2-P6共六期规划。各期核心交付内容如下表所示。

    | 版本 | 核心主题                 | 交付内容                                                                      |
    | ---- | ------------------------ | ----------------------------------------------------------------------------- |
    | P1   | 私有化部署 + 企业IAM整合 | 租户直接开通（平台管理员直接创建）、租户配置（基本信息、邮箱域名、SSO、LDAP） |
    | P2   | 生命周期完善 + 基础运维  | 试用申请、审批、转正、暂停/恢复、注销、到期处理；品牌定制、配额管理、用量统计 |
    | P3   | 商业化基础               | 套餐定义、订阅管理、配额告警、功能开关                                        |
    | P4   | 商业化进阶               | 计费管理、账单管理、监控告警、活跃度分析                                      |
    | P5   | 商业化完善               | 续费管理、发票管理、备份恢复、流失预警                                        |
    | P6   | 运营智能化               | 自助开通、租户画像                                                            |

    表 1.6-1 版本规划概览

+   **P1 与 P2 的范围说明**：P1聚焦私有化部署的最小可用场景——平台管理员直接创建租户并完成企业IAM集成配置；P2补齐完整的租户生命周期管理能力（试用申请、审批、暂停、恢复、注销等）并增加基础运维能力。

+   P1核心聚焦图示：

    ```
    ┌───────────────────────────────────────────────────────────────────────┐
    │                        P1 核心交付范围                                │
    ├───────────────────────────────────────────────────────────────────────┤
    │                                                                       │
    │   私有化部署场景核心需求：                                            │
    │   ┌───────────────────────────────────────────────────────────────┐   │
    │   │  1. 单租户/少量租户，平台管理员直接开通，无需试用申请流程     │   │
    │   │  2. 必须对接企业现有IAM体系（AD/LDAP/SSO）                    │   │
    │   │  3. 快速完成身份认证集成，降低企业接入成本                    │   │
    │   └───────────────────────────────────────────────────────────────┘   │
    │                                                                       │
    │   P1交付范围：                                                        │
    │   ┌──────────────────────────────┐  ┌─────────────────────────────┐   │
    │   │ 【租户生命周期 - 直接开通】  │  │ 【租户配置 - 企业IAM整合】  │   │
    │   │                              │  │                             │   │
    │   │ ✓ 平台管理员直接创建租户     │  │ ✓ 基本信息维护              │   │
    │   │ ✓ 自动数据库创建+数据源注册  │  │ ✓ 邮箱域名配置              │   │
    │   │ ✓ 自动IAM初始化（调用BC-10） │  │ ✓ 认证方式选择              │   │
    │   │ ✓ 租户激活                   │  │ ✓ SSO-SAML配置              │   │
    │   │                              │  │ ✓ SSO-OIDC配置              │   │
    │   │ ✗ 试用申请/审批（P2）        │  │ ✓ LDAP/AD配置               │   │
    │   │ ✗ 暂停/恢复/注销（P2）       │  │                             │   │
    │   └──────────────────────────────┘  └─────────────────────────────┘   │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘
    ```

    图 1.6-1 P1核心交付范围

# 2 架构设计

+   本章记录BC-11租户管理上下文的关键架构设计。
+   这些设计决策对后续所有章节具有约束力，是理解本BC设计的前提和基础。

## 2.1 核心挑战

+   BC-11作为租户管理上下文（Tenant Operations），面临以下核心设计挑战：
    -   双视角服务：需要同时服务供给侧（UP，平台运营方）和消费侧（UR，租户管理员），两类用户的关注点和操作完全不同
    -   多子领域融合：BC-11涵盖租户生命周期、租户商业化、租户配置、租户运维、租户分析五个子领域，需要在单一上下文内实现清晰的职责划分
    -   租户隔离架构：需要为每个租户创建独立数据库，实现数据物理隔离，同时支持动态数据源路由
    -   跨BC协作编排：租户开通涉及BC-10（IAM初始化）和BC-01~09（业务表初始化）的协调，需要处理分布式事务和失败回滚
    -   商业化复杂性：订阅套餐、计费周期、配额管理、欠费处理等商业逻辑复杂，需要与租户生命周期紧密配合
    -   状态机复杂：租户生命周期涉及多种状态、多种转换路径，需要严格的状态机控制

### 2.1.1 P1核心聚焦：私有化部署与企业IAM整合

+   P1以私有化部署为主要场景，核心特点和约束如下表所示。

    | 维度       | 私有化部署特点                       | 对BC-11的影响                                 |
    | ---------- | ------------------------------------ | --------------------------------------------- |
    | 租户数量   | 单租户或极少量租户（1-5个）          | 简化多租户管理复杂度，平台管理员直接开通即可  |
    | 开通方式   | 无需试用申请和审批流程               | P1仅实现平台管理员直接开通，试用/审批延后至P2 |
    | 身份认证   | **必须对接企业现有IAM体系**          | SSO/LDAP是P1刚需，不是可选项                  |
    | 商业化需求 | 通常为一次性项目交付，无订阅计费需求 | 商业化子领域延后至P3-P5                       |
    | 运维需求   | 由企业IT部门自行运维                 | 租户运维功能可简化                            |
    | 定制化需求 | 品牌定制、功能裁剪                   | P2支持品牌定制，P3支持功能开关                |

    表 2.1.1-1 私有化部署场景特点

+   P1必须实现的企业IAM整合能力如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────┐
    │                    P1 企业IAM整合架构                           │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │                           企业现有IAM体系                       │
    │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
    │   │  企业IdP        │ │  Active         │ │  LDAP           │   │
    │   │  (Okta/Azure AD │ │  Directory      │ │  Server         │   │
    │   │   /ADFS/...)    │ │                 │ │                 │   │
    │   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘   │
    │            │ SAML/OIDC         │ Kerberos          │ LDAP       │
    │            │                   │                   │            │
    │   ┌────────▼───────────────────▼───────────────────▼────────┐   │
    │   │                                                         │   │
    │   │                 BC-11 租户配置                          │   │
    │   │   ┌─────────────────────────────────────────────────┐   │   │
    │   │   │              认证配置管理                       │   │   │
    │   │   │                                                 │   │   │
    │   │   │  • SSO-SAML配置：IdP元数据、SP配置、属性映射    │   │   │
    │   │   │  • SSO-OIDC配置：Client ID/Secret、端点URL      │   │   │
    │   │   │  • LDAP配置：服务器地址、绑定DN、搜索过滤器     │   │   │
    │   │   │  • 认证方式选择：本地/SSO/LDAP/混合             │   │   │
    │   │   └─────────────────────────────────────────────────┘   │   │
    │   │                                                         │   │
    │   └─────────────────────────────┬───────────────────────────┘   │
    │                                 │ 提供配置                      │
    │                                 ▼                               │
    │   ┌─────────────────────────────────────────────────────────┐   │
    │   │                                                         │   │
    │   │         BC-10 用户管理（认证执行+审计）                 │   │
    │   │   ┌─────────────────────────────────────────────────┐   │   │
    │   │   │              认证服务                           │   │   │
    │   │   │                                                 │   │   │
    │   │   │  • 从BC-11查询租户认证配置                      │   │   │
    │   │   │  • 根据配置执行SSO/LDAP认证流程                 │   │   │
    │   │   │  • 处理SAML断言/OIDC Token/LDAP绑定             │   │   │
    │   │   │  • 完成用户身份映射和会话建立                   │   │   │
    │   │   └─────────────────────────────────────────────────┘   │   │
    │   │                                                         │   │
    │   └─────────────────────────────────────────────────────────┘   │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```
    图 2.1.1-1 P1企业IAM整合架构

+   BC-11与BC-10在认证方面的职责划分：
    -   **BC-11职责**：存储和管理租户的认证配置（SSO配置、LDAP配置、认证方式选择）
    -   **BC-10职责**：查询BC-11的配置，执行实际的认证流程（SAML断言处理、LDAP绑定验证）；同时负责操作审计日志记录

## 2.2 用户视角分析

### 2.2.1 双视角服务模型

+   BC-11需要同时服务两类用户，各自关注点如下表所示。

    | 维度     | UP（供给侧 - 平台运营方）        | UR（消费侧 - 租户管理员）          |
    | -------- | -------------------------------- | ---------------------------------- |
    | 角色定位 | 平台管理员、运营人员、财务人员   | 租户超级管理员                     |
    | 核心关注 | 租户全生命周期管控、商业运营     | 租户自身配置、订阅与用量           |
    | 操作特点 | 管理所有租户、制定规则、监控全局 | 管理自己租户、按规则操作、查看自身 |
    | 数据范围 | 全平台租户数据                   | 仅本租户数据                       |
    | 典型场景 | 租户审批、套餐定价、欠费处理     | SSO配置、套餐升级、账单查看        |

    表 2.2.1-1 双视角服务模型

### 2.2.2 UP视角职责总览

+   供给侧（UP）用户在BC-11中的职责如下表所示。

    | 职责板块     | 核心职责                                             | 操作者        |
    | ------------ | ---------------------------------------------------- | ------------- |
    | 租户生命周期 | 租户创建/审批、激活、强制暂停/恢复、注销、数据源管理 | 平台管理员    |
    | 租户商业化   | 套餐定义、定价策略、计费账单、资源配额分配、欠费处理 | 运营/财务人员 |
    | 租户运维     | 资源用量监控、健康度检查、数据备份恢复、故障处理     | 运维人员      |
    | 租户分析     | 活跃度分析、使用趋势、流失预警、运营报表、租户画像   | 运营人员      |

    表 2.2.2-1 UP视角职责总览

### 2.2.3 UR视角职责总览

+   消费侧（UR）用户在BC-11中的职责如下表所示。

    | 职责板块 | 核心职责                                                  | 操作者     |
    | -------- | --------------------------------------------------------- | ---------- |
    | 租户配置 | 基本信息维护、邮箱域名、认证方式、SSO/LDAP、品牌定制      | 租户管理员 |
    | 订阅管理 | 当前套餐查看、套餐升级/续费、账单查看、发票申请、试用转正 | 租户管理员 |
    | 用量查看 | 存储用量、用户数统计、API调用量、配额余量                 | 租户管理员 |

    表 2.2.3-1 UR视角职责总览

### 2.2.4 双视角架构图

+   BC-11双视角服务架构如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    BC-11 租户管理上下文 - 双视角架构                        │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐   │
    │   │                   UP视角（供给侧 - 平台运营方）                     │   │
    │   │                                                                     │   │
    │   │   /api/v1/provider/tenant/**                                        │   │
    │   │                                                                     │   │
    │   │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
    │   │   │租户生命周期 │ │ 租户商业化  │ │  租户运维   │ │  租户分析   │   │   │
    │   │   │             │ │             │ │             │ │             │   │   │
    │   │   │• 创建/审批  │ │• 套餐定义   │ │• 资源监控   │ │• 活跃度     │   │   │
    │   │   │• 激活/暂停  │ │• 定价策略   │ │• 健康检查   │ │• 使用趋势   │   │   │
    │   │   │• 注销       │ │• 计费账单   │ │• 备份恢复   │ │• 流失预警   │   │   │
    │   │   │• 数据源管理 │ │• 配额分配   │ │• 故障处理   │ │• 运营报表   │   │   │
    │   │   │• 强制操作   │ │• 欠费处理   │ │             │ │• 租户画像   │   │   │
    │   │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
    │   │                                                                     │   │
    │   └─────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐   │
    │   │                   UR视角（消费侧 - 租户管理员）                     │   │
    │   │                                                                     │   │
    │   │   /api/v1/tenant/settings/**                                        │   │
    │   │                                                                     │   │
    │   │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │   │
    │   │   │    租户配置     │ │    订阅管理     │ │    用量查看     │       │   │
    │   │   │                 │ │                 │ │                 │       │   │
    │   │   │ • 基本信息维护  │ │ • 当前套餐查看  │ │ • 存储用量      │       │   │
    │   │   │ • 邮箱域名配置  │ │ • 套餐升级/续费 │ │ • 用户数统计    │       │   │
    │   │   │ • 认证方式选择  │ │ • 账单查看      │ │ • API调用量     │       │   │
    │   │   │ • SSO配置       │ │ • 发票申请      │ │ • 配额余量      │       │   │
    │   │   │ • LDAP配置      │ │ • 试用转正      │ │                 │       │   │
    │   │   │ • 品牌定制      │ │                 │ │                 │       │   │
    │   │   └─────────────────┘ └─────────────────┘ └─────────────────┘       │   │
    │   │                                                                     │   │
    │   └─────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.2.4-1 BC-11双视角服务架构图

## 2.3 子领域划分

### 2.3.1 子领域识别

+   BC-11包含五个子领域，按业务职能划分如下表所示。

    | 子领域       | 英文名称      | 一句话描述         | 关注的核心问题           | 服务视角              |
    | ------------ | ------------- | ------------------ | ------------------------ | --------------------- |
    | 租户生命周期 | Lifecycle     | 管理"租户的生死"   | 租户从创建到注销的全过程 | UP                    |
    | 租户商业化   | Commercialize | 管理"租户的钱"     | 套餐、计费、配额、续费   | UP + UR               |
    | 租户配置     | Configuration | 管理"租户的个性化" | 认证配置、品牌定制       | UR（主） + UP（只读） |
    | 租户运维     | Operations    | 管理"租户的健康"   | 监控、告警、备份、故障   | UP + UR               |
    | 租户分析     | Analytics     | 洞察"租户的价值"   | 活跃度、趋势、流失、画像 | UP                    |

    表 2.3.1-1 子领域识别

+   五个子领域的关系可以用一句话概括：**租户生命周期**控制租户存亡，**租户商业化**驱动商业价值，**租户配置**满足个性需求，**租户运维**保障稳定运行，**租户分析**支撑运营决策。

### 2.3.2 子领域职责边界

+   各子领域的详细职责边界如下表所示。

    | 子领域       | 职责范围                                               | 核心概念                                    | 不负责的内容            |
    | ------------ | ------------------------------------------------------ | ------------------------------------------- | ----------------------- |
    | 租户生命周期 | 租户创建/审批、激活、暂停、恢复、注销、数据源管理      | Tenant, TenantStatus, DataSource            | 用户管理、业务数据      |
    | 租户商业化   | 套餐定义、定价、计费、账单、配额、续费、试用、欠费处理 | Subscription, Plan, Billing, Quota, Invoice | 支付网关对接、财务核算  |
    | 租户配置     | 基本信息、邮箱域名、认证方式、SSO/LDAP、品牌定制       | TenantConfig, AuthConfig, BrandConfig       | 认证执行（由BC-10负责） |
    | 租户运维     | 资源监控、健康检查、备份恢复、故障处理、用量统计       | Monitoring, HealthCheck, Backup, Usage      | 基础设施运维、日志分析  |
    | 租户分析     | 活跃度分析、使用趋势、流失预警、运营报表、租户画像     | Activity, Trend, ChurnRisk, Report, Profile | BI报表、数据仓库        |

    表 2.3.2-1 子领域职责边界

+   边界划分说明：
    -   租户生命周期只关心"租户的状态流转"，不关心租户内的用户和业务数据
    -   租户商业化只关心"商业规则和计费"，实际支付由支付网关处理
    -   租户配置只关心"配置的存储和查询"，实际的SSO/LDAP认证由BC-10执行
    -   租户运维只关心"租户级别的监控和运维"，基础设施运维由平台运维团队负责
    -   租户分析只关心"租户维度的分析"，全局BI分析由独立的数据平台负责

### 2.3.3 子领域关系图

+   五个子领域的依赖关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         BC-11 子领域关系图                                  │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                          ┌─────────────────┐                                │
    │                          │   租户生命周期  │                                │
    │                          │   (Lifecycle)   │                                │
    │                          │                 │                                │
    │                          │ • 租户创建/激活 │                                │
    │                          │ • 租户暂停/注销 │                                │
    │                          │ • 数据源管理    │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │                    ┌──────────────┼──────────────┐                          │
    │                    │              │              │                          │
    │                    │ 触发商业化   │ 触发配置     │                          │
    │                    ▼              ▼              ▼                          │
    │          ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │
    │          │   租户商业化    │ │    租户配置     │ │    租户运维     │        │
    │          │ (Commercialize) │ │ (Configuration) │ │  (Operations)   │        │
    │          │                 │ │                 │ │                 │        │
    │          │ • 套餐/计费     │ │ • 认证配置      │ │ • 资源监控      │        │
    │          │ • 配额管理      │ │ • SSO/LDAP      │ │ • 健康检查      │        │
    │          │ • 账单/发票     │ │ • 品牌定制      │ │ • 备份恢复      │        │
    │          └────────┬────────┘ └─────────────────┘ └────────┬────────┘        │
    │                   │                                       │                 │
    │                   │ 提供配额数据         提供用量数据     │                 │
    │                   │                                       │                 │
    │                   └───────────────┬───────────────────────┘                 │
    │                                   │                                         │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │    租户分析     │                                │
    │                          │   (Analytics)   │                                │
    │                          │                 │                                │
    │                          │ • 活跃度分析    │                                │
    │                          │ • 流失预警      │                                │
    │                          │ • 运营报表      │                                │
    │                          │ • 租户画像      │                                │
    │                          └─────────────────┘                                │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.3.3-1 BC-11子领域关系图

+   依赖关系说明：
    -   租户生命周期是核心子领域，租户创建后触发商业化（订阅）和配置（初始化）
    -   租户商业化的配额数据影响租户运维的监控告警
    -   租户运维的用量数据反馈给租户商业化（用于计费）和租户分析
    -   租户分析汇聚各子领域数据，输出洞察报告

### 2.3.4 子领域与章节映射

    | 子领域       | 对应章节           | 章节内容                                 | 版本范围 |
    | ------------ | ------------------ | ---------------------------------------- | -------- |
    | 租户生命周期 | 第3章 租户生命周期 | 创建、激活、暂停、恢复、注销、数据源管理 | P1-P2    |
    | 租户配置     | 第4章 租户配置     | 基本信息、认证配置、SSO/LDAP、品牌定制   | P1-P3    |
    | 租户商业化   | 第5章 租户商业化   | 套餐、计费、账单、配额、续费、试用转正   | P3-P6    |
    | 租户运维     | 第6章 租户运维     | 资源监控、健康检查、备份恢复、用量统计   | P2-P5    |
    | 租户分析     | 第7章 租户分析     | 活跃度、趋势、流失预警、报表、画像       | P4-P6    |

    表 2.3.4-1 子领域与章节映射

+   **章节说明**：本文档当前版本（V0.10）详细描述第3章（租户生命周期）和第4章（租户配置）的P1范围设计，第5-7章将在后续版本中补充。

## 2.4 租户生命周期概要

### 2.4.1 职责范围

+   租户生命周期子领域负责管理"租户的生死"，核心职责如下表所示。

    | 职责分类     | 具体职责                                   | 操作者     | 版本计划 |
    | ------------ | ------------------------------------------ | ---------- | -------- |
    | 租户直接开通 | 平台管理员直接创建租户、触发自动化开通流程 | 平台管理员 | P1       |
    | 数据源管理   | 数据库创建/删除、连接池管理、动态路由      | 系统自动   | P1       |
    | 租户激活     | 完成初始化、更新状态为已激活、发布激活事件 | 系统自动   | P1       |
    | 试用申请     | 企业用户提交试用申请                       | 企业用户   | P2       |
    | 租户审批     | 试用申请审批                               | 平台管理员 | P2       |
    | 试用转正     | 试用租户升级为正式租户                     | 租户管理员 | P2       |
    | 租户暂停     | 暂停服务、关闭数据源、记录暂停原因         | 平台管理员 | P2       |
    | 租户恢复     | 恢复服务、重建数据源、清除暂停原因         | 平台管理员 | P2       |
    | 租户注销     | 归档或删除数据、清理资源、发布注销事件     | 平台管理员 | P2       |

    表 2.4.1-1 租户生命周期职责范围

### 2.4.2 租户状态机

+   租户生命周期涉及10种状态，状态转换规则如下表所示。

    | 当前状态 | 英文标识     | 可转换到的状态              | 触发条件                |
    | -------- | ------------ | --------------------------- | ----------------------- |
    | 待审批   | PENDING      | CREATING, REJECTED          | 审批通过/拒绝           |
    | 已拒绝   | REJECTED     | -                           | 终态                    |
    | 创建中   | CREATING     | INITIALIZING                | 数据库创建成功          |
    | 初始化中 | INITIALIZING | ACTIVE, TRIAL               | IAM表和业务表初始化成功 |
    | 试用中   | TRIAL        | ACTIVE, SUSPENDED, EXPIRED  | 转正/暂停/到期          |
    | 已激活   | ACTIVE       | SUSPENDED, DEACTIVATING     | 暂停/注销               |
    | 已暂停   | SUSPENDED    | ACTIVE, TRIAL, DEACTIVATING | 恢复/注销               |
    | 已过期   | EXPIRED      | ACTIVE, DEACTIVATING        | 续费/注销               |
    | 注销中   | DEACTIVATING | DEACTIVATED                 | 数据库清理完成          |
    | 已注销   | DEACTIVATED  | -                           | 终态，不可转换          |

    表 2.4.2-1 租户状态转换规则

+   **状态转换约束说明**
    -   ACTIVE（已激活）状态不支持逆向转换为TRIAL（试用中），原因如下：
        -   正式租户已绑定商业合同和计费周期，逆向转换会导致商业数据混乱
        -   试用租户的功能和配额限制不适用于已享受正式服务的企业用户
        -   如需为正式租户提供类似"体验新功能"的场景，应通过功能开关（P3）实现，而非状态降级

+   状态机图如下所示。

    ```
    ┌──────────────────────────────────────────────────────────────┐
    │                              租户状态机                      │
    ├──────────────────────────────────────────────────────────────┤
    │                                                              │
    │                              ┌──────────┐                    │
    │                       ┌─────▶│ REJECTED │ （终态）           │
    │                       │      │ (已拒绝) │                    │
    │                       │ 拒绝 └──────────┘                    │
    │                       │                                      │
    │  ┌──────────┐  申请   │  ┌──────────────┐                    │
    │  │          │─────────┴─▶│              │                    │
    │  │   新建   │            │   PENDING    │                    │
    │  │          │            │   (待审批)   │                    │
    │  └──────────┘            └──────┬───────┘                    │
    │                                 │ 审批通过                   │
    │                                 ▼                            │
    │                          ┌──────────────┐                    │
    │                          │              │                    │
    │                          │   CREATING   │                    │
    │                          │   (创建中)   │                    │
    │                          └──────┬───────┘                    │
    │                                 │ 数据库创建成功             │
    │                                 ▼                            │
    │                          ┌──────────────┐                    │
    │                          │              │                    │
    │                          │INITIALIZING  │                    │
    │                          │(初始化中)    │                    │
    │                          └──────┬───────┘                    │
    │                                 │                            │
    │                       ┌─────────┴─────────┐                  │
    │                       │                   │                  │
    │                       ▼                   ▼                  │
    │             ┌──────────────┐      ┌──────────────┐           │
    │             │              │ 转正 │              │           │
    │    resume() │   ACTIVE     │◀──── │    TRIAL     │◀────┐     │
    │    ┌────────│   (已激活)   │──┐   │   (试用中)   │     │     │
    │    │        └──────┬───────┘  │   └──────┬───────┘     │     │
    │    │               │ 转正     │          │             │     │
    │    │               │          │     trial_expired      │     │
    │    │               │ suspend( │          │            续期   │
    │    │               ▼          │          ▼             │     │
    │    │        ┌──────────────┐  │   ┌──────────────┐     │     │
    │    │        │              │  │   │              │     │     │
    │    └───────▶│  SUSPENDED   │  │   │   EXPIRED    │─────┘     │
    │             │  (已暂停)    │  │   │   (已过期)   │           │
    │             └──────┬───────┘  │   └──────┬───────┘           │
    │                    │          │          │                   │
    │    deactivate()    │          │     deactivate()             │
    │                    ▼          │          │                   │
    │             ┌──────────────┐  │          │                   │
    │             │              │◀─┘          │                   │
    │             │DEACTIVATING  │◀────────────┘                   │
    │             │(注销中)      │                                 │
    │             └──────┬───────┘                                 │
    │                    │ 数据库清理完成                          │
    │                    ▼                                         │
    │             ┌──────────────┐                                 │
    │             │              │                                 │
    │             │ DEACTIVATED  │ （终态）                        │
    │             │ (已注销)     │                                 │
    │             └──────────────┘                                 │
    │                                                              │
    └──────────────────────────────────────────────────────────────┘
    ```

    图 2.4.2-1 租户状态机

+   **P1可达路径**：create() → CREATING → INITIALIZING → ACTIVE（跳过PENDING，不支持TRIAL）

### 2.4.3 租户类型

+   系统支持两种租户类型，如下表所示。

    | 租户类型 | 英文标识 | 说明             | 用户上限 | 有效期   | 功能范围   | 初始状态 |
    | -------- | -------- | ---------------- | -------- | -------- | ---------- | -------- |
    | 试用租户 | TRIAL    | 企业试用体验     | 5人      | 30天     | 基础功能   | TRIAL    |
    | 正式租户 | OFFICIAL | 正式签约企业客户 | 按套餐   | 按订阅期 | 按订阅套餐 | ACTIVE   |

    表 2.4.3-1 租户类型

### 2.4.4 多租户数据隔离架构

+   系统采用**数据库级隔离**（Database per Tenant）架构，每个租户拥有独立数据库。
+   数据库命名规则：`clarisphere_t<tenant_id>`，如 clarisphere_t1001、clarisphere_t1002。
+   **设计说明**：数据库名使用不可变的 tenant_id 而非可变的 tenant_code，避免 tenant_code 修改后数据库名不一致。
+   多租户数据隔离架构如下图所示。

    ```
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                         多租户数据隔离架构                                │
    ├───────────────────────────────────────────────────────────────────────────┤
    │                                                                           │
    │   ┌───────────────────────────────────────────────────────────────────┐   │
    │   │                          请求入口层                               │   │
    │   │                                                                   │   │
    │   │   请求头携带 X-Tenant-Id 或 从JWT Token中解析 tenant_id           │   │
    │   └───────────────────────────────────────────────────────────────────┘   │
    │                                    │                                      │
    │                                    ▼                                      │
    │   ┌───────────────────────────────────────────────────────────────────┐   │
    │   │                      动态数据源路由层                             │   │
    │   │                                                                   │   │
    │   │   ┌───────────────────────────────────────────────────────────┐   │   │
    │   │   │              DynamicDataSource                            │   │   │
    │   │   │                                                           │   │   │
    │   │   │   • 继承 AbstractRoutingDataSource                        │   │   │
    │   │   │   • determineCurrentLookupKey() 返回 tenant_id            │   │   │
    │   │   │   • 从 ThreadLocal 获取当前租户标识                       │   │   │
    │   │   └───────────────────────────────────────────────────────────┘   │   │
    │   └───────────────────────────────────────────────────────────────────┘   │
    │                                    │                                      │
    │                  ┌─────────────────┼─────────────────┐                    │
    │                  │                 │                 │                    │
    │                  ▼                 ▼                 ▼                    │
    │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐             │
    │   │  DataSource     │ │  DataSource     │ │  DataSource     │             │
    │   │  Key: 1001      │ │  Key: 1002      │ │  Key: 1003      │             │
    │   │  HikariCP       │ │  HikariCP       │ │  HikariCP       │             │
    │   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘             │
    │            │                   │                   │                      │
    │            ▼                   ▼                   ▼                      │
    │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐             │
    │   │   MySQL         │ │   MySQL         │ │   MySQL         │             │
    │   │clarisphere_t1001│ │clarisphere_t1002│ │clarisphere_t1003│             │
    │   │                 │ │                 │ │                 │             │
    │   └─────────────────┘ └─────────────────┘ └─────────────────┘             │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.4.4-1 多租户数据隔离架构图

+   **tenant_id 与 tenant_code 的职责分工**
    -   **tenant_id**（Long，主键，不可变）：用于数据库命名（clarisphere_t{tenant_id}）、数据源路由键（DynamicDataSource lookup key）、JWT Token claims、请求头（X-Tenant-Id）、用户归属标识、跨BC协作参数
    -   **tenant_code**（String，4-20位，全局唯一，**可修改**）：仅用于用户登录时的输入标识，格式为 `tenant_code\username`。后端在认证流程中将 tenant_code 解析为 tenant_id，后续所有内部操作均使用 tenant_id
    -   **设计原因**：tenant_code 作为人可读标识允许企业在品牌变更等场景下修改，而 tenant_id 作为技术标识保持不可变，避免修改代号导致数据库名、路由键、引用关系断裂

### 2.4.5 核心概念

+   租户生命周期子领域的核心概念如下表所示。

    | 概念       | 英文              | 说明                                                       |
    | ---------- | ----------------- | ---------------------------------------------------------- |
    | 租户       | Tenant            | 企业客户在平台上的逻辑隔离单元                             |
    | 租户ID     | TenantId          | 租户主键（Long），不可变，用于数据库命名、路由键、用户区分 |
    | 租户代号   | TenantCode        | 租户人可读标识（4-20位），全局唯一，可修改，仅用于登录输入 |
    | 租户状态   | TenantStatus      | 租户当前状态（10种状态的枚举）                             |
    | 数据源     | DataSource        | HikariCP连接池实例                                         |
    | 动态数据源 | DynamicDataSource | 基于 tenant_id 路由的数据源                                |

    表 2.4.5-1 租户生命周期核心概念

+   **tenant_id生成策略说明**
    -   tenant_id采用数据库自增主键（AUTO_INCREMENT）生成
    -   考虑到SaaS平台的实际业务规模，单一MySQL实例的自增主键完全能够满足租户数量需求（百万级）
    -   私有化部署场景下租户数量通常为个位数至百位数，分布式ID生成器的复杂性收益不足
    -   若未来演进为超大规模多集群部署，可通过配置不同的AUTO_INCREMENT起始值和步长实现分片，或升级为雪花算法

## 2.5 租户商业化概要

### 2.5.1 职责范围

+   租户商业化子领域负责管理"租户的钱"，核心职责如下表所示。

    | 职责分类 | 具体职责（UP视角）           | 具体职责（UR视角）           | 版本计划 |
    | -------- | ---------------------------- | ---------------------------- | -------- |
    | 套餐管理 | 套餐定义、定价策略、功能配置 | 当前套餐查看                 | P3       |
    | 订阅管理 | -                            | 套餐升级、套餐降级、试用转正 | P3       |
    | 计费管理 | 计费规则、计费周期、费用计算 | -                            | P4       |
    | 账单管理 | 账单生成、账单审核           | 账单查看、账单下载           | P4       |
    | 发票管理 | 发票审核、发票开具           | 发票申请、发票查看           | P5       |
    | 配额管理 | 配额分配、配额调整           | 配额查看                     | P2       |
    | 续费管理 | 续费提醒配置                 | 续费操作                     | P5       |
    | 欠费处理 | 欠费策略、欠费暂停、欠费通知 | -                            | P4       |

    表 2.5.1-1 租户商业化职责范围

### 2.5.2 订阅套餐体系

+   系统支持多级订阅套餐，如下表所示。

    | 套餐级别 | 英文标识   | 用户数上限 | 存储配额 | API调用/月 | 功能范围      | 价格（示例） |
    | -------- | ---------- | ---------- | -------- | ---------- | ------------- | ------------ |
    | 试用版   | TRIAL      | 5人        | 1GB      | 1,000次    | 基础功能      | 免费         |
    | 基础版   | BASIC      | 20人       | 10GB     | 10,000次   | 标准功能      | ¥999/月      |
    | 标准版   | STANDARD   | 100人      | 100GB    | 100,000次  | 高级功能      | ¥4,999/月    |
    | 企业版   | ENTERPRISE | 500人      | 500GB    | 500,000次  | 全部功能+SSO  | ¥19,999/月   |
    | 旗舰版   | FLAGSHIP   | 不限       | 不限     | 不限       | 全部功能+定制 | 按需报价     |

    表 2.5.2-1 订阅套餐体系

+   **私有化部署与SaaS场景的区别**：私有化部署场景下不受套餐限制，所有租户默认拥有全部功能（含SSO/LDAP）；上述套餐体系仅适用于SaaS多租户场景（P3+）。

### 2.5.3 计费模式

+   系统支持多种计费模式，如下表所示。

    | 计费模式   | 说明                           | 适用套餐                    |
    | ---------- | ------------------------------ | --------------------------- |
    | 包年包月   | 按固定周期收费，预付费         | BASIC、STANDARD、ENTERPRISE |
    | 按量付费   | 按实际使用量收费，后付费       | 超出配额部分                |
    | 一次性付费 | 定制开发、数据迁移等一次性服务 | FLAGSHIP定制服务            |

    表 2.5.3-1 计费模式

### 2.5.4 核心概念

+   租户商业化子领域的核心概念如下表所示。

    | 概念     | 英文         | 说明                                  |
    | -------- | ------------ | ------------------------------------- |
    | 订阅     | Subscription | 租户对某套餐的订阅关系，含有效期      |
    | 套餐     | Plan         | 预定义的功能和配额组合                |
    | 计费周期 | BillingCycle | 计费的时间周期（月/季/年）            |
    | 账单     | Bill         | 某计费周期的费用明细                  |
    | 发票     | Invoice      | 根据账单开具的财务凭证                |
    | 配额     | Quota        | 资源使用上限（用户数、存储、API调用） |

    表 2.5.4-1 租户商业化核心概念

## 2.6 租户配置概要

### 2.6.1 职责范围

+   租户配置子领域负责管理"租户的个性化"，核心职责如下表所示。
+   **P1重点**：私有化部署场景下，企业IAM整合（SSO/LDAP）是刚需，优先级最高。

    | 职责分类 | 具体职责                       | 操作者     | 版本计划 |
    | -------- | ------------------------------ | ---------- | -------- |
    | 基本信息 | 租户名称、联系人、企业信息维护 | 租户管理员 | P1       |
    | 邮箱域名 | 配置允许注册的企业邮箱域名     | 租户管理员 | P1       |
    | 认证配置 | 选择认证方式（本地/SSO/LDAP）  | 租户管理员 | P1       |
    | SSO配置  | 配置SAML/OIDC单点登录          | 租户管理员 | P1       |
    | LDAP配置 | 配置企业LDAP/AD服务器          | 租户管理员 | P1       |
    | 品牌定制 | Logo、主题色、登录页定制       | 租户管理员 | P2       |
    | 功能开关 | 启用/禁用特定功能模块          | 租户管理员 | P3       |

    表 2.6.1-1 租户配置职责范围

### 2.6.2 认证方式选择

+   租户可选择的认证方式如下表所示。
+   **私有化部署场景**：企业客户通常已有统一身份认证体系，SSO和LDAP是P1必须支持的能力。

    | 认证方式 | 说明                       | 适用场景              | 版本 |
    | -------- | -------------------------- | --------------------- | ---- |
    | 本地认证 | 用户名+密码，由平台管理    | 默认方式、小型企业    | P1   |
    | SSO-SAML | 基于SAML 2.0协议的单点登录 | 已有IdP的企业         | P1   |
    | SSO-OIDC | 基于OIDC协议的单点登录     | 现代云应用集成        | P1   |
    | LDAP/AD  | 对接企业Active Directory   | 使用微软AD的企业      | P1   |
    | 混合模式 | 本地+SSO/LDAP共存          | 部分用户使用SSO的企业 | P2   |

    表 2.6.2-1 认证方式选择

### 2.6.3 与BC-10的协作

+   租户配置与BC-10（用户管理上下文）的协作关系如下表所示。BC-10通过 tenant_id 查询配置。

    | 配置项   | BC-11职责（存储与管理）        | BC-10职责（使用与执行）          |
    | -------- | ------------------------------ | -------------------------------- |
    | 邮箱域名 | 存储、增删改查                 | 用户注册时校验邮箱域名           |
    | SSO配置  | 存储IdP元数据、配置回调URL     | 执行SSO认证流程、处理断言        |
    | LDAP配置 | 存储服务器地址、绑定DN、过滤器 | 执行LDAP认证、用户同步           |
    | 审计日志 | 发布领域事件                   | 订阅事件后记录操作审计和安全审计 |

    表 2.6.3-1 租户配置与BC-10协作

### 2.6.4 核心概念

+   租户配置子领域的核心概念如下表所示。

    | 概念     | 英文         | 说明                                     |
    | -------- | ------------ | ---------------------------------------- |
    | 租户配置 | TenantConfig | 租户环境配置的聚合根                     |
    | 邮箱域名 | EmailDomain  | 允许注册的企业邮箱后缀（如@icbc.com.cn） |
    | 认证配置 | AuthConfig   | 认证方式选择及相关配置                   |
    | SSO配置  | SsoConfig    | SAML/OIDC单点登录配置                    |
    | LDAP配置 | LdapConfig   | 企业LDAP服务器连接配置                   |
    | 品牌配置 | BrandConfig  | Logo、主题色、登录页等品牌定制           |

    表 2.6.4-1 租户配置核心概念

## 2.7 租户运维概要

### 2.7.1 职责范围

+   租户运维子领域负责管理"租户的健康"，核心职责如下表所示。

    | 职责分类 | 具体职责（UP视角）               | 具体职责（UR视角） | 版本计划 |
    | -------- | -------------------------------- | ------------------ | -------- |
    | 资源监控 | 全局资源用量监控、异常检测       | 本租户用量查看     | P4       |
    | 健康检查 | 数据库连接检查、服务可用性检查   | -                  | P4       |
    | 配额告警 | 配额超限告警、告警规则配置       | 配额余量提醒       | P3       |
    | 数据备份 | 备份策略配置、手动备份、备份列表 | 备份申请、备份下载 | P5       |
    | 数据恢复 | 恢复操作、恢复审批               | 恢复申请           | P5       |
    | 故障处理 | 故障诊断、故障恢复、故障记录     | -                  | P4       |
    | 用量统计 | 全局用量报表                     | 本租户用量详情     | P2       |

    表 2.7.1-1 租户运维职责范围

### 2.7.2 监控指标

+   租户运维关注的监控指标如下表所示。

    | 指标分类   | 具体指标                   | 告警阈值（示例）     |
    | ---------- | -------------------------- | -------------------- |
    | 存储用量   | 数据库大小、文件存储大小   | 配额80%、100%        |
    | 用户数量   | 总用户数、活跃用户数       | 配额90%、100%        |
    | API调用    | 日调用量、月调用量         | 配额80%、100%        |
    | 数据库健康 | 连接数、慢查询数、响应时间 | 连接池80%、慢查询>10 |
    | 活跃度     | 日登录次数、周活跃用户数   | 7天无登录            |

    表 2.7.2-1 租户运维监控指标

### 2.7.3 核心概念

+   租户运维子领域的核心概念如下表所示。

    | 概念   | 英文        | 说明                          |
    | ------ | ----------- | ----------------------------- |
    | 用量   | Usage       | 资源使用量（存储、用户、API） |
    | 配额   | Quota       | 资源使用上限                  |
    | 告警   | Alert       | 配额超限或异常的通知          |
    | 备份   | Backup      | 租户数据的备份文件            |
    | 健康度 | HealthScore | 租户整体健康状况评分          |

    表 2.7.3-1 租户运维核心概念

## 2.8 租户分析概要

### 2.8.1 职责范围

+   租户分析子领域负责洞察"租户的价值"，核心职责如下表所示。

    | 职责分类   | 具体职责                                 | 操作者   | 版本计划 |
    | ---------- | ---------------------------------------- | -------- | -------- |
    | 活跃度分析 | 登录频率、功能使用率、用户活跃占比       | 运营人员 | P4       |
    | 使用趋势   | 用量增长趋势、功能使用趋势、用户增长趋势 | 运营人员 | P4       |
    | 流失预警   | 活跃度下降检测、到期未续费预警、风险评分 | 运营人员 | P5       |
    | 运营报表   | 租户概览报表、收入报表、增长报表         | 运营人员 | P4       |
    | 租户画像   | 行业分布、规模分布、使用特征、价值评估   | 运营人员 | P6       |

    表 2.8.1-1 租户分析职责范围

### 2.8.2 分析维度

+   租户分析的主要维度如下表所示。

    | 分析维度 | 具体指标                                  |
    | -------- | ----------------------------------------- |
    | 活跃度   | DAU、WAU、MAU、功能使用次数、平均会话时长 |
    | 成长性   | 用户增长率、用量增长率、功能渗透率        |
    | 价值度   | ARR贡献、续费率、升级率、LTV              |
    | 健康度   | 登录稳定性、功能覆盖率、配额使用率        |
    | 风险度   | 活跃下降幅度、到期天数、欠费金额          |

    表 2.8.2-1 租户分析维度

### 2.8.3 核心概念

+   租户分析子领域的核心概念如下表所示。

    | 概念     | 英文      | 说明                     |
    | -------- | --------- | ------------------------ |
    | 活跃度   | Activity  | 租户使用平台的频率和深度 |
    | 流失风险 | ChurnRisk | 租户流失的可能性评分     |
    | 租户画像 | Profile   | 租户的特征标签集合       |
    | 运营报表 | Report    | 汇总租户数据的定期报表   |
    | LTV      | LTV       | 客户生命周期价值         |

    表 2.8.3-1 租户分析核心概念

## 2.9 架构总览

### 2.9.1 整体架构图

+   BC-11整体架构如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        BC-11 整体架构图                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌───────────────────────────────────────────────────────────────────────┐  │
    │  │                          接口层 (Interfaces)                          │  │
    │  ├──────────────────────────────────┬────────────────────────────────────┤  │
    │  │    UP视角（供给侧）              │      UR视角（消费侧）              │  │
    │  │    /api/v1/provider/tenant/**    │      /api/v1/tenant/settings/**    │  │
    │  │                                  │                                    │  │
    │  │    • 租户生命周期管理            │      • 租户配置管理                │  │
    │  │    • 套餐定义与定价              │      • 订阅查看与升级              │  │
    │  │    • 计费与账单管理              │      • 账单与发票查看              │  │
    │  │    • 全局监控与运维              │      • 用量查看                    │  │
    │  │    • 租户分析报表                │                                    │  │
    │  └───────────────┬──────────────────┴────────────────┬───────────────────┘  │
    │                  │                                   │                      │
    │  ┌───────────────▼───────────────────────────────────▼───────────────────┐  │
    │  │                          应用服务层                                   │  │
    │  ├─────────────┬─────────────┬─────────────┬─────────────┬───────────────┤  │
    │  │ 租户生命周期│ 租户商业化  │  租户配置   │  租户运维   │   租户分析    │  │
    │  │ Application │ Application │ Application │ Application │  Application  │  │
    │  │ Service     │ Service     │ Service     │ Service     │  Service      │  │
    │  └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴───────┬───────┘  │
    │         │             │             │             │              │          │
    │  ┌──────▼─────────────▼─────────────▼─────────────▼──────────────▼───────┐  │
    │  │                          领域层 (Domain)                              │  │
    │  ├───────────────────────────────────────────────────────────────────────┤  │
    │  │                                                                       │  │
    │  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │  │
    │  │   │ 租户聚合    │ │ 订阅聚合    │ │ 配置聚合    │ │ 用量聚合    │     │  │
    │  │   │ Tenant      │ │ Subscription│ │ TenantConfig│ │ Usage       │     │  │
    │  │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │  │
    │  │                                                                       │  │
    │  │   ┌─────────────────────────────────────────────────────────────┐     │  │
    │  │   │                      领域服务                               │     │  │
    │  │   │  • TenantProvisioningService（租户开通编排）                │     │  │
    │  │   │  • DatabaseManagementService（数据库管理）                  │     │  │
    │  │   │  • DataSourceManagementService（数据源管理）                │     │  │
    │  │   │  • BillingCalculationService（计费计算）                    │     │  │
    │  │   │  • QuotaEnforcementService（配额执行）                      │     │  │
    │  │   └─────────────────────────────────────────────────────────────┘     │  │
    │  │                                                                       │  │
    │  └───────────────────────────────────┬───────────────────────────────────┘  │
    │                                      │                                      │
    │  ┌───────────────────────────────────▼───────────────────────────────────┐  │
    │  │                     基础设施层 (Infrastructure)                       │  │
    │  ├───────────────────────────────────────────────────────────────────────┤  │
    │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │
    │  │  │ Repository  │ │ Gateway     │ │ Messaging   │ │DynamicDataSource│  │  │
    │  │  │ 持久化实现  │ │ BC-10调用   │ │ 事件发布    │ │ 动态数据源路由  │  │  │
    │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │
    │  └───────────────────────────────────┬───────────────────────────────────┘  │
    │                                      │                                      │
    │  ┌───────────────────────────────────▼───────────────────────────────────┐  │
    │  │                          数据层 (Database)                            │  │
    │  ├───────────────────────────────────────────────────────────────────────┤  │
    │  │ clarisphere_platform（平台库）                                        │  │
    │  │ • platform_tenant（租户元数据）                                       │  │
    │  │ • platform_tenant_config（租户配置）                                  │  │
    │  │ • platform_sso_config（SSO配置）                                      │  │
    │  │ • platform_ldap_config（LDAP配置）                                    │  │
    │  │ • platform_subscription（订阅记录）                                   │  │
    │  │ • platform_plan（套餐定义）                                           │  │
    │  │ • platform_bill（账单记录）                                           │  │
    │  │ • platform_tenant_usage（用量记录）等                                 │  │
    │  └───────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.9.1-1 BC-11整体架构图

### 2.9.2 代码包结构

+   BC-11的代码包结构按子领域组织，如下表所示。

    | 包路径                                                   | 说明               |
    | -------------------------------------------------------- | ------------------ |
    | com.clarisphere.tenant                                   | BC-11根包          |
    | com.clarisphere.tenant.lifecycle                         | 租户生命周期子领域 |
    | com.clarisphere.tenant.lifecycle.domain                  | 领域层             |
    | com.clarisphere.tenant.lifecycle.application             | 应用层             |
    | com.clarisphere.tenant.lifecycle.interfaces.provider     | UP接口层           |
    | com.clarisphere.tenant.lifecycle.infrastructure          | 基础设施层         |
    | com.clarisphere.tenant.commercialize                     | 租户商业化子领域   |
    | com.clarisphere.tenant.commercialize.domain              | 领域层             |
    | com.clarisphere.tenant.commercialize.application         | 应用层             |
    | com.clarisphere.tenant.commercialize.interfaces.provider | UP接口层           |
    | com.clarisphere.tenant.commercialize.interfaces.tenant   | UR接口层           |
    | com.clarisphere.tenant.commercialize.infrastructure      | 基础设施层         |
    | com.clarisphere.tenant.config                            | 租户配置子领域     |
    | com.clarisphere.tenant.config.domain                     | 领域层             |
    | com.clarisphere.tenant.config.application                | 应用层             |
    | com.clarisphere.tenant.config.interfaces.tenant          | UR接口层           |
    | com.clarisphere.tenant.config.interfaces.provider        | UP接口层（只读）   |
    | com.clarisphere.tenant.config.infrastructure             | 基础设施层         |
    | com.clarisphere.tenant.operations                        | 租户运维子领域     |
    | com.clarisphere.tenant.operations.domain                 | 领域层             |
    | com.clarisphere.tenant.operations.application            | 应用层             |
    | com.clarisphere.tenant.operations.interfaces.provider    | UP接口层           |
    | com.clarisphere.tenant.operations.interfaces.tenant      | UR接口层           |
    | com.clarisphere.tenant.operations.infrastructure         | 基础设施层         |
    | com.clarisphere.tenant.analytics                         | 租户分析子领域     |
    | com.clarisphere.tenant.analytics.domain                  | 领域层             |
    | com.clarisphere.tenant.analytics.application             | 应用层             |
    | com.clarisphere.tenant.analytics.interfaces.provider     | UP接口层           |
    | com.clarisphere.tenant.analytics.infrastructure          | 基础设施层         |
    | com.clarisphere.tenant.shared                            | 共享服务           |

    表 2.9.2-1 代码包结构

### 2.9.3 API路径规划

+   BC-11的API路径按视角和子领域规划如下表所示。

    | 视角 | 子领域       | API路径前缀                             | 说明               |
    | ---- | ------------ | --------------------------------------- | ------------------ |
    | UP   | 租户生命周期 | /api/v1/provider/tenant/tenants/**      | 租户CRUD、状态管理 |
    | UP   | 租户商业化   | /api/v1/provider/tenant/plans/**        | 套餐管理           |
    | UP   | 租户商业化   | /api/v1/provider/tenant/billing/**      | 计费与账单         |
    | UP   | 租户运维     | /api/v1/provider/tenant/monitoring/**   | 监控与运维         |
    | UP   | 租户分析     | /api/v1/provider/tenant/analytics/**    | 分析与报表         |
    | UR   | 租户配置     | /api/v1/tenant/settings/config/**       | 配置管理           |
    | UR   | 租户商业化   | /api/v1/tenant/settings/subscription/** | 订阅管理           |
    | UR   | 租户商业化   | /api/v1/tenant/settings/billing/**      | 账单与发票         |
    | UR   | 租户运维     | /api/v1/tenant/settings/usage/**        | 用量查看           |
    | 内部 | 跨BC协作     | /internal/tenant/**                     | BC间内部调用       |

    表 2.9.3-1 API路径规划

+   **内部接口命名规范**
    -   内部接口按子领域分组，路径结构为：`/internal/tenant/{子领域}/{资源}/{操作}`
    -   租户生命周期子领域：`/internal/tenant/lifecycle/**`，如 `/internal/tenant/lifecycle/{tenantId}/status`
    -   租户配置子领域：`/internal/tenant/config/**`，如 `/internal/tenant/config/{tenantId}/auth`
    -   为保持向后兼容，现有接口路径保留，新增接口遵循上述规范

### 2.9.4 与其他BC的协作

    | 协作BC   | 协作方向    | 协作内容                                               | 协作方式    |
    | -------- | ----------- | ------------------------------------------------------ | ----------- |
    | BC-10    | BC-11→BC-10 | 租户开通时调用IAM初始化                                | 同步API调用 |
    | BC-10    | BC-10→BC-11 | 根据tenant_id查询租户配置（邮箱域名、SSO、LDAP）       | 同步API调用 |
    | BC-10    | BC-10→BC-11 | 根据tenant_id查询租户状态（是否有效、是否暂停）        | 同步API调用 |
    | BC-10    | BC-10→BC-11 | 根据tenant_code解析tenant_id（登录时code→id转换）      | 同步API调用 |
    | BC-01~09 | BC-11→BC-XX | 租户开通时调用业务表初始化                             | 同步API调用 |
    | BC-10    | BC-11→BC-10 | 租户生命周期事件（创建、暂停、注销）→审计日志+用户管理 | 领域事件    |
    | BC-12    | BC-11→BC-12 | 租户通知（开通成功、欠费提醒、到期）                   | 领域事件    |
    | 支付网关 | BC-11→外部  | 支付请求、支付结果回调                                 | HTTP调用    |

    表 2.9.4-1 BC-11与其他BC的协作关系

### 2.9.5 聚合设计总览

+   BC-11包含4个核心聚合，聚合设计总览如下表所示。

    | 聚合名称 | 聚合根       | 所属子领域   | 职责                       | 版本 |
    | -------- | ------------ | ------------ | -------------------------- | ---- |
    | 租户聚合 | Tenant       | 租户生命周期 | 租户生命周期管理、状态流转 | P1   |
    | 订阅聚合 | Subscription | 租户商业化   | 订阅关系、套餐、计费周期   | P3   |
    | 配置聚合 | TenantConfig | 租户配置     | 认证配置、品牌配置         | P1   |
    | 用量聚合 | Usage        | 租户运维     | 资源用量记录、配额监控     | P2   |

    表 2.9.5-1 BC-11聚合设计总览

### 2.9.6 领域事件总览

+   BC-11发布的领域事件如下表所示。

    | 事件名称             | 触发时机                                                | 包含数据                          | 消费方       |
    | -------------------- | ------------------------------------------------------- | --------------------------------- | ------------ |
    | TenantApplied        | 租户申请提交                                            | tenantId, tenantName, contactInfo | BC-10, BC-12 |
    | TenantApproved       | 租户审批通过                                            | tenantId, approvedBy              | BC-10        |
    | TenantRejected       | 租户审批拒绝                                            | tenantId, rejectReason            | BC-10, BC-12 |
    | TenantCreated        | 租户记录创建且数据库/数据源就绪（状态进入INITIALIZING） | tenantId, tenantCode, tenantName  | BC-10, BC-12 |
    | TenantActivated      | 租户激活成功                                            | tenantId, activatedAt             | BC-10        |
    | TenantSuspended      | 租户暂停                                                | tenantId, suspendReason           | BC-10        |
    | TenantResumed        | 租户恢复                                                | tenantId, resumedAt               | BC-10        |
    | TenantDeactivated    | 租户注销完成                                            | tenantId, deactivatedAt           | BC-10        |
    | SubscriptionCreated  | 订阅创建                                                | tenantId, planId, startDate       | BC-10        |
    | SubscriptionUpgraded | 订阅升级                                                | tenantId, oldPlanId, newPlanId    | BC-10, BC-12 |
    | SubscriptionExpiring | 订阅即将到期                                            | tenantId, expireDate              | BC-12        |
    | SubscriptionExpired  | 订阅已到期                                              | tenantId, expiredAt               | BC-10        |
    | QuotaExceeded        | 配额超限                                                | tenantId, quotaType, usage, limit | BC-12        |
    | PaymentReceived      | 收到付款                                                | tenantId, amount, paymentId       | BC-10        |
    | PaymentOverdue       | 付款逾期                                                | tenantId, overdueAmount, dueDays  | BC-12        |

    表 2.9.6-1 BC-11领域事件总览

### 2.9.7 数据库表总览

+   BC-11使用的数据库表如下表所示。

    | 表名                         | 所属子领域   | 职责               | 版本 |
    | ---------------------------- | ------------ | ------------------ | ---- |
    | platform_tenant              | 租户生命周期 | 租户元数据         | P1   |
    | platform_tenant_config       | 租户配置     | 租户环境配置       | P1   |
    | platform_sso_config          | 租户配置     | SSO单点登录配置    | P1   |
    | platform_ldap_config         | 租户配置     | LDAP/AD配置        | P1   |
    | platform_plan                | 租户商业化   | 套餐定义           | P3   |
    | platform_subscription        | 租户商业化   | 订阅记录           | P3   |
    | platform_bill                | 租户商业化   | 账单记录           | P4   |
    | platform_invoice             | 租户商业化   | 发票记录           | P5   |
    | platform_payment             | 租户商业化   | 支付记录           | P4   |
    | platform_tenant_quota        | 租户运维     | 租户配额配置       | P2   |
    | platform_tenant_usage        | 租户运维     | 用量记录（日汇总） | P2   |
    | platform_tenant_usage_detail | 租户运维     | 用量明细（实时）   | P4   |
    | platform_backup              | 租户运维     | 备份记录           | P5   |
    | platform_tenant_activity     | 租户分析     | 活跃度统计         | P4   |
    | platform_tenant_profile      | 租户分析     | 租户画像           | P6   |

    表 2.9.7-1 BC-11数据库表总览

### 2.9.8 版本规划总览

+   BC-11各子领域的版本规划如下表所示。
+   **P1核心目标**：私有化部署场景下，平台管理员直接开通租户 + 企业IAM整合（SSO/LDAP）。
+   **P2补充目标**：完善租户生命周期管理（试用申请、审批、暂停、恢复、注销等），并增加基础运维能力。

    | 子领域       | P1                                | P2                                     | P3         | P4                 | P5         | P6       |
    | ------------ | --------------------------------- | -------------------------------------- | ---------- | ------------------ | ---------- | -------- |
    | 租户生命周期 | **直接开通、激活**                | 试用申请、审批、转正、暂停、恢复、注销 | -          | -                  | -          | -        |
    | 租户配置     | **基本信息、邮箱域名、SSO、LDAP** | 品牌定制                               | 功能开关   | -                  | -          | -        |
    | 租户商业化   | -                                 | 基础配额                               | 套餐、订阅 | 计费、账单、欠费   | 续费、发票 | 自助开通 |
    | 租户运维     | -                                 | 配额管理、用量统计                     | 配额告警   | 监控、健康检查     | 备份恢复   | -        |
    | 租户分析     | -                                 | -                                      | -          | 活跃度、趋势、报表 | 流失预警   | 租户画像 |

    表 2.9.8-1 BC-11版本规划总览

+   P1/P2交付范围图示：

    ```
    ┌───────────────────────────────────────────────────────────────────────┐
    │                   P1 核心交付范围（P1首发）                           │
    ├───────────────────────────────────────────────────────────────────────┤
    │                                                                       │
    │   【租户生命周期 - 直接开通】          【租户配置 - 企业IAM整合】     │
    │   ┌──────────────────────────────┐  ┌─────────────────────────────┐   │
    │   │ ✓ 平台管理员直接创建租户     │  │ ✓ 基本信息维护              │   │
    │   │ ✓ 自动数据库创建+数据源注册  │  │ ✓ 邮箱域名配置              │   │
    │   │ ✓ 自动IAM初始化（调用BC-10） │  │ ✓ 认证方式选择              │   │
    │   │ ✓ 租户激活                   │  │ ✓ SSO-SAML配置              │   │
    │   │                              │  │ ✓ SSO-OIDC配置              │   │
    │   │                              │  │ ✓ LDAP/AD配置               │   │
    │   └──────────────────────────────┘  └─────────────────────────────┘   │
    │                                                                       │
    │   ┌───────────────────────────────────────────────────────────────┐   │
    │   │                     私有化部署核心价值                        │   │
    │   │                                                               │   │
    │   │   • 单租户/少量租户场景，管理员直接开通                       │   │
    │   │   • 必须对接企业现有IAM体系（AD/LDAP/SSO）                    │   │
    │   │   • 快速完成身份认证集成，降低企业接入成本                    │   │
    │   └───────────────────────────────────────────────────────────────┘   │
    │                                                                       │
    │   P2补充范围：                                                        │
    │   ┌───────────────────────────────────────────────────────────────┐   │
    │   │ ✓ 试用申请  ✓ 租户审批  ✓ 试用转正  ✓ 试用到期处理            │   │
    │   │ ✓ 租户暂停  ✓ 租户恢复  ✓ 租户注销  ✓ 完整状态机              │   │
    │   └───────────────────────────────────────────────────────────────┘   │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘
    ```

    图 2.9.8-1 P1/P2核心交付范围

## 2.10 安全设计

### 2.10.1 敏感数据加密

+   BC-11涉及多类敏感数据，需加密存储和安全传输。

#### 2.10.1.1 加密数据清单

+   需要加密存储的敏感数据如下表所示。

    | 数据类型           | 存储位置                   | 加密算法    | 密钥类型   | 说明                         |
    | ------------------ | -------------------------- | ----------- | ---------- | ---------------------------- |
    | 租户数据库密码     | tenant.datasource_password | AES-256-GCM | 平台主密钥 | 每个租户独立的数据库连接密码 |
    | OIDC Client Secret | sso_config.client_secret   | AES-256-GCM | 平台主密钥 | OIDC协议的客户端密钥         |
    | LDAP Bind Password | ldap_config.bind_password  | AES-256-GCM | 平台主密钥 | LDAP服务账号密码             |

    表 2.10.1.1-1 加密数据清单

#### 2.10.1.2 密钥管理方案

+   敏感数据加密的密钥管理方案如下表所示。

    | 维度     | 方案                                                                                 |
    | -------- | ------------------------------------------------------------------------------------ |
    | 密钥存储 | 平台主密钥（Master Key）存储于环境变量或密钥管理服务（如HashiCorp Vault、阿里云KMS） |
    | 密钥格式 | AES-256密钥，Base64编码，长度44字符                                                  |
    | 密钥轮换 | 支持密钥版本管理，轮换时使用新密钥加密，解密时根据密钥版本号选择对应密钥             |
    | 密钥隔离 | 所有租户共享平台主密钥（P1）；P3+可扩展为租户级密钥隔离                              |
    | 加密时机 | 数据写入数据库前加密，读取时解密                                                     |
    | IV管理   | 每次加密生成随机IV（12字节），与密文一起存储                                         |

    表 2.10.1.2-1 密钥管理方案

+   **P1实现方案**：
    -   平台主密钥通过环境变量 `CLARISPHERE_MASTER_KEY` 注入
    -   应用启动时加载密钥到内存，运行时不落盘
    -   加密服务类：`AesEncryptionService`，位于 `bc-11-tenant-infrastructure` 模块

+   **加密存储格式**：
    ```
    $AES$1$<base64(iv)>$<base64(ciphertext)>
    ```
    -   `$AES$`：算法标识
    -   `1`：密钥版本号
    -   `<base64(iv)>`：Base64编码的IV
    -   `<base64(ciphertext)>`：Base64编码的密文

### 2.10.2 数据安全

#### 2.10.2.1 租户数据隔离

+   租户数据隔离策略如下表所示。

    | 隔离层级 | 隔离方式                                    | 说明                     |
    | -------- | ------------------------------------------- | ------------------------ |
    | 数据库级 | 每租户独立数据库（clarisphere_t{id}）       | 物理隔离，最高安全等级   |
    | 连接池级 | 每租户独立HikariCP连接池                    | 连接不复用，防止数据泄露 |
    | 应用级   | ThreadLocal存储tenant_id，动态路由数据源    | 请求级隔离               |
    | API级    | UR视角API自动注入当前租户ID，禁止跨租户访问 | 接口级隔离               |

    表 2.10.2.1-1 租户数据隔离策略

#### 2.10.2.2 数据清理安全

+   租户注销时的数据清理安全策略如下表所示。

    | 清理阶段   | 安全措施                                           |
    | ---------- | -------------------------------------------------- |
    | 归档前     | 验证租户状态为DEACTIVATING且宽限期已过             |
    | 归档中     | 导出数据到加密存储，生成SHA-256校验和              |
    | 归档验证   | 校验归档文件完整性，确认大小>0且校验和匹配         |
    | 数据库删除 | 归档验证通过后方可执行DROP DATABASE                |
    | 删除确认   | 记录删除操作的审计日志，包含操作人、时间、租户信息 |

    表 2.10.2.2-1 数据清理安全策略

### 2.10.3 接口安全

+   BC-11接口安全策略如下表所示。

    | 接口类型       | 认证方式                | 授权方式                | 限流策略                |
    | -------------- | ----------------------- | ----------------------- | ----------------------- |
    | UP运营方接口   | JWT Token（平台管理员） | RBAC权限校验            | 100次/分钟/用户         |
    | UR租户管理接口 | JWT Token（租户管理员） | RBAC权限校验 + 租户隔离 | 60次/分钟/用户          |
    | 公共接口       | 无认证（验证码校验）    | IP限流 + 邮箱限流       | 10次/天/IP，3次/天/邮箱 |
    | 内部RPC接口    | 服务间mTLS或内网白名单  | 服务名校验              | 1000次/秒/服务          |

    表 2.10.3-1 接口安全策略

### 2.10.4 监控指标

+   BC-11关键监控指标定义如下表所示。

    | 指标分类 | 指标名称                          | 指标类型  | 告警阈值     | 说明                       |
    | -------- | --------------------------------- | --------- | ------------ | -------------------------- |
    | 租户开通 | tenant_provision_total            | Counter   | -            | 租户开通请求总数           |
    | 租户开通 | tenant_provision_success_total    | Counter   | -            | 租户开通成功总数           |
    | 租户开通 | tenant_provision_failure_total    | Counter   | >3次/小时    | 租户开通失败总数           |
    | 租户开通 | tenant_provision_duration_seconds | Histogram | P99 > 120秒  | 租户开通耗时分布           |
    | 数据源   | datasource_pool_active            | Gauge     | -            | 当前活跃连接池数量         |
    | 数据源   | datasource_pool_connections       | Gauge     | 使用率 > 80% | 各租户连接池连接数         |
    | 数据源   | datasource_health_check_failure   | Counter   | >0           | 连接池健康检查失败次数     |
    | 配置查询 | tenant_config_query_total         | Counter   | -            | 租户配置查询总数（含RPC）  |
    | 配置查询 | tenant_config_query_duration_ms   | Histogram | P99 > 50ms   | 配置查询耗时（认证热路径） |
    | 状态查询 | tenant_status_query_total         | Counter   | -            | 租户状态查询总数           |
    | 状态查询 | tenant_status_cache_hit_ratio     | Gauge     | < 90%        | 状态查询缓存命中率         |
    | 生命周期 | tenant_status_distribution        | Gauge     | -            | 各状态租户数量分布         |
    | 生命周期 | tenant_expiring_count             | Gauge     | -            | 7天内即将到期的试用租户数  |

    表 2.10.4-1 BC-11监控指标定义

+   **监控实现说明**
    -   指标采集：使用Micrometer暴露Prometheus格式指标，端点为 `/actuator/prometheus`
    -   告警配置：通过Prometheus Alertmanager配置告警规则，触发后通知运维团队
    -   仪表盘：Grafana预置BC-11专属仪表盘，包含租户概览、开通趋势、连接池状态等面板

# 3 租户生命周期

> **版本说明：P1实现直接开通+激活，P2补充完整生命周期（试用申请、审批、暂停/恢复、注销等）**

+   本章详细描述租户生命周期子领域的设计，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   租户生命周期是BC-11的核心子领域，负责管理租户从创建到注销的全过程。

+   **P1/P2范围说明**：

    | 流程         | P1  | P2  | 说明                             |
    | ------------ | --- | --- | -------------------------------- |
    | 租户直接开通 | ✓   | -   | 平台管理员在运营后台直接创建租户 |
    | 租户激活     | ✓   | -   | 开通完成后自动激活               |
    | 试用申请     | -   | ✓   | 企业用户在官网提交试用申请       |
    | 租户审批     | -   | ✓   | 平台管理员审批试用/开通申请      |
    | 试用转正     | -   | ✓   | 试用租户升级为正式租户           |
    | 租户暂停     | -   | ✓   | 因欠费/违规暂停服务              |
    | 租户恢复     | -   | ✓   | 解除暂停，恢复服务               |
    | 租户注销     | -   | ✓   | 租户主动或合同到期注销           |
    | 试用到期     | -   | ✓   | 试用期满自动处理                 |

    表 3-1 P1/P2范围说明

+   **P1设计原则**：P1面向私有化部署场景，租户数量少（1-5个），平台管理员直接创建即可，无需试用申请和审批流程。本章设计时，P1仅需关注FL-TL-03和FL-TL-04两个流程，其余流程的领域模型、接口和数据模型在P2中补充实现。

## 3.1 业务场景分析

+   本节分析租户生命周期相关的业务场景，明确各场景的特点、参与者和处理方式。

### 3.1.1 场景总览

+   租户生命周期涉及的业务场景如下表所示。

    | 场景编号 | 场景名称     | 触发者     | 场景描述                         | 版本 |
    | -------- | ------------ | ---------- | -------------------------------- | ---- |
    | SC-03    | 租户直接开通 | 平台管理员 | 平台管理员直接创建租户并自动开通 | P1   |
    | SC-04    | 租户激活     | 系统       | 初始化完成后激活租户             | P1   |
    | SC-01    | 试用申请     | 企业用户   | 企业在官网提交试用申请           | P2   |
    | SC-02    | 租户审批     | 平台管理员 | 审批试用申请或正式开通申请       | P2   |
    | SC-05    | 试用转正     | 租户管理员 | 试用期内申请转为正式租户         | P2   |
    | SC-06    | 租户暂停     | 平台管理员 | 因欠费/违规等原因暂停租户服务    | P2   |
    | SC-07    | 租户恢复     | 平台管理员 | 解除暂停状态，恢复租户服务       | P2   |
    | SC-08    | 租户注销     | 平台管理员 | 租户主动申请或合同到期后注销租户 | P2   |
    | SC-09    | 试用到期     | 系统       | 试用期满自动处理                 | P2   |

    表 3.1.1-1 租户生命周期业务场景总览

+   **P1范围说明**：P1仅实现SC-03（平台管理员直接开通）和SC-04（租户激活），即平台管理员在运营后台直接填写租户信息并一键创建租户，系统自动完成数据库创建、数据源注册、IAM初始化和激活。试用申请、审批、暂停、恢复、注销等场景在P2中实现。

### 3.1.2 租户状态机

+   租户生命周期通过状态机管理，共定义10种状态。

#### 3.1.2.1 状态定义

+   租户状态定义如下表所示。

    | 状态编码     | 状态名称 | 状态说明                               | 可停留时长            |
    | ------------ | -------- | -------------------------------------- | --------------------- |
    | PENDING      | 待审批   | 申请已提交，等待平台管理员审批         | 无限制                |
    | REJECTED     | 已拒绝   | 申请被拒绝，终态                       | 终态                  |
    | CREATING     | 创建中   | 审批通过或直接创建，正在创建租户数据库 | < 5分钟               |
    | INITIALIZING | 初始化中 | 数据库已创建，正在初始化IAM和业务表    | < 10分钟              |
    | TRIAL        | 试用中   | 试用租户已激活，在试用期内             | 30天                  |
    | ACTIVE       | 已激活   | 正式租户已激活，正常服务中             | 按订阅周期            |
    | SUSPENDED    | 已暂停   | 因欠费/违规等原因暂停服务              | 按策略                |
    | EXPIRED      | 已过期   | 试用到期或订阅到期                     | 按宽限期              |
    | DEACTIVATING | 注销中   | 正在执行注销流程，清理数据             | 宽限期7天 + 清理期7天 |
    | DEACTIVATED  | 已注销   | 注销完成，终态                         | 终态                  |

    表 3.1.2.1-1 租户状态定义

#### 3.1.2.2 状态转换规则

+   租户状态转换规则如下表所示。

    | 当前状态     | 目标状态     | 转换事件             | 触发条件               | 操作者     |
    | ------------ | ------------ | -------------------- | ---------------------- | ---------- |
    | PENDING      | CREATING     | approve              | 审批通过               | 平台管理员 |
    | PENDING      | REJECTED     | reject               | 审批拒绝               | 平台管理员 |
    | CREATING     | INITIALIZING | database_created     | 数据库创建成功         | 系统       |
    | INITIALIZING | TRIAL        | init_completed       | 初始化完成（试用租户） | 系统       |
    | INITIALIZING | ACTIVE       | init_completed       | 初始化完成（正式租户） | 系统       |
    | INITIALIZING | CREATING     | init_failed          | 初始化失败，回退重试   | 系统       |
    | TRIAL        | ACTIVE       | convert_to_official  | 试用转正               | 租户管理员 |
    | TRIAL        | EXPIRED      | trial_expired        | 试用期满               | 系统       |
    | TRIAL        | SUSPENDED    | suspend              | 违规暂停               | 平台管理员 |
    | ACTIVE       | SUSPENDED    | suspend              | 欠费/违规暂停          | 平台管理员 |
    | ACTIVE       | EXPIRED      | subscription_expired | 订阅到期               | 系统       |
    | ACTIVE       | DEACTIVATING | deactivate           | 申请注销               | 平台管理员 |
    | SUSPENDED    | ACTIVE       | resume               | 恢复服务               | 平台管理员 |
    | SUSPENDED    | TRIAL        | resume               | 恢复服务（试用租户）   | 平台管理员 |
    | SUSPENDED    | DEACTIVATING | deactivate           | 暂停后注销             | 平台管理员 |
    | EXPIRED      | ACTIVE       | renew                | 续费成功               | 系统       |
    | EXPIRED      | DEACTIVATING | deactivate           | 过期后注销             | 平台管理员 |
    | DEACTIVATING | DEACTIVATED  | cleanup_completed    | 数据清理完成           | 系统       |

    表 3.1.2.2-1 租户状态转换规则

#### 3.1.2.3 状态机图

+   租户状态机如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                              租户状态机                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                              ┌──────────────┐                               │
    │                       ┌─────▶│   REJECTED   │ （终态）                      │
    │                       │      │   (已拒绝)   │                               │
    │                       │      └──────────────┘                               │
    │                       │ reject                                              │
    │                       │                                                     │
    │  ┌──────────┐  申请   │  ┌──────────────┐                                   │
    │  │   新建   │────────▶├─▶│   PENDING    │                                   │
    │  └──────────┘         │  │   (待审批)   │                                   │
    │                       │  └───────┬──────┘                                   │
    │                       │          │ approve                                  │
    │                       │          ▼                                          │
    │                       │  ┌──────────────┐                                   │
    │                       │  │   CREATING   │◀─────────┐                        │
    │                       │  │   (创建中)   │          │ init_failed            │
    │                       │  └───────┬──────┘          │                        │
    │                       │          │ database_created│                        │
    │                       │          ▼                 │                        │
    │                       │  ┌──────────────┐          │                        │
    │                       │  │ INITIALIZING │──────────┘                        │
    │                       │  │  (初始化中)  │                                   │
    │                       │  └───────┬──────┘                                   │
    │                       │          │ init_completed                           │
    │                       │     ┌────┴────┐                                     │
    │                       │     │         │                                     │
    │                       │     ▼         ▼                                     │
    │                 ┌──────────────┐  ┌──────────────┐                          │
    │                 │    TRIAL     │  │    ACTIVE    │◀──────┐                  │
    │                 │   (试用中)   │  │   (已激活)   │       │                  │
    │                 └───────┬──────┘  └───────┬──────┘       │                  │
    │                         │                 │              │                  │
    │         convert_to_     │                 │              │ resume           │
    │         official        │                 │              │                  │
    │           ┌─────────────┘                 │              │                  │
    │           │                               │              │                  │
    │           │    trial_expired              │ suspend      │                  │
    │           │         │                     │              │                  │
    │           │         ▼                     ▼              │                  │
    │           │  ┌──────────────┐      ┌──────────────┐      │                  │
    │           │  │   EXPIRED    │      │  SUSPENDED   │──────┘                  │
    │           │  │   (已过期)   │      │   (已暂停)   │                         │
    │           │  └───────┬──────┘      └───────┬──────┘                         │
    │           │          │                     │                                │
    │           │          │ renew               │                                │
    │           │          └──────▶ ACTIVE ◀─────┘                                │
    │           │                                                                 │
    │           │          │ deactivate          │ deactivate                     │
    │           │          ▼                     ▼                                │
    │           │  ┌──────────────────────────────────┐                           │
    │           └─▶│         DEACTIVATING             │◀──── ACTIVE.deactivate    │
    │              │           (注销中)               │                           │
    │              └────────────────┬─────────────────┘                           │
    │                               │ cleanup_completed                           │
    │                               ▼                                             │
    │                       ┌──────────────┐                                      │
    │                       │  DEACTIVATED │ （终态）                             │
    │                       │   (已注销)   │                                      │
    │                       └──────────────┘                                      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.1.2.3-1 租户状态机

+   **P1可达路径**：create() → CREATING → INITIALIZING → ACTIVE（跳过PENDING，不支持TRIAL）

### 3.1.3 试用申请场景

+   试用申请是企业用户首次接触平台的入口场景。

#### 3.1.3.1 场景特点

+   试用申请场景特点如下：
    -   **开放申请**：任何企业都可以在官网提交试用申请
    -   **信息采集**：需填写企业信息、联系人信息、预期用途
    -   **人工审批**：平台管理员审核企业资质后决定是否通过
    -   **自动开通**：审批通过后系统自动执行开通流程

#### 3.1.3.2 试用租户规格

+   试用租户的规格限制如下表所示。

    | 限制项     | 限制值    | 说明               |
    | ---------- | --------- | ------------------ |
    | 用户数上限 | 5人       | 含管理员账号       |
    | 试用期限   | 30天      | 从激活日期开始计算 |
    | 存储配额   | 1GB       | 数据库存储上限     |
    | 功能范围   | 基础功能  | 高级功能不可用     |
    | API调用    | 1000次/月 | API调用次数限制    |

    表 3.1.3.2-1 试用租户规格

#### 3.1.3.3 申请信息要求

+   试用申请需填写的信息如下表所示。

    | 信息分类 | 字段名称         | 是否必填 | 说明                   |
    | -------- | ---------------- | -------- | ---------------------- |
    | 企业信息 | 企业名称         | 是       | 企业全称               |
    | 企业信息 | 统一社会信用代码 | 否       | 用于企业资质核验       |
    | 企业信息 | 所属行业         | 是       | 选择行业分类           |
    | 企业信息 | 企业规模         | 是       | 选择人员规模区间       |
    | 联系人   | 联系人姓名       | 是       | 管理员姓名             |
    | 联系人   | 联系电话         | 是       | 用于审批沟通和账号通知 |
    | 联系人   | 联系邮箱         | 是       | 管理员登录账号         |
    | 联系人   | 职位             | 否       | 联系人职位             |
    | 需求信息 | 预期用途         | 是       | 描述使用场景           |
    | 需求信息 | 预期用户数       | 否       | 预估正式使用的用户规模 |

    表 3.1.3.3-1 试用申请信息

### 3.1.4 租户审批场景

+   租户审批是平台管理员对试用申请或正式开通申请进行审核的场景。

#### 3.1.4.1 场景特点

+   租户审批场景特点如下：
    -   **人工决策**：由平台管理员根据企业资质和申请信息做出决策
    -   **审批结果**：通过或拒绝，拒绝需填写原因
    -   **触发后续**：审批通过自动触发租户开通流程

#### 3.1.4.2 审批要点

+   审批时需关注的要点如下表所示。

    | 审批维度   | 审批要点                           | 风险等级 |
    | ---------- | ---------------------------------- | -------- |
    | 企业真实性 | 企业名称是否真实存在、是否有官网   | 高       |
    | 企业资质   | 是否为正规企业、是否有不良记录     | 高       |
    | 联系人信息 | 邮箱是否为企业邮箱、电话是否可联系 | 中       |
    | 使用意图   | 预期用途是否合理、是否符合平台定位 | 中       |
    | 重复申请   | 是否为同一企业重复申请             | 低       |

    表 3.1.4.2-1 租户审批要点

### 3.1.5 租户开通场景

+   租户开通是审批通过后系统自动执行的开通流程。

#### 3.1.5.1 场景特点

+   租户开通场景特点如下：
    -   **自动执行**：审批通过后由系统自动触发，无需人工干预
    -   **多步骤编排**：包含数据库创建、数据源注册、IAM初始化等多个步骤
    -   **跨BC协作**：需要调用BC-10完成IAM表初始化
    -   **失败回滚**：任一步骤失败需要回滚已完成的步骤

#### 3.1.5.2 开通步骤

+   租户开通的详细步骤如下表所示。

    | 步骤 | 步骤名称         | 执行者 | 说明                               | 失败处理 |
    | ---- | ---------------- | ------ | ---------------------------------- | -------- |
    | 1    | 生成租户代号     | BC-11  | 根据企业名称生成唯一代号           | 重试     |
    | 2    | 创建租户数据库   | BC-11  | 创建clarisphere_t<tenant_id>数据库 | 回滚删除 |
    | 3    | 创建数据源连接池 | BC-11  | 创建HikariCP连接池并注册到路由器   | 回滚关闭 |
    | 4    | 调用IAM初始化    | BC-10  | 创建IAM表、预置角色、管理员账号    | 回滚清理 |
    | 5    | 发送激活通知     | BC-11  | 发送邮件通知管理员账号信息         | 记录失败 |
    | 6    | 更新租户状态     | BC-11  | 状态变为TRIAL或ACTIVE              | -        |
    | 7    | 发布领域事件     | BC-11  | 发布TenantActivated事件            | 异步重试 |

    表 3.1.5.2-1 租户开通步骤

### 3.1.6 租户暂停与恢复场景

+   租户暂停与恢复是平台管理员对租户服务状态进行管控的场景。

#### 3.1.6.1 暂停场景

+   租户暂停的触发原因如下表所示。

    | 暂停原因 | 原因代码  | 说明                     | 自动/手动 |
    | -------- | --------- | ------------------------ | --------- |
    | 欠费暂停 | OVERDUE   | 账单逾期未支付           | 自动      |
    | 违规暂停 | VIOLATION | 违反平台使用条款         | 手动      |
    | 安全暂停 | SECURITY  | 发现安全风险，预防性暂停 | 手动      |
    | 主动暂停 | VOLUNTARY | 租户主动申请暂停         | 手动      |

    表 3.1.6.1-1 租户暂停原因

+   暂停后的影响如下：
    -   租户所有用户无法登录
    -   租户数据保留，不删除
    -   数据源连接池保持，但拒绝请求
    -   API调用返回租户已暂停错误

#### 3.1.6.2 恢复场景

+   租户恢复的前置条件如下表所示。

    | 暂停原因 | 恢复条件                     |
    | -------- | ---------------------------- |
    | 欠费暂停 | 完成欠费支付                 |
    | 违规暂停 | 整改完成，平台管理员确认     |
    | 安全暂停 | 安全风险排除，平台管理员确认 |
    | 主动暂停 | 租户申请恢复，平台管理员确认 |

    表 3.1.6.2-1 租户恢复条件

### 3.1.7 租户注销场景

+   租户注销是租户生命周期的终结场景。

#### 3.1.7.1 场景特点

+   租户注销场景特点如下：
    -   **不可逆操作**：注销完成后无法恢复
    -   **数据处理**：需要决定数据归档还是删除
    -   **宽限期**：注销申请后有宽限期可撤销
    -   **资源清理**：需要清理数据库、连接池等资源

#### 3.1.7.2 注销原因

+   租户注销的原因如下表所示。

    | 注销原因 | 原因代码          | 说明             | 数据处理 |
    | -------- | ----------------- | ---------------- | -------- |
    | 主动注销 | VOLUNTARY         | 租户主动申请注销 | 归档     |
    | 合同到期 | CONTRACT_END      | 合同到期且不续约 | 归档     |
    | 试用到期 | TRIAL_EXPIRED     | 试用期满未转正   | 删除     |
    | 长期欠费 | LONG_OVERDUE      | 欠费超过宽限期   | 归档     |
    | 严重违规 | SERIOUS_VIOLATION | 严重违反平台条款 | 立即删除 |

    表 3.1.7.2-1 租户注销原因

#### 3.1.7.3 注销流程

+   注销流程的关键节点如下表所示。

    | 阶段     | 时间点     | 状态         | 可执行操作                  |
    | -------- | ---------- | ------------ | --------------------------- |
    | 申请阶段 | T+0        | DEACTIVATING | 可撤销注销申请              |
    | 宽限期   | T+0 ~ T+7  | DEACTIVATING | 可撤销，数据仍可访问        |
    | 清理期   | T+7 ~ T+14 | DEACTIVATING | 不可撤销，开始数据归档/删除 |
    | 完成     | T+14       | DEACTIVATED  | 终态，资源完全释放          |

    表 3.1.7.3-1 租户注销流程节点

### 3.1.8 场景与流程映射

+   各业务场景对应的后续流程如下表所示。
+   流程编号规则：FL-TL-{序号}，TL表示Tenant Lifecycle。

    | 场景编号 | 业务场景     | 对应流程                           | 流程编号 | 版本 |
    | -------- | ------------ | ---------------------------------- | -------- | ---- |
    | SC-03    | 租户直接开通 | 租户开通流程（平台管理员直接开通） | FL-TL-03 | P1   |
    | SC-04    | 租户激活     | 租户激活流程                       | FL-TL-04 | P1   |
    | SC-01    | 试用申请     | 试用申请提交流程                   | FL-TL-01 | P2   |
    | SC-02    | 租户审批     | 租户审批流程                       | FL-TL-02 | P2   |
    | SC-05    | 试用转正     | 试用转正流程                       | FL-TL-05 | P2   |
    | SC-06    | 租户暂停     | 租户暂停流程                       | FL-TL-06 | P2   |
    | SC-07    | 租户恢复     | 租户恢复流程                       | FL-TL-07 | P2   |
    | SC-08    | 租户注销     | 租户注销流程                       | FL-TL-08 | P2   |
    | SC-09    | 试用到期     | 试用到期处理流程                   | FL-TL-09 | P2   |

    表 3.1.8-1 场景与流程映射

+   **P1范围说明**：P1仅实现FL-TL-03（平台管理员直接开通）和FL-TL-04（租户激活），其余流程在P2中实现。

[待续...]

## 3.2 业务流程设计

+   本节基于3.1业务场景分析，详细设计各业务流程。
+   流程设计遵循《领域驱动设计详细设计文档编写指南》的流程层级规范。

### 3.2.1 流程层级说明

+   本子领域业务流程采用三层结构组织：

    | 层级     | 说明             | 图示工具    | 读者           |
    | -------- | ---------------- | ----------- | -------------- |
    | 一级流程 | 端到端完整流程   | ASCII流程图 | 产品/业务/架构 |
    | 二级流程 | 子流程（带泳道） | 时序图      | 架构/开发      |
    | 三级流程 | 功能级详细流程   | 步骤表      | 开发/测试      |

    表 3.2.1-1 流程层级说明

+   本章重点描述一级流程和关键二级流程，三级流程在接口设计中体现。

### 3.2.2 FL-TL-01 试用申请提交流程

> **⏳ 版本标记：P2实现**（P1不含试用申请功能，平台管理员通过FL-TL-03直接开通租户）

+   本流程描述企业用户在官网提交试用申请的过程。

#### 3.2.2.1 流程概述

+   流程基本信息如下：
    -   流程目标：企业用户提交试用申请，系统创建待审批的租户申请记录
    -   触发条件：企业用户在官网点击"申请试用"
    -   结束条件：申请记录创建成功，通知平台管理员
    -   预计耗时：< 3秒

#### 3.2.2.2 流程图

+   试用申请提交流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-TL-01 试用申请提交流程                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   企业用户                       BC-11                    BC-12             │
    │  ┌────────┐    ┌────────┐    ┌────────┐                                     │
    │  │ 开始   │───▶│ 填写   │───▶│ 信息   │                                     │
    │  │        │    │ 企业   │    │ 校验   │                                     │
    │  └────────┘    │ 信息   │    └───┬────┘                                     │
    │                └────────┘        │                                          │
    │                             校验失败                                        │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐                                      │
    │                             │ 返回   │                                      │
    │                             │ 错误   │                                      │
    │                             └────────┘                                      │
    │                                  │                                          │
    │                             校验通过                                        │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐    ┌────────┐    ┌────────┐          │
    │                             │ 查重   │───▶│ 创建   │───▶│ 通知   │          │
    │                             │ 检查   │    │ 申请   │    │ 管理员 │          │
    │                             └───┬────┘    │ 记录   │    │ 审批   │          │
    │                                 │         │(待审批)│    └───┬────┘          │
    │                            存在重复       └────────┘        │               │
    │                                 │                           │               │
    │                                 ▼                      ─ ─ ─│─ ─ ─ ─ ─      │
    │                            ┌────────┐                       ▼               │
    │                            │ 提示   │                  ┌────────┐           │
    │                            │ 已申请 │                  │ 发送   │           │
    │                            └────────┘                  │ 邮件   │           │
    │                                                        │ 通知   │           │
    │                                                        └────────┘           │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.2.2-1 试用申请提交流程

#### 3.2.2.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者   | 输入       | 输出     | 业务规则                                  |
    | ---- | ---------- | -------- | ---------- | -------- | ----------------------------------------- |
    | 1    | 填写信息   | 企业用户 | -          | 申请表单 | 必填：企业名称、行业、规模、联系人、邮箱  |
    | 2    | 信息校验   | BC-11    | 申请表单   | 校验结果 | 邮箱格式校验、手机号格式校验              |
    | 3    | 查重检查   | BC-11    | 企业名称   | 查重结果 | 同一企业名称不可重复申请（PENDING状态内） |
    | 4    | 创建记录   | BC-11    | 申请信息   | 租户ID   | 状态=PENDING，类型=TRIAL                  |
    | 5    | 通知管理员 | BC-11    | 申请信息   | 通知事件 | 发布TenantApplied事件                     |
    | 6    | 发送通知   | BC-12    | 管理员邮箱 | -        | 向平台管理员发送审批邮件通知              |
    | 7    | 返回结果   | BC-11    | 租户ID     | 响应     | 返回申请成功提示和预计审批时间            |

    表 3.2.2.3-1 试用申请提交流程步骤

### 3.2.3 FL-TL-02 租户审批流程

> **⏳ 版本标记：P2实现**（P1无需审批，平台管理员通过FL-TL-03直接开通租户）

+   本流程描述平台管理员对试用申请或正式开通申请进行审核的过程。

#### 3.2.3.1 流程概述

+   流程基本信息如下：
    -   流程目标：平台管理员审核租户申请，决定通过或拒绝
    -   触发条件：管理员在运营后台查看待审批列表，发起审批
    -   结束条件：审批通过则触发开通流程，审批拒绝则通知申请人
    -   预计耗时：审批操作 < 2秒，人工审核时间 < 24小时

#### 3.2.3.2 流程图

+   租户审批流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-TL-02 租户审批流程                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   平台管理员                  BC-11                    BC-12                │
    │  ┌────────┐    ┌────────┐    ┌────────┐                                     │
    │  │ 查看   │───▶│ 审查   │───▶│ 提交   │                                     │
    │  │ 申请   │    │ 企业   │    │ 审批   │                                     │
    │  │ 详情   │    │ 资质   │    │ 决策   │                                     │
    │  └────────┘    └────────┘    └───┬────┘                                     │
    │                                  │                                          │
    │                         ┌────────┴────────┐                                 │
    │                         │                 │                                 │
    │                        通过              拒绝                               │
    │                         │                 │                                 │
    │                         ▼                 ▼                                 │
    │                    ┌────────┐        ┌────────┐                             │
    │                    │ 更新   │        │ 更新   │                             │
    │                    │ 状态为 │        │ 状态为 │                             │
    │                    │CREATING│        │REJECTED│                             │
    │                    └───┬────┘        └───┬────┘                             │
    │                        │                 │                                  │
    │                        ▼                 ▼                                  │
    │                    ┌────────┐        ┌────────┐    ┌────────┐               │
    │                    │ 发布   │        │ 发布   │───▶│ 通知   │               │
    │                    │Approved│        │Rejected│    │ 申请人 │               │
    │                    │ 事件   │        │ 事件   │    │ 被拒绝 │               │
    │                    └───┬────┘        └────────┘    └────────┘               │
    │                        │                                                    │
    │                        ▼                                                    │
    │                    ┌────────┐                                               │
    │                    │ 触发   │                                               │
    │                    │ 开通   │                                               │
    │                    │ 流程   │                                               │
    │                    └────────┘                                               │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.3.2-1 租户审批流程

#### 3.2.3.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称 | 执行者     | 输入     | 输出     | 业务规则                                 |
    | ---- | -------- | ---------- | -------- | -------- | ---------------------------------------- |
    | 1    | 查看详情 | 平台管理员 | 租户ID   | 申请详情 | 展示企业信息、联系人、预期用途           |
    | 2    | 审查资质 | 平台管理员 | 申请详情 | -        | 线下核验企业真实性、资质                 |
    | 3    | 提交决策 | 平台管理员 | 审批意见 | 审批结果 | 通过或拒绝，拒绝必须填写原因             |
    | 4a   | 通过处理 | BC-11      | 审批结果 | 状态更新 | 状态→CREATING，记录审批人和时间          |
    | 4b   | 拒绝处理 | BC-11      | 审批结果 | 状态更新 | 状态→REJECTED，记录拒绝原因              |
    | 5a   | 发布事件 | BC-11      | 租户信息 | 领域事件 | 通过→TenantApproved，拒绝→TenantRejected |
    | 6a   | 触发开通 | BC-11      | 租户ID   | -        | 审批通过后自动触发FL-TL-03开通流程       |
    | 6b   | 通知拒绝 | BC-12      | 申请人   | -        | 发送拒绝邮件，包含拒绝原因               |

    表 3.2.3.3-1 租户审批流程步骤

### 3.2.4 FL-TL-03 租户开通流程（平台管理员直接开通）

> **✓ 版本标记：P1实现** — 这是P1租户生命周期的核心流程

+   本流程描述平台管理员在运营后台直接创建租户并完成自动化开通的过程。
+   这是BC-11最核心的流程，涉及跨BC协作和多步骤编排。
+   **P1场景说明**：在私有化部署场景下，租户数量少（1-5个），无需走试用申请→审批→开通的链路。平台管理员在运营后台直接填写租户信息（企业名称、管理员邮箱等），一键提交后系统自动完成数据库创建、数据源注册、IAM初始化和激活。P2版本将补充试用申请和审批流程，届时审批通过后也复用本流程完成自动化开通。

#### 3.2.4.1 流程概述

+   流程基本信息如下：
    -   流程目标：平台管理员直接创建租户，系统自动完成数据库创建、数据源注册、IAM初始化，使租户可用
    -   触发条件：**P1 — 平台管理员在运营后台提交"创建租户"表单**；P2 — 也可由FL-TL-02审批通过后自动触发
    -   结束条件：租户状态变为ACTIVE，管理员可登录（P1不支持TRIAL类型，直接创建正式租户）
    -   执行方式：系统自动执行，异步编排
    -   预计耗时：30秒 ~ 2分钟（视数据库创建速度）

+   **P1与P2的触发差异**：

    | 维度     | P1（直接开通）                     | P2（审批开通，后续补充）           |
    | -------- | ---------------------------------- | ---------------------------------- |
    | 触发方式 | 平台管理员直接提交创建表单         | FL-TL-02审批通过后自动触发         |
    | 前置流程 | 无                                 | FL-TL-01试用申请 → FL-TL-02审批    |
    | 租户类型 | OFFICIAL（正式租户）               | TRIAL（试用）或 OFFICIAL（正式）   |
    | 目标状态 | ACTIVE                             | TRIAL 或 ACTIVE                    |
    | 输入信息 | 管理员填写：企业名称、管理员邮箱等 | 来自试用申请表单的企业和联系人信息 |

    表 3.2.4.1-1 P1与P2触发差异

#### 3.2.4.2 流程图

+   租户开通流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │              FL-TL-03 租户开通流程（平台管理员直接开通）                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   BC-11                           BC-10                    BC-12            │
    │  ┌────────┐                                                                 │
    │  │ 生成   │                                                                 │
    │  │ 租户   │                                                                 │
    │  │ 代号   │                                                                 │
    │  └───┬────┘                                                                 │
    │      │                                                                      │
    │      ▼                                                                      │
    │  ┌────────┐                                                                 │
    │  │ 创建   │                                                                 │
    │  │ 租户   │                                                                 │
    │  │ 数据库 │                                                                 │
    │  └───┬────┘                                                                 │
    │      │                                                                      │
    │      │ 失败 ──▶ 回滚（删除数据库）──▶ 状态保持CREATING，记录失败原因        │
    │      │                                                                      │
    │      ▼ 成功                                                                 │
    │  ┌────────┐                                                                 │
    │  │ 创建   │                                                                 │
    │  │ 数据源 │                                                                 │
    │  │ 连接池 │                                                                 │
    │  └───┬────┘                                                                 │
    │      │                                                                      │
    │      │ 失败 ──▶ 回滚（关闭连接池、删除数据库）                              │
    │      │                                                                      │
    │      ▼ 成功                                                                 │
    │  ┌────────┐    状态→INITIALIZING                                            │
    │  │ 调用   │──────────────────────▶┌────────┐                                │
    │  │ IAM    │                       │ 创建   │                                │
    │  │ 初始化 │                       │ IAM表  │                                │
    │  └───┬────┘                       │ 预置   │                                │
    │      │                            │ 角色   │                                │
    │      │                            │ 管理员 │                                │
    │      │                            └───┬────┘                                │
    │      │                                │                                     │
    │      │◀───────── 返回初始化结果 ──────┘                                     │
    │      │                                                                      │
    │      │ 失败 ──▶ 回滚（清理IAM数据、关闭连接池、删除数据库）                 │
    │      │                                                                      │
    │      ▼ 成功                                                                 │
    │  ┌────────┐                                                                 │
    │  │ 更新   │                                                                 │
    │  │ 状态   │  试用→TRIAL / 正式→ACTIVE                                       │
    │  └───┬────┘                                                                 │
    │      │                                                                      │
    │      ▼                                                                      │
    │  ┌────────┐                                    ┌────────┐                   │
    │  │ 发布   │───────────────────────────────────▶│ 发送   │                   │
    │  │Tenant  │                                    │ 开通   │                   │
    │  │Activated│                                   │ 通知   │                   │
    │  └────────┘                                    └────────┘                   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.4.2-1 租户开通流程

#### 3.2.4.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称       | 执行者 | 输入       | 输出            | 业务规则                                                    |
    | ---- | -------------- | ------ | ---------- | --------------- | ----------------------------------------------------------- |
    | 1    | 生成租户代号   | BC-11  | 企业名称   | tenant_code     | 4-20位小写字母+数字，全局唯一                               |
    | 2    | 创建租户数据库 | BC-11  | tenant_id  | 数据库          | 执行DDL创建clarisphere_t{tenant_id}                         |
    | 3    | 创建数据源     | BC-11  | tenant_id  | 连接池          | 创建HikariCP连接池，以tenant_id为key注册到DynamicDataSource |
    | 4    | 更新状态       | BC-11  | 租户ID     | 状态更新        | 状态→INITIALIZING                                           |
    | 5    | 调用IAM初始化  | BC-10  | tenant_id  | 初始化结果      | 创建IAM表、预置角色权限、创建租户管理员账号                 |
    | 6    | 更新状态       | BC-11  | 初始化结果 | 状态更新        | 试用→TRIAL，正式→ACTIVE                                     |
    | 7    | 记录激活时间   | BC-11  | 租户ID     | 激活信息        | 记录activatedAt，试用租户计算trialExpiresAt=+30天           |
    | 8    | 发布事件       | BC-11  | 租户信息   | TenantActivated | 通知BC-12发送开通通知                                       |

    表 3.2.4.3-1 租户开通流程步骤

+   **P1平台管理员创建租户所需输入信息**：

    | 字段       | 是否必填 | 说明                                       |
    | ---------- | -------- | ------------------------------------------ |
    | 企业名称   | 是       | 租户企业全称，全局唯一                     |
    | 租户代号   | 否       | 可选手动输入，否则系统根据企业名称自动生成 |
    | 管理员姓名 | 是       | 租户超级管理员姓名                         |
    | 管理员邮箱 | 是       | 租户超级管理员登录邮箱                     |
    | 管理员手机 | 否       | 联系电话                                   |
    | 所属行业   | 否       | 用于统计分析                               |
    | 企业规模   | 否       | 用于统计分析                               |
    | 最大用户数 | 否       | 默认无限制（正式租户），P2试用租户默认5    |

    表 3.2.4.3-2 P1创建租户输入信息

+   **P1流程简化说明**：
    -   P1不支持TRIAL类型，步骤6中目标状态固定为ACTIVE
    -   P1不生成trialExpiresAt，步骤7中仅记录activatedAt
    -   P2接入试用申请后，本流程将根据tenantType动态选择目标状态（TRIAL或ACTIVE）

#### 3.2.4.4 失败回滚策略

+   租户开通流程的失败回滚策略如下表所示。

    | 失败步骤       | 已完成步骤          | 回滚操作                            | 最终状态 |
    | -------------- | ------------------- | ----------------------------------- | -------- |
    | 创建数据库失败 | 无                  | 无需回滚，状态保持CREATING          | CREATING |
    | 创建数据源失败 | 数据库已创建        | 删除数据库                          | CREATING |
    | IAM初始化失败  | 数据库+数据源已创建 | 清理IAM数据、关闭连接池、删除数据库 | CREATING |
    | 更新状态失败   | 全部初始化已完成    | 重试更新状态（幂等操作）            | 重试     |

    表 3.2.4.4-1 租户开通失败回滚策略

+   回滚说明：
    -   回滚后租户状态恢复为CREATING，平台管理员可手动重试开通
    -   每次失败记录详细的错误信息到tenant_operation_log，供排查问题
    -   IAM初始化调用BC-10的内部接口，该接口本身支持幂等（基于tenant_id判断是否已初始化）

#### 3.2.4.5 超时与重试策略

+   租户开通流程的超时和重试策略如下表所示。

    | 步骤                | 超时时间 | 重试次数 | 重试间隔 | 超时后处理                           |
    | ------------------- | -------- | -------- | -------- | ------------------------------------ |
    | 创建数据库          | 60秒     | 3次      | 5秒      | 标记失败，记录错误原因，可人工重试   |
    | 创建数据源连接池    | 30秒     | 3次      | 3秒      | 回滚数据库，标记失败                 |
    | 调用BC-10 IAM初始化 | 120秒    | 3次      | 10秒     | 保留数据库，标记INITIALIZING，可重试 |
    | 初始化业务表        | 180秒    | 2次      | 15秒     | 保留已初始化部分，标记失败原因       |
    | 注册数据源路由      | 10秒     | 3次      | 2秒      | 回滚连接池，标记失败                 |

    表 3.2.4.5-1 超时与重试策略

+   **重试机制说明**
    -   自动重试：上表所列重试在TenantProvisioningService内自动执行，使用指数退避策略
    -   人工重试：自动重试耗尽后，租户状态保持在失败前的状态（如CREATING或INITIALIZING），平台管理员可在运营后台点击"重试开通"按钮触发从失败步骤继续执行
    -   幂等保证：每个步骤通过tenantId做幂等检查，重复执行不会产生副作用
    -   告警通知：自动重试失败后发送告警通知给运维人员，便于及时介入处理

### 3.2.5 FL-TL-04 租户激活流程

> **✓ 版本标记：P1实现** — 作为FL-TL-03的最后阶段，随FL-TL-03一同实现

+   本流程描述初始化完成后租户激活的过程。
+   **FL-TL-04实际上是FL-TL-03的最后阶段**，独立为流程是为了明确激活这一关键状态变更。
+   主要差异如下表所示。

    | 维度     | FL-TL-03 租户开通            | FL-TL-04 租户激活                 |
    | -------- | ---------------------------- | --------------------------------- |
    | 关注点   | 整个开通编排（数据库→IAM）   | 状态变更为ACTIVE/TRIAL            |
    | 触发条件 | 审批通过                     | FL-TL-03的IAM初始化成功           |
    | 执行者   | BC-11（编排）+ BC-10（执行） | BC-11                             |
    | 核心操作 | 资源创建和初始化             | 记录激活时间、发布TenantActivated |

    表 3.2.5-1 开通流程与激活流程差异

### 3.2.6 FL-TL-05 试用转正流程

> **⏳ 版本标记：P2实现**（P1直接创建正式租户，不涉及试用转正）

+   本流程描述试用租户在试用期内申请转为正式租户的过程。

#### 3.2.6.1 流程概述

+   流程基本信息如下：
    -   流程目标：试用租户升级为正式租户，解除试用限制
    -   触发条件：租户管理员在管理后台发起转正申请
    -   结束条件：租户类型变为OFFICIAL，状态变为ACTIVE
    -   前提条件：租户当前状态为TRIAL且未过期
    -   预计耗时：< 5秒

#### 3.2.6.2 流程图

+   试用转正流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-TL-05 试用转正流程                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   租户管理员                  BC-11                    BC-12                │
    │  ┌────────┐    ┌────────┐    ┌────────┐                                     │
    │  │ 发起   │───▶│ 提交   │───▶│ 状态   │                                     │
    │  │ 转正   │    │ 转正   │    │ 校验   │                                     │
    │  │ 申请   │    │ 信息   │    └───┬────┘                                     │
    │  └────────┘    └────────┘        │                                          │
    │                             非TRIAL状态                                     │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐                                      │
    │                             │ 返回   │                                      │
    │                             │ 错误   │                                      │
    │                             └────────┘                                      │
    │                                  │                                          │
    │                             状态=TRIAL                                      │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐                                      │
    │                             │ 更新   │                                      │
    │                             │ 类型为 │                                      │
    │                             │OFFICIAL│                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 更新   │                                      │
    │                             │ 状态为 │                                      │
    │                             │ ACTIVE │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐          ┌────────┐                  │
    │                             │ 发布   │─────────▶│ 发送   │                  │
    │                             │ 转正   │          │ 转正   │                  │
    │                             │ 事件   │          │ 通知   │                  │
    │                             └────────┘          └────────┘                  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.6.2-1 试用转正流程

#### 3.2.6.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称 | 执行者     | 输入       | 输出     | 业务规则                           |
    | ---- | -------- | ---------- | ---------- | -------- | ---------------------------------- |
    | 1    | 发起申请 | 租户管理员 | -          | 转正请求 | 仅租户超级管理员可操作             |
    | 2    | 状态校验 | BC-11      | 租户ID     | 校验结果 | 当前状态必须为TRIAL且未过期        |
    | 3    | 更新类型 | BC-11      | 租户ID     | 更新结果 | tenantType: TRIAL → OFFICIAL       |
    | 4    | 更新状态 | BC-11      | 租户ID     | 状态更新 | status: TRIAL → ACTIVE             |
    | 5    | 解除限制 | BC-11      | 租户ID     | 更新结果 | 清除trialExpiresAt，解除用户数限制 |
    | 6    | 发布事件 | BC-11      | 租户信息   | 领域事件 | 发布TenantConverted事件            |
    | 7    | 发送通知 | BC-12      | 管理员邮箱 | -        | 发送转正成功通知                   |

    表 3.2.6.3-1 试用转正流程步骤

+   流程说明：
    -   P1版本中试用转正为简化流程，不涉及付费和套餐选择
    -   P3版本引入商业化后，转正流程将增加套餐选择和支付步骤
    -   试用期间的数据在转正后完全保留

### 3.2.7 FL-TL-06 租户暂停流程

> **⏳ 版本标记：P2实现**

+   本流程描述平台管理员暂停租户服务的过程。

#### 3.2.7.1 流程概述

+   流程基本信息如下：
    -   流程目标：暂停租户服务，阻止该租户所有用户登录和访问
    -   触发条件：平台管理员在运营后台发起暂停操作
    -   结束条件：租户状态变为SUSPENDED，所有用户被强制下线
    -   前提条件：租户当前状态为ACTIVE、TRIAL或EXPIRED
    -   预计耗时：< 5秒

#### 3.2.7.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称  | 执行者     | 输入       | 输出     | 业务规则                           |
    | ---- | --------- | ---------- | ---------- | -------- | ---------------------------------- |
    | 1    | 选择租户  | 平台管理员 | -          | 租户ID   | 选择要暂停的租户                   |
    | 2    | 填写原因  | 平台管理员 | -          | 暂停原因 | 必填：原因代码+原因描述            |
    | 3    | 状态校验  | BC-11      | 租户ID     | 校验结果 | 状态须为ACTIVE/TRIAL/EXPIRED       |
    | 4    | 更新状态  | BC-11      | 租户ID     | 状态更新 | 状态→SUSPENDED，记录暂停原因和时间 |
    | 5    | 发布事件  | BC-11      | 租户信息   | 领域事件 | 发布TenantSuspended事件            |
    | 6    | 通知BC-10 | BC-10      | 事件消息   | -        | BC-10强制该租户所有用户下线        |
    | 7    | 发送通知  | BC-12      | 管理员邮箱 | -        | 发送暂停通知邮件给租户管理员       |
    | 8    | 记录审计  | BC-11      | 操作信息   | 审计日志 | 记录暂停操作人、原因、时间         |

    表 3.2.7.2-1 租户暂停流程步骤

+   暂停后影响：
    -   该租户所有用户无法登录（BC-10在认证时查询租户状态，SUSPENDED拒绝登录）
    -   租户数据保留，不删除
    -   数据源连接池保持ACTIVE状态，通过应用层拦截器拒绝业务请求（便于恢复时立即可用）
    -   管理员可随时恢复

+   **连接池状态处理策略**

    | 租户状态     | 连接池状态 | 处理说明                                                     |
    | ------------ | ---------- | ------------------------------------------------------------ |
    | ACTIVE       | ACTIVE     | 正常运行，接受所有数据库请求                                 |
    | TRIAL        | ACTIVE     | 正常运行，与ACTIVE相同                                       |
    | SUSPENDED    | ACTIVE     | 连接池保持运行但拒绝业务请求（通过应用层拦截），便于快速恢复 |
    | EXPIRED      | ACTIVE     | 与SUSPENDED相同，保持就绪状态                                |
    | DEACTIVATING | ACTIVE     | 宽限期内保持运行，支持撤回后立即恢复服务                     |
    | DEACTIVATED  | CLOSED     | 注销完成后关闭连接池并从路由表移除                           |

    表 3.2.7.2-2 连接池状态处理策略

    -   **设计原因**：暂停/过期状态下保持连接池ACTIVE，是为了在恢复时无需重建连接池，可在秒级恢复服务。连接池的"拒绝请求"通过TenantContextInterceptor在应用层实现，而非关闭连接池。

### 3.2.8 FL-TL-07 租户恢复流程

> **⏳ 版本标记：P2实现**

+   本流程描述平台管理员恢复已暂停租户服务的过程。

#### 3.2.8.1 流程概述

+   流程基本信息如下：
    -   流程目标：恢复已暂停租户的服务，用户可重新登录
    -   触发条件：平台管理员在运营后台发起恢复操作
    -   结束条件：租户状态恢复为ACTIVE，用户可正常登录
    -   前提条件：租户当前状态为SUSPENDED
    -   预计耗时：< 3秒

#### 3.2.8.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称  | 执行者     | 输入       | 输出     | 业务规则                        |
    | ---- | --------- | ---------- | ---------- | -------- | ------------------------------- |
    | 1    | 选择租户  | 平台管理员 | -          | 租户ID   | 选择要恢复的租户                |
    | 2    | 状态校验  | BC-11      | 租户ID     | 校验结果 | 状态必须为SUSPENDED             |
    | 3    | 检查前置  | BC-11      | 暂停原因   | 检查结果 | 欠费暂停需确认已付款            |
    | 4    | 更新状态  | BC-11      | 租户ID     | 状态更新 | 状态→ACTIVE，清除暂停原因和时间 |
    | 5    | 发布事件  | BC-11      | 租户信息   | 领域事件 | 发布TenantResumed事件           |
    | 6    | 通知BC-10 | BC-10      | 事件消息   | -        | BC-10恢复该租户的认证服务       |
    | 7    | 发送通知  | BC-12      | 管理员邮箱 | -        | 发送恢复通知邮件给租户管理员    |
    | 8    | 记录审计  | BC-11      | 操作信息   | 审计日志 | 记录恢复操作人、时间            |

    表 3.2.8.2-1 租户恢复流程步骤

### 3.2.9 FL-TL-08 租户注销流程

> **⏳ 版本标记：P2实现**

+   本流程描述租户注销（终结）的过程，属于不可逆操作。

#### 3.2.9.1 流程概述

+   流程基本信息如下：
    -   流程目标：注销租户，清理所有相关资源
    -   触发条件：平台管理员在运营后台发起注销操作
    -   结束条件：租户状态变为DEACTIVATED，资源完全释放
    -   前提条件：租户当前状态为ACTIVE、SUSPENDED或EXPIRED
    -   预计耗时：宽限期7天 + 清理期7天，共14天

#### 3.2.9.2 流程图

+   租户注销流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-TL-08 租户注销流程                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   平台管理员              BC-11                     定时任务                │
    │  ┌────────┐          ┌────────┐                                             │
    │  │ 发起   │─────────▶│ 状态   │                                             │
    │  │ 注销   │          │ 校验   │                                             │
    │  └────────┘          └───┬────┘                                             │
    │                          │                                                  │
    │                          ▼                                                  │
    │                     ┌────────┐                                              │
    │                     │ 更新   │                                              │
    │                     │ 状态为 │                                              │
    │                     │DEACTIV-│                                              │
    │                     │ ATING  │                                              │
    │                     └───┬────┘                                              │
    │                         │                                                   │
    │                         ▼                                                   │
    │                     ┌────────┐                                              │
    │                     │ 发布   │                                              │
    │                     │ 事件   │                                              │
    │                     │ 通知   │                                              │
    │                     └───┬────┘                                              │
    │                         │                                                   │
    │                         │       ┌─── 宽限期7天（可撤销）                    │
    │                         │       │                                           │
    │                         │       │                ┌────────┐                 │
    │                         │       │                │ 检查   │                 │
    │                         ▼       ▼                │ 宽限期 │                 │
    │                    ┌─────────────────┐           │ 到期   │                 │
    │                    │  等待宽限期结束 │◀──────────│ 任务   │                 │
    │                    └────────┬────────┘           └───┬────┘                 │
    │                             │                        │                      │
    │                             │  宽限期到期            │                      │
    │                             ▼                        ▼                      │
    │                    ┌────────────────────────────────────────┐               │
    │                    │           数据归档/删除                │               │
    │                    │  • 导出租户数据到归档存储              │               │
    │                    │  • 关闭HikariCP连接池                  │               │
    │                    │  • 删除租户数据库                      │               │
    │                    │  • 清理数据源路由注册                  │               │
    │                    └────────────────┬───────────────────────┘               │
    │                                     │                                       │
    │                                     ▼                                       │
    │                                ┌────────┐                                   │
    │                                │ 更新   │                                   │
    │                                │ 状态为 │                                   │
    │                                │DEACTIV-│                                   │
    │                                │ ATED   │                                   │
    │                                └────────┘                                   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.9.2-1 租户注销流程

#### 3.2.9.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者   | 输入       | 输出     | 业务规则                                  |
    | ---- | ---------- | -------- | ---------- | -------- | ----------------------------------------- |
    | 1    | 发起注销   | 管理员   | 租户ID     | 注销请求 | 必填注销原因，二次确认                    |
    | 2    | 状态校验   | BC-11    | 租户ID     | 校验结果 | 状态须为ACTIVE/SUSPENDED/EXPIRED          |
    | 3    | 更新状态   | BC-11    | 租户ID     | 状态更新 | 状态→DEACTIVATING，记录注销原因和开始时间 |
    | 4    | 发布事件   | BC-11    | 租户信息   | 领域事件 | 发布TenantDeactivating事件，通知相关BC    |
    | 5    | 通知租户   | BC-12    | 管理员邮箱 | -        | 发送注销通知，告知宽限期                  |
    | 6    | 等待宽限期 | 定时任务 | -          | -        | 宽限期7天，期间管理员可撤销注销           |
    | 7    | 数据归档   | BC-11    | 租户ID     | 归档文件 | 导出租户数据到归档存储（按注销原因决策）  |
    | 8    | 关闭连接池 | BC-11    | 租户ID     | -        | 关闭HikariCP连接池                        |
    | 9    | 删除数据库 | BC-11    | 租户ID     | -        | 删除clarisphere_t{id}数据库               |
    | 10   | 清理路由   | BC-11    | 租户ID     | -        | 从DynamicDataSource移除路由注册           |
    | 11   | 更新终态   | BC-11    | 租户ID     | 状态更新 | 状态→DEACTIVATED，记录注销完成时间        |
    | 12   | 发布事件   | BC-11    | 租户信息   | 领域事件 | 发布TenantDeactivated事件                 |

    表 3.2.9.3-1 租户注销流程步骤

+   **数据归档验证规则**：
    -   步骤7（数据归档）完成后，必须执行归档验证：
        -   检查归档文件存在且大小>0
        -   校验SHA-256校验和
        -   记录归档元数据（文件路径、大小、校验和、归档时间）
    -   验证失败时：记录错误日志，标记data_archived=false，触发告警，暂停后续清理步骤
    -   验证通过后：标记data_archived=true，继续执行步骤8-12

+   注销说明：
    -   严重违规租户不设宽限期，直接进入清理步骤
    -   试用到期租户的数据不做归档，直接删除
    -   正常注销和合同到期的租户数据归档后保留90天，到期自动清理

### 3.2.10 FL-TL-09 试用到期处理流程

> **⏳ 版本标记：P2实现**

+   本流程描述试用期满后系统自动处理的过程。

#### 3.2.10.1 流程概述

+   流程基本信息如下：
    -   流程目标：试用期满后，根据配置自动暂停或注销试用租户
    -   触发条件：定时任务每日检测试用租户的到期时间
    -   结束条件：到期租户状态变更为EXPIRED
    -   执行方式：定时任务自动执行

#### 3.2.10.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称     | 执行者   | 输入       | 输出     | 业务规则                                    |
    | ---- | ------------ | -------- | ---------- | -------- | ------------------------------------------- |
    | 1    | 扫描到期租户 | 定时任务 | 当前日期   | 到期列表 | 查询status=TRIAL且trialExpiresAt ≤ 当前日期 |
    | 2    | 逐个处理     | BC-11    | 租户ID     | -        | 循环处理每个到期租户                        |
    | 3    | 更新状态     | BC-11    | 租户ID     | 状态更新 | 状态→EXPIRED                                |
    | 4    | 发布事件     | BC-11    | 租户信息   | 领域事件 | 发布TrialExpired事件                        |
    | 5    | 发送通知     | BC-12    | 管理员邮箱 | -        | 发送试用到期通知，引导转正或下载数据        |

    表 3.2.10.2-1 试用到期处理流程步骤

+   到期后续处理：
    -   EXPIRED状态的租户保留数据7天
    -   7天内租户可通过转正流程升级为正式租户（数据保留）
    -   超过7天未转正，系统自动触发FL-TL-08注销流程（无宽限期）

+   到期提醒策略：
    -   试用到期前7天：发送首次提醒
    -   试用到期前3天：发送二次提醒
    -   试用到期前1天：发送最后提醒
    -   试用到期当天：发送到期通知

## 3.3 领域模型设计

+   本节设计租户生命周期子领域的领域模型，包括聚合划分、聚合根实体、值对象、领域服务、领域事件和协作关系。
+   领域模型遵循DDD战术设计原则，聚合内强一致性，聚合间最终一致性。

### 3.3.1 聚合划分

+   租户生命周期子领域划分为以下聚合：

    | 聚合名称 | 聚合根 | 职责                                     | 所属数据库           | 版本 |
    | -------- | ------ | ---------------------------------------- | -------------------- | ---- |
    | 租户聚合 | Tenant | 租户全生命周期管理、状态流转、数据源管理 | clarisphere_platform | P1   |

    表 3.3.1-1 租户生命周期聚合划分

+   聚合划分说明：
    -   租户生命周期子领域仅包含一个聚合——Tenant聚合，聚合根为Tenant实体
    -   Tenant聚合管理租户从申请到注销的全生命周期，包含状态流转、数据源连接池管理、试用管理等职责
    -   Tenant元数据存储在平台库 clarisphere_platform，但每个租户拥有独立的业务数据库 clarisphere_t\<tenant_id\>
    -   与第4章（租户配置）的TenantConfig聚合通过tenantId关联，无直接引用

### 3.3.2 聚合关系图

+   租户生命周期子领域聚合关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                   租户生命周期子领域聚合关系图                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   clarisphere_platform                                                      │
    │  ┌──────────────────────────────────────────────────────────────────────┐   │
    │  │                       Tenant 聚合                                    │   │
    │  │                      （租户聚合）                                    │   │
    │  ├──────────────────────────────────────────────────────────────────────┤   │
    │  │                                                                      │   │
    │  │   ┌──────────────────────┐                                           │   │
    │  │   │ «聚合根»             │                                           │   │
    │  │   │ Tenant               │                                           │   │
    │  │   └──────────┬───────────┘                                           │   │
    │  │              │                                                       │   │
    │  │     ┌────────┼────────┬──────────┬──────────┬──────────┐             │   │
    │  │     │        │        │          │          │          │             │   │
    │  │     ▼        ▼        ▼          ▼          ▼          ▼             │   │
    │  │ ┌────────┐┌────────┐┌──────────┐┌────────┐┌────────┐┌───────────┐    │   │
    │  │ │«值对象»││«值对象»││«值对象»  ││«值对象»││«值对象»││«值对象»   │    │   │
    │  │ │Tenant  ││Tenant  ││DataSource││Contact ││Trial   ││Deactivat- │    │   │
    │  │ │Code    ││Status  ││Config    ││Info    ││Info    ││ionInfo    │    │   │
    │  │ └────────┘└────────┘└──────────┘└────────┘└────────┘└───────────┘    │   │
    │  │                                                                      │   │
    │  └──────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    │   关联聚合（其他子领域，通过tenantId关联）                                  │
    │  ┌──────────────────────────────────────────────────────────────────────┐   │
    │  │  TenantConfig（第4章） │ Subscription（第5章） │ Usage（第7章）      │   │
    │  └──────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.3.2-1 租户生命周期聚合关系图

### 3.3.3 Tenant 聚合

+   Tenant聚合是租户生命周期子领域的唯一聚合，负责管理租户的全生命周期。

#### 3.3.3.1 聚合结构

+   Tenant聚合包含以下元素：

    | 元素类型 | 元素名称         | 说明                                     | 版本 |
    | -------- | ---------------- | ---------------------------------------- | ---- |
    | 聚合根   | Tenant           | 租户实体，管理全生命周期                 | P1   |
    | 值对象   | TenantCode       | 租户代号，全局唯一标识                   | P1   |
    | 值对象   | TenantStatus     | 租户状态，封装状态流转规则               | P1   |
    | 值对象   | DataSourceConfig | 数据源配置，封装数据库连接信息           | P1   |
    | 值对象   | ContactInfo      | 联系人信息，封装企业联系方式             | P1   |
    | 值对象   | TrialInfo        | 试用信息，封装试用期限和规格限制         | P2   |
    | 值对象   | DeactivationInfo | 注销信息，封装注销原因、宽限期和清理状态 | P2   |

    表 3.3.3.1-1 Tenant聚合结构

#### 3.3.3.2 Tenant 实体

+   Tenant是聚合根，采用三表模型定义如下。

##### 属性清单表

| 属性名           | 数据类型         | 约束                      | 默认值         | 业务含义                                                                       | 版本 |
| ---------------- | ---------------- | ------------------------- | -------------- | ------------------------------------------------------------------------------ | ---- |
| id               | Long             | 必填，主键                | 自增           | 租户唯一标识，全局唯一                                                         | P1   |
| tenantCode       | TenantCode       | 必填，全局唯一，**可变**  | -              | 租户代号值对象，仅用于登录输入标识                                             | P1   |
| tenantName       | String           | 必填，长度2-128           | -              | 租户企业名称                                                                   | P1   |
| tenantType       | TenantType       | 必填，枚举                | OFFICIAL       | 租户类型：TRIAL试用 / OFFICIAL正式                                             | P1   |
| status           | TenantStatus     | 必填                      | 由工厂方法决定 | 租户状态值对象，封装状态流转规则。create()初始为CREATING，apply()初始为PENDING | P1   |
| industry         | String           | 可选，长度≤64             | null           | 所属行业，用于租户分析                                                         | P1   |
| scale            | String           | 可选，长度≤32             | null           | 企业规模：如"1-50"、"51-200"等                                                 | P1   |
| contactInfo      | ContactInfo      | 必填                      | 由创建者提供   | 联系人信息值对象                                                               | P1   |
| dataSourceConfig | DataSourceConfig | CREATING后必填            | null           | 数据源配置值对象，租户创建后填充                                               | P1   |
| trialInfo        | TrialInfo        | TRIAL类型必填             | null           | 试用信息值对象，试用租户专属                                                   | P2   |
| deactivationInfo | DeactivationInfo | DEACTIVATING时必填        | null           | 注销信息值对象，发起注销后填充                                                 | P2   |
| maxUserCount     | Integer          | 必填                      | 无限制         | 最大用户数，P1正式租户无限制，P2试用默认5                                      | P1   |
| approvedBy       | Long             | 审批后必填                | null           | 审批人ID，平台管理员                                                           | P2   |
| approvedAt       | DateTime         | 审批后必填                | null           | 审批时间                                                                       | P2   |
| rejectReason     | String           | REJECTED时必填，长度≤512  | null           | 拒绝原因                                                                       | P2   |
| activatedAt      | DateTime         | 激活后必填                | null           | 激活时间，首次进入ACTIVE状态的时刻                                             | P1   |
| suspendedReason  | String           | SUSPENDED时必填，长度≤512 | null           | 暂停原因                                                                       | P2   |
| suspendedAt      | DateTime         | SUSPENDED时必填           | null           | 暂停时间                                                                       | P2   |
| createdBy        | Long             | 必填                      | -              | 创建人ID，平台管理员                                                           | P1   |
| createdAt        | DateTime         | 必填，不可变              | NOW()          | 创建时间                                                                       | P1   |
| updatedAt        | DateTime         | 必填                      | NOW()          | 更新时间，每次修改时自动更新                                                   | P1   |

表 3.3.3.2-1 Tenant属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                                       | 验证时机  | 违反后果             | 异常响应 | 版本 |
| -------- | -------------- | ------------------------------------------------------------------------------ | --------- | -------------------- | -------- | ---- |
| TN-R-01  | 租户代号唯一性 | tenantCode在platform_tenant表中必须全局唯一                                    | 创建/修改 | 拒绝操作，提示重复   | E-409500 | P1   |
| TN-R-02  | 租户代号格式   | tenantCode仅允许小写字母和数字，长度4-20，不能以数字开头                       | 创建      | 拒绝操作，提示格式   | E-400501 | P1   |
| TN-R-03  | 企业名称唯一性 | tenantName在非终态（非REJECTED/DEACTIVATED）的租户中必须唯一                   | 创建      | 拒绝操作，提示重复   | E-409501 | P1   |
| TN-R-04  | 状态流转约束   | 状态转换必须符合状态机定义（表2.4.2-1），不允许非法跳转                        | 状态变更  | 拒绝操作，提示状态   | E-422001 | P1   |
| TN-R-05  | 审批前提       | 审批操作要求status=PENDING，已处理的申请不可重复审批                           | 审批      | 拒绝操作，提示状态   | E-422001 | P2   |
| TN-R-06  | 暂停前提       | 暂停操作要求status为ACTIVE或TRIAL，暂停原因必填                                | 暂停      | 拒绝操作，提示状态   | E-422001 | P2   |
| TN-R-07  | 恢复前提       | 恢复操作要求status=SUSPENDED，且暂停原因已解决（欠费暂停需先缴费）             | 恢复      | 拒绝操作，提示前提   | E-422001 | P2   |
| TN-R-08  | 注销前提       | 注销操作要求status为ACTIVE、SUSPENDED或EXPIRED                                 | 注销      | 拒绝操作，提示状态   | E-422001 | P2   |
| TN-R-09  | 注销不可逆     | status=DEACTIVATED后不可恢复，仅保留元数据供审计                               | -         | -                    | -        | P2   |
| TN-R-10  | 试用规格限制   | TRIAL类型租户：maxUserCount=5，trialInfo.trialDays=30                          | 创建      | 自动设定             | -        | P2   |
| TN-R-11  | 转正前提       | 试用转正要求status=TRIAL，转正后tenantType变更为OFFICIAL                       | 转正      | 拒绝操作，提示状态   | E-422006 | P2   |
| TN-R-12  | 宽限期可撤回   | DEACTIVATING状态且在宽限期内（7天）可撤回注销，恢复到注销前状态                | 撤回      | 拒绝操作，提示已过期 | E-422002 | P2   |
| TN-R-13  | 注销期间冻结   | DEACTIVATING状态期间禁止其他状态变更操作（如暂停、恢复、转正），仅允许撤回注销 | 状态变更  | 拒绝操作，提示注销中 | E-422001 | P2   |

表 3.3.3.2-2 Tenant业务规则表

+   试用限制的具体约束说明（试用期用户数上限、功能限制等）应在P2阶段详细设计时说明。

##### 业务方法表

| 方法名                 | 方法简述                                      | 关联规则         | 异常                         | 事件                      | 版本 |
| ---------------------- | --------------------------------------------- | ---------------- | ---------------------------- | ------------------------- | ---- |
| create()               | 静态工厂方法，直接创建CREATING状态的租户      | TN-R-01,02,03    | TenantAlreadyExistsException | TenantCreated             | P1   |
| apply()                | 静态工厂方法，创建待审批状态的租户申请        | TN-R-01,02,03,10 | TenantAlreadyExistsException | TenantApplied             | P2   |
| approve()              | 审批通过，状态PENDING→CREATING                | TN-R-04,05       | InvalidTenantStatusException | TenantApproved            | P2   |
| reject()               | 审批拒绝，状态PENDING→REJECTED                | TN-R-04,05       | InvalidTenantStatusException | TenantRejected            | P2   |
| markInitializing()     | 标记数据库创建完成，状态CREATING→INITIALIZING | TN-R-04          | InvalidTenantStatusException | -                         | P1   |
| activate()             | 激活租户，状态INITIALIZING→ACTIVE             | TN-R-04          | InvalidTenantStatusException | TenantActivated           | P1   |
| suspend()              | 暂停租户，记录暂停原因和时间                  | TN-R-04,06       | InvalidTenantStatusException | TenantSuspended           | P2   |
| resume()               | 恢复暂停的租户                                | TN-R-04,07       | InvalidTenantStatusException | TenantResumed             | P2   |
| convertToOfficial()    | 试用转正，变更类型和规格                      | TN-R-04,11       | InvalidTenantStatusException | TenantConverted           | P2   |
| expire()               | 试用到期，状态TRIAL→EXPIRED                   | TN-R-04          | InvalidTenantStatusException | TenantExpired             | P2   |
| deactivate()           | 发起注销，状态→DEACTIVATING，设置宽限期       | TN-R-04,08       | InvalidTenantStatusException | TenantDeactivating        | P2   |
| revokeDeactivation()   | 撤回注销（宽限期内），恢复到注销前状态        | TN-R-12          | GracePeriodExpiredException  | TenantDeactivationRevoked | P2   |
| confirmDeactivation()  | 确认注销，宽限期结束后执行，状态→DEACTIVATED  | TN-R-04,09       | InvalidTenantStatusException | TenantDeactivated         | P2   |
| bindDataSource()       | 绑定数据源配置（数据库创建成功后调用）        | -                | -                            | -                         | P1   |
| updateContactInfo()    | 更新联系人信息                                | -                | -                            | -                         | P1   |
| updateMaxUserCount()   | 更新最大用户数（套餐变更时）                  | -                | -                            | -                         | P3   |
| changeTenantCode()     | 修改租户代号（品牌变更等场景），校验唯一性    | TN-R-01,02       | TenantAlreadyExistsException | TenantCodeChanged         | P2   |
| syncTenantCodeChange() | 同步租户代号变更到关联系统（内部方法）        | TN-R-01,02       | -                            | -                         | P2   |

表 3.3.3.2-3 Tenant业务方法表

+   备注：
    -   apply()为静态工厂方法，不是实例方法；试用申请时自动设置TRIAL规格（TN-R-10）
    -   activate()根据tenantType决定目标状态：TRIAL类型→TRIAL状态，OFFICIAL类型→ACTIVE状态
    -   deactivate()设置宽限期（默认7天），宽限期内可通过revokeDeactivation()撤回
    -   changeTenantCode()修改租户代号时的级联处理：
        -   发布TenantCodeChanged事件
        -   BC-10订阅事件后刷新tenant_code→tenant_id缓存映射
        -   清除旧code的缓存条目
        -   同步更新配置表中的冗余tenant_code字段
        +   注意：数据库名（clarisphere_t{id}）和数据源路由key使用tenant_id，不受代号变更影响。
    -   confirmDeactivation()由定时任务在宽限期结束后调用，不可手动调用

#### 3.3.3.3 TenantCode 值对象

+   TenantCode值对象封装租户代号，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 数据类型 | 约束                     | 默认值 | 业务含义                           |
| ------ | -------- | ------------------------ | ------ | ---------------------------------- |
| value  | String   | 必填，长度4-20，全局唯一 | -      | 租户代号值，仅用于用户登录输入标识 |

表 3.3.3.3-1 TenantCode属性清单表

##### 业务规则表

| 规则编号 | 规则名称   | 规则简述                                                                     | 验证时机  | 违反后果 |
| -------- | ---------- | ---------------------------------------------------------------------------- | --------- | -------- |
| TC-R-01  | 格式约束   | 仅允许小写字母和数字，长度4-20，不能以数字开头                               | 创建/修改 | 拒绝操作 |
| TC-R-02  | 保留词检查 | 不允许使用系统保留词（platform、consumer、admin、system等）                  | 创建/修改 | 拒绝操作 |
| TC-R-03  | 可修改性   | 允许修改，但修改后必须仍保持全局唯一（由聚合根的changeTenantCode方法校验）   | 修改      | 拒绝操作 |
| TC-R-04  | 登录标识   | 仅用于用户登录时的输入标识（tenant_code\username），不再用于数据库命名或路由 | -         | -        |

表 3.3.3.3-2 TenantCode业务规则表

+   备注：TenantCode为值对象，由聚合根管理其生命周期。数据库命名和路由键已改用不可变的 tenant_id（Tenant.id），因此 tenant_code 可以修改。修改场景如企业品牌变更、组织合并等。修改需保证全局唯一性。

#### 3.3.3.4 TenantStatus 值对象

+   TenantStatus值对象封装租户状态和状态流转规则，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 数据类型   | 约束       | 默认值         | 业务含义                                                   |
| ------ | ---------- | ---------- | -------------- | ---------------------------------------------------------- |
| status | StatusEnum | 必填，枚举 | 由工厂方法决定 | 租户当前状态，决定可执行的操作。与Tenant实体status属性一致 |

表 3.3.3.4-1 TenantStatus属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                                             | 验证时机 | 违反后果 |
| -------- | ------------ | -------------------------------------------------------------------- | -------- | -------- |
| TS-R-01  | 状态流转约束 | 状态转换必须符合状态机定义，非法跳转抛出InvalidTenantStatusException | 状态变更 | 拒绝操作 |
| TS-R-02  | 终态不可变   | REJECTED和DEACTIVATED为终态，不允许任何状态转换                      | 状态变更 | 拒绝操作 |
| TS-R-03  | 服务可用性   | 仅ACTIVE和TRIAL状态的租户可接受用户登录和业务请求                    | 请求路由 | 拒绝请求 |

表 3.3.3.4-2 TenantStatus业务规则表

##### StatusEnum 枚举值

| 枚举值       | 说明     | 可登录 | 可操作             | 前置状态                             |
| ------------ | -------- | ------ | ------------------ | ------------------------------------ |
| PENDING      | 待审批   | 否     | 仅审批             | 初始状态                             |
| REJECTED     | 已拒绝   | 否     | 无                 | PENDING                              |
| CREATING     | 创建中   | 否     | 仅系统内部操作     | PENDING                              |
| INITIALIZING | 初始化中 | 否     | 仅系统内部操作     | CREATING                             |
| TRIAL        | 试用中   | 是     | 全部（受试用限制） | INITIALIZING                         |
| ACTIVE       | 已激活   | 是     | 全部               | INITIALIZING/TRIAL/SUSPENDED/EXPIRED |
| SUSPENDED    | 已暂停   | 否     | 仅恢复/注销        | ACTIVE/TRIAL                         |
| EXPIRED      | 已过期   | 否     | 仅续费/注销        | TRIAL / ACTIVE                       |
| DEACTIVATING | 注销中   | 否     | 仅撤回/确认注销    | ACTIVE/SUSPENDED/EXPIRED             |
| DEACTIVATED  | 已注销   | 否     | 无                 | DEACTIVATING                         |

表 3.3.3.4-3 StatusEnum枚举值

+   备注：
    -   SUSPENDED状态时用户已被强制下线（通过BC-10协作），恢复后用户需重新登录
    -   EXPIRED状态是TRIAL专有的到期状态，用户不可登录但数据保留（默认7天）
    -   DEACTIVATING状态有7天宽限期，宽限期内可撤回

#### 3.3.3.5 DataSourceConfig 值对象

+   DataSourceConfig值对象封装租户数据库连接信息，采用三表模型定义如下。

##### 属性清单表

| 属性名       | 数据类型   | 约束           | 默认值  | 业务含义                                    |
| ------------ | ---------- | -------------- | ------- | ------------------------------------------- |
| databaseName | String     | 必填，长度≤64  | -       | 数据库名称，格式：clarisphere_t\{tenantId\} |
| jdbcUrl      | String     | 必填，长度≤256 | -       | JDBC连接URL                                 |
| username     | String     | 必填，长度≤64  | -       | 数据库连接用户名                            |
| password     | String     | 必填，长度≤128 | -       | 数据库连接密码（加密存储）                  |
| maxPoolSize  | Integer    | 必填           | 10      | HikariCP最大连接池大小                      |
| minIdle      | Integer    | 必填           | 2       | HikariCP最小空闲连接数                      |
| poolStatus   | PoolStatus | 必填，枚举     | PENDING | 连接池状态：PENDING/ACTIVE/CLOSED           |

表 3.3.3.5-1 DataSourceConfig属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                  | 验证时机  | 违反后果 |
| -------- | -------------- | --------------------------------------------------------- | --------- | -------- |
| DS-R-01  | 数据库命名规范 | databaseName必须为 clarisphere_t\{tenantId\}，不可自定义  | 创建      | 自动生成 |
| DS-R-02  | 密码加密存储   | password字段使用AES-256加密存储，运行时解密               | 创建/更新 | -        |
| DS-R-03  | 连接池范围     | maxPoolSize范围5-50，minIdle范围1-10，minIdle≤maxPoolSize | 创建/更新 | 拒绝操作 |
| DS-R-04  | 池状态流转     | PENDING→ACTIVE（创建成功）→CLOSED（注销时关闭）           | 状态变更  | -        |

表 3.3.3.5-2 DataSourceConfig业务规则表

##### PoolStatus 枚举值

| 枚举值  | 说明   | 可路由 | 前置状态 |
| ------- | ------ | ------ | -------- |
| PENDING | 待创建 | 否     | 初始状态 |
| ACTIVE  | 已激活 | 是     | PENDING  |
| CLOSED  | 已关闭 | 否     | ACTIVE   |

表 3.3.3.5-3 PoolStatus枚举值

+   备注：DataSourceConfig为值对象，无独立业务方法，由聚合根管理其生命周期。连接池的实际管理（创建、销毁）由DataSourceManagementService领域服务负责。

#### 3.3.3.6 ContactInfo 值对象

+   ContactInfo值对象封装租户企业联系信息，采用三表模型定义如下。

##### 属性清单表

| 属性名       | 数据类型 | 约束                       | 默认值 | 业务含义                               |
| ------------ | -------- | -------------------------- | ------ | -------------------------------------- |
| contactName  | String   | 必填，长度2-32             | -      | 联系人姓名，负责对接的企业联系人       |
| contactEmail | String   | 必填，格式：合法邮箱地址   | -      | 联系人邮箱，用于接收审批结果和系统通知 |
| contactPhone | String   | 可选，格式：中国大陆手机号 | null   | 联系人电话                             |
| companyEmail | String   | 可选，格式：合法邮箱地址   | null   | 企业邮箱域名，用于配置邮箱域名白名单   |

表 3.3.3.6-1 ContactInfo属性清单表

##### 业务规则表

| 规则编号 | 规则名称   | 规则简述                                      | 验证时机  | 违反后果 |
| -------- | ---------- | --------------------------------------------- | --------- | -------- |
| CI-R-01  | 邮箱格式   | contactEmail必须符合RFC 5322邮箱格式          | 创建/更新 | 拒绝操作 |
| CI-R-02  | 手机格式   | contactPhone若填写，必须是11位中国大陆手机号  | 创建/更新 | 拒绝操作 |
| CI-R-03  | 联系人必填 | contactName和contactEmail在试用申请时为必填项 | 创建      | 拒绝操作 |

表 3.3.3.6-2 ContactInfo业务规则表

+   备注：ContactInfo为值对象，无独立业务方法，由聚合根管理其生命周期。

#### 3.3.3.7 TrialInfo 值对象

+   TrialInfo值对象封装试用租户的试用期限和规格信息，采用三表模型定义如下。

##### 属性清单表

| 属性名        | 数据类型 | 约束       | 默认值 | 业务含义                                 |
| ------------- | -------- | ---------- | ------ | ---------------------------------------- |
| trialDays     | Integer  | 必填       | 30     | 试用天数，默认30天                       |
| trialStartAt  | DateTime | 激活后必填 | null   | 试用开始时间，激活时填充                 |
| trialExpireAt | DateTime | 激活后必填 | null   | 试用到期时间，trialStartAt + trialDays天 |
| expired       | Boolean  | 必填       | false  | 是否已到期                               |

表 3.3.3.7-1 TrialInfo属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                                          | 验证时机 | 违反后果 |
| -------- | ------------ | ----------------------------------------------------------------- | -------- | -------- |
| TI-R-01  | 试用天数范围 | trialDays范围7-90天，默认30天                                     | 创建     | 自动设定 |
| TI-R-02  | 到期时间计算 | trialExpireAt = trialStartAt + trialDays天，精确到23:59:59        | 激活     | 自动计算 |
| TI-R-03  | 试用类型专属 | 仅tenantType=TRIAL的租户拥有TrialInfo，正式租户为null             | 创建     | -        |
| TI-R-04  | 转正后清理   | 试用转正（convertToOfficial）后，TrialInfo保留但expired标记为true | 转正     | 自动更新 |

表 3.3.3.7-2 TrialInfo业务规则表

+   备注：TrialInfo为值对象，无独立业务方法，由聚合根管理其生命周期。试用到期检查由TenantExpirationService定时任务驱动。

#### 3.3.3.8 DeactivationInfo 值对象

+   DeactivationInfo值对象封装租户注销相关信息，采用三表模型定义如下。

##### 属性清单表

| 属性名           | 数据类型           | 约束           | 默认值 | 业务含义                             |
| ---------------- | ------------------ | -------------- | ------ | ------------------------------------ |
| reason           | DeactivationReason | 必填，枚举     | -      | 注销原因枚举                         |
| reasonDetail     | String             | 可选，长度≤512 | null   | 注销原因详细说明                     |
| requestedAt      | DateTime           | 必填           | -      | 注销请求时间                         |
| gracePeriodEndAt | DateTime           | 必填           | -      | 宽限期结束时间，requestedAt + 7天    |
| previousStatus   | StatusEnum         | 必填           | -      | 注销前的状态，用于宽限期内撤回时恢复 |
| dataArchived     | Boolean            | 必填           | false  | 数据是否已归档                       |
| databaseDropped  | Boolean            | 必填           | false  | 数据库是否已删除                     |
| dataSourceClosed | Boolean            | 必填           | false  | 连接池是否已关闭                     |

表 3.3.3.8-1 DeactivationInfo属性清单表

##### 业务规则表

| 规则编号 | 规则名称   | 规则简述                                           | 验证时机 | 违反后果 |
| -------- | ---------- | -------------------------------------------------- | -------- | -------- |
| DI-R-01  | 宽限期计算 | gracePeriodEndAt = requestedAt + 7天               | 创建     | 自动计算 |
| DI-R-02  | 撤回条件   | 仅在当前时间 < gracePeriodEndAt时可撤回注销        | 撤回     | 拒绝操作 |
| DI-R-03  | 清理顺序   | 清理必须按顺序执行：归档数据→关闭连接池→删除数据库 | 清理     | -        |
| DI-R-04  | 前状态记录 | previousStatus在注销请求时自动记录，用于撤回时恢复 | 创建     | 自动记录 |

表 3.3.3.8-2 DeactivationInfo业务规则表

##### DeactivationReason 枚举值

| 枚举值        | 说明     | 自动/手动 | 宽限期 |
| ------------- | -------- | --------- | ------ |
| VOLUNTARY     | 主动注销 | 手动      | 7天    |
| OVERDUE       | 欠费注销 | 自动      | 7天    |
| VIOLATION     | 违规注销 | 手动      | 7天    |
| TRIAL_EXPIRED | 试用到期 | 自动      | 7天    |
| CONTRACT_END  | 合同到期 | 自动      | 7天    |

表 3.3.3.8-3 DeactivationReason枚举值

+   备注：DeactivationInfo为值对象，无独立业务方法，由聚合根管理其生命周期。无论注销原因如何，均有7天宽限期供撤回。

### 3.3.4 领域服务

+   租户生命周期子领域包含以下领域服务：

    | 服务名称                    | 职责       | 说明                                        | 版本 |
    | --------------------------- | ---------- | ------------------------------------------- | ---- |
    | TenantProvisioningService   | 租户开通   | 编排数据库创建、IAM初始化、数据源注册全流程 | P1   |
    | DatabaseManagementService   | 数据库管理 | 创建/删除租户数据库、执行DDL初始化脚本      | P1   |
    | DataSourceManagementService | 数据源管理 | HikariCP连接池的创建、注册、销毁            | P1   |
    | TenantQueryService          | 租户查询   | 提供租户信息查询，供其他BC调用              | P1   |
    | TenantApprovalService       | 审批处理   | 处理试用申请的审批通过/拒绝逻辑             | P2   |
    | TenantExpirationService     | 到期处理   | 定时扫描到期试用租户，执行到期流程          | P2   |
    | TenantDeactivationService   | 注销处理   | 宽限期到期后执行数据清理和资源回收          | P2   |

    表 3.3.4-1 领域服务清单

#### 3.3.4.1 TenantProvisioningService

+   TenantProvisioningService负责编排租户开通的全流程，是最核心的领域服务：

    | 方法名                     | 参数               | 返回值 | 说明                                              |
    | -------------------------- | ------------------ | ------ | ------------------------------------------------- |
    | provisionTenant()          | tenantId           | void   | 编排开通全流程：创建数据库→初始化→注册数据源→激活 |
    | rollbackProvisioning()     | tenantId, failStep | void   | 开通失败时执行补偿回滚                            |
    | initializeIamTables()      | tenantId           | void   | 调用BC-10 IAM初始化接口                           |
    | initializeBusinessTables() | tenantId           | void   | 执行业务模块DDL脚本初始化                         |

    表 3.3.4.1-1 TenantProvisioningService方法

+   业务逻辑说明：
    -   provisionTenant()采用Saga模式编排，每个步骤有对应的补偿操作
    -   执行顺序：① 生成tenantCode → ② 创建数据库（clarisphere_t{tenant_id}） → ③ 状态→INITIALIZING → ④ 调用BC-10 IAM初始化 → ⑤ 初始化业务表 → ⑥ 注册数据源到路由（key=tenant_id） → ⑦ 状态→ACTIVE或TRIAL
    -   rollbackProvisioning()根据失败步骤决定补偿范围，具体策略见3.2节FL-TL-03失败回滚策略表
    -   initializeIamTables()通过同步RPC调用BC-10（用户管理上下文）的TenantIamFeignClient.initializeIam()，传入tenantId和管理员信息
    -   幂等性保证：每个步骤通过tenantId做幂等检查，重复调用不会产生副作用

#### 3.3.4.2 DatabaseManagementService

+   DatabaseManagementService负责租户数据库的物理管理：

    | 方法名              | 参数                  | 返回值  | 说明                                       |
    | ------------------- | --------------------- | ------- | ------------------------------------------ |
    | createDatabase()    | tenantId              | String  | 创建租户数据库，返回jdbcUrl                |
    | dropDatabase()      | tenantId              | void    | 删除租户数据库（注销清理时使用）           |
    | databaseExists()    | tenantId              | boolean | 检查数据库是否已存在（幂等性检查）         |
    | executeDdlScripts() | tenantId, scriptPaths | void    | 在租户数据库中执行DDL初始化脚本            |
    | archiveDatabase()   | tenantId              | String  | 导出数据库备份后标记为已归档，返回备份路径 |

    表 3.3.4.2-1 DatabaseManagementService方法

+   业务逻辑说明：
    -   createDatabase()执行 CREATE DATABASE clarisphere_t\{tenantId\}，同时创建专属数据库用户
    -   executeDdlScripts()执行IAM表和业务表的DDL脚本，脚本路径从配置中读取
    -   dropDatabase()在注销清理阶段执行，需先确认数据已归档（archiveDatabase()已调用）
    -   所有操作使用平台管理员数据库连接（非租户数据源），避免循环依赖

#### 3.3.4.3 DataSourceManagementService

+   DataSourceManagementService负责HikariCP连接池的运行时管理：

    | 方法名                     | 参数             | 返回值     | 说明                                                       |
    | -------------------------- | ---------------- | ---------- | ---------------------------------------------------------- |
    | registerDataSource()       | tenantId, config | void       | 创建HikariCP连接池并以tenantId为key注册到DynamicDataSource |
    | removeDataSource()         | tenantId         | void       | 关闭连接池并从DynamicDataSource移除                        |
    | getDataSource()            | tenantId         | DataSource | 根据tenantId获取租户数据源，不存在则抛出异常               |
    | isDataSourceActive()       | tenantId         | boolean    | 检查连接池是否存活                                         |
    | refreshDataSource()        | tenantId, config | void       | 刷新连接池配置（如调整池大小）                             |
    | loadAllActiveDataSources() | -                | void       | 应用启动时加载所有ACTIVE租户的数据源                       |

    表 3.3.4.3-1 DataSourceManagementService方法

+   业务逻辑说明：
    -   registerDataSource()创建HikariDataSource实例，配置jdbcUrl、username、password（解密）、maxPoolSize、minIdle，以tenantId为key注册到DynamicDataSource路由表
    -   loadAllActiveDataSources()在应用启动时调用，查询所有status=ACTIVE或TRIAL的租户，逐个创建连接池并以tenantId为key注册
    -   removeDataSource()在租户注销清理阶段调用，先调用HikariDataSource.close()再从路由表移除
    -   getDataSource()被DynamicDataSource.determineTargetDataSource()调用，根据ThreadLocal中的tenantId查找对应数据源，是请求路由的核心路径

#### 3.3.4.4 TenantQueryService

+   TenantQueryService负责对外提供租户信息查询，供BC-10等其他上下文调用：

    | 方法名            | 参数            | 返回值          | 说明                                          |
    | ----------------- | --------------- | --------------- | --------------------------------------------- |
    | getTenantById()   | tenantId        | TenantDTO       | 根据tenantId查询租户信息，含状态和配置        |
    | getTenantByCode() | tenantCode      | TenantDTO       | 根据代号查询租户信息（登录时code→id转换使用） |
    | resolveIdByCode() | tenantCode      | Long            | 根据tenant_code解析tenant_id（登录流程专用）  |
    | getTenantStatus() | tenantId        | StatusEnum      | 查询租户当前状态，认证时校验租户有效性        |
    | isActive()        | tenantId        | boolean         | 判断租户是否可服务（ACTIVE或TRIAL）           |
    | getList()         | query, pageable | Page<TenantDTO> | 分页查询租户列表，支持多条件筛选              |
    | getDetail()       | tenantId        | TenantDetailDTO | 查询租户详情，含完整生命周期信息              |
    | getStatistics()   | -               | TenantStatsDTO  | 获取租户统计概况（各状态数量）                |

    表 3.3.4.4-1 TenantQueryService方法

+   设计说明：
    -   resolveIdByCode()是登录流程的关键方法：用户输入tenant_code\username后，BC-10调用此方法将tenant_code解析为tenant_id，后续所有操作使用tenant_id
    -   getTenantStatus()和isActive()参数已改为tenantId，BC-10在认证流程中使用tenant_id调用
    -   查询服务不修改数据，走只读事务，可对接CQRS读模型
    -   resolveIdByCode()支持缓存，缓存键为 tenant_code_to_id:\{tenantCode\}，TTL 30分钟；租户代号变更时主动清除缓存
    -   getTenantById()支持缓存，缓存键为 tenant:\{tenantId\}，TTL 5分钟

#### 3.3.4.5 TenantExpirationService

+   TenantExpirationService负责定时扫描到期试用租户，执行到期处理流程：

    | 方法名                   | 参数     | 返回值  | 说明                                             |
    | ------------------------ | -------- | ------- | ------------------------------------------------ |
    | scanAndExpire()          | -        | int     | 定时任务：扫描到期租户并执行到期处理，返回处理数 |
    | sendExpirationReminder() | -        | int     | 定时任务：发送到期提醒通知，返回发送数           |
    | isExpired()              | tenantId | boolean | 判断指定试用租户是否已到期                       |

    表 3.3.4.5-1 TenantExpirationService方法

+   业务逻辑说明：
    -   scanAndExpire()由定时任务每日凌晨01:00执行，查询trialExpireAt < 当前时间且status=TRIAL的租户，逐个调用Tenant.expire()
    -   sendExpirationReminder()由定时任务每日08:00执行，查询即将到期的试用租户，按提醒策略发送通知（到期前7天、3天、1天、当天）
    -   到期后租户状态变为EXPIRED，数据保留7天等待续费或注销

#### 3.3.4.6 TenantDeactivationService

+   TenantDeactivationService负责注销宽限期结束后的资源清理工作：

    | 方法名                      | 参数     | 返回值 | 说明                                               |
    | --------------------------- | -------- | ------ | -------------------------------------------------- |
    | processGracePeriodExpired() | -        | int    | 定时任务：处理宽限期已过的注销请求，返回处理数     |
    | executeCleanup()            | tenantId | void   | 执行单个租户的资源清理：归档→关闭连接池→删除数据库 |
    | cleanupExpiredTrials()      | -        | int    | 定时任务：清理已过保留期的过期试用租户             |

    表 3.3.4.6-1 TenantDeactivationService方法

+   业务逻辑说明：
    -   processGracePeriodExpired()由定时任务每日凌晨02:00执行，查询gracePeriodEndAt < 当前时间且status=DEACTIVATING的租户，逐个调用executeCleanup()
    -   executeCleanup()按顺序执行：① archiveDatabase()归档数据 → ② removeDataSource()关闭连接池 → ③ dropDatabase()删除数据库 → ④ confirmDeactivation()标记终态
    -   cleanupExpiredTrials()处理EXPIRED状态超过7天数据保留期的试用租户，自动发起注销流程
    -   每个清理步骤独立记录完成状态（dataArchived、dataSourceClosed、databaseDropped），支持断点续传

### 3.3.5 领域事件

+   租户生命周期子领域发布以下领域事件：

    | 事件名称                  | 触发时机               | 消费者       | 说明                                                         | 版本 |
    | ------------------------- | ---------------------- | ------------ | ------------------------------------------------------------ | ---- |
    | TenantCreated             | 租户直接创建成功       | BC-10        | 记录审计日志，触发开通流程                                   | P1   |
    | TenantActivated           | 租户激活成功           | BC-10, BC-12 | 记录审计日志，发送开通成功通知和管理员信息                   | P1   |
    | TenantApplied             | 租户申请提交成功       | BC-10, BC-12 | 记录审计日志，发送申请确认通知给联系人                       | P2   |
    | TenantApproved            | 租户审批通过           | BC-10        | 记录审计日志，触发开通流程                                   | P2   |
    | TenantRejected            | 租户审批拒绝           | BC-10, BC-12 | 记录审计日志，发送拒绝通知给联系人                           | P2   |
    | TenantConverted           | 试用转正成功           | BC-10, BC-12 | 记录审计日志，发送转正成功通知                               | P2   |
    | TenantExpired             | 试用到期               | BC-10, BC-12 | 记录审计日志，通知BC-10限制登录，发送到期通知                | P2   |
    | TenantSuspended           | 租户暂停               | BC-10, BC-12 | 记录审计日志，通知BC-10强制下线，发送暂停通知                | P2   |
    | TenantResumed             | 租户恢复               | BC-10        | 记录审计日志，通知BC-10恢复认证服务                          | P2   |
    | TenantDeactivating        | 租户发起注销（宽限期） | BC-10, BC-12 | 记录审计日志，发送注销宽限期提醒通知                         | P2   |
    | TenantDeactivationRevoked | 撤回注销申请           | BC-10        | 记录审计日志                                                 | P2   |
    | TenantDeactivated         | 租户注销完成           | BC-10        | 记录审计日志，通知BC-10清理该租户相关缓存和Token             | P2   |
    | TenantCodeChanged         | 租户代号修改           | BC-10        | 记录审计日志，刷新BC-10本地缓存中的tenant_code→tenant_id映射 | P2   |

    表 3.3.5-1 领域事件清单

#### 3.3.5.1 事件结构示例

+   TenantActivated事件结构（租户激活是最关键的事件，触发其他BC联动）：

    | 字段名      | 数据类型 | 说明                          |
    | ----------- | -------- | ----------------------------- |
    | eventId     | String   | 事件唯一标识（UUID）          |
    | eventType   | String   | 事件类型：TenantActivated     |
    | eventTime   | DateTime | 事件发生时间                  |
    | tenantId    | Long     | 租户ID                        |
    | tenantCode  | String   | 租户代号                      |
    | tenantName  | String   | 租户企业名称                  |
    | tenantType  | String   | 租户类型：TRIAL / OFFICIAL    |
    | adminUserId | Long     | 租户管理员用户ID（BC-10创建） |
    | adminEmail  | String   | 管理员邮箱                    |
    | activatedAt | DateTime | 激活时间                      |

    表 3.3.5.1-1 TenantActivated事件结构

+   TenantSuspended事件结构（暂停事件需携带原因，BC-10据此决定处理策略）：

    | 字段名        | 数据类型 | 说明                      |
    | ------------- | -------- | ------------------------- |
    | eventId       | String   | 事件唯一标识（UUID）      |
    | eventType     | String   | 事件类型：TenantSuspended |
    | eventTime     | DateTime | 事件发生时间              |
    | tenantId      | Long     | 租户ID                    |
    | tenantCode    | String   | 租户代号                  |
    | suspendReason | String   | 暂停原因                  |
    | suspendedBy   | Long     | 操作人ID（平台管理员）    |
    | suspendedAt   | DateTime | 暂停时间                  |

    表 3.3.5.1-2 TenantSuspended事件结构

+   TenantDeactivated事件结构（注销完成事件，通知所有相关BC清理资源）：

    | 字段名        | 数据类型 | 说明                        |
    | ------------- | -------- | --------------------------- |
    | eventId       | String   | 事件唯一标识（UUID）        |
    | eventType     | String   | 事件类型：TenantDeactivated |
    | eventTime     | DateTime | 事件发生时间                |
    | tenantId      | Long     | 租户ID                      |
    | tenantCode    | String   | 租户代号                    |
    | reason        | String   | 注销原因                    |
    | deactivatedAt | DateTime | 注销完成时间                |

    表 3.3.5.1-3 TenantDeactivated事件结构

### 3.3.6 协作关系

+   本节梳理租户生命周期子领域与其他子领域及外部BC之间的协作关系，包括领域内协作、跨领域协作和跨BC协作三个层面。

#### 3.3.6.1 领域内协作

+   租户生命周期子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方                    | 被调用方                    | 协作方式 | 触发场景       | 说明                                        |
    | --------- | ------------------------- | --------------------------- | -------- | -------------- | ------------------------------------------- |
    | INTRA-001 | TenantProvisioningService | Tenant（聚合根）            | 方法调用 | 开通流程各阶段 | 调用approve()、markCreating()、activate()等 |
    | INTRA-002 | TenantProvisioningService | DatabaseManagementService   | 方法调用 | 创建租户数据库 | 调用createDatabase()和executeDdlScripts()   |
    | INTRA-003 | TenantProvisioningService | DataSourceManagementService | 方法调用 | 注册数据源     | 调用registerDataSource()将连接池注册到路由  |
    | INTRA-004 | TenantExpirationService   | Tenant（聚合根）            | 方法调用 | 试用到期处理   | 调用Tenant.expire()变更状态                 |
    | INTRA-005 | TenantDeactivationService | DatabaseManagementService   | 方法调用 | 注销清理阶段   | 调用archiveDatabase()和dropDatabase()       |
    | INTRA-006 | TenantDeactivationService | DataSourceManagementService | 方法调用 | 注销清理阶段   | 调用removeDataSource()关闭连接池            |
    | INTRA-007 | TenantDeactivationService | Tenant（聚合根）            | 方法调用 | 注销确认       | 调用confirmDeactivation()标记终态           |
    | INTRA-008 | TenantQueryService        | Tenant（聚合根）            | 仓储查询 | 租户信息查询   | 通过TenantRepository读取数据，走只读事务    |

    表 3.3.6.1-1 领域内协作关系

#### 3.3.6.2 跨领域协作

+   租户生命周期子领域与BC-11内部其他子领域的跨领域协作关系如下表所示。

##### 与租户配置子领域（第4章）的协作

+   租户生命周期与租户配置之间的协作关系如下表所示。

    | 协作编号  | 方向            | 协作方式 | 触发事件/接口                 | 说明                                                 |
    | --------- | --------------- | -------- | ----------------------------- | ---------------------------------------------------- |
    | CROSS-001 | 生命周期 → 配置 | 领域事件 | TenantActivated               | 租户激活后，配置子领域为其创建默认配置（认证方式等） |
    | CROSS-002 | 生命周期 → 配置 | 领域事件 | TenantDeactivated             | 租户注销后，配置子领域清理该租户的所有配置数据       |
    | CROSS-003 | 配置 → 生命周期 | RPC调用  | TenantQueryService.isActive() | 配置变更时校验租户是否处于有效状态                   |

    表 3.3.6.2-1 与租户配置子领域的协作

+   **聚合一致性说明**
    -   Tenant聚合与TenantConfig聚合分属不同子领域，各自拥有独立的Repository
    -   一致性保证策略：
        -   **创建时**：租户激活（TenantActivated事件）后，TenantConfig订阅该事件并创建默认配置，采用最终一致性
        -   **更新时**：TenantConfig的变更独立于Tenant聚合，无需跨聚合事务
        -   **删除时**：租户注销（TenantDeactivated事件）后，TenantConfig订阅该事件并清理配置数据，采用最终一致性
    -   事务边界：每个聚合在单独的事务中持久化，通过领域事件实现跨聚合协调
    -   异常处理：如果TenantConfig创建失败，不影响租户激活状态，通过事件重试机制保证最终一致

##### 与租户运维子领域（第6章）的协作

+   租户生命周期与租户运维之间的协作关系如下表所示。

    | 协作编号  | 方向            | 协作方式 | 触发事件/接口                  | 说明                                               |
    | --------- | --------------- | -------- | ------------------------------ | -------------------------------------------------- |
    | CROSS-011 | 生命周期 → 运维 | 领域事件 | TenantActivated                | 租户激活后，运维子领域初始化该租户的配额和监控配置 |
    | CROSS-012 | 生命周期 → 运维 | 领域事件 | TenantDeactivated              | 租户注销后，运维子领域清理监控配置和用量数据       |
    | CROSS-013 | 运维 → 生命周期 | RPC调用  | TenantQueryService.getDetail() | 运维面板展示时获取租户基本信息                     |

    表 3.3.6.2-2 与租户运维子领域的协作

#### 3.3.6.3 跨BC协作

+   租户生命周期子领域与其他BC的跨BC协作通过事件驱动和RPC调用两种方式实现。

##### 与BC-10（用户管理上下文）的协作

+   租户生命周期与BC-10之间的协作关系如下表所示。

    | 协作编号 | 方向          | 协作方式 | 触发事件/接口                        | 说明                                                   |
    | -------- | ------------- | -------- | ------------------------------------ | ------------------------------------------------------ |
    | BC10-001 | BC-11 → BC-10 | 同步RPC  | TenantIamFeignClient.initializeIam() | 租户开通时调用BC-10初始化IAM表（iam_user, iam_role等） |
    | BC10-002 | BC-11 → BC-10 | 领域事件 | TenantSuspended                      | 租户暂停时通知BC-10强制下线该租户所有在线用户          |
    | BC10-003 | BC-11 → BC-10 | 领域事件 | TenantResumed                        | 租户恢复时通知BC-10恢复该租户的认证服务                |
    | BC10-004 | BC-11 → BC-10 | 领域事件 | TenantDeactivated                    | 租户注销时通知BC-10清理该租户相关缓存和Token           |
    | BC10-005 | BC-11 → BC-10 | 领域事件 | TenantExpired                        | 试用到期时通知BC-10限制该租户用户登录                  |
    | BC10-006 | BC-10 → BC-11 | 同步RPC  | TenantQueryService.getTenantStatus() | 用户登录时BC-10查询租户状态，判断租户是否有效          |
    | BC10-007 | BC-10 → BC-11 | 同步RPC  | TenantQueryService.isActive()        | 认证流程中快速判断租户是否可服务                       |

    表 3.3.6.3-1 与BC-10（用户管理上下文）的协作

+   协作说明：
    -   BC10-001是开通流程中的关键步骤，采用同步RPC调用，BC-10需保证幂等性（通过tenantId去重）
    -   BC10-002~005通过领域事件异步通知，BC-10订阅后根据事件类型执行相应操作
    -   BC10-006~007是认证热路径，需要高性能，建议BC-10本地缓存租户状态，通过事件保持缓存一致性

##### 与BC-10的审计协作

+   审计功能已合并至BC-10（用户管理上下文），不再作为独立上下文。租户生命周期事件的审计处理如下：

    | 协作编号 | 方向          | 协作方式 | 触发事件/接口                       | 说明                                                           |
    | -------- | ------------- | -------- | ----------------------------------- | -------------------------------------------------------------- |
    | BC10-008 | BC-11 → BC-10 | 领域事件 | 所有租户生命周期领域事件            | BC-10用户管理上下文订阅表3.3.5-1中的全部事件，记录操作审计日志 |
    | BC10-009 | BC-11 → BC-10 | 领域事件 | TenantSuspended / TenantDeactivated | BC-10额外记录安全审计日志                                      |

    表 3.3.6.3-2 与BC-10的审计协作

##### 与BC-12（通知上下文）的协作

+   租户生命周期与BC-12之间的协作关系如下表所示。

    | 协作编号 | 方向          | 协作方式 | 触发事件/接口      | 说明                                                 |
    | -------- | ------------- | -------- | ------------------ | ---------------------------------------------------- |
    | BC12-001 | BC-11 → BC-12 | 领域事件 | TenantApplied      | 发送试用申请确认通知（邮件）给联系人                 |
    | BC12-002 | BC-11 → BC-12 | 领域事件 | TenantRejected     | 发送审批拒绝通知（邮件）给联系人，含拒绝原因         |
    | BC12-003 | BC-11 → BC-12 | 领域事件 | TenantActivated    | 发送开通成功通知（邮件），含管理员账号和登录地址     |
    | BC12-004 | BC-11 → BC-12 | 领域事件 | TenantConverted    | 发送试用转正成功通知（邮件）                         |
    | BC12-005 | BC-11 → BC-12 | 领域事件 | TenantExpired      | 发送试用到期通知（邮件）                             |
    | BC12-006 | BC-11 → BC-12 | 领域事件 | TenantSuspended    | 发送租户暂停通知（邮件+短信），含暂停原因和恢复方式  |
    | BC12-007 | BC-11 → BC-12 | 领域事件 | TenantDeactivating | 发送注销宽限期提醒通知（邮件），含撤回方式和截止时间 |

    表 3.3.6.3-3 与BC-12（通知上下文）的协作

##### 与BC-01~09（业务模块上下文）的协作

+   租户生命周期与业务模块之间的协作关系如下表所示。

    | 协作编号 | 方向             | 协作方式 | 触发事件/接口                     | 说明                                       |
    | -------- | ---------------- | -------- | --------------------------------- | ------------------------------------------ |
    | BCXX-001 | BC-11 → BC-01~09 | 同步RPC  | 各BC的TableInitFeignClient.init() | 租户开通时调用各业务模块的表初始化接口     |
    | BCXX-002 | BC-11 → BC-01~09 | 领域事件 | TenantDeactivated                 | 租户注销后通知各业务模块清理该租户相关资源 |

    表 3.3.6.3-4 与BC-01~09（业务模块上下文）的协作

+   协作说明：
    -   BCXX-001在租户开通流程（FL-TL-03）的initializeBusinessTables()步骤中按配置顺序逐个调用
    -   各业务模块需实现统一的TableInitFeignClient接口，提供init(tenantId)方法
    -   P1阶段仅BC-10的IAM初始化，业务模块的表初始化在对应BC进入P1后逐步接入

#### 3.3.6.4 协作时序总览

+   以下ASCII图展示租户开通（最复杂的协作场景）的跨域协作时序：

    ```
    ┌────────────────────────────────────────────────────────────────────────────────────┐
    │                     租户开通跨域协作时序                                           │
    ├────────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                    │
    │  BC-11 租户生命周期                BC-10 （含审计）               BC-12            │
    │  ┌──────────────────┐             ┌──────────┐          ┌────┐   ┌────┐            │
    │  │                  │             │          │          │    │   │    │            │
    │  │  1. approve()    │             │          │          │    │   │    │            │
    │  │  PENDING→CREATING│──event──────│──────────│─────────▶│log │   │    │            │
    │  │                  │             │          │          │    │   │    │            │
    │  │  2. createDB()   │             │          │          │    │   │    │            │
    │  │  CREATING→INIT   │             │          │          │    │   │    │            │
    │  │                  │             │          │          │    │   │    │            │
    │  │  3. initIam()    │──sync RPC──▶│ init()   │          │    │   │    │            │
    │  │                  │◀──response──│ 创建表   │          │    │   │    │            │
    │  │                  │             │ 创建管理员          │    │   │    │            │
    │  │                  │             │          │          │    │   │    │            │
    │  │  4. registerDS() │             │          │          │    │   │    │            │
    │  │                  │             │          │          │    │   │    │            │
    │  │  5. activate()   │             │          │          │    │   │    │            │
    │  │  INIT→ACTIVE     │──event──────│──────────│─────────▶│log │   │    │            │
    │  │                  │──event──────│ 缓存状态 │          │    │  ▶│通知│            │
    │  │                  │             │          │          │    │   │    │            │
    │  └──────────────────┘             └──────────┘          └────┘   └────┘            │
    │                                                                                    │
    │  ── sync RPC ──  同步调用（强依赖，失败触发回滚）                                  │
    │  ── event ────── 领域事件（异步，最终一致性）                                      │
    │                                                                                    │
    └────────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.3.6.4-1 租户开通跨域协作时序图

## 3.4 接口设计

+   本节设计租户生命周期子领域的API接口，按视角分组（UP运营方视角 + 公共接口 + 内部RPC）。
+   接口设计遵循RESTful规范，路径按第2.9.3节API路径规划执行。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 3.4.1 接口总览

+   租户生命周期子领域对外提供REST API、RPC和消息三类接口。

#### 3.4.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明           |
    | -------- | ---- | -------------- |
    | REST API | 13个 | 前端调用       |
    | RPC接口  | 4个  | 微服务内部调用 |
    | 消息接口 | 13个 | 事件发布       |

    表 3.4.1.1-1 接口分类统计

+   说明：
    -   REST API分为UP运营方接口（11个）和公共接口（2个），P1阶段无UR视角租户管理API
    -   RPC接口供BC-10认证子域通过Feign调用，用于认证流程中校验租户状态
    -   消息接口通过领域事件发布，事件定义详见表 3.3.5-1

#### 3.4.1.2 REST API 清单表

+   租户生命周期 REST API 清单如下表所示。

    | API编号    | API名称          | 方法 | 路径                                                   | 权限                              | 领域方法                            | 版本 |
    | ---------- | ---------------- | ---- | ------------------------------------------------------ | --------------------------------- | ----------------------------------- | ---- |
    | P-TNT-01   | 查询租户列表     | GET  | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:list       | TenantQueryService.getList()        | P1   |
    | P-TNT-02   | 查询租户详情     | GET  | /api/v1/provider/tenant/tenants/{id}                   | provider:tenant:tenant:read       | TenantQueryService.getDetail()      | P1   |
    | P-TNT-03   | 租户统计概况     | GET  | /api/v1/provider/tenant/tenants/statistics             | provider:tenant:tenant:list       | TenantQueryService.getStatistics()  | P1   |
    | P-TNT-04   | 审批通过         | POST | /api/v1/provider/tenant/tenants/{id}/approve           | provider:tenant:tenant:approve    | Tenant.approve()                    | P2   |
    | P-TNT-05   | 审批拒绝         | POST | /api/v1/provider/tenant/tenants/{id}/reject            | provider:tenant:tenant:approve    | Tenant.reject()                     | P2   |
    | P-TNT-06   | 暂停租户         | POST | /api/v1/provider/tenant/tenants/{id}/suspend           | provider:tenant:tenant:suspend    | Tenant.suspend()                    | P2   |
    | P-TNT-07   | 恢复租户         | POST | /api/v1/provider/tenant/tenants/{id}/resume            | provider:tenant:tenant:suspend    | Tenant.resume()                     | P2   |
    | P-TNT-08   | 试用转正         | POST | /api/v1/provider/tenant/tenants/{id}/convert           | provider:tenant:tenant:update     | Tenant.convertToOfficial()          | P2   |
    | P-TNT-09   | 发起注销         | POST | /api/v1/provider/tenant/tenants/{id}/deactivate        | provider:tenant:tenant:deactivate | Tenant.deactivate()                 | P2   |
    | P-TNT-10   | 撤回注销         | POST | /api/v1/provider/tenant/tenants/{id}/deactivate/revoke | provider:tenant:tenant:deactivate | Tenant.revokeDeactivation()         | P2   |
    | P-TNT-11   | 更新联系人信息   | PUT  | /api/v1/provider/tenant/tenants/{id}/contact           | provider:tenant:tenant:update     | Tenant.updateContactInfo()          | P1   |
    | P-TNT-12   | 直接创建租户     | POST | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:create     | Tenant.create()                     | P1   |
    | PUB-TNT-01 | 提交试用申请     | POST | /api/v1/public/tenant/trial/apply                      | 无                                | Tenant.apply()                      | P2   |
    | PUB-TNT-02 | 查询试用申请状态 | GET  | /api/v1/public/tenant/trial/{applyToken}/status        | 无                                | TenantQueryService.getApplyStatus() | P2   |

    表 3.4.1.2-1 租户生命周期 REST API 清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，P-TNT前缀表示UP运营方接口，PUB-TNT前缀表示公共接口
    -   领域方法：关联到第3.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况

#### 3.4.1.3 RPC 接口清单表

+   租户生命周期子领域提供的RPC接口清单如下表所示。

    | 接口编号   | 接口名称           | 调用方        | 接口类型 | 领域方法                             | 说明                                    | 版本 |
    | ---------- | ------------------ | ------------- | -------- | ------------------------------------ | --------------------------------------- | ---- |
    | RPC-TNT-01 | 查询租户状态       | BC-10认证子域 | Feign    | TenantQueryService.getTenantStatus() | 登录流程中判断租户是否有效              | P1   |
    | RPC-TNT-02 | 判断租户是否可服务 | BC-10认证子域 | Feign    | TenantQueryService.isActive()        | 认证流程中快速判断租户是否可服务        | P1   |
    | RPC-TNT-03 | 查询租户基本信息   | BC-10认证子域 | Feign    | TenantQueryService.getTenantById()   | Token签发时获取租户名称等信息写入claims | P1   |
    | RPC-TNT-04 | 根据code解析租户ID | BC-10认证子域 | Feign    | TenantQueryService.resolveIdByCode() | 登录时根据tenant_code解析为tenant_id    | P1   |

    表 3.4.1.3-1 RPC接口清单表

#### 3.4.1.4 消息接口清单表

+   租户生命周期子领域发布的消息接口清单如下表所示。

    | 接口编号   | 消息名称                  | 消息类型 | Topic         | 触发领域方法                 | 消费方       | 版本 |
    | ---------- | ------------------------- | -------- | ------------- | ---------------------------- | ------------ | ---- |
    | MSG-TNT-04 | TenantCreated             | 领域事件 | tenant.events | Tenant.create()              | BC-10        | P1   |
    | MSG-TNT-05 | TenantActivated           | 领域事件 | tenant.events | Tenant.activate()            | BC-10, BC-12 | P1   |
    | MSG-TNT-01 | TenantApplied             | 领域事件 | tenant.events | Tenant.apply()               | BC-10, BC-12 | P2   |
    | MSG-TNT-02 | TenantApproved            | 领域事件 | tenant.events | Tenant.approve()             | BC-10        | P2   |
    | MSG-TNT-03 | TenantRejected            | 领域事件 | tenant.events | Tenant.reject()              | BC-10, BC-12 | P2   |
    | MSG-TNT-06 | TenantConverted           | 领域事件 | tenant.events | Tenant.convertToOfficial()   | BC-10, BC-12 | P2   |
    | MSG-TNT-07 | TenantExpired             | 领域事件 | tenant.events | Tenant.expire()              | BC-10, BC-12 | P2   |
    | MSG-TNT-08 | TenantSuspended           | 领域事件 | tenant.events | Tenant.suspend()             | BC-10, BC-12 | P2   |
    | MSG-TNT-09 | TenantResumed             | 领域事件 | tenant.events | Tenant.resume()              | BC-10        | P2   |
    | MSG-TNT-10 | TenantDeactivating        | 领域事件 | tenant.events | Tenant.deactivate()          | BC-10, BC-12 | P2   |
    | MSG-TNT-11 | TenantDeactivationRevoked | 领域事件 | tenant.events | Tenant.revokeDeactivation()  | BC-10        | P2   |
    | MSG-TNT-12 | TenantDeactivated         | 领域事件 | tenant.events | Tenant.confirmDeactivation() | BC-10        | P2   |
    | MSG-TNT-13 | TenantCodeChanged         | 领域事件 | tenant.events | Tenant.changeTenantCode()    | BC-10        | P2   |

    表 3.4.1.4-1 消息接口清单表

### 3.4.2 RPC 接口设计

+   租户生命周期子领域通过Feign向BC-10（用户管理上下文）提供内部RPC接口。

#### 3.4.2.1 TenantLifecycleFeignClient

+   **TenantFeignClient 概述**

    | 属性     | 值                                          |
    | -------- | ------------------------------------------- |
    | 接口名称 | TenantLifecycleFeignClient                  |
    | 职责     | 供BC-10用户管理上下文查询租户状态和基本信息 |
    | 服务名   | svc-tenant                                  |
    | 路径前缀 | /internal/tenant/lifecycle                  |
    | 降级实现 | TenantLifecycleFeignClientFallback          |
    | 默认超时 | 3秒                                         |

    表 3.4.2.1-1 TenantLifecycleFeignClient概述

+   **方法清单表**

    | 方法                        | 简述                       | HTTP | 路径                  | 入参       | 返回            | 超时 | 降级返回      |
    | --------------------------- | -------------------------- | ---- | --------------------- | ---------- | --------------- | ---- | ------------- |
    | getTenantStatus(tenantId)   | 查询租户当前状态           | GET  | /{tenantId}/status    | tenantId   | TenantStatusDTO | 3秒  | 视为不可用    |
    | isActive(tenantId)          | 判断租户是否可服务         | GET  | /{tenantId}/active    | tenantId   | boolean         | 2秒  | 视为不可用    |
    | getTenantById(tenantId)     | 查询租户基本信息           | GET  | /{tenantId}           | tenantId   | TenantBasicDTO  | 3秒  | 拒绝签发Token |
    | resolveIdByCode(tenantCode) | 根据code解析id（登录专用） | GET  | /resolve/{tenantCode} | tenantCode | Long            | 3秒  | 拒绝登录      |

    表 3.4.2.1-2 TenantLifecycleFeignClient方法清单表

+   **RPC-TNT-01 getTenantStatus 契约**

    | 属性     | 值                                                                 |
    | -------- | ------------------------------------------------------------------ |
    | 接口编号 | RPC-TNT-01                                                         |
    | 调用场景 | 认证子域登录流程，用户身份校验通过后调用，判断其所属租户是否可服务 |
    | 入参     | tenantId: Long                                                     |
    | 返回类型 | TenantStatusDTO                                                    |
    | 幂等性   | 是（只读查询）                                                     |

    表 3.4.2.1-3 RPC-TNT-01契约概述

+   **TenantStatusDTO 结构**

    | 字段名      | 数据类型 | 说明                                            |
    | ----------- | -------- | ----------------------------------------------- |
    | tenantId    | Long     | 租户ID                                          |
    | tenantCode  | String   | 租户代号                                        |
    | status      | String   | 租户状态枚举值                                  |
    | tenantType  | String   | 租户类型：TRIAL / OFFICIAL                      |
    | active      | boolean  | 是否可服务（ACTIVE或TRIAL）                     |
    | suspendedAt | DateTime | 暂停时间（SUSPENDED时有值），null表示非暂停状态 |

    表 3.4.2.1-4 TenantStatusDTO字段

+   **RPC-TNT-02 isActive 契约**

    | 属性     | 值                                                                   |
    | -------- | -------------------------------------------------------------------- |
    | 接口编号 | RPC-TNT-02                                                           |
    | 调用场景 | 认证子域快速判断租户是否可服务，用于请求路由和数据源切换前的前置校验 |
    | 入参     | tenantId: Long                                                       |
    | 返回类型 | boolean                                                              |
    | 幂等性   | 是（只读查询）                                                       |

    表 3.4.2.1-5 RPC-TNT-02契约概述

+   **RPC-TNT-03 getTenantById 契约**

    | 属性     | 值                                                              |
    | -------- | --------------------------------------------------------------- |
    | 接口编号 | RPC-TNT-03                                                      |
    | 调用场景 | 认证子域签发JWT Token时调用，获取租户名称等信息写入Token claims |
    | 入参     | tenantId: Long                                                  |
    | 返回类型 | TenantBasicDTO                                                  |
    | 幂等性   | 是（只读查询）                                                  |

    表 3.4.2.1-6 RPC-TNT-03契约概述

+   **TenantBasicDTO 结构**

    | 字段名       | 数据类型 | 说明                       |
    | ------------ | -------- | -------------------------- |
    | tenantId     | Long     | 租户ID                     |
    | tenantCode   | String   | 租户代号                   |
    | tenantName   | String   | 租户企业名称               |
    | tenantType   | String   | 租户类型：TRIAL / OFFICIAL |
    | status       | String   | 租户状态枚举值             |
    | maxUserCount | Integer  | 最大用户数                 |
    | activatedAt  | DateTime | 激活时间                   |

    表 3.4.2.1-7 TenantBasicDTO字段

+   **RPC-TNT-04 resolveIdByCode 契约**

    | 属性     | 值                                                                                   |
    | -------- | ------------------------------------------------------------------------------------ |
    | 接口编号 | RPC-TNT-04                                                                           |
    | 调用场景 | 用户登录时，BC-10根据用户输入的tenant_code解析为tenant_id，后续认证流程使用tenant_id |
    | 入参     | tenantCode: String                                                                   |
    | 返回类型 | Long（tenant_id），若不存在则返回null                                                |
    | 幂等性   | 是（只读查询）                                                                       |

    表 3.4.2.1-8 RPC-TNT-04契约概述

+   **备注**
    -   四个接口均为只读查询，走只读事务，不修改任何数据
    -   接口定义在 `bc-11-tenant-api` 模块的 `feign` 包下
    -   BC-10建议本地缓存isActive()结果（TTL 5分钟），通过订阅租户状态变更事件刷新缓存

#### 3.4.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口            | 降级条件        | 降级返回值                      | 日志级别 | 说明                                      |
    | --------------- | --------------- | ------------------------------- | -------- | ----------------------------------------- |
    | getTenantStatus | 超时/服务不可用 | 视为不可用（active=false）      | ERROR    | 租户状态未知时拒绝登录，安全优先          |
    | isActive        | 超时/服务不可用 | 返回false                       | ERROR    | 租户状态未知时拒绝请求路由，安全优先      |
    | getTenantById   | 超时/服务不可用 | 抛出ServiceUnavailableException | ERROR    | 拒绝签发Token，返回登录失败；不可静默通过 |
    | resolveIdByCode | 超时/服务不可用 | 抛出ServiceUnavailableException | ERROR    | 拒绝登录，返回租户不存在；不可静默通过    |

    表 3.4.2.2-1 降级策略

+   **降级设计说明**
    -   三个接口均采用偏严格的降级策略：租户状态是安全边界的关键判断依据，降级时宁可拒绝服务也不可放行
    -   这与BC-10的getUserMfaStatus偏宽松策略不同：MFA是增强安全，而租户状态是基础安全
    -   熔断策略：连续5次调用失败后触发熔断，熔断窗口30秒，半开状态允许1个探测请求
    -   建议BC-10对isActive()做本地缓存，降低对RPC的依赖

### 3.4.3 消息接口设计

+   租户生命周期子领域通过领域事件发布消息。所有事件共享统一的通道和封装规范。

+   **消息编号规则**
    -   消息编号格式：`MSG-TNT-{序号}`，序号为两位数字
    -   编号按事件发生的时间顺序分配，部分编号预留用于未来扩展

#### 3.4.3.1 消息通道配置

+   租户生命周期的消息通道配置如下表所示。

    | 通道名称      | Topic/Exchange | 类型  | 说明         |
    | ------------- | -------------- | ----- | ------------ |
    | tenant-events | tenant.events  | Topic | 租户领域事件 |

    表 3.4.3.1-1 消息通道配置

+   **消息规范**
    -   所有领域事件统一发布至 `tenant.events` Topic，消费方通过事件类型（`type`字段）过滤订阅
    -   事件消息采用CloudEvents规范封装，包含 `type`、`source`、`id`、`time`、`data` 标准字段
    -   事件发布采用本地事务表（Outbox模式）保证与业务操作的原子性，由后台任务异步投递至消息中间件
    -   消费方必须实现幂等处理，以eventId作为去重键

#### 3.4.3.2 事件公共信封结构

+   所有事件共享以下CloudEvents信封字段，各事件的Payload仅定义 `data` 部分。

    | 信封字段        | 类型     | 说明                                   | 示例值                                 |
    | --------------- | -------- | -------------------------------------- | -------------------------------------- |
    | id              | String   | 事件唯一标识（UUID）                   | "a1b2c3d4-e5f6-7890-abcd-ef0123456789" |
    | type            | String   | 事件类型，对应消息名称                 | "TenantActivated"                      |
    | source          | String   | 事件来源，格式：/{context}/{subdomain} | "/bc-11/tenant-lifecycle"              |
    | time            | DateTime | 事件发生时间（ISO 8601）               | "2026-02-01T10:30:00Z"                 |
    | datacontenttype | String   | data内容类型                           | "application/json"                     |
    | data            | Object   | 事件Payload（各事件不同，见下文）      | { ... }                                |

    表 3.4.3.2-1 事件公共信封结构

#### 3.4.3.3 租户生命周期事件

+   以下事件覆盖租户从申请到注销的完整生命周期。

##### MSG-TNT-01 TenantApplied

+   **消息概述**

    | 属性     | 值                               |
    | -------- | -------------------------------- |
    | 消息编号 | MSG-TNT-01                       |
    | 消息名称 | TenantApplied                    |
    | Topic    | tenant.events                    |
    | 消费方   | BC-10用户管理（审计）、BC-12通知 |
    | 触发时机 | 租户试用申请提交成功后           |

    表 3.4.3.3-1 MSG-TNT-01消息概述

+   **Payload字段说明**

    | 字段名       | 数据类型 | 说明         |
    | ------------ | -------- | ------------ |
    | tenantId     | Long     | 租户ID       |
    | tenantName   | String   | 租户企业名称 |
    | contactName  | String   | 联系人姓名   |
    | contactEmail | String   | 联系人邮箱   |
    | contactPhone | String   | 联系人电话   |
    | industry     | String   | 所属行业     |
    | scale        | String   | 企业规模     |
    | applyToken   | String   | 申请跟踪令牌 |

    表 3.4.3.3-2 MSG-TNT-01 Payload字段

+   **消费方处理契约**

    | 消费方 | 处理逻辑                           | 幂等策略    | 失败处理      |
    | ------ | ---------------------------------- | ----------- | ------------- |
    | BC-10  | 记录租户申请操作审计日志           | eventId去重 | 重试3次后告警 |
    | BC-12  | 发送申请确认通知邮件给contactEmail | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-3 MSG-TNT-01消费方处理

##### MSG-TNT-02 ~ MSG-TNT-03 审批类事件（简表）

+   以下审批类事件结构相似，以简表列出差异。

    | 消息编号   | 消息名称       | 触发时机 | 特有Payload字段                                | 消费方       |
    | ---------- | -------------- | -------- | ---------------------------------------------- | ------------ |
    | MSG-TNT-02 | TenantApproved | 审批通过 | tenantId, tenantCode, approvedBy, approvedAt   | BC-10        |
    | MSG-TNT-03 | TenantRejected | 审批拒绝 | tenantId, rejectReason, rejectedBy, rejectedAt | BC-10, BC-12 |

    表 3.4.3.3-4 审批类事件简表

+   **公共Payload字段**：tenantId, tenantName, contactEmail

+   **MSG-TNT-03消费方处理**

    | 消费方 | 处理逻辑                                       | 幂等策略    | 失败处理      |
    | ------ | ---------------------------------------------- | ----------- | ------------- |
    | BC-10  | 记录审批拒绝操作审计日志                       | eventId去重 | 重试3次后告警 |
    | BC-12  | 发送审批拒绝通知邮件给contactEmail，含拒绝原因 | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-5 MSG-TNT-03消费方处理

##### MSG-TNT-05 TenantActivated

+   **消息概述**

    | 属性     | 值                                  |
    | -------- | ----------------------------------- |
    | 消息编号 | MSG-TNT-05                          |
    | 消息名称 | TenantActivated                     |
    | Topic    | tenant.events                       |
    | 消费方   | BC-10用户管理、BC-10审计、BC-12通知 |
    | 触发时机 | 租户开通全流程完成后（激活成功）    |

    表 3.4.3.3-6 MSG-TNT-05消息概述

+   **Payload字段说明**

    | 字段名      | 数据类型 | 说明                          |
    | ----------- | -------- | ----------------------------- |
    | tenantId    | Long     | 租户ID                        |
    | tenantCode  | String   | 租户代号                      |
    | tenantName  | String   | 租户企业名称                  |
    | tenantType  | String   | 租户类型：TRIAL / OFFICIAL    |
    | adminUserId | Long     | 租户管理员用户ID（BC-10创建） |
    | adminEmail  | String   | 管理员邮箱                    |
    | activatedAt | DateTime | 激活时间                      |

    表 3.4.3.3-7 MSG-TNT-05 Payload字段

+   **消费方处理契约**

    | 消费方 | 处理逻辑                                               | 幂等策略    | 失败处理      |
    | ------ | ------------------------------------------------------ | ----------- | ------------- |
    | BC-10  | 缓存租户状态（tenantId→ACTIVE），用于登录快速校验      | eventId去重 | 重试3次后告警 |
    | BC-10  | 记录租户激活操作审计日志                               | eventId去重 | 重试3次后告警 |
    | BC-12  | 发送开通成功通知邮件，含管理员账号、登录地址和快速指南 | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-8 MSG-TNT-05消费方处理

##### MSG-TNT-08 TenantSuspended

+   **消息概述**

    | 属性     | 值                                  |
    | -------- | ----------------------------------- |
    | 消息编号 | MSG-TNT-08                          |
    | 消息名称 | TenantSuspended                     |
    | Topic    | tenant.events                       |
    | 消费方   | BC-10用户管理、BC-10审计、BC-12通知 |
    | 触发时机 | 管理员暂停租户后                    |

    表 3.4.3.3-9 MSG-TNT-08消息概述

+   **Payload字段说明**

    | 字段名        | 数据类型 | 说明         |
    | ------------- | -------- | ------------ |
    | tenantId      | Long     | 租户ID       |
    | tenantCode    | String   | 租户代号     |
    | tenantName    | String   | 租户企业名称 |
    | suspendReason | String   | 暂停原因     |
    | suspendedBy   | Long     | 操作人ID     |
    | suspendedAt   | DateTime | 暂停时间     |

    表 3.4.3.3-10 MSG-TNT-08 Payload字段

+   **消费方处理契约**

    | 消费方 | 处理逻辑                                                | 幂等策略    | 失败处理      |
    | ------ | ------------------------------------------------------- | ----------- | ------------- |
    | BC-10  | 强制下线该租户所有在线用户（撤销Token、清除Session）    | eventId去重 | 重试3次后告警 |
    | BC-10  | 记录租户暂停安全审计日志                                | eventId去重 | 重试3次后告警 |
    | BC-12  | 发送租户暂停通知邮件+短信给联系人，含暂停原因和恢复方式 | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-11 MSG-TNT-08消费方处理

##### MSG-TNT-13 TenantCodeChanged

+   **消息概述**

    | 属性     | 值                             |
    | -------- | ------------------------------ |
    | 消息编号 | MSG-TNT-13                     |
    | 消息名称 | TenantCodeChanged              |
    | Topic    | tenant.events                  |
    | 消费方   | BC-10用户管理（审计+缓存刷新） |
    | 触发时机 | 租户代号修改成功后             |

+   **Payload字段说明**

    | 字段名    | 数据类型 | 说明                |
    | --------- | -------- | ------------------- |
    | tenantId  | Long     | 租户ID（不变）      |
    | oldCode   | String   | 修改前的tenant_code |
    | newCode   | String   | 修改后的tenant_code |
    | changedBy | Long     | 操作人ID            |
    | changedAt | DateTime | 修改时间            |

+   **消费方处理契约**

    | 消费方 | 处理逻辑                                                                                       | 幂等策略    | 失败处理      |
    | ------ | ---------------------------------------------------------------------------------------------- | ----------- | ------------- |
    | BC-10  | ① 刷新tenant_code→tenant_id缓存映射 ② 记录操作审计日志 ③ 同步更新配置表中的冗余tenant_code字段 | eventId去重 | 重试3次后告警 |

#### 3.4.3.4 状态变更事件（简表）

+   以下事件覆盖租户恢复、转正、到期等状态变更，以简表列出。

    | 消息编号   | 消息名称        | 触发时机   | Payload字段（data部分）                                 | 消费方       |
    | ---------- | --------------- | ---------- | ------------------------------------------------------- | ------------ |
    | MSG-TNT-04 | TenantCreated   | 数据库创建 | tenantId, tenantCode, tenantName, databaseName          | BC-10        |
    | MSG-TNT-06 | TenantConverted | 试用转正   | tenantId, tenantCode, oldType, newType, maxUserCount    | BC-10, BC-12 |
    | MSG-TNT-07 | TenantExpired   | 试用到期   | tenantId, tenantCode, trialExpireAt, dataRetentionEndAt | BC-10, BC-12 |
    | MSG-TNT-09 | TenantResumed   | 租户恢复   | tenantId, tenantCode, resumedBy, resumedAt              | BC-10        |

    表 3.4.3.4-1 状态变更事件汇总

+   **消费方处理契约**（统一）

    | 消费方 | 处理逻辑                                             | 幂等策略    | 失败处理      |
    | ------ | ---------------------------------------------------- | ----------- | ------------- |
    | BC-10  | 更新租户状态缓存（恢复时置为可用，到期时置为不可用） | eventId去重 | 重试3次后告警 |
    | BC-10  | 记录操作审计日志                                     | eventId去重 | 重试3次后告警 |
    | BC-12  | 发送对应通知邮件（转正成功/到期提醒/恢复成功）       | eventId去重 | 重试3次后告警 |

    表 3.4.3.4-2 状态变更事件消费方处理

#### 3.4.3.5 注销流程事件

+   以下事件覆盖租户注销全流程。

    | 消息编号   | 消息名称                  | 触发时机 | Payload字段（data部分）                                     | 消费方       |
    | ---------- | ------------------------- | -------- | ----------------------------------------------------------- | ------------ |
    | MSG-TNT-10 | TenantDeactivating        | 发起注销 | tenantId, tenantCode, reason, gracePeriodEndAt, requestedAt | BC-10, BC-12 |
    | MSG-TNT-11 | TenantDeactivationRevoked | 撤回注销 | tenantId, tenantCode, revokedAt, restoredStatus             | BC-10        |
    | MSG-TNT-12 | TenantDeactivated         | 注销完成 | tenantId, tenantCode, reason, deactivatedAt                 | BC-10        |

    表 3.4.3.5-1 注销流程事件汇总

+   **MSG-TNT-12 TenantDeactivated 消费方处理契约**

    | 消费方 | 处理逻辑                                            | 幂等策略    | 失败处理      |
    | ------ | --------------------------------------------------- | ----------- | ------------- |
    | BC-10  | 清理该租户相关缓存和Token；移除该租户的用户数据缓存 | eventId去重 | 重试3次后告警 |
    | BC-10  | 记录租户注销完成安全审计日志                        | eventId去重 | 重试3次后告警 |

    表 3.4.3.5-2 MSG-TNT-12消费方处理

### 3.4.4 REST 接口

#### 3.4.4.1 UP运营方租户管理接口

+   UP运营方租户管理接口用于平台管理员管理租户生命周期，需要管理员权限。

##### 3.4.4.1.1 接口清单

+   接口清单如下表：

    | API编号  | API名称        | 方法 | 路径                                                   | 权限                              | 领域方法                           | 备注           |
    | -------- | -------------- | ---- | ------------------------------------------------------ | --------------------------------- | ---------------------------------- | -------------- |
    | P-TNT-01 | 查询租户列表   | GET  | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:list       | TenantQueryService.getList()       | 支持分页       |
    | P-TNT-02 | 查询租户详情   | GET  | /api/v1/provider/tenant/tenants/{id}                   | provider:tenant:tenant:read       | TenantQueryService.getDetail()     | -              |
    | P-TNT-03 | 租户统计概况   | GET  | /api/v1/provider/tenant/tenants/statistics             | provider:tenant:tenant:list       | TenantQueryService.getStatistics() | 各状态数量     |
    | P-TNT-04 | 审批通过       | POST | /api/v1/provider/tenant/tenants/{id}/approve           | provider:tenant:tenant:approve    | Tenant.approve()                   | 触发开通流程   |
    | P-TNT-05 | 审批拒绝       | POST | /api/v1/provider/tenant/tenants/{id}/reject            | provider:tenant:tenant:approve    | Tenant.reject()                    | 需填写原因     |
    | P-TNT-06 | 暂停租户       | POST | /api/v1/provider/tenant/tenants/{id}/suspend           | provider:tenant:tenant:suspend    | Tenant.suspend()                   | 需填写原因     |
    | P-TNT-07 | 恢复租户       | POST | /api/v1/provider/tenant/tenants/{id}/resume            | provider:tenant:tenant:suspend    | Tenant.resume()                    | -              |
    | P-TNT-08 | 试用转正       | POST | /api/v1/provider/tenant/tenants/{id}/convert           | provider:tenant:tenant:update     | Tenant.convertToOfficial()         | 变更类型和规格 |
    | P-TNT-09 | 发起注销       | POST | /api/v1/provider/tenant/tenants/{id}/deactivate        | provider:tenant:tenant:deactivate | Tenant.deactivate()                | 7天宽限期      |
    | P-TNT-10 | 撤回注销       | POST | /api/v1/provider/tenant/tenants/{id}/deactivate/revoke | provider:tenant:tenant:deactivate | Tenant.revokeDeactivation()        | 宽限期内可撤   |
    | P-TNT-11 | 更新联系人信息 | PUT  | /api/v1/provider/tenant/tenants/{id}/contact           | provider:tenant:tenant:update     | Tenant.updateContactInfo()         | -              |
    | P-TNT-12 | 直接创建租户   | POST | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:create     | Tenant.create()                    | P1核心入口     |

    表 3.4.4.1.1-1 UP运营方租户管理REST API清单表

##### 3.4.4.1.2 P-TNT-01 查询租户列表

+   **契约概述表**

    | 属性       | 值                                  |
    | ---------- | ----------------------------------- |
    | API编号    | P-TNT-01                            |
    | 接口路径   | GET /api/v1/provider/tenant/tenants |
    | 功能简述   | 分页查询租户列表，支持多条件筛选    |
    | 所需权限   | provider:tenant:tenant:list         |
    | 关联功能   | F-TNT-01 租户列表查看               |
    | 关联用例   | UC-TNT-01 管理员查看租户列表        |
    | 关联领域   | TenantQueryService.getList()        |
    | 关联规则   | 无                                  |
    | 幂等性     | 是                                  |
    | 关联错误码 | E-400001, E-401001                  |

    表 3.4.4.1.2-1 P-TNT-01契约概述表

+   **请求契约表**

    | 参数名     | 位置  | 类型    | 必填 | 约束                                                                                                 | 示例值     | 业务含义 |
    | ---------- | ----- | ------- | ---- | ---------------------------------------------------------------------------------------------------- | ---------- | -------- |
    | tenantName | query | String  | 否   | 模糊匹配                                                                                             | "中信"     | 企业名称 |
    | tenantCode | query | String  | 否   | 精确匹配                                                                                             | "citic"    | 租户代号 |
    | status     | query | String  | 否   | 枚举：PENDING/CREATING/INITIALIZING/TRIAL/ACTIVE/SUSPENDED/EXPIRED/DEACTIVATING/DEACTIVATED/REJECTED | "ACTIVE"   | 租户状态 |
    | tenantType | query | String  | 否   | 枚举：TRIAL/OFFICIAL                                                                                 | "OFFICIAL" | 租户类型 |
    | industry   | query | String  | 否   | 模糊匹配                                                                                             | "金融"     | 所属行业 |
    | page       | query | Integer | 否   | ≥1，默认1                                                                                            | 1          | 页码     |
    | size       | query | Integer | 否   | 1-100，默认20                                                                                        | 20         | 每页大小 |

    表 3.4.4.1.2-2 P-TNT-01请求契约表

+   **响应契约表**

    | 参数名                  | 类型   | 必有 | 示例值                | 业务含义 |
    | ----------------------- | ------ | ---- | --------------------- | -------- |
    | code                    | Number | 是   | 200                   | 响应码   |
    | message                 | String | 是   | "success"             | 响应消息 |
    | data.list[]             | Array  | 是   | [...]                 | 租户列表 |
    | data.list[].id          | Number | 是   | 1001                  | 租户ID   |
    | data.list[].tenantCode  | String | 是   | "citic"               | 租户代号 |
    | data.list[].tenantName  | String | 是   | "中信银行"            | 企业名称 |
    | data.list[].tenantType  | String | 是   | "OFFICIAL"            | 租户类型 |
    | data.list[].status      | String | 是   | "ACTIVE"              | 租户状态 |
    | data.list[].industry    | String | 否   | "金融"                | 所属行业 |
    | data.list[].contactName | String | 是   | "张三"                | 联系人   |
    | data.list[].activatedAt | String | 否   | "2026-01-15T10:00:00" | 激活时间 |
    | data.list[].createdAt   | String | 是   | "2026-01-10T09:00:00" | 申请时间 |
    | data.total              | Number | 是   | 50                    | 总记录数 |
    | data.page               | Number | 是   | 1                     | 当前页码 |
    | data.size               | Number | 是   | 20                    | 每页大小 |
    | data.pages              | Number | 是   | 3                     | 总页数   |

    表 3.4.4.1.2-3 P-TNT-01响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 1001,
                "tenantCode": "citic",
                "tenantName": "中信银行",
                "tenantType": "OFFICIAL",
                "status": "ACTIVE",
                "industry": "金融",
                "contactName": "张三",
                "activatedAt": "2026-01-15T10:00:00",
                "createdAt": "2026-01-10T09:00:00"
              }
            ],
            "total": 50,
            "page": 1,
            "size": 20,
            "pages": 3
          },
          "timestamp": 1738368000000
        }
        ```

##### 3.4.4.1.3 P-TNT-02 查询租户详情

+   **契约概述表**

    | 属性       | 值                                         |
    | ---------- | ------------------------------------------ |
    | API编号    | P-TNT-02                                   |
    | 接口路径   | GET /api/v1/provider/tenant/tenants/{id}   |
    | 功能简述   | 根据ID查询租户完整详情，含生命周期全部信息 |
    | 所需权限   | provider:tenant:tenant:read                |
    | 关联功能   | F-TNT-02 租户详情查看                      |
    | 关联用例   | UC-TNT-02 管理员查看租户详情               |
    | 关联领域   | TenantQueryService.getDetail()             |
    | 关联规则   | 无                                         |
    | 幂等性     | 是                                         |
    | 关联错误码 | E-400001, E-401001, E-404001               |

    表 3.4.4.1.3-1 P-TNT-02契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 租户ID   |

    表 3.4.4.1.3-2 P-TNT-02请求契约表

+   **响应契约表**

    | 参数名                        | 类型   | 必有 | 示例值                | 业务含义     |
    | ----------------------------- | ------ | ---- | --------------------- | ------------ |
    | code                          | Number | 是   | 200                   | 响应码       |
    | message                       | String | 是   | "success"             | 响应消息     |
    | data.id                       | Number | 是   | 1001                  | 租户ID       |
    | data.tenantCode               | String | 是   | "citic"               | 租户代号     |
    | data.tenantName               | String | 是   | "中信银行"            | 企业名称     |
    | data.tenantType               | String | 是   | "OFFICIAL"            | 租户类型     |
    | data.status                   | String | 是   | "ACTIVE"              | 租户状态     |
    | data.industry                 | String | 否   | "金融"                | 所属行业     |
    | data.scale                    | String | 否   | "1001-5000"           | 企业规模     |
    | data.maxUserCount             | Number | 是   | 200                   | 最大用户数   |
    | data.contactInfo.contactName  | String | 是   | "张三"                | 联系人姓名   |
    | data.contactInfo.contactEmail | String | 是   | "zhangsan@citic.com"  | 联系人邮箱   |
    | data.contactInfo.contactPhone | String | 否   | "13800138000"         | 联系人电话   |
    | data.dataSource.databaseName  | String | 否   | "clarisphere_t1001"   | 数据库名     |
    | data.dataSource.poolStatus    | String | 否   | "ACTIVE"              | 连接池状态   |
    | data.trialInfo                | Object | 否   | null                  | 试用信息     |
    | data.trialInfo.trialDays      | Number | 否   | 30                    | 试用天数     |
    | data.trialInfo.trialExpireAt  | String | 否   | "2026-02-15T23:59:59" | 试用到期时间 |
    | data.deactivationInfo         | Object | 否   | null                  | 注销信息     |
    | data.approvedBy               | Number | 否   | 100                   | 审批人ID     |
    | data.approvedAt               | String | 否   | "2026-01-12T14:00:00" | 审批时间     |
    | data.activatedAt              | String | 否   | "2026-01-15T10:00:00" | 激活时间     |
    | data.suspendedReason          | String | 否   | null                  | 暂停原因     |
    | data.createdAt                | String | 是   | "2026-01-10T09:00:00" | 申请时间     |
    | data.updatedAt                | String | 是   | "2026-01-15T10:00:00" | 更新时间     |

    表 3.4.4.1.3-3 P-TNT-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "tenantCode": "citic",
            "tenantName": "中信银行",
            "tenantType": "OFFICIAL",
            "status": "ACTIVE",
            "industry": "金融",
            "scale": "1001-5000",
            "maxUserCount": 200,
            "contactInfo": {
              "contactName": "张三",
              "contactEmail": "zhangsan@citic.com",
              "contactPhone": "13800138000"
            },
            "dataSource": {
              "databaseName": "clarisphere_t1001",
              "poolStatus": "ACTIVE"
            },
            "trialInfo": null,
            "deactivationInfo": null,
            "approvedBy": 100,
            "approvedAt": "2026-01-12T14:00:00",
            "activatedAt": "2026-01-15T10:00:00",
            "suspendedReason": null,
            "createdAt": "2026-01-10T09:00:00",
            "updatedAt": "2026-01-15T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

##### 3.4.4.1.4 P-TNT-03 租户统计概况

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | P-TNT-03                                       |
    | 接口路径   | GET /api/v1/provider/tenant/tenants/statistics |
    | 功能简述   | 获取各状态租户数量统计，用于仪表盘展示         |
    | 所需权限   | provider:tenant:tenant:list                    |
    | 关联领域   | TenantQueryService.getStatistics()             |
    | 幂等性     | 是                                             |
    | 关联错误码 | E-401001                                       |

    表 3.4.4.1.4-1 P-TNT-03契约概述表

+   **响应契约表**

    | 参数名                | 类型   | 必有 | 示例值 | 业务含义 |
    | --------------------- | ------ | ---- | ------ | -------- |
    | code                  | Number | 是   | 200    | 响应码   |
    | data.total            | Number | 是   | 120    | 租户总数 |
    | data.pendingCount     | Number | 是   | 5      | 待审批数 |
    | data.activeCount      | Number | 是   | 80     | 已激活数 |
    | data.trialCount       | Number | 是   | 15     | 试用中数 |
    | data.suspendedCount   | Number | 是   | 3      | 已暂停数 |
    | data.expiredCount     | Number | 是   | 7      | 已过期数 |
    | data.deactivatedCount | Number | 是   | 10     | 已注销数 |

    表 3.4.4.1.4-2 P-TNT-03响应契约表

##### 3.4.4.1.5 P-TNT-04 审批通过

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | P-TNT-04                                                 |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/approve        |
    | 功能简述   | 审批通过租户申请，状态PENDING→CREATING，异步触发开通流程 |
    | 所需权限   | provider:tenant:tenant:approve                           |
    | 关联功能   | F-TNT-04 租户审批                                        |
    | 关联用例   | UC-TNT-04 管理员审批租户申请                             |
    | 关联领域   | Tenant.approve()                                         |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-05（审批前提）             |
    | 幂等性     | 是（已审批返回成功）                                     |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001         |

    表 3.4.4.1.5-1 P-TNT-04契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束     | 示例值     | 业务含义                           |
    | ---------- | ---- | ------ | ---- | -------- | ---------- | ---------------------------------- |
    | id         | path | Long   | 是   | BIGINT   | 1001       | 租户ID                             |
    | tenantCode | body | String | 否   | 4-20位   | "citic"    | 指定租户代号（不填则系统自动生成） |
    | remark     | body | String | 否   | 长度≤256 | "审核通过" | 审批备注                           |

    表 3.4.4.1.5-2 P-TNT-04请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------- | ------ | ---- | --------------------- | -------- |
    | code            | Number | 是   | 200                   | 响应码   |
    | message         | String | 是   | "审批通过"            | 响应消息 |
    | data.id         | Number | 是   | 1001                  | 租户ID   |
    | data.tenantCode | String | 是   | "citic"               | 租户代号 |
    | data.status     | String | 是   | "CREATING"            | 状态     |
    | data.approvedAt | String | 是   | "2026-02-01T10:00:00" | 审批时间 |

    表 3.4.4.1.5-3 P-TNT-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "citic",
          "remark": "企业资质审核通过"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "审批通过，正在开通中",
          "data": {
            "id": 1001,
            "tenantCode": "citic",
            "status": "CREATING",
            "approvedAt": "2026-02-01T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

+   **备注**
    -   审批通过后异步触发开通流程（FL-TL-03），前端可通过轮询P-TNT-02接口观察状态变化
    -   tenantCode不填时系统根据企业名称拼音自动生成，如"中信银行"→"zhongxinyinhang"截取前20位

##### 3.4.4.1.6 P-TNT-05 审批拒绝

+   **契约概述表**

    | 属性       | 值                                                   |
    | ---------- | ---------------------------------------------------- |
    | API编号    | P-TNT-05                                             |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/reject     |
    | 功能简述   | 审批拒绝租户申请，状态PENDING→REJECTED，发送拒绝通知 |
    | 所需权限   | provider:tenant:tenant:approve                       |
    | 关联领域   | Tenant.reject()                                      |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-05（审批前提）         |
    | 幂等性     | 是（已拒绝返回成功）                                 |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001     |

    表 3.4.4.1.6-1 P-TNT-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值               | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | -------------------- | -------- |
    | id     | path | Long   | 是   | BIGINT   | 1001                 | 租户ID   |
    | reason | body | String | 是   | 长度≤512 | "企业资质材料不完整" | 拒绝原因 |

    表 3.4.4.1.6-2 P-TNT-05请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值               | 业务含义 |
    | ----------------- | ------ | ---- | -------------------- | -------- |
    | code              | Number | 是   | 200                  | 响应码   |
    | message           | String | 是   | "审批拒绝"           | 响应消息 |
    | data.id           | Number | 是   | 1001                 | 租户ID   |
    | data.status       | String | 是   | "REJECTED"           | 状态     |
    | data.rejectReason | String | 是   | "企业资质材料不完整" | 拒绝原因 |

    表 3.4.4.1.6-3 P-TNT-05响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reason": "企业资质材料不完整，请补充营业执照副本"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "审批拒绝",
          "data": {
            "id": 1001,
            "status": "REJECTED",
            "rejectReason": "企业资质材料不完整，请补充营业执照副本"
          },
          "timestamp": 1738368000000
        }
        ```

##### 3.4.4.1.7 P-TNT-06 暂停租户

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | P-TNT-06                                                 |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/suspend        |
    | 功能简述   | 暂停租户，需填写暂停原因，暂停后该租户所有用户被强制下线 |
    | 所需权限   | provider:tenant:tenant:suspend                           |
    | 关联领域   | Tenant.suspend()                                         |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-06（暂停前提）             |
    | 幂等性     | 是（已暂停返回成功）                                     |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001         |

    表 3.4.4.1.7-1 P-TNT-06契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值       | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | ------------ | -------- |
    | id     | path | Long   | 是   | BIGINT   | 1001         | 租户ID   |
    | reason | body | String | 是   | 长度≤512 | "欠费超30天" | 暂停原因 |

    表 3.4.4.1.7-2 P-TNT-06请求契约表

+   **响应契约表**

    | 参数名           | 类型   | 必有 | 示例值                | 业务含义 |
    | ---------------- | ------ | ---- | --------------------- | -------- |
    | code             | Number | 是   | 200                   | 响应码   |
    | message          | String | 是   | "暂停成功"            | 响应消息 |
    | data.id          | Number | 是   | 1001                  | 租户ID   |
    | data.status      | String | 是   | "SUSPENDED"           | 状态     |
    | data.reason      | String | 是   | "欠费超30天"          | 暂停原因 |
    | data.suspendedAt | String | 是   | "2026-02-01T10:00:00" | 暂停时间 |

    表 3.4.4.1.7-3 P-TNT-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reason": "欠费超30天，暂停服务"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "暂停成功",
          "data": {
            "id": 1001,
            "status": "SUSPENDED",
            "reason": "欠费超30天，暂停服务",
            "suspendedAt": "2026-02-01T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

+   **备注**
    -   暂停后发布TenantSuspended事件，BC-10收到后强制下线该租户所有在线用户
    -   暂停原因会记录在审计日志中

##### 3.4.4.1.8 P-TNT-07 恢复租户

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | P-TNT-07                                         |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/resume |
    | 功能简述   | 恢复已暂停的租户                                 |
    | 所需权限   | provider:tenant:tenant:suspend                   |
    | 关联领域   | Tenant.resume()                                  |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-07（恢复前提）     |
    | 幂等性     | 是（已恢复返回成功）                             |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001 |

    表 3.4.4.1.8-1 P-TNT-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值       | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | ------------ | -------- |
    | id     | path | Long   | 是   | BIGINT   | 1001         | 租户ID   |
    | remark | body | String | 否   | 长度≤256 | "欠费已补缴" | 恢复备注 |

    表 3.4.4.1.8-2 P-TNT-07请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "恢复成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 租户ID   |
    | data.status    | String | 是   | "ACTIVE"              | 状态     |
    | data.resumedAt | String | 是   | "2026-02-01T10:00:00" | 恢复时间 |

    表 3.4.4.1.8-3 P-TNT-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "恢复成功",
          "data": {
            "id": 1001,
            "status": "ACTIVE",
            "resumedAt": "2026-02-01T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

    +   错误响应Mock（前提未满足）

        ```json
        {
          "code": 422001,
          "message": "恢复前提未满足：欠费暂停的租户需先补缴费用",
          "data": {
            "currentStatus": "SUSPENDED",
            "suspendReason": "欠费超30天"
          },
          "timestamp": 1738368000000
        }
        ```

##### 3.4.4.1.9 P-TNT-08 试用转正

+   **契约概述表**

    | 属性       | 值                                                |
    | ---------- | ------------------------------------------------- |
    | API编号    | P-TNT-08                                          |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/convert |
    | 功能简述   | 将试用租户转为正式租户，变更类型和用户上限        |
    | 所需权限   | provider:tenant:tenant:update                     |
    | 关联领域   | Tenant.convertToOfficial()                        |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-11（转正前提）      |
    | 幂等性     | 是（已转正返回成功）                              |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001  |

    表 3.4.4.1.9-1 P-TNT-08契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型    | 必填 | 约束    | 示例值 | 业务含义             |
    | ------------ | ---- | ------- | ---- | ------- | ------ | -------------------- |
    | id           | path | Long    | 是   | BIGINT  | 1001   | 租户ID               |
    | maxUserCount | body | Integer | 否   | 5-10000 | 100    | 新用户上限（默认50） |

    表 3.4.4.1.9-2 P-TNT-08请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值     | 业务含义   |
    | ----------------- | ------ | ---- | ---------- | ---------- |
    | code              | Number | 是   | 200        | 响应码     |
    | message           | String | 是   | "转正成功" | 响应消息   |
    | data.id           | Number | 是   | 1001       | 租户ID     |
    | data.tenantType   | String | 是   | "OFFICIAL" | 新租户类型 |
    | data.status       | String | 是   | "ACTIVE"   | 状态       |
    | data.maxUserCount | Number | 是   | 100        | 新用户上限 |

    表 3.4.4.1.9-3 P-TNT-08响应契约表

##### 3.4.4.1.10 P-TNT-09 发起注销

+   **契约概述表**

    | 属性       | 值                                                   |
    | ---------- | ---------------------------------------------------- |
    | API编号    | P-TNT-09                                             |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/deactivate |
    | 功能简述   | 发起租户注销，进入7天宽限期，宽限期内可撤回          |
    | 所需权限   | provider:tenant:tenant:deactivate                    |
    | 关联领域   | Tenant.deactivate()                                  |
    | 关联规则   | TN-R-04（状态流转约束）, TN-R-08（注销前提）         |
    | 幂等性     | 否（重复调用会刷新宽限期）                           |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404001, E-422001     |

    表 3.4.4.1.10-1 P-TNT-09契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束                                           | 示例值         | 业务含义 |
    | ------------ | ---- | ------ | ---- | ---------------------------------------------- | -------------- | -------- |
    | id           | path | Long   | 是   | BIGINT                                         | 1001           | 租户ID   |
    | reason       | body | String | 是   | 枚举：VOLUNTARY/OVERDUE/VIOLATION/CONTRACT_END | "VOLUNTARY"    | 注销原因 |
    | reasonDetail | body | String | 否   | 长度≤512                                       | "企业主动退出" | 原因详情 |

    表 3.4.4.1.10-2 P-TNT-09请求契约表

+   **响应契约表**

    | 参数名                | 类型   | 必有 | 示例值                | 业务含义       |
    | --------------------- | ------ | ---- | --------------------- | -------------- |
    | code                  | Number | 是   | 200                   | 响应码         |
    | message               | String | 是   | "注销申请已提交"      | 响应消息       |
    | data.id               | Number | 是   | 1001                  | 租户ID         |
    | data.status           | String | 是   | "DEACTIVATING"        | 状态           |
    | data.gracePeriodEndAt | String | 是   | "2026-02-08T10:00:00" | 宽限期截止时间 |

    表 3.4.4.1.10-3 P-TNT-09响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reason": "VOLUNTARY",
          "reasonDetail": "企业决定退出平台，感谢服务"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注销申请已提交，7天宽限期内可撤回",
          "data": {
            "id": 1001,
            "status": "DEACTIVATING",
            "gracePeriodEndAt": "2026-02-08T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

##### 3.4.4.1.11 P-TNT-10 撤回注销

+   **契约概述表**

    | 属性       | 值                                                          |
    | ---------- | ----------------------------------------------------------- |
    | API编号    | P-TNT-10                                                    |
    | 接口路径   | POST /api/v1/provider/tenant/tenants/{id}/deactivate/revoke |
    | 功能简述   | 在宽限期内撤回注销申请，恢复到注销前状态                    |
    | 所需权限   | provider:tenant:tenant:deactivate                           |
    | 关联领域   | Tenant.revokeDeactivation()                                 |
    | 关联规则   | TN-R-12（宽限期可撤回）                                     |
    | 幂等性     | 是（已撤回返回成功）                                        |
    | 关联错误码 | E-400001, E-401001, E-404001, E-422001, E-422002            |

    表 3.4.4.1.11-1 P-TNT-10契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 租户ID   |

    表 3.4.4.1.11-2 P-TNT-10请求契约表

+   **响应契约表**

    | 参数名      | 类型   | 必有 | 示例值     | 业务含义     |
    | ----------- | ------ | ---- | ---------- | ------------ |
    | code        | Number | 是   | 200        | 响应码       |
    | message     | String | 是   | "撤回成功" | 响应消息     |
    | data.id     | Number | 是   | 1001       | 租户ID       |
    | data.status | String | 是   | "ACTIVE"   | 恢复后的状态 |

    表 3.4.4.1.11-3 P-TNT-10响应契约表

+   **备注**
    -   仅DEACTIVATING状态且在宽限期内（gracePeriodEndAt > 当前时间）可撤回
    -   撤回后恢复到注销前的状态（由DeactivationInfo.previousStatus决定）
    -   宽限期已过则返回E-422002错误

##### 3.4.4.1.12 P-TNT-11 更新联系人信息

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | P-TNT-11                                         |
    | 接口路径   | PUT /api/v1/provider/tenant/tenants/{id}/contact |
    | 功能简述   | 更新租户联系人信息                               |
    | 所需权限   | provider:tenant:tenant:update                    |
    | 关联领域   | Tenant.updateContactInfo()                       |
    | 关联规则   | CI-R-01（邮箱格式）, CI-R-02（手机格式）         |
    | 幂等性     | 是                                               |
    | 关联错误码 | E-400001, E-400002, E-401001, E-404001           |

    表 3.4.4.1.12-1 P-TNT-11契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束       | 示例值           | 业务含义   |
    | ------------ | ---- | ------ | ---- | ---------- | ---------------- | ---------- |
    | id           | path | Long   | 是   | BIGINT     | 1001             | 租户ID     |
    | contactName  | body | String | 是   | 2-32字符   | "李四"           | 联系人姓名 |
    | contactEmail | body | String | 是   | 邮箱格式   | "lisi@citic.com" | 联系人邮箱 |
    | contactPhone | body | String | 否   | 11位手机号 | "13900139000"    | 联系人电话 |

    表 3.4.4.1.12-2 P-TNT-11请求契约表

+   **响应契约表**

    | 参数名                        | 类型   | 必有 | 示例值           | 业务含义   |
    | ----------------------------- | ------ | ---- | ---------------- | ---------- |
    | code                          | Number | 是   | 200              | 响应码     |
    | message                       | String | 是   | "更新成功"       | 响应消息   |
    | data.contactInfo.contactName  | String | 是   | "李四"           | 联系人姓名 |
    | data.contactInfo.contactEmail | String | 是   | "lisi@citic.com" | 联系人邮箱 |

    表 3.4.4.1.12-3 P-TNT-11响应契约表

##### 3.4.4.1.13 P-TNT-12 直接创建租户

+   **契约概述表**

    | 属性       | 值                                                                            |
    | ---------- | ----------------------------------------------------------------------------- |
    | API编号    | P-TNT-12                                                                      |
    | 接口路径   | POST /api/v1/provider/tenant/tenants                                          |
    | 功能简述   | 平台管理员直接创建租户，系统自动执行开通流程（创建数据库→IAM初始化→激活）     |
    | 所需权限   | provider:tenant:tenant:create                                                 |
    | 关联功能   | F-TNT-12 直接创建租户                                                         |
    | 关联用例   | UC-TNT-12 平台管理员直接创建租户                                              |
    | 关联领域   | Tenant.create(), TenantProvisioningService.provisionTenant()                  |
    | 关联规则   | TN-R-01（代号唯一）, TN-R-02（代号格式）, TN-R-03（企业名称唯一）, CI-R-01~03 |
    | 幂等性     | 否（每次创建新租户）                                                          |
    | 关联错误码 | E-400001, E-400002, E-401001, E-403001, E-409001                              |

    表 3.4.4.1.13-1 P-TNT-12契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型    | 必填 | 约束                                             | 示例值                 | 业务含义                         |
    | ------------ | ---- | ------- | ---- | ------------------------------------------------ | ---------------------- | -------------------------------- |
    | tenantCode   | body | String  | 否   | 4-20位，小写字母和数字，不能以数字开头，全局唯一 | "citic"                | 租户代号（不填则系统自动生成）   |
    | tenantName   | body | String  | 是   | 2-128字符，非终态租户内唯一                      | "中信银行股份有限公司" | 企业名称                         |
    | contactName  | body | String  | 是   | 2-32字符                                         | "张三"                 | 联系人姓名                       |
    | contactEmail | body | String  | 是   | 邮箱格式                                         | "zhangsan@citic.com"   | 联系人邮箱（开通成功后发送通知） |
    | contactPhone | body | String  | 否   | 11位手机号                                       | "13800138000"          | 联系人电话                       |
    | industry     | body | String  | 否   | 长度≤64                                          | "金融"                 | 所属行业                         |
    | scale        | body | String  | 否   | 枚举：1-50/51-200/201-1000/1001-5000/5000+       | "1001-5000"            | 企业规模                         |
    | maxUserCount | body | Integer | 否   | ≥1，不填则无限制                                 | 200                    | 最大用户数                       |
    | adminEmail   | body | String  | 否   | 邮箱格式，不填则使用contactEmail                 | "admin@citic.com"      | 租户管理员邮箱                   |
    | adminName    | body | String  | 否   | 2-32字符，不填则使用contactName                  | "张三"                 | 租户管理员姓名                   |

    表 3.4.4.1.13-2 P-TNT-12请求契约表

+   **响应契约表**

    | 参数名                        | 类型   | 必有 | 示例值                 | 业务含义                           |
    | ----------------------------- | ------ | ---- | ---------------------- | ---------------------------------- |
    | code                          | Number | 是   | 200                    | 响应码                             |
    | message                       | String | 是   | "创建成功，正在开通中" | 响应消息                           |
    | data.id                       | Number | 是   | 1001                   | 租户ID                             |
    | data.tenantCode               | String | 是   | "citic"                | 租户代号                           |
    | data.tenantName               | String | 是   | "中信银行股份有限公司" | 企业名称                           |
    | data.status                   | String | 是   | "CREATING"             | 当前状态（创建后立即进入CREATING） |
    | data.contactInfo.contactName  | String | 是   | "张三"                 | 联系人姓名                         |
    | data.contactInfo.contactEmail | String | 是   | "zhangsan@citic.com"   | 联系人邮箱                         |
    | data.createdAt                | String | 是   | "2026-02-01T10:00:00"  | 创建时间                           |

    表 3.4.4.1.13-3 P-TNT-12响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "citic",
          "tenantName": "中信银行股份有限公司",
          "contactName": "张三",
          "contactEmail": "zhangsan@citic.com",
          "contactPhone": "13800138000",
          "industry": "金融",
          "scale": "1001-5000",
          "maxUserCount": 200,
          "adminEmail": "admin@citic.com",
          "adminName": "张三"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功，正在开通中",
          "data": {
            "id": 1001,
            "tenantCode": "citic",
            "tenantName": "中信银行股份有限公司",
            "status": "CREATING",
            "contactInfo": {
              "contactName": "张三",
              "contactEmail": "zhangsan@citic.com"
            },
            "createdAt": "2026-02-01T10:00:00"
          },
          "timestamp": 1738368000000
        }
        ```

    +   租户代号重复错误响应Mock

        ```json
        {
          "code": 409001,
          "message": "租户代号已存在",
          "data": {
            "field": "tenantCode",
            "value": "citic"
          },
          "timestamp": 1738368000000
        }
        ```

+   **备注**
    -   P-TNT-12是P1阶段租户创建的唯一入口，跳过试用申请和审批流程
    -   创建成功后系统异步执行开通流程（FL-TL-03），前端可通过轮询P-TNT-02接口观察状态变化
    -   tenantCode不填时系统根据企业名称拼音自动生成，如"中信银行"→"zhongxinyinhang"截取前20位
    -   开通完成后发送TenantActivated事件，BC-12订阅该事件向contactEmail发送开通成功通知
    -   adminEmail/adminName用于创建租户管理员账号，不填则使用联系人信息

#### 3.4.4.2 公共接口

+   公共接口无需登录认证，用于试用申请等匿名场景。

##### 3.4.4.2.1 接口清单

+   接口清单如下表：

    | API编号    | API名称          | 方法 | 路径                                            | 权限 | 领域方法                            | 备注           |
    | ---------- | ---------------- | ---- | ----------------------------------------------- | ---- | ----------------------------------- | -------------- |
    | PUB-TNT-01 | 提交试用申请     | POST | /api/v1/public/tenant/trial/apply               | 无   | Tenant.apply()                      | 匿名申请       |
    | PUB-TNT-02 | 查询试用申请状态 | GET  | /api/v1/public/tenant/trial/{applyToken}/status | 无   | TenantQueryService.getApplyStatus() | 凭申请令牌查询 |

    表 3.4.4.2.1-1 公共接口清单表

##### 3.4.4.2.2 PUB-TNT-01 提交试用申请

+   **契约概述表**

    | 属性       | 值                                                                            |
    | ---------- | ----------------------------------------------------------------------------- |
    | API编号    | PUB-TNT-01                                                                    |
    | 接口路径   | POST /api/v1/public/tenant/trial/apply                                        |
    | 功能简述   | 企业用户提交试用申请，创建PENDING状态的租户记录，返回申请跟踪令牌             |
    | 所需权限   | 无（公共接口）                                                                |
    | 关联领域   | Tenant.apply()                                                                |
    | 关联规则   | TN-R-01（代号唯一）, TN-R-03（企业名称唯一）, TN-R-10（试用规格）, CI-R-01~03 |
    | 幂等性     | 否（每次提交创建新记录）                                                      |
    | 关联错误码 | E-400001, E-400002, E-409001, E-429001                                        |

    表 3.4.4.2.2-1 PUB-TNT-01契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束                                       | 示例值             | 业务含义   |
    | ------------ | ---- | ------ | ---- | ------------------------------------------ | ------------------ | ---------- |
    | tenantName   | body | String | 是   | 2-128字符，非终态租户内唯一                | "演示科技有限公司" | 企业名称   |
    | contactName  | body | String | 是   | 2-32字符                                   | "王五"             | 联系人姓名 |
    | contactEmail | body | String | 是   | 邮箱格式                                   | "wangwu@demo.com"  | 联系人邮箱 |
    | contactPhone | body | String | 否   | 11位手机号                                 | "13700137000"      | 联系人电话 |
    | industry     | body | String | 否   | 长度≤64                                    | "互联网"           | 所属行业   |
    | scale        | body | String | 否   | 枚举：1-50/51-200/201-1000/1001-5000/5000+ | "51-200"           | 企业规模   |
    | captchaCode  | body | String | 是   | 6位数字                                    | "836291"           | 邮箱验证码 |

    表 3.4.4.2.2-2 PUB-TNT-01请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                | 业务含义     |
    | --------------- | ------ | ---- | --------------------- | ------------ |
    | code            | Number | 是   | 200                   | 响应码       |
    | message         | String | 是   | "申请已提交"          | 响应消息     |
    | data.tenantId   | Number | 是   | 1002                  | 租户ID       |
    | data.applyToken | String | 是   | "atk_abc123def456..." | 申请跟踪令牌 |
    | data.status     | String | 是   | "PENDING"             | 申请状态     |

    表 3.4.4.2.2-3 PUB-TNT-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantName": "演示科技有限公司",
          "contactName": "王五",
          "contactEmail": "wangwu@demo.com",
          "contactPhone": "13700137000",
          "industry": "互联网",
          "scale": "51-200",
          "captchaCode": "836291"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "试用申请已提交，我们将在1-2个工作日内完成审核",
          "data": {
            "tenantId": 1002,
            "applyToken": "atk_abc123def456ghi789jkl012mno345",
            "status": "PENDING"
          },
          "timestamp": 1738368000000
        }
        ```

+   **备注**
    -   公共接口需防刷：同一邮箱每天最多提交3次，同一IP每天最多提交10次（E-429001）
    -   captchaCode通过BC-10共享服务CaptchaService预先发送至contactEmail
    -   applyToken用于在PUB-TNT-02接口中查询申请状态，有效期7天

##### 3.4.4.2.3 PUB-TNT-02 查询试用申请状态

+   **契约概述表**

    | 属性       | 值                                                  |
    | ---------- | --------------------------------------------------- |
    | API编号    | PUB-TNT-02                                          |
    | 接口路径   | GET /api/v1/public/tenant/trial/{applyToken}/status |
    | 功能简述   | 凭申请令牌查询试用申请当前状态                      |
    | 所需权限   | 无（公共接口，凭令牌访问）                          |
    | 关联领域   | TenantQueryService.getApplyStatus()                 |
    | 幂等性     | 是                                                  |
    | 关联错误码 | E-400001, E-404001                                  |

    表 3.4.4.2.3-1 PUB-TNT-02契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束   | 示例值                               | 业务含义     |
    | ---------- | ---- | ------ | ---- | ------ | ------------------------------------ | ------------ |
    | applyToken | path | String | 是   | 长度32 | "atk_abc123def456ghi789jkl012mno345" | 申请跟踪令牌 |

    表 3.4.4.2.3-2 PUB-TNT-02请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义               |
    | ----------------- | ------ | ---- | --------------------- | ---------------------- |
    | code              | Number | 是   | 200                   | 响应码                 |
    | data.status       | String | 是   | "PENDING"             | 申请状态               |
    | data.tenantName   | String | 是   | "演示科技有限公司"    | 企业名称               |
    | data.appliedAt    | String | 是   | "2026-02-01T09:00:00" | 申请时间               |
    | data.rejectReason | String | 否   | null                  | 拒绝原因               |
    | data.loginUrl     | String | 否   | null                  | 登录地址（激活后有值） |

    表 3.4.4.2.3-3 PUB-TNT-02响应契约表

+   **备注**
    -   申请令牌有效期7天，过期后返回E-404001
    -   当status变为ACTIVE或TRIAL时，loginUrl字段返回租户登录地址
    -   当status为REJECTED时，rejectReason字段返回拒绝原因

## 3.5 数据模型设计

+   本节设计租户生命周期子领域的数据库表结构。
+   数据模型遵循领域模型设计，租户聚合对应独立的表结构，存储在平台库中。

### 3.5.1 数据库分布

+   租户生命周期数据分布说明：

    | 数据库               | 存储内容             | 说明                                      |
    | -------------------- | -------------------- | ----------------------------------------- |
    | clarisphere_platform | 租户主表、事件发件箱 | 所有租户数据统一存储在平台库              |
    | clarisphere_t{id}    | 租户独占业务数据库   | 由BC-11创建，BC-10/BC-01~09写入各自业务表 |

    表 3.5.1-1 数据库分布

+   **设计说明**
    -   租户元数据（tenant表）存储在平台库，因为租户管理是平台级操作，不属于任何单个租户
    -   租户的业务数据库（clarisphere_t{tenant_id}，如clarisphere_t1001）由TenantProvisioningService动态创建
    -   事件发件箱表（tenant_outbox_event）同样在平台库，保证与租户状态变更的事务原子性

### 3.5.2 平台库表结构（clarisphere_platform）

#### 3.5.2.1 tenant 租户主表

+   租户主表存储租户全生命周期信息。

+   **P1/P2字段划分**：

    | 字段分类   | 字段                                                                                                                                                                                   |
    | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | P1核心字段 | id, tenant_code, tenant_name, tenant_type, status, industry, scale, contact_*, database_*, datasource_*, pool_status, max_user_count, activated_at, created_by, created_at, updated_at |
    | P2扩展字段 | trial_*, deactivation_*, grace_period_end_at, previous_status, data_archived, database_dropped, datasource_closed, suspend_*, reject_reason, apply_token, approved_*                   |

    表 3.5.2.1-0 P1/P2字段划分

    | 字段名                    | 数据类型     | 可空 | 默认值         | 说明                                                                         | 版本 |
    | ------------------------- | ------------ | ---- | -------------- | ---------------------------------------------------------------------------- | ---- |
    | id                        | BIGINT       | NO   | AUTO_INCREMENT | 主键，租户ID                                                                 | P1   |
    | tenant_code               | VARCHAR(32)  | NO   | -              | 租户代号，创建时赋值，全局唯一，**可修改**                                   | P1   |
    | tenant_name               | VARCHAR(128) | NO   | -              | 租户企业名称                                                                 | P1   |
    | tenant_type               | VARCHAR(16)  | NO   | 'OFFICIAL'     | 租户类型：TRIAL / OFFICIAL（P1仅OFFICIAL）                                   | P1   |
    | status                    | VARCHAR(32)  | NO   | -              | 租户状态枚举，由应用层设置。P1：create()设为CREATING；P2：apply()设为PENDING | P1   |
    | industry                  | VARCHAR(64)  | YES  | NULL           | 所属行业                                                                     | P1   |
    | scale                     | VARCHAR(32)  | YES  | NULL           | 企业规模：1-50 / 51-200 / 201-1000 / 1001-5000 / 5000+                       | P1   |
    | contact_name              | VARCHAR(64)  | NO   | -              | 联系人姓名                                                                   | P1   |
    | contact_email             | VARCHAR(128) | NO   | -              | 联系人邮箱                                                                   | P1   |
    | contact_phone             | VARCHAR(20)  | YES  | NULL           | 联系人电话                                                                   | P1   |
    | company_email             | VARCHAR(128) | YES  | NULL           | 企业统一邮箱                                                                 | P1   |
    | database_name             | VARCHAR(64)  | YES  | NULL           | 数据库名（clarisphere_t{id}）                                                | P1   |
    | datasource_url            | VARCHAR(512) | YES  | NULL           | JDBC连接URL                                                                  | P1   |
    | datasource_username       | VARCHAR(64)  | YES  | NULL           | 数据库用户名                                                                 | P1   |
    | datasource_password       | VARCHAR(256) | YES  | NULL           | 数据库密码（AES-256加密存储）                                                | P1   |
    | datasource_pool_max       | INT          | YES  | 20             | 连接池最大连接数                                                             | P1   |
    | datasource_pool_min       | INT          | YES  | 5              | 连接池最小空闲数                                                             | P1   |
    | pool_status               | VARCHAR(16)  | YES  | NULL           | 连接池状态：PENDING / ACTIVE / CLOSED                                        | P1   |
    | trial_days                | INT          | YES  | NULL           | 试用天数（仅试用租户）                                                       | P2   |
    | trial_start_at            | DATETIME     | YES  | NULL           | 试用开始时间                                                                 | P2   |
    | trial_expire_at           | DATETIME     | YES  | NULL           | 试用到期时间                                                                 | P2   |
    | max_user_count            | INT          | YES  | NULL           | 最大用户数（P1无限制，P2试用默认5）                                          | P1   |
    | deactivation_reason       | VARCHAR(32)  | YES  | NULL           | 注销原因枚举                                                                 | P2   |
    | deactivation_detail       | VARCHAR(512) | YES  | NULL           | 注销详情说明                                                                 | P2   |
    | deactivation_requested_at | DATETIME     | YES  | NULL           | 注销发起时间                                                                 | P2   |
    | grace_period_end_at       | DATETIME     | YES  | NULL           | 宽限期截止时间                                                               | P2   |
    | previous_status           | VARCHAR(32)  | YES  | NULL           | 注销前状态（用于撤回恢复）                                                   | P2   |
    | data_archived             | TINYINT(1)   | NO   | 0              | 数据是否已归档                                                               | P2   |
    | database_dropped          | TINYINT(1)   | NO   | 0              | 数据库是否已销毁                                                             | P2   |
    | datasource_closed         | TINYINT(1)   | NO   | 0              | 连接池是否已关闭                                                             | P2   |
    | suspend_reason            | VARCHAR(512) | YES  | NULL           | 暂停原因                                                                     | P2   |
    | reject_reason             | VARCHAR(512) | YES  | NULL           | 审批拒绝原因                                                                 | P2   |
    | apply_token               | VARCHAR(64)  | YES  | NULL           | 试用申请跟踪令牌                                                             | P2   |
    | approved_by               | BIGINT       | YES  | NULL           | 审批人ID                                                                     | P2   |
    | approved_at               | DATETIME     | YES  | NULL           | 审批时间                                                                     | P2   |
    | activated_at              | DATETIME     | YES  | NULL           | 激活时间                                                                     | P1   |
    | suspended_at              | DATETIME     | YES  | NULL           | 暂停时间                                                                     | P2   |
    | deactivated_at            | DATETIME     | YES  | NULL           | 注销完成时间                                                                 | P2   |
    | created_by                | BIGINT       | NO   | -              | 创建人ID（平台管理员）                                                       | P1   |
    | created_at                | DATETIME     | NO   | NOW()          | 创建时间                                                                     | P1   |
    | updated_at                | DATETIME     | NO   | NOW()          | 更新时间                                                                     | P1   |

    表 3.5.2.1-1 tenant 租户主表结构

+   索引设计：

    | 索引名              | 索引字段            | 类型 | 说明                         | 版本 |
    | ------------------- | ------------------- | ---- | ---------------------------- | ---- |
    | PRIMARY             | id                  | 主键 | 主键索引                     | P1   |
    | uk_tenant_code      | tenant_code         | 唯一 | 租户代号唯一索引             | P1   |
    | idx_tenant_name     | tenant_name         | 普通 | 企业名称索引（模糊查询）     | P1   |
    | idx_status          | status              | 普通 | 状态索引                     | P1   |
    | idx_tenant_type     | tenant_type         | 普通 | 租户类型索引                 | P1   |
    | idx_contact_email   | contact_email       | 普通 | 联系人邮箱索引               | P1   |
    | idx_created_at      | created_at          | 普通 | 创建时间索引                 | P1   |
    | uk_apply_token      | apply_token         | 唯一 | 申请令牌唯一索引（允许NULL） | P2   |
    | idx_trial_expire_at | trial_expire_at     | 普通 | 试用到期时间索引（定时扫描） | P2   |
    | idx_status_type     | status, tenant_type | 复合 | 状态+类型组合筛选            | P1   |
    | idx_grace_period    | grace_period_end_at | 普通 | 宽限期索引（定时扫描）       | P2   |

    表 3.5.2.1-2 tenant 索引设计

#### 3.5.2.2 tenant_outbox_event 事件发件箱表

+   事件发件箱表用于实现Outbox模式，保证领域事件与业务操作的事务原子性。

    | 字段名        | 数据类型    | 可空 | 默认值         | 说明                              |
    | ------------- | ----------- | ---- | -------------- | --------------------------------- |
    | id            | BIGINT      | NO   | AUTO_INCREMENT | 主键                              |
    | event_id      | VARCHAR(64) | NO   | -              | 事件唯一标识（UUID）              |
    | event_type    | VARCHAR(64) | NO   | -              | 事件类型（如TenantActivated）     |
    | aggregate_id  | BIGINT      | NO   | -              | 聚合根ID（tenantId）              |
    | payload       | TEXT        | NO   | -              | 事件Payload（JSON）               |
    | status        | VARCHAR(16) | NO   | 'PENDING'      | 投递状态：PENDING / SENT / FAILED |
    | retry_count   | INT         | NO   | 0              | 重试次数                          |
    | max_retries   | INT         | NO   | 5              | 最大重试次数                      |
    | next_retry_at | DATETIME    | YES  | NULL           | 下次重试时间（指数退避）          |
    | sent_at       | DATETIME    | YES  | NULL           | 投递成功时间                      |
    | created_at    | DATETIME    | NO   | NOW()          | 创建时间                          |

    表 3.5.2.2-1 tenant_outbox_event 事件发件箱表结构

+   索引设计：

    | 索引名           | 索引字段              | 类型 | 说明                   |
    | ---------------- | --------------------- | ---- | ---------------------- |
    | PRIMARY          | id                    | 主键 | 主键索引               |
    | uk_event_id      | event_id              | 唯一 | 事件ID唯一索引         |
    | idx_status_retry | status, next_retry_at | 复合 | 投递任务扫描索引       |
    | idx_aggregate_id | aggregate_id          | 普通 | 聚合根索引             |
    | idx_created_at   | created_at            | 普通 | 创建时间索引（清理用） |

    表 3.5.2.2-2 tenant_outbox_event 索引设计

+   业务规则：
    -   后台定时任务（每5秒）扫描status=PENDING或status=FAILED且next_retry_at≤当前时间的记录
    -   投递成功后更新status=SENT和sent_at
    -   投递失败时retry_count+1，设置next_retry_at为指数退避时间（2^retry_count * 10秒）
    -   超过max_retries后标记为FAILED并触发告警
    -   已投递成功且超过7天的记录可物理删除

### 3.5.3 表关系图

+   租户生命周期数据模型关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     租户生命周期数据模型关系图                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  clarisphere_platform                                                       │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                     │    │
    │  │  ┌─────────────────────┐      ┌──────────────────────────┐          │    │
    │  │  │       tenant        │      │  tenant_outbox_event     │          │    │
    │  │  │    （租户主表）     │──1:N─│   （事件发件箱表）       │          │    │
    │  │  │                     │      └──────────────────────────┘          │    │
    │  │  │  id (tenant_id) ────────────────┐                                │    │
    │  │  │  tenant_name        │           │                                │    │
    │  │  │  status             │           │ 动态创建                       │    │
    │  │  │  database_name      │           │                                │    │
    │  │  └─────────────────────┘           ▼                                │    │
    │  │                           ┌────────────────────┐                    │    │
    │  │                           │clarisphere_t{id}   │                    │    │
    │  │                           │  (租户独占数据库)  │                    │    │
    │  │                           │                    │                    │    │
    │  │                           │  iam_user (BC-10)  │                    │    │
    │  │                           │  iam_role (BC-10)  │                    │    │
    │  │                           │  org_xxx  (BC-10)  │                    │    │
    │  │                           │  biz_xxx  (BC-01~) │                    │    │
    │  │                           └────────────────────┘                    │    │
    │  │                                                                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.5.3-1 租户生命周期数据模型关系图

### 3.5.4 数据字典

#### 3.5.4.1 tenant_type 租户类型

    | Java枚举值 | 数据库存储值 | 说明     |
    | ---------- | ------------ | -------- |
    | TRIAL      | TRIAL        | 试用租户 |
    | OFFICIAL   | OFFICIAL     | 正式租户 |

    表 3.5.4.1-1 tenant_type 租户类型枚举

#### 3.5.4.2 status 租户状态

    | 枚举值       | 说明     | 可流转到                                 |
    | ------------ | -------- | ---------------------------------------- |
    | PENDING      | 待审批   | CREATING, REJECTED                       |
    | REJECTED     | 已拒绝   | -（终态）                                |
    | CREATING     | 创建中   | INITIALIZING                             |
    | INITIALIZING | 初始化中 | TRIAL, ACTIVE                            |
    | TRIAL        | 试用中   | ACTIVE, EXPIRED, SUSPENDED, DEACTIVATING |
    | ACTIVE       | 已激活   | SUSPENDED, EXPIRED, DEACTIVATING         |
    | SUSPENDED    | 已暂停   | ACTIVE, DEACTIVATING                     |
    | EXPIRED      | 已过期   | ACTIVE, DEACTIVATING                     |
    | DEACTIVATING | 注销中   | ACTIVE, TRIAL, SUSPENDED, DEACTIVATED    |
    | DEACTIVATED  | 已注销   | -（终态）                                |

    表 3.5.4.2-1 status 租户状态枚举

+   **说明**：DEACTIVATING状态可流转回ACTIVE/TRIAL/SUSPENDED，因宽限期内可撤回注销，恢复到previous_status。

#### 3.5.4.3 pool_status 连接池状态

    | 枚举值  | 说明   | 触发时机           |
    | ------- | ------ | ------------------ |
    | PENDING | 待创建 | 数据库创建完成     |
    | ACTIVE  | 运行中 | 连接池注册成功     |
    | CLOSED  | 已关闭 | 注销清理或手动关闭 |

    表 3.5.4.3-1 pool_status 连接池状态枚举

#### 3.5.4.4 deactivation_reason 注销原因

    | 枚举值        | 说明         |
    | ------------- | ------------ |
    | VOLUNTARY     | 主动退出     |
    | OVERDUE       | 欠费注销     |
    | VIOLATION     | 违规注销     |
    | TRIAL_EXPIRED | 试用过期注销 |
    | CONTRACT_END  | 合同到期注销 |

    表 3.5.4.4-1 deactivation_reason 注销原因枚举

#### 3.5.4.5 scale 企业规模

    | 枚举值    | 说明        |
    | --------- | ----------- |
    | 1-50      | 50人以下    |
    | 51-200    | 51-200人    |
    | 201-1000  | 201-1000人  |
    | 1001-5000 | 1001-5000人 |
    | 5000+     | 5000人以上  |

    表 3.5.4.5-1 scale 企业规模枚举

### 3.5.5 数据迁移与初始化

#### 3.5.5.1 平台库初始化

+   平台库初始化时需要执行以下操作：
    -   创建tenant表和tenant_outbox_event表
    -   无需插入初始数据（租户通过试用申请流程创建）

#### 3.5.5.2 租户库动态创建

+   新租户开通时的数据库初始化流程：
    -   第1步：创建数据库 `CREATE DATABASE clarisphere_t{tenant_id}`
    -   第2步：BC-10执行IAM表DDL（iam_user、iam_role等）
    -   第3步：BC-01~09执行各自业务表DDL（P1+阶段）
    -   第4步：BC-10创建租户管理员账号
    -   第5步：注册HikariCP连接池

#### 3.5.5.3 数据清理策略

+   数据清理策略如下：

    | 数据类型           | 清理条件                       | 清理方式     |
    | ------------------ | ------------------------------ | ------------ |
    | 过期申请令牌       | apply_token且created_at超过7天 | 置空字段     |
    | 已投递事件         | status=SENT且超过7天           | 物理删除     |
    | 投递失败事件       | status=FAILED且超过30天        | 归档后删除   |
    | 已注销租户         | status=DEACTIVATED且超过1年    | 可归档       |
    | 已拒绝申请         | status=REJECTED且超过90天      | 可归档       |
    | 过期试用租户数据库 | status=EXPIRED且超过7天未转正  | 执行注销清理 |

    表 3.5.5.3-1 数据清理策略

## 3.6 前端设计

+   本节设计租户生命周期子领域的前端页面，包括页面清单、页面结构和交互设计。
+   P1阶段租户管理仅面向UP运营方，公共页面提供试用申请入口。

### 3.6.1 页面总览

+   租户生命周期子领域前端页面清单如下表所示。

    | 页面编号      | 页面名称       | 用户群   | 路由路径                           | 说明                 |
    | ------------- | -------------- | -------- | ---------------------------------- | -------------------- |
    | PG-P-TNT-01   | 租户管理列表页 | provider | /provider/tenant/tenants           | 供给侧租户管理主入口 |
    | PG-P-TNT-02   | 租户详情页     | provider | /provider/tenant/tenants/:id       | 列表页点击租户名进入 |
    | PG-P-TNT-03   | 租户审批页     | provider | /provider/tenant/tenants/:id/audit | 列表页审批按钮进入   |
    | PG-PUB-TNT-01 | 企业试用申请页 | 公共     | /public/trial-apply                | 官网免费试用入口     |
    | PG-PUB-TNT-02 | 申请状态查询页 | 公共     | /public/trial-status               | 试用申请提交后跳转   |

    表 3.6.1-1 租户生命周期页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                      租户生命周期页面导航结构                             │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  供给侧管理后台                                                          │
    │  └── 租户管理 → 租户列表                                                 │
    │      └── [PG-P-TNT-01] 租户管理列表页                                    │
    │          ├── [PG-P-TNT-02] 租户详情页                                    │
    │          └── [PG-P-TNT-03] 租户审批页                                    │
    │                                                                          │
    │  公共页面（无需登录）                                                    │
    │  ├── [PG-PUB-TNT-01] 企业试用申请页                                      │
    │  └── [PG-PUB-TNT-02] 申请状态查询页                                      │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.1-1 租户生命周期页面导航结构

### 3.6.2 供给侧租户管理

#### 3.6.2.1 PG-P-TNT-01 租户管理列表页

+   页面说明：
    -   用途：管理所有租户，支持查询、审批、暂停、恢复、注销等操作
    -   入口：供给侧后台 → 租户管理 → 租户列表
    -   权限：provider:tenant:tenant:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-TNT-01 租户管理列表页                                              │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 租户管理 / 租户列表                                               │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 统计卡片区域 ────────────────────────────────────────────────────┐   │
    │  │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐       │   │
    │  │  │总租户│  │待审批│  │试用中│  │已激活│  │已暂停│  │已过期│       │   │
    │  │  │ 120  │  │  5   │  │  15  │  │  80  │  │  3   │  │  7   │       │   │
    │  │  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 搜索区域 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  企业名称/代号         状态               类型                    │   │
    │  │  ┌──────────────┐    ┌──────────┐      ┌──────────┐               │   │
    │  │  │              │    │ 全部   ▼ │      │ 全部   ▼ │               │   │
    │  │  └──────────────┘    └──────────┘      └──────────┘               │   │
    │  │                                                                   │   │
    │  │  行业                                  ┌──────┐    ┌──────┐       │   │
    │  │  ┌──────────────┐                      │ 搜索 │    │ 重置 │       │   │
    │  │  │              │                      └──────┘    └──────┘       │   │
    │  │  └──────────────┘                                                 │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │  ┌──────────┐                                                            │
    │  │+ 创建租户│                                                            │
    │  └──────────┘                                                            │
    │                                                                          │
    │  ┌─ 数据列表 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌──────┬────────┬──────┬──────┬──────┬──────────┬────────────┐   │   │
    │  │  │ 代号 │ 企业名 │ 类型 │ 状态 │ 联系人│ 申请时间 │   操作    │   │   │
    │  │  ├──────┼────────┼──────┼──────┼──────┼──────────┼────────────┤   │   │
    │  │  │citic │中信银行│ 正式 │ 正常 │ 张三 │01-10     │详情 暂停   │   │   │
    │  │  │      │        │      │      │      │          │注销        │   │   │
    │  │  ├──────┼────────┼──────┼──────┼──────┼──────────┼────────────┤   │   │
    │  │  │ -    │演示科技│ 试用 │待审批│ 王五 │02-01     │审批        │   │   │
    │  │  ├──────┼────────┼──────┼──────┼──────┼──────────┼────────────┤   │   │
    │  │  │demo  │测试公司│ 试用 │已暂停│ 李四 │01-20     │详情 恢复   │   │   │
    │  │  │      │        │      │      │      │          │注销        │   │   │
    │  │  └──────┴────────┴──────┴──────┴──────┴──────────┴────────────┘   │   │
    │  │                                                                   │   │
    │  │  共 120 条  < 1 2 3 ... 6 >    每页 20 条                         │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.1-1 租户管理列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                                           | 关联API  | 前置条件                          |
    | -------- | -------- | -------- | ---------------------------------------------- | -------- | --------------------------------- |
    | F01      | 展示     | 加载统计 | 进入页面时加载租户统计卡片数据                 | P-TNT-03 | provider:tenant:tenant:list       |
    | F02      | 展示     | 加载列表 | 进入页面时加载租户列表数据，默认按创建时间倒序 | P-TNT-01 | provider:tenant:tenant:list       |
    | F03      | 操作     | 搜索     | 按搜索条件查询租户列表                         | P-TNT-01 | provider:tenant:tenant:list       |
    | F04      | 操作     | 重置     | 清空搜索条件并重新加载列表                     | -        | -                                 |
    | F05      | 操作     | 查看详情 | 点击租户名或详情按钮，跳转租户详情页           | P-TNT-02 | provider:tenant:tenant:read       |
    | F06      | 操作     | 审批     | 点击审批按钮，跳转租户审批页（仅待审批状态）   | -        | provider:tenant:tenant:approve    |
    | F07      | 操作     | 暂停     | 弹出暂停确认对话框，需填写原因                 | P-TNT-06 | provider:tenant:tenant:suspend    |
    | F08      | 操作     | 恢复     | 恢复已暂停租户，弹出二次确认                   | P-TNT-07 | provider:tenant:tenant:suspend    |
    | F09      | 操作     | 试用转正 | 弹出转正对话框，可调整用户上限（仅试用中状态） | P-TNT-08 | provider:tenant:tenant:update     |
    | F10      | 操作     | 发起注销 | 弹出注销确认对话框，需选择原因                 | P-TNT-09 | provider:tenant:tenant:deactivate |
    | F11      | 操作     | 撤回注销 | 撤回注销申请，弹出二次确认（仅注销中状态）     | P-TNT-10 | provider:tenant:tenant:deactivate |
    | F12      | 操作     | 创建租户 | 弹出创建租户对话框，P1核心操作入口             | P-TNT-12 | provider:tenant:create            |

    表 3.6.2.1-1 租户管理列表页功能说明

+   搜索条件：

    | 字段名        | 组件类型 | 数据来源 | 默认值 | 说明                           |
    | ------------- | -------- | -------- | ------ | ------------------------------ |
    | 企业名称/代号 | Input    | 用户输入 | 空     | 模糊匹配企业名称或精确匹配代号 |
    | 状态          | Select   | 枚举     | 全部   | 全部10种状态                   |
    | 类型          | Select   | 枚举     | 全部   | 试用 / 正式                    |
    | 行业          | Input    | 用户输入 | 空     | 模糊匹配行业                   |

    表 3.6.2.1-2 租户管理列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                       |
    | -------- | ---- | ---- | -------- | -------------------------- |
    | 租户代号 | 100  | 左   | 否       | 未审批显示"-"              |
    | 企业名称 | 160  | 左   | 是       | 可点击跳转详情页           |
    | 租户类型 | 80   | 中   | 否       | 试用 / 正式                |
    | 状态     | 80   | 中   | 否       | 标签展示，颜色见状态标签表 |
    | 联系人   | 80   | 左   | 否       | -                          |
    | 申请时间 | 120  | 中   | 是       | 格式：MM-DD HH:mm          |
    | 操作     | 180  | 中   | 否       | 按钮组，按状态动态显示     |

    表 3.6.2.1-3 租户管理列表页列表字段

+   状态标签展示：

    | 状态值 | 标签文本 | 标签颜色 |
    | ------ | -------- | -------- |
    | 待审批 | 待审批   | 橙色     |
    | 创建中 | 创建中   | 蓝色     |
    | 初始化 | 初始化中 | 蓝色     |
    | 试用中 | 试用中   | 青色     |
    | 正常   | 正常     | 绿色     |
    | 已暂停 | 已暂停   | 红色     |
    | 已过期 | 已过期   | 灰色     |
    | 注销中 | 注销中   | 红色     |
    | 已注销 | 已注销   | 灰色     |
    | 已拒绝 | 已拒绝   | 灰色     |

    表 3.6.2.1-4 租户状态标签

+   交互规则：
    -   操作列按钮根据租户状态动态显示：待审批→审批；试用中→详情、转正、暂停、注销；正常→详情、暂停、注销；已暂停→详情、恢复、注销；注销中→详情、撤回注销；已过期→详情、续费、注销；已拒绝/已注销→详情
    -   暂停、注销操作需弹出二次确认对话框
    -   统计卡片可点击快速筛选对应状态

#### 3.6.2.2 PG-P-TNT-02 租户详情页

+   页面说明：
    -   用途：查看租户完整生命周期信息
    -   入口：租户管理列表页 → 点击企业名称或详情按钮
    -   权限：provider:tenant:read

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-TNT-02 租户详情页                                                  │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 租户管理 / 租户列表 / 租户详情                                    │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 头部信息 ────────────────────────────────────────────────────────┐   │
    │  │  中信银行 (citic)                              状态: [正常]       │   │
    │  │  类型: 正式    行业: 金融    规模: 1001-5000                      │   │
    │  │                                                                   │   │
    │  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌──────────┐                 │   │
    │  │  │编辑联系│  │ 暂停   │  │ 注销   │  │ 更新配额 │                 │   │
    │  │  └────────┘  └────────┘  └────────┘  └──────────┘                 │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ Tab面板 ─────────────────────────────────────────────────────────┐   │
    │  │  [基本信息]  [联系信息]  [数据源信息]  [审批信息]  [时间线]       │   │
    │  │                                                                   │   │
    │  │  ┌ 基本信息 ──────────────────────────────────────────────────┐   │   │
    │  │  │  租户ID：1001          租户代号：citic                     │   │   │
    │  │  │  企业名称：中信银行    租户类型：正式                      │   │   │
    │  │  │  最大用户数：200       当前用户数：45                      │   │   │
    │  │  │  试用信息：已转正      激活时间：2026-01-15 10:00          │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.2-1 租户详情页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称      | 说明                                                                              | 关联API     | 前置条件                          |
    | -------- | -------- | ------------- | --------------------------------------------------------------------------------- | ----------- | --------------------------------- |
    | F01      | 展示     | 加载详情      | 加载租户完整信息                                                                  | P-TNT-02    | provider:tenant:tenant:read       |
    | F02      | 操作     | 编辑联系人    | 弹出联系人信息编辑对话框                                                          | P-TNT-11    | provider:tenant:tenant:update     |
    | F03      | 操作     | 暂停/恢复     | 根据当前状态显示暂停或恢复                                                        | P-TNT-06/07 | provider:tenant:tenant:suspend    |
    | F04      | 操作     | 发起/撤回注销 | 根据当前状态显示注销或撤回                                                        | P-TNT-09/10 | provider:tenant:tenant:deactivate |
    | F05      | 操作     | 更新配额      | 弹出修改最大用户数对话框。当前复用P-TNT-08（试用转正），P3将提供独立的更新配额API | P-TNT-08    | provider:tenant:tenant:update     |

    表 3.6.2.2-1 租户详情页功能说明

#### 3.6.2.3 PG-P-TNT-03 租户审批页

+   页面说明：
    -   用途：审批租户试用申请，可通过或拒绝
    -   入口：租户管理列表页 → 审批按钮（仅PENDING状态可见）
    -   权限：provider:tenant:tenant:approve

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-TNT-03 租户审批页                                                  │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 申请信息（只读）─────────────────────────────────────────────────┐   │
    │  │  企业名称：演示科技有限公司     联系人：王五                      │   │
    │  │  联系邮箱：wangwu@demo.com     电话：13700137000                  │   │
    │  │  行业：互联网                   规模：51-200人                    │   │
    │  │  申请时间：2026-02-01 09:00                                       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 审批操作 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  租户代号（选填）                                                 │   │
    │  │  ┌──────────────────────────────────┐                             │   │
    │  │  │ demo_tech                        │                             │   │
    │  │  └──────────────────────────────────┘                             │   │
    │  │  提示：4-20位，小写字母和数字，不填则自动生成                     │   │
    │  │                                                                   │   │
    │  │  审批备注（选填）                                                 │   │
    │  │  ┌──────────────────────────────────┐                             │   │
    │  │  │                                  │                             │   │
    │  │  └──────────────────────────────────┘                             │   │
    │  │                                                                   │   │
    │  │  拒绝原因（拒绝时必填）                                           │   │
    │  │  ┌──────────────────────────────────┐                             │   │
    │  │  │                                  │                             │   │
    │  │  └──────────────────────────────────┘                             │   │
    │  │                                                                   │   │
    │  │  ┌──────────┐  ┌──────────┐  ┌──────┐                             │   │
    │  │  │ 审批通过 │  │ 审批拒绝 │  │ 返回 │                             │   │
    │  │  └──────────┘  └──────────┘  └──────┘                             │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.3-1 租户审批页线框图

### 3.6.3 公共页面

#### 3.6.3.1 PG-PUB-TNT-01 企业试用申请页

+   页面说明：
    -   用途：企业用户提交试用申请
    -   入口：官网首页 → 免费试用按钮
    -   权限：无（公共页面）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-TNT-01 企业试用申请页                                            │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 品牌区域 ────────────────────────────────────────────────────────┐   │
    │  │  Clarisphere · 企业试用申请                                       │   │
    │  │  30天免费试用，完整体验所有功能                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 申请表单 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  企业名称 *             联系人姓名 *                              │   │
    │  │  ┌──────────────┐      ┌──────────────┐                           │   │
    │  │  │              │      │              │                           │   │
    │  │  └──────────────┘      └──────────────┘                           │   │
    │  │                                                                   │   │
    │  │  联系人邮箱 *           联系人电话                                │   │
    │  │  ┌──────────────┐      ┌──────────────┐                           │   │
    │  │  │              │      │              │                           │   │
    │  │  └──────────────┘      └──────────────┘                           │   │
    │  │                                                                   │   │
    │  │  所属行业               企业规模                                  │   │
    │  │  ┌──────────────┐      ┌──────────────┐                           │   │
    │  │  │              │      │ 请选择    ▼  │                           │   │
    │  │  └──────────────┘      └──────────────┘                           │   │
    │  │                                                                   │   │
    │  │  邮箱验证码 *                                                     │   │
    │  │  ┌──────────────┐  ┌──────────────┐                               │   │
    │  │  │              │  │  发送验证码  │                               │   │
    │  │  └──────────────┘  └──────────────┘                               │   │
    │  │                                                                   │   │
    │  │  ┌──────────────────────────────┐                                 │   │
    │  │  │        提交申请              │                                 │   │
    │  │  └──────────────────────────────┘                                 │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.3.1-1 企业试用申请页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                           | 关联API       | 前置条件   |
    | -------- | -------- | ------------ | ------------------------------ | ------------- | ---------- |
    | F01      | 操作     | 发送验证码   | 发送邮箱验证码，60秒冷却       | PUB-06(BC-10) | -          |
    | F02      | 操作     | 提交申请     | 校验表单后提交试用申请         | PUB-TNT-01    | 验证码有效 |
    | F03      | 展示     | 提交成功跳转 | 提交成功后跳转至申请状态查询页 | -             | -          |

    表 3.6.3.1-1 企业试用申请页功能说明

### 3.6.4 功能操作汇总

+   租户生命周期子领域全部页面功能操作汇总如下表所示。

    | 功能编号          | 页面编号      | 功能类型 | 功能名称     | 关联API     | 前置条件                          |
    | ----------------- | ------------- | -------- | ------------ | ----------- | --------------------------------- |
    | PG-P-TNT-01.F01   | PG-P-TNT-01   | 展示     | 加载统计     | P-TNT-03    | provider:tenant:tenant:list       |
    | PG-P-TNT-01.F02   | PG-P-TNT-01   | 展示     | 加载列表     | P-TNT-01    | provider:tenant:tenant:list       |
    | PG-P-TNT-01.F03   | PG-P-TNT-01   | 操作     | 搜索         | P-TNT-01    | provider:tenant:tenant:list       |
    | PG-P-TNT-01.F04   | PG-P-TNT-01   | 操作     | 重置         | -           | -                                 |
    | PG-P-TNT-01.F05   | PG-P-TNT-01   | 操作     | 查看详情     | P-TNT-02    | provider:tenant:tenant:read       |
    | PG-P-TNT-01.F06   | PG-P-TNT-01   | 操作     | 审批         | -           | provider:tenant:tenant:approve    |
    | PG-P-TNT-01.F07   | PG-P-TNT-01   | 操作     | 暂停         | P-TNT-06    | provider:tenant:tenant:suspend    |
    | PG-P-TNT-01.F08   | PG-P-TNT-01   | 操作     | 恢复         | P-TNT-07    | provider:tenant:tenant:suspend    |
    | PG-P-TNT-01.F09   | PG-P-TNT-01   | 操作     | 试用转正     | P-TNT-08    | provider:tenant:tenant:update     |
    | PG-P-TNT-01.F10   | PG-P-TNT-01   | 操作     | 发起注销     | P-TNT-09    | provider:tenant:tenant:deactivate |
    | PG-P-TNT-01.F11   | PG-P-TNT-01   | 操作     | 撤回注销     | P-TNT-10    | provider:tenant:tenant:deactivate |
    | PG-P-TNT-02.F01   | PG-P-TNT-02   | 展示     | 加载详情     | P-TNT-02    | provider:tenant:tenant:read       |
    | PG-P-TNT-02.F02   | PG-P-TNT-02   | 操作     | 编辑联系人   | P-TNT-11    | provider:tenant:tenant:update     |
    | PG-P-TNT-02.F03   | PG-P-TNT-02   | 操作     | 暂停/恢复    | P-TNT-06/07 | provider:tenant:tenant:suspend    |
    | PG-P-TNT-02.F04   | PG-P-TNT-02   | 操作     | 注销/撤回    | P-TNT-09/10 | provider:tenant:tenant:deactivate |
    | PG-P-TNT-02.F05   | PG-P-TNT-02   | 操作     | 更新配额     | P-TNT-08    | provider:tenant:tenant:update     |
    | PG-P-TNT-03.F01   | PG-P-TNT-03   | 展示     | 加载申请信息 | P-TNT-02    | provider:tenant:tenant:approve    |
    | PG-P-TNT-03.F02   | PG-P-TNT-03   | 操作     | 审批通过     | P-TNT-04    | provider:tenant:tenant:approve    |
    | PG-P-TNT-03.F03   | PG-P-TNT-03   | 操作     | 审批拒绝     | P-TNT-05    | provider:tenant:tenant:approve    |
    | PG-PUB-TNT-01.F01 | PG-PUB-TNT-01 | 操作     | 发送验证码   | PUB-06      | -                                 |
    | PG-PUB-TNT-01.F02 | PG-PUB-TNT-01 | 操作     | 提交申请     | PUB-TNT-01  | -                                 |
    | PG-PUB-TNT-02.F01 | PG-PUB-TNT-02 | 展示     | 查询状态     | PUB-TNT-02  | -                                 |

    表 3.6.4-1 功能操作汇总

## 3.7 权限设计

+   本节设计租户生命周期子领域的权限模型，包括权限点定义、页面-功能-API映射和预置角色。
+   权限设计遵循RBAC模型，权限标识采用四段式命名格式。

### 3.7.1 权限模型

+   权限标识沿用BC-10定义的四段式格式：`{用户侧}:{限界上下文}:{资源}:{操作}`
+   本子领域权限标识说明：
    -   用户侧：provider（租户管理为平台级操作，仅UP用户群）
    -   限界上下文：tenant
    -   资源：tenant（租户资源）
    -   操作：list / read / approve / update / suspend / deactivate

### 3.7.2 权限点清单

#### 3.7.2.1 运营用户群权限点（provider）

+   运营用户群租户管理权限点清单：

    | 权限标识                          | 权限名称     | 权限类型  | 说明                           |
    | --------------------------------- | ------------ | --------- | ------------------------------ |
    | provider:tenant:tenant:list       | 查询租户列表 | 页面+功能 | 访问租户管理页面，查询列表     |
    | provider:tenant:tenant:read       | 查看租户详情 | 功能      | 查看单个租户详情               |
    | provider:tenant:tenant:approve    | 审批租户     | 功能      | 审批通过或拒绝租户申请         |
    | provider:tenant:tenant:update     | 更新租户     | 功能      | 编辑联系人、试用转正、更新配额 |
    | provider:tenant:tenant:suspend    | 暂停/恢复    | 功能      | 暂停和恢复租户                 |
    | provider:tenant:tenant:create     | 创建租户     | 功能      | 直接创建租户（P1核心入口）     |
    | provider:tenant:tenant:deactivate | 注销租户     | 功能      | 发起注销和撤回注销             |

    表 3.7.2.1-1 运营用户群租户管理权限点

+   **说明**：P1阶段租户管理仅面向UP运营方，UR租户侧用户无租户管理权限。UR视角的租户配置管理在第4章TenantConfig子领域中定义。

### 3.7.3 页面-功能-API-权限映射表

#### 3.7.3.1 运营用户群映射表

+   运营用户群页面-功能-API-权限完整映射：

    | 页面编号    | 功能名称   | API编号  | API路径                                        | 权限标识                          |
    | ----------- | ---------- | -------- | ---------------------------------------------- | --------------------------------- |
    | PG-P-TNT-01 | 访问页面   | -        | -                                              | provider:tenant:tenant:list       |
    | PG-P-TNT-01 | 加载统计   | P-TNT-03 | GET /api/v1/provider/tenant/tenants/statistics | provider:tenant:tenant:list       |
    | PG-P-TNT-01 | 加载列表   | P-TNT-01 | GET /api/v1/provider/tenant/tenants            | provider:tenant:tenant:list       |
    | PG-P-TNT-01 | 搜索       | P-TNT-01 | GET /api/v1/provider/tenant/tenants            | provider:tenant:tenant:list       |
    | PG-P-TNT-01 | 暂停       | P-TNT-06 | POST .../tenants/{id}/suspend                  | provider:tenant:tenant:suspend    |
    | PG-P-TNT-01 | 恢复       | P-TNT-07 | POST .../tenants/{id}/resume                   | provider:tenant:tenant:suspend    |
    | PG-P-TNT-01 | 试用转正   | P-TNT-08 | POST .../tenants/{id}/convert                  | provider:tenant:tenant:update     |
    | PG-P-TNT-01 | 发起注销   | P-TNT-09 | POST .../tenants/{id}/deactivate               | provider:tenant:tenant:deactivate |
    | PG-P-TNT-01 | 撤回注销   | P-TNT-10 | POST .../tenants/{id}/deactivate/revoke        | provider:tenant:tenant:deactivate |
    | PG-P-TNT-02 | 访问页面   | P-TNT-02 | GET /api/v1/provider/tenant/tenants/{id}       | provider:tenant:tenant:read       |
    | PG-P-TNT-02 | 编辑联系人 | P-TNT-11 | PUT .../tenants/{id}/contact                   | provider:tenant:tenant:update     |
    | PG-P-TNT-03 | 访问页面   | P-TNT-02 | GET /api/v1/provider/tenant/tenants/{id}       | provider:tenant:tenant:approve    |
    | PG-P-TNT-03 | 审批通过   | P-TNT-04 | POST .../tenants/{id}/approve                  | provider:tenant:tenant:approve    |
    | PG-P-TNT-03 | 审批拒绝   | P-TNT-05 | POST .../tenants/{id}/reject                   | provider:tenant:tenant:approve    |
    | PG-P-TNT-01 | 直接创建   | P-TNT-12 | POST /api/v1/provider/tenant/tenants           | provider:tenant:tenant:create     |

    表 3.7.3.1-1 运营用户群映射表

#### 3.7.3.2 公共页面映射表

+   公共页面无需权限控制：

    | 页面编号      | 功能名称 | API编号    | API路径                                        | 权限标识 |
    | ------------- | -------- | ---------- | ---------------------------------------------- | -------- |
    | PG-PUB-TNT-01 | 提交申请 | PUB-TNT-01 | POST /api/v1/public/tenant/trial/apply         | 无       |
    | PG-PUB-TNT-02 | 查询状态 | PUB-TNT-02 | GET /api/v1/public/tenant/trial/{token}/status | 无       |

    表 3.7.3.2-1 公共页面映射表

### 3.7.4 预置角色与权限

#### 3.7.4.1 运营用户群预置角色

+   运营用户群租户管理相关权限在预置角色中的配置：

    | 角色编码             | 角色名称   | 包含租户管理权限                                                                      | 说明                 |
    | -------------------- | ---------- | ------------------------------------------------------------------------------------- | -------------------- |
    | provider_super_admin | 超级管理员 | provider:tenant:tenant:list, :read, :create, :approve, :update, :suspend, :deactivate | 拥有所有租户管理权限 |
    | provider_admin       | 运营管理员 | provider:tenant:tenant:list, :read, :create, :approve, :update, :suspend              | 无注销权限           |
    | provider_support     | 客服专员   | provider:tenant:tenant:list, :read                                                    | 仅查看权限           |

    表 3.7.4.1-1 运营用户群预置角色（租户管理部分）

+   **说明**：以上角色与BC-10第3章定义的角色为同一组角色，此处仅列出租户管理相关权限的追加配置。

#### 3.7.4.2 角色权限矩阵

+   运营用户群角色与租户管理权限矩阵：

    | 权限点                            | 超级管理员 | 运营管理员 | 客服专员 |
    | --------------------------------- | ---------- | ---------- | -------- |
    | provider:tenant:tenant:list       | ✓          | ✓          | ✓        |
    | provider:tenant:tenant:read       | ✓          | ✓          | ✓        |
    | provider:tenant:tenant:create     | ✓          | ✓          | -        |
    | provider:tenant:tenant:approve    | ✓          | ✓          | -        |
    | provider:tenant:tenant:update     | ✓          | ✓          | -        |
    | provider:tenant:tenant:suspend    | ✓          | ✓          | -        |
    | provider:tenant:tenant:deactivate | ✓          | -          | -        |

    表 3.7.4.2-1 运营用户群角色权限矩阵

### 3.7.5 API权限配置

+   API权限配置汇总，用于后端权限校验：

    | API编号    | HTTP方法 | API路径                                                | 权限标识                          |
    | ---------- | -------- | ------------------------------------------------------ | --------------------------------- |
    | P-TNT-01   | GET      | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:list       |
    | P-TNT-02   | GET      | /api/v1/provider/tenant/tenants/{id}                   | provider:tenant:tenant:read       |
    | P-TNT-03   | GET      | /api/v1/provider/tenant/tenants/statistics             | provider:tenant:tenant:list       |
    | P-TNT-04   | POST     | /api/v1/provider/tenant/tenants/{id}/approve           | provider:tenant:tenant:approve    |
    | P-TNT-05   | POST     | /api/v1/provider/tenant/tenants/{id}/reject            | provider:tenant:tenant:approve    |
    | P-TNT-06   | POST     | /api/v1/provider/tenant/tenants/{id}/suspend           | provider:tenant:tenant:suspend    |
    | P-TNT-07   | POST     | /api/v1/provider/tenant/tenants/{id}/resume            | provider:tenant:tenant:suspend    |
    | P-TNT-08   | POST     | /api/v1/provider/tenant/tenants/{id}/convert           | provider:tenant:tenant:update     |
    | P-TNT-09   | POST     | /api/v1/provider/tenant/tenants/{id}/deactivate        | provider:tenant:tenant:deactivate |
    | P-TNT-10   | POST     | /api/v1/provider/tenant/tenants/{id}/deactivate/revoke | provider:tenant:tenant:deactivate |
    | P-TNT-11   | PUT      | /api/v1/provider/tenant/tenants/{id}/contact           | provider:tenant:tenant:update     |
    | P-TNT-12   | POST     | /api/v1/provider/tenant/tenants                        | provider:tenant:tenant:create     |
    | PUB-TNT-01 | POST     | /api/v1/public/tenant/trial/apply                      | 无                                |
    | PUB-TNT-02 | GET      | /api/v1/public/tenant/trial/{applyToken}/status        | 无                                |
    | RPC-TNT-01 | GET      | /internal/tenant/lifecycle/{tenantId}/status           | 内部调用                          |
    | RPC-TNT-02 | GET      | /internal/tenant/lifecycle/{tenantId}/active           | 内部调用                          |
    | RPC-TNT-03 | GET      | /internal/tenant/lifecycle/{tenantId}                  | 内部调用                          |
    | RPC-TNT-04 | GET      | /internal/tenant/lifecycle/resolve/{tenantCode}        | 内部调用                          |

    表 3.7.5-1 API权限配置汇总

+   权限标识说明：
    -   `无`：公开接口，无需登录
    -   `内部调用`：Feign内部接口，通过服务名鉴权（非用户权限控制）
    -   `{四段式权限}`：需要登录且拥有对应权限

## 3.8 后端工程结构设计

+   本节设计租户生命周期子领域的后端工程结构，包括模块划分、包结构和命名规范。
+   工程结构遵循DDD分层架构，采用Maven多模块组织。

### 3.8.1 模块划分

#### 3.8.1.1 BC-11 服务模块结构

+   BC-11 租户服务采用Maven多模块结构：

    ```
    bc-11-tenant/
    ├── pom.xml                             # 父POM
    ├── bc-11-tenant-api/                   # API模块（对外暴露的接口定义）
    ├── bc-11-tenant-application/           # 应用层模块
    ├── bc-11-tenant-domain/                # 领域层模块
    ├── bc-11-tenant-infrastructure/        # 基础设施层模块
    └── bc-11-tenant-starter/               # 启动模块
    ```

    图 3.8.1.1-1 BC-11服务模块结构

+   模块职责说明：

    | 模块名称                    | 职责                                       | 依赖关系                |
    | --------------------------- | ------------------------------------------ | ----------------------- |
    | bc-11-tenant-api            | 对外API定义、DTO、Feign接口                | 无依赖                  |
    | bc-11-tenant-domain         | 领域模型、领域服务、仓储接口               | 无依赖                  |
    | bc-11-tenant-application    | 应用服务、命令/查询处理、Saga编排          | 依赖domain              |
    | bc-11-tenant-infrastructure | 仓储实现、数据库管理、连接池管理、外部集成 | 依赖domain、application |
    | bc-11-tenant-starter        | Spring Boot启动、Controller、定时任务配置  | 依赖所有模块            |

    表 3.8.1.1-1 模块职责说明

#### 3.8.1.2 模块依赖关系

+   模块依赖关系图：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          模块依赖关系图                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                       ┌──────────────────────┐                              │
    │                       │ bc-11-tenant-starter │                              │
    │                       │     (启动模块)       │                              │
    │                       └──────────┬───────────┘                              │
    │                                  │                                          │
    │                   ┌──────────────┼──────────────┐                           │
    │                   │              │              │                           │
    │                   ▼              ▼              ▼                           │
    │  ┌────────────────────┐  ┌─────────────┐  ┌───────────────────────────┐     │
    │  │ bc-11-tenant-api   │  │             │  │bc-11-tenant-infrastructure│     │
    │  │ (API定义)          │  │             │  │   (基础设施层)            │     │
    │  └────────────────────┘  │             │  └──────────┬────────────────┘     │
    │                          │             │             │                      │
    │                          │             │             ▼                      │
    │                          │             │  ┌────────────────────────┐        │
    │                          │             │  │bc-11-tenant-application│        │
    │                          │             │  │    (应用层)            │        │
    │                          │             │  └──────────┬─────────────┘        │
    │                          │             │             │                      │
    │                          │             │             ▼                      │
    │                          │             │  ┌────────────────────────┐        │
    │                          │             └─▶│  bc-11-tenant-domain   │        │
    │                          │                │    (领域层)            │        │
    │                          │                └────────────────────────┘        │
    │                          │                           ▲                      │
    │                          └───────────────────────────┘                      │
    │                                                                             │
    │   说明：箭头表示依赖方向，领域层不依赖任何模块                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.8.1.2-1 模块依赖关系图

### 3.8.2 包结构设计

#### 3.8.2.1 bc-11-tenant-api 模块

+   API模块包结构：

    ```
    bc-11-tenant-api/
    └── src/main/java/
        └── com/clarisphere/tenant/api/
            ├── dto/                         # 数据传输对象
            │   ├── provider/                # 运营方DTO
            │   │   ├── request/
            │   │   │   ├── ApproveTenantRequest.java
            │   │   │   ├── RejectTenantRequest.java
            │   │   │   ├── SuspendTenantRequest.java
            │   │   │   ├── DeactivateTenantRequest.java
            │   │   │   ├── ConvertTenantRequest.java
            │   │   │   └── UpdateContactRequest.java
            │   │   └── response/
            │   │       ├── TenantResponse.java
            │   │       ├── TenantDetailResponse.java
            │   │       ├── TenantListResponse.java
            │   │       └── TenantStatisticsResponse.java
            │   ├── common/                  # 公共DTO
            │   │   ├── request/
            │   │   │   └── TrialApplyRequest.java
            │   │   └── response/
            │   │       ├── TrialApplyResponse.java
            │   │       └── ApplyStatusResponse.java
            │   └── internal/                # 内部RPC DTO
            │       ├── TenantStatusDTO.java
            │       ├── TenantBasicDTO.java
            │       └── TenantActiveDTO.java
            ├── feign/                       # Feign客户端接口
            │   ├── TenantLifecycleFeignClient.java       # 租户生命周期Feign（/internal/tenant/lifecycle/**）
            │   ├── TenantLifecycleFeignClientFallback.java
            │   ├── TenantConfigFeignClient.java           # 租户配置Feign（/internal/tenant/config/**）
            │   └── TenantConfigFeignClientFallback.java
            └── constant/                    # API常量
                └── TenantApiPaths.java
    ```

    图 3.8.2.1-1 API模块包结构

#### 3.8.2.2 bc-11-tenant-domain 模块

+   领域层模块包结构：

    ```
    bc-11-tenant-domain/
    └── src/main/java/
        └── com/clarisphere/tenant/domain/
            ├── lifecycle/                   # 租户生命周期子领域
            │   ├── model/                   # 领域模型
            │   │   ├── aggregate/           # 聚合根
            │   │   │   └── Tenant.java
            │   │   └── valueobject/         # 值对象
            │   │       ├── TenantCode.java
            │   │       ├── TenantStatus.java
            │   │       ├── DataSourceConfig.java
            │   │       ├── ContactInfo.java
            │   │       ├── TrialInfo.java
            │   │       └── DeactivationInfo.java
            │   ├── repository/              # 仓储接口
            │   │   └── TenantRepository.java
            │   ├── service/                 # 领域服务
            │   │   ├── TenantProvisioningService.java
            │   │   ├── DatabaseManagementService.java
            │   │   ├── DataSourceManagementService.java
            │   │   ├── TenantQueryService.java
            │   │   ├── TenantExpirationService.java
            │   │   └── TenantDeactivationService.java
            │   ├── event/                   # 领域事件
            │   │   ├── TenantApplied.java
            │   │   ├── TenantApproved.java
            │   │   ├── TenantRejected.java
            │   │   ├── TenantCreated.java
            │   │   ├── TenantActivated.java
            │   │   ├── TenantConverted.java
            │   │   ├── TenantExpired.java
            │   │   ├── TenantSuspended.java
            │   │   ├── TenantResumed.java
            │   │   ├── TenantDeactivating.java
            │   │   ├── TenantDeactivationRevoked.java
            │   │   ├── TenantDeactivated.java
            │   │   └── TenantCodeChanged.java
            │   ├── specification/           # 规约
            │   │   ├── TenantCodeUniqueSpec.java
            │   │   └── TenantNameUniqueSpec.java
            │   └── exception/               # 领域异常
            │       ├── TenantNotFoundException.java
            │       ├── TenantAlreadyExistsException.java
            │       ├── InvalidTenantStateException.java
            │       └── DatabaseCreationException.java
            ├── config/                      # 租户配置子领域（第4章）
            └── shared/                      # 共享内核
                ├── valueobject/
                │   ├── TenantId.java
                │   └── TenantCode.java
                └── event/
                    └── DomainEvent.java
    ```

    图 3.8.2.2-1 领域层模块包结构

#### 3.8.2.3 bc-11-tenant-application 模块

+   应用层模块包结构：

    ```
    bc-11-tenant-application/
    └── src/main/java/
        └── com/clarisphere/tenant/application/
            ├── lifecycle/                   # 租户生命周期应用服务
            │   ├── command/                 # 命令处理
            │   │   ├── TenantApplyCommand.java
            │   │   ├── TenantApproveCommand.java
            │   │   ├── TenantRejectCommand.java
            │   │   ├── TenantSuspendCommand.java
            │   │   ├── TenantResumeCommand.java
            │   │   ├── TenantConvertCommand.java
            │   │   ├── TenantDeactivateCommand.java
            │   │   └── TenantRevokeDeactivationCommand.java
            │   ├── query/                   # 查询处理
            │   │   ├── TenantListQuery.java
            │   │   └── TenantDetailQuery.java
            │   ├── service/                 # 应用服务
            │   │   ├── TenantCommandService.java
            │   │   └── TenantQueryAppService.java
            │   ├── saga/                    # Saga编排
            │   │   └── TenantProvisioningSaga.java
            │   └── listener/               # 事件监听
            │       └── TenantEventListener.java
            └── assembler/                   # DTO装配
                └── TenantAssembler.java
    ```

    图 3.8.2.3-1 应用层模块包结构

#### 3.8.2.4 bc-11-tenant-infrastructure 模块

+   基础设施层模块包结构：

    ```
    bc-11-tenant-infrastructure/
    └── src/main/java/
        └── com/clarisphere/tenant/infrastructure/
            ├── persistence/                 # 持久化
            │   ├── repository/              # 仓储实现
            │   │   └── TenantRepositoryImpl.java
            │   ├── mapper/                  # MyBatis Mapper
            │   │   ├── TenantMapper.java
            │   │   └── TenantOutboxEventMapper.java
            │   ├── entity/                  # 持久化实体（PO）
            │   │   ├── TenantPO.java
            │   │   └── TenantOutboxEventPO.java
            │   └── converter/               # PO-DO转换
            │       └── TenantConverter.java
            ├── datasource/                  # 动态数据源管理
            │   ├── DynamicDataSourceManager.java
            │   ├── HikariPoolRegistry.java
            │   └── DataSourceRoutingAspect.java
            ├── database/                    # 数据库管理
            │   ├── DatabaseCreator.java
            │   ├── DdlScriptExecutor.java
            │   └── DatabaseArchiver.java
            ├── outbox/                      # 事件发件箱
            │   ├── OutboxEventPublisher.java
            │   └── OutboxEventScheduler.java
            ├── feign/                       # Feign调用
            │   └── IamFeignClientAdapter.java
            └── config/                      # 配置
                ├── DataSourceConfig.java
                └── SchedulerConfig.java
    ```

    图 3.8.2.4-1 基础设施层模块包结构

#### 3.8.2.5 bc-11-tenant-starter 模块

+   启动模块包结构：

    ```
    bc-11-tenant-starter/
    └── src/main/java/
        └── com/clarisphere/tenant/
            ├── TenantApplication.java       # Spring Boot主类
            └── web/                         # Controller层
                ├── provider/                # 运营方Controller
                │   └── TenantController.java
                ├── common/                  # 公共Controller
                │   └── TrialApplyController.java
                └── internal/                # 内部RPC Controller
                    ├── TenantLifecycleInternalController.java  # 生命周期RPC（/internal/tenant/lifecycle/**）
                    └── TenantConfigInternalController.java     # 配置RPC（/internal/tenant/config/**）
    ```

    图 3.8.2.5-1 启动模块包结构

### 3.8.3 命名规范

#### 3.8.3.1 类命名规范

+   BC-11租户服务类命名规范：

    | 分类        | 命名模式               | 示例                               |
    | ----------- | ---------------------- | ---------------------------------- |
    | 聚合根      | {聚合名}               | Tenant                             |
    | 值对象      | {概念名}               | TenantCode, TenantStatus           |
    | 领域服务    | {业务名}Service        | TenantProvisioningService          |
    | 领域事件    | Tenant{动作过去式}     | TenantActivated                    |
    | 仓储接口    | {聚合名}Repository     | TenantRepository                   |
    | 仓储实现    | {聚合名}RepositoryImpl | TenantRepositoryImpl               |
    | 应用服务    | {聚合名}CommandService | TenantCommandService               |
    | 命令对象    | Tenant{操作}Command    | TenantApproveCommand               |
    | 查询对象    | Tenant{操作}Query      | TenantListQuery                    |
    | Controller  | {聚合名}Controller     | TenantController                   |
    | 请求DTO     | {操作}TenantRequest    | ApproveTenantRequest               |
    | 响应DTO     | Tenant{内容}Response   | TenantDetailResponse               |
    | 持久化实体  | {聚合名}PO             | TenantPO                           |
    | Mapper      | {聚合名}Mapper         | TenantMapper                       |
    | Feign客户端 | {子领域名}FeignClient  | TenantLifecycleFeignClient         |
    | 降级实现    | {Feign名}Fallback      | TenantLifecycleFeignClientFallback |

    表 3.8.3.1-1 类命名规范

#### 3.8.3.2 方法命名规范

+   BC-11方法命名规范：

    | 分类       | 命名模式                | 示例                      |
    | ---------- | ----------------------- | ------------------------- |
    | 创建类     | apply / create          | apply(), createDatabase() |
    | 审批类     | approve / reject        | approve(), reject()       |
    | 状态变更类 | {动作}                  | suspend(), resume()       |
    | 查询单个   | get{对象}               | getTenantById()           |
    | 查询列表   | getList / get{对象}List | getList()                 |
    | 查询统计   | getStatistics / count   | getStatistics()           |
    | 判断类     | is{条件}                | isActive()                |
    | 更新类     | update{属性}            | updateContactInfo()       |

    表 3.8.3.2-1 方法命名规范

### 3.8.4 类职责说明

+   核心类职责说明：

    | 类名                        | 层级   | 职责                                                    |
    | --------------------------- | ------ | ------------------------------------------------------- |
    | Tenant                      | domain | 租户聚合根，管理生命周期状态机和业务规则                |
    | TenantProvisioningService   | domain | Saga编排：创建数据库→初始化IAM→注册连接池→激活          |
    | DatabaseManagementService   | domain | 物理数据库的创建、删除、归档等操作（接口，infra层实现） |
    | DataSourceManagementService | domain | HikariCP连接池的运行时管理（接口，infra层实现）         |
    | TenantCommandService        | app    | 应用服务，协调命令处理、事务控制和事件发布              |
    | TenantProvisioningSaga      | app    | 租户开通Saga状态管理和补偿逻辑                          |
    | TenantController            | web    | REST API入口，请求验证和路由                            |
    | DynamicDataSourceManager    | infra  | 动态数据源注册、路由和生命周期管理                      |
    | OutboxEventPublisher        | infra  | 事件发件箱投递，定时任务扫描和发布                      |

    表 3.8.4-1 核心类职责说明

## 3.9 前端工程结构设计

+   本节设计租户生命周期子领域的前端工程结构，包括目录划分和命名规范。
+   技术栈：TypeScript + Vue 3 + Element Plus + Vite + Pinia

### 3.9.1 技术栈说明

+   前端技术栈与BC-10统一，详见BC-10第3.9.1节表 3.9.1-1。

### 3.9.2 目录结构设计

#### 3.9.2.1 API模块结构

+   租户管理API模块结构：

    ```
    src/api/
    └── tenant/                          # 租户限界上下文
        ├── index.ts                     # 租户API导出
        ├── types.ts                     # 租户类型定义
        ├── provider.ts                  # 运营方租户管理API
        └── public.ts                    # 公共API（试用申请）
    ```

    图 3.9.2.1-1 API模块结构

#### 3.9.2.2 类型定义结构

+   租户管理TypeScript类型定义模块结构：

    ```
    src/types/
    └── tenant/                          # 租户类型
        ├── index.ts                     # 租户类型导出
        ├── tenant.ts                    # 租户相关类型
        ├── enums.ts                     # 枚举类型（TenantStatus, TenantType等）
        └── dto.ts                       # DTO类型（Request/Response）
    ```

    图 3.9.2.2-1 类型定义模块结构

#### 3.9.2.3 页面组件结构

+   租户管理页面组件按用户群组织：

    ```
    src/views/
    ├── provider/                        # 运营方页面
    │   └── tenant/                      # 租户管理
    │       ├── tenants/                 # 租户列表
    │       │   ├── index.vue            # PG-P-TNT-01 列表页
    │       │   └── components/          # 列表页子组件
    │       │       ├── TenantStatCards.vue
    │       │       ├── TenantSearchForm.vue
    │       │       ├── TenantTable.vue
    │       │       ├── SuspendDialog.vue
    │       │       ├── DeactivateDialog.vue
    │       │       └── ConvertDialog.vue
    │       ├── detail/                  # 租户详情
    │       │   ├── index.vue            # PG-P-TNT-02 详情页
    │       │   └── components/
    │       │       ├── TenantBaseInfo.vue
    │       │       ├── TenantContactInfo.vue
    │       │       ├── TenantDataSourceInfo.vue
    │       │       ├── TenantApprovalInfo.vue
    │       │       └── TenantTimeline.vue
    │       └── audit/                   # 租户审批
    │           └── index.vue            # PG-P-TNT-03 审批页
    └── public/                          # 公共页面
        ├── trial-apply/                 # 试用申请
        │   └── index.vue                # PG-PUB-TNT-01 申请页
        └── trial-status/                # 申请状态
            └── index.vue                # PG-PUB-TNT-02 状态页
    ```

    图 3.9.2.3-1 页面组件结构

#### 3.9.2.4 路由配置结构

+   租户管理路由配置：

    ```
    src/router/
    └── modules/
        └── tenant.ts                    # 租户管理路由模块
    ```

    图 3.9.2.4-1 路由配置结构

#### 3.9.2.5 状态管理结构

+   租户管理状态管理：

    ```
    src/stores/
    └── tenant/
        └── tenantStore.ts               # 租户管理状态
    ```

    图 3.9.2.5-1 状态管理结构

### 3.9.3 命名规范

#### 3.9.3.1 文件命名规范

+   BC-11前端文件命名规范：

    | 文件类型   | 命名规范   | 示例             |
    | ---------- | ---------- | ---------------- |
    | 页面组件   | index.vue  | detail/index.vue |
    | 业务子组件 | PascalCase | TenantTable.vue  |
    | API文件    | camelCase  | provider.ts      |
    | 类型文件   | camelCase  | tenant.ts        |
    | Store文件  | camelCase  | tenantStore.ts   |
    | 路由模块   | camelCase  | tenant.ts        |

    表 3.9.3.1-1 文件命名规范

#### 3.9.3.2 组件命名规范

+   BC-11前端组件命名规范：

    | 组件类型     | 命名规范         | 示例             |
    | ------------ | ---------------- | ---------------- |
    | 页面组件     | {功能}Page       | TenantListPage   |
    | 表格组件     | {资源}Table      | TenantTable      |
    | 表单组件     | {资源}{操作}Form | TenantSearchForm |
    | 对话框组件   | {操作}Dialog     | SuspendDialog    |
    | 信息展示组件 | {资源}{分类}Info | TenantBaseInfo   |
    | 统计卡片组件 | {资源}StatCards  | TenantStatCards  |

    表 3.9.3.2-1 组件命名规范

### 3.9.4 页面与组件映射

+   页面编号与前端组件文件映射：

    | 页面编号      | 页面名称       | 组件路径                                |
    | ------------- | -------------- | --------------------------------------- |
    | PG-P-TNT-01   | 租户管理列表页 | views/provider/tenant/tenants/index.vue |
    | PG-P-TNT-02   | 租户详情页     | views/provider/tenant/detail/index.vue  |
    | PG-P-TNT-03   | 租户审批页     | views/provider/tenant/audit/index.vue   |
    | PG-PUB-TNT-01 | 企业试用申请页 | views/public/trial-apply/index.vue      |
    | PG-PUB-TNT-02 | 申请状态查询页 | views/public/trial-status/index.vue     |

    表 3.9.4-1 页面与组件映射

# 4 租户配置

> **✓ 版本标记：P1完整实现**（品牌定制P2、功能开关P3除外）

+   本章详细描述租户配置子领域的设计，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   租户配置负责管理"租户的个性化"，涵盖基本信息维护、邮箱域名配置、认证方式选择、SSO单点登录配置和LDAP/AD配置。
+   **P1核心价值**：私有化部署场景下，企业客户通常已有统一身份认证体系（AD/LDAP/SSO），快速完成企业IAM整合是P1刚需。本章所有P1内容（SC-CFG-01至SC-CFG-06）均在P1中实现。

+   **P1交付范围**：

    | 功能         | P1  | 说明                                 |
    | ------------ | --- | ------------------------------------ |
    | 基本信息维护 | ✓   | 企业名称、联系人、Logo等             |
    | 邮箱域名配置 | ✓   | 控制允许注册的企业邮箱域名列表       |
    | 认证方式选择 | ✓   | 本地认证/SSO/LDAP三选一              |
    | SSO-SAML配置 | ✓   | SAML 2.0协议IdP元数据和SP参数配置    |
    | SSO-OIDC配置 | ✓   | OIDC协议Provider端点和Client参数配置 |
    | LDAP/AD配置  | ✓   | LDAP服务器连接、用户搜索和属性映射   |
    | 品牌定制     | ✗   | P2实现                               |
    | 功能开关     | ✗   | P3实现                               |

    表 4-1 P1租户配置交付范围

## 4.1 业务场景分析

### 4.1.1 场景总览

+   租户配置子领域的业务场景如下表所示。

    | 场景编号  | 场景名称     | 操作者     | 版本 | 说明                                   |
    | --------- | ------------ | ---------- | ---- | -------------------------------------- |
    | SC-CFG-01 | 基本信息维护 | 租户管理员 | P1   | 维护租户企业名称、联系方式等基本信息   |
    | SC-CFG-02 | 邮箱域名配置 | 租户管理员 | P1   | 管理允许注册的企业邮箱域名列表         |
    | SC-CFG-03 | 认证方式选择 | 租户管理员 | P1   | 选择本地认证、SSO或LDAP认证方式        |
    | SC-CFG-04 | SSO-SAML配置 | 租户管理员 | P1   | 配置SAML 2.0协议的IdP元数据和SP参数    |
    | SC-CFG-05 | SSO-OIDC配置 | 租户管理员 | P1   | 配置OIDC协议的Provider端点和Client参数 |
    | SC-CFG-06 | LDAP/AD配置  | 租户管理员 | P1   | 配置LDAP服务器地址、绑定DN和搜索过滤器 |
    | SC-CFG-07 | 品牌定制     | 租户管理员 | P2   | 自定义Logo、主题色、登录页样式         |
    | SC-CFG-08 | 功能开关     | 租户管理员 | P3   | 启用/禁用特定业务功能模块              |

    表 4.1.1-1 租户配置场景总览

### 4.1.2 基本信息维护场景

#### 4.1.2.1 场景特点

+   基本信息维护是租户管理员的日常操作：
    -   租户激活后首次登录时引导完善企业信息
    -   后续可随时修改企业名称、联系方式等信息
    -   企业信息展示在租户后台的头部和个人中心

#### 4.1.2.2 可维护字段

+   租户管理员可维护的基本信息字段如下表所示。

    | 字段       | 是否必填 | 修改限制       | 说明                    |
    | ---------- | -------- | -------------- | ----------------------- |
    | 企业名称   | 是       | 可修改，需唯一 | 展示名称，非tenant_code |
    | 企业Logo   | 否       | 可修改         | 200x200px，≤1MB         |
    | 联系人姓名 | 是       | 可修改         | 企业联系人              |
    | 联系人邮箱 | 是       | 可修改，需验证 | 系统通知发送目标        |
    | 联系人电话 | 否       | 可修改         | -                       |
    | 企业地址   | 否       | 可修改         | -                       |
    | 所属行业   | 否       | 可修改         | -                       |

    表 4.1.2.2-1 可维护基本信息字段

### 4.1.3 邮箱域名配置场景

#### 4.1.3.1 场景特点

+   邮箱域名配置控制哪些邮箱可以注册为该租户的用户：
    -   与BC-10的"开放注册"模式（FL-UR-02）协作，BC-10注册时调用BC-11查询域名列表进行校验
    -   企业可配置多个域名（如@icbc.com.cn、@icbc.com）
    -   未配置域名的租户不支持开放注册模式

#### 4.1.3.2 域名规则

+   邮箱域名配置规则如下：

    | 规则编号 | 规则描述                                 | 示例                       |
    | -------- | ---------------------------------------- | -------------------------- |
    | ED-R-01  | 域名格式：以@开头，后跟合法域名          | @icbc.com.cn               |
    | ED-R-02  | 同一租户最多配置10个域名                 | -                          |
    | ED-R-03  | 同一域名全局唯一，不可被多个租户同时使用 | @icbc.com.cn只属于一个租户 |
    | ED-R-04  | 删除域名不影响已注册用户，仅影响新注册   | -                          |

    表 4.1.3.2-1 邮箱域名规则

### 4.1.4 认证方式选择场景

#### 4.1.4.1 场景特点

+   认证方式选择决定租户用户的登录方式：
    -   新租户默认使用本地认证（LOCAL）
    -   切换认证方式前需先完成目标方式的配置（如SSO需先配好IdP信息）
    -   切换认证方式不影响已有用户数据，但影响新用户的创建和登录流程

#### 4.1.4.2 认证方式详情

+   P1支持的认证方式如下表所示。

    | 认证方式 | 编码     | 登录流程                           | 密码管理       | 用户创建方式            |
    | -------- | -------- | ---------------------------------- | -------------- | ----------------------- |
    | 本地认证 | LOCAL    | 用户名+密码→BC-10本地校验          | BC-10管理      | 管理员创建 / 开放注册   |
    | SSO-SAML | SSO_SAML | 重定向IdP→SAML断言→BC-10验证       | IdP管理        | 首次SSO登录自动创建     |
    | SSO-OIDC | SSO_OIDC | 重定向OP→授权码→ID Token→BC-10验证 | OP管理         | 首次SSO登录自动创建     |
    | LDAP/AD  | LDAP     | 用户名+密码→BC-10转发LDAP Bind     | LDAP服务器管理 | 定时同步 / 首次登录创建 |

    表 4.1.4.2-1 认证方式详情

+   **设计说明**：BC-11仅负责存储和管理认证配置，实际的认证执行（SSO流程、LDAP绑定）由BC-10（用户管理上下文）负责。BC-10通过 tenant_id 发起RPC查询BC-11获取当前租户的认证配置。登录流程中的审计日志也由BC-10统一记录。

+   **配置版本管理（P2+扩展）**
    -   P1阶段SSO/LDAP配置采用覆盖更新模式，不保留历史版本
    -   P2+阶段可扩展配置版本管理能力：
        -   每次配置变更生成新版本，保留最近5个历史版本
        -   支持一键回滚到历史版本（如证书更新后出现问题可快速回退）
        -   版本记录包含：版本号、变更时间、变更人、变更内容摘要
    -   数据模型扩展：在platform_sso_config和platform_ldap_config表增加version字段，历史版本存入platform_config_history归档表

### 4.1.5 SSO配置场景

#### 4.1.5.1 SSO-SAML配置

+   SAML 2.0协议配置所需参数如下表所示。

    | 参数分类       | 参数名称        | 必填 | 说明                     | 示例                                 |
    | -------------- | --------------- | ---- | ------------------------ | ------------------------------------ |
    | IdP元数据      | IdP Entity ID   | 是   | 身份提供者实体标识       | https://idp.company.com/metadata     |
    | IdP元数据      | IdP SSO URL     | 是   | 单点登录端点             | https://idp.company.com/sso          |
    | IdP元数据      | IdP SLO URL     | 否   | 单点登出端点             | https://idp.company.com/slo          |
    | IdP元数据      | IdP Certificate | 是   | IdP签名证书（X.509 PEM） | -----BEGIN CERTIFICATE-----...       |
    | SP参数（自动） | SP Entity ID    | 自动 | 系统自动生成             | https://app.clarisphere.com/saml/sp  |
    | SP参数（自动） | SP ACS URL      | 自动 | 断言消费服务URL          | https://app.clarisphere.com/saml/acs |
    | 属性映射       | 用户名属性      | 是   | SAML断言中的用户名属性名 | NameID 或 username                   |
    | 属性映射       | 邮箱属性        | 是   | SAML断言中的邮箱属性名   | email                                |
    | 属性映射       | 姓名属性        | 否   | SAML断言中的姓名属性名   | displayName                          |

    表 4.1.5.1-1 SAML配置参数

#### 4.1.5.2 SSO-OIDC配置

+   OIDC协议配置所需参数如下表所示。

    | 参数分类     | 参数名称          | 必填 | 说明                          | 示例                                      |
    | ------------ | ----------------- | ---- | ----------------------------- | ----------------------------------------- |
    | Provider端点 | Issuer            | 是   | OIDC颁发者URL                 | https://auth.company.com                  |
    | Provider端点 | Authorization URL | 是   | 授权端点                      | https://auth.company.com/authorize        |
    | Provider端点 | Token URL         | 是   | 令牌端点                      | https://auth.company.com/token            |
    | Provider端点 | UserInfo URL      | 否   | 用户信息端点                  | https://auth.company.com/userinfo         |
    | Provider端点 | JWKS URL          | 是   | JSON Web Key Set端点          | https://auth.company.com/.well-known/jwks |
    | Client参数   | Client ID         | 是   | 客户端标识                    | clarisphere-{tenantId}                    |
    | Client参数   | Client Secret     | 是   | 客户端密钥（AES-256加密存储） | ******                                    |
    | Client参数   | Scopes            | 是   | 请求的权限范围                | openid profile email                      |
    | 回调（自动） | Redirect URI      | 自动 | 系统自动生成                  | https://app.clarisphere.com/oidc/callback |
    | 属性映射     | 用户名Claim       | 是   | ID Token中的用户名字段        | preferred_username                        |
    | 属性映射     | 邮箱Claim         | 是   | ID Token中的邮箱字段          | email                                     |

    表 4.1.5.2-1 OIDC配置参数

### 4.1.6 LDAP/AD配置场景

#### 4.1.6.1 场景特点

+   LDAP/AD配置让租户对接企业Active Directory或OpenLDAP：
    -   BC-11存储LDAP服务器连接参数
    -   BC-10使用这些参数执行LDAP Bind认证和用户同步
    -   支持连接测试功能，配置保存前先验证连通性

#### 4.1.6.2 LDAP配置参数

+   LDAP/AD配置所需参数如下表所示。

    | 参数分类   | 参数名称           | 必填 | 说明                        | 示例                                        |
    | ---------- | ------------------ | ---- | --------------------------- | ------------------------------------------- |
    | 服务器连接 | Server URL         | 是   | LDAP服务器地址              | ldaps://ad.company.com:636                  |
    | 服务器连接 | Base DN            | 是   | 搜索基准DN                  | dc=company,dc=com                           |
    | 服务器连接 | Bind DN            | 是   | 绑定DN（服务账号）          | cn=svc-clarisphere,ou=Services,dc=company   |
    | 服务器连接 | Bind Password      | 是   | 绑定密码（AES-256加密存储） | ******                                      |
    | 连接参数   | Connection Timeout | 否   | 连接超时（毫秒），默认5000  | 5000                                        |
    | 连接参数   | Read Timeout       | 否   | 读取超时（毫秒），默认10000 | 10000                                       |
    | 连接参数   | Use SSL            | 否   | 是否使用SSL，默认true       | true                                        |
    | 用户搜索   | User Search Base   | 是   | 用户搜索起点                | ou=Users,dc=company,dc=com                  |
    | 用户搜索   | User Search Filter | 是   | 用户搜索过滤器              | (&(objectClass=person)(sAMAccountName={0})) |
    | 属性映射   | 用户名属性         | 是   | LDAP中的用户名属性          | sAMAccountName                              |
    | 属性映射   | 邮箱属性           | 是   | LDAP中的邮箱属性            | mail                                        |
    | 属性映射   | 姓名属性           | 否   | LDAP中的姓名属性            | displayName                                 |
    | 属性映射   | 部门属性           | 否   | LDAP中的部门属性            | department                                  |
    | 同步配置   | 启用自动同步       | 否   | 是否启用定时同步，默认false | true                                        |
    | 同步配置   | 同步频率（Cron）   | 否   | 同步定时表达式              | 0 0 2 \* \* ?（每天凌晨2点）                |
    | 同步配置   | 同步范围过滤器     | 否   | 同步时的用户过滤条件        | (&(objectClass=person)(department=IT))      |

    表 4.1.6.2-1 LDAP配置参数

### 4.1.7 场景与流程映射

+   租户配置场景与流程映射如下表所示。

    | 场景编号  | 场景名称     | 关联流程         | 流程编号  |
    | --------- | ------------ | ---------------- | --------- |
    | SC-CFG-01 | 基本信息维护 | 租户信息编辑流程 | FL-CFG-01 |
    | SC-CFG-02 | 邮箱域名配置 | 邮箱域名管理流程 | FL-CFG-02 |
    | SC-CFG-03 | 认证方式选择 | 认证方式切换流程 | FL-CFG-03 |
    | SC-CFG-04 | SSO-SAML配置 | SSO配置流程      | FL-CFG-04 |
    | SC-CFG-05 | SSO-OIDC配置 | SSO配置流程      | FL-CFG-04 |
    | SC-CFG-06 | LDAP/AD配置  | LDAP配置流程     | FL-CFG-05 |

    表 4.1.7-1 场景与流程映射

## 4.2 业务流程设计

### 4.2.1 流程层级说明

+   租户配置子领域包含5个业务流程，流程层级如下表所示。

    | 流程编号  | 流程名称         | 层级 | 触发方式   | 说明                       |
    | --------- | ---------------- | ---- | ---------- | -------------------------- |
    | FL-CFG-01 | 租户信息编辑流程 | 用例 | UR手动操作 | 租户管理员修改企业基本信息 |
    | FL-CFG-02 | 邮箱域名管理流程 | 用例 | UR手动操作 | 增删改企业邮箱域名列表     |
    | FL-CFG-03 | 认证方式切换流程 | 用例 | UR手动操作 | 切换登录认证方式           |
    | FL-CFG-04 | SSO配置流程      | 用例 | UR手动操作 | 配置SAML或OIDC单点登录参数 |
    | FL-CFG-05 | LDAP配置流程     | 用例 | UR手动操作 | 配置LDAP/AD服务器连接参数  |

    表 4.2.1-1 流程层级说明

### 4.2.2 FL-CFG-01 租户信息编辑流程

#### 4.2.2.1 流程概述

    | 属性     | 内容                                       |
    | -------- | ------------------------------------------ |
    | 流程编号 | FL-CFG-01                                  |
    | 流程名称 | 租户信息编辑流程                           |
    | 触发条件 | 租户管理员进入"租户设置→基本信息"页面编辑  |
    | 前置条件 | 租户状态为TRIAL/ACTIVE/SUSPENDED           |
    | 后置条件 | 租户配置记录更新，同步更新Tenant联系人信息 |
    | 主要角色 | 租户管理员                                 |

    表 4.2.2.1-1 FL-CFG-01 流程概述

#### 4.2.2.2 流程步骤

+   租户信息编辑流程步骤如下：
    -   **步骤1**：租户管理员进入"租户设置→基本信息"页面
    -   **步骤2**：系统加载当前租户配置信息
    -   **步骤3**：管理员修改目标字段（企业名称、联系人、行业等）
    -   **步骤4**：系统校验字段合法性
        -   企业名称：2-128字符，全局唯一（排除自身）
        -   联系人邮箱：合法邮箱格式
        -   联系人电话：合法手机号格式（选填）
    -   **步骤5**：系统更新TenantConfig记录
    -   **步骤6**：若修改了联系人信息，同步更新Tenant聚合的ContactInfo（保持数据一致）
    -   **步骤7**：发布TenantConfigUpdated领域事件

### 4.2.3 FL-CFG-02 邮箱域名管理流程

#### 4.2.3.1 流程概述

    | 属性     | 内容                                      |
    | -------- | ----------------------------------------- |
    | 流程编号 | FL-CFG-02                                 |
    | 流程名称 | 邮箱域名管理流程                          |
    | 触发条件 | 租户管理员进入"租户设置→邮箱域名"页面操作 |
    | 前置条件 | 租户状态为TRIAL/ACTIVE                    |
    | 后置条件 | 邮箱域名列表更新                          |
    | 主要角色 | 租户管理员                                |

    表 4.2.3.1-1 FL-CFG-02 流程概述

#### 4.2.3.2 流程步骤

+   邮箱域名管理流程步骤如下：

+   **添加域名**：
    -   **步骤1**：管理员输入域名（如@icbc.com.cn）
    -   **步骤2**：系统校验域名格式（ED-R-01）
    -   **步骤3**：系统校验域名数量上限（ED-R-02，最多10个）
    -   **步骤4**：系统校验全局唯一性（ED-R-03，不可被其他租户使用）
    -   **步骤5**：域名添加成功

+   **删除域名**：
    -   **步骤1**：管理员选择要删除的域名
    -   **步骤2**：系统提示"删除域名不影响已注册用户，仅阻止新用户使用此域名注册"
    -   **步骤3**：管理员确认删除
    -   **步骤4**：域名删除成功

### 4.2.4 FL-CFG-03 认证方式切换流程

#### 4.2.4.1 流程概述

    | 属性     | 内容                                             |
    | -------- | ------------------------------------------------ |
    | 流程编号 | FL-CFG-03                                        |
    | 流程名称 | 认证方式切换流程                                 |
    | 触发条件 | 租户管理员在"租户设置→认证配置"页面切换方式      |
    | 前置条件 | 租户状态为TRIAL/ACTIVE，且目标认证方式已完成配置 |
    | 后置条件 | 租户认证方式切换，发布AuthMethodChanged事件      |
    | 主要角色 | 租户管理员                                       |

    表 4.2.4.1-1 FL-CFG-03 流程概述

#### 4.2.4.2 流程步骤

+   认证方式切换流程步骤如下：
    -   **步骤1**：管理员选择目标认证方式（LOCAL / SSO_SAML / SSO_OIDC / LDAP）
    -   **步骤2**：系统检查目标认证方式是否已完成配置
        -   SSO_SAML：需已配置IdP Entity ID、SSO URL、Certificate
        -   SSO_OIDC：需已配置Issuer、Authorization URL、Token URL、Client ID/Secret
        -   LDAP：需已配置Server URL、Base DN、Bind DN/Password
        -   若未完成配置，提示"请先完成{方式}配置"并跳转对应配置页
    -   **步骤3**：系统弹出切换确认对话框，说明影响：
        -   切换到SSO：已有的本地密码仍然保留，但登录时将重定向至IdP
        -   切换到LDAP：登录时将使用LDAP Bind验证，本地密码不再生效
        -   切回LOCAL：恢复使用本地密码登录
    -   **步骤4**：管理员确认切换
    -   **步骤5**：系统更新TenantConfig.authMethod
    -   **步骤6**：发布AuthMethodChanged领域事件
    -   **步骤7**：BC-10收到事件后刷新缓存，后续登录请求使用新认证方式

### 4.2.5 FL-CFG-04 SSO配置流程

#### 4.2.5.1 流程概述

    | 属性     | 内容                                     |
    | -------- | ---------------------------------------- |
    | 流程编号 | FL-CFG-04                                |
    | 流程名称 | SSO配置流程                              |
    | 触发条件 | 租户管理员进入"租户设置→SSO配置"页面配置 |
    | 前置条件 | 租户状态为TRIAL/ACTIVE                   |
    | 后置条件 | SSO配置记录创建或更新                    |
    | 主要角色 | 租户管理员                               |

    表 4.2.5.1-1 FL-CFG-04 流程概述

#### 4.2.5.2 流程步骤

+   SSO配置流程步骤如下：
    -   **步骤1**：管理员选择SSO协议类型（SAML / OIDC）
    -   **步骤2**：系统展示对应协议的配置表单
        -   SAML：展示IdP元数据输入区域（支持手动填写和XML上传两种方式）
        -   OIDC：展示Provider端点和Client参数输入表单
    -   **步骤3**：管理员填写配置参数
    -   **步骤4**：系统校验参数合法性
        -   URL格式校验、证书格式校验
        -   OIDC的Client Secret必填
    -   **步骤5**：管理员点击"测试连接"（可选但推荐）
        -   SAML：尝试解析IdP元数据XML，验证证书有效性
        -   OIDC：尝试访问JWKS URL，验证可达性
    -   **步骤6**：系统保存SSO配置（sso_config表）
    -   **步骤7**：系统展示SP参数（ACS URL / Redirect URI），管理员需将其配置到企业IdP端

### 4.2.6 FL-CFG-05 LDAP配置流程

#### 4.2.6.1 流程概述

    | 属性     | 内容                                      |
    | -------- | ----------------------------------------- |
    | 流程编号 | FL-CFG-05                                 |
    | 流程名称 | LDAP配置流程                              |
    | 触发条件 | 租户管理员进入"租户设置→LDAP配置"页面配置 |
    | 前置条件 | 租户状态为TRIAL/ACTIVE                    |
    | 后置条件 | LDAP配置记录创建或更新                    |
    | 主要角色 | 租户管理员                                |

    表 4.2.6.1-1 FL-CFG-05 流程概述

#### 4.2.6.2 流程步骤

+   LDAP配置流程步骤如下：
    -   **步骤1**：管理员进入LDAP配置页面
    -   **步骤2**：系统展示服务器连接、用户搜索、属性映射、同步配置四个配置区域
    -   **步骤3**：管理员填写服务器连接参数（URL、Base DN、Bind DN/Password）
    -   **步骤4**：管理员点击"测试连接"
        -   系统使用填写的Bind DN/Password尝试LDAP Bind
        -   连接成功：显示绿色提示和服务器信息（如目录类型、版本）
        -   连接失败：显示红色错误信息（如连接超时、认证失败、证书错误）
    -   **步骤5**：管理员填写用户搜索参数（Search Base、Search Filter）
    -   **步骤6**：管理员点击"测试搜索"（可选）
        -   系统使用配置参数搜索并返回前5条用户记录预览
    -   **步骤7**：管理员配置属性映射（用户名、邮箱、姓名等LDAP属性名）
    -   **步骤8**：管理员选择是否启用自动同步及同步频率
    -   **步骤9**：系统保存LDAP配置（ldap_config表），敏感字段AES-256加密

## 4.3 领域模型设计

### 4.3.1 聚合划分

+   P1阶段租户配置子领域包含1个聚合，聚合划分如下表所示。

    | 聚合名称 | 聚合根       | 职责                   | 包含实体/值对象                                                        | 版本 |
    | -------- | ------------ | ---------------------- | ---------------------------------------------------------------------- | ---- |
    | 配置聚合 | TenantConfig | 租户个性化配置统一管理 | EmailDomain(VO), AuthConfig(VO), SsoConfig(Entity), LdapConfig(Entity) | P1   |

    表 4.3.1-1 P1聚合划分

+   **聚合设计决策**：
    -   SsoConfig和LdapConfig设计为实体而非值对象，因为它们有独立的生命周期（可独立创建、更新、删除）、较多属性且包含敏感数据（需独立加密存储）
    -   EmailDomain和AuthConfig设计为值对象，因为它们总是跟随TenantConfig整体读写

### 4.3.2 聚合关系图

+   TenantConfig聚合内部关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    TenantConfig聚合关系图                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────┐                                              │
    │   │   TenantConfig（聚合根）│                                              │
    │   │                         │                                              │
    │   │   tenantId              │                                              │
    │   │   tenantCode            │                                              │
    │   │   tenantName            │                                              │
    │   │   companyInfo           │                                              │
    │   │   authConfig ───────────┼────── AuthConfig（值对象）                   │
    │   │   emailDomains ─────────┼────── List<EmailDomain>（值对象）            │
    │   │                         │                                              │
    │   │   ssoConfig ────────────┼────── SsoConfig（实体，0..1）                │
    │   │   ldapConfig ───────────┼────── LdapConfig（实体，0..1）               │
    │   └─────────────────────────┘                                              │
    │                                                                             │
    │   ┌──────────────────┐     ┌──────────────────┐                            │
    │   │  SsoConfig       │     │  LdapConfig      │                            │
    │   │                  │     │                  │                            │
    │   │  protocol(枚举)  │     │  serverUrl       │                            │
    │   │  samlConfig{}    │     │  baseDn           │                            │
    │   │  oidcConfig{}    │     │  bindDn           │                            │
    │   │  attributeMapping│     │  userSearchBase   │                            │
    │   │  enabled         │     │  userSearchFilter │                            │
    │   │  testResult      │     │  attributeMapping │                            │
    │   └──────────────────┘     │  syncConfig{}     │                            │
    │                            │  enabled          │                            │
    │                            │  testResult       │                            │
    │                            └──────────────────┘                            │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.2-1 TenantConfig聚合关系图

### 4.3.3 TenantConfig 聚合根

#### 4.3.3.1 属性清单表

    | 属性名         | 类型               | 必填 | 业务含义             | 关联规则   |
    | -------------- | ------------------ | ---- | -------------------- | ---------- |
    | id             | Long               | 是   | 配置记录ID           | -          |
    | tenantId       | Long               | 是   | 所属租户ID           | -          |
    | tenantCode     | TenantCode         | 是   | 所属租户代号         | -          |
    | tenantName     | String             | 是   | 企业名称（可修改）   | CFG-R-01   |
    | companyLogo    | String             | 否   | 企业Logo URL         | CFG-R-02   |
    | contactName    | String             | 是   | 联系人姓名           | -          |
    | contactEmail   | String             | 是   | 联系人邮箱           | CI-R-01    |
    | contactPhone   | String             | 否   | 联系人电话           | CI-R-02    |
    | companyAddress | String             | 否   | 企业地址             | -          |
    | industry       | String             | 否   | 所属行业             | -          |
    | authConfig     | AuthConfig         | 是   | 认证配置             | CFG-R-03   |
    | emailDomains   | List\<EmailDomain> | 否   | 邮箱域名列表         | ED-R-01~04 |
    | ssoConfig      | SsoConfig          | 否   | SSO配置（按需创建）  | -          |
    | ldapConfig     | LdapConfig         | 否   | LDAP配置（按需创建） | -          |

    表 4.3.3.1-1 TenantConfig 属性清单

#### 4.3.3.2 业务规则表

    | 规则编号 | 规则名称       | 规则描述                                               | 异常响应 |
    | -------- | -------------- | ------------------------------------------------------ | -------- |
    | CFG-R-01 | 企业名称唯一   | 企业名称全局唯一（排除自身）                           | E-409501 |
    | CFG-R-02 | Logo格式约束   | 仅支持PNG/JPG/SVG，尺寸≤200x200px，大小≤1MB            | E-400010 |
    | CFG-R-03 | 认证切换前置   | 切换认证方式前，目标方式必须已完成配置                 | E-422510 |
    | CFG-R-04 | SSO配置完整性  | 切换到SSO方式时，对应协议的必填参数必须全部填写        | E-422511 |
    | CFG-R-05 | LDAP配置完整性 | 切换到LDAP方式时，服务器连接和用户搜索参数必须全部填写 | E-422512 |
    | CFG-R-06 | 联系人信息同步 | 修改联系人信息时，需同步更新Tenant聚合的ContactInfo    | -        |

    表 4.3.3.2-1 TenantConfig 业务规则

#### 4.3.3.3 业务方法表

    | 方法名            | 参数               | 返回值 | 业务描述         | 关联规则    | 领域事件            |
    | ----------------- | ------------------ | ------ | ---------------- | ----------- | ------------------- |
    | updateBasicInfo   | name, contact, ... | void   | 更新企业基本信息 | CFG-R-01    | TenantConfigUpdated |
    | addEmailDomain    | domain             | void   | 添加邮箱域名     | ED-R-01~03  | EmailDomainAdded    |
    | removeEmailDomain | domain             | void   | 删除邮箱域名     | ED-R-04     | EmailDomainRemoved  |
    | switchAuthMethod  | authMethod         | void   | 切换认证方式     | CFG-R-03~05 | AuthMethodChanged   |
    | saveSsoConfig     | ssoConfig          | void   | 保存SSO配置      | CFG-R-04    | SsoConfigUpdated    |
    | saveLdapConfig    | ldapConfig         | void   | 保存LDAP配置     | CFG-R-05    | LdapConfigUpdated   |
    | getEmailDomains   | -                  | List   | 获取邮箱域名列表 | -           | -                   |
    | getAuthConfig     | -                  | Config | 获取当前认证配置 | -           | -                   |

    表 4.3.3.3-1 TenantConfig 业务方法

### 4.3.4 AuthConfig 值对象

#### 4.3.4.1 属性清单表

    | 属性名     | 类型          | 必填 | 业务含义         | 关联规则 |
    | ---------- | ------------- | ---- | ---------------- | -------- |
    | authMethod | AuthMethod    | 是   | 当前认证方式     | CFG-R-03 |
    | changedAt  | LocalDateTime | 否   | 认证方式切换时间 | -        |
    | changedBy  | Long          | 否   | 切换操作人ID     | -        |

    表 4.3.4.1-1 AuthConfig 属性清单

#### 4.3.4.2 AuthMethod 枚举

    | 枚举值   | 说明         | 需要的配置      |
    | -------- | ------------ | --------------- |
    | LOCAL    | 本地认证     | 无需额外配置    |
    | SSO_SAML | SAML单点登录 | SsoConfig(SAML) |
    | SSO_OIDC | OIDC单点登录 | SsoConfig(OIDC) |
    | LDAP     | LDAP/AD认证  | LdapConfig      |

    表 4.3.4.2-1 AuthMethod 枚举值

### 4.3.5 EmailDomain 值对象

#### 4.3.5.1 属性清单表

    | 属性名  | 类型          | 必填 | 业务含义 | 关联规则 |
    | ------- | ------------- | ---- | -------- | -------- |
    | domain  | String        | 是   | 邮箱域名 | ED-R-01  |
    | addedAt | LocalDateTime | 是   | 添加时间 | -        |
    | addedBy | Long          | 是   | 添加人ID | -        |

    表 4.3.5.1-1 EmailDomain 属性清单

### 4.3.6 SsoConfig 实体

#### 4.3.6.1 属性清单表

    | 属性名             | 类型          | 必填   | 业务含义                  | 关联规则 |
    | ------------------ | ------------- | ------ | ------------------------- | -------- |
    | id                 | Long          | 是     | SSO配置ID                 | -        |
    | tenantId           | Long          | 是     | 所属租户ID                | -        |
    | protocol           | SsoProtocol   | 是     | SSO协议：SAML / OIDC      | -        |
    | enabled            | Boolean       | 是     | 是否启用                  | -        |
    | samlIdpEntityId    | String        | SAML时 | IdP Entity ID             | CFG-R-04 |
    | samlIdpSsoUrl      | String        | SAML时 | IdP SSO URL               | CFG-R-04 |
    | samlIdpSloUrl      | String        | 否     | IdP SLO URL               | -        |
    | samlIdpCertificate | String        | SAML时 | IdP签名证书（PEM）        | CFG-R-04 |
    | samlSpEntityId     | String        | 自动   | SP Entity ID（系统生成）  | -        |
    | samlSpAcsUrl       | String        | 自动   | SP ACS URL（系统生成）    | -        |
    | oidcIssuer         | String        | OIDC时 | OIDC Issuer URL           | CFG-R-04 |
    | oidcAuthUrl        | String        | OIDC时 | Authorization URL         | CFG-R-04 |
    | oidcTokenUrl       | String        | OIDC时 | Token URL                 | CFG-R-04 |
    | oidcUserInfoUrl    | String        | 否     | UserInfo URL              | -        |
    | oidcJwksUrl        | String        | OIDC时 | JWKS URL                  | CFG-R-04 |
    | oidcClientId       | String        | OIDC时 | Client ID                 | CFG-R-04 |
    | oidcClientSecret   | String        | OIDC时 | Client Secret（加密存储） | CFG-R-04 |
    | oidcScopes         | String        | OIDC时 | 请求的Scopes              | -        |
    | oidcRedirectUri    | String        | 自动   | Redirect URI（系统生成）  | -        |
    | attrUsername       | String        | 是     | 用户名属性映射            | -        |
    | attrEmail          | String        | 是     | 邮箱属性映射              | -        |
    | attrDisplayName    | String        | 否     | 姓名属性映射              | -        |
    | lastTestResult     | String        | 否     | 最后测试结果（JSON）      | -        |
    | lastTestAt         | LocalDateTime | 否     | 最后测试时间              | -        |
    | createdAt          | LocalDateTime | 是     | 创建时间                  | -        |
    | updatedAt          | LocalDateTime | 是     | 更新时间                  | -        |

    表 4.3.6.1-1 SsoConfig 属性清单

#### 4.3.6.2 SsoProtocol 枚举

    | 枚举值 | 说明           |
    | ------ | -------------- |
    | SAML   | SAML 2.0协议   |
    | OIDC   | OpenID Connect |

    表 4.3.6.2-1 SsoProtocol 枚举值

### 4.3.7 LdapConfig 实体

#### 4.3.7.1 属性清单表

    | 属性名            | 类型          | 必填 | 业务含义                | 关联规则 |
    | ----------------- | ------------- | ---- | ----------------------- | -------- |
    | id                | Long          | 是   | LDAP配置ID              | -        |
    | tenantId          | Long          | 是   | 所属租户ID              | -        |
    | enabled           | Boolean       | 是   | 是否启用                | -        |
    | serverUrl         | String        | 是   | LDAP服务器URL           | CFG-R-05 |
    | baseDn            | String        | 是   | 搜索基准DN              | CFG-R-05 |
    | bindDn            | String        | 是   | 绑定DN（服务账号）      | CFG-R-05 |
    | bindPassword      | String        | 是   | 绑定密码（加密存储）    | CFG-R-05 |
    | connectionTimeout | Integer       | 否   | 连接超时毫秒，默认5000  | -        |
    | readTimeout       | Integer       | 否   | 读取超时毫秒，默认10000 | -        |
    | useSsl            | Boolean       | 否   | 是否SSL，默认true       | -        |
    | userSearchBase    | String        | 是   | 用户搜索起点DN          | CFG-R-05 |
    | userSearchFilter  | String        | 是   | 用户搜索过滤器          | CFG-R-05 |
    | attrUsername      | String        | 是   | 用户名LDAP属性名        | -        |
    | attrEmail         | String        | 是   | 邮箱LDAP属性名          | -        |
    | attrDisplayName   | String        | 否   | 姓名LDAP属性名          | -        |
    | attrDepartment    | String        | 否   | 部门LDAP属性名          | -        |
    | syncEnabled       | Boolean       | 否   | 是否启用自动同步        | -        |
    | syncCron          | String        | 否   | 同步Cron表达式          | -        |
    | syncFilter        | String        | 否   | 同步范围过滤器          | -        |
    | lastSyncAt        | LocalDateTime | 否   | 最后同步时间            | -        |
    | lastSyncCount     | Integer       | 否   | 最后同步用户数          | -        |
    | lastTestResult    | String        | 否   | 最后测试结果（JSON）    | -        |
    | lastTestAt        | LocalDateTime | 否   | 最后测试时间            | -        |
    | createdAt         | LocalDateTime | 是   | 创建时间                | -        |
    | updatedAt         | LocalDateTime | 是   | 更新时间                | -        |

    表 4.3.7.1-1 LdapConfig 属性清单

### 4.3.8 领域服务

#### 4.3.8.1 TenantConfigService

+   租户配置领域服务，协调配置的读写和跨聚合同步。

    | 方法名              | 参数                 | 返回值          | 业务描述                                           | 调用方                 |
    | ------------------- | -------------------- | --------------- | -------------------------------------------------- | ---------------------- |
    | initConfigForTenant | tenantId, tenantCode | TenantConfig    | 租户激活时初始化默认配置（LOCAL认证，空域名）      | TenantProvisioningSaga |
    | getConfig           | tenantId             | TenantConfigDTO | 查询租户完整配置摘要（基本信息+认证+SSO/LDAP状态） | ConfigQueryAppService  |
    | updateBasicInfo     | tenantId, command    | void            | 更新基本信息，联动Tenant.ContactInfo同步           | ConfigCommandService   |
    | getEmailDomains     | tenantId             | List<String>    | 查询邮箱域名列表（BC-10 RPC调用）                  | TenantConfigRpc        |
    | getAuthConfig       | tenantId             | AuthConfigDTO   | 查询认证配置（BC-10 RPC调用）                      | TenantConfigRpc        |
    | getSsoConfig        | tenantId             | SsoConfigDTO    | 查询SSO配置（BC-10 RPC调用）                       | TenantConfigRpc        |
    | getLdapConfig       | tenantId             | LdapConfigDTO   | 查询LDAP配置（BC-10 RPC调用）                      | TenantConfigRpc        |

    表 4.3.8.1-1 TenantConfigService 方法

#### 4.3.8.2 ConnectionTestService

+   连接测试领域服务，验证SSO和LDAP配置的连通性。

    | 方法名         | 参数       | 返回值     | 业务描述                              |
    | -------------- | ---------- | ---------- | ------------------------------------- |
    | testSso        | ssoConfig  | TestResult | 测试SSO连通性（SAML元数据/OIDC JWKS） |
    | testLdap       | ldapConfig | TestResult | 测试LDAP Bind连通性                   |
    | testLdapSearch | ldapConfig | List<User> | 测试LDAP用户搜索，返回前5条预览       |

    表 4.3.8.2-1 ConnectionTestService 方法

### 4.3.9 领域事件

+   租户配置子领域发布的领域事件如下表所示。

    | 事件名称            | 触发时机           | Payload                                    | 消费方 |
    | ------------------- | ------------------ | ------------------------------------------ | ------ |
    | TenantConfigUpdated | 基本信息修改       | tenantId, tenantCode, changedFields        | BC-10  |
    | EmailDomainAdded    | 添加邮箱域名       | tenantId, tenantCode, domain               | BC-10  |
    | EmailDomainRemoved  | 删除邮箱域名       | tenantId, tenantCode, domain               | BC-10  |
    | AuthMethodChanged   | 认证方式切换       | tenantId, tenantCode, oldMethod, newMethod | BC-10  |
    | SsoConfigUpdated    | SSO配置保存或更新  | tenantId, tenantCode, protocol, enabled    | BC-10  |
    | LdapConfigUpdated   | LDAP配置保存或更新 | tenantId, tenantCode, serverUrl, enabled   | BC-10  |

    表 4.3.9-1 租户配置领域事件

+   **消费方说明**：
    -   BC-10需收到EmailDomain/AuthMethod/SSO/LDAP变更事件后刷新本地缓存，确保下次认证请求使用最新配置
    -   BC-10记录所有配置变更的审计日志

### 4.3.10 协作关系

#### 4.3.10.1 与租户生命周期子领域的协作

    | 协作场景             | 发起方 | 协作方式                               | 说明                             |
    | -------------------- | ------ | -------------------------------------- | -------------------------------- |
    | 租户激活时初始化配置 | 第3章  | 事件驱动：TenantActivated → initConfig | TenantProvisioningSaga编排       |
    | 修改联系人信息同步   | 第4章  | 内部调用：Tenant.updateContactInfo     | 保持Tenant与TenantConfig的一致性 |
    | 租户注销时归档配置   | 第3章  | 事件驱动：TenantDeactivated → 归档     | SSO/LDAP配置一并清理             |
    | 修改企业名称同步     | 第4章  | 内部调用：Tenant.updateTenantName      | 保持企业名称一致                 |

    表 4.3.10.1-1 与租户生命周期协作

#### 4.3.10.2 跨BC协作

    | 协作BC | 协作方向    | 协作内容                           | 协作方式 |
    | ------ | ----------- | ---------------------------------- | -------- |
    | BC-10  | BC-10→BC-11 | 查询邮箱域名列表（用户注册时校验） | RPC调用  |
    | BC-10  | BC-10→BC-11 | 查询认证配置（登录时路由认证方式） | RPC调用  |
    | BC-10  | BC-10→BC-11 | 查询SSO配置（执行SSO认证流程）     | RPC调用  |
    | BC-10  | BC-10→BC-11 | 查询LDAP配置（执行LDAP Bind认证）  | RPC调用  |
    | BC-10  | BC-11→BC-10 | 配置变更事件（刷新认证缓存）       | 领域事件 |
    | BC-10  | BC-11→BC-10 | 配置变更审计日志                   | 领域事件 |

    表 4.3.10.2-1 跨BC协作

## 4.4 接口设计

### 4.4.1 接口总览

+   租户配置子领域接口分类如下：

    | 接口类型 | 数量 | 说明                                   |
    | -------- | ---- | -------------------------------------- |
    | REST API | 9    | UR配置管理9个                          |
    | RPC接口  | 4    | BC-10查询邮箱域名、认证配置、SSO、LDAP |
    | 消息接口 | 6    | 配置变更事件6个                        |

    表 4.4.1-1 接口分类统计

#### 4.4.1.1 REST API清单

    | API编号   | API名称          | 方法   | 路径                                                  | 权限                    | 领域方法                                 | 备注 |
    | --------- | ---------------- | ------ | ----------------------------------------------------- | ----------------------- | ---------------------------------------- | ---- |
    | UR-CFG-01 | 查询租户配置     | GET    | /api/v1/tenant/settings/config                        | ur:tenant:config:read   | TenantConfigService.getConfig            | UR   |
    | UR-CFG-02 | 更新基本信息     | PUT    | /api/v1/tenant/settings/config/basic                  | ur:tenant:config:update | TenantConfig.updateBasicInfo             | UR   |
    | UR-CFG-03 | 获取邮箱域名列表 | GET    | /api/v1/tenant/settings/config/email-domains          | ur:tenant:config:read   | TenantConfig.getEmailDomains             | UR   |
    | UR-CFG-04 | 添加邮箱域名     | POST   | /api/v1/tenant/settings/config/email-domains          | ur:tenant:config:update | TenantConfig.addEmailDomain              | UR   |
    | UR-CFG-05 | 删除邮箱域名     | DELETE | /api/v1/tenant/settings/config/email-domains/{domain} | ur:tenant:config:update | TenantConfig.removeEmailDomain           | UR   |
    | UR-CFG-06 | 切换认证方式     | POST   | /api/v1/tenant/settings/config/auth-method            | ur:tenant:config:update | TenantConfig.switchAuthMethod            | UR   |
    | UR-CFG-07 | 保存SSO配置      | PUT    | /api/v1/tenant/settings/config/sso                    | ur:tenant:config:update | TenantConfig.saveSsoConfig               | UR   |
    | UR-CFG-08 | 保存LDAP配置     | PUT    | /api/v1/tenant/settings/config/ldap                   | ur:tenant:config:update | TenantConfig.saveLdapConfig              | UR   |
    | UR-CFG-09 | 测试连接         | POST   | /api/v1/tenant/settings/config/test-connection        | ur:tenant:config:update | ConnectionTestService.testSso / testLdap | UR   |

    表 4.4.1.1-1 REST API清单

#### 4.4.1.2 RPC接口清单

    | 接口编号   | 接口名称     | Feign方法       | 说明                    |
    | ---------- | ------------ | --------------- | ----------------------- |
    | RPC-CFG-01 | 查询邮箱域名 | getEmailDomains | BC-10用户注册时校验域名 |
    | RPC-CFG-02 | 查询认证配置 | getAuthConfig   | BC-10登录时路由认证方式 |
    | RPC-CFG-03 | 查询SSO配置  | getSsoConfig    | BC-10执行SSO认证流程    |
    | RPC-CFG-04 | 查询LDAP配置 | getLdapConfig   | BC-10执行LDAP Bind认证  |

    表 4.4.1.2-1 RPC接口清单

#### 4.4.1.3 消息接口清单

    | 事件编号   | 事件名称            | Topic         | 消费方 |
    | ---------- | ------------------- | ------------- | ------ |
    | MSG-CFG-01 | TenantConfigUpdated | tenant.events | BC-10  |
    | MSG-CFG-02 | EmailDomainAdded    | tenant.events | BC-10  |
    | MSG-CFG-03 | EmailDomainRemoved  | tenant.events | BC-10  |
    | MSG-CFG-04 | AuthMethodChanged   | tenant.events | BC-10  |
    | MSG-CFG-05 | SsoConfigUpdated    | tenant.events | BC-10  |
    | MSG-CFG-06 | LdapConfigUpdated   | tenant.events | BC-10  |

    表 4.4.1.3-1 消息接口清单

### 4.4.2 RPC接口设计

#### 4.4.2.1 RPC-CFG-01 getEmailDomains 查询邮箱域名

+   契约概述

    | 项目     | 内容                                                 |
    | -------- | ---------------------------------------------------- |
    | API编号  | RPC-CFG-01                                           |
    | 接口路径 | GET /internal/tenant/config/{tenantId}/email-domains |
    | 功能简述 | 查询指定租户配置的企业邮箱域名列表                   |
    | 所需权限 | 内部调用                                             |
    | 关联用例 | BC-10开放注册时校验邮箱域名（FL-UR-02, TU-R-04）     |
    | 幂等性   | 是（读操作）                                         |

    表 4.4.2.1-1 RPC-CFG-01 契约概述

+   请求参数

    | 参数名   | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | -------- | ---- | ---- | ---- | ------ | ------ | -------- |
    | tenantId | path | Long | 是   | 正整数 | 1001   | 租户ID   |

    表 4.4.2.1-2 请求参数

+   响应参数

    | 参数名  | 类型         | 必有 | 示例值                       | 业务含义 |
    | ------- | ------------ | ---- | ---------------------------- | -------- |
    | domains | List<String> | 是   | ["@icbc.com.cn","@icbc.com"] | 域名列表 |

    表 4.4.2.1-3 响应参数

+   降级策略：Fallback返回空列表。效果：开放注册时无法校验域名，拒绝注册（安全优先）。

#### 4.4.2.2 RPC-CFG-02 getAuthConfig 查询认证配置

+   契约概述

    | 项目     | 内容                                        |
    | -------- | ------------------------------------------- |
    | API编号  | RPC-CFG-02                                  |
    | 接口路径 | GET /internal/tenant/config/{tenantId}/auth |
    | 功能简述 | 查询指定租户当前认证方式                    |
    | 所需权限 | 内部调用                                    |
    | 关联用例 | BC-10登录时根据认证方式路由到不同认证流程   |
    | 幂等性   | 是（读操作）                                |

    表 4.4.2.2-1 RPC-CFG-02 契约概述

+   响应参数

    | 参数名      | 类型    | 必有 | 示例值   | 业务含义         |
    | ----------- | ------- | ---- | -------- | ---------------- |
    | authMethod  | String  | 是   | SSO_SAML | 当前认证方式枚举 |
    | ssoEnabled  | Boolean | 是   | true     | SSO是否已启用    |
    | ldapEnabled | Boolean | 是   | false    | LDAP是否已启用   |

    表 4.4.2.2-2 响应参数

+   降级策略：Fallback返回authMethod=LOCAL。效果：SSO/LDAP不可用时回退到本地认证，保障基本登录。

#### 4.4.2.3 RPC-CFG-03 getSsoConfig 查询SSO配置

+   契约概述

    | 项目     | 内容                                         |
    | -------- | -------------------------------------------- |
    | API编号  | RPC-CFG-03                                   |
    | 接口路径 | GET /internal/tenant/config/{tenantId}/sso   |
    | 功能简述 | 查询指定租户的SSO配置（SAML或OIDC全量参数）  |
    | 所需权限 | 内部调用                                     |
    | 关联用例 | BC-10执行SSO认证流程时获取IdP元数据/OIDC端点 |
    | 幂等性   | 是（读操作）                                 |

    表 4.4.2.3-1 RPC-CFG-03 契约概述

+   响应参数

    | 参数名             | 类型   | 必有   | 示例值                       | 业务含义          |
    | ------------------ | ------ | ------ | ---------------------------- | ----------------- |
    | protocol           | String | 是     | SAML                         | SSO协议类型       |
    | samlIdpEntityId    | String | SAML时 | https://idp.company.com/...  | IdP Entity ID     |
    | samlIdpSsoUrl      | String | SAML时 | https://idp.company.com/sso  | IdP SSO URL       |
    | samlIdpSloUrl      | String | 否     | -                            | IdP SLO URL       |
    | samlIdpCertificate | String | SAML时 | PEM证书内容                  | IdP签名证书       |
    | samlSpEntityId     | String | SAML时 | https://app.../saml/sp       | SP Entity ID      |
    | samlSpAcsUrl       | String | SAML时 | https://app.../saml/acs      | SP ACS URL        |
    | oidcIssuer         | String | OIDC时 | https://auth.company.com     | Issuer URL        |
    | oidcAuthUrl        | String | OIDC时 | .../authorize                | Authorization URL |
    | oidcTokenUrl       | String | OIDC时 | .../token                    | Token URL         |
    | oidcJwksUrl        | String | OIDC时 | .../.well-known/jwks         | JWKS URL          |
    | oidcClientId       | String | OIDC时 | clarisphere-citic            | Client ID         |
    | oidcClientSecret   | String | OIDC时 | 解密后的Secret               | Client Secret     |
    | oidcScopes         | String | OIDC时 | openid profile email         | Scopes            |
    | oidcRedirectUri    | String | OIDC时 | https://app.../oidc/callback | Redirect URI      |
    | attrUsername       | String | 是     | NameID                       | 用户名属性映射    |
    | attrEmail          | String | 是     | email                        | 邮箱属性映射      |
    | attrDisplayName    | String | 否     | displayName                  | 姓名属性映射      |

    表 4.4.2.3-2 响应参数

+   降级策略：Fallback抛出ServiceUnavailableException，BC-10返回"SSO服务暂时不可用，请使用本地密码登录"。
+   **安全说明**：Client Secret在BC-11数据库中AES-256加密存储，RPC返回时解密传输（服务间通信走内网mTLS）。

#### 4.4.2.4 RPC-CFG-04 getLdapConfig 查询LDAP配置

+   契约概述

    | 项目     | 内容                                            |
    | -------- | ----------------------------------------------- |
    | API编号  | RPC-CFG-04                                      |
    | 接口路径 | GET /internal/tenant/config/{tenantId}/ldap     |
    | 功能简述 | 查询指定租户的LDAP/AD配置（连接参数和属性映射） |
    | 所需权限 | 内部调用                                        |
    | 关联用例 | BC-10执行LDAP Bind认证和用户同步                |
    | 幂等性   | 是（读操作）                                    |

    表 4.4.2.4-1 RPC-CFG-04 契约概述

+   响应参数

    | 参数名            | 类型    | 必有 | 示例值                     | 业务含义      |
    | ----------------- | ------- | ---- | -------------------------- | ------------- |
    | serverUrl         | String  | 是   | ldaps://ad.company.com:636 | LDAP服务器URL |
    | baseDn            | String  | 是   | dc=company,dc=com          | 搜索基准DN    |
    | bindDn            | String  | 是   | cn=svc-clarisphere,...     | 绑定DN        |
    | bindPassword      | String  | 是   | 解密后的密码               | 绑定密码      |
    | connectionTimeout | Integer | 是   | 5000                       | 连接超时      |
    | readTimeout       | Integer | 是   | 10000                      | 读取超时      |
    | useSsl            | Boolean | 是   | true                       | 是否SSL       |
    | userSearchBase    | String  | 是   | ou=Users,dc=company,dc=com | 用户搜索起点  |
    | userSearchFilter  | String  | 是   | (&(objectClass=person)...) | 搜索过滤器    |
    | attrUsername      | String  | 是   | sAMAccountName             | 用户名属性    |
    | attrEmail         | String  | 是   | mail                       | 邮箱属性      |
    | attrDisplayName   | String  | 否   | displayName                | 姓名属性      |
    | attrDepartment    | String  | 否   | department                 | 部门属性      |
    | syncEnabled       | Boolean | 是   | true                       | 是否启用同步  |
    | syncCron          | String  | 否   | 0 0 2 \* \* ?              | 同步Cron      |
    | syncFilter        | String  | 否   | -                          | 同步过滤器    |

    表 4.4.2.4-2 响应参数

+   降级策略：Fallback抛出ServiceUnavailableException，BC-10返回"LDAP服务暂时不可用，请使用本地密码登录"。

### 4.4.3 消息接口设计

+   租户配置的6个领域事件均通过tenant.events主题发布，遵循第3章定义的CloudEvents信封格式和Outbox模式。
+   关键事件Payload示例：

#### 4.4.3.1 MSG-CFG-04 AuthMethodChanged

+   Payload

    | 字段名     | 类型   | 必有 | 示例值               | 业务含义       |
    | ---------- | ------ | ---- | -------------------- | -------------- |
    | tenantId   | Long   | 是   | 1001                 | 租户ID         |
    | tenantCode | String | 是   | citic                | 租户代号       |
    | oldMethod  | String | 是   | LOCAL                | 变更前认证方式 |
    | newMethod  | String | 是   | SSO_SAML             | 变更后认证方式 |
    | changedBy  | Long   | 是   | 20001                | 操作人ID       |
    | changedAt  | String | 是   | 2026-02-02T10:00:00Z | 变更时间       |

    表 4.4.3.1-1 AuthMethodChanged Payload

+   **BC-10消费逻辑**：
    -   收到AuthMethodChanged事件后，刷新该租户的认证方式缓存
    -   若newMethod为SSO_SAML/SSO_OIDC/LDAP，主动预加载对应配置到本地缓存
    -   后续该租户用户登录时，BC-10根据缓存中的authMethod路由到对应认证流程

### 4.4.4 REST接口设计

#### 4.4.4.1 UR-CFG-01 查询租户配置

+   契约概述

    | 项目     | 内容                               |
    | -------- | ---------------------------------- |
    | API编号  | UR-CFG-01                          |
    | 接口路径 | GET /api/v1/tenant/settings/config |
    | 功能简述 | 查询当前租户的完整配置信息         |
    | 所需权限 | ur:tenant:config:read              |
    | 关联功能 | PG-UR-CFG-01 租户设置首页          |
    | 幂等性   | 是（读操作）                       |

    表 4.4.4.1-1 UR-CFG-01 契约概述

+   响应参数

    | 参数名         | 类型         | 必有 | 示例值               | 业务含义       |
    | -------------- | ------------ | ---- | -------------------- | -------------- |
    | tenantId       | Long         | 是   | 1001                 | 租户ID         |
    | tenantCode     | String       | 是   | citic                | 租户代号       |
    | tenantName     | String       | 是   | 中信银行             | 企业名称       |
    | companyLogo    | String       | 否   | https://...          | Logo URL       |
    | contactName    | String       | 是   | 张三                 | 联系人         |
    | contactEmail   | String       | 是   | zhangsan@icbc.com.cn | 联系人邮箱     |
    | contactPhone   | String       | 否   | 13700137000          | 联系人电话     |
    | companyAddress | String       | 否   | 北京市朝阳区...      | 企业地址       |
    | industry       | String       | 否   | 金融                 | 所属行业       |
    | authMethod     | String       | 是   | SSO_SAML             | 当前认证方式   |
    | emailDomains   | List<String> | 是   | ["@icbc.com.cn"]     | 邮箱域名列表   |
    | ssoConfigured  | Boolean      | 是   | true                 | SSO是否已配置  |
    | ssoProtocol    | String       | 否   | SAML                 | SSO协议类型    |
    | ldapConfigured | Boolean      | 是   | false                | LDAP是否已配置 |

    表 4.4.4.1-2 响应参数

#### 4.4.4.2 UR-CFG-07 保存SSO配置

+   契约概述

    | 项目       | 内容                                             |
    | ---------- | ------------------------------------------------ |
    | API编号    | UR-CFG-07                                        |
    | 接口路径   | PUT /api/v1/tenant/settings/config/sso           |
    | 功能简述   | 保存或更新当前租户的SSO配置                      |
    | 所需权限   | ur:tenant:config:update                          |
    | 关联功能   | PG-UR-CFG-03 SSO配置页                           |
    | 关联规则   | CFG-R-04（SSO配置完整性）                        |
    | 幂等性     | 是（相同参数多次调用结果一致）                   |
    | 关联错误码 | E-400010（参数格式错误）, E-422511（配置不完整） |

    表 4.4.4.2-1 UR-CFG-07 契约概述

+   请求参数

    | 参数名           | 位置 | 类型   | 必填   | 约束            | 示例值                   | 业务含义          |
    | ---------------- | ---- | ------ | ------ | --------------- | ------------------------ | ----------------- |
    | protocol         | body | String | 是     | 枚举：SAML/OIDC | SAML                     | SSO协议类型       |
    | idpEntityId      | body | String | SAML时 | 合法URL         | https://idp.../metadata  | IdP Entity ID     |
    | idpSsoUrl        | body | String | SAML时 | 合法URL         | https://idp.../sso       | IdP SSO URL       |
    | idpSloUrl        | body | String | 否     | 合法URL         | -                        | IdP SLO URL       |
    | idpCertificate   | body | String | SAML时 | X.509 PEM格式   | -----BEGIN CERT...       | IdP签名证书       |
    | issuer           | body | String | OIDC时 | 合法URL         | https://auth.company.com | OIDC Issuer       |
    | authorizationUrl | body | String | OIDC时 | 合法URL         | .../authorize            | Authorization URL |
    | tokenUrl         | body | String | OIDC时 | 合法URL         | .../token                | Token URL         |
    | userInfoUrl      | body | String | 否     | 合法URL         | .../userinfo             | UserInfo URL      |
    | jwksUrl          | body | String | OIDC时 | 合法URL         | .../.well-known/jwks     | JWKS URL          |
    | clientId         | body | String | OIDC时 | 非空            | clarisphere-citic        | Client ID         |
    | clientSecret     | body | String | OIDC时 | 非空            | ******                   | Client Secret     |
    | scopes           | body | String | OIDC时 | 非空            | openid profile email     | Scopes            |
    | attrUsername     | body | String | 是     | 非空            | NameID                   | 用户名属性映射    |
    | attrEmail        | body | String | 是     | 非空            | email                    | 邮箱属性映射      |
    | attrDisplayName  | body | String | 否     | -               | displayName              | 姓名属性映射      |

    表 4.4.4.2-2 请求参数

+   响应参数

    | 参数名      | 类型   | 必有 | 示例值                       | 业务含义     |
    | ----------- | ------ | ---- | ---------------------------- | ------------ |
    | protocol    | String | 是   | SAML                         | SSO协议类型  |
    | spEntityId  | String | 是   | https://app.../saml/sp       | SP Entity ID |
    | spAcsUrl    | String | SAML | https://app.../saml/acs      | SP ACS URL   |
    | redirectUri | String | OIDC | https://app.../oidc/callback | Redirect URI |
    | updatedAt   | String | 是   | 2026-02-02T10:00:00Z         | 更新时间     |

    表 4.4.4.2-3 响应参数

+   **使用指引**：保存成功后，系统返回SP参数（spEntityId、spAcsUrl或redirectUri），租户管理员需将这些参数配置到企业IdP端才能完成SSO集成。

#### 4.4.4.3 UR-CFG-09 测试连接

+   契约概述

    | 项目     | 内容                                                |
    | -------- | --------------------------------------------------- |
    | API编号  | UR-CFG-09                                           |
    | 接口路径 | POST /api/v1/tenant/settings/config/test-connection |
    | 功能简述 | 测试SSO或LDAP配置的连通性                           |
    | 所需权限 | ur:tenant:config:update                             |
    | 幂等性   | 是（测试操作，不修改数据）                          |

    表 4.4.4.3-1 UR-CFG-09 契约概述

+   请求参数

    | 参数名 | 位置 | 类型   | 必填 | 约束                         | 示例值 | 业务含义     |
    | ------ | ---- | ------ | ---- | ---------------------------- | ------ | ------------ |
    | type   | body | String | 是   | 枚举：SSO_SAML/SSO_OIDC/LDAP | LDAP   | 测试类型     |
    | config | body | Object | 是   | 对应类型的配置JSON           | {...}  | 待测试的配置 |

    表 4.4.4.3-2 请求参数

+   响应参数

    | 参数名   | 类型    | 必有 | 示例值                            | 业务含义     |
    | -------- | ------- | ---- | --------------------------------- | ------------ |
    | success  | Boolean | 是   | true                              | 测试是否成功 |
    | message  | String  | 是   | LDAP连接成功                      | 测试结果描述 |
    | details  | Object  | 否   | {"serverType":"AD","version":"3"} | 详细信息     |
    | testedAt | String  | 是   | 2026-02-02T10:00:00Z              | 测试时间     |

    表 4.4.4.3-3 响应参数

## 4.5 数据模型设计

### 4.5.1 平台库表结构（clarisphere_platform）

#### 4.5.1.1 tenant_config 租户配置表

+   租户配置表存储租户基本信息和认证方式选择。

    | 字段名          | 数据类型      | 可空 | 默认值         | 说明                                             |
    | --------------- | ------------- | ---- | -------------- | ------------------------------------------------ |
    | id              | BIGINT        | NO   | AUTO_INCREMENT | 主键                                             |
    | tenant_id       | BIGINT        | NO   | -              | 租户ID（关联tenant表）                           |
    | tenant_code     | VARCHAR(32)   | NO   | -              | 租户代号（冗余字段，可变，随Tenant主表同步更新） |
    | tenant_name     | VARCHAR(128)  | NO   | -              | 企业名称（可修改）                               |
    | company_logo    | VARCHAR(512)  | YES  | NULL           | 企业Logo URL                                     |
    | contact_name    | VARCHAR(64)   | NO   | -              | 联系人姓名                                       |
    | contact_email   | VARCHAR(128)  | NO   | -              | 联系人邮箱                                       |
    | contact_phone   | VARCHAR(20)   | YES  | NULL           | 联系人电话                                       |
    | company_address | VARCHAR(256)  | YES  | NULL           | 企业地址                                         |
    | industry        | VARCHAR(64)   | YES  | NULL           | 所属行业                                         |
    | auth_method     | VARCHAR(16)   | NO   | 'LOCAL'        | 认证方式：LOCAL/SSO_SAML/SSO_OIDC/LDAP           |
    | auth_changed_at | DATETIME      | YES  | NULL           | 认证方式切换时间                                 |
    | auth_changed_by | BIGINT        | YES  | NULL           | 认证方式切换操作人                               |
    | email_domains   | VARCHAR(1024) | YES  | NULL           | 邮箱域名列表（JSON数组）                         |
    | created_at      | DATETIME      | NO   | NOW()          | 创建时间                                         |
    | updated_at      | DATETIME      | NO   | NOW()          | 更新时间                                         |

    表 4.5.1.1-1 tenant_config 租户配置表结构

+   **email_domains 存储方案说明**：P1阶段邮箱域名以JSON数组存储于VARCHAR(1024)字段内，全局唯一校验（ED-R-03）由应用层EmailDomainUniqueSpec实现。因P1租户量有限（百级），全表JSON查询性能可接受。若P2+租户量超过阈值（1000+），建议将email_domains拆分为独立关联表tenant_email_domain，以支持数据库层UNIQUE索引保证唯一性。

+   索引设计：

    | 索引名          | 索引字段    | 类型 | 说明                           |
    | --------------- | ----------- | ---- | ------------------------------ |
    | PRIMARY         | id          | 主键 | 主键索引                       |
    | uk_tenant_id    | tenant_id   | 唯一 | 一个租户一条配置               |
    | idx_tenant_code | tenant_code | 普通 | 租户代号索引（冗余字段，可变） |

    表 4.5.1.1-2 tenant_config 索引设计

+   email_domains字段存储格式示例：

    ```json
    [
      {"domain":"@icbc.com.cn","addedAt":"2026-01-15T10:00:00Z","addedBy":20001},
      {"domain":"@icbc.com","addedAt":"2026-01-16T09:00:00Z","addedBy":20001}
    ]
    ```

#### 4.5.1.2 sso_config SSO配置表

+   SSO配置表存储SAML和OIDC单点登录配置。

    | 字段名               | 数据类型      | 可空 | 默认值         | 说明                                             |
    | -------------------- | ------------- | ---- | -------------- | ------------------------------------------------ |
    | id                   | BIGINT        | NO   | AUTO_INCREMENT | 主键                                             |
    | tenant_id            | BIGINT        | NO   | -              | 租户ID                                           |
    | tenant_code          | VARCHAR(32)   | NO   | -              | 租户代号（冗余字段，可变，随Tenant主表同步更新） |
    | protocol             | VARCHAR(16)   | NO   | -              | SSO协议：SAML / OIDC                             |
    | enabled              | TINYINT(1)    | NO   | 0              | 是否启用                                         |
    | saml_idp_entity_id   | VARCHAR(512)  | YES  | NULL           | IdP Entity ID                                    |
    | saml_idp_sso_url     | VARCHAR(512)  | YES  | NULL           | IdP SSO URL                                      |
    | saml_idp_slo_url     | VARCHAR(512)  | YES  | NULL           | IdP SLO URL                                      |
    | saml_idp_certificate | TEXT          | YES  | NULL           | IdP签名证书（PEM）                               |
    | saml_sp_entity_id    | VARCHAR(512)  | YES  | NULL           | SP Entity ID（系统生成）                         |
    | saml_sp_acs_url      | VARCHAR(512)  | YES  | NULL           | SP ACS URL（系统生成）                           |
    | oidc_issuer          | VARCHAR(512)  | YES  | NULL           | OIDC Issuer URL                                  |
    | oidc_auth_url        | VARCHAR(512)  | YES  | NULL           | Authorization URL                                |
    | oidc_token_url       | VARCHAR(512)  | YES  | NULL           | Token URL                                        |
    | oidc_userinfo_url    | VARCHAR(512)  | YES  | NULL           | UserInfo URL                                     |
    | oidc_jwks_url        | VARCHAR(512)  | YES  | NULL           | JWKS URL                                         |
    | oidc_client_id       | VARCHAR(256)  | YES  | NULL           | Client ID                                        |
    | oidc_client_secret   | VARCHAR(512)  | YES  | NULL           | Client Secret（AES-256加密）                     |
    | oidc_scopes          | VARCHAR(256)  | YES  | NULL           | 请求的Scopes                                     |
    | oidc_redirect_uri    | VARCHAR(512)  | YES  | NULL           | Redirect URI（系统生成）                         |
    | attr_username        | VARCHAR(64)   | YES  | NULL           | 用户名属性映射                                   |
    | attr_email           | VARCHAR(64)   | YES  | NULL           | 邮箱属性映射                                     |
    | attr_display_name    | VARCHAR(64)   | YES  | NULL           | 姓名属性映射                                     |
    | last_test_result     | VARCHAR(1024) | YES  | NULL           | 最后测试结果（JSON）                             |
    | last_test_at         | DATETIME      | YES  | NULL           | 最后测试时间                                     |
    | created_at           | DATETIME      | NO   | NOW()          | 创建时间                                         |
    | updated_at           | DATETIME      | NO   | NOW()          | 更新时间                                         |

    表 4.5.1.2-1 sso_config SSO配置表结构

+   索引设计：

    | 索引名          | 索引字段    | 类型 | 说明            |
    | --------------- | ----------- | ---- | --------------- |
    | PRIMARY         | id          | 主键 | 主键索引        |
    | uk_tenant_id    | tenant_id   | 唯一 | 一个租户一条SSO |
    | idx_tenant_code | tenant_code | 普通 | 租户代号索引    |

    表 4.5.1.2-2 sso_config 索引设计

#### 4.5.1.3 ldap_config LDAP配置表

+   LDAP配置表存储LDAP/AD服务器连接、搜索和同步配置。

    | 字段名             | 数据类型      | 可空 | 默认值         | 说明                                             |
    | ------------------ | ------------- | ---- | -------------- | ------------------------------------------------ |
    | id                 | BIGINT        | NO   | AUTO_INCREMENT | 主键                                             |
    | tenant_id          | BIGINT        | NO   | -              | 租户ID                                           |
    | tenant_code        | VARCHAR(32)   | NO   | -              | 租户代号（冗余字段，可变，随Tenant主表同步更新） |
    | enabled            | TINYINT(1)    | NO   | 0              | 是否启用                                         |
    | server_url         | VARCHAR(512)  | NO   | -              | LDAP服务器URL                                    |
    | base_dn            | VARCHAR(256)  | NO   | -              | 搜索基准DN                                       |
    | bind_dn            | VARCHAR(256)  | NO   | -              | 绑定DN                                           |
    | bind_password      | VARCHAR(512)  | NO   | -              | 绑定密码（AES-256加密）                          |
    | connection_timeout | INT           | NO   | 5000           | 连接超时（毫秒）                                 |
    | read_timeout       | INT           | NO   | 10000          | 读取超时（毫秒）                                 |
    | use_ssl            | TINYINT(1)    | NO   | 1              | 是否SSL                                          |
    | user_search_base   | VARCHAR(256)  | NO   | -              | 用户搜索起点DN                                   |
    | user_search_filter | VARCHAR(512)  | NO   | -              | 用户搜索过滤器                                   |
    | attr_username      | VARCHAR(64)   | NO   | -              | 用户名LDAP属性名                                 |
    | attr_email         | VARCHAR(64)   | NO   | -              | 邮箱LDAP属性名                                   |
    | attr_display_name  | VARCHAR(64)   | YES  | NULL           | 姓名LDAP属性名                                   |
    | attr_department    | VARCHAR(64)   | YES  | NULL           | 部门LDAP属性名                                   |
    | sync_enabled       | TINYINT(1)    | NO   | 0              | 是否启用自动同步                                 |
    | sync_cron          | VARCHAR(64)   | YES  | NULL           | 同步Cron表达式                                   |
    | sync_filter        | VARCHAR(512)  | YES  | NULL           | 同步范围过滤器                                   |
    | last_sync_at       | DATETIME      | YES  | NULL           | 最后同步时间                                     |
    | last_sync_count    | INT           | YES  | NULL           | 最后同步用户数                                   |
    | last_test_result   | VARCHAR(1024) | YES  | NULL           | 最后测试结果（JSON）                             |
    | last_test_at       | DATETIME      | YES  | NULL           | 最后测试时间                                     |
    | created_at         | DATETIME      | NO   | NOW()          | 创建时间                                         |
    | updated_at         | DATETIME      | NO   | NOW()          | 更新时间                                         |

    表 4.5.1.3-1 ldap_config LDAP配置表结构

+   索引设计：

    | 索引名          | 索引字段    | 类型 | 说明             |
    | --------------- | ----------- | ---- | ---------------- |
    | PRIMARY         | id          | 主键 | 主键索引         |
    | uk_tenant_id    | tenant_id   | 唯一 | 一个租户一条LDAP |
    | idx_tenant_code | tenant_code | 普通 | 租户代号索引     |

    表 4.5.1.3-2 ldap_config 索引设计

### 4.5.2 表关系图

+   租户配置数据模型关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     租户配置数据模型关系图                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  clarisphere_platform                                                       │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                     │    │
    │  │      ┌─────────────────┐                                           │    │
    │  │      │     tenant      │  第3章定义                                │    │
    │  │      │   （租户主表）  │                                           │    │
    │  │      └────────┬────────┘                                           │    │
    │  │               │                                                    │    │
    │  │          1:1  │  tenant_id                                         │    │
    │  │               │                                                    │    │
    │  │               ▼                                                    │    │
    │  │      ┌─────────────────┐                                           │    │
    │  │      │  tenant_config  │                                           │    │
    │  │      │ （租户配置表）  │                                           │    │
    │  │      │                 │                                           │    │
    │  │      │ auth_method     │                                           │    │
    │  │      │ email_domains   │                                           │    │
    │  │      └────────┬────────┘                                           │    │
    │  │               │                                                    │    │
    │  │        ┌──────┴──────┐                                             │    │
    │  │        │             │                                             │    │
    │  │   0..1 │        0..1 │                                             │    │
    │  │        ▼             ▼                                             │    │
    │  │  ┌────────────┐ ┌────────────┐                                     │    │
    │  │  │ sso_config │ │ldap_config │                                     │    │
    │  │  │（SSO配置） │ │（LDAP配置）│                                     │    │
    │  │  │            │ │            │                                     │    │
    │  │  │ SAML参数   │ │ 服务器连接 │                                     │    │
    │  │  │ OIDC参数   │ │ 用户搜索   │                                     │    │
    │  │  │ 属性映射   │ │ 属性映射   │                                     │    │
    │  │  └────────────┘ │ 同步配置   │                                     │    │
    │  │                 └────────────┘                                     │    │
    │  │                                                                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.5.2-1 租户配置数据模型关系图

### 4.5.3 数据字典

#### 4.5.3.1 auth_method 认证方式

    | Java枚举值 | 数据库存储值 | 说明         |
    | ---------- | ------------ | ------------ |
    | LOCAL      | LOCAL        | 本地认证     |
    | SSO_SAML   | SSO_SAML     | SAML单点登录 |
    | SSO_OIDC   | SSO_OIDC     | OIDC单点登录 |
    | LDAP       | LDAP         | LDAP/AD认证  |

    表 4.5.3.1-1 auth_method 认证方式枚举

#### 4.5.3.2 sso_protocol SSO协议类型

    | Java枚举值 | 数据库存储值 | 说明           |
    | ---------- | ------------ | -------------- |
    | SAML       | SAML         | SAML 2.0       |
    | OIDC       | OIDC         | OpenID Connect |

    表 4.5.3.2-1 sso_protocol SSO协议类型枚举

### 4.5.4 数据初始化

+   租户激活时自动创建配置记录：

    | 表名          | 初始化时机      | 初始化内容                                               |
    | ------------- | --------------- | -------------------------------------------------------- |
    | tenant_config | TenantActivated | 从Tenant聚合复制tenantName/contactInfo，authMethod=LOCAL |
    | sso_config    | 首次保存SSO时   | 按需创建，不预初始化                                     |
    | ldap_config   | 首次保存LDAP时  | 按需创建，不预初始化                                     |

    表 4.5.4-1 数据初始化策略

+   **tenant_code 冗余字段同步策略**
    -   tenant_config、sso_config、ldap_config 三张表中的 tenant_code 字段为冗余字段，方便按代号快速查询
    -   当 Tenant 聚合根的 tenant_code 被修改（changeTenantCode）时，BC-11发布 TenantCodeChanged 领域事件
    -   BC-11配置子领域订阅该事件后，同步更新三张表中的 tenant_code 字段
    -   更新采用最终一致性，短暂不一致期间（毫秒级）不影响业务（RPC以tenant_id为主键查询）

### 4.5.5 安全设计

+   敏感数据加密存储策略：

    | 表名        | 敏感字段           | 加密方式    | 说明           |
    | ----------- | ------------------ | ----------- | -------------- |
    | sso_config  | oidc_client_secret | AES-256-GCM | OIDC客户端密钥 |
    | ldap_config | bind_password      | AES-256-GCM | LDAP绑定密码   |

    表 4.5.5-1 敏感数据加密策略

+   加密密钥管理：
    -   加密密钥存储在应用配置文件中，不入库
    -   私有化部署时，客户可自定义加密密钥
    -   RPC返回时解密传输，服务间通信走内网mTLS

## 4.6 前端设计

### 4.6.1 页面总览

+   租户配置子领域前端页面清单如下表所示。

    | 页面编号     | 页面名称     | 用户群 | 路由路径               | 说明               |
    | ------------ | ------------ | ------ | ---------------------- | ------------------ |
    | PG-UR-CFG-01 | 租户设置首页 | ur     | /tenant/settings       | 设置入口，Tab导航  |
    | PG-UR-CFG-02 | 基本信息页   | ur     | /tenant/settings/basic | 企业信息和邮箱域名 |
    | PG-UR-CFG-03 | 认证配置页   | ur     | /tenant/settings/auth  | 认证方式选择和配置 |

    表 4.6.1-1 租户配置页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                      租户配置页面导航结构                                │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  租户管理后台                                                            │
    │  └── 租户设置                                                            │
    │      └── [PG-UR-CFG-01] 租户设置首页（Tab导航）                          │
    │          ├── [PG-UR-CFG-02] 基本信息页（Tab: 基本信息）                  │
    │          │   ├── 企业信息区域                                            │
    │          │   └── 邮箱域名区域                                            │
    │          └── [PG-UR-CFG-03] 认证配置页（Tab: 认证配置）                  │
    │              ├── 认证方式选择区域                                        │
    │              ├── SSO配置区域（按需展开）                                 │
    │              └── LDAP配置区域（按需展开）                                │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.1-1 租户配置页面导航结构

### 4.6.2 PG-UR-CFG-02 基本信息页

+   页面说明：
    -   用途：维护企业基本信息和管理邮箱域名
    -   入口：租户管理后台 → 租户设置 → 基本信息
    -   权限：ur:tenant:config:read（查看），ur:tenant:config:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-CFG-02 基本信息页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ Tab导航 ─────────────────────────────────────────────────────────┐   │
    │  │  [基本信息]  [认证配置]                                           │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 企业信息 ────────────────────────────────────────────────────────┐   │
    │  │                                                     ┌──────────┐  │   │
    │  │  企业名称 *          联系人姓名 *                   │ 编辑     │  │   │
    │  │  中信银行            张三                           └──────────┘  │   │
    │  │                                                                   │   │
    │  │  联系人邮箱 *         联系人电话                                  │   │
    │  │  zhangsan@icbc.com    13700137000                                 │   │
    │  │                                                                   │   │
    │  │  所属行业             企业地址                                    │   │
    │  │  金融                 北京市朝阳区...                             │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 邮箱域名 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  配置允许注册的企业邮箱域名（最多10个）                           │   │
    │  │                                                                   │   │
    │  │  ┌─────────────────┐  ┌──────┐                                   │   │
    │  │  │ @               │  │ 添加 │                                   │   │
    │  │  └─────────────────┘  └──────┘                                   │   │
    │  │                                                                   │   │
    │  │  ┌───────────────────────┬──────────────────┬──────┐             │   │
    │  │  │ 域名                  │ 添加时间         │ 操作 │             │   │
    │  │  ├───────────────────────┼──────────────────┼──────┤             │   │
    │  │  │ @icbc.com.cn          │ 2026-01-15 10:00 │ 删除 │             │   │
    │  │  ├───────────────────────┼──────────────────┼──────┤             │   │
    │  │  │ @icbc.com             │ 2026-01-16 09:00 │ 删除 │             │   │
    │  │  └───────────────────────┴──────────────────┴──────┘             │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.2-1 基本信息页线框图

### 4.6.3 PG-UR-CFG-03 认证配置页

+   页面说明：
    -   用途：选择认证方式，配置SSO和LDAP参数
    -   入口：租户管理后台 → 租户设置 → 认证配置
    -   权限：ur:tenant:config:read（查看），ur:tenant:config:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-CFG-03 认证配置页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ Tab导航 ─────────────────────────────────────────────────────────┐   │
    │  │  [基本信息]  [认证配置]                                           │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 认证方式选择 ────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  当前认证方式：SSO-SAML                                           │   │
    │  │                                                                   │   │
    │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │   │
    │  │  │ ○ 本地  │  │ ● SAML  │  │ ○ OIDC  │  │ ○ LDAP  │               │   │
    │  │  │   认证  │  │   SSO   │  │   SSO   │  │  /AD    │               │   │
    │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘               │   │
    │  │                                           ┌──────────┐            │   │
    │  │                                           │ 切换方式 │            │   │
    │  │                                           └──────────┘            │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ SSO配置（当前使用中）────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  协议类型：SAML 2.0                                               │   │
    │  │                                                                   │   │
    │  │  ── IdP配置 ──────────────────────────────────────                │   │
    │  │  IdP Entity ID *                                                  │   │
    │  │  ┌────────────────────────────────────────┐                       │   │
    │  │  │ https://idp.company.com/metadata       │                       │   │
    │  │  └────────────────────────────────────────┘                       │   │
    │  │  IdP SSO URL *                                                    │   │
    │  │  ┌────────────────────────────────────────┐                       │   │
    │  │  │ https://idp.company.com/sso            │                       │   │
    │  │  └────────────────────────────────────────┘                       │   │
    │  │  IdP签名证书 *                                                    │   │
    │  │  ┌────────────────────────────────────────┐  ┌──────────┐         │   │
    │  │  │ 已上传                                 │  │ 重新上传 │         │   │
    │  │  └────────────────────────────────────────┘  └──────────┘         │   │
    │  │                                                                   │   │
    │  │  ── 属性映射 ──────────────────────────────────                   │   │
    │  │  用户名属性 *    邮箱属性 *      姓名属性                         │   │
    │  │  ┌────────┐     ┌────────┐      ┌────────┐                        │   │
    │  │  │ NameID │     │ email  │      │        │                        │   │
    │  │  └────────┘     └────────┘      └────────┘                        │   │
    │  │                                                                   │   │
    │  │  ── SP参数（自动生成，请配置到企业IdP）──────                     │   │
    │  │  SP Entity ID：https://app.clarisphere.com/saml/sp    [复制]      │   │
    │  │  ACS URL：https://app.clarisphere.com/saml/acs        [复制]      │   │
    │  │                                                                   │   │
    │  │  ┌──────────┐  ┌──────────┐                                       │   │
    │  │  │ 测试连接 │  │   保存   │                                       │   │
    │  │  └──────────┘  └──────────┘                                       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.3-1 认证配置页线框图（SAML模式）

### 4.6.4 功能操作汇总

    | 功能编号         | 页面编号     | 功能类型 | 功能名称     | 关联API   | 前置条件                |
    | ---------------- | ------------ | -------- | ------------ | --------- | ----------------------- |
    | PG-UR-CFG-01.F01 | PG-UR-CFG-01 | 展示     | 加载配置     | UR-CFG-01 | ur:tenant:config:read   |
    | PG-UR-CFG-02.F01 | PG-UR-CFG-02 | 展示     | 加载基本信息 | UR-CFG-01 | ur:tenant:config:read   |
    | PG-UR-CFG-02.F02 | PG-UR-CFG-02 | 操作     | 编辑基本信息 | UR-CFG-02 | ur:tenant:config:update |
    | PG-UR-CFG-02.F03 | PG-UR-CFG-02 | 展示     | 加载域名列表 | UR-CFG-03 | ur:tenant:config:read   |
    | PG-UR-CFG-02.F04 | PG-UR-CFG-02 | 操作     | 添加域名     | UR-CFG-04 | ur:tenant:config:update |
    | PG-UR-CFG-02.F05 | PG-UR-CFG-02 | 操作     | 删除域名     | UR-CFG-05 | ur:tenant:config:update |
    | PG-UR-CFG-03.F01 | PG-UR-CFG-03 | 展示     | 加载认证配置 | UR-CFG-01 | ur:tenant:config:read   |
    | PG-UR-CFG-03.F02 | PG-UR-CFG-03 | 操作     | 切换认证方式 | UR-CFG-06 | ur:tenant:config:update |
    | PG-UR-CFG-03.F03 | PG-UR-CFG-03 | 操作     | 保存SSO配置  | UR-CFG-07 | ur:tenant:config:update |
    | PG-UR-CFG-03.F04 | PG-UR-CFG-03 | 操作     | 保存LDAP配置 | UR-CFG-08 | ur:tenant:config:update |
    | PG-UR-CFG-03.F05 | PG-UR-CFG-03 | 操作     | 测试连接     | UR-CFG-09 | ur:tenant:config:update |

    表 4.6.4-1 功能操作汇总

## 4.7 权限设计

### 4.7.1 权限点清单

#### 4.7.1.1 租户用户群权限点（ur）

+   租户用户群配置管理权限点清单：

    | 权限标识                | 权限名称     | 权限类型  | 说明                                |
    | ----------------------- | ------------ | --------- | ----------------------------------- |
    | ur:tenant:config:read   | 查看租户配置 | 页面+功能 | 访问租户设置页面，查看配置信息      |
    | ur:tenant:config:update | 修改租户配置 | 功能      | 编辑基本信息、域名、认证、SSO、LDAP |

    表 4.7.1.1-1 租户用户群配置管理权限点

### 4.7.2 页面-功能-API-权限映射表

    | 页面编号     | 功能名称     | API编号   | API路径                                  | 权限标识                |
    | ------------ | ------------ | --------- | ---------------------------------------- | ----------------------- |
    | PG-UR-CFG-01 | 访问页面     | -         | -                                        | ur:tenant:config:read   |
    | PG-UR-CFG-02 | 编辑基本信息 | UR-CFG-02 | PUT .../config/basic                     | ur:tenant:config:update |
    | PG-UR-CFG-02 | 添加域名     | UR-CFG-04 | POST .../config/email-domains            | ur:tenant:config:update |
    | PG-UR-CFG-02 | 删除域名     | UR-CFG-05 | DELETE .../config/email-domains/{domain} | ur:tenant:config:update |
    | PG-UR-CFG-03 | 切换认证方式 | UR-CFG-06 | POST .../config/auth-method              | ur:tenant:config:update |
    | PG-UR-CFG-03 | 保存SSO配置  | UR-CFG-07 | PUT .../config/sso                       | ur:tenant:config:update |
    | PG-UR-CFG-03 | 保存LDAP配置 | UR-CFG-08 | PUT .../config/ldap                      | ur:tenant:config:update |
    | PG-UR-CFG-03 | 测试连接     | UR-CFG-09 | POST .../config/test-connection          | ur:tenant:config:update |

    表 4.7.2-1 页面-功能-API-权限映射表

### 4.7.3 预置角色与权限

+   租户用户群配置管理权限在预置角色中的配置：

    | 角色编码        | 角色名称       | 包含配置权限                   | 说明             |
    | --------------- | -------------- | ------------------------------ | ---------------- |
    | ur_super_admin  | 租户超级管理员 | ur:tenant:config:read, :update | 完整配置管理权限 |
    | ur_admin        | 管理员         | ur:tenant:config:read          | 仅查看权限       |
    | ur_dept_manager | 部门经理       | -                              | 无配置权限       |
    | ur_user         | 普通员工       | -                              | 无配置权限       |

    表 4.7.3-1 租户用户群预置角色（配置管理部分）

+   **设计说明**：SSO/LDAP配置涉及企业认证体系安全，仅租户超级管理员可修改。普通管理员仅可查看。

### 4.7.4 API权限配置

    | API编号    | HTTP方法 | API路径                                               | 权限标识                |
    | ---------- | -------- | ----------------------------------------------------- | ----------------------- |
    | UR-CFG-01  | GET      | /api/v1/tenant/settings/config                        | ur:tenant:config:read   |
    | UR-CFG-02  | PUT      | /api/v1/tenant/settings/config/basic                  | ur:tenant:config:update |
    | UR-CFG-03  | GET      | /api/v1/tenant/settings/config/email-domains          | ur:tenant:config:read   |
    | UR-CFG-04  | POST     | /api/v1/tenant/settings/config/email-domains          | ur:tenant:config:update |
    | UR-CFG-05  | DELETE   | /api/v1/tenant/settings/config/email-domains/{domain} | ur:tenant:config:update |
    | UR-CFG-06  | POST     | /api/v1/tenant/settings/config/auth-method            | ur:tenant:config:update |
    | UR-CFG-07  | PUT      | /api/v1/tenant/settings/config/sso                    | ur:tenant:config:update |
    | UR-CFG-08  | PUT      | /api/v1/tenant/settings/config/ldap                   | ur:tenant:config:update |
    | UR-CFG-09  | POST     | /api/v1/tenant/settings/config/test-connection        | ur:tenant:config:update |
    | RPC-CFG-01 | GET      | /internal/tenant/config/{tenantId}/email-domains      | 内部调用                |
    | RPC-CFG-02 | GET      | /internal/tenant/config/{tenantId}/auth               | 内部调用                |
    | RPC-CFG-03 | GET      | /internal/tenant/config/{tenantId}/sso                | 内部调用                |
    | RPC-CFG-04 | GET      | /internal/tenant/config/{tenantId}/ldap               | 内部调用                |

    表 4.7.4-1 API权限配置汇总

## 4.8 后端工程结构

+   租户配置的代码组织在bc-11-tenant模块的config包下。

    ```
    bc-11-tenant-domain/
    └── com/clarisphere/tenant/domain/
        └── config/                          # 配置子领域
            ├── model/
            │   ├── aggregate/
            │   │   └── TenantConfig.java    # 配置聚合根
            │   ├── entity/
            │   │   ├── SsoConfig.java       # SSO配置实体
            │   │   └── LdapConfig.java      # LDAP配置实体
            │   └── valueobject/
            │       ├── AuthConfig.java      # 认证配置值对象
            │       ├── AuthMethod.java      # 认证方式枚举
            │       ├── SsoProtocol.java     # SSO协议枚举
            │       └── EmailDomain.java     # 邮箱域名值对象
            ├── repository/
            │   └── TenantConfigRepository.java
            ├── service/
            │   ├── TenantConfigService.java
            │   └── ConnectionTestService.java
            ├── event/
            │   ├── TenantConfigUpdated.java
            │   ├── EmailDomainAdded.java
            │   ├── EmailDomainRemoved.java
            │   ├── AuthMethodChanged.java
            │   ├── SsoConfigUpdated.java
            │   └── LdapConfigUpdated.java
            ├── specification/
            │   ├── TenantNameUniqueSpec.java
            │   └── EmailDomainUniqueSpec.java
            └── exception/
                ├── ConfigNotFoundException.java
                ├── AuthConfigIncompleteException.java
                └── EmailDomainConflictException.java

    bc-11-tenant-application/
    └── com/clarisphere/tenant/application/
        └── config/
            ├── command/
            │   ├── UpdateBasicInfoCommand.java
            │   ├── AddEmailDomainCommand.java
            │   ├── RemoveEmailDomainCommand.java
            │   ├── SwitchAuthMethodCommand.java
            │   ├── SaveSsoConfigCommand.java
            │   └── SaveLdapConfigCommand.java
            ├── query/
            │   └── TenantConfigQuery.java
            └── service/
                ├── ConfigCommandService.java
                └── ConfigQueryAppService.java

    bc-11-tenant-infrastructure/
    └── com/clarisphere/tenant/infrastructure/
        ├── persistence/
        │   ├── mapper/
        │   │   ├── TenantConfigMapper.java
        │   │   ├── SsoConfigMapper.java
        │   │   └── LdapConfigMapper.java
        │   ├── entity/
        │   │   ├── TenantConfigPO.java
        │   │   ├── SsoConfigPO.java
        │   │   └── LdapConfigPO.java
        │   └── repository/
        │       └── TenantConfigRepositoryImpl.java
        ├── security/
        │   └── AesEncryptionService.java    # AES-256加密服务
        └── connection/
            ├── SsoConnectionTester.java     # SSO连通测试
            └── LdapConnectionTester.java    # LDAP连通测试

    bc-11-tenant-starter/
    └── com/clarisphere/tenant/web/
        ├── tenant/
        │   └── ConfigController.java        # UR侧配置Controller
        └── internal/
            └── TenantConfigInternalController.java  # RPC Controller
    ```

    图 4.8-1 租户配置工程结构

## 4.9 前端工程结构

+   租户配置前端组件结构：

    ```
    src/views/
    └── tenant/
        └── settings/
            ├── index.vue                    # PG-UR-CFG-01 设置首页（Tab容器）
            ├── basic/
            │   ├── index.vue                # PG-UR-CFG-02 基本信息页
            │   └── components/
            │       ├── CompanyInfoForm.vue   # 企业信息编辑表单
            │       └── EmailDomainList.vue   # 邮箱域名列表
            └── auth/
                ├── index.vue                # PG-UR-CFG-03 认证配置页
                └── components/
                    ├── AuthMethodSelector.vue # 认证方式选择卡片
                    ├── SamlConfigForm.vue    # SAML配置表单
                    ├── OidcConfigForm.vue    # OIDC配置表单
                    ├── LdapConfigForm.vue    # LDAP配置表单
                    ├── SpParamsDisplay.vue   # SP参数展示（含复制按钮）
                    └── ConnectionTestBtn.vue # 测试连接按钮

    src/api/tenant/
    └── config.ts                            # 配置管理API

    src/types/tenant/
    └── config.ts                            # Pinia状态管理
    ```

    图 4.9-1 租户配置前端结构

+   **前端技术规范**
    -   状态管理：使用Pinia管理租户配置状态，Store定义在 `src/stores/tenant/config.ts`
    -   API调用：统一使用封装的axios实例，API定义在 `src/api/tenant/config.ts`
    -   类型定义：TypeScript类型定义在 `src/types/tenant/config.ts`，与后端DTO保持一致
    -   表单校验：使用VeeValidate + Yup进行表单校验，校验规则与后端业务规则保持同步
    -   组件通信：父子组件通过props/emit通信，跨组件通过Pinia Store共享状态

+   页面与组件映射：

    | 页面编号     | 页面名称     | 组件路径                              |
    | ------------ | ------------ | ------------------------------------- |
    | PG-UR-CFG-01 | 租户设置首页 | views/tenant/settings/index.vue       |
    | PG-UR-CFG-02 | 基本信息页   | views/tenant/settings/basic/index.vue |
    | PG-UR-CFG-03 | 认证配置页   | views/tenant/settings/auth/index.vue  |

    表 4.9-1 页面与组件映射

# 附录A 术语表

+   本文档使用的核心术语定义如下表所示。

    | 术语         | 英文              | 定义                                                                       | 备注                            |
    | ------------ | ----------------- | -------------------------------------------------------------------------- | ------------------------------- |
    | 租户         | Tenant            | 使用平台服务的企业客户实体，拥有独立的数据库和用户空间                     | -                               |
    | 租户ID       | tenant_id         | 租户的数据库主键，Long类型，系统内部唯一标识，不可变                       | 用于数据库名、数据源路由键      |
    | 租户代号     | tenant_code       | 租户的业务标识，用户可见，用于登录输入，可修改                             | 如：citic、icbc                 |
    | 平台管理员   | Platform Admin    | 运营方管理人员，拥有租户全生命周期管理权限                                 | 又称运营管理员                  |
    | 租户管理员   | Tenant Admin      | 租户企业内的超级管理员，管理本租户的配置和用户                             | -                               |
    | 供给侧（UP） | User Provider     | 平台运营方视角，管理所有租户                                               | API路径前缀：/provider          |
    | 消费侧（UR） | User Requester    | 租户用户视角，使用本租户服务                                               | API路径前缀：/tenant            |
    | 数据源       | DataSource        | 数据库连接池，每个租户对应一个HikariCP连接池实例                           | -                               |
    | 动态路由     | Dynamic Routing   | 根据tenant_id自动切换到对应租户数据源的机制                                | -                               |
    | SSO          | Single Sign-On    | 单点登录，支持SAML 2.0和OIDC两种协议                                       | -                               |
    | IdP          | Identity Provider | 身份提供者，企业的统一认证服务（如Okta、Azure AD、ADFS）                   | -                               |
    | SP           | Service Provider  | 服务提供者，本平台作为SP接入企业IdP                                        | -                               |
    | LDAP/AD      | LDAP/Active Dir.  | 轻量目录访问协议/活动目录，企业用户目录服务                                | -                               |
    | 宽限期       | Grace Period      | 租户注销发起后的可撤回期限，固定为7天                                      | 所有注销原因统一为7天           |
    | Outbox模式   | Outbox Pattern    | 领域事件先写入本地事务表再异步投递至消息中间件，保证事件与业务操作的原子性 | 见3.5.2.2 tenant_outbox_event表 |
    | CloudEvents  | CloudEvents       | CNCF标准化事件封装规范，定义type/source/id/time/data等信封字段             | 见3.4.3.1事件信封格式           |

    表 附录A-1 术语表

+   **tenant_id与tenant_code的使用规范**

    | 场景              | 使用标识    | 说明                                          |
    | ----------------- | ----------- | --------------------------------------------- |
    | 数据库名          | tenant_id   | clarisphere_t{tenant_id}，如clarisphere_t1001 |
    | 数据源路由key     | tenant_id   | DynamicDataSource路由表的key                  |
    | 跨BC RPC调用      | tenant_id   | BC-10调用BC-11时传递tenant_id                 |
    | 领域事件Payload   | tenant_id   | 事件中携带tenant_id作为主标识                 |
    | 用户登录输入      | tenant_code | 用户输入tenant_code\username格式登录          |
    | URL路径（UR视角） | tenant_code | 可选：/tenant/{tenantCode}/settings           |
    | 审计日志记录      | 两者都记录  | 同时记录tenant_id和tenant_code便于追溯        |

    表 附录A-2 tenant_id与tenant_code使用规范

+   **tenant_code修改影响范围**

    | 影响范围     | 影响说明                                                | 处理措施                                        |
    | ------------ | ------------------------------------------------------- | ----------------------------------------------- |
    | 用户登录     | 用户需使用新code登录（如newcode\username）              | 修改后发送通知邮件告知用户                      |
    | 缓存失效     | tenant_code_to_id缓存需主动清除                         | 修改操作中自动清除旧code缓存并预热新code缓存    |
    | 审计日志追溯 | 历史日志中记录的旧code不会自动更新                      | 审计日志同时记录tenant_id，通过id可追溯完整历史 |
    | 外部系统集成 | 如有外部系统依赖tenant_code（如SSO回调URL），需同步更新 | 修改前提示管理员确认外部依赖                    |
    | 数据库名     | 不受影响，数据库名使用tenant_id                         | -                                               |
    | 数据源路由   | 不受影响，路由key使用tenant_id                          | -                                               |

    表 附录A-3 tenant_code修改影响范围

+   **修改限制**
    -   租户代号修改需由租户超级管理员发起，每30天最多修改1次
    -   修改前需二次确认，系统展示影响范围提示
    -   修改后旧代号保留7天的重定向期，期间使用旧代号登录会提示已变更并引导使用新代号

# 附录B 错误码表

## 附录B.0 说明

+   错误码表全局定义本BC的所有错误码，避免分散在各API中。
+   错误码采用统一编号规则，便于前端统一处理和国际化。
+   各API通过"关联错误码"字段引用本节定义的错误码编号。

### B.0.1 设计原则

+   错误码设计遵循BC-10附录A.0.1节定义的统一原则（唯一性、自解释性、可追溯性、可国际化、安全性），此处不再重复。

### B.0.2 错误码命名规范

+   错误码采用"E-"前缀加6位数字：`E-XXXYYY`
    -   E-：错误码前缀，便于识别
    -   XXX：HTTP状态码（400、401、403、404、409、422、429、500、503）
    -   YYY：业务错误序号（000-999）

### B.0.3 错误码分段规划

+   BC-11租户管理上下文的错误码段分配如下表所示，与BC-10统一分段规划框架保持一致。

    | 错误码范围        | HTTP状态码 | 错误类型                 | 说明                         |
    | ----------------- | ---------- | ------------------------ | ---------------------------- |
    | E-400001~E-400099 | 400        | 通用参数校验错误（复用） | 复用BC-10附录A.0.4通用错误码 |
    | E-400500~E-400599 | 400        | 租户生命周期模块错误     | 租户参数校验                 |
    | E-400600~E-400699 | 400        | 租户配置模块错误         | 配置参数校验                 |
    | E-401001~E-401008 | 401        | 认证错误（复用）         | 复用BC-10附录A.0.4通用错误码 |
    | E-403001~E-403019 | 403        | 权限错误（复用）         | 复用BC-10附录A.0.4通用错误码 |
    | E-404001~E-404004 | 404        | 资源不存在（复用）       | 复用BC-10附录A.0.4通用错误码 |
    | E-409001~E-409005 | 409        | 冲突错误（复用）         | 复用BC-10附录A.0.4通用错误码 |
    | E-409500~E-409599 | 409        | 租户生命周期冲突         | 租户冲突                     |
    | E-409600~E-409699 | 409        | 租户配置冲突             | 配置冲突                     |
    | E-422001~E-422099 | 422        | 租户生命周期业务逻辑     | 租户状态/业务规则            |
    | E-422500~E-422599 | 422        | 租户配置业务逻辑         | 配置业务规则                 |
    | E-429001~E-429004 | 429        | 限流错误（复用）         | 复用BC-10附录A.0.4通用错误码 |
    | E-500001~E-500004 | 500        | 系统内部错误（复用）     | 复用BC-10附录A.0.4通用错误码 |
    | E-500500~E-500502 | 500        | 依赖服务错误（复用）     | 复用BC-10附录A.0.4通用错误码 |
    | E-500510~E-500519 | 500        | 租户开通基础设施错误     | 数据库/数据源/IAM初始化      |
    | E-503001~E-503002 | 503        | 服务不可用（复用）       | 复用BC-10附录A.0.4通用错误码 |

    表 B.0.3-1 BC-11错误码分段规划

+   **分段分配原则**：
    -   通用错误码（参数校验、认证、权限、资源不存在、冲突、限流、系统错误）直接复用BC-10附录A.0.4定义，不再重复列出
    -   BC-11专属错误码使用500~699段（与BC-10的100~499段错开），避免跨BC编号冲突
    -   每个子领域预留100个错误码位

### B.0.4 通用错误码复用清单

+   以下BC-10附录A.0.4定义的通用错误码在BC-11中直接复用，不再重复定义。

+   **BC-11复用的通用错误码**

    | 错误码   | HTTP状态码 | 错误名称            | 错误描述         | BC-11使用场景                      |
    | -------- | ---------- | ------------------- | ---------------- | ---------------------------------- |
    | E-400001 | 400        | PARAM_INVALID       | 参数校验失败     | 所有API参数校验                    |
    | E-400002 | 400        | BODY_EMPTY          | 请求体不能为空   | 创建租户、更新联系人等POST/PUT请求 |
    | E-400010 | 400        | FILE_TYPE_INVALID   | 文件格式不支持   | Logo上传格式校验（配置子领域）     |
    | E-401001 | 401        | NOT_LOGGED_IN       | 未登录           | 所有需认证的API                    |
    | E-403001 | 403        | PERMISSION_DENIED   | 无操作权限       | 运营方/租户管理员权限校验          |
    | E-404001 | 404        | RESOURCE_NOT_FOUND  | 资源不存在       | 租户ID不存在、配置不存在           |
    | E-409001 | 409        | OPTIMISTIC_LOCK     | 数据已被修改     | 租户信息并发修改                   |
    | E-429001 | 429        | RATE_LIMIT_EXCEEDED | 请求过于频繁     | 公共试用申请接口防刷               |
    | E-500501 | 500        | SERVICE_CALL_FAILED | 依赖服务调用失败 | 调用BC-10 IAM初始化接口失败        |

    表 B.0.4-1 BC-11复用的通用错误码

### B.0.5 错误响应格式规范

+   BC-11错误响应格式与BC-10保持一致，详见BC-10附录A.0.5节。

### B.0.6 自定义错误码扩展

+   BC-11自定义错误码扩展规范与BC-10保持一致，详见BC-10附录A.0.6节。

## 附录B.1 租户生命周期子领域错误码

+   本节定义租户生命周期子领域的专属错误码，与附录B.0通用错误码复用清单配合使用。
+   错误码段分配：E-400500~E-400599（参数校验）、E-409500~E-409599（冲突）、E-422001~E-422099（业务逻辑）、E-500510~E-500519（基础设施）。

### B.1.1 租户参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                     | 错误描述             |
| -------- | ---------- | ---------------------------- | -------------------- |
| E-400500 | 400        | TENANT_NAME_INVALID          | 租户企业名称格式无效 |
| E-400501 | 400        | TENANT_CODE_FORMAT_INVALID   | 租户代号格式无效     |
| E-400502 | 400        | CONTACT_EMAIL_INVALID        | 联系人邮箱格式无效   |
| E-400503 | 400        | CONTACT_PHONE_INVALID        | 联系人电话格式无效   |
| E-400504 | 400        | SCALE_VALUE_INVALID          | 企业规模值无效       |
| E-400505 | 400        | DEACTIVATION_REASON_REQUIRED | 注销原因不能为空     |
| E-400506 | 400        | SUSPEND_REASON_REQUIRED      | 暂停原因不能为空     |

表 B.1.1-1 租户参数校验错误码

### B.1.2 租户冲突错误码（409）

| 错误码   | HTTP状态码 | 错误名称              | 错误描述       |
| -------- | ---------- | --------------------- | -------------- |
| E-409500 | 409        | TENANT_CODE_DUPLICATE | 租户代号已存在 |
| E-409501 | 409        | TENANT_NAME_DUPLICATE | 企业名称已存在 |

表 B.1.2-1 租户冲突错误码

### B.1.3 租户业务逻辑错误码（422）

| 错误码   | HTTP状态码 | 错误名称                   | 错误描述                               |
| -------- | ---------- | -------------------------- | -------------------------------------- |
| E-422001 | 422        | TENANT_STATUS_INVALID      | 当前租户状态不允许此操作               |
| E-422002 | 422        | GRACE_PERIOD_EXPIRED       | 注销宽限期已过，不可撤回               |
| E-422003 | 422        | TENANT_ALREADY_ACTIVE      | 租户已处于激活状态                     |
| E-422004 | 422        | TENANT_NOT_ACTIVE          | 租户未处于激活状态                     |
| E-422005 | 422        | TRIAL_EXPIRED              | 试用期已过期                           |
| E-422006 | 422        | TRIAL_CONVERT_NOT_ALLOWED  | 当前状态不允许试用转正                 |
| E-422007 | 422        | DEACTIVATION_NOT_REVOCABLE | 注销操作不可撤回（非DEACTIVATING状态） |
| E-422008 | 422        | DATABASE_ALREADY_EXISTS    | 租户数据库已存在                       |
| E-422009 | 422        | DATASOURCE_POOL_NOT_READY  | 数据源连接池未就绪                     |

表 B.1.3-1 租户业务逻辑错误码

### B.1.4 租户基础设施错误码（500）

| 错误码   | HTTP状态码 | 错误名称                   | 错误描述                |
| -------- | ---------- | -------------------------- | ----------------------- |
| E-500510 | 500        | DATABASE_CREATE_FAILED     | 租户数据库创建失败      |
| E-500511 | 500        | DATASOURCE_REGISTER_FAILED | 数据源连接池注册失败    |
| E-500512 | 500        | IAM_INIT_FAILED            | 调用BC-10 IAM初始化失败 |
| E-500513 | 500        | DATABASE_DROP_FAILED       | 租户数据库删除失败      |
| E-500514 | 500        | DATASOURCE_CLOSE_FAILED    | 数据源连接池关闭失败    |
| E-500515 | 500        | DATA_ARCHIVE_FAILED        | 租户数据归档失败        |

表 B.1.4-1 租户基础设施错误码

## 附录B.2 租户配置子领域错误码

+   本节定义租户配置子领域的专属错误码，与附录B.0通用错误码复用清单配合使用。
+   错误码段分配：E-400600~E-400699（配置参数校验）、E-409600~E-409699（配置冲突）、E-422500~E-422599（配置业务逻辑）。

### B.2.1 配置参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                    | 错误描述                |
| -------- | ---------- | --------------------------- | ----------------------- |
| E-400600 | 400        | EMAIL_DOMAIN_FORMAT_INVALID | 邮箱域名格式无效        |
| E-400601 | 400        | SAML_IDP_URL_INVALID        | SAML IdP URL格式无效    |
| E-400602 | 400        | SAML_CERTIFICATE_INVALID    | SAML证书格式无效        |
| E-400603 | 400        | OIDC_ISSUER_URL_INVALID     | OIDC Issuer URL格式无效 |
| E-400604 | 400        | LDAP_SERVER_URL_INVALID     | LDAP服务器URL格式无效   |
| E-400605 | 400        | LDAP_BASE_DN_INVALID        | LDAP Base DN格式无效    |
| E-400606 | 400        | LDAP_FILTER_INVALID         | LDAP搜索过滤器格式无效  |

表 B.2.1-1 配置参数校验错误码

### B.2.2 配置冲突错误码（409）

| 错误码   | HTTP状态码 | 错误名称               | 错误描述                 |
| -------- | ---------- | ---------------------- | ------------------------ |
| E-409600 | 409        | EMAIL_DOMAIN_DUPLICATE | 邮箱域名已被其他租户使用 |

表 B.2.2-1 配置冲突错误码

+   **说明**：配置子领域修改企业名称时，复用B.1.2定义的E-409501（TENANT_NAME_DUPLICATE）。

### B.2.3 配置业务逻辑错误码（422）

| 错误码   | HTTP状态码 | 错误名称                      | 错误描述                                     |
| -------- | ---------- | ----------------------------- | -------------------------------------------- |
| E-422510 | 422        | AUTH_SWITCH_CONFIG_INCOMPLETE | 切换认证方式前，目标方式必须已完成配置       |
| E-422511 | 422        | SSO_CONFIG_INCOMPLETE         | SSO配置不完整，必填参数缺失                  |
| E-422512 | 422        | LDAP_CONFIG_INCOMPLETE        | LDAP配置不完整，服务器连接或用户搜索参数缺失 |
| E-422500 | 422        | EMAIL_DOMAIN_LIMIT_EXCEEDED   | 邮箱域名数量超过上限（最多10个）             |
| E-422501 | 422        | CONFIG_TENANT_NOT_ACTIVE      | 租户未激活，不允许修改配置                   |
| E-422502 | 422        | SSO_TEST_CONNECTION_FAILED    | SSO连通测试失败                              |
| E-422503 | 422        | LDAP_TEST_CONNECTION_FAILED   | LDAP连通测试失败                             |

表 B.2.3-1 配置业务逻辑错误码

+   **说明**：E-422510~E-422512对应BC-11业务规则表CFG-R-03~CFG-R-05，编号遵循配置子领域E-422500~E-422599段分配。

## 附录B.3 错误码国际化

+   错误码支持国际化（i18n），错误信息从资源文件读取，格式与BC-10保持一致。

+   **资源文件示例**（以下为部分代表性示例，完整错误码清单见B.1/B.2各表）

    ```properties
    # error_messages.properties (中文)
    E-422001=当前租户状态不允许此操作，当前状态：{0}
    E-422002=注销宽限期已过，不可撤回
    E-409500=租户代号已存在：{0}
    E-409501=企业名称已存在：{0}
    E-500510=租户数据库创建失败，请联系管理员
    E-422510=切换认证方式前，请先完成{0}的配置
    E-422511=SSO配置不完整，缺少必填参数：{0}

    # error_messages_en.properties (英文)
    E-422001=Operation not allowed for current tenant status: {0}
    E-422002=Grace period has expired, revocation not allowed
    E-409500=Tenant code already exists: {0}
    E-409501=Company name already exists: {0}
    E-500510=Failed to create tenant database, please contact administrator
    E-422510=Please complete {0} configuration before switching auth method
    E-422511=SSO configuration incomplete, missing required fields: {0}
    ```
