# 文档信息

+   **文档版本**: V0.48
+   **编制日期**: 2026-02-03
+   **文档状态**: 草案
+   **所属项目**: ClariSphere(透管云)
+   **限界上下文**: BC-10 用户与权限上下文 (IAM)
+   版本变更历史如下表所示
    | 版本  | 日期       | 变更内容                                                                                                                                                                                                                                           | 变更人 |
    | ----- | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
    | V0.10 | 2026-01-19 | 初始版本                                                                                                                                                                                                                                           | 丁劲松 |
    | V0.22 | 2026-01-20 | 基于详细设计编写指南优化：补充BC归属信息、测试策略、部署运维、实现层代码                                                                                                                                                                           | 丁劲松 |
    | V0.30 | 2026-01-20 | 0.22版权限表缺失前端资源字段的问题，通过引入Menu聚合实现菜单资源与访问权限的分离设计。                                                                                                                                                             | 丁劲松 |
    | V0.40 | 2026-01-25 | 基于4A，全面重新梳理                                                                                                                                                                                                                               | 丁劲松 |
    | V0.41 | 2026-01-25 | 修正接口层部分接口未遵循三表原则进行表述的部分；增补部分接口描述的缺失；ID字段类型统一改为BIGINT AUTO_INCREMENT；补充缺失的updated_by；                                                                                                            | 丁劲松 |
    | V0.42 | 2026-01-27 | 术语体系统一与API路径规范化：(1)建立三层用户概念体系（UserSide/UserPool/UserType），新增附录B用户概念体系、附录C枚举定义统一表；                                                                                                                   | 丁劲松 |
    |       |            | (2)核心字段userSide统一改为userPool，涉及Permission、PlatformRole等领域模型及DDL；                                                                                                                                                                 |        |
    |       |            | (3)用户群中文名称统一（UP=运营用户群、UR=租户用户群、UC=C端用户群）；                                                                                                                                                                              |        |
    |       |            | (4)API路径统一为简写形式（up/、/ur/、/uc/），消除/platform/例外路径；                                                                                                                                                                              |        |
    |       |            | (5)修正auth_login_attempt表存储位置描述                                                                                                                                                                                                            |        |
    | V0.43 | 2026-01-27 | Token聚合完善：                                                                                                                                                                                                                                    | 丁劲松 |
    |       |            | (1)新增AccessToken值对象完整三表模型定义，包含jti、sub、userPool、tenantCode、tenantId、username、iat、exp属性；                                                                                                                                   |        |
    |       |            | (2)AccessToken增加tenantCode字段用于数据源路由；                                                                                                                                                                                                   |        |
    |       |            | (3)RefreshToken实体补充tenantCode字段；                                                                                                                                                                                                            |        |
    |       |            | (4)TokenBlacklist实体拆分独立并补充完整三表模型（业务规则表、业务方法表）；                                                                                                                                                                        |        |
    |       |            | (5)重构5.3.5节结构，规范表编号                                                                                                                                                                                                                     |        |
    | V0.44 | 2026-01-30 | 组织模型命名统一与Token会话关联：                                                                                                                                                                                                                  | 丁劲松 |
    |       |            | (1)Organization命名统一：orgUnitId→orgId、org_unit_id→org_id、orgUnitName→orgName，消除OrgUnit与Organization混用；                                                                                                                                 |        |
    |       |            | (2)方法名统一：assignToOrgUnit()→assignToOrg()、InvalidOrgUnitException→InvalidOrganizationException；                                                                                                                                             |        |
    |       |            | (3)查询服务统一：OrgUnitQueryService→OrganizationQueryService；                                                                                                                                                                                    |        |
    |       |            | (4)表名引用修正：org_unit表→org_organization表（TU-R-08、API约束等处）；                                                                                                                                                                           |        |
    |       |            | (5)AccessToken值对象新增sessionId属性，用于会话管理和审计追踪；                                                                                                                                                                                    |        |
    |       |            | (6)JWT Payload增加session_id声明；业务方法表增加getSessionId()方法                                                                                                                                                                                 |        |
    | V0.45 | 2026-01-30 | 租户标识简化与配置管理：                                                                                                                                                                                                                           | 丁劲松 |
    |       |            | (1)API参数统一使用tenantCode，移除tenantId/tenant_id参数；响应中tenant.id和user.id类型改为BIGINT Number；                                                                                                                                          |        |
    |       |            | (2)新增租户用户登录流程说明，包含tenantCode\username输入格式、前端解析与后端路由流程图；                                                                                                                                                           |        |
    |       |            | (3)新增SystemConfig聚合及sys_config表，支持平台级配置参数（默认租户编码、全局认证策略等）；                                                                                                                                                        |        |
    |       |            | (4)新增TenantConfig聚合及tenant_config表，支持租户级配置参数覆盖（认证策略、会话超时等）                                                                                                                                                           |        |
    | V0.46 | 2026-02-02 | 前端设计节规范化改造与新增章节：                                                                                                                                                                                                                   | 丁劲松 |
    |       |            | (1)3.6/4.6/5.6/7.6前端设计节统一进行规范化改造；                                                                                                                                                                                                   |        |
    |       |            | (2)新增6.8前端设计：权限管理子领域前端页面设计，含供给侧角色管理、权限定义、角色互斥配置，租户侧角色管理与数据授权管理共10个页面；                                                                                                                 |        |
    |       |            | (3)新增第8章共享服务：对TokenService、PasswordService、CaptchaService、MfaService、PermissionLoader、ConfigService共6个跨子领域进行详细设计；                                                                                                      |        |
    |       |            | (4)新增第9章配置管理：将系统配置/租户配置从共享服务提升为独立子领域，按标准章节结构补齐业务流程、接口设计、数据模型、前端设计、权限设计；                                                                                                          |        |
    |       |            | (5)废弃5.5.3.2节ur_auth_config宽表，租户认证配置统一由tenant_config键值对表承载                                                                                                                                                                    |        |
    | V0.47 | 2026-02-02 | 租户路由标识重构与整体优化：                                                                                                                                                                                                                       | 丁劲松 |
    |       |            | (1)数据库路由键从tenant_code改为tenant_id，库名格式统一为clarisphere_t{tenant_id}；                                                                                                                                                                |        |
    |       |            | (2)明确tenant_id与tenant_code职责分工：tenant_id（Long，主键，不可变）用于数据库命名、数据源路由键、JWT Token claims、请求头、用户归属标识、跨BC协作参数；                                                                                         |        |
    |       |            | tenant_code（String，4-20位，全局唯一，可修改）仅用于用户登录时的输入标识（tenant_code\username格式），后端认证流程中解析为tenant_id后，后续所有内部操作均使用tenant_id；                                                                          |        |
    |       |            | (3)所有关联user_id的位置补充tenant_id（因自增ID跨库存在重号）；                                                                                                                                                                                    |        |
    |       |            | (4)统一id类型为BIGINT/LONG；                                                                                                                                                                                                                       |        |
    |       |            | (5)按DDD理念重构了第9章；                                                                                                                                                                                                                          |        |
    |       |            | (6)优化了各领域之间的联动，增加了协作关系小节；                                                                                                                                                                                                    |        |
    |       |            | (7)优化了接口设计部分，按三类接口进行了统一                                                                                                                                                                                                        |        |
    | V0.48 | 2026-02-03 | 验证码重构：激活链接/密码重置令牌统一改为验证码机制，废弃ActivationToken，删除冗余接口COMMON-02：                                                                                                                                                  | 丁劲松 |
    |       |            | (1)激活流程从"发送激活链接→点击链接→设置密码"改为"发送激活验证码→输入验证码→设置密码"，有效期从24小时缩短为15分钟，新增60秒重发间隔限制；涉及FL-P-01、FL-UR-00、FL-UR-01流程图及步骤表（3.2.3/3.2.5/3.2.7节）；                                    |        |
    |       |            | (2)密码重置流程从令牌机制改为验证码机制，管理员协助重置和用户自助重置统一使用CaptchaService；涉及FL-CMN-02流程图及步骤表（3.2.12节）；                                                                                                             |        |
    |       |            | (3)废弃ActivationToken值对象（3.3.3.6节），原AT-R-01~04规则由CAP-R-01~03替代，PlatformUser/TenantUser聚合的activationToken属性及对应DDL字段（activation_token/activation_expires_at/activation_used）标记移除；                                    |        |
    |       |            | (4)PasswordService移除generateResetToken()/validateResetToken()方法，方法表从6个缩减为4个；密码重置验证码由CaptchaService统一管理（3.3.6.2/8.3.2/8.3.3/8.3.4节）；                                                                                 |        |
    |       |            | (5)UserActivationService重构：activateByToken()→activateByCode()，移除validateToken()/isTokenExpired()方法（3.3.6.3节）；                                                                                                                          |        |
    |       |            | (6)跨BC协作更新：BC-12通知上下文从"发送激活邮件"改为"发送激活验证码"（CROSS-051）；共享服务协作中SHARE-004/005从PasswordService.generateResetToken()/validateResetToken()改为CaptchaService.sendSmsCode()/verifyCode()（3.3.8节）；                |        |
    |       |            | (7)接口契约更新：PUB-03激活账号（token→target+code）、PUB-04忘记密码（发送重置验证码）、PUB-05重置密码（token→target+code）、P-USR-08/UR-USR-08管理员协助重置（链接→验证码）、P-USR-09/UR-USR-09重发激活（邮件→验证码）共8个API契约重写（3.4节）； |        |
    |       |            | (8)PUB-06发送验证码scene枚举新增ACTIVATE场景，ACTIVATE验证码有效期15分钟（3.4.4.4.7节）；                                                                                                                                                          |        |
    |       |            | (9)删除COMMON-02（发送短信验证码）接口，其职责合并至PUB-06（发送验证码），PUB-06同时支持SMS和EMAIL通道                                                                                                                                             |        |
    |       |            | (10)MSG-USR-05 UserActivated事件触发时机从"激活链接"更新为"激活验证码"（3.3.7节）                                                                                                                                                                  |        |

# 1 概述

## 1.1 上下文定位

+   BC归属信息

    | 属性       | 值                                                                             |
    | ---------- | ------------------------------------------------------------------------------ |
    | BC编号     | BC-10                                                                          |
    | BC名称     | 用户与权限上下文                                                               |
    | BC英文名   | IAM (Identity and Access Management)                                           |
    | 所属域     | 通用域                                                                         |
    | 上下文类型 | 通用子域                                                                       |
    | 所属微服务 | svc-iam                                                                        |
    | 微服务端口 | 8084                                                                           |
    | 所属数据库 | clarisphere_platform（供给侧）；clarisphere_t{tenant_id}（消费侧，按租户隔离） |
    | 代码包路径 | com.clarisphere.iam                                                            |
    | 上游依赖   | 无（基础服务）                                                                 |
    | 下游被依赖 | BC-01~BC-09, BC-11（OHS模式）、BC-12（领域事件）                               |

+   与BC-11的职责边界

    +   **BC-10（用户与权限上下文）职责**
        +   用户认证与授权：登录（本地认证、SSO认证、LDAP认证）、Token管理、权限校验
        +   用户账号管理：用户CRUD、密码管理、状态管理
        +   角色权限模型：RBAC实现、角色与权限关联
        +   多租户数据隔离：基于tenant_id的数据源路由、租户上下文传递
        +   租户IAM表初始化：为租户数据库创建IAM表结构和预置数据（内部接口）
        +   租户运行策略配置：认证策略、密码策略、会话超时等（TenantConfig）
        +   说明：LDAP用户由BC-11同步创建，BC-10仅负责登录时的LDAP认证

    +   **BC-11（租户管理上下文）职责**
        +   租户生命周期管理：创建、激活、暂停、注销
        +   租户数据库管理：数据库创建、删除
        +   租户数据源管理：连接池创建、销毁、动态路由
        +   租户基础设施配置：邮箱域名、SSO IdP元数据、LDAP连接参数
        +   租户状态管理：状态流转、状态查询
        +   AD/LDAP用户同步：从企业目录同步用户

    +   **租户开通协作流程**
        1.   BC-11：创建租户记录（platform_tenant表）
        2.   BC-11：创建租户数据库（clarisphere_t{tenant_id}）
        3.   BC-11：创建并注册数据源连接池
        4.   BC-11：调用BC-10的内部接口 /internal/iam/tenant/{tenantId}/init-tables
        5.   BC-10：创建IAM表结构（iam_user、platform_role等）
        6.   BC-10：初始化预置角色和权限
        7.   BC-10：创建租户管理员账号
        8.   BC-10：返回初始化结果给BC-11
        9.   BC-11：更新租户状态为"已初始化"
        10.   BC-11：记录初始化时间

    +   **接口调用关系**
        +   BC-11 → BC-10：租户IAM表初始化（内部接口）
        +   BC-10 → BC-11：获取租户邮箱域名配置（内部接口，用于注册时校验）
        +   BC-10 → LDAP服务器：LDAP用户登录认证（外部调用，V2.0）
        +   业务上下文 → BC-10：用户认证、权限校验（公开接口）
        +   业务上下文 → BC-11：租户管理、AD/LDAP用户同步（公开接口）

## 1.2 核心价值

+   **身份认证**: 提供统一的用户身份认证能力，支持多种认证方式
+   **权限管控**: 实现细粒度的权限控制，支持RBAC模型，数据权限基于组织架构维度控制
+   **多租户隔离**: 支持供给侧系统级用户和消费侧租户级用户的双层隔离
+   **安全审计**: 提供完整的操作审计日志，满足合规要求

## 1.3 业务边界

+   **范围内**
    +   系统级用户管理（UP角色用户）- 供给侧数据库（clarisphere_platform）
    +   租户级用户管理（UR角色用户）- 消费侧数据库（clarisphere_t{tenant_id}）
    +   角色定义与分配
    +   权限定义与授权
    +   登录认证与Token管理（本地认证、SSO单点登录）
    +   密码策略与安全控制
    +   操作审计日志
    +   租户运行策略配置：认证策略、密码策略、会话超时等（BC-10 TenantConfig承载）
+   **范围外**（由其他上下文负责）
    +   租户生命周期管理（BC-11租户管理上下文）
    +   租户数据库创建与管理（BC-11租户管理上下文）
    +   租户基础设施配置：邮箱域名、SSO IdP元数据、LDAP连接参数（BC-11租户管理上下文）
    +   AD/LDAP用户同步（BC-11租户管理上下文）
    +   租户组织架构管理（BC-11租户管理上下文）
    +   工作流任务权限（BC-14工作流引擎上下文）
    +   数据权限（各业务上下文自行控制）
    +   企业IdP管理（由租户企业自行维护）

## 1.4 上下文协作关系

+   **提供服务给**
    +   所有业务上下文（BC-01 ~ BC-09）
    +   BC-11 租户管理上下文（租户IAM表初始化，内部接口）
    +   BC-12（领域事件）
    +   网关层（认证鉴权）
    +   前端应用（登录认证）
+   **依赖服务**
    +   BC-11 租户管理上下文（获取租户邮箱域名配置，内部接口）
+   **集成模式**
    +   开放主机服务 (OHS): 提供标准RESTful API
    +   发布语言 (PL): 使用JWT标准格式

# 2 架构设计

+   本章记录BC-10用户与权限上下文的关键架构设计。
+   这些设计决策对后续所有章节具有约束力，是理解本BC设计的前提和基础。

## 2.1 核心挑战

+   BC-10作为IAM（Identity and Access Management）上下文，面临以下核心设计挑战：
    -   多子领域融合：BC-10涵盖用户管理、认证、授权、审计四个子领域，需要在单一上下文内实现清晰的职责划分
    -   多类型用户并存：系统存在5类用户，各类用户的身份归属、数据边界、认证方式存在本质差异
    -   多库存储隔离：基于租户隔离和数据安全要求，需要将不同用户群的数据存储在不同数据库中
    -   认证机制差异化：不同用户类型的登录入口、认证方式、密码策略、会话时长均有差异
    -   权限模型复杂：需要同时支持功能权限（RBAC）和数据权限（基于组织架构）

## 2.2 子领域划分

### 2.2.1 子领域识别

+   BC-10包含六个子领域，按业务职能划分如下表所示。

    | 子领域   | 英文名称       | 一句话描述     | 关注的核心问题       |
    | -------- | -------------- | -------------- | -------------------- |
    | 用户管理 | User           | 管理"是什么人" | 用户是谁、属于哪     |
    | 组织管理 | Organization   | 管理"归属在哪" | 组织架构、岗位人员   |
    | 认证管理 | Authentication | 验证"是不是他" | 如何证明身份         |
    | 授权管理 | Authorization  | 控制"能做什么" | 有哪些权限           |
    | 审计管理 | Audit          | 记录"做了什么" | 操作可追溯           |
    | 配置管理 | Configuration  | 管控"怎么运行" | 策略参数如何生效覆盖 |

    表 2.2.1-1 子领域识别

+   六个子领域的关系可以用一句话概括：**用户管理**定义主体，**组织管理**定义主体的归属结构，**认证**验证主体身份，**授权**控制主体行为，**审计**记录主体操作，**配置管理**为以上各子领域提供可动态调整的策略参数。

### 2.2.2 子领域职责边界

+   各子领域的详细职责边界如下表所示。

    | 子领域   | 职责范围                                         | 核心概念                          | 不负责的内容           |
    | -------- | ------------------------------------------------ | --------------------------------- | ---------------------- |
    | 用户管理 | 用户生命周期、用户信息、账号凭证                 | User, Account, Credential         | 登录验证、权限判断     |
    | 组织管理 | 组织架构、岗位定义、人员管理、任职关系           | Organization, Position, Person    | 用户认证、角色分配     |
    | 认证管理 | 身份验证、凭证管理、Token签发、会话管理、MFA     | Credential, Token, Session        | 用户信息维护、权限定义 |
    | 授权管理 | 角色定义、权限分配、功能权限、数据权限           | Role, Permission, DataScope       | 身份验证、用户信息     |
    | 审计管理 | 登录日志、操作日志、安全事件                     | LoginLog, AuditLog, SecurityEvent | 日志分析、监控告警     |
    | 配置管理 | 系统配置、租户配置、用户类型配置、配置优先级合并 | SystemConfig, TenantConfig        | 业务逻辑执行、权限判断 |

    表 2.2.2-1 子领域职责边界

+   边界划分说明：
    -   用户管理只关心"用户是谁"，不关心"用户能做什么"
    -   组织管理只关心"组织结构和人员归属"，不关心"用户如何登录"
    -   认证只关心"身份真伪"，验证通过后签发Token，不判断权限
    -   授权只关心"权限有无"，基于Token中的用户信息进行判断
    -   审计只关心"操作记录"，不做实时拦截或告警（告警属于监控领域）
    -   配置管理只关心"策略参数值"，不关心参数在各子领域中的具体使用方式

### 2.2.3 子领域关系图

+   六个子领域的依赖关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         BC-10 子领域关系图                                  │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                 ┌─────────────────┐    ┌─────────────────┐                  │
    │                 │    用户管理     │    │    组织管理     │                  │
    │                 │     (User)      │    │ (Organization)  │                  │
    │                 │                 │    │                 │                  │
    │                 │ • 用户生命周期  │    │ • 组织架构      │                  │
    │                 │ • 账号凭证      │    │ • 岗位人员      │                  │
    │                 └────────┬────────┘    └────────┬────────┘                  │
    │                          │                      │                           │
    │                          │ 提供用户信息          │ 提供组织归属信息         │
    │                          └──────────┬───────────┘                           │
    │                                     │                                       │
    │                                     ▼                                       │
    │                          ┌─────────────────┐                                │
    │                          │      认证管理   │                                │
    │                          │(Authentication) │                                │
    │                          │                 │                                │
    │                          │ • 身份验证      │                                │
    │                          │ • Token签发     │                                │
    │                          │ • 会话管理      │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │                                   │ 提供身份凭证(Token)                     │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │      授权管理   │                                │
    │                          │(Authorization)  │                                │
    │                          │                 │                                │
    │                          │ • 角色管理      │                                │
    │                          │ • 功能权限      │                                │
    │                          │ • 数据权限      │                                │
    │                          └─────────────────┘                                │
    │                                                                             │
    │  ┌───────────────────────────────────────────────────────────────────────┐  │
    │  │                          配置管理                                     │  │
    │  │                    (Configuration)                                    │  │
    │  │                                                                       │  │
    │  │  为以上子领域提供策略参数：认证策略、密码策略、会话策略等             │  │
    │  └───────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    │  ┌───────────────────────────────────────────────────────────────────────┐  │
    │  │                          审计管理                                     │  │
    │  │                        (Audit)                                        │  │
    │  │                                                                       │  │
    │  │  记录以上所有子领域的关键操作：登录、权限变更、配置变更、敏感操作     │  │
    │  └───────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.2.3-1 BC-10子领域关系图

+   依赖关系说明：
    -   认证依赖用户管理：认证时需要查询用户信息、验证凭证
    -   授权依赖认证：授权判断基于认证签发的Token
    -   授权依赖组织管理：数据权限计算需要用户的组织归属信息
    -   配置管理为用户管理、认证管理、授权管理提供策略参数（密码策略、会话超时、MFA策略等）
    -   审计横切所有子领域：记录各子领域的关键操作（含配置变更）

### 2.2.4 子领域与章节映射

+   本文档后续章节按子领域组织，映射关系如下表所示。

    | 子领域   | 对应章节       | 章节内容                                     | 说明                     |
    | -------- | -------------- | -------------------------------------------- | ------------------------ |
    | 用户管理 | 第3章 用户管理 | 用户生命周期                                 |                          |
    | 组织管理 | 第4章 组织管理 | 组织架构、岗位、人员                         |                          |
    | 认证管理 | 第5章 认证管理 | 认证流程、Token管理、会话管理                |                          |
    | 授权管理 | 第6章 权限管理 | 角色管理、功能权限、数据权限                 | 子领域名：授权管理       |
    | 审计管理 | 第7章 审计管理 | 登录日志、操作日志                           |                          |
    | 共享服务 | 第8章 共享服务 | Token、密码、验证码、MFA、权限加载、审计日志 | 横切关注点，非独立子领域 |
    | 配置管理 | 第9章 配置管理 | 系统配置、租户配置、配置优先级合并           |                          |

    表 2.2.4-1 子领域与章节映射

    注：共享服务不是独立子领域，而是为各子领域提供的横切基础能力，为便于文档导航在此一并列出。

+   用户群（UP / UR / UC）作为**数据隔离维度**，贯穿各子领域，在每个子领域内部体现差异。

## 2.3 用户管理概要

### 2.3.1 职责范围

+   用户管理子领域负责管理"是什么人"，核心职责如下表所示。

    | 职责分类 | 具体职责                                                                                        | 适用用户群       |
    | -------- | ----------------------------------------------------------------------------------------------- | ---------------- |
    | 账号管理 | 用户注册、信息维护、状态管理、账号注销                                                          | 全部             |
    | 凭证管理 | 密码设置、密码找回、密码策略                                                                    | 全部             |
    | 组织架构 | 组织单元、岗位、人员、任职关系、汇报关系（归组织管理子领域，此处列出仅为完整性参考，详见第4章） | 租户用户群（UR） |
    | 用户查询 | 用户列表、用户详情、用户搜索                                                                    | 全部             |

    表 2.3.1-1 用户管理职责范围

+   职责边界说明：
    -   用户管理负责维护用户的静态信息（是谁、属于哪个组织）
    -   登录验证属于认证子领域，用户管理只提供凭证数据
    -   角色分配属于授权子领域，用户管理只提供用户主体

### 2.3.2 用户分类体系

+   系统存在5类用户，按用户群（UserPool）划分为UP、UR、UC三大类。
+   用户分类总览如下表所示。

    | 用户群（UserPool） | 用户类型（UserType） | 代码标识       | 角色范围      | 业务场景                             |
    | ------------------ | -------------------- | -------------- | ------------- | ------------------------------------ |
    | UP（运营用户群）   | 运营方管理员         | provider_admin | 系统管理员等  | 平台级系统配置、权限定义、字典管理   |
    | UP（运营用户群）   | 运营方用户           | provider_user  | UP-01 ~ UP-06 | 知识中台运营：外规采集、质检、发布等 |
    | UR（租户用户群）   | 租户管理员           | ur_admin       | 租户超管等    | 租户内用户管理、角色分配、组织维护   |
    | UR（租户用户群）   | 租户用户             | ur_user        | UR-01 ~ UR-10 | 企业租户合规管理：制度管理、合规验证 |
    | UC（C端用户群）    | 个人用户             | uc_user        | UC-01 ~ UC-04 | 个人用户：知识检索、学习             |

    表 2.3.2-1 用户分类总览

    +   **用户群编码说明**：UP = User Provider（运营用户群），UR = User Renter（租户用户群），UC = User Consumer（C端用户群）。详见附录B用户概念体系。

+   用户类型枚举定义如下表所示。

    | 枚举值         | 编码           | 名称         | 所属用户群 | 说明             |
    | -------------- | -------------- | ------------ | ---------- | ---------------- |
    | PROVIDER_ADMIN | provider_admin | 运营方管理员 | UP         | 运营方运维人员   |
    | PROVIDER_USER  | provider_user  | 运营方用户   | UP         | 运营方业务人员   |
    | UR_ADMIN       | ur_admin       | 租户管理员   | UR         | 企业租户IT人员   |
    | UR_USER        | ur_user        | 租户用户     | UR         | 企业租户业务人员 |
    | UC_USER        | uc_user        | 个人用户     | UC         | 独立个人用户     |

    表 2.3.2-2 用户类型枚举定义

### 2.3.3 各类用户本质区别

+   5类用户在身份归属、数据边界、认证入口、生命周期管理等方面存在本质区别。
+   各类用户的本质区别如下表所示。

    | 维度       | 运营方管理员   | 运营方用户     | 租户管理员     | 租户用户         | 个人用户     |
    | ---------- | -------------- | -------------- | -------------- | ---------------- | ------------ |
    | 身份归属   | 运营方运维人员 | 运营方业务人员 | 企业租户IT人员 | 企业租户业务人员 | 独立个人     |
    | 数据边界   | 系统配置数据   | 知识中台数据   | 本租户配置数据 | 本租户业务数据   | 个人私有数据 |
    | 认证入口   | 供给侧管理后台 | 供给侧运营后台 | 租户管理后台   | 租户工作台       | 个人门户     |
    | 生命周期   | 运营方HR管理   | 运营方HR管理   | 租户自主管理   | 租户自主管理     | 自助注册     |
    | 典型数量级 | 十级           | 百级           | 百级/租户      | 万级/租户        | 百万级       |

    表 2.3.3-1 各类用户本质区别

### 2.3.4 用户存储架构

+   系统采用三库分离架构，按用户群划分为平台库、租户库、C端库。
+   数据库分库策略如下表所示。

    | 数据库                   | 用途   | 存储的用户类型         | 数量 |
    | ------------------------ | ------ | ---------------------- | ---- |
    | clarisphere_platform     | 平台库 | 运营管理员、运营方用户 | 1个  |
    | clarisphere_t{tenant_id} | 租户库 | 租户管理员、租户用户   | N个  |
    | clarisphere_consumer     | C端库  | 个人用户               | 1个  |

    表 2.3.4-1 数据库分库策略

+   用户表存储映射如下表所示。

    | 用户类型     | 数据库                   | 用户表   | user_type字段值 |
    | ------------ | ------------------------ | -------- | --------------- |
    | 运营方管理员 | clarisphere_platform     | iam_user | provider_admin  |
    | 运营方用户   | clarisphere_platform     | iam_user | provider_user   |
    | 租户管理员   | clarisphere_t{tenant_id} | iam_user | ur_admin        |
    | 租户用户     | clarisphere_t{tenant_id} | iam_user | ur_user         |
    | 个人用户     | clarisphere_consumer     | iam_user | uc_user         |

    表 2.3.4-2 用户表存储映射

+   用户分类与存储架构的整体关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                           用户分类架构图                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                                   ┌─────────────┐                           │
    │                                   │  系统用户   │                           │
    │                                   └──────┬──────┘                           │
    │                                          │                                  │
    │                 ┌────────────────────────┼────────────────────┐             │
    │                 │                        │                    │             │
    │                 ▼                        ▼                    ▼             │
    │        ┌────────────────┐        ┌────────────────┐    ┌───────────────┐    │
    │        │    供给侧      │        │   消费侧A      │    │    消费侧B    │    │
    │        │  (provider)    │        │     (ur)       │    │     (uc)      │    │
    │        └───────┬────────┘        └───────┬────────┘    └───────┬───────┘    │
    │                │                         │                     │            │
    │          ┌─────┴─────┐             ┌─────┴─────┐               │            │
    │          │           │             │           │               │            │
    │          ▼           ▼             ▼           ▼               ▼            │
    │    ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────────┐    │
    │    │ 运营方   │ │ 运营方   │ │ 租户     │ │ 租户     │ │ 个人          │    │
    │    │ 管理员   │ │ 用户     │ │ 管理员   │ │ 用户     │ │ 用户          │    │
    │    │ provider │ │ provider │ │ ur_admin │ │ ur_user  │ │ uc_user       │    │
    │    │ _admin   │ │ _user    │ │          │ │          │ │               │    │
    │    └──────────┘ └──────────┘ └──────────┘ └──────────┘ └───────────────┘    │
    │          │           │            │             │            │              │
    │          └─────┬─────┘            └──────┬──────┘            │              │
    │                │                         │                   │              │
    │                ▼                         ▼                   ▼              │
    │    ┌───────────────────────┐ ┌───────────────────────┐ ┌────────────────┐   │
    │    │ clarisphere_          │ │ clarisphere_          │ │ clarisphere_   │   │
    │    │ platform              │ │ t{tenant_id}          │ │ consumer       │   │
    │    │ (平台库)              │ │ (租户库 × N)          │ │ (C端库)        │   │
    │    └───────────────────────┘ └───────────────────────┘ └────────────────┘   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.3.4-1 用户分类与存储架构图

### 2.3.5 核心概念

+   用户管理子领域的核心概念如下表所示。

    | 概念     | 英文         | 说明                                     | 所在库   |
    | -------- | ------------ | ---------------------------------------- | -------- |
    | 平台用户 | PlatformUser | 运营方用户实体，含管理员和业务用户       | platform |
    | 租户用户 | TenantUser   | 租户用户群（UR）实体，含管理员和业务用户 | tenant   |
    | 个人用户 | ConsumerUser | C端用户实体                              | consumer |
    | 组织单元 | Organization | 租户内的组织架构节点，树形结构           | tenant   |
    | 岗位     | Position     | 租户内的岗位定义                         | tenant   |
    | 人员     | Person       | 租户内的自然人，可关联多个岗位           | tenant   |
    | 任职     | Employment   | 人员与岗位的关联关系                     | tenant   |
    | 账号     | Account      | 用户的登录账号信息（用户名、手机、邮箱） | 各库     |

    表 2.3.5-1 用户管理核心概念

+   概念关系说明：
    -   用户（User）是登录主体，账号（Account）是登录凭证载体
    -   人员（Person）是自然人，一个人员可以有多个任职（Employment）
    -   组织单元（Organization）构成树形结构，人员通过任职挂靠在组织下的岗位上
    -   租户用户（TenantUser）与人员（Person）是1:1关系，创建用户时自动创建对应人员
    -   用户侧（UserSide）是商业视角的二分法：PROVIDER（供给侧）、CONSUMER（消费侧）
    -   用户群（UserPool）是数据隔离维度，包括：UP（运营用户群）、UR（租户用户群）、UC（C端用户群）
    -   用户类型（UserType）是权限视角的细分，包括：PROVIDER_ADMIN、PROVIDER_USER、UR_ADMIN、UR_USER、UC_USER
    -   三层概念的包含关系：UserSide → UserPool → UserType，详见附录B

## 2.4 认证管理概要

### 2.4.1 职责范围

+   认证管理子领域负责验证"是不是他"，核心职责如下表所示。

    | 职责分类   | 具体职责                                     | 适用用户群 |
    | ---------- | -------------------------------------------- | ---------- |
    | 身份验证   | 凭证认证、验证码认证、MFA多因素认证          | 全部       |
    | Token管理  | Token签发、Token刷新、Token注销、Token黑名单 | 全部       |
    | 会话管理   | 会话创建、会话续期、会话销毁、并发会话控制   | 全部       |
    | 第三方认证 | OAuth登录、SSO集成                           | uc / ur    |

    表 2.4.1-1 认证管理职责范围

+   职责边界说明：
    -   认证管理只负责验证身份、签发凭证，不负责用户信息维护
    -   认证成功后签发Token，Token中携带用户基本信息和角色信息
    -   权限判断属于授权子领域，认证管理不做权限校验

### 2.4.2 多入口认证架构

+   系统为不同用户群提供独立的认证入口，实现认证隔离。
+   认证入口与数据源映射如下表所示。

    | API路径前缀（标准） | API路径前缀（兼容） | 用户群（UserPool） | 数据源                   | 前端应用        |
    | ------------------- | ------------------- | ------------------ | ------------------------ | --------------- |
    | /api/v1/up/iam/**   | /api/v1/provider/** | UP                 | clarisphere_platform     | 运营方后台      |
    | /api/v1/ur/iam/**   | /api/v1/tenant/**   | UR                 | clarisphere_t{tenant_id} | 租户管理/工作台 |
    | /api/v1/uc/iam/**   | /api/v1/consumer/** | UC                 | clarisphere_consumer     | 个人门户        |

    表 2.4.2-1 认证入口与数据源映射

+   **路径命名规范**：本文档统一使用简写形式（/up/、/ur/、/uc/），与UserPool枚举值对应。全称形式（/provider/、/tenant/、/consumer/）作为兼容路径保留，代码层面两者等价。

+   多入口认证架构如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                           多入口认证架构图                                  │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌──────────────┐  │
    │  │ 供给侧管理后台│  │ 供给侧运营后台│  │  租户工作台   │  │  个人门户    │  │
    │  │ (管理员登录)  │  │ (业务员登录)  │  │ (租户用户)    │  │  (C端用户)   │  │
    │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  └──────┬───────┘  │
    │          │                  │                  │                 │          │
    │          └────────┬─────────┘                  │                 │          │
    │                   │                            │                 │          │
    │                   ▼                            ▼                 ▼          │
    │          ┌────────────────┐          ┌────────────────┐  ┌──────────────┐   │
    │          │ /api/v1/       │          │ /api/v1/       │  │ /api/v1/     │   │
    │          │ up/iam/        │          │ ur/iam/        │  │ uc/iam/      │   │
    │          │ auth/**        │          │ auth/**        │  │ auth/**      │   │
    │          └────────┬───────┘          └────────┬───────┘  └──────┬───────┘   │
    │                   │                           │                 │           │
    │                   └───────────────┬───────────┴─────────────────┘           │
    │                                   │                                         │
    │                                   ▼                                         │
    │                        ┌─────────────────────┐                              │
    │                        │      svc-iam        │                              │
    │                        │   (认证核心服务)    │                              │
    │                        └─────────────────────┘                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.4.2-1 多入口认证架构图

### 2.4.3 认证方式差异

+   不同用户类型支持的认证方式存在差异，以满足各自的安全和便捷性要求。
+   各用户类型认证方式如下表所示。

    | 用户类型     | 主要认证方式  | 辅助认证方式 | MFA要求 | 说明           |
    | ------------ | ------------- | ------------ | ------- | -------------- |
    | 运营方管理员 | 用户名 + 密码 | -            | 强制    | 安全要求最高   |
    | 运营方用户   | 用户名 + 密码 | 手机验证码   | 强制    | 安全要求高     |
    | 租户管理员   | 用户名 + 密码 | 企业SSO      | 可配置  | 由租户自行决定 |
    | 租户用户     | 用户名 + 密码 | 企业SSO      | 可配置  | 由租户自行决定 |
    | 个人用户     | 手机验证码    | 第三方OAuth  | 不要求  | 便捷性优先     |

    表 2.4.3-1 各用户类型认证方式

### 2.4.4 核心概念

+   认证管理子领域的核心概念如下表所示。

    | 概念        | 英文           | 说明                                  |
    | ----------- | -------------- | ------------------------------------- |
    | 凭证        | Credential     | 用于身份验证的信息，如密码、验证码    |
    | 访问令牌    | AccessToken    | JWT格式的短期令牌，用于API访问        |
    | 刷新令牌    | RefreshToken   | 长期令牌，用于获取新的访问令牌        |
    | 会话        | Session        | 用户登录后的状态，关联Token和设备信息 |
    | 验证码      | Captcha        | 图形验证码、短信验证码、邮件验证码    |
    | 多因素认证  | MFA            | 密码之外的第二重验证，如TOTP          |
    | Token黑名单 | TokenBlacklist | 已注销但未过期的Token列表             |

    表 2.4.4-1 认证管理核心概念

## 2.5 授权管理概要

### 2.5.1 职责范围

+   授权管理子领域负责控制"能做什么"，核心职责如下表所示。

    | 职责分类 | 具体职责                               | 适用用户群 |
    | -------- | -------------------------------------- | ---------- |
    | 角色管理 | 角色定义、角色分配、角色互斥           | 全部       |
    | 功能权限 | 权限资源点定义、角色权限分配、权限校验 | 全部       |
    | 数据权限 | 数据范围定义、组织维度权限、跨部门授权 | ur         |
    | 权限查询 | 用户权限列表、权限判断接口             | 全部       |

    表 2.5.1-1 授权管理职责范围

### 2.5.2 权限模型

+   系统采用RBAC（Role-Based Access Control）模型，扩展支持数据权限。
+   权限模型的核心关系：用户 → 角色 → 权限。
+   功能权限与数据权限的区别如下表所示。

    | 维度     | 功能权限                 | 数据权限                         |
    | -------- | ------------------------ | -------------------------------- |
    | 控制对象 | 能访问哪些功能           | 能看到哪些数据                   |
    | 适用范围 | 全部用户群               | ur和uc（模型不同）               |
    | 模型基础 | RBAC（角色-权限）        | ur基于组织架构，uc基于订阅级别   |
    | 典型场景 | 菜单可见性、按钮可操作性 | ur看本部门数据，uc看订阅的场景包 |

    表 2.5.2-1 功能权限与数据权限对比

### 2.5.3 各用户群授权机制

+   不同用户群的授权机制存在本质差异，如下表所示。

    | 维度     | provider           | ur                         | uc                     |
    | -------- | ------------------ | -------------------------- | ---------------------- |
    | 角色来源 | 预置               | 预置 + 自定义              | 预置                   |
    | 角色存储 | 平台库             | 预置→平台库，自定义→租户库 | 平台库                 |
    | 权限定义 | 平台库             | 平台库                     | 平台库                 |
    | 分配方式 | 平台管理员手动分配 | 租户管理员手动分配         | 按订阅级别自动关联     |
    | 数据权限 | 无                 | 有（基于组织架构）         | 有（基于订阅内容范围） |

    表 2.5.3-1 各用户群授权机制对比

+   授权机制说明：
    -   **权限资源点统一定义在平台库**，所有用户群共享同一套权限定义
    -   **预置角色在平台库**，各用户群只读不可修改
    -   **租户自定义角色在租户库**，只能关联平台库中已定义的权限
    -   **C端用户无需手动分配**，订阅级别自动对应预置角色

### 2.5.4 角色与权限存储架构

+   角色与权限的存储分布如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        角色与权限存储架构图                                 │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐   │
    │   │                    clarisphere_platform（平台库）                   │   │
    │   ├─────────────────────────────────────────────────────────────────────┤   │
    │   │                                                                     │   │
    │   │   ┌─────────────────┐    ┌─────────────────┐                        │   │
    │   │   │ 权限资源点定义  │    │   预置角色定义  │                        │   │
    │   │   │(platform_       │    │ (platform_role) │                        │   │
    │   │   │    permission)  │    │                 │                        │   │
    │   │   │ • 路由权限      │    │ • provider角色  │                        │   │
    │   │   │ • 菜单权限      │    │ • ur预置角色    │                        │   │
    │   │   │ • 按钮权限      │    │ • uc预置角色    │                        │   │
    │   │   │ • API权限       │    │                 │                        │   │
    │   │   │ 【全局唯一】    │    │ 【只读】        │                        │   │
    │   │   └─────────────────┘    └─────────────────┘                        │   │
    │   │                                                                     │   │
    │   └─────────────────────────────────────────────────────────────────────┘   │
    │                         ▲                    ▲                              │
    │                         │ 引用               │ 引用                         │
    │                         │                    │                              │
    │   ┌─────────────────────┴────────────────────┴──────────────────────────┐   │
    │   │                clarisphere_t{tenant_id}（租户库）                   │   │
    │   ├─────────────────────────────────────────────────────────────────────┤   │
    │   │                                                                     │   │
    │   │   ┌─────────────────┐    ┌─────────────────┐                        │   │
    │   │   │ 租户自定义角色  │    │  用户角色关联   │                        │   │
    │   │   │ (tenant_role)   │    │(tenant_user_role)                        │   │
    │   │   │                 │    │                 │                        │   │
    │   │   │ • 引用平台权限  │    │ • 预置角色引用  │                        │   │
    │   │   │ • 租户可增删改  │    │ • 自定义角色    │                        │   │
    │   │   └─────────────────┘    └─────────────────┘                        │   │
    │   │                                                                     │   │
    │   └─────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.5.4-1 角色与权限存储架构图

### 2.5.5 C端用户订阅级别与权限

+   C端用户（uc）的权限由订阅级别自动决定，无需手动分配。
+   订阅级别与预置角色的对应关系如下表所示。

    | 订阅级别   | 预置角色      | 功能范围                     | 说明         |
    | ---------- | ------------- | ---------------------------- | ------------ |
    | GUEST      | uc_guest      | 公开内容浏览、注册引导       | 未注册游客   |
    | FREE       | uc_free       | 基础检索、每日限量查询       | 免费注册用户 |
    | BASIC      | uc_basic      | 标准检索、收藏、历史记录     | 基础订阅用户 |
    | PREMIUM    | uc_premium    | 高级检索、导出、API调用      | 高级订阅用户 |
    | ENTERPRISE | uc_enterprise | 全功能、批量操作、优先级支持 | 企业订阅用户 |

    表 2.5.5-1 订阅级别与预置角色对应关系

+   游客（GUEST）说明：
    -   未注册或未登录状态的访客
    -   无user_id，系统使用匿名标识（设备指纹或session_id）追踪
    -   只能访问公开内容，核心功能引导注册

### 2.5.6 数据权限设计

+   数据权限控制用户能看到哪些数据，ur和uc采用不同的数据权限模型。

#### 2.5.6.1 租户用户数据权限（ur）

+   租户用户的数据权限基于组织架构，控制能看到哪些部门的数据。
+   数据权限范围定义如下表所示。

    | 范围编码 | 范围名称     | 说明                             |
    | -------- | ------------ | -------------------------------- |
    | 1        | 仅本人       | 只能查看自己创建的数据           |
    | 2        | 本部门       | 能查看本部门所有人的数据         |
    | 3        | 本部门及下级 | 能查看本部门及所有下级部门的数据 |
    | 4        | 全部         | 能查看本租户所有数据             |
    | 5        | 自定义       | 按指定部门列表授权               |

    表 2.5.6.1-1 租户用户数据权限范围

#### 2.5.6.2 个人用户数据权限（uc）

+   个人用户的数据权限基于订阅级别，控制能访问哪些内容范围（如行业场景包）。
+   订阅级别与内容范围的对应关系如下表所示。

    | 订阅级别   | 内容范围                 |
    | ---------- | ------------------------ |
    | GUEST      | 仅公开内容               |
    | FREE       | 公开内容 + 试用内容      |
    | BASIC      | 单一行业场景包           |
    | PREMIUM    | 指定行业场景包（可多选） |
    | ENTERPRISE | 全部行业场景包           |

    表 2.5.6.2-1 个人用户内容范围

### 2.5.7 核心概念

+   授权管理子领域的核心概念如下表所示。

    | 概念       | 英文         | 说明                                   |
    | ---------- | ------------ | -------------------------------------- |
    | 预置角色   | PresetRole   | 平台定义的角色，各用户群只读           |
    | 自定义角色 | CustomRole   | 租户自定义的角色，仅ur用户群支持       |
    | 权限       | Permission   | 对资源的操作许可，全局统一定义         |
    | 资源点     | Resource     | 被保护的资源，包括菜单、按钮、API      |
    | 数据范围   | DataScope    | 用户可访问的数据边界，基于组织架构计算 |
    | 订阅级别   | Subscription | C端用户的付费等级，自动关联预置角色    |

    表 2.5.7-1 授权管理核心概念

## 2.6 审计管理概要

### 2.6.1 职责范围

+   审计管理子领域负责记录"做了什么"，核心职责如下表所示。

    | 职责分类 | 具体职责                                                                | 适用用户群 |
    | -------- | ----------------------------------------------------------------------- | ---------- |
    | 登录日志 | 登录成功、登录失败、登出、Token刷新、MFA验证、强制下线、会话过期        | 全部       |
    | 操作日志 | 用户/角色/组织/岗位/人员/任职/权限/配置的增删改等关键操作               | UP/UR      |
    | 安全事件 | 密码修改、MFA变更、账号锁定/注销、异常登录、权限提升/降级、数据授权变更 | 全部       |

    表 2.6.1-1 审计管理职责范围

+   职责边界说明：
    -   审计管理只负责**BC-10内部**的操作记录
    -   不负责其他BC的业务操作日志
    -   不负责日志分析、监控告警（属于平台日志模块职责）

### 2.6.2 与平台日志模块的关系

+   平台存在独立的日志模块（BC-15或基础设施层），负责全局日志采集、存储、分析。
+   BC-10审计管理与平台日志模块的职责划分如下表所示。

    | 维度     | BC-10 审计管理          | 平台日志模块                  |
    | -------- | ----------------------- | ----------------------------- |
    | 职责定位 | IAM领域的审计记录       | 全平台的日志基础设施          |
    | 数据范围 | 仅BC-10相关操作         | 所有BC的操作日志              |
    | 存储位置 | 各用户群对应的数据库    | 统一日志存储（ES/ClickHouse） |
    | 查询入口 | BC-10提供的审计查询接口 | 平台日志中心统一查询          |
    | 保留策略 | 按合规要求（如180天）   | 按平台统一策略                |
    | 实时性   | 同步写入                | 异步采集                      |

    表 2.6.2-1 BC-10审计管理与平台日志模块职责划分

+   协作关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                   BC-10审计管理与平台日志模块关系图                         │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌─────────────────────────────────────────────────────────────────────┐   │
    │   │                         BC-10 svc-iam                               │   │
    │   ├─────────────────────────────────────────────────────────────────────┤   │
    │   │                                                                     │   │
    │   │   用户管理 ──┐                                                      │   │
    │   │              │                                                      │   │
    │   │   认证管理 ──┤                                                      │   │
    │   │              ├──▶ 审计管理 ──┬──▶ 本地审计表（同步写入）            │   │
    │   │   授权管理 ──┤               │                                      │   │
    │   │              │               │    • iam_login_log                   │   │
    │   │   组织管理 ──┤               │    • iam_operation_log               │   │
    │   │              │               │    • iam_security_event              │   │
    │   │   配置管理 ──┘               │                                      │   │
    │   │                              │                                      │   │
    │   └──────────────────────────────┼──────────────────────────────────────┘   │
    │                                  │                                          │
    │                                  │ 发布领域事件（异步）                     │
    │                                  ▼                                          │
    │   ┌─────────────────────────────────────────────────────────────────────┐   │
    │   │                      平台日志模块（BC-15）                          │   │
    │   ├─────────────────────────────────────────────────────────────────────┤   │
    │   │                                                                     │   │
    │   │   • 日志采集（从各BC接收事件）                                      │   │
    │   │   • 日志存储（ES/ClickHouse）                                       │   │
    │   │   • 日志查询（统一查询接口）                                        │   │
    │   │   • 日志分析（报表、趋势）                                          │   │
    │   │   • 监控告警（异常检测）                                            │   │
    │   │                                                                     │   │
    │   └─────────────────────────────────────────────────────────────────────┘   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.6.2-1 BC-10审计管理与平台日志模块关系图

+   协作说明：
    -   **同步写入本地**：BC-10审计记录同步写入各用户群对应的数据库，保证事务一致性
    -   **异步发布事件**：同时发布领域事件，供平台日志模块异步采集
    -   **双写目的**：本地存储满足BC-10自身的审计查询需求，平台日志模块满足全局分析需求

### 2.6.3 日志类型

+   BC-10审计管理涉及的日志类型如下表所示。

    | 日志类型 | 记录内容                                                                | 存储表             | 保留时长 |
    | -------- | ----------------------------------------------------------------------- | ------------------ | -------- |
    | 登录日志 | 登录成功/失败、登出、Token刷新、MFA验证、强制下线、会话过期             | iam_login_log      | 180天    |
    | 操作日志 | 用户/角色/组织/岗位/人员/任职/权限/配置的增删改等关键操作               | iam_operation_log  | 180天    |
    | 安全事件 | 密码修改、MFA变更、账号锁定/注销、异常登录、权限提升/降级、数据授权变更 | iam_security_event | 365天    |

    表 2.6.3-1 BC-10审计日志类型

### 2.6.4 核心概念

+   审计管理子领域的核心概念如下表所示。

    | 概念     | 英文          | 说明                                                             |
    | -------- | ------------- | ---------------------------------------------------------------- |
    | 登录日志 | LoginLog      | 记录用户登录/登出/MFA验证/会话过期等行为                         |
    | 操作日志 | OperationLog  | 记录用户/角色/组织/权限/配置等关键业务操作的增删改               |
    | 安全事件 | SecurityEvent | 记录影响账号安全的操作（密码/MFA/锁定/注销/权限变更/数据授权等） |
    | 审计追踪 | AuditTrail    | 操作的完整追踪链路，含操作人、时间、内容                         |

    表 2.6.4-1 审计管理核心概念

## 2.7 架构总览

+   本节汇总BC-10的整体架构，包括架构图、代码结构、数据源路由、共享服务等。

### 2.7.1 整体架构图

+   BC-10整体架构如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        BC-10 整体架构图                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌───────────────────────────────────────────────────────────────────────┐  │
    │  │                          接口层 (Interfaces)                          │  │
    │  ├───────────────────┬───────────────────┬───────────────────────────────┤  │
    │  │ /api/v1/up/       │ /api/v1/ur/       │  /api/v1/uc/                  │  │
    │  │ iam/**            │ iam/**            │  iam/**                       │  │
    │  └─────────┬─────────┴─────────┬─────────┴─────────┬─────────────────────┘  │
    │            │                   │                   │                        │
    │  ┌─────────▼───────────────────▼───────────────────▼─────────────────────┐  │
    │  │                         子领域服务层                                  │  │
    │  ├────────┬──────────┬────────────┬───────────┬───────────┬──────────────┤  │
    │  │ 用户   │ 组织管理 │  认证管理  │  授权管理 │  审计管理 │  配置管理    │  │
    │  │ 管理   │ Organiz- │  Authenti- │  Authori- │  Audit    │  Configu-    │  │
    │  │ User   │ ation    │  cation    │  zation   │           │  ration      │  │
    │  └────┬───┴────┬─────┴──────┬─────┴─────┬─────┴─────┬─────┴──────┬───────┘  │
    │       │        │            │           │           │            │          │
    │       └────────┴────────────┴──────┬────┴───────────┴────────────┘          │
    │                                    │                                        │
    │  ┌─────────────────────────────────▼────────────────────────────────────┐   │
    │  │                      共享服务层 (Shared Services)                    │   │
    │  ├──────────────────────────────────────────────────────────────────────┤   │
    │  │  ┌──────────────┐ ┌───────────────┐ ┌──────────────┐                 │   │
    │  │  │ TokenService │ │PasswordService│ │CaptchaService│                 │   │
    │  │  │ Token签发验证│ │ 密码加密校验  │ │验证码生成校验│                 │   │
    │  │  └──────────────┘ └───────────────┘ └──────────────┘                 │   │
    │  │  ┌──────────────┐ ┌───────────────┐ ┌──────────────┐                 │   │
    │  │  │  MfaService  │ │ Permission    │ │ ConfigService│                 │   │
    │  │  │  MFA多因素   │ │ Loader        │ │ 配置读取合并 │                 │   │
    │  │  │              │ │ 权限定义加载  │ │              │                 │   │
    │  │  └──────────────┘ └───────────────┘ └──────────────┘                 │   │
    │  └─────────────────────────────┬────────────────────────────────────────┘   │
    │                                │                                            │
    │  ┌─────────────────────────────▼─────────────────────────────────────────┐  │
    │  │                     基础设施层 (Infrastructure)                       │  │
    │  ├───────────────────────────────────────────────────────────────────────┤  │
    │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │
    │  │  │ Repository  │ │ Gateway     │ │ Messaging   │ │ DataSource      │  │  │
    │  │  │ 持久化实现  │ │ 防腐层      │ │ 事件发布    │ │ 动态数据源路由  │  │  │
    │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │
    │  │  ┌─────────────┐ ┌─────────────┐                                      │  │
    │  │  │ Redis       │ │ Security    │                                      │  │
    │  │  │ 缓存与会话  │ │ JWT与加密   │                                      │  │
    │  │  └─────────────┘ └─────────────┘                                      │  │
    │  └─────────────────────────────┬─────────────────────────────────────────┘  │
    │                                │                                            │
    │  ┌─────────────────────────────▼─────────────────────────────────────────┐  │
    │  │                          数据层 (Database)                            │  │
    │  ├───────────────────┬───────────────────┬───────────────────────────────┤  │
    │  │ clarisphere_      │ clarisphere_      │ clarisphere_                  │  │
    │  │ platform          │ t{tenant_id}      │ consumer                      │  │
    │  └───────────────────┴───────────────────┴───────────────────────────────┘  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 2.7.1-1 BC-10整体架构图

### 2.7.2 代码包结构

+   BC-10的代码包结构按子领域组织，如下表所示。

    | 包路径                                        | 说明           |
    | --------------------------------------------- | -------------- |
    | com.clarisphere.iam                           | BC-10根包      |
    | com.clarisphere.iam.user                      | 用户管理子领域 |
    | com.clarisphere.iam.user.domain               | 用户领域层     |
    | com.clarisphere.iam.user.application          | 用户应用层     |
    | com.clarisphere.iam.user.interfaces           | 用户接口层     |
    | com.clarisphere.iam.user.infrastructure       | 用户基础设施层 |
    | com.clarisphere.iam.org                       | 组织管理子领域 |
    | com.clarisphere.iam.org.domain                | 组织领域层     |
    | com.clarisphere.iam.org.application           | 组织应用层     |
    | com.clarisphere.iam.org.interfaces            | 组织接口层     |
    | com.clarisphere.iam.org.infrastructure        | 组织基础设施层 |
    | com.clarisphere.iam.auth                      | 认证管理子领域 |
    | com.clarisphere.iam.auth.domain               | 认证领域层     |
    | com.clarisphere.iam.auth.application          | 认证应用层     |
    | com.clarisphere.iam.auth.interfaces           | 认证接口层     |
    | com.clarisphere.iam.auth.infrastructure       | 认证基础设施层 |
    | com.clarisphere.iam.permission                | 授权管理子领域 |
    | com.clarisphere.iam.permission.domain         | 授权领域层     |
    | com.clarisphere.iam.permission.application    | 授权应用层     |
    | com.clarisphere.iam.permission.interfaces     | 授权接口层     |
    | com.clarisphere.iam.permission.infrastructure | 授权基础设施层 |
    | com.clarisphere.iam.audit                     | 审计管理子领域 |
    | com.clarisphere.iam.audit.domain              | 审计领域层     |
    | com.clarisphere.iam.audit.application         | 审计应用层     |
    | com.clarisphere.iam.audit.interfaces          | 审计接口层     |
    | com.clarisphere.iam.audit.infrastructure      | 审计基础设施层 |
    | com.clarisphere.iam.config                    | 配置管理子领域 |
    | com.clarisphere.iam.config.domain             | 配置领域层     |
    | com.clarisphere.iam.config.application        | 配置应用层     |
    | com.clarisphere.iam.config.interfaces         | 配置接口层     |
    | com.clarisphere.iam.config.infrastructure     | 配置基础设施层 |
    | com.clarisphere.iam.shared                    | 共享服务       |
    | com.clarisphere.iam.shared.token              | Token服务      |
    | com.clarisphere.iam.shared.password           | 密码服务       |
    | com.clarisphere.iam.shared.captcha            | 验证码服务     |
    | com.clarisphere.iam.shared.mfa                | MFA服务        |
    | com.clarisphere.iam.shared.permission         | 权限加载服务   |

    表 2.7.2-1 代码包结构

### 2.7.3 数据源路由

+   svc-iam服务根据请求路径动态切换数据源。
+   数据源路由规则如下表所示。

    | 请求路径前缀      | 数据源                   | 路由依据              |
    | ----------------- | ------------------------ | --------------------- |
    | /api/v1/up/iam/** | clarisphere_platform     | 固定数据源            |
    | /api/v1/ur/iam/** | clarisphere_t{tenant_id} | 从请求头获取tenant_id |
    | /api/v1/uc/iam/** | clarisphere_consumer     | 固定数据源            |

    表 2.7.3-1 数据源路由规则

+   数据源路由实现要点：
    -   使用Spring的AbstractRoutingDataSource实现动态数据源切换
    -   租户标识从JWT Token或请求头中的X-Tenant-Id获取
    -   授权管理需要同时访问平台库（权限定义）和租户库（角色分配），需支持跨库查询

### 2.7.4 共享服务

+   各子领域共享以下基础服务，避免重复建设。各服务的详细设计见第8章。

    | 服务名称         | 服务职责                                  | 使用方             |
    | ---------------- | ----------------------------------------- | ------------------ |
    | TokenService     | JWT Token签发、验证、刷新、注销           | 认证管理           |
    | PasswordService  | 密码加密、密码强度校验、密码历史检查      | 用户管理、认证管理 |
    | CaptchaService   | 图形验证码生成、短信/邮件验证码发送与校验 | 认证管理、用户管理 |
    | MfaService       | MFA设备绑定/解绑、多因素验证              | 认证管理           |
    | PermissionLoader | 权限资源点定义的加载与缓存                | 授权管理           |

    表 2.7.4-1 共享服务清单

+   ConfigService已随配置管理子领域独立，详细设计见第9章。第8.7节保留跨子领域调用视角的补充说明。

### 2.7.5 与其他BC的协作

+   BC-10作为IAM上下文，为其他BC提供身份认证和权限校验服务。
+   与其他BC的协作关系如下表所示。

    | 协作BC   | 协作方向    | 协作内容                                                               | 协作方式    |
    | -------- | ----------- | ---------------------------------------------------------------------- | ----------- |
    | BC-11    | BC-11→BC-10 | 租户开通时调用IAM表初始化（含表结构、预置角色权限、租户管理员）        | 同步API调用 |
    | BC-11    | BC-10→BC-11 | 查询租户信息（租户状态、配额）；获取租户邮箱域名配置（用于注册时校验） | 同步API调用 |
    | BC-01~09 | BC-XX→BC-10 | 权限校验、获取当前用户信息                                             | 同步API调用 |
    | BC-01~09 | BC-XX→BC-10 | 获取数据权限范围                                                       | 同步API调用 |
    | BC-15    | BC-10→BC-15 | 审计日志事件                                                           | 领域事件    |
    | BC-12    | BC-10→BC-12 | 用户注册成功发送欢迎通知                                               | 领域事件    |

    表 2.7.5-1 BC-10与其他BC的协作关系

# 3 用户管理

+   本章详细设计用户管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   用户管理负责管理"是什么人"，核心职责包括账号管理、凭证管理、用户查询。
+   组织架构（组织单元、岗位、人员、任职）的详细设计见第4章。

## 3.0  用户与组织的关系

+   组织管理仅适用于租户用户群（UR），运营用户群（UP）和C端用户群（UC）不涉及组织架构。

+   用户与组织中人员的关系如下：

    | 维度     | 用户（User）   | 人员（Person）   |
    | -------- | -------------- | ---------------- |
    | 本质     | 可登录的账号   | 组织中的自然人   |
    | 核心职责 | 身份认证       | 业务归属         |
    | 独立性   | 可独立存在     | 必须属于组织单元 |
    | 关联关系 | 可关联一个人员 | 可关联一个用户   |

    表 3.0-1 用户与人员的关系

+   不同用户来源模式下，用户与人员的创建关系不同：

    | 来源模式   | 人员创建     | 用户创建     | 关联关系         |
    | ---------- | ------------ | ------------ | ---------------- |
    | 管理员创建 | 手工创建人员 | 可选创建账号 | 手工关联（可选） |
    | 开放注册   | 不创建人员   | 用户自助注册 | 无关联           |
    | 企业同步   | 自动同步人员 | 自动创建账号 | 自动关联         |

    表 3.0-2 不同来源模式下的创建关系

+   关系说明：
    -   **管理员创建模式**：管理员在组织中创建人员，可选择是否为该人员创建登录账号；不需要登录系统的员工可以只有人员记录而没有账号
    -   **开放注册模式**：用户自助注册账号，此时用户不关联组织中的人员；管理员可后续手工关联
    -   **企业同步模式**：从外部系统（HR/AD/SCIM）同步组织和人员时，系统自动为每个人员创建对应的用户账号并建立关联

## 3.1 用户业务场景

+   本节分析各用户群的业务场景，明确用户从哪来、谁来管理、适用什么模式。
+   业务场景是后续流程设计和领域模型设计的前提和依据。

### 3.1.1 场景总览

+   三个用户群的用户来源和管理方式存在本质差异，总览如下表所示。

    | 维度       | 运营用户群（UP） | 租户用户群（UR）                  | C端用户群（UC）    |
    | ---------- | ---------------- | --------------------------------- | ------------------ |
    | 用户来源   | 管理员创建       | 多种模式可选                      | 自助注册           |
    | 来源模式   | 单一模式         | 开放注册/企业同步/管理员创建/混合 | 手机注册/三方账号  |
    | 首个用户   | 系统初始化时预置 | 租户开通时自动创建                | 无（用户自行注册） |
    | 管理责任方 | 平台运维团队     | 租户自行管理                      | 用户自我管理       |
    | 用户规模   | 十~百级          | 百~万级/租户                      | 百万级             |
    | 典型场景   | 内部运营团队     | 企业客户员工                      | 公众用户           |

    表 3.1.1-1 用户业务场景总览

### 3.1.2 运营方用户场景

+   运营方用户（provider）是平台运营方的内部用户，采用**管理员创建**的单一模式。

#### 3.1.2.1 场景特点

+   运营方用户场景特点如下：
    -   **封闭体系**：不对外开放注册，所有用户由管理员创建
    -   **首个管理员**：系统部署初始化时通过脚本或配置预置，拥有最高权限
    -   **层级创建**：首个管理员创建其他管理员，管理员创建普通用户
    -   **强管控**：用户的创建、禁用、删除均需管理员操作

#### 3.1.2.2 用户创建场景

+   运营方用户创建的典型场景如下表所示。

    | 场景编号 | 场景名称     | 触发条件     | 操作者     | 结果               |
    | -------- | ------------ | ------------ | ---------- | ------------------ |
    | P-01     | 系统初始化   | 系统首次部署 | 部署脚本   | 创建首个管理员账号 |
    | P-02     | 新增管理员   | 运维团队扩编 | 现有管理员 | 创建新管理员账号   |
    | P-03     | 新增业务用户 | 业务团队入职 | 管理员     | 创建业务用户账号   |
    | P-04     | 用户离职     | 员工离开公司 | 管理员     | 禁用或删除用户账号 |

    表 3.1.2.2-1 运营方用户创建场景

#### 3.1.2.3 管理要点

+   运营方用户管理要点：
    -   初始密码由系统生成，首次登录强制修改
    -   管理员账号需启用MFA（多因素认证）
    -   用户离职后账号应禁用而非删除，保留审计追溯能力
    -   定期审查用户权限，遵循最小权限原则

### 3.1.3 租户用户场景

+   租户用户（ur）是企业客户的员工用户，支持**多种用户获取模式**，租户可根据自身情况选择。

#### 3.1.3.1 场景特点

+   租户用户场景特点如下：
    -   **首个管理员**：租户开通时由系统自动创建，关联租户管理员角色
    -   **模式可选**：租户可选择开放注册、企业同步、管理员创建或混合模式
    -   **租户自治**：用户管理由租户管理员负责，平台不直接干预
    -   **组织关联**：用户可关联组织架构（部门、岗位），支持数据权限控制

#### 3.1.3.2 租户类型

+   系统支持两种租户类型，如下表所示。

    | 租户类型 | 说明             | 用户上限 | 有效期 | 功能范围   | 数据范围   |
    | -------- | ---------------- | -------- | ------ | ---------- | ---------- |
    | 试用租户 | 企业试用体验     | 5人      | 30天   | 基础功能   | 试用数据包 |
    | 正式租户 | 正式签约企业客户 | 按合同   | 按合同 | 按订阅套餐 | 按订阅套餐 |

    表 3.1.3.2-1 租户类型

+   试用租户说明：
    -   试用租户采用**管理员创建**模式，管理员可创建最多5个用户（含管理员自己）
    -   试用期满后，可转为正式租户或自动失效
    -   试用期间数据在转正后可保留
    -   申请试用时填写企业信息和管理员信息，审核通过后自动创建租户和管理员账号

#### 3.1.3.3 用户获取模式

+   租户用户支持四种获取模式，如下表所示。

    | 模式编号 | 模式名称   | 适用场景                 | 用户来源       | 适用租户类型 |
    | -------- | ---------- | ------------------------ | -------------- | ------------ |
    | M-01     | 管理员创建 | 小型企业、严格管控、试用 | 管理员逐个创建 | 试用/正式    |
    | M-02     | 开放注册   | 中型企业、快速扩张       | 员工自助注册   | 正式         |
    | M-03     | 企业同步   | 大型企业、已有IAM/HR/AD  | 从企业系统同步 | 正式         |
    | M-04     | 混合模式   | 复杂组织、多种需求并存   | 以上模式组合   | 正式         |

    表 3.1.3.3-1 租户用户获取模式

+   模式说明：
    -   **试用租户**仅支持管理员创建模式，最多创建5个用户
    -   **正式租户**可选择任意模式或组合

#### 3.1.3.4 模式一：管理员创建

+   **管理员创建**模式详细说明：
    -   适用场景：小型企业（< 100人）、对用户管控要求高的企业
    -   工作流程：管理员在后台逐个创建用户，填写用户信息，分配角色
    -   初始密码：系统生成随机密码，通过邮件/短信发送给用户
    -   优点：管控严格，用户信息准确
    -   缺点：管理员工作量大，用户入职到可用时间长

#### 3.1.3.5 模式二：开放注册

+   **开放注册**模式详细说明：
    -   适用场景：中型企业、快速扩张期企业、分支机构较多的企业
    -   工作流程：员工自行访问租户注册页面，使用企业邮箱注册
    -   身份验证：必须使用企业邮箱域名（如@company.com），通过邮箱验证码确认
    -   自动关联：注册成功后自动关联到该租户，分配默认角色
    -   优点：用户自助，管理员工作量小
    -   缺点：需要企业有统一邮箱域名，无法精确控制谁能注册

+   开放注册的配置项如下表所示。

    | 配置项         | 说明                     | 示例值       |
    | -------------- | ------------------------ | ------------ |
    | 允许的邮箱域名 | 限制注册邮箱的域名后缀   | @company.com |
    | 默认角色       | 注册成功后自动分配的角色 | 普通员工     |
    | 默认部门       | 注册成功后自动归属的部门 | 待分配部门   |
    | 是否需要审批   | 注册后是否需要管理员审批 | 否           |

    表 3.1.3.5-1 开放注册配置项

#### 3.1.3.6 模式三：企业同步

+   **企业同步**模式详细说明：
    -   适用场景：大型企业、已有成熟IAM/HR/AD系统的企业
    -   工作流程：对接企业现有系统，定期或实时同步用户数据
    -   对接方式：支持SCIM协议、LDAP/AD对接、HR系统API对接
    -   同步内容：用户基本信息、组织架构、岗位信息、在职状态
    -   优点：数据一致性高，用户无感知，支持大规模用户
    -   缺点：对接开发工作量大，需要企业侧配合

+   企业同步支持的对接方式如下表所示。

    | 对接方式 | 协议/技术    | 适用场景               | 同步方式 |
    | -------- | ------------ | ---------------------- | -------- |
    | SCIM     | SCIM 2.0协议 | 现代云应用集成         | 实时推送 |
    | LDAP/AD  | LDAP协议     | 微软AD环境             | 定时拉取 |
    | HR API   | REST API     | 有HR系统的企业         | 定时拉取 |
    | 文件导入 | Excel/CSV    | 一次性迁移或小批量更新 | 手动触发 |

    表 3.1.3.6-1 企业同步对接方式

#### 3.1.3.7 模式四：混合模式

+   **混合模式**详细说明：
    -   适用场景：复杂组织结构、有多种用户来源的企业
    -   典型组合：核心员工通过企业同步，外包/临时人员由管理员创建
    -   管理要点：需明确各来源用户的优先级和冲突处理规则
    -   冲突处理：同一用户多来源时，以企业同步数据为准

#### 3.1.3.8 租户如何选择模式

+   租户选择用户获取模式的决策树如下：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      租户用户获取模式选择决策                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                         企业是否有现成IAM/HR/AD系统？                       │
    │                                    │                                        │
    │                         ┌──────────┴──────────┐                             │
    │                         │                     │                             │
    │                        是                    否                             │
    │                         │                     │                             │
    │                         ▼                     ▼                             │
    │                  是否愿意投入              企业规模多大？                   │
    │                  对接开发？                      │                          │
    │                     │                            │                          │
    │              ┌──────┴──────┐             ┌───────┴───────┐                  │
    │              │             │             │               │                  │
    │             是            否           < 100人       ≥ 100人                │
    │              │             │             │               │                  │
    │              ▼             ▼             ▼               ▼                  │
    │         ┌─────────┐  ┌─────────┐     ┌─────────┐   ┌─────────┐              │
    │         │ 企业    │  │ 开放    │     │ 管理员  │   │ 开放    │              │
    │         │ 同步    │  │ 注册    │     │ 创建    │   │ 注册    │              │
    │         └─────────┘  └─────────┘     └─────────┘   └─────────┘              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.1.3.8-1 租户用户获取模式选择决策

### 3.1.4 个人用户场景

+   个人用户（uc）是面向公众的C端用户，采用**自助注册**模式。

#### 3.1.4.1 场景特点

+   个人用户场景特点如下：
    -   **完全开放**：任何人都可以注册，无需邀请或审批
    -   **自我管理**：用户自行管理个人信息、密码、绑定关系
    -   **多种注册方式**：支持手机号注册、第三方账号注册
    -   **游客模式**：支持未注册游客浏览公开内容，引导转化

#### 3.1.4.2 用户获取方式

+   个人用户的获取方式如下表所示。

    | 方式编号 | 方式名称     | 注册信息 | 验证方式   | 说明         |
    | -------- | ------------ | -------- | ---------- | ------------ |
    | C-01     | 手机号注册   | 手机号   | 短信验证码 | 主要注册方式 |
    | C-02     | 邮箱注册     | 邮箱     | 邮件验证码 | 备选注册方式 |
    | C-03     | 三方账号注册 | 授权信息 | OAuth回调  | QQ/微信/钉钉 |

    表 3.1.4.2-1 个人用户获取方式

#### 3.1.4.3 手机号/邮箱注册场景

+   **手机号/邮箱注册**详细说明：
    -   流程：输入手机号或邮箱 → 获取验证码 → 验证通过 → 注册成功
    -   唯一性：手机号和邮箱在C端库各自全局唯一
    -   初始状态：注册成功后订阅级别为FREE
    -   自动登录：注册成功后自动签发Token，无需再次登录
    -   账号绑定：手机号注册后可绑定邮箱，邮箱注册后可绑定手机号

#### 3.1.4.4 三方账号注册场景

+   **三方账号注册**详细说明：
    -   支持渠道：QQ、微信、钉钉
    -   流程：点击三方登录 → 跳转授权 → 授权成功 → 自动创建账号
    -   首次登录即注册：三方账号首次授权时自动创建本地账号
    -   账号绑定：支持后续绑定手机号，实现多种登录方式

+   三方账号注册的数据获取如下表所示。

    | 三方渠道 | 获取的用户信息     | 唯一标识 |
    | -------- | ------------------ | -------- |
    | QQ       | openid、昵称、头像 | unionid  |
    | 微信     | openid、昵称、头像 | unionid  |
    | 钉钉     | userid、姓名、头像 | unionid  |

    表 3.1.4.4-1 三方账号数据获取

### 3.1.5 场景与流程映射

+   各业务场景对应的后续流程如下表所示。
+   流程编号规则：FL-{用户群}-{序号}，其中用户群代码为P（provider）、UR、UC、CMN（通用）。

    | 用户群   | 业务场景        | 对应流程               | 流程编号  |
    | -------- | --------------- | ---------------------- | --------- |
    | provider | 系统初始化      | 初始管理员预置         | FL-P-00   |
    | provider | 管理员创建用户  | 用户创建流程           | FL-P-01   |
    | provider | 管理员删除用户  | 用户删除流程           | FL-P-02   |
    | ur       | 租户开通        | 租户管理员自动创建     | FL-UR-00  |
    | ur       | 企业试用申请    | 试用租户开通流程       | FL-UR-00A |
    | ur       | 管理员创建用户  | 用户创建流程           | FL-UR-01  |
    | ur       | 开放注册        | 租户用户注册流程       | FL-UR-02  |
    | ur       | 企业同步        | 用户同步流程           | FL-UR-03  |
    | ur       | 用户自助注销    | 用户注销流程           | FL-UR-04  |
    | ur       | 管理员删除用户  | 用户删除流程           | FL-UR-05  |
    | uc       | 手机号/邮箱注册 | 个人用户注册流程       | FL-UC-01  |
    | uc       | 三方账号注册    | 三方账号注册流程       | FL-UC-02  |
    | uc       | 用户注销        | 用户注销流程           | FL-UC-03  |
    | 通用     | 自助密码重置    | 密码重置流程           | FL-CMN-01 |
    | 通用     | 管理员协助重置  | 管理员协助重置密码流程 | FL-CMN-02 |

    表 3.1.5-1 场景与流程映射

+   用户注销/删除规则（谁创建谁删除）：

    | 用户群   | 用户来源   | 注销/删除方式 | 说明                     |
    | -------- | ---------- | ------------- | ------------------------ |
    | uc       | 自助注册   | 自助注销      | 用户自己注册，可自己注销 |
    | ur       | 开放注册   | 自助注销      | 员工自己注册，可自己注销 |
    | ur       | 企业同步   | 系统同步删除  | 从源系统同步删除状态     |
    | ur       | 管理员创建 | 管理员删除    | 谁创建谁删除             |
    | provider | 管理员创建 | 管理员删除    | 谁创建谁删除             |

    表 3.1.5-2 用户注销/删除规则

## 3.2 业务流程设计

+   本节基于3.1业务场景，详细设计各业务流程。
+   流程设计遵循《领域驱动设计详细设计文档编写指南》的流程层级规范。

### 3.2.1 流程层级说明

+   本子领域业务流程采用三层结构组织：

    | 层级     | 说明             | 图示工具    | 读者           |
    | -------- | ---------------- | ----------- | -------------- |
    | 一级流程 | 端到端完整流程   | ASCII流程图 | 产品/业务/架构 |
    | 二级流程 | 子流程（带泳道） | 时序图      | 架构/开发      |
    | 三级流程 | 功能级详细流程   | 步骤表      | 开发/测试      |

    表 3.2.1-1 流程层级说明

+   本章重点描述一级流程和关键二级流程，三级流程在接口设计中体现。

### 3.2.2 FL-P-00 初始管理员预置流程

+   本流程描述系统部署时预置首个管理员账号的过程。

#### 3.2.2.1 流程概述

+   流程基本信息如下：
    -   流程目标：系统部署完成后，预置首个供给侧管理员账号
    -   触发条件：系统首次部署或初始化
    -   结束条件：管理员账号创建成功，可正常登录
    -   执行方式：部署脚本自动执行或运维手动执行

#### 3.2.2.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 步骤名称       | 执行者   | 输入       | 输出       | 业务规则                   |
    | ---- | -------------- | -------- | ---------- | ---------- | -------------------------- |
    | 1    | 读取初始配置   | 部署脚本 | 配置文件   | 管理员信息 | 用户名、初始密码从配置读取 |
    | 2    | 检查是否已存在 | 部署脚本 | 用户名     | 存在标志   | 已存在则跳过               |
    | 3    | 创建管理员     | 部署脚本 | 管理员信息 | 用户ID     | user_type=provider_admin   |
    | 4    | 分配超管角色   | 部署脚本 | 用户ID     | 角色关联   | 关联系统超级管理员角色     |
    | 5    | 标记强制改密   | 部署脚本 | 用户ID     | 改密标志   | 首次登录必须修改密码       |

    表 3.2.2.2-1 初始管理员预置流程步骤

### 3.2.3 FL-P-01 运营方用户创建流程

+   本流程描述供给侧管理员创建其他运营方用户的过程。

#### 3.2.3.1 流程概述

+   流程基本信息如下：
    -   流程目标：管理员为平台运营团队创建用户账号
    -   触发条件：管理员在供给侧管理后台发起创建用户请求
    -   结束条件：用户创建成功，初始密码已发送
    -   预计耗时：< 3秒

+   运营方用户创建流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-P-01 运营方用户创建流程                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   管理员操作                              用户操作                          │
    │  ┌────────┐    ┌────────┐    ┌────────┐                                     │
    │  │ 开始   │───▶│ 填写   │───▶│ 权限   │                                     │
    │  │        │    │ 用户   │    │ 校验   │                                     │
    │  └────────┘    │ 信息   │    └───┬────┘                                     │
    │                └────────┘        │                                          │
    │                             权限不足                                        │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐                                      │
    │                             │ 返回   │                                      │
    │                             │ 403    │                                      │
    │                             └────────┘                                      │
    │                                  │                                          │
    │                             权限通过                                        │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐    ┌────────┐    ┌────────┐          │
    │                             │ 信息   │───▶│ 创建   │───▶│ 发送   │          │
    │                             │ 校验   │    │ 用户   │    │ 激活   │          │
    │                             └───┬────┘    │(待激活)│    │ 验证码 │          │
    │                                 │         └────────┘    └───┬────┘          │
    │                            校验失败                         │               │
    │                                 │                           │               │
    │                                 ▼                      ─ ─ ─│─ ─ ─ ─ ─      │
    │                            ┌────────┐                       ▼               │
    │                            │ 返回   │                  ┌────────┐           │
    │                            │ 错误   │                  │ 用户   │           │
    │                            └────────┘                  │ 输入   │           │
    │                                                        │ 验证码 │           │
    │                                                        └───┬────┘           │
    │                                                            │                │
    │                                                            ▼                │
    │                                                        ┌────────┐           │
    │                                                        │ 设置   │           │
    │                                                        │ 密码   │           │
    │                                                        └───┬────┘           │
    │                                                            │                │
    │                                                            ▼                │
    │                                                        ┌────────┐           │
    │                                                        │ 激活   │           │
    │                                                        │ 完成   │           │
    │                                                        └────────┘           │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.3.2-1 运营方用户创建流程
    ```

    图 3.2.3.2-1 运营方用户创建流程

#### 3.2.3.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者 | 输入          | 输出     | 业务规则                                |
    | ---- | ---------- | ------ | ------------- | -------- | --------------------------------------- |
    | 1    | 填写信息   | 管理员 | -             | 用户表单 | 必填：用户名、姓名、邮箱或手机号        |
    | 2    | 权限校验   | BC-10  | 操作者Token   | 校验结果 | 需要用户管理权限                        |
    | 3    | 信息校验   | BC-10  | 用户表单      | 校验结果 | 用户名、邮箱平台库内唯一                |
    | 4    | 创建用户   | BC-10  | 用户信息      | 用户ID   | 状态=待激活，user_type根据选择          |
    | 5    | 发送验证码 | BC-10  | 用户邮箱/手机 | 验证码   | 验证码15分钟内有效，60秒内不可重发      |
    | 6    | 输入验证码 | 用户   | 验证码        | 校验结果 | 用户在激活页面输入收到的验证码          |
    | 7    | 设置密码   | 用户   | 新密码        | -        | 用户自行设置密码，符合密码策略          |
    | 8    | 完成激活   | BC-10  | 验证码+密码   | 激活结果 | 校验验证码通过后激活，状态=正常，可登录 |

    表 3.2.3.3-1 运营方用户创建流程步骤

### 3.2.4 FL-P-02 运营方用户删除流程

+   本流程描述供给侧管理员删除用户的过程。

#### 3.2.4.1 流程概述

+   流程基本信息如下：
    -   流程目标：管理员删除已离职或无需使用的用户账号
    -   触发条件：管理员在供给侧管理后台发起删除用户请求
    -   结束条件：用户状态变更为已删除，无法登录
    -   预计耗时：< 2秒

#### 3.2.4.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称 | 执行者 | 输入        | 输出     | 业务规则                  |
    | ---- | -------- | ------ | ----------- | -------- | ------------------------- |
    | 1    | 选择用户 | 管理员 | -           | 用户ID   | 不能删除自己              |
    | 2    | 权限校验 | BC-10  | 操作者Token | 校验结果 | 需要用户管理权限          |
    | 3    | 确认删除 | 管理员 | 用户信息    | 确认     | 二次确认                  |
    | 4    | 逻辑删除 | BC-10  | 用户ID      | 删除结果 | 状态置为DELETED，保留数据 |
    | 5    | 清理会话 | BC-10  | 用户ID      | -        | 强制下线，Token加入黑名单 |
    | 6    | 记录审计 | BC-10  | 操作信息    | 审计日志 | 记录删除操作              |

    表 3.2.4.2-1 运营方用户删除流程步骤

### 3.2.5 FL-UR-00 租户管理员自动创建流程

+   本流程描述正式租户开通时自动创建租户管理员的过程。

#### 3.2.5.1 流程概述

+   流程基本信息如下：
    -   流程目标：租户开通后自动创建首个租户管理员账号
    -   触发条件：BC-11完成租户开通，发布TenantCreated事件
    -   结束条件：租户管理员账号创建成功，通知已发送
    -   执行方式：事件驱动，自动执行

#### 3.2.5.2 流程图

+   租户管理员自动创建流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-UR-00 租户管理员自动创建流程                          │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   BC-11              BC-10                管理员              BC-12         │
    │  ┌────────┐       ┌────────┐                                                │
    │  │ 租户   │       │ 接收   │                                                │
    │  │ 开通   │──────▶│ 事件   │                                                │
    │  └────────┘       └───┬────┘                                                │
    │                       │                                                     │
    │                       ▼                                                     │
    │                  ┌────────┐                                                 │
    │                  │ 创建   │                                                 │
    │                  │ 租户库 │                                                 │
    │                  └───┬────┘                                                 │
    │                      │                                                      │
    │                      ▼                                                      │
    │                  ┌────────┐                                                 │
    │                  │ 创建   │                                                 │
    │                  │ 管理员 │                                                 │
    │                  │(待激活)│                                                 │
    │                  └───┬────┘                                                 │
    │                      │                                                      │
    │                      ▼                                                      │
    │                  ┌────────┐          ┌────────┐                             │
    │                  │ 发送   │─────────▶│ 收到   │                             │
    │                  │ 激活   │          │ 验证码 │                             │
    │                  │ 验证码 │          └───┬────┘                             │
    │                  └────────┘              │                                  │
    │                                          ▼                                  │
    │                                     ┌────────┐                              │
    │                                     │ 输入   │                              │
    │                                     │ 验证码 │                              │
    │                                     └───┬────┘                              │
    │                                         │                                   │
    │                                         ▼                                   │
    │                                     ┌────────┐                              │
    │                                     │ 设置   │                              │
    │                                     │ 密码   │                              │
    │                                     └───┬────┘                              │
    │                                         │                                   │
    │                  ┌────────┐             │                                   │
    │                  │ 完成   │◀────────────┘                                   │
    │                  │ 激活   │                                                 │
    │                  └───┬────┘                                                 │
    │                      │                                                      │
    │                      ▼                                                      │
    │                  ┌────────┐          ┌────────┐                             │
    │                  │ 发布   │─────────▶│ 发送   │                             │
    │                  │ 事件   │          │ 欢迎   │                             │
    │                  │        │          │ 通知   │                             │
    │                  └────────┘          └────────┘                             │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.5.2-1 租户管理员自动创建流程

#### 3.2.5.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者 | 输入            | 输出                 | 业务规则                                |
    | ---- | ---------- | ------ | --------------- | -------------------- | --------------------------------------- |
    | 1    | 接收事件   | BC-10  | TenantCreated   | 租户信息             | 包含tenant_id、tenant_code、管理员信息  |
    | 2    | 创建租户库 | BC-10  | tenant_id       | 数据库               | 执行DDL创建clarisphere_t{tenant_id}     |
    | 3    | 创建管理员 | BC-10  | 管理员信息      | 用户ID               | 状态=待激活，user_type=ur_admin         |
    | 4    | 分配角色   | BC-10  | 用户ID          | 角色关联             | 关联租户超级管理员角色                  |
    | 5    | 发送验证码 | BC-10  | 管理员邮箱/手机 | 验证码               | 验证码15分钟内有效，60秒内不可重发      |
    | 6    | 输入验证码 | 管理员 | 验证码          | 校验结果             | 管理员在激活页面输入收到的验证码        |
    | 7    | 设置密码   | 管理员 | 新密码          | -                    | 用户自行设置密码，符合密码策略          |
    | 8    | 完成激活   | BC-10  | 验证码+密码     | 激活结果             | 校验验证码通过后激活，状态=正常，可登录 |
    | 9    | 发布事件   | BC-10  | 用户信息        | TenantAdminActivated | 通知BC-12发送欢迎通知                   |

    表 3.2.5.3-1 租户管理员自动创建流程步骤

+   流程说明：
    -   TenantAdminActivated事件在管理员**激活后**才发布，而非创建时立即发布
    -   这样确保租户管理员已经可以正常登录后，才发送欢迎通知

### 3.2.6 FL-UR-00A 试用租户开通流程

+   本流程描述企业申请试用并开通试用租户的过程。

#### 3.2.6.1 流程概述

+   流程基本信息如下：
    -   流程目标：企业用户申请试用，审核通过后开通试用租户
    -   触发条件：用户在官网提交企业试用申请
    -   结束条件：试用租户开通，管理员账号创建成功
    -   预计耗时：自动审核 < 1分钟，人工审核 < 24小时

#### 3.2.6.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者    | 输入          | 输出                   | 业务规则                     |
    | ---- | ---------- | --------- | ------------- | ---------------------- | ---------------------------- |
    | 1    | 填写申请   | 申请人    | -             | 申请表单               | 企业名称、联系人、手机、邮箱 |
    | 2    | 信息校验   | BC-10     | 申请表单      | 校验结果               | 手机号/邮箱未被占用          |
    | 3    | 审核申请   | 系统/人工 | 申请信息      | 审核结果               | 可配置自动审核或人工审核     |
    | 4    | 创建租户   | BC-11     | 企业信息      | tenant_id, tenant_code | 租户类型=试用，有效期30天    |
    | 5    | 创建管理员 | BC-10     | 管理员信息    | 用户ID                 | 同FL-UR-00                   |
    | 6    | 发送通知   | BC-12     | 租户+用户信息 | -                      | 发送试用开通通知             |

    表 3.2.6.2-1 试用租户开通流程步骤

### 3.2.7 FL-UR-01 租户用户创建流程

+   本流程描述租户管理员创建租户用户的过程。
+   **流程与FL-P-01（运营方用户创建流程）相同**，均采用验证码激活方式，此处不再重复绘制流程图。
+   主要差异如下表所示。

    | 维度             | FL-P-01 供给侧       | FL-UR-01 租户用户群       |
    | ---------------- | -------------------- | ------------------------- |
    | 操作者           | 运营方管理员         | 租户管理员                |
    | 存储位置         | clarisphere_platform | clarisphere_t{tenant_id}  |
    | 用户名唯一性     | 平台库内唯一         | 租户库内唯一              |
    | 激活验证码有效期 | 15分钟               | 15分钟（可配置）          |
    | 组织关联         | 无                   | 可关联组织岗位            |
    | 角色范围         | 平台预置角色         | 预置角色 + 租户自定义角色 |
    | 用户数量限制     | 无                   | 试用租户最多5人           |

    表 3.2.7-1 供给侧与租户用户群用户创建差异

### 3.2.8 FL-UR-02 租户用户开放注册流程

+   本流程描述租户开启开放注册后，员工自助注册的过程。

#### 3.2.8.1 流程概述

+   流程基本信息如下：
    -   流程目标：企业员工使用企业邮箱自助注册成为租户用户
    -   触发条件：员工访问租户注册页面，提交注册请求
    -   结束条件：注册成功，用户可正常登录
    -   前提条件：租户已开启开放注册功能

#### 3.2.8.2 流程图

+   租户用户开放注册流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-UR-02 租户用户开放注册流程                            │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌────────┐    ┌────────┐    ┌────────┐                                     │
    │  │ 开始   │───▶│ 输入   │───▶│ 校验   │───▶ 域名不匹配 ───▶ 返回错误        │
    │  │        │    │ 企业   │    │ 邮箱   │                                     │
    │  └────────┘    │ 邮箱   │    │ 域名   │                                     │
    │                └────────┘    └───┬────┘                                     │
    │                                  │                                          │
    │                             域名匹配                                        │
    │                                  │                                          │
    │                                  ▼                                          │
    │                             ┌────────┐                                      │
    │                             │ 发送   │                                      │
    │                             │ 验证码 │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 验证   │───▶ 验证失败 ───▶ 返回错误           │
    │                             │ 邮箱   │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                            验证成功                                         │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 设置   │                                      │
    │                             │ 密码   │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 创建   │                                      │
    │                             │ 用户   │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 分配   │                                      │
    │                             │ 默认   │                                      │
    │                             │ 角色   │                                      │
    │                             └───┬────┘                                      │
    │                                 │                                           │
    │                                 ▼                                           │
    │                             ┌────────┐                                      │
    │                             │ 完成   │                                      │
    │                             └────────┘                                      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.8.2-1 租户用户开放注册流程

#### 3.2.8.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者 | 输入        | 输出     | 业务规则               |
    | ---- | ---------- | ------ | ----------- | -------- | ---------------------- |
    | 1    | 输入邮箱   | 用户   | -           | 企业邮箱 | 必须是企业邮箱格式     |
    | 2    | 校验域名   | BC-10  | 邮箱        | 租户信息 | 邮箱域名匹配租户配置   |
    | 3    | 发送验证码 | BC-10  | 邮箱        | 验证码   | 60秒内不可重复发送     |
    | 4    | 验证邮箱   | BC-10  | 邮箱+验证码 | 校验结果 | 验证码5分钟内有效      |
    | 5    | 创建用户   | BC-10  | 用户信息    | 用户ID   | user_type=ur_user      |
    | 6    | 分配角色   | BC-10  | 用户ID      | 角色关联 | 分配租户配置的默认角色 |
    | 7    | 设置密码   | 用户   | 密码        | -        | 注册时设置密码         |

    表 3.2.8.3-1 租户用户开放注册流程步骤

### 3.2.9 FL-UC-01 个人用户注册流程

+   本流程描述C端个人用户通过手机号或邮箱注册的过程。

#### 3.2.9.1 流程概述

+   流程基本信息如下：
    -   流程目标：完成个人用户账号注册，创建可用账号
    -   触发条件：用户在个人门户发起注册请求
    -   结束条件：注册成功，用户可正常登录
    -   预计耗时：< 30秒（含验证码等待时间）

#### 3.2.9.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称   | 执行者 | 输入        | 输出           | 业务规则              |
    | ---- | ---------- | ------ | ----------- | -------------- | --------------------- |
    | 1    | 选择方式   | 用户   | -           | 注册方式       | 手机号或邮箱          |
    | 2    | 输入账号   | 用户   | -           | 手机号/邮箱    | 格式校验              |
    | 3    | 发送验证码 | BC-10  | 手机号/邮箱 | 验证码         | 60秒内不可重复发送    |
    | 4    | 校验验证码 | BC-10  | 账号+验证码 | 校验结果       | 验证码5分钟内有效     |
    | 5    | 创建用户   | BC-10  | 注册信息    | 用户ID         | user_type=uc_user     |
    | 6    | 设置订阅   | BC-10  | 用户ID      | 订阅信息       | 默认订阅级别=FREE     |
    | 7    | 签发Token  | BC-10  | 用户ID      | Token          | 注册成功自动登录      |
    | 8    | 发布事件   | BC-10  | 用户信息    | UserRegistered | 通知BC-12发送欢迎消息 |

    表 3.2.9.2-1 个人用户注册流程步骤

### 3.2.10 FL-UC-02 三方账号注册流程

+   本流程描述C端用户通过QQ/微信/钉钉等三方账号注册的过程。

#### 3.2.10.1 流程概述

+   流程基本信息如下：
    -   流程目标：用户通过三方账号授权完成注册
    -   触发条件：用户点击三方登录按钮
    -   结束条件：授权成功，账号创建，用户已登录
    -   预计耗时：< 10秒

#### 3.2.10.2 流程图

+   三方账号注册流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-UC-02 三方账号注册流程                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   用户              个人门户            BC-10             三方平台          │
    │    │                   │                  │                   │             │
    │    │  点击三方登录     │                  │                   │             │
    │    │──────────────────▶│                  │                   │             │
    │    │                   │                  │                   │             │
    │    │                   │  获取授权URL     │                   │             │
    │    │                   │─────────────────▶│                   │             │
    │    │                   │                  │                   │             │
    │    │                   │◀─────────────────│                   │             │
    │    │                   │                  │                   │             │
    │    │◀──────────────────│ 跳转授权页       │                   │             │
    │    │                                      │                   │             │
    │    │─────────────────────────────────────────────────────────▶│             │
    │    │                   用户授权                               │             │
    │    │◀─────────────────────────────────────────────────────────│             │
    │    │                   回调（带code）                         │             │
    │    │──────────────────▶│                  │                   │             │
    │    │                   │  换取用户信息    │                   │             │
    │    │                   │─────────────────▶│                   │             │
    │    │                   │                  │  code换token      │             │
    │    │                   │                  │──────────────────▶│             │
    │    │                   │                  │◀──────────────────│             │
    │    │                   │                  │  获取用户信息     │             │
    │    │                   │                  │──────────────────▶│             │
    │    │                   │                  │◀──────────────────│             │
    │    │                   │                  │                   │             │
    │    │                   │                  │  创建/关联用户    │             │
    │    │                   │◀─────────────────│                   │             │
    │    │                   │  返回Token       │                   │             │
    │    │◀──────────────────│                  │                   │             │
    │    │                   │                  │                   │             │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.10.2-1 三方账号注册流程

#### 3.2.10.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称      | 执行者 | 输入         | 输出         | 业务规则               |
    | ---- | ------------- | ------ | ------------ | ------------ | ---------------------- |
    | 1    | 选择三方平台  | 用户   | -            | 平台类型     | QQ/微信/钉钉           |
    | 2    | 获取授权URL   | BC-10  | 平台类型     | 授权URL      | 包含回调地址           |
    | 3    | 用户授权      | 用户   | -            | 授权码       | 在三方平台完成授权     |
    | 4    | 换取Token     | BC-10  | 授权码       | access_token | 调用三方接口           |
    | 5    | 获取用户信息  | BC-10  | access_token | 三方用户信息 | 昵称、头像、unionid    |
    | 6    | 查找已有绑定  | BC-10  | unionid      | 用户ID/空    | 检查是否已绑定         |
    | 7    | 创建/关联用户 | BC-10  | 三方用户信息 | 用户ID       | 新用户创建，老用户关联 |
    | 8    | 签发Token     | BC-10  | 用户ID       | Token        | 完成登录               |

    表 3.2.10.3-1 三方账号注册流程步骤

### 3.2.11 FL-CMN-01 密码重置流程

+   本流程描述用户忘记密码后重置密码的过程，适用于所有用户群。
+   **注意**：通过SSO/企业同步的用户不能在本系统重置密码，需到源系统操作。

#### 3.2.11.1 流程概述

+   流程基本信息如下：
    -   流程目标：用户通过验证身份后重置密码
    -   触发条件：用户点击"忘记密码"
    -   结束条件：密码重置成功，用户可使用新密码登录
    -   前提条件：用户认证来源为本系统（非SSO/企业同步）
    -   预计耗时：< 1分钟

#### 3.2.11.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称     | 执行者 | 输入          | 输出             | 业务规则                     |
    | ---- | ------------ | ------ | ------------- | ---------------- | ---------------------------- |
    | 1    | 输入账号     | 用户   | -             | 用户名/手机/邮箱 | 支持多种账号标识             |
    | 2    | 查找用户     | BC-10  | 账号标识      | 用户信息         | 找不到则提示账号不存在       |
    | 3    | 检查来源     | BC-10  | 用户信息      | 认证来源         | SSO/同步用户提示到源系统操作 |
    | 4    | 选择验证方式 | 用户   | -             | 验证方式         | 手机验证码/邮箱验证码        |
    | 5    | 发送验证码   | BC-10  | 手机/邮箱     | 验证码           | 60秒内不可重复发送           |
    | 6    | 校验验证码   | BC-10  | 验证码        | 校验结果         | 验证码5分钟内有效            |
    | 7    | 设置新密码   | 用户   | 新密码        | -                | 符合密码策略                 |
    | 8    | 更新密码     | BC-10  | 用户ID+新密码 | 更新结果         | 加密存储，记录修改时间       |
    | 9    | 清理会话     | BC-10  | 用户ID        | -                | 可选：强制其他设备下线       |
    | 10   | 记录审计     | BC-10  | 操作信息      | 审计日志         | 记录密码重置事件             |

    表 3.2.11.2-1 密码重置流程步骤

#### 3.2.11.3 各用户群差异

+   密码重置流程在各用户群的差异如下表所示。

    | 维度     | provider     | ur                     | uc        |
    | -------- | ------------ | ---------------------- | --------- |
    | 验证方式 | 手机/邮箱    | 手机/邮箱              | 手机/邮箱 |
    | 密码策略 | 12位复杂密码 | 按租户配置             | 6位以上   |
    | 强制下线 | 是           | 可配置                 | 否        |
    | MFA验证  | 需要         | 可配置                 | 不需要    |
    | SSO用户  | 不适用       | 不可重置，提示到源系统 | 不适用    |
    | 同步用户 | 不适用       | 不可重置，提示到源系统 | 不适用    |

    表 3.2.11.3-1 密码重置各用户群差异

+   SSO/同步用户密码管理规则：
    -   通过企业SSO登录的用户，密码由企业IdP管理，本系统不存储密码
    -   通过企业同步的用户，密码在源系统（AD/HR）管理，本系统不存储或仅同步哈希
    -   这类用户点击"忘记密码"时，提示"请联系企业IT管理员"或跳转到企业密码重置页面

### 3.2.12 FL-CMN-02 管理员协助重置密码流程

+   本流程描述用户原有邮箱/手机不可用时，由管理员协助重置密码的过程。

#### 3.2.12.1 流程概述

+   流程基本信息如下：
    -   流程目标：用户无法通过自助方式重置密码时，由管理员协助完成
    -   触发条件：用户联系管理员，说明原邮箱/手机不可用
    -   结束条件：用户通过新渠道完成密码重置
    -   前提条件：用户需线下提供身份证明材料
    -   适用用户群：provider、ur

+   备注：ur用户只能联系本企业（租户）的管理员，不能联系平台管理员。

### 3.2.12.2 流程图

+   管理员协助重置密码流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                FL-CMN-02 管理员协助重置密码流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   用户（线下）          管理员                用户（线上）                  │
    │  ┌────────┐          ┌────────┐                                             │
    │  │ 联系   │─────────▶│ 接收   │                                             │
    │  │ 管理员 │          │ 请求   │                                             │
    │  └────────┘          └───┬────┘                                             │
    │                          │                                                  │
    │                          ▼                                                  │
    │  ┌────────┐          ┌────────┐          ┌────────┐                         │
    │  │ 提供   │─────────▶│ 核实   │─────────▶│ 拒绝   │                         │
    │  │ 身份   │  线下    │ 身份   │ 核实失败 │ 请求   │                         │
    │  │ 证明   │          └───┬────┘          └────────┘                         │
    │  └────────┘              │                                                  │
    │                     核实通过                                                │
    │                          │                                                  │
    │                          ▼                                                  │
    │                     ┌────────┐                                              │
    │                     │ 更新   │                                              │
    │                     │ 联系   │                                              │
    │                     │ 方式   │                                              │
    │                     └───┬────┘                                              │
    │                         │                                                   │
    │                         ▼                                                   │
    │                     ┌────────┐          ┌────────┐                          │
    │                     │ 发送   │─────────▶│ 收到   │                          │
    │                     │ 重置   │          │ 验证码 │                          │
    │                     │ 验证码 │          └───┬────┘                          │
    │                     └────────┘              │                               │
    │                                             ▼                               │
    │                                        ┌────────┐                           │
    │                                        │ 输入   │                           │
    │                                        │ 验证码 │                           │
    │                                        └───┬────┘                           │
    │                                            │                                │
    │                                            ▼                                │
    │                                        ┌────────┐                           │
    │                                        │ 设置   │                           │
    │                                        │ 新密码 │                           │
    │                                        └───┬────┘                           │
    │                                            │                                │
    │                                            ▼                                │
    │                                        ┌────────┐                           │
    │                                        │ 完成   │                           │
    │                                        └────────┘                           │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.2.12.2-1 管理员协助重置密码流程

#### 3.2.12.3 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称     | 执行者 | 输入          | 输出     | 业务规则                               |
    | ---- | ------------ | ------ | ------------- | -------- | -------------------------------------- |
    | 1    | 联系管理员   | 用户   | -             | 重置请求 | 线下联系，说明情况                     |
    | 2    | 核实身份     | 管理员 | 身份证明材料  | 核实结果 | 线下核实，如身份证、工牌等             |
    | 3    | 更新联系方式 | 管理员 | 新邮箱/手机   | 更新结果 | 可选，更新用户的联系方式               |
    | 4    | 发送验证码   | 管理员 | 用户ID        | 验证码   | 发送到新邮箱/手机，验证码15分钟内有效  |
    | 5    | 输入验证码   | 用户   | 验证码        | 校验结果 | 在密码重置页面输入收到的验证码         |
    | 6    | 设置新密码   | 用户   | 新密码        | -        | 符合密码策略                           |
    | 7    | 完成重置     | BC-10  | 验证码+新密码 | 重置结果 | 校验验证码通过后更新密码，记录审计日志 |
    | 8    | 清理会话     | BC-10  | 用户ID        | -        | 强制其他设备下线                       |

    表 3.2.12.3-1 管理员协助重置密码流程步骤

#### 3.2.12.4 安全要求

+   管理员协助重置密码的安全要求如下：
    -   **身份核实**：管理员必须线下核实用户身份，留存证明材料
    -   **审计记录**：系统记录管理员操作，包括操作人、操作时间、目标用户
    -   **验证码有效期**：重置验证码15分钟内有效，且只能使用一次
    -   **通知原渠道**：如原邮箱/手机仍可接收消息，同时发送安全提醒
    -   **权限控制**：只有具备"用户管理"权限的管理员才能执行此操作

### 3.2.13 FL-UR-04 租户用户自助注销流程

+   本流程描述通过开放注册加入租户的用户自助注销账号的过程。

#### 3.2.13.1 流程概述

+   流程基本信息如下：
    -   流程目标：用户自助注销账号，退出租户
    -   触发条件：用户在个人设置中发起注销请求
    -   结束条件：账号注销成功，无法再登录
    -   前提条件：用户来源为"开放注册"

#### 3.2.13.2 流程步骤

+   流程步骤详细说明如下表所示。

    | 步骤 | 步骤名称 | 执行者 | 输入        | 输出     | 业务规则                     |
    | ---- | -------- | ------ | ----------- | -------- | ---------------------------- |
    | 1    | 发起注销 | 用户   | -           | 注销请求 | 检查用户来源是否为开放注册   |
    | 2    | 身份验证 | BC-10  | 密码/验证码 | 验证结果 | 确认是本人操作               |
    | 3    | 确认注销 | 用户   | -           | 确认     | 告知注销后果，二次确认       |
    | 4    | 数据处理 | BC-10  | 用户ID      | 处理结果 | 解除组织关联，保留或删除数据 |
    | 5    | 注销账号 | BC-10  | 用户ID      | 注销结果 | 状态置为CANCELLED            |
    | 6    | 清理会话 | BC-10  | 用户ID      | -        | 强制下线，Token加入黑名单    |
    | 7    | 记录审计 | BC-10  | 操作信息    | 审计日志 | 记录注销操作                 |

    表 3.2.13.2-1 租户用户自助注销流程步骤

### 3.2.14 FL-UC-03 个人用户注销流程

+   本流程描述C端个人用户注销账号的过程。
+   流程与FL-UR-04类似，主要差异如下表所示。

    | 维度     | FL-UR-04 租户用户 | FL-UC-03 个人用户      |
    | -------- | ----------------- | ---------------------- |
    | 前提条件 | 来源为开放注册    | 无限制                 |
    | 数据处理 | 解除组织关联      | 处理订阅、收藏、历史等 |
    | 冷静期   | 可配置            | 7天冷静期，期间可恢复  |
    | 三方解绑 | 不涉及            | 解除QQ/微信/钉钉绑定   |

    表 3.2.14-1 租户用户与个人用户注销差异

## 3.3 领域模型设计

+   本节设计用户管理子领域的领域模型，包括聚合划分、实体、值对象、领域服务和领域事件。
+   领域模型设计遵循DDD战术设计原则，确保业务概念的准确表达。

### 3.3.1 聚合划分

+   用户管理子领域划分为以下聚合：

    | 聚合名称     | 聚合根       | 职责               | 所属数据库               |
    | ------------ | ------------ | ------------------ | ------------------------ |
    | 平台用户聚合 | PlatformUser | 管理运营方用户     | clarisphere_platform     |
    | 租户用户聚合 | TenantUser   | 管理租户用户群用户 | clarisphere_t{tenant_id} |
    | 个人用户聚合 | ConsumerUser | 管理C端个人用户    | clarisphere_consumer     |

    表 3.3.1-1 用户管理聚合划分

+   聚合划分说明：
    -   三个用户群分别对应三个独立聚合，物理隔离在不同数据库
    -   每个聚合内部结构相似，但存在业务差异
    -   聚合之间无直接引用，通过用户ID进行跨聚合协作

### 3.3.2 聚合关系图

+   用户管理子领域聚合关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      用户管理子领域聚合关系图                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   clarisphere_platform      clarisphere_t{tenant_id}   clarisphere_consumer │
    │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
    │  │   PlatformUser      │    │    TenantUser       │    │  ConsumerUser   │  │
    │  │   (平台用户聚合)    │    │   (租户用户聚合)    │    │ (个人用户聚合)  │  │
    │  ├─────────────────────┤    ├─────────────────────┤    ├─────────────────┤  │
    │  │                     │    │                     │    │                 │  │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │ │ «聚合根»        │ │    │ │ «聚合根»        │ │    │ │ «聚合根»    │ │  │
    │  │ │ PlatformUser    │ │    │ │ TenantUser      │ │    │ │ConsumerUser │ │  │
    │  │ └────────┬────────┘ │    │ └────────┬────────┘ │    │ └──────┬──────┘ │  │
    │  │          │          │    │          │          │    │        │        │  │
    │  │          ▼          │    │          ▼          │    │        ▼        │  │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │ │ «值对象»        │ │    │ │ «值对象»        │ │    │ │ «值对象»    │ │  │
    │  │ │ Credential      │ │    │ │ Credential      │ │    │ │ Credential  │ │  │
    │  │ └─────────────────┘ │    │ └─────────────────┘ │    │ └─────────────┘ │  │
    │  │                     │    │          │          │    │        │        │  │
    │  │                     │    │          ▼          │    │        ▼        │  │
    │  │                     │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │                     │    │ │ «值对象»        │ │    │ │ «值对象»    │ │  │
    │  │                     │    │ │ UserSource      │ │    │ │ OAuthBinding│ │  │
    │  │                     │    │ └─────────────────┘ │    │ └─────────────┘ │  │
    │  │                     │    │                     │    │                 │  │
    │  └─────────────────────┘    └─────────────────────┘    └─────────────────┘  │
    │                                                                             │
    │   共享值对象（跨聚合复用）                                                  │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │  ContactInfo │ UserStatus │ PasswordPolicy                          │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.3.2-1 用户管理聚合关系图

### 3.3.3 PlatformUser 聚合（平台用户）

+   PlatformUser聚合管理运营方用户，存储在平台库。

#### 3.3.3.1 聚合结构

+   PlatformUser聚合包含以下元素：

    | 元素类型 | 元素名称     | 说明                   |
    | -------- | ------------ | ---------------------- |
    | 聚合根   | PlatformUser | 平台用户实体           |
    | 值对象   | Credential   | 凭证信息（密码哈希等） |
    | 值对象   | ContactInfo  | 联系方式（手机、邮箱） |
    | 值对象   | UserStatus   | 用户状态               |

    表 3.3.3.1-1 PlatformUser聚合结构

#### 3.3.3.2 PlatformUser 实体

+   PlatformUser是聚合根，采用三表模型定义如下。

##### 属性清单表

| 属性名      | 数据类型    | 约束                         | 默认值  | 业务含义                                |
| ----------- | ----------- | ---------------------------- | ------- | --------------------------------------- |
| id          | Long        | 必填，主键                   | 自增    | 用户唯一标识，全局唯一                  |
| username    | String      | 必填，长度3-32，平台库内唯一 | -       | 登录用户名，仅允许字母数字下划线        |
| realName    | String      | 必填，长度2-64               | -       | 用户真实姓名                            |
| userType    | UserType    | 必填，枚举                   | -       | 用户类型：provider_admin或provider_user |
| credential  | Credential  | 必填                         | -       | 凭证信息值对象，包含密码哈希等          |
| contactInfo | ContactInfo | 必填                         | -       | 联系方式值对象，包含邮箱手机等          |
| status      | UserStatus  | 必填                         | PENDING | 用户状态值对象，包含状态及禁用原因等    |
| mfaEnabled  | Boolean     | 必填                         | false   | 是否启用多因素认证，admin类型默认开启   |
| lastLoginAt | DateTime    | 可选                         | null    | 最后登录时间，登录成功时更新            |
| createdBy   | Long        | 必填                         | -       | 创建人ID，系统初始化时为SYSTEM          |
| createdAt   | DateTime    | 必填，不可变                 | NOW()   | 创建时间，记录创建时刻                  |
| updatedAt   | DateTime    | 必填                         | NOW()   | 更新时间，每次修改时自动更新            |

表 3.3.3.2-1 PlatformUser属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                | 验证时机  | 违反后果           |
| -------- | -------------- | ------------------------------------------------------- | --------- | ------------------ |
| PU-R-01  | 用户名唯一性   | username在平台库iam_user表中必须唯一                    | 创建/更新 | 拒绝操作，提示重复 |
| PU-R-02  | 用户名格式     | username仅允许字母、数字、下划线，长度3-32              | 创建      | 拒绝操作，提示格式 |
| PU-R-03  | 邮箱唯一性     | contactInfo.email在平台库内必须唯一                     | 创建/更新 | 拒绝操作，提示重复 |
| PU-R-04  | 激活前提       | 激活操作要求status=PENDING且activationToken有效且未过期 | 激活      | 拒绝操作，提示状态 |
| PU-R-05  | 密码策略       | 密码需符合供给侧策略：长度≥12，含大小写+数字+特殊字符   | 激活/改密 | 拒绝操作，提示策略 |
| PU-R-06  | 旧密码验证     | changePassword时必须验证oldPwd正确                      | 改密      | 拒绝操作，提示错误 |
| PU-R-07  | 禁用前提       | 不能禁用自己，不能禁用最后一个admin                     | 禁用      | 拒绝操作，提示原因 |
| PU-R-08  | 删除前提       | 不能删除自己，状态需为DISABLED                          | 删除      | 拒绝操作，提示原因 |
| PU-R-09  | MFA管理员强制  | userType=provider_admin时，mfaEnabled必须为true         | 创建/更新 | 自动设为true       |
| PU-R-10  | 激活令牌有效期 | activationToken有效期24小时，过期需重新生成             | 激活      | 拒绝操作，提示过期 |

表 3.3.3.2-2 PlatformUser业务规则表

##### 业务方法表

| 方法名              | 方法简述                           | 关联规则         | 异常                             | 事件                |
| ------------------- | ---------------------------------- | ---------------- | -------------------------------- | ------------------- |
| create()            | 静态工厂方法，创建待激活状态用户   | PU-R-01,02,03,09 | UserAlreadyExistsException       | UserCreated         |
| activate()          | 验证激活验证码后激活账号并设置密码 | PU-R-04,05,10    | InvalidVerificationCodeException | UserActivated       |
| changePassword()    | 用户自助修改密码，需验证旧密码     | PU-R-05,06       | PasswordPolicyViolationException | UserPasswordChanged |
| resetPassword()     | 管理员协助重置密码，无需旧密码验证 | PU-R-05          | PasswordPolicyViolationException | UserPasswordReset   |
| updateContactInfo() | 更新联系方式，需验证新邮箱唯一性   | PU-R-03          | UserAlreadyExistsException       | -                   |
| disable()           | 禁用账号，记录禁用原因和时间       | PU-R-07          | OperationNotAllowedException     | UserDisabled        |
| enable()            | 启用已禁用的账号，清除禁用原因     | -                | InvalidUserStatusException       | UserEnabled         |
| delete()            | 逻辑删除，状态置为DELETED          | PU-R-08          | OperationNotAllowedException     | UserDeleted         |
| enableMfa()         | 启用多因素认证                     | -                | -                                | MfaEnabled          |
| disableMfa()        | 禁用多因素认证                     | PU-R-09          | OperationNotAllowedException     | MfaDisabled         |

表 3.3.3.2-3 PlatformUser业务方法表

+   备注：
    -   PU-R-07规则"最后一个admin"的判断：查询userType=provider_admin且status=ACTIVE的记录数，若仅剩1条则禁止禁用
    -   MfaDisabled操作对provider_admin类型用户会被PU-R-09规则阻止

#### 3.3.3.3 Credential 值对象

+   Credential值对象封装凭证信息，采用三表模型定义如下。

##### 属性清单表

 | 属性名             | 数据类型   | 约束                  | 默认值 | 业务含义                             |
 | ------------------ | ---------- | --------------------- | ------ | ------------------------------------ |
 | passwordHash       | String     | LOCAL时必填，长度≤128 | null   | 密码哈希值，使用Argon2id算法         |
 | passwordSalt       | String     | LOCAL时必填，长度≤64  | null   | 密码盐值，随机生成                   |
 | passwordChangedAt  | DateTime   | LOCAL时必填           | null   | 密码最后修改时间，用于过期检查       |
 | mustChangePassword | Boolean    | 必填                  | false  | 是否强制下次登录修改密码             |
 | authSource         | AuthSource | 必填，枚举            | LOCAL  | 认证来源：LOCAL本地认证，SSO单点登录 |

表 3.3.3.3-1 Credential属性清单表

##### 业务规则表

| 规则编号 | 规则名称      | 规则简述                                               | 验证时机  | 违反后果     |
| -------- | ------------- | ------------------------------------------------------ | --------- | ------------ |
| CR-R-01  | LOCAL凭证必填 | authSource=LOCAL时，passwordHash和passwordSalt必须有值 | 创建/更新 | 抛出校验异常 |
| CR-R-02  | SSO凭证为空   | authSource=SSO时，密码相关字段应为null                 | 创建      | 自动置空     |
| CR-R-03  | 哈希算法      | 供给侧和租户用户群使用Argon2id，C端用户群使用BCrypt    | 创建/改密 | -            |
| CR-R-04  | 密码不可逆    | 仅存储哈希值，系统无法还原明文密码                     | -         | -            |

表 3.3.3.3-2 Credential业务规则表

+   备注：Credential为值对象，无独立业务方法，由聚合根管理其生命周期。

#### 3.3.3.4 ContactInfo 值对象

+   ContactInfo值对象封装联系方式，采用三表模型定义如下。

##### 属性清单表

 | 属性名         | 数据类型 | 约束                       | 默认值 | 业务含义                             |
 | -------------- | -------- | -------------------------- | ------ | ------------------------------------ |
 | mobile         | String   | 可选，格式：中国大陆手机号 | null   | 联系手机号，用于短信通知和验证码登录 |
 | mobileVerified | Boolean  | 必填                       | false  | 手机号是否已验证，验证后才可用于登录 |
 | email          | String   | 必填，格式：合法邮箱地址   | -      | 联系邮箱，用于激活、重置密码、通知   |
 | emailVerified  | Boolean  | 必填                       | false  | 邮箱是否已验证，激活成功后自动置true |

表 3.3.3.4-1 ContactInfo属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                      | 验证时机  | 违反后果 |
| -------- | -------------- | --------------------------------------------- | --------- | -------- |
| CI-R-01  | 邮箱格式       | email必须符合RFC 5322邮箱格式                 | 创建/更新 | 拒绝操作 |
| CI-R-02  | 手机格式       | mobile若填写，必须是11位中国大陆手机号        | 创建/更新 | 拒绝操作 |
| CI-R-03  | 验证状态联动   | 邮箱或手机变更时，对应verified状态重置为false | 更新      | 自动重置 |
| CI-R-04  | 供给侧邮箱必填 | 运营方用户email为必填项                       | 创建      | 拒绝操作 |

表 3.3.3.4-2 ContactInfo业务规则表

+   备注：ContactInfo为值对象，无独立业务方法，由聚合根管理其生命周期。

#### 3.3.3.5 UserStatus 值对象

+   UserStatus值对象封装用户状态，采用三表模型定义如下。

##### 属性清单表

 | 属性名         | 数据类型   | 约束                     | 默认值  | 业务含义                     |
 | -------------- | ---------- | ------------------------ | ------- | ---------------------------- |
 | status         | StatusEnum | 必填，枚举               | PENDING | 用户当前状态，决定是否可登录 |
 | disabledReason | String     | DISABLED时必填，长度≤256 | null    | 禁用原因，管理员操作时填写   |
 | disabledAt     | DateTime   | DISABLED时必填           | null    | 禁用时间，用于审计追溯       |

表 3.3.3.5-1 UserStatus属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                                                               | 验证时机 | 违反后果     |
| -------- | ---------------- | -------------------------------------------------------------------------------------- | -------- | ------------ |
| US-R-01  | 状态流转约束     | 允许的流转：PENDING→ACTIVE, ACTIVE→DISABLED/DELETED/CANCELLED, DISABLED→ACTIVE/DELETED | 状态变更 | 拒绝操作     |
| US-R-02  | DISABLED信息完整 | 状态为DISABLED时，disabledReason和disabledAt必填                                       | 禁用     | 自动补填时间 |
| US-R-03  | 已删除不可恢复   | status=DELETED后不可恢复，仅保留数据供审计                                             | -        | -            |
| US-R-04  | 登录状态限制     | 仅status=ACTIVE的用户可登录系统                                                        | 登录     | 拒绝登录     |

表 3.3.3.5-2 UserStatus业务规则表

##### StatusEnum枚举值

| 枚举值    | 说明   | 可登录 | 可操作      | 前置状态         |
| --------- | ------ | ------ | ----------- | ---------------- |
| PENDING   | 待激活 | 否     | 仅激活      | 初始状态         |
| ACTIVE    | 正常   | 是     | 全部        | PENDING/DISABLED |
| DISABLED  | 已禁用 | 否     | 仅启用/删除 | ACTIVE           |
| DELETED   | 已删除 | 否     | 无          | ACTIVE/DISABLED  |
| CANCELLED | 已注销 | 否     | 无          | ACTIVE           |

表 3.3.3.5-3 StatusEnum枚举值

+   备注：
    -   DISABLED状态可通过enable()恢复为ACTIVE，是唯一可逆操作
    -   CANCELLED仅适用于自助注销场景（C端用户、租户开放注册用户）
    -   DELETED和CANCELLED均为终态，不可恢复

#### 3.3.3.6 ~~ActivationToken 值对象~~（已废弃）

+   **废弃说明**：自V0.48起，激活流程从"激活链接（Token）"模式改为"激活验证码"模式。激活验证码由共享服务CaptchaService（第8章）统一管理，不再作为聚合根内的值对象存在。

+   废弃影响与迁移对照如下表所示。

    | 原设计                           | 迁移后                                       |
    | -------------------------------- | -------------------------------------------- |
    | ActivationToken值对象            | 废弃，由CaptchaService统一管理验证码生命周期 |
    | PlatformUser.activationToken属性 | 移除，激活状态仅通过status=PENDING判断       |
    | TenantUser.activationToken属性   | 移除，同上                                   |
    | AT-R-01 令牌唯一性               | 由CaptchaService的验证码生成机制保证         |
    | AT-R-02 有效期24小时             | 改为验证码有效期15分钟（CAP-R-02）           |
    | AT-R-03 一次性使用               | 由CaptchaService.verifyCode()校验后自动失效  |
    | AT-R-04 重新生成覆盖             | 重新发送验证码时，原验证码自动失效           |

    表 3.3.3.6-1 ActivationToken废弃迁移对照表

+   备注：
    -   PlatformUser和TenantUser聚合根的activationToken属性应同步移除，相关DDL中activation_token、activation_expires_at、activation_used字段也应移除
    -   激活流程改为：管理员创建用户（状态=PENDING）→ 系统通过CaptchaService发送验证码到用户邮箱/手机 → 用户输入验证码+密码完成激活
    -   原ActivationToken相关业务规则（AT-R-01~AT-R-04）由CaptchaService的验证码规则（CAP-R-01~CAP-R-03）替代

### 3.3.4 TenantUser 聚合（租户用户）

+   TenantUser聚合管理租户用户群用户，存储在各租户库。

#### 3.3.4.1 聚合结构

+   TenantUser聚合包含以下元素：

    | 元素类型 | 元素名称    | 说明                   |
    | -------- | ----------- | ---------------------- |
    | 聚合根   | TenantUser  | 租户用户实体           |
    | 值对象   | Credential  | 凭证信息（同平台用户） |
    | 值对象   | ContactInfo | 联系方式（同平台用户） |
    | 值对象   | UserStatus  | 用户状态（同平台用户） |
    | 值对象   | UserSource  | 用户来源信息           |

    表 3.3.4.1-1 TenantUser聚合结构

#### 3.3.4.2 TenantUser 实体

+   TenantUser是聚合根，管理租户用户群用户，采用三表模型定义如下。

##### 属性清单表

 | 属性名      | 数据类型    | 约束                         | 默认值  | 业务含义                                      |
 | ----------- | ----------- | ---------------------------- | ------- | --------------------------------------------- |
 | id          | Long        | 必填，主键                   | 自增    | 用户唯一标识，租户库内唯一                    |
 | tenantId    | Long        | 必填，不可变                 | -       | 所属租户ID，冗余存储以支持跨BC协作和事件发布  |
 | username    | String      | 必填，长度3-32，租户库内唯一 | -       | 登录用户名，仅允许字母数字下划线              |
 | realName    | String      | 必填，长度2-64               | -       | 用户真实姓名                                  |
 | userType    | UserType    | 必填，枚举                   | ur_user | 用户类型：ur_admin租户管理员或ur_user普通用户 |
 | credential  | Credential  | 必填                         | -       | 凭证信息值对象                                |
 | contactInfo | ContactInfo | 必填                         | -       | 联系方式值对象                                |
 | status      | UserStatus  | 必填                         | -       | 用户状态值对象，初始状态因创建方式而异        |
 | userSource  | UserSource  | 必填                         | -       | 用户来源值对象，标识用户创建方式              |
 | orgId       | Long        | 可选                         | null    | 所属组织单元ID，关联org_organization表        |
 | positionId  | Long        | 可选                         | null    | 所属岗位ID，关联position表                    |
 | employeeNo  | String      | 可选，长度≤32，租户内唯一    | null    | 员工编号，企业同步时从外部系统带入            |
 | mfaEnabled  | Boolean     | 必填                         | false   | 是否启用多因素认证                            |
 | lastLoginAt | DateTime    | 可选                         | null    | 最后登录时间                                  |
 | createdBy   | Long        | 可选                         | null    | 创建人ID，自助注册和同步创建时为null          |
 | createdAt   | DateTime    | 必填，不可变                 | NOW()   | 创建时间                                      |
 | updatedAt   | DateTime    | 必填                         | NOW()   | 更新时间                                      |

表 3.3.4.2-1 TenantUser属性清单表

##### 业务规则表

| 规则编号 | 规则名称           | 规则简述                                                  | 验证时机  | 违反后果           |
| -------- | ------------------ | --------------------------------------------------------- | --------- | ------------------ |
| TU-R-01  | 用户名唯一性       | username在租户库iam_user表中必须唯一                      | 创建/更新 | 拒绝操作，提示重复 |
| TU-R-02  | 邮箱租户内唯一     | contactInfo.email在租户库内必须唯一                       | 创建/更新 | 拒绝操作，提示重复 |
| TU-R-03  | 员工编号唯一       | employeeNo若填写，在租户内必须唯一                        | 创建/更新 | 拒绝操作，提示重复 |
| TU-R-04  | 开放注册邮箱域校验 | 开放注册时，邮箱域名必须匹配租户配置的允许域名列表        | 注册      | 拒绝注册           |
| TU-R-05  | 密码策略           | 密码需符合租户配置的策略，默认：长度≥8，含大小写+数字     | 激活/改密 | 拒绝操作，提示策略 |
| TU-R-06  | 自助注销前提       | 仅userSource.sourceType=SELF_REGISTERED的用户可自助注销   | 注销      | 拒绝操作           |
| TU-R-07  | 同步用户只读       | userSource.sourceType=SYNCED的用户不可本地修改            | 更新      | 拒绝操作           |
| TU-R-08  | 组织单元有效性     | orgId若填写，必须在org_organization表中存在且状态为ACTIVE | 分配      | 拒绝操作           |
| TU-R-09  | 岗位有效性         | positionId若填写，必须在position表中存在且状态为ACTIVE    | 分配      | 拒绝操作           |
| TU-R-10  | 试用租户用户上限   | 试用租户的用户数不能超过5个（含管理员）                   | 创建      | 拒绝创建           |
| TU-R-11  | 首个管理员不可删   | 租户的首个管理员（租户开通时自动创建）不可删除            | 删除      | 拒绝操作           |

表 3.3.4.2-2 TenantUser业务规则表

##### 业务方法表

| 方法名                 | 方法简述                            | 关联规则         | 异常                             | 事件                |
| ---------------------- | ----------------------------------- | ---------------- | -------------------------------- | ------------------- |
| createByAdmin()        | 管理员创建用户，状态为PENDING待激活 | TU-R-01,02,03,10 | UserAlreadyExistsException       | UserCreated         |
| createByRegistration() | 开放注册创建，状态为ACTIVE直接激活  | TU-R-01,02,04,10 | UserAlreadyExistsException       | UserRegistered      |
| createBySync()         | 企业同步创建，状态取决于源系统      | TU-R-01,02,03    | UserAlreadyExistsException       | UserSynced          |
| activate()             | 验证激活验证码后激活账号并设置密码  | TU-R-05          | InvalidVerificationCodeException | UserActivated       |
| changePassword()       | 用户自助修改密码                    | TU-R-05,07       | PasswordPolicyViolationException | UserPasswordChanged |
| assignToOrg()          | 分配到组织单元                      | TU-R-07,08       | InvalidOrganizationException     | -                   |
| assignToPosition()     | 分配到岗位                          | TU-R-07,09       | InvalidPositionException         | -                   |
| canSelfCancel()        | 判断是否可自助注销，返回布尔值      | TU-R-06          | -                                | -                   |
| cancel()               | 注销账号，状态置为CANCELLED         | TU-R-06,11       | OperationNotAllowedException     | UserCancelled       |
| disable()              | 禁用账号                            | TU-R-07,11       | OperationNotAllowedException     | UserDisabled        |
| delete()               | 逻辑删除                            | TU-R-07,11       | OperationNotAllowedException     | UserDeleted         |

表 3.3.4.2-3 TenantUser业务方法表

+   备注：
    -   TU-R-04邮箱域校验：租户管理员在BC-11中配置允许的邮箱域名列表，如["@company.com", "@corp.company.com"]
    -   TU-R-07同步用户的修改需通过外部源系统进行，本系统在下次同步时自动更新
    -   createByRegistration()方法中直接设置status=ACTIVE，因邮箱验证码已验证用户身份

#### 3.3.4.3 UserSource 值对象

+   UserSource值对象封装用户来源信息，采用三表模型定义如下。

##### 属性清单表

 | 属性名     | 数据类型   | 约束                   | 默认值 | 业务含义                               |
 | ---------- | ---------- | ---------------------- | ------ | -------------------------------------- |
 | sourceType | SourceType | 必填，枚举             | -      | 用户来源类型，决定用户可执行的操作范围 |
 | externalId | String     | SYNCED时必填，长度≤128 | null   | 外部系统用户ID，用于同步时匹配         |
 | syncedAt   | DateTime   | SYNCED时有值           | null   | 最后同步时间，每次同步更新成功后刷新   |

表 3.3.4.3-1 UserSource属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                             | 验证时机  | 违反后果 |
| -------- | ------------ | ---------------------------------------------------- | --------- | -------- |
| SR-R-01  | 来源不可变   | sourceType创建后不可修改                             | 更新      | 拒绝操作 |
| SR-R-02  | 外部ID必填   | sourceType=SYNCED时，externalId必须有值              | 创建      | 拒绝创建 |
| SR-R-03  | 外部ID唯一   | externalId在租户内唯一，不能有两个用户关联同一外部ID | 创建/同步 | 拒绝操作 |
| SR-R-04  | 同步时间更新 | 每次同步成功后，syncedAt更新为当前时间               | 同步      | -        |

表 3.3.4.3-2 UserSource业务规则表

##### SourceType枚举值

| 枚举值          | 说明       | 可自助注销 | 可自助改密 | 可本地修改 | 备注                       |
| --------------- | ---------- | ---------- | ---------- | ---------- | -------------------------- |
| ADMIN_CREATED   | 管理员创建 | 否         | 是         | 是         | 由租户管理员手工创建       |
| SELF_REGISTERED | 开放注册   | 是         | 是         | 是         | 用户通过开放注册自行创建   |
| SYNCED          | 企业同步   | 否         | 否         | 否         | 从HR/AD/SCIM等外部系统同步 |

表 3.3.4.3-3 SourceType枚举值

+   备注：
    -   来源类型决定用户的操作权限边界，是租户用户管理的核心区分维度
    -   SYNCED用户的所有修改需通过源系统进行，本系统仅接收同步数据

### 3.3.5 ConsumerUser 聚合（个人用户）

+   ConsumerUser聚合管理C端个人用户，存储在消费者库。

#### 3.3.5.1 聚合结构

+   ConsumerUser聚合包含以下元素：

    | 元素类型 | 元素名称          | 说明         |
    | -------- | ----------------- | ------------ |
    | 聚合根   | ConsumerUser      | 个人用户实体 |
    | 值对象   | Credential        | 凭证信息     |
    | 值对象   | ContactInfo       | 联系方式     |
    | 值对象   | UserStatus        | 用户状态     |
    | 值对象   | OAuthBinding      | 三方账号绑定 |
    | 值对象   | SubscriptionLevel | 订阅级别     |

    表 3.3.5.1-1 ConsumerUser聚合结构

#### 3.3.5.2 ConsumerUser 实体

+   ConsumerUser是聚合根，管理C端个人用户，采用三表模型定义如下。

##### 属性清单表

 | 属性名              | 数据类型           | 约束                    | 默认值 | 业务含义                               |
 | ------------------- | ------------------ | ----------------------- | ------ | -------------------------------------- |
 | id                  | Long               | 必填，主键              | 自增   | 用户唯一标识，消费者库内唯一           |
 | nickname            | String             | 可选，长度2-32          | null   | 用户昵称，展示用                       |
 | avatar              | String             | 可选，URL格式，长度≤512 | null   | 头像URL，支持上传或三方头像            |
 | credential          | Credential         | 可选                    | null   | 凭证信息，三方登录用户可无本地密码     |
 | contactInfo         | ContactInfo        | 必填                    | -      | 联系方式，手机或邮箱至少填一个         |
 | status              | UserStatus         | 必填                    | ACTIVE | 用户状态值对象                         |
 | oauthBindings       | List<OAuthBinding> | 可选                    | []     | 三方账号绑定列表，可绑定多个不同平台   |
 | subscriptionLevel   | SubscriptionLevel  | 必填                    | FREE   | 订阅级别值对象                         |
 | registrationChannel | String             | 必填，枚举              | -      | 注册渠道：MOBILE/EMAIL/OAUTH           |
 | lastLoginAt         | DateTime           | 可选                    | null   | 最后登录时间                           |
 | cancelRequestedAt   | DateTime           | 可选                    | null   | 申请注销时间，进入冷静期时设置         |
 | cancelCoolingEndAt  | DateTime           | 可选                    | null   | 注销冷静期结束时间，申请时间+7天       |
 | cancelledAt         | DateTime           | 可选                    | null   | 实际注销时间，冷静期结束后系统自动设置 |
 | createdAt           | DateTime           | 必填，不可变            | NOW()  | 创建时间                               |
 | updatedAt           | DateTime           | 必填                    | NOW()  | 更新时间                               |

表 3.3.5.2-1 ConsumerUser属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                                     | 验证时机  | 违反后果           |
| -------- | ---------------- | ------------------------------------------------------------ | --------- | ------------------ |
| CU-R-01  | 手机号唯一       | contactInfo.mobile在消费者库内必须唯一                       | 创建/更新 | 拒绝操作，提示重复 |
| CU-R-02  | 邮箱唯一         | contactInfo.email在消费者库内必须唯一                        | 创建/更新 | 拒绝操作，提示重复 |
| CU-R-03  | 联系方式至少一项 | mobile和email至少填写一项                                    | 创建/更新 | 拒绝操作           |
| CU-R-04  | 密码策略         | 密码需符合：长度≥6，含字母+数字                              | 设密/改密 | 拒绝操作，提示策略 |
| CU-R-05  | 三方账号唯一绑定 | 同一三方平台的unionId/openId只能绑定一个本地用户             | 绑定      | 拒绝绑定           |
| CU-R-06  | 最少一种登录方式 | 解绑三方账号时，需确保至少保留一种登录方式（密码或其他三方） | 解绑      | 拒绝解绑           |
| CU-R-07  | 冷静期7天        | 申请注销后进入7天冷静期，期间可撤销                          | 注销      | -                  |
| CU-R-08  | 冷静期内可撤销   | cancelCoolingEndAt之前可调用revokeCancel()撤销注销申请       | 撤销      | -                  |
| CU-R-09  | 冷静期后自动注销 | 冷静期结束后，定时任务自动执行confirmCancel()完成注销        | 定时      | -                  |
| CU-R-10  | 订阅降级限制     | 订阅级别只能升级，不能主动降级（到期自动降为FREE）           | 升级      | 拒绝操作           |

表 3.3.5.2-2 ConsumerUser业务规则表

##### 业务方法表

| 方法名                | 方法简述                     | 关联规则      | 异常                             | 事件                 |
| --------------------- | ---------------------------- | ------------- | -------------------------------- | -------------------- |
| createByMobile()      | 手机号+验证码注册，直接激活  | CU-R-01,03,04 | UserAlreadyExistsException       | ConsumerRegistered   |
| createByEmail()       | 邮箱+验证码注册，直接激活    | CU-R-02,03,04 | UserAlreadyExistsException       | ConsumerRegistered   |
| createByOAuth()       | 三方账号注册，自动创建并绑定 | CU-R-05       | OAuthAlreadyBoundException       | ConsumerRegistered   |
| bindOAuth()           | 绑定三方账号到已有用户       | CU-R-05       | OAuthAlreadyBoundException       | OAuthBound           |
| unbindOAuth()         | 解绑三方账号                 | CU-R-06       | LastLoginMethodException         | OAuthUnbound         |
| setPassword()         | 三方用户补设本地密码         | CU-R-04       | PasswordPolicyViolationException | PasswordSet          |
| changePassword()      | 修改密码，需验证旧密码       | CU-R-04       | PasswordPolicyViolationException | UserPasswordChanged  |
| requestCancel()       | 申请注销，进入7天冷静期      | CU-R-07       | -                                | CancelRequested      |
| revokeCancel()        | 撤销注销申请，取消冷静期     | CU-R-08       | CoolingPeriodExpiredException    | CancelRevoked        |
| confirmCancel()       | 确认注销，冷静期后执行       | CU-R-09       | -                                | UserCancelled        |
| upgradeSubscription() | 升级订阅级别                 | CU-R-10       | InvalidSubscriptionException     | SubscriptionUpgraded |

表 3.3.5.2-3 ConsumerUser业务方法表

+   备注：
    -   三方登录用户首次登录时自动调用createByOAuth()创建本地账号，无需单独注册
    -   冷静期机制符合《个人信息保护法》要求，给予用户充分的考虑时间
    -   定时任务每日执行一次，处理所有冷静期已过的注销申请

#### 3.3.5.3 OAuthBinding 值对象

+   OAuthBinding值对象封装三方账号绑定，采用三表模型定义如下。

##### 属性清单表

 | 属性名   | 数据类型      | 约束                    | 默认值 | 业务含义                         |
 | -------- | ------------- | ----------------------- | ------ | -------------------------------- |
 | provider | OAuthProvider | 必填，枚举              | -      | 三方平台类型：QQ/WECHAT/DINGTALK |
 | openId   | String        | 必填，长度≤128          | -      | 三方平台openId，应用维度唯一标识 |
 | unionId  | String        | 可选，长度≤128          | null   | 三方平台unionId，跨应用唯一标识  |
 | nickname | String        | 可选，长度≤64           | null   | 三方平台昵称，授权时获取         |
 | avatar   | String        | 可选，URL格式，长度≤512 | null   | 三方平台头像URL，授权时获取      |
 | boundAt  | DateTime      | 必填                    | NOW()  | 绑定时间                         |

表 3.3.5.3-1 OAuthBinding属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                               | 验证时机 | 违反后果                   |
| -------- | ---------------- | ------------------------------------------------------ | -------- | -------------------------- |
| OB-R-01  | 平台+openId唯一  | 同一provider的openId在系统内只能绑定一个用户           | 绑定     | OAuthAlreadyBoundException |
| OB-R-02  | 平台+unionId唯一 | 同一provider的unionId在系统内只能绑定一个用户          | 绑定     | OAuthAlreadyBoundException |
| OB-R-03  | 优先unionId匹配  | 查找绑定时，优先使用unionId匹配，无unionId时使用openId | 登录     | -                          |
| OB-R-04  | 单用户多平台     | 一个用户可绑定多个不同平台的三方账号                   | 绑定     | -                          |
| OB-R-05  | 单平台单账号     | 一个用户在同一平台只能绑定一个账号                     | 绑定     | 提示已绑定                 |

表 3.3.5.3-2 OAuthBinding业务规则表

+   备注：
    -   unionId比openId更稳定，建议在可获取unionId的场景下优先使用
    -   OAuthBinding为值对象，无独立业务方法，通过聚合根的bindOAuth/unbindOAuth管理

#### 3.3.5.4 SubscriptionLevel 值对象

+   SubscriptionLevel值对象封装订阅级别，采用三表模型定义如下。

##### 属性清单表

 | 属性名        | 数据类型  | 约束       | 默认值 | 业务含义                       |
 | ------------- | --------- | ---------- | ------ | ------------------------------ |
 | level         | LevelEnum | 必填，枚举 | FREE   | 订阅级别，决定可使用的功能范围 |
 | effectiveFrom | DateTime  | 必填       | NOW()  | 生效开始时间                   |
 | effectiveTo   | DateTime  | 可选       | null   | 生效结束时间，null表示永久有效 |

表 3.3.5.4-1 SubscriptionLevel属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                              | 验证时机 | 违反后果 |
| -------- | -------------- | ----------------------------------------------------- | -------- | -------- |
| SL-R-01  | 只升不降       | 订阅级别只能升级，不能主动降级                        | 升级     | 拒绝操作 |
| SL-R-02  | 到期自动降级   | effectiveTo过期后，定时任务自动将level降为FREE        | 定时     | -        |
| SL-R-03  | 生效时间逻辑   | effectiveFrom必须小于effectiveTo（若effectiveTo有值） | 升级     | 拒绝操作 |
| SL-R-04  | 续费延长有效期 | 续费时延长effectiveTo，不新建记录                     | 续费     | -        |

表 3.3.5.4-2 SubscriptionLevel业务规则表

##### LevelEnum枚举值

| 枚举值     | 说明     | 功能范围  | 价格     | 备注               |
| ---------- | -------- | --------- | -------- | ------------------ |
| GUEST      | 游客     | 浏览      | 免费     | 未注册用户默认状态 |
| FREE       | 免费用户 | 基础功能  | 免费     | 注册用户默认状态   |
| BASIC      | 基础订阅 | 标准功能  | ¥9.9/月  | 按月付费           |
| PREMIUM    | 高级订阅 | 全部功能  | ¥29.9/月 | 按月付费           |
| ENTERPRISE | 企业订阅 | 全部+专属 | 定制     | 企业级大客户       |

表 3.3.5.4-3 LevelEnum枚举值

+   备注：
    -   SubscriptionLevel为值对象，无独立业务方法，通过聚合根的upgradeSubscription管理
    -   订阅到期降级由定时任务每日凌晨执行，提前3天发送到期提醒

### 3.3.6 领域服务

+   用户管理子领域包含以下领域服务：

    | 服务名称                | 职责     | 说明                         |
    | ----------------------- | -------- | ---------------------------- |
    | UserCreationService     | 用户创建 | 处理各种创建场景的业务逻辑   |
    | UserActivationService   | 用户激活 | 处理激活验证码校验和账号激活 |
    | UserQueryService        | 用户查询 | 跨聚合的用户查询             |
    | UserCancellationService | 用户注销 | 处理注销流程和冷静期         |

    注：密码相关操作通过共享服务 PasswordService（第8章）实现，用户管理子领域调用但不拥有该服务。密码重置和激活流程中的验证码发送与校验通过共享服务 CaptchaService（第8章）实现。

    表 3.3.6-1 领域服务清单

#### 3.3.6.1 UserCreationService

+   UserCreationService负责处理用户创建的复杂业务逻辑：

    | 方法名                     | 参数      | 返回值 | 说明                 |
    | -------------------------- | --------- | ------ | -------------------- |
    | createPlatformUser()       | command   | Long   | 创建平台用户         |
    | createTenantUserByAdmin()  | command   | Long   | 管理员创建租户用户   |
    | registerTenantUser()       | command   | Long   | 租户用户开放注册     |
    | syncTenantUser()           | syncData  | Long   | 同步租户用户         |
    | registerConsumerByMobile() | command   | Long   | 手机号注册个人用户   |
    | registerConsumerByEmail()  | command   | Long   | 邮箱注册个人用户     |
    | registerConsumerByOAuth()  | oauthInfo | Long   | 三方账号注册个人用户 |

    表 3.3.6.1-1 UserCreationService方法

#### 3.3.6.2 PasswordService

+   PasswordService负责密码相关的业务逻辑：

    | 方法名                 | 参数                | 返回值    | 说明                     |
    | ---------------------- | ------------------- | --------- | ------------------------ |
    | hashPassword()         | plainPassword       | hash+salt | 密码加密                 |
    | verifyPassword()       | plainPassword, hash | boolean   | 验证密码                 |
    | checkPasswordPolicy()  | password, policy    | result    | 检查密码策略             |
    | checkPasswordHistory() | userId, newPassword | boolean   | 检查密码历史（不可重复） |

    表 3.3.6.2-1 PasswordService方法

+   备注：密码重置流程中的身份验证改为通过CaptchaService发送验证码并校验，不再使用重置令牌（resetToken）。原generateResetToken()和validateResetToken()方法已废弃。

#### 3.3.6.3 UserActivationService

+   UserActivationService负责处理用户激活验证码的校验和账号激活：

    | 方法名             | 参数                      | 返回值 | 说明                                       |
    | ------------------ | ------------------------- | ------ | ------------------------------------------ |
    | activateByCode()   | target, code, newPassword | void   | 校验激活验证码并激活账号，同时设置初始密码 |
    | resendActivation() | userId                    | void   | 重新发送激活验证码到用户邮箱/手机          |

    表 3.3.6.3-1 UserActivationService方法

+   业务逻辑说明：
    -   activateByCode()内部调用CaptchaService.verifyCode()校验激活验证码，调用PasswordService.hashPassword()加密初始密码，调用PasswordService.checkPasswordPolicy()校验密码强度
    -   激活成功后发布UserActivated事件，通知审计模块和通知服务
    -   验证码无效或已过期时抛出InvalidVerificationCodeException
    -   resendActivation()内部调用CaptchaService.sendSmsCode()或CaptchaService.sendEmailCode()，根据用户注册时填写的联系方式自动选择发送渠道；若用户未提供手机号或邮箱，返回提示"该手机号/邮箱未注册"

#### 3.3.6.4 UserQueryService

+   UserQueryService负责跨聚合的用户查询，为各用户群提供统一查询能力：

    | 方法名                                      | 参数            | 返回值         | 说明                                                                             |
    | ------------------------------------------- | --------------- | -------------- | -------------------------------------------------------------------------------- |
    | PlatformUserQueryService.getList()          | query, pageable | Page<UserDTO>  | 分页查询平台用户列表，支持多条件筛选                                             |
    | PlatformUserQueryService.getDetail()        | userId          | UserDetailDTO  | 查询平台用户详情，包含角色信息                                                   |
    | TenantUserQueryService.getList()            | query, pageable | Page<UserDTO>  | 分页查询租户用户列表，支持多条件筛选                                             |
    | TenantUserQueryService.getDetail()          | userId          | UserDetailDTO  | 查询租户用户详情，包含组织、岗位、角色信息                                       |
    | TenantUserQueryService.getMe()              | currentUserId   | UserDetailDTO  | 查询当前登录的租户用户自身信息                                                   |
    | ConsumerUserQueryService.getMe()            | currentUserId   | ConsumerDTO    | 查询当前登录的C端用户自身信息                                                    |
    | ConsumerUserQueryService.getOAuthBindings() | currentUserId   | List<OAuthDTO> | 查询当前C端用户的三方账号绑定列表                                                |
    | getUserMfaStatus()                          | userId          | MfaStatusDTO   | 查询用户MFA启用状态，供认证域登录流程调用                                        |
    | getUserBasicInfoForToken()                  | userId          | TokenUserInfo  | 获取签发Token所需的用户基本信息（userId、userPool、tenantId、tenantCode、roles） |

    表 3.3.6.4-1 UserQueryService方法

+   设计说明：
    -   各用户群的查询服务按命名前缀区分：PlatformUserQueryService、TenantUserQueryService、ConsumerUserQueryService
    -   getUserMfaStatus()和getUserBasicInfoForToken()为认证域提供的跨子领域查询方法，定义在用户管理域，由认证域调用
    -   查询服务不修改数据，走只读事务，可对接CQRS读模型

#### 3.3.6.5 UserCancellationService

+   UserCancellationService负责处理用户注销流程和冷静期管理：

    | 方法名                  | 参数   | 返回值  | 说明                                   |
    | ----------------------- | ------ | ------- | -------------------------------------- |
    | requestCancel()         | userId | void    | 发起注销申请，记录冷静期开始和结束时间 |
    | revokeCancel()          | userId | void    | 撤销注销申请，清除冷静期信息           |
    | processCoolingExpired() | -      | int     | 定时任务：批量处理冷静期已过的注销申请 |
    | confirmCancel()         | userId | void    | 确认注销，执行账号数据清理和状态变更   |
    | canUserCancel()         | userId | boolean | 判断用户是否具备自助注销资格           |

    表 3.3.6.5-1 UserCancellationService方法

+   业务逻辑说明：
    -   requestCancel()设置cancelRequestedAt和cancelCoolingEndAt（当前时间+7天），发布UserCancelRequested事件
    -   processCoolingExpired()由定时任务每日凌晨执行一次，查询所有cancelCoolingEndAt < 当前时间且status=ACTIVE的用户，逐个调用confirmCancel()
    -   confirmCancel()将用户状态置为CANCELLED，清理三方绑定（UC用户），发布UserCancelled事件
    -   canUserCancel()检查用户来源类型：仅SELF_REGISTERED的UR用户和全部UC用户可自助注销

### 3.3.7 领域事件

+   用户管理子领域发布以下领域事件：

    | 事件名称             | 触发时机           | 消费者                       | 说明                                                         |
    | -------------------- | ------------------ | ---------------------------- | ------------------------------------------------------------ |
    | UserCreated          | 用户创建成功       | 审计模块、BC-12、组织管理    | 记录操作日志、发送激活验证码；企业同步时通知组织管理创建人员 |
    | UserRegistered       | 开放注册成功       | 审计模块、BC-12、组织管理    | 记录操作日志；若租户配置了默认部门/岗位则触发默认任职创建    |
    | UserSynced           | 企业同步创建成功   | 审计模块                     | 记录操作日志                                                 |
    | ConsumerRegistered   | C端用户注册成功    | 审计模块                     | 记录操作日志                                                 |
    | UserActivated        | 用户激活成功       | 审计模块、BC-12              | 记录操作日志、发送欢迎通知                                   |
    | TenantAdminActivated | 租户管理员激活成功 | 审计模块、BC-12              | 记录操作日志、发送租户开通欢迎通知                           |
    | UserPasswordChanged  | 密码修改成功       | 审计模块                     | 记录安全审计                                                 |
    | UserPasswordReset    | 密码重置成功       | 审计模块                     | 记录安全审计                                                 |
    | UserEnabled          | 用户被启用         | 审计模块                     | 记录操作日志                                                 |
    | UserDisabled         | 用户被禁用         | 审计模块、认证模块、组织管理 | 记录安全审计、强制下线；可选通知组织域更新人员在职状态       |
    | UserDeleted          | 用户被删除         | 审计模块、认证模块           | 记录安全审计、强制下线、清理Token                            |
    | UserCancelRequested  | 用户申请注销       | 审计模块                     | 记录操作日志（注销申请）                                     |
    | CancelRevoked        | 撤销注销申请       | 审计模块                     | 记录操作日志（注销撤销）                                     |
    | UserCancelled        | 用户注销完成       | 审计模块、认证模块           | 记录安全审计（账号注销）、清理Token                          |
    | OAuthBound           | 绑定三方账号       | 审计模块                     | 记录操作日志                                                 |
    | OAuthUnbound         | 解绑三方账号       | 审计模块                     | 记录操作日志                                                 |
    | MfaEnabled           | 启用MFA            | 审计模块                     | 记录安全审计                                                 |
    | MfaDisabled          | 禁用MFA            | 审计模块                     | 记录安全审计                                                 |
    | SubscriptionUpgraded | 订阅升级           | 审计模块                     | 记录操作日志                                                 |
    | PasswordSet          | 三方用户补设密码   | 审计模块                     | 记录安全审计                                                 |

    表 3.3.7-1 领域事件清单

#### 3.3.7.1 事件结构示例

+   UserActivated事件结构：

    | 字段名     | 数据类型 | 说明               |
    | ---------- | -------- | ------------------ |
    | eventId    | String   | 事件唯一标识       |
    | eventTime  | DateTime | 事件发生时间       |
    | userId     | Long     | 用户ID             |
    | userPool   | String   | 用户群：UP/UR/UC   |
    | username   | String   | 用户名             |
    | email      | String   | 邮箱               |
    | tenantId   | Long     | 租户ID（ur用户）   |
    | tenantCode | String   | 租户编码（ur用户） |

    表 3.3.7.1-1 UserActivated事件结构

### 3.3.8 协作关系

+   本节梳理用户管理子领域与其他子领域及共享服务之间的协作关系，包括领域内协作、跨领域协作和共享服务协作三个层面。

#### 3.3.8.1 领域内协作

+   用户管理子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方                  | 被调用方                                 | 协作方式 | 触发场景           | 说明                                              |
    | --------- | ----------------------- | ---------------------------------------- | -------- | ------------------ | ------------------------------------------------- |
    | INTRA-001 | UserCreationService     | PlatformUser（聚合根）                   | 方法调用 | 创建平台用户       | 调用PlatformUser.create(cmd)                      |
    | INTRA-002 | UserCreationService     | TenantUser（聚合根）                     | 方法调用 | 创建租户用户       | 调用TenantUser.createByAdmin(cmd)等               |
    | INTRA-003 | UserCreationService     | ConsumerUser（聚合根）                   | 方法调用 | 创建C端用户        | 调用ConsumerUser.createByMobile(cmd)等            |
    | INTRA-004 | UserActivationService   | PlatformUser / TenantUser                | 方法调用 | 激活用户账号       | 调用聚合根的activate()方法，更新状态为ACTIVE      |
    | INTRA-005 | UserActivationService   | PasswordService                          | 方法调用 | 激活时设置初始密码 | 调用hashPassword()和checkPasswordPolicy()         |
    | INTRA-006 | UserCancellationService | ConsumerUser / TenantUser                | 方法调用 | 注销申请/撤销/确认 | 调用聚合根的requestCancel()、revokeCancel()等方法 |
    | INTRA-007 | UserQueryService        | PlatformUser / TenantUser / ConsumerUser | 仓储查询 | 跨聚合用户查询     | 通过各聚合仓储读取数据，走只读事务                |

    表 3.3.8.1-1 领域内协作关系

#### 3.3.8.2 跨领域协作

+   用户管理子领域与其他子领域的跨领域协作通过事件驱动和RPC调用两种方式实现。

##### 与组织管理子领域（第4章）的协作

+   用户管理与组织管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                               |
    | --------- | ------------------- | -------- | ------------------------------------------- | ------------------------------------------------------------------ |
    | CROSS-001 | 用户管理 → 组织管理 | 领域事件 | UserCreated                                 | 企业同步（createBySync）创建用户后，通知组织管理子领域创建对应人员 |
    | CROSS-002 | 用户管理 → 组织管理 | 领域事件 | UserRegistered                              | 租户用户开放注册后，若租户配置了默认部门/岗位则触发默认任职创建    |
    | CROSS-003 | 用户管理 → 组织管理 | 领域事件 | UserDisabled                                | 用户被禁用后，可选通知组织管理域更新人员在职状态                   |
    | CROSS-004 | 用户管理 → 组织管理 | 领域事件 | UserDeleted                                 | 用户被删除后，通知组织管理域处理关联人员数据                       |
    | CROSS-005 | 组织管理 → 用户管理 | RPC调用  | UserQueryService.getUserBasicInfoForToken() | 组织管理需要获取用户基本信息用于人员关联展示                       |
    | CROSS-006 | 组织管理 → 用户管理 | 领域事件 | PersonCreated                               | 企业同步创建人员后，用户管理域更新关联用户的组织归属信息           |
    | CROSS-007 | 组织管理 → 用户管理 | 领域事件 | PersonUserBound                             | 人员关联用户后，用户管理域更新用户的组织归属信息                   |
    | CROSS-008 | 组织管理 → 用户管理 | 领域事件 | PersonUserUnbound                           | 人员解除用户关联后，用户管理域清除用户的组织归属信息               |

    表 3.3.8.2-1 与组织管理子领域的协作

##### 与认证管理子领域（第5章）的协作

+   用户管理与认证管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                                         |
    | --------- | ------------------- | -------- | ------------------------------------------- | ---------------------------------------------------------------------------- |
    | CROSS-011 | 认证管理 → 用户管理 | RPC调用  | UserQueryService.getUserMfaStatus()         | 登录流程中判断是否需要双因素验证                                             |
    | CROSS-012 | 认证管理 → 用户管理 | RPC调用  | UserQueryService.getUserBasicInfoForToken() | 签发Token时获取用户基本信息（userId、userPool、tenantId、tenantCode、roles） |
    | CROSS-013 | 用户管理 → 认证管理 | 领域事件 | UserDisabled                                | 用户禁用后，认证子领域强制终止该用户所有会话并撤销Token                      |
    | CROSS-014 | 用户管理 → 认证管理 | 领域事件 | UserDeleted                                 | 用户删除后，认证子领域强制终止该用户所有会话并撤销Token                      |
    | CROSS-015 | 用户管理 → 认证管理 | 领域事件 | UserCancelled                               | 用户注销完成后，认证子领域清理该用户所有Token和会话                          |
    | CROSS-016 | 用户管理 → 认证管理 | 领域事件 | UserPasswordChanged / UserPasswordReset     | 密码变更后，认证子领域可选撤销该用户现有Token（根据安全策略配置）            |

    表 3.3.8.2-2 与认证管理子领域的协作

##### 与授权管理子领域（第6章）的协作

+   用户管理与授权管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口            | 说明                                                           |
    | --------- | ------------------- | -------- | ------------------------ | -------------------------------------------------------------- |
    | CROSS-021 | 用户管理 → 授权管理 | 领域事件 | UserCreated              | 用户创建后，授权子领域为其分配默认角色（根据用户群和租户配置） |
    | CROSS-022 | 用户管理 → 授权管理 | 领域事件 | UserDeleted              | 用户删除后，授权子领域清理该用户的所有角色分配                 |
    | CROSS-023 | 授权管理 → 用户管理 | RPC调用  | UserQueryService（查询） | 授权管理在角色分配时需查询用户信息以校验用户存在性             |

    表 3.3.8.2-3 与授权管理子领域的协作

##### 与审计管理子领域（第7章）的协作

+   用户管理与审计管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口              | 说明                                                  |
    | --------- | ------------------- | -------- | -------------------------- | ----------------------------------------------------- |
    | CROSS-031 | 用户管理 → 审计管理 | 领域事件 | 所有用户管理领域事件       | 审计子领域订阅表3.3.7-1中的全部事件，记录操作审计日志 |
    | CROSS-032 | 用户管理 → 审计管理 | 领域事件 | UserDisabled / UserDeleted | 审计子领域额外记录安全审计日志                        |

    表 3.3.8.2-4 与审计管理子领域的协作

##### 与配置管理子领域（第9章）的协作

+   用户管理与配置管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                | 说明                                                                 |
    | --------- | ------------------- | -------- | ---------------------------- | -------------------------------------------------------------------- |
    | CROSS-041 | 用户管理 → 配置管理 | RPC调用  | ConfigService.getEffective() | 获取三级合并后的配置生效值，如密码最小长度、激活令牌有效期等         |
    | CROSS-042 | 用户管理 → 配置管理 | RPC调用  | ConfigService.batchGet()     | 批量获取多个配置键的生效值，如用户创建流程中一次性获取所有密码策略   |
    | CROSS-043 | 配置管理 → 用户管理 | 领域事件 | TenantConfigChanged          | 租户配置变更后，用户管理域刷新缓存的配置值（如密码策略变更即时生效） |

    表 3.3.8.2-5 与配置管理子领域的协作

##### 与通知上下文（BC-12）的协作

+   用户管理与通知上下文之间的协作关系如下表所示。

    | 协作编号  | 方向             | 协作方式 | 触发事件/接口        | 说明                           |
    | --------- | ---------------- | -------- | -------------------- | ------------------------------ |
    | CROSS-051 | 用户管理 → BC-12 | 领域事件 | UserCreated          | 通知上下文发送激活验证码       |
    | CROSS-052 | 用户管理 → BC-12 | 领域事件 | UserActivated        | 通知上下文发送欢迎通知         |
    | CROSS-053 | 用户管理 → BC-12 | 领域事件 | TenantAdminActivated | 通知上下文发送租户开通欢迎通知 |

    表 3.3.8.2-6 与通知上下文（BC-12）的协作

#### 3.3.8.3 共享服务协作

+   用户管理子领域使用的共享服务（第8章）协作关系如下表所示。

    | 协作编号  | 共享服务        | 调用方法               | 调用场景                                   | 参考章节 |
    | --------- | --------------- | ---------------------- | ------------------------------------------ | -------- |
    | SHARE-001 | PasswordService | hashPassword()         | 创建用户时加密初始密码                     | 8.3.2    |
    | SHARE-002 | PasswordService | checkPasswordPolicy()  | 创建/改密/激活时校验密码强度               | 8.3.2    |
    | SHARE-003 | PasswordService | checkPasswordHistory() | 改密时检查是否与历史密码重复               | 8.3.2    |
    | SHARE-004 | CaptchaService  | sendSmsCode()          | 手机号注册、激活、密码重置时发送短信验证码 | 8.4.2    |
    | SHARE-005 | CaptchaService  | sendEmailCode()        | 邮箱注册、激活、密码重置时发送邮件验证码   | 8.4.2    |
    | SHARE-006 | CaptchaService  | verifyCode()           | 注册/激活/密码重置时校验验证码             | 8.4.2    |
    | SHARE-007 | MfaService      | isUserMfaEnabled()     | 查询用户MFA启用状态，供认证域间接获取      | 8.5.2    |

    表 3.3.8.3-1 共享服务协作关系

+   共享服务协作说明：
    -   PasswordService与CaptchaService的方法签名与第8章定义保持一致，详细参数和约束见表8.3.2-1和表8.4.2-1
    -   密码重置流程中的身份验证改为通过CaptchaService发送验证码并校验，不再使用PasswordService的重置令牌机制
    -   激活流程同样通过CaptchaService发送验证码并校验，不再使用ActivationToken值对象
    -   MfaService的isUserMfaEnabled()通过UserQueryService.getUserMfaStatus()间接暴露给认证子领域，用户管理域内部也直接调用该方法
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口（表9.3.1.3-1）作为基础设施供所有子领域使用，已在3.3.8.2中作为跨领域协作列出

## 3.4 接口设计

+   本节设计用户管理子领域的API接口，按用户群分组。
+   接口设计遵循RESTful规范，路径按用户群区分以实现数据源路由。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 3.4.1 接口总览

+   用户管理子领域对外提供REST API、RPC和消息三类接口。

#### 3.4.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明           |
    | -------- | ---- | -------------- |
    | REST API | 39个 | 前端调用       |
    | RPC接口  | 2个  | 微服务内部调用 |
    | 消息接口 | 20个 | 事件发布       |

    表 3.4.1.1-1 接口分类统计

+   说明：
    -   REST API按用户群分为运营方用户接口（9个）、租户用户接口（13个）、个人用户接口（8个）、公共接口（9个）
    -   RPC接口供认证管理子领域（第5章）通过Feign调用
    -   消息接口通过领域事件发布，事件定义详见表 3.3.7-1

+   用户管理 REST API 清单如下表所示。

    | API编号   | API名称            | 方法   | 路径                                          | 权限                     | 领域方法                                                     | 备注               |
    | --------- | ------------------ | ------ | --------------------------------------------- | ------------------------ | ------------------------------------------------------------ | ------------------ |
    | P-USR-01  | 创建用户           | POST   | /api/v1/up/iam/users                          | provider:iam:user:create | PlatformUser.create()                                        | -                  |
    | P-USR-02  | 查询用户列表       | GET    | /api/v1/up/iam/users                          | provider:iam:user:list   | PlatformUserQueryService.getList()                           | 支持分页           |
    | P-USR-03  | 查询用户详情       | GET    | /api/v1/up/iam/users/{id}                     | provider:iam:user:read   | PlatformUserQueryService.getDetail()                         | -                  |
    | P-USR-04  | 更新用户信息       | PUT    | /api/v1/up/iam/users/{id}                     | provider:iam:user:update | PlatformUser.updateContactInfo()                             | -                  |
    | P-USR-05  | 删除用户           | DELETE | /api/v1/up/iam/users/{id}                     | provider:iam:user:delete | PlatformUser.delete()                                        | 逻辑删除           |
    | P-USR-06  | 禁用用户           | POST   | /api/v1/up/iam/users/{id}/disable             | provider:iam:user:update | PlatformUser.disable()                                       | 需填写原因         |
    | P-USR-07  | 启用用户           | POST   | /api/v1/up/iam/users/{id}/enable              | provider:iam:user:update | PlatformUser.enable()                                        | -                  |
    | P-USR-08  | 管理员协助重置密码 | POST   | /api/v1/up/iam/users/{id}/reset-password      | provider:iam:user:update | PlatformUser.resetPassword()                                 | 发送重置验证码     |
    | P-USR-09  | 重发激活验证码     | POST   | /api/v1/up/iam/users/{id}/resend-activation   | provider:iam:user:update | UserActivationService.resendActivation()                     | -                  |
    | UR-USR-01 | 创建用户           | POST   | /api/v1/ur/iam/users                          | ur:iam:user:create       | TenantUser.createByAdmin()                                   | -                  |
    | UR-USR-02 | 查询用户列表       | GET    | /api/v1/ur/iam/users                          | ur:iam:user:list         | TenantUserQueryService.getList()                             | 支持分页           |
    | UR-USR-03 | 查询用户详情       | GET    | /api/v1/ur/iam/users/{id}                     | ur:iam:user:read         | TenantUserQueryService.getDetail()                           | -                  |
    | UR-USR-04 | 更新用户信息       | PUT    | /api/v1/ur/iam/users/{id}                     | ur:iam:user:update       | TenantUser.updateContactInfo()                               | 同步用户受限       |
    | UR-USR-05 | 删除用户           | DELETE | /api/v1/ur/iam/users/{id}                     | ur:iam:user:delete       | TenantUser.delete()                                          | 逻辑删除           |
    | UR-USR-06 | 禁用用户           | POST   | /api/v1/ur/iam/users/{id}/disable             | ur:iam:user:update       | TenantUser.disable()                                         | 需填写原因         |
    | UR-USR-07 | 启用用户           | POST   | /api/v1/ur/iam/users/{id}/enable              | ur:iam:user:update       | TenantUser.enable()                                          | -                  |
    | UR-USR-08 | 管理员协助重置密码 | POST   | /api/v1/ur/iam/users/{id}/reset-password      | ur:iam:user:update       | TenantUser.resetPassword()                                   | 发送重置验证码     |
    | UR-USR-09 | 重发激活验证码     | POST   | /api/v1/ur/iam/users/{id}/resend-activation   | ur:iam:user:update       | UserActivationService.resendActivation()                     | -                  |
    | UR-USR-10 | 分配组织岗位       | POST   | /api/v1/ur/iam/users/{id}/assign-org          | ur:iam:user:update       | TenantUser.assignToOrg()                                     | 含岗位分配         |
    | UR-USR-11 | 获取当前用户信息   | GET    | /api/v1/ur/iam/users/me                       | authenticated            | TenantUserQueryService.getMe()                               | -                  |
    | UR-USR-12 | 更新当前用户信息   | PUT    | /api/v1/ur/iam/users/me                       | authenticated            | TenantUser.updateProfile()                                   | 同步用户受限       |
    | UR-USR-13 | 用户自助注销       | POST   | /api/v1/ur/iam/users/me/cancel                | authenticated            | TenantUser.cancel()                                          | 仅自注册用户       |
    | UC-USR-01 | 获取当前用户信息   | GET    | /api/v1/uc/iam/users/me                       | authenticated            | ConsumerUserQueryService.getMe()                             | -                  |
    | UC-USR-02 | 更新当前用户信息   | PUT    | /api/v1/uc/iam/users/me                       | authenticated            | ConsumerUser.updateProfile()                                 | -                  |
    | UC-USR-03 | 申请注销           | POST   | /api/v1/uc/iam/users/me/cancel                | authenticated            | ConsumerUser.requestCancel()                                 | 7天冷静期          |
    | UC-USR-04 | 撤销注销           | POST   | /api/v1/uc/iam/users/me/cancel/revoke         | authenticated            | ConsumerUser.revokeCancel()                                  | 冷静期内可撤       |
    | UC-USR-05 | 获取三方绑定列表   | GET    | /api/v1/uc/iam/users/me/oauth                 | authenticated            | ConsumerUserQueryService.getOAuthBindings()                  | -                  |
    | UC-USR-06 | 绑定三方账号       | POST   | /api/v1/uc/iam/users/me/oauth/{provider}/bind | authenticated            | ConsumerUser.bindOAuth()                                     | -                  |
    | UC-USR-07 | 解绑三方账号       | DELETE | /api/v1/uc/iam/users/me/oauth/{provider}      | authenticated            | ConsumerUser.unbindOAuth()                                   | 需保留一种登录方式 |
    | UC-USR-08 | 设置/修改密码      | POST   | /api/v1/uc/iam/users/me/password              | authenticated            | ConsumerUser.setPassword() / changePassword()                | 首设/修改          |
    | PUB-01    | 个人用户注册       | POST   | /api/v1/public/iam/register/consumer          | 无                       | ConsumerUser.createByMobile/Email()                          | 注册即登录         |
    | PUB-02    | 租户用户开放注册   | POST   | /api/v1/public/iam/register/tenant            | 无                       | TenantUser.createByRegistration()                            | 邮箱域匹配租户     |
    | PUB-03    | 激活账号           | POST   | /api/v1/public/iam/activate                   | 无                       | UserActivationService.activateByCode()                       | 验证码+密码        |
    | PUB-04    | 忘记密码           | POST   | /api/v1/public/iam/password/forgot            | 无                       | CaptchaService.send()                                        | 发送重置验证码     |
    | PUB-05    | 重置密码           | POST   | /api/v1/public/iam/password/reset             | 无                       | User.resetPasswordByCode()                                   | 验证码一次性       |
    | PUB-06    | 发送验证码         | POST   | /api/v1/public/iam/captcha/send               | 无                       | CaptchaService.send()                                        | 60秒间隔限制       |
    | PUB-07    | 申请企业试用       | POST   | /api/v1/public/iam/trial/apply                | 无                       | TrialApplicationService.apply()                              | 可配自动审核       |
    | PUB-08    | 获取OAuth授权URL   | GET    | /api/v1/public/iam/oauth/{provider}/url       | 无                       | OAuthService.generateAuthUrl()                               | state防CSRF        |
    | PUB-09    | 三方授权回调       | POST   | /api/v1/public/iam/oauth/{provider}/callback  | 无                       | OAuthService.handleCallback() + ConsumerUser.createByOAuth() | 新用户自动创建     |

    表 3.4.1.2-1 用户管理 REST API 清单表

+   说明：
    -   REST API按用户群分为运营方用户接口（9个）、租户用户接口（13个）、个人用户接口（8个）、公共接口（9个）
    -   RPC接口供认证管理子领域（第5章）通过Feign调用
    -   消息接口通过领域事件发布，事件定义详见表 3.3.7-1

#### 3.4.1.3 RPC接口清单表

+   用户管理子领域提供的RPC接口清单如下表所示。

    | 接口编号   | 接口名称                  | 调用方        | 接口类型 | 领域方法                                    | 说明                                                         |
    | ---------- | ------------------------- | ------------- | -------- | ------------------------------------------- | ------------------------------------------------------------ |
    | RPC-USR-01 | 查询用户MFA状态           | BC-10认证子域 | Feign    | UserQueryService.getUserMfaStatus()         | 登录流程中判断是否需要双因素验证                             |
    | RPC-USR-02 | 获取用户Token签发基本信息 | BC-10认证子域 | Feign    | UserQueryService.getUserBasicInfoForToken() | 签发Token时获取userId、userPool、tenantId、tenantCode、roles |

    表 3.4.1.3-1 RPC接口清单表

#### 3.4.1.4 消息接口清单表

+   用户管理子领域发布的消息接口清单如下表所示。

    | 接口编号   | 消息名称             | 消息类型 | Topic      | 触发领域方法                                          | 消费方                       |
    | ---------- | -------------------- | -------- | ---------- | ----------------------------------------------------- | ---------------------------- |
    | MSG-USR-01 | UserCreated          | 领域事件 | iam.events | PlatformUser.create() / TenantUser.createByAdmin() 等 | 审计模块、BC-12、组织管理    |
    | MSG-USR-02 | UserRegistered       | 领域事件 | iam.events | TenantUser.createByRegistration()                     | 审计模块、BC-12、组织管理    |
    | MSG-USR-03 | UserSynced           | 领域事件 | iam.events | TenantUser.createBySync()                             | 审计模块                     |
    | MSG-USR-04 | ConsumerRegistered   | 领域事件 | iam.events | ConsumerUser.createByMobile() 等                      | 审计模块                     |
    | MSG-USR-05 | UserActivated        | 领域事件 | iam.events | PlatformUser.activate() / TenantUser.activate()       | 审计模块、BC-12              |
    | MSG-USR-06 | TenantAdminActivated | 领域事件 | iam.events | TenantUser.activate()（租户管理员）                   | 审计模块、BC-12              |
    | MSG-USR-07 | UserPasswordChanged  | 领域事件 | iam.events | *.changePassword()                                    | 审计模块                     |
    | MSG-USR-08 | UserPasswordReset    | 领域事件 | iam.events | *.resetPassword()                                     | 审计模块                     |
    | MSG-USR-09 | UserEnabled          | 领域事件 | iam.events | *.enable()                                            | 审计模块                     |
    | MSG-USR-10 | UserDisabled         | 领域事件 | iam.events | *.disable()                                           | 审计模块、认证模块、组织管理 |
    | MSG-USR-11 | UserDeleted          | 领域事件 | iam.events | *.delete()                                            | 审计模块、认证模块           |
    | MSG-USR-12 | UserCancelRequested  | 领域事件 | iam.events | *.requestCancel()                                     | 审计模块                     |
    | MSG-USR-13 | CancelRevoked        | 领域事件 | iam.events | *.revokeCancel()                                      | 审计模块                     |
    | MSG-USR-14 | UserCancelled        | 领域事件 | iam.events | UserCancellationService.confirmCancel()               | 审计模块、认证模块           |
    | MSG-USR-15 | OAuthBound           | 领域事件 | iam.events | ConsumerUser.bindOAuth()                              | 审计模块                     |
    | MSG-USR-16 | OAuthUnbound         | 领域事件 | iam.events | ConsumerUser.unbindOAuth()                            | 审计模块                     |
    | MSG-USR-17 | MfaEnabled           | 领域事件 | iam.events | *.enableMfa()                                         | 审计模块                     |
    | MSG-USR-18 | MfaDisabled          | 领域事件 | iam.events | *.disableMfa()                                        | 审计模块                     |
    | MSG-USR-19 | SubscriptionUpgraded | 领域事件 | iam.events | ConsumerUser.upgradeSubscription()                    | 审计模块                     |
    | MSG-USR-20 | PasswordSet          | 领域事件 | iam.events | ConsumerUser.setPassword()                            | 审计模块                     |

    表 3.4.1.4-1 消息接口清单表

### 3.4.2 RPC接口设计

+   用户管理子领域通过Feign向BC-10认证子域提供内部RPC接口。

#### 3.4.2.1 UserFeignClient

+   **UserFeignClient 概述**

    | 属性     | 值                                  |
    | -------- | ----------------------------------- |
    | 接口名称 | UserFeignClient                     |
    | 职责     | 供BC-10认证子域查询用户认证相关信息 |
    | 服务名   | svc-iam                             |
    | 路径前缀 | /internal/iam/users                 |
    | 降级实现 | UserFeignClientFallback             |
    | 默认超时 | 3秒                                 |

    表 3.4.2.1-1 UserFeignClient概述

+   **方法清单表**

    | 方法                                   | 简述                            | HTTP | 路径                 | 入参             | 返回                        | 超时 | 降级返回   |
    | -------------------------------------- | ------------------------------- | ---- | -------------------- | ---------------- | --------------------------- | ---- | ---------- |
    | getUserMfaStatus(userId, userPool)     | 查询用户MFA启用状态             | GET  | /{userId}/mfa-status | userId, userPool | MfaStatusDTO(enabled, type) | 3秒  | 视为未启用 |
    | getUserBasicInfoForToken(userId, pool) | 获取签发Token所需的用户基本信息 | GET  | /{userId}/token-info | userId, userPool | TokenUserInfoDTO            | 3秒  | 拒绝签发   |

    表 3.4.2.1-2 UserFeignClient方法清单表

+   **RPC-USR-01 getUserMfaStatus 契约**

    | 属性     | 值                                                                |
    | -------- | ----------------------------------------------------------------- |
    | 接口编号 | RPC-USR-01                                                        |
    | 调用场景 | 认证子域登录流程，密码校验通过后调用，判断是否需要进入MFA二次验证 |
    | 入参     | userId: Long, userPool: String(UP/UR)                             |
    | 返回类型 | MfaStatusDTO                                                      |
    | 幂等性   | 是（只读查询）                                                    |

    表 3.4.2.1-3 RPC-USR-01契约概述

+   **MfaStatusDTO 结构**

    | 字段名  | 数据类型 | 说明                                      |
    | ------- | -------- | ----------------------------------------- |
    | enabled | boolean  | 是否启用MFA                               |
    | mfaType | String   | MFA类型：TOTP / SMS / EMAIL，未启用为null |

    表 3.4.2.1-4 MfaStatusDTO字段

+   **RPC-USR-02 getUserBasicInfoForToken 契约**

    | 属性     | 值                                                              |
    | -------- | --------------------------------------------------------------- |
    | 接口编号 | RPC-USR-02                                                      |
    | 调用场景 | 认证子域签发JWT Token时调用，获取写入Token claims的用户核心属性 |
    | 入参     | userId: Long, userPool: String(UP/UR/UC)                        |
    | 返回类型 | TokenUserInfoDTO                                                |
    | 幂等性   | 是（只读查询）                                                  |

    表 3.4.2.1-5 RPC-USR-02契约概述

+   **TokenUserInfoDTO 结构**

    | 字段名     | 数据类型     | 说明                      |
    | ---------- | ------------ | ------------------------- |
    | userId     | Long         | 用户ID                    |
    | username   | String       | 用户名                    |
    | userPool   | String       | 用户群标识：UP / UR / UC  |
    | tenantId   | Long         | 租户ID，UP/UC用户为null   |
    | tenantCode | String       | 租户编码，UP/UC用户为null |
    | userType   | String       | 用户类型枚举值            |
    | status     | String       | 用户状态枚举值            |
    | roles      | List<String> | 用户角色编码列表          |

    表 3.4.2.1-6 TokenUserInfoDTO字段

+   **备注**
    -   两个接口均为只读查询，走只读事务，不修改任何数据
    -   接口定义在 `bc-10-iam-api` 模块的 `feign` 包下
    -   C端用户（UC）暂不支持MFA，getUserMfaStatus对UC用户直接返回 enabled=false

#### 3.4.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口                     | 降级条件        | 降级返回值                      | 日志级别 | 说明                                      |
    | ------------------------ | --------------- | ------------------------------- | -------- | ----------------------------------------- |
    | getUserMfaStatus         | 超时/服务不可用 | MfaStatusDTO(enabled=false)     | WARN     | 降级为不要求MFA，允许登录但记录告警       |
    | getUserBasicInfoForToken | 超时/服务不可用 | 抛出ServiceUnavailableException | ERROR    | 拒绝签发Token，返回登录失败；不可静默通过 |

    表 3.4.2.2-1 降级策略

+   **降级设计说明**
    -   getUserMfaStatus降级策略偏宽松：MFA是增强安全手段，短暂不可用时允许基础密码登录，避免用户完全无法登录
    -   getUserBasicInfoForToken降级策略偏严格：Token claims数据不完整会导致下游权限判断错误，必须拒绝签发
    -   熔断策略：连续5次调用失败后触发熔断，熔断窗口30秒，半开状态允许1个探测请求

### 3.4.3 消息接口设计

+   用户管理子领域通过领域事件发布消息。所有事件共享统一的通道和封装规范。

#### 3.4.3.1 消息通道配置

+   用户管理的消息通道配置如下表所示。

    | 通道名称   | Topic/Exchange | 类型  | 说明        |
    | ---------- | -------------- | ----- | ----------- |
    | iam-events | iam.events     | Topic | IAM领域事件 |

    表 3.4.3.1-1 消息通道配置

+   **消息规范**
    -   所有领域事件统一发布至 `iam.events` Topic，消费方通过事件类型（`type`字段）过滤订阅
    -   事件消息采用CloudEvents规范封装，包含 `type`、`source`、`id`、`time`、`data` 标准字段
    -   事件发布采用本地事务表（Outbox模式）保证与业务操作的原子性，由后台任务异步投递至消息中间件
    -   消费方必须实现幂等处理，以eventId作为去重键

#### 3.4.3.2 事件公共信封结构

+   所有事件共享以下CloudEvents信封字段，各事件的Payload仅定义 `data` 部分。

    | 信封字段        | 类型     | 说明                                   | 示例值                                 |
    | --------------- | -------- | -------------------------------------- | -------------------------------------- |
    | id              | String   | 事件唯一标识（UUID）                   | "f47ac10b-58cc-4372-a567-0e02b2c3d479" |
    | type            | String   | 事件类型，对应消息名称                 | "UserCreated"                          |
    | source          | String   | 事件来源，格式：/{context}/{subdomain} | "/bc-10/user-management"               |
    | time            | DateTime | 事件发生时间（ISO 8601）               | "2025-06-15T10:30:00Z"                 |
    | datacontenttype | String   | data内容类型                           | "application/json"                     |
    | data            | Object   | 事件Payload（各事件不同，见下文）      | { ... }                                |

    表 3.4.3.2-1 事件公共信封结构

#### 3.4.3.3 用户生命周期事件

+   以下事件覆盖用户从创建到注销的完整生命周期。

##### MSG-USR-01 UserCreated

+   **消息概述**

    | 属性     | 值                                  |
    | -------- | ----------------------------------- |
    | 消息编号 | MSG-USR-01                          |
    | 消息名称 | UserCreated                         |
    | Topic    | iam.events                          |
    | 消费方   | 审计模块、BC-12通知、组织管理       |
    | 触发时机 | 管理员创建用户成功后（UP/UR用户群） |

    表 3.4.3.3-1 MSG-USR-01消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明               |
    | ---------- | -------- | ------------------ |
    | userId     | Long     | 用户ID             |
    | username   | String   | 用户名             |
    | userPool   | String   | 用户群：UP / UR    |
    | email      | String   | 邮箱               |
    | userType   | String   | 用户类型枚举值     |
    | tenantId   | Long     | 租户ID（UR用户）   |
    | tenantCode | String   | 租户编码（UR用户） |
    | createdBy  | Long     | 创建人ID           |

    表 3.4.3.3-2 MSG-USR-01 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                    | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录用户创建操作日志                        | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送激活验证码                              | eventId去重 | 重试3次后告警 |
    | 组织管理 | 企业同步场景下调用PersonService自动创建人员 | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-3 MSG-USR-01消费方处理

##### MSG-USR-02 UserRegistered

+   **消息概述**

    | 属性     | 值                            |
    | -------- | ----------------------------- |
    | 消息编号 | MSG-USR-02                    |
    | 消息名称 | UserRegistered                |
    | Topic    | iam.events                    |
    | 消费方   | 审计模块、BC-12通知、组织管理 |
    | 触发时机 | 租户用户开放注册成功后        |

    表 3.4.3.3-4 MSG-USR-02消息概述

+   **Payload字段说明**

    | 字段名       | 数据类型 | 说明                                 |
    | ------------ | -------- | ------------------------------------ |
    | userId       | Long     | 用户ID                               |
    | username     | String   | 用户名                               |
    | email        | String   | 邮箱                                 |
    | tenantId     | Long     | 租户ID                               |
    | tenantCode   | String   | 租户编码                             |
    | registerType | String   | 注册方式：EMAIL_DOMAIN / INVITE_LINK |

    表 3.4.3.3-5 MSG-USR-02 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                                      | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录开放注册操作日志                                          | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送欢迎通知                                                  | eventId去重 | 重试3次后告警 |
    | 组织管理 | 若租户配置了默认部门/岗位，调用AppointmentService创建默认任职 | eventId去重 | 重试3次后告警 |

    表 3.4.3.3-6 MSG-USR-02消费方处理

##### MSG-USR-03 ~ MSG-USR-04 创建类事件（简表）

+   以下创建类事件结构与MSG-USR-01相似，以简表列出差异。

    | 消息编号   | 消息名称           | 触发时机         | 特有Payload字段                     | 消费方   |
    | ---------- | ------------------ | ---------------- | ----------------------------------- | -------- |
    | MSG-USR-03 | UserSynced         | 企业同步创建成功 | syncSource, externalId              | 审计模块 |
    | MSG-USR-04 | ConsumerRegistered | C端用户注册成功  | registerChannel(MOBILE/EMAIL/OAUTH) | 审计模块 |

    表 3.4.3.3-7 创建类事件简表

+   **公共Payload字段**：userId, username, userPool, email。注：MSG-USR-03（UserSynced）额外包含tenantId、tenantCode，MSG-USR-04（ConsumerRegistered）不含租户字段。

##### MSG-USR-05 UserActivated

+   **消息概述**

    | 属性     | 值                                          |
    | -------- | ------------------------------------------- |
    | 消息编号 | MSG-USR-05                                  |
    | 消息名称 | UserActivated                               |
    | Topic    | iam.events                                  |
    | 消费方   | 审计模块、BC-12通知                         |
    | 触发时机 | 用户通过激活验证码激活账号后（UP/UR用户群） |

    表 3.4.3.3-8 MSG-USR-05消息概述

+   **Payload字段说明**

    | 字段名      | 数据类型 | 说明               |
    | ----------- | -------- | ------------------ |
    | userId      | Long     | 用户ID             |
    | userPool    | String   | 用户群：UP / UR    |
    | username    | String   | 用户名             |
    | email       | String   | 邮箱               |
    | tenantId    | Long     | 租户ID（UR用户）   |
    | tenantCode  | String   | 租户编码（UR用户） |
    | activatedAt | DateTime | 激活时间           |

    表 3.4.3.3-9 MSG-USR-05 Payload字段

##### MSG-USR-06 TenantAdminActivated

+   **消息概述**

    | 属性     | 值                                                   |
    | -------- | ---------------------------------------------------- |
    | 消息编号 | MSG-USR-06                                           |
    | 消息名称 | TenantAdminActivated                                 |
    | Topic    | iam.events                                           |
    | 消费方   | 审计模块、BC-12通知                                  |
    | 触发时机 | 租户管理员激活成功后（首个管理员，标志租户正式开通） |

    表 3.4.3.3-10 MSG-USR-06消息概述

+   **Payload字段说明**：与MSG-USR-05相同，额外增加 tenantName: String（租户名称）

#### 3.4.3.4 安全与密码事件

+   以下事件与密码管理和MFA相关，消费方主要为审计模块。

    | 消息编号   | 消息名称            | 触发时机         | Payload字段（data部分）                                  | 消费方   |
    | ---------- | ------------------- | ---------------- | -------------------------------------------------------- | -------- |
    | MSG-USR-07 | UserPasswordChanged | 密码修改成功     | userId, userPool, tenantId, tenantCode, changedAt        | 审计模块 |
    | MSG-USR-08 | UserPasswordReset   | 密码重置成功     | userId, userPool, tenantId, tenantCode, resetBy, resetAt | 审计模块 |
    | MSG-USR-17 | MfaEnabled          | 启用MFA          | userId, userPool, mfaType                                | 审计模块 |
    | MSG-USR-18 | MfaDisabled         | 禁用MFA          | userId, userPool, disabledBy, reason                     | 审计模块 |
    | MSG-USR-20 | PasswordSet         | 三方用户补设密码 | userId, userPool(UC), setAt                              | 审计模块 |

    表 3.4.3.4-1 安全与密码事件汇总

+   **消费方处理契约**（统一）

    | 消费方   | 处理逻辑         | 幂等策略    | 失败处理      |
    | -------- | ---------------- | ----------- | ------------- |
    | 审计模块 | 记录安全审计日志 | eventId去重 | 重试3次后告警 |

    表 3.4.3.4-2 安全事件消费方处理

#### 3.4.3.5 状态变更事件

+   以下事件覆盖用户启用/禁用/删除等状态变更，涉及跨领域协作。

##### MSG-USR-09 UserEnabled

+   **消息概述**

    | 属性     | 值                 |
    | -------- | ------------------ |
    | 消息编号 | MSG-USR-09         |
    | 消息名称 | UserEnabled        |
    | Topic    | iam.events         |
    | 消费方   | 审计模块           |
    | 触发时机 | 已禁用用户被启用后 |

    表 3.4.3.5-1 MSG-USR-09消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明     |
    | ---------- | -------- | -------- |
    | userId     | Long     | 用户ID   |
    | userPool   | String   | 用户群   |
    | tenantId   | Long     | 租户ID   |
    | tenantCode | String   | 租户编码 |
    | enabledBy  | Long     | 操作人ID |
    | enabledAt  | DateTime | 启用时间 |

    表 3.4.3.5-2 MSG-USR-09 Payload字段

##### MSG-USR-10 UserDisabled

+   **消息概述**

    | 属性     | 值                           |
    | -------- | ---------------------------- |
    | 消息编号 | MSG-USR-10                   |
    | 消息名称 | UserDisabled                 |
    | Topic    | iam.events                   |
    | 消费方   | 审计模块、认证模块、组织管理 |
    | 触发时机 | 用户被管理员禁用后           |

    表 3.4.3.5-3 MSG-USR-10消息概述

+   **Payload字段说明**

    | 字段名        | 数据类型 | 说明     |
    | ------------- | -------- | -------- |
    | userId        | Long     | 用户ID   |
    | userPool      | String   | 用户群   |
    | tenantId      | Long     | 租户ID   |
    | tenantCode    | String   | 租户编码 |
    | disabledBy    | Long     | 操作人ID |
    | disabledAt    | DateTime | 禁用时间 |
    | disableReason | String   | 禁用原因 |

    表 3.4.3.5-4 MSG-USR-10 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                   | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------------ | ----------- | ------------- |
    | 审计模块 | 记录安全审计日志                           | eventId去重 | 重试3次后告警 |
    | 认证模块 | 强制下线：吊销该用户所有活跃Session和Token | eventId去重 | 重试3次后告警 |
    | 组织管理 | 可选更新关联人员的在职状态                 | eventId去重 | 重试3次后告警 |

    表 3.4.3.5-5 MSG-USR-10消费方处理

##### MSG-USR-11 UserDeleted

+   **消息概述**

    | 属性     | 值                 |
    | -------- | ------------------ |
    | 消息编号 | MSG-USR-11         |
    | 消息名称 | UserDeleted        |
    | Topic    | iam.events         |
    | 消费方   | 审计模块、认证模块 |
    | 触发时机 | 用户被逻辑删除后   |

    表 3.4.3.5-6 MSG-USR-11消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明     |
    | ---------- | -------- | -------- |
    | userId     | Long     | 用户ID   |
    | userPool   | String   | 用户群   |
    | tenantId   | Long     | 租户ID   |
    | tenantCode | String   | 租户编码 |
    | deletedBy  | Long     | 操作人ID |
    | deletedAt  | DateTime | 删除时间 |

    表 3.4.3.5-7 MSG-USR-11 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                             | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------ | ----------- | ------------- |
    | 审计模块 | 记录安全审计日志                     | eventId去重 | 重试3次后告警 |
    | 认证模块 | 强制下线、清理Token、吊销所有Session | eventId去重 | 重试3次后告警 |

    表 3.4.3.5-8 MSG-USR-11消费方处理

#### 3.4.3.6 注销流程事件

+   以下事件覆盖用户注销申请、撤销和完成。

    | 消息编号   | 消息名称            | 触发时机     | Payload字段（data部分）                                             | 消费方             |
    | ---------- | ------------------- | ------------ | ------------------------------------------------------------------- | ------------------ |
    | MSG-USR-12 | UserCancelRequested | 用户申请注销 | userId, userPool, tenantId, tenantCode, requestedAt, cooldownEndsAt | 审计模块           |
    | MSG-USR-13 | CancelRevoked       | 撤销注销申请 | userId, userPool, tenantId, tenantCode, revokedAt                   | 审计模块           |
    | MSG-USR-14 | UserCancelled       | 注销完成     | userId, userPool, tenantId, tenantCode, cancelledAt                 | 审计模块、认证模块 |

    表 3.4.3.6-1 注销流程事件汇总

+   **MSG-USR-14 消费方处理契约**

    | 消费方   | 处理逻辑                   | 幂等策略    | 失败处理      |
    | -------- | -------------------------- | ----------- | ------------- |
    | 审计模块 | 记录账号注销审计日志       | eventId去重 | 重试3次后告警 |
    | 认证模块 | 清理Token、吊销所有Session | eventId去重 | 重试3次后告警 |

    表 3.4.3.6-2 MSG-USR-14消费方处理

#### 3.4.3.7 三方账号与订阅事件

+   以下事件与C端用户三方账号管理和订阅变更相关。

    | 消息编号   | 消息名称             | 触发时机     | Payload字段（data部分）              | 消费方   |
    | ---------- | -------------------- | ------------ | ------------------------------------ | -------- |
    | MSG-USR-15 | OAuthBound           | 绑定三方账号 | userId, provider, openId, boundAt    | 审计模块 |
    | MSG-USR-16 | OAuthUnbound         | 解绑三方账号 | userId, provider, unboundAt          | 审计模块 |
    | MSG-USR-19 | SubscriptionUpgraded | 订阅升级     | userId, oldTier, newTier, upgradedAt | 审计模块 |

    表 3.4.3.7-1 三方账号与订阅事件汇总

+   **消费方处理契约**（统一）

    | 消费方   | 处理逻辑     | 幂等策略    | 失败处理      |
    | -------- | ------------ | ----------- | ------------- |
    | 审计模块 | 记录操作日志 | eventId去重 | 重试3次后告警 |

    表 3.4.3.7-2 三方账号与订阅事件消费方处理

### 3.4.4 REST接口设计

#### 3.4.4.1 运营方用户接口

+   运营方用户接口用于管理平台用户，需要管理员权限。

##### 3.4.4.1.1 接口清单

+   接口清单如下表：

    | API编号  | API名称            | 方法   | 路径                                        | 权限                     | 领域方法                                 | 备注           |
    | -------- | ------------------ | ------ | ------------------------------------------- | ------------------------ | ---------------------------------------- | -------------- |
    | P-USR-01 | 创建用户           | POST   | /api/v1/up/iam/users                        | provider:iam:user:create | PlatformUser.create()                    | -              |
    | P-USR-02 | 查询用户列表       | GET    | /api/v1/up/iam/users                        | provider:iam:user:list   | PlatformUserQueryService.getList()       | 支持分页       |
    | P-USR-03 | 查询用户详情       | GET    | /api/v1/up/iam/users/{id}                   | provider:iam:user:read   | PlatformUserQueryService.getDetail()     | -              |
    | P-USR-04 | 更新用户信息       | PUT    | /api/v1/up/iam/users/{id}                   | provider:iam:user:update | PlatformUser.updateContactInfo()         | -              |
    | P-USR-05 | 删除用户           | DELETE | /api/v1/up/iam/users/{id}                   | provider:iam:user:delete | PlatformUser.delete()                    | 逻辑删除       |
    | P-USR-06 | 禁用用户           | POST   | /api/v1/up/iam/users/{id}/disable           | provider:iam:user:update | PlatformUser.disable()                   | 需填写原因     |
    | P-USR-07 | 启用用户           | POST   | /api/v1/up/iam/users/{id}/enable            | provider:iam:user:update | PlatformUser.enable()                    | -              |
    | P-USR-08 | 管理员协助重置密码 | POST   | /api/v1/up/iam/users/{id}/reset-password    | provider:iam:user:update | PlatformUser.resetPassword()             | 发送重置验证码 |
    | P-USR-09 | 重发激活验证码     | POST   | /api/v1/up/iam/users/{id}/resend-activation | provider:iam:user:update | UserActivationService.resendActivation() | -              |

    +   表 3.4.4.1.1-1 运营方用户REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第3.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况

##### 3.4.4.1.2 P-USR-01 创建用户

+   **契约概述表**

    | 属性       | 值                                                                                    |
    | ---------- | ------------------------------------------------------------------------------------- |
    | API编号    | P-USR-01                                                                              |
    | 接口路径   | POST /api/v1/up/iam/users                                                             |
    | 功能简述   | 管理员创建平台用户，创建后发送激活验证码，初始状态为待激活                            |
    | 所需权限   | provider:iam:user:create                                                              |
    | 关联功能   | F-USR-01 平台用户创建                                                                 |
    | 关联用例   | UC-USR-01 管理员创建平台用户                                                          |
    | 关联领域   | PlatformUser.create()                                                                 |
    | 关联规则   | PU-R-01（用户名唯一）, PU-R-02（用户名格式）, PU-R-03（邮箱唯一）, PU-R-09（MFA强制） |
    | 幂等性     | 否（用户名/邮箱唯一性保证不重复创建）                                                 |
    | 关联错误码 | E-400001, E-400002, E-400003, E-409001, E-403001                                      |

    表 3.4.4.1.2-1 P-USR-01契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                               | 示例值                   | 业务含义                 |
    | -------- | ---- | ------ | ---- | ---------------------------------- | ------------------------ | ------------------------ |
    | username | body | String | 是   | 3-32位，仅字母数字下划线，唯一     | "admin_user01"           | 登录用户名               |
    | realName | body | String | 是   | 2-64字符                           | "张三"                   | 用户真实姓名             |
    | email    | body | String | 是   | 邮箱格式，平台库内唯一             | "<zhangsan@company.com>" | 邮箱，用于接收激活验证码 |
    | mobile   | body | String | 否   | 11位手机号                         | "13800138000"            | 手机号                   |
    | userType | body | String | 是   | 枚举：provider_admin/provider_user | "provider_user"          | 用户类型                 |
    | roleIds  | body | Long[] | 否   | BIGINT数组                         | [1001]                   | 分配的角色ID列表         |

    表 3.4.4.1.2-2 P-USR-01请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "创建成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.username  | String | 是   | "admin_user01"        | 用户名   |
    | data.status    | String | 是   | "PENDING"             | 用户状态 |
    | data.createdAt | String | 是   | "2026-01-26T10:00:00" | 创建时间 |

    表 3.4.4.1.2-3 P-USR-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "username": "admin_user01",
          "realName": "张三",
          "email": "zhangsan@company.com",
          "mobile": "13800138000",
          "userType": "provider_user",
          "roleIds": [1001]
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 1001,
            "username": "admin_user01",
            "status": "PENDING",
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.1.3 P-USR-02 查询用户列表

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | P-USR-02                               |
    | 接口路径   | GET /api/v1/up/iam/users               |
    | 功能简述   | 分页查询运营方用户列表，支持多条件筛选 |
    | 所需权限   | provider:iam:user:list                 |
    | 关联功能   | F-USR-02 平台用户查询                  |
    | 关联用例   | UC-USR-02 管理员查询平台用户列表       |
    | 关联领域   | PlatformUserQueryService.getList()     |
    | 关联规则   | 无                                     |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-400001, E-401001                     |

    表 3.4.4.1.3-1 P-USR-02契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                                  | 示例值          | 业务含义 |
    | -------- | ----- | ------- | ---- | ------------------------------------- | --------------- | -------- |
    | username | query | String  | 否   | 模糊匹配                              | "admin"         | 用户名   |
    | realName | query | String  | 否   | 模糊匹配                              | "张"            | 真实姓名 |
    | email    | query | String  | 否   | 模糊匹配                              | "@company.com"  | 邮箱     |
    | status   | query | String  | 否   | 枚举：PENDING/ACTIVE/DISABLED/DELETED | "ACTIVE"        | 用户状态 |
    | userType | query | String  | 否   | 枚举：provider_admin/provider_user    | "provider_user" | 用户类型 |
    | page     | query | Integer | 否   | ≥1，默认1                             | 1               | 页码     |
    | size     | query | Integer | 否   | 1-100，默认20                         | 20              | 每页大小 |

    表 3.4.4.1.3-2 P-USR-02请求契约表

+   **响应契约表**

    | 参数名                | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------------- | ------ | ---- | --------------------- | -------- |
    | code                  | Number | 是   | 0                     | 响应码   |
    | message               | String | 是   | "success"             | 响应消息 |
    | data.list[]           | Array  | 是   | [...]                 | 用户列表 |
    | data.list[].id        | Number | 是   | 1001                  | 用户ID   |
    | data.list[].username  | String | 是   | "admin_user01"        | 用户名   |
    | data.list[].realName  | String | 是   | "张三"                | 真实姓名 |
    | data.list[].email     | String | 是   | "zhang@company.com"   | 邮箱     |
    | data.list[].mobile    | String | 否   | "13800138000"         | 手机号   |
    | data.list[].userType  | String | 是   | "provider_user"       | 用户类型 |
    | data.list[].status    | String | 是   | "ACTIVE"              | 状态     |
    | data.list[].createdAt | String | 是   | "2026-01-20T10:00:00" | 创建时间 |
    | data.total            | Number | 是   | 100                   | 总记录数 |
    | data.page             | Number | 是   | 1                     | 当前页码 |
    | data.size             | Number | 是   | 20                    | 每页大小 |
    | data.pages            | Number | 是   | 5                     | 总页数   |

    表 3.4.4.1.3-3 P-USR-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 1001,
                "username": "admin_user01",
                "realName": "张三",
                "email": "zhangsan@company.com",
                "mobile": "13800138000",
                "userType": "provider_user",
                "status": "ACTIVE",
                "createdAt": "2026-01-20T10:00:00"
              }
            ],
            "total": 100,
            "page": 1,
            "size": 20,
            "pages": 5
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.1.4 P-USR-03 查询用户详情

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | P-USR-03                             |
    | 接口路径   | GET /api/v1/up/iam/users/{id}        |
    | 功能简述   | 根据ID查询运营方用户详细信息         |
    | 所需权限   | provider:iam:user:read               |
    | 关联功能   | F-USR-03 平台用户详情查询            |
    | 关联用例   | UC-USR-03 管理员查看用户详情         |
    | 关联领域   | PlatformUserQueryService.getDetail() |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001, E-401001, E-404001         |

    表 3.4.4.1.4-1 P-USR-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.1.4-2 P-USR-03请求契约表

+   **响应契约表**

    | 参数名           | 类型     | 必有 | 示例值                | 业务含义     |
    | ---------------- | -------- | ---- | --------------------- | ------------ |
    | code             | Number   | 是   | 0                     | 响应码       |
    | message          | String   | 是   | "success"             | 响应消息     |
    | data.id          | Number   | 是   | 1001                  | 用户ID       |
    | data.username    | String   | 是   | "admin_user01"        | 用户名       |
    | data.realName    | String   | 是   | "张三"                | 真实姓名     |
    | data.email       | String   | 是   | "zhang@company.com"   | 邮箱         |
    | data.mobile      | String   | 否   | "13800138000"         | 手机号       |
    | data.userType    | String   | 是   | "provider_user"       | 用户类型     |
    | data.status      | String   | 是   | "ACTIVE"              | 状态         |
    | data.mfaEnabled  | Boolean  | 是   | true                  | MFA是否启用  |
    | data.roles       | Object[] | 是   | [...]                 | 角色列表     |
    | data.lastLoginAt | String   | 否   | "2026-01-25T10:00:00" | 最后登录时间 |
    | data.createdAt   | String   | 是   | "2026-01-20T10:00:00" | 创建时间     |
    | data.updatedAt   | String   | 是   | "2026-01-25T10:00:00" | 更新时间     |

    表 3.4.4.1.4-3 P-USR-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "username": "admin_user01",
            "realName": "张三",
            "email": "zhangsan@company.com",
            "mobile": "13800138000",
            "userType": "provider_user",
            "status": "ACTIVE",
            "mfaEnabled": true,
            "roles": [
              {
                "roleId": "role-aa0e8400-e29b-41d4-a716-446655440000",
                "roleCode": "provider_user",
                "roleName": "普通用户"
              }
            ],
            "lastLoginAt": "2026-01-25T10:00:00",
            "createdAt": "2026-01-20T10:00:00",
            "updatedAt": "2026-01-25T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（用户不存在）

        ```json
        {
          "code": 404001,
          "message": "用户不存在",
          "data": {
            "userId": 1001
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.1.5 P-USR-04 更新用户信息

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | P-USR-04                               |
    | 接口路径   | PUT /api/v1/up/iam/users/{id}          |
    | 功能简述   | 更新运营方用户基本信息                 |
    | 所需权限   | provider:iam:user:update               |
    | 关联功能   | F-USR-04 平台用户信息更新              |
    | 关联用例   | UC-USR-04 管理员更新用户信息           |
    | 关联领域   | PlatformUser.updateContactInfo()       |
    | 关联规则   | PU-R-03（邮箱唯一）                    |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-400001, E-401001, E-404001, E-409002 |

    表 3.4.4.1.5-1 P-USR-04契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束       | 示例值              | 业务含义 |
    | -------- | ---- | ------ | ---- | ---------- | ------------------- | -------- |
    | id       | path | Long   | 是   | BIGINT     | 1001                | 用户ID   |
    | realName | body | String | 否   | 2-64字符   | "张三丰"            | 真实姓名 |
    | email    | body | String | 否   | 邮箱格式   | "zhang@company.com" | 邮箱     |
    | mobile   | body | String | 否   | 11位手机号 | "13800138001"       | 手机号   |

    表 3.4.4.1.5-2 P-USR-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "更新成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.realName  | String | 是   | "张三丰"              | 真实姓名 |
    | data.email     | String | 是   | "zhang@company.com"   | 邮箱     |
    | data.mobile    | String | 否   | "13800138001"         | 手机号   |
    | data.updatedAt | String | 是   | "2026-01-26T10:00:00" | 更新时间 |

    表 3.4.4.1.5-3 P-USR-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "realName": "张三丰",
          "mobile": "13800138001"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 1001,
            "realName": "张三丰",
            "email": "zhangsan@company.com",
            "mobile": "13800138001",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.1.6 P-USR-05 删除用户

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | P-USR-05                               |
    | 接口路径   | DELETE /api/v1/up/iam/users/{id}       |
    | 功能简述   | 逻辑删除运营方用户                     |
    | 所需权限   | provider:iam:user:delete               |
    | 关联功能   | F-USR-05 平台用户删除                  |
    | 关联用例   | UC-USR-05 管理员删除用户               |
    | 关联领域   | PlatformUser.delete()                  |
    | 关联规则   | PU-R-10（不能删除自己）                |
    | 幂等性     | 是（已删除返回成功）                   |
    | 关联错误码 | E-400001, E-401001, E-403002, E-404001 |

    表 3.4.4.1.6-1 P-USR-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.1.6-2 P-USR-05请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "删除成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.status    | String | 是   | "DELETED"             | 状态     |
    | data.deletedAt | String | 是   | "2026-01-26T10:00:00" | 删除时间 |

    表 3.4.4.1.6-3 P-USR-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "删除成功",
          "data": {
            "id": 1001,
            "status": "DELETED",
            "deletedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（不能删除自己）

        ```json
        {
          "code": 403002,
          "message": "不能删除当前登录用户",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   逻辑删除，状态变为DELETED
    -   删除后用户名和邮箱释放，可被其他用户使用

##### 3.4.4.1.7 P-USR-06 禁用用户

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | P-USR-06                                       |
    | 接口路径   | POST /api/v1/up/iam/users/{id}/disable         |
    | 功能简述   | 禁用运营方用户，需填写禁用原因                 |
    | 所需权限   | provider:iam:user:update                       |
    | 关联功能   | F-USR-06 平台用户禁用                          |
    | 关联用例   | UC-USR-06 管理员禁用用户                       |
    | 关联领域   | PlatformUser.disable()                         |
    | 关联规则   | PU-R-10（不能禁用自己）, PU-R-11（需填写原因） |
    | 幂等性     | 是（已禁用返回成功）                           |
    | 关联错误码 | E-400001, E-401001, E-403002, E-404001         |

    表 3.4.4.1.7-1 P-USR-06契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值         | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | -------------- | -------- |
    | id     | path | Long   | 是   | BIGINT   | 1001           | 用户ID   |
    | reason | body | String | 是   | 长度≤200 | "违反公司规定" | 禁用原因 |

    表 3.4.4.1.7-2 P-USR-06请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------- | ------ | ---- | --------------------- | -------- |
    | code            | Number | 是   | 0                     | 响应码   |
    | message         | String | 是   | "禁用成功"            | 响应消息 |
    | data.id         | Number | 是   | 1001                  | 用户ID   |
    | data.status     | String | 是   | "DISABLED"            | 状态     |
    | data.reason     | String | 是   | "违反公司规定"        | 禁用原因 |
    | data.disabledAt | String | 是   | "2026-01-26T10:00:00" | 禁用时间 |

    表 3.4.4.1.7-3 P-USR-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reason": "违反公司规定"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "禁用成功",
          "data": {
            "id": 1001,
            "status": "DISABLED",
            "reason": "违反公司规定",
            "disabledAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   禁用后用户无法登录
    -   禁用原因会记录在审计日志中

##### 3.4.4.1.8 P-USR-07 启用用户

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | P-USR-07                               |
    | 接口路径   | POST /api/v1/up/iam/users/{id}/enable  |
    | 功能简述   | 启用已禁用的运营方用户                 |
    | 所需权限   | provider:iam:user:update               |
    | 关联功能   | F-USR-07 平台用户启用                  |
    | 关联用例   | UC-USR-07 管理员启用用户               |
    | 关联领域   | PlatformUser.enable()                  |
    | 关联规则   | 无                                     |
    | 幂等性     | 是（已启用返回成功）                   |
    | 关联错误码 | E-400001, E-401001, E-404001, E-422001 |

    表 3.4.4.1.8-1 P-USR-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.1.8-2 P-USR-07请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "启用成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.status    | String | 是   | "ACTIVE"              | 状态     |
    | data.enabledAt | String | 是   | "2026-01-26T10:00:00" | 启用时间 |

    表 3.4.4.1.8-3 P-USR-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "启用成功",
          "data": {
            "id": 1001,
            "status": "ACTIVE",
            "enabledAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（用户状态不允许启用）

        ```json
        {
          "code": 422001,
          "message": "用户当前状态不允许启用",
          "data": {
            "currentStatus": "PENDING",
            "allowedStatuses": ["DISABLED"]
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅DISABLED状态的用户可以启用
    -   启用后状态变为ACTIVE

##### 3.4.4.1.9 P-USR-08 管理员协助重置密码

+   **契约概述表**

    | 属性       | 值                                                    |
    | ---------- | ----------------------------------------------------- |
    | API编号    | P-USR-08                                              |
    | 接口路径   | POST /api/v1/up/iam/users/{id}/reset-password         |
    | 功能简述   | 管理员为用户发送密码重置验证码，支持同时更新邮箱/手机 |
    | 所需权限   | provider:iam:user:update                              |
    | 关联功能   | F-USR-08 管理员协助重置密码                           |
    | 关联用例   | UC-USR-08 管理员重置用户密码                          |
    | 关联领域   | PlatformUser.resetPassword()                          |
    | 关联规则   | PU-R-03（邮箱唯一）, CAP-R-01（60秒间隔）             |
    | 幂等性     | 是（重复调用发送新验证码，旧验证码失效）              |
    | 关联错误码 | E-400001, E-403001, E-404001, E-409001                |

    表 3.4.4.1.9-1 P-USR-08契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                   | 示例值                   | 业务含义             |
    | -------- | ---- | ------ | ---- | ---------------------- | ------------------------ | -------------------- |
    | id       | path | Long   | 是   | BIGINT                 | 1001                     | 用户ID               |
    | newEmail | body | String | 否   | 邮箱格式，平台库内唯一 | "<newemail@company.com>" | 新邮箱（如需更新）   |
    | newPhone | body | String | 否   | 11位手机号             | "13900139000"            | 新手机号（如需更新） |
    | reason   | body | String | 是   | 1-200字符              | "用户忘记密码，申请重置" | 重置原因（审计用）   |

    表 3.4.4.1.9-2 P-USR-08请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                | 业务含义           |
    | ----------------- | ------- | ---- | --------------------- | ------------------ |
    | code              | Number  | 是   | 0                     | 响应码             |
    | message           | String  | 是   | "重置验证码已发送"    | 响应消息           |
    | data.success      | Boolean | 是   | true                  | 是否成功           |
    | data.expiresIn    | Number  | 是   | 900                   | 验证码有效期（秒） |
    | data.maskedTarget | String  | 是   | "zha****@company.com" | 脱敏后的接收目标   |

    表 3.4.4.1.9-3 P-USR-08响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "newEmail": "newemail@company.com",
          "reason": "用户忘记密码，申请重置"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "重置验证码已发送",
          "data": {
            "success": true,
            "expiresIn": 900,
            "maskedTarget": "new****@company.com"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.1.10 P-USR-09 重发激活验证码

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | P-USR-09                                                 |
    | 接口路径   | POST /api/v1/up/iam/users/{id}/resend-activation         |
    | 功能简述   | 为待激活用户重新发送激活验证码                           |
    | 所需权限   | provider:iam:user:update                                 |
    | 关联功能   | F-USR-09 重发激活验证码                                  |
    | 关联用例   | UC-USR-09 管理员重发激活验证码                           |
    | 关联领域   | UserActivationService.resendActivation()                 |
    | 关联规则   | PU-R-12（仅PENDING状态可重发）, CAP-R-01（发送间隔60秒） |
    | 幂等性     | 否                                                       |
    | 关联错误码 | E-400001, E-401001, E-404001, E-422002, E-429001         |

    表 3.4.4.1.10-1 P-USR-09契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.1.10-2 P-USR-09请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义           |
    | ----------------- | ------ | ---- | --------------------- | ------------------ |
    | code              | Number | 是   | 0                     | 响应码             |
    | message           | String | 是   | "激活验证码已发送"    | 响应消息           |
    | data.id           | Number | 是   | 1001                  | 用户ID             |
    | data.maskedTarget | String | 是   | "zha****@company.com" | 脱敏后的接收目标   |
    | data.expiresIn    | Number | 是   | 900                   | 验证码有效期（秒） |
    | data.sentAt       | String | 是   | "2026-01-26T10:00:00" | 发送时间           |

    表 3.4.4.1.10-3 P-USR-09响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "激活验证码已发送",
          "data": {
            "id": 1001,
            "maskedTarget": "zha****@company.com",
            "expiresIn": 900,
            "sentAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（用户状态不允许）

        ```json
        {
          "code": 422002,
          "message": "用户已激活，无需重发激活验证码",
          "data": {
            "currentStatus": "ACTIVE"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（发送过于频繁）

        ```json
        {
          "code": 429001,
          "message": "发送过于频繁，请60秒后重试",
          "data": {
            "retryAfter": 45
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅PENDING状态的用户可重发激活验证码
    -   激活验证码有效期15分钟
    -   发送间隔限制60秒

#### 3.4.4.2 租户用户接口

+   租户用户接口用于管理租户用户，通过X-Tenant-Id头部确定租户。

##### 3.4.4.2.1 接口清单

+   接口清单如下表：

    | API编号   | API名称            | 方法   | 路径                                        | 权限               | 领域方法                                 | 备注           |
    | --------- | ------------------ | ------ | ------------------------------------------- | ------------------ | ---------------------------------------- | -------------- |
    | UR-USR-01 | 创建用户           | POST   | /api/v1/ur/iam/users                        | ur:iam:user:create | TenantUser.createByAdmin()               | -              |
    | UR-USR-02 | 查询用户列表       | GET    | /api/v1/ur/iam/users                        | ur:iam:user:list   | TenantUserQueryService.getList()         | 支持分页       |
    | UR-USR-03 | 查询用户详情       | GET    | /api/v1/ur/iam/users/{id}                   | ur:iam:user:read   | TenantUserQueryService.getDetail()       | -              |
    | UR-USR-04 | 更新用户信息       | PUT    | /api/v1/ur/iam/users/{id}                   | ur:iam:user:update | TenantUser.updateContactInfo()           | 同步用户受限   |
    | UR-USR-05 | 删除用户           | DELETE | /api/v1/ur/iam/users/{id}                   | ur:iam:user:delete | TenantUser.delete()                      | 逻辑删除       |
    | UR-USR-06 | 禁用用户           | POST   | /api/v1/ur/iam/users/{id}/disable           | ur:iam:user:update | TenantUser.disable()                     | 需填写原因     |
    | UR-USR-07 | 启用用户           | POST   | /api/v1/ur/iam/users/{id}/enable            | ur:iam:user:update | TenantUser.enable()                      | -              |
    | UR-USR-08 | 管理员协助重置密码 | POST   | /api/v1/ur/iam/users/{id}/reset-password    | ur:iam:user:update | TenantUser.resetPassword()               | 发送重置验证码 |
    | UR-USR-09 | 重发激活验证码     | POST   | /api/v1/ur/iam/users/{id}/resend-activation | ur:iam:user:update | UserActivationService.resendActivation() | -              |
    | UR-USR-10 | 分配组织岗位       | POST   | /api/v1/ur/iam/users/{id}/assign-org        | ur:iam:user:update | TenantUser.assignToOrg()                 | 含岗位分配     |
    | UR-USR-11 | 获取当前用户信息   | GET    | /api/v1/ur/iam/users/me                     | authenticated      | TenantUserQueryService.getMe()           | -              |
    | UR-USR-12 | 更新当前用户信息   | PUT    | /api/v1/ur/iam/users/me                     | authenticated      | TenantUser.updateProfile()               | 同步用户受限   |
    | UR-USR-13 | 用户自助注销       | POST   | /api/v1/ur/iam/users/me/cancel              | authenticated      | TenantUser.cancel()                      | 仅自注册用户   |

    表 3.4.4.2.1-1 租户用户REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第3.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 3.4.4.2.2 UR-USR-01 创建用户

+   **契约概述表**

    | 属性       | 值                                                                                           |
    | ---------- | -------------------------------------------------------------------------------------------- |
    | API编号    | UR-USR-01                                                                                    |
    | 接口路径   | POST/api/v1/ur/iam/users                                                                     |
    | 功能简述   | 租户管理员创建用户，创建后发送激活验证码，用户来源标记为ADMIN_CREATED                        |
    | 所需权限   | ur:iam:user:create                                                                           |
    | 关联功能   | F-USR-01 租户用户创建                                                                        |
    | 关联用例   | UC-USR-01 租户管理员创建用户                                                                 |
    | 关联领域   | TenantUser.createByAdmin()                                                                   |
    | 关联规则   | TU-R-01（用户名唯一）, TU-R-02（邮箱唯一）, TU-R-03（员工编号唯一）, TU-R-10（试用用户上限） |
    | 幂等性     | 否（用户名/邮箱唯一性保证不重复创建）                                                        |
    | 关联错误码 | E-400001, E-400002, E-400003, E-400010, E-403001, E-409001                                   |

    表 3.4.4.2.2-1 UR-USR-01契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                                 | 示例值              | 业务含义             |
    | ---------- | ---- | ------ | ---- | ------------------------------------ | ------------------- | -------------------- |
    | username   | body | String | 是   | 3-32位，仅字母数字下划线，唯一       | "tenant_user01"     | 登录用户名           |
    | realName   | body | String | 是   | 2-64字符                             | "李四"              | 用户真实姓名         |
    | email      | body | String | 是   | 邮箱格式，租户库内唯一               | "<lisi@tenant.com>" | 邮箱，接收激活验证码 |
    | mobile     | body | String | 否   | 11位手机号                           | "13900139000"       | 手机号               |
    | employeeNo | body | String | 否   | 3-32字符，租户内唯一                 | "EMP001"            | 员工编号             |
    | userType   | body | String | 是   | 枚举：ur_admin/ur_user               | "ur_user"           | 用户类型             |
    | orgId      | body | Long   | 否   | BIGINT，需在org_organization表中存在 | 1001                | 所属组织单元ID       |
    | positionId | body | Long   | 否   | BIGINT，需在position表中存在         | 2001                | 所属岗位ID           |
    | roleIds    | body | Long[] | 否   | BIGINT数组                           | [2001]              | 分配的角色ID列表     |

    表 3.4.4.2.2-2 UR-USR-01请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------- | ------ | ---- | --------------------- | -------- |
    | code            | Number | 是   | 0                     | 响应码   |
    | message         | String | 是   | "创建成功"            | 响应消息 |
    | data.id         | Number | 是   | 1001                  | 用户ID   |
    | data.username   | String | 是   | "tenant_user01"       | 用户名   |
    | data.status     | String | 是   | "PENDING"             | 用户状态 |
    | data.sourceType | String | 是   | "ADMIN_CREATED"       | 用户来源 |
    | data.createdAt  | String | 是   | "2026-01-26T10:00:00" | 创建时间 |

    表 3.4.4.2.2-3 UR-USR-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "username": "tenant_user01",
          "realName": "李四",
          "email": "lisi@tenant.com",
          "mobile": "13900139000",
          "employeeNo": "EMP001",
          "userType": "ur_user",
          "orgId": 1001,
          "positionId": 2001,
          "roleIds": [2001]
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 1001,
            "username": "tenant_user01",
            "status": "PENDING",
            "sourceType": "ADMIN_CREATED",
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.3 UR-USR-02 查询用户列表

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-USR-02                            |
    | 接口路径   | GET/api/v1/ur/iam/users              |
    | 功能简述   | 分页查询租户用户列表，支持多条件筛选 |
    | 所需权限   | ur:iam:user:list                     |
    | 关联功能   | F-USR-02 租户用户查询                |
    | 关联用例   | UC-USR-02 管理员查询租户用户列表     |
    | 关联领域   | TenantUserQueryService.getList()     |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001, E-401001                   |

    表 3.4.4.2.3-1 UR-USR-02契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                                  | 示例值         | 业务含义   |
    | -------- | ----- | ------- | ---- | ------------------------------------- | -------------- | ---------- |
    | username | query | String  | 否   | 模糊匹配                              | "zhang"        | 用户名     |
    | realName | query | String  | 否   | 模糊匹配                              | "张"           | 真实姓名   |
    | email    | query | String  | 否   | 模糊匹配                              | "@company.com" | 邮箱       |
    | mobile   | query | String  | 否   | 模糊匹配                              | "138"          | 手机号     |
    | status   | query | String  | 否   | 枚举：PENDING/ACTIVE/DISABLED/DELETED | "ACTIVE"       | 用户状态   |
    | orgId    | query | Long    | 否   | BIGINT                                | 1001           | 所属组织ID |
    | source   | query | String  | 否   | 枚举：LOCAL/SYNC                      | "LOCAL"        | 数据来源   |
    | page     | query | Integer | 否   | ≥1，默认1                             | 1              | 页码       |
    | size     | query | Integer | 否   | 1-100，默认20                         | 20             | 每页大小   |

    表 3.4.4.2.3-2 UR-USR-02请求契约表

+   **响应契约表**

    | 参数名                | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------------- | ------ | ---- | --------------------- | -------- |
    | code                  | Number | 是   | 0                     | 响应码   |
    | message               | String | 是   | "success"             | 响应消息 |
    | data.list[]           | Array  | 是   | [...]                 | 用户列表 |
    | data.list[].id        | Number | 是   | 1001                  | 用户ID   |
    | data.list[].username  | String | 是   | "zhangsan"            | 用户名   |
    | data.list[].realName  | String | 是   | "张三"                | 真实姓名 |
    | data.list[].email     | String | 否   | "zhang@company.com"   | 邮箱     |
    | data.list[].mobile    | String | 否   | "13800138000"         | 手机号   |
    | data.list[].orgName   | String | 否   | "研发一部"            | 所属组织 |
    | data.list[].status    | String | 是   | "ACTIVE"              | 状态     |
    | data.list[].source    | String | 是   | "LOCAL"               | 数据来源 |
    | data.list[].createdAt | String | 是   | "2026-01-20T10:00:00" | 创建时间 |
    | data.total            | Number | 是   | 100                   | 总记录数 |
    | data.page             | Number | 是   | 1                     | 当前页码 |
    | data.size             | Number | 是   | 20                    | 每页大小 |
    | data.pages            | Number | 是   | 5                     | 总页数   |

    表 3.4.4.2.3-3 UR-USR-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 1001,
                "username": "zhangsan",
                "realName": "张三",
                "email": "zhangsan@company.com",
                "mobile": "13800138000",
                "orgName": "研发一部",
                "status": "ACTIVE",
                "source": "LOCAL",
                "createdAt": "2026-01-20T10:00:00"
              }
            ],
            "total": 100,
            "page": 1,
            "size": 20,
            "pages": 5
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.4 UR-USR-03 查询用户详情

+   **契约概述表**

    | 属性       | 值                                 |
    | ---------- | ---------------------------------- |
    | API编号    | UR-USR-03                          |
    | 接口路径   | GET/api/v1/ur/iam/users/{id}       |
    | 功能简述   | 根据ID查询租户用户详细信息         |
    | 所需权限   | ur:iam:user:read                   |
    | 关联功能   | F-USR-03 租户用户详情查询          |
    | 关联用例   | UC-USR-03 管理员查看用户详情       |
    | 关联领域   | TenantUserQueryService.getDetail() |
    | 关联规则   | 无                                 |
    | 幂等性     | 是                                 |
    | 关联错误码 | E-400001, E-401001, E-404001       |

    表 3.4.4.2.4-1 UR-USR-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.2.4-2 UR-USR-03请求契约表

+   **响应契约表**

    | 参数名            | 类型     | 必有 | 示例值                | 业务含义     |
    | ----------------- | -------- | ---- | --------------------- | ------------ |
    | code              | Number   | 是   | 0                     | 响应码       |
    | message           | String   | 是   | "success"             | 响应消息     |
    | data.id           | Number   | 是   | 1001                  | 用户ID       |
    | data.username     | String   | 是   | "zhangsan"            | 用户名       |
    | data.realName     | String   | 是   | "张三"                | 真实姓名     |
    | data.email        | String   | 否   | "zhang@company.com"   | 邮箱         |
    | data.mobile       | String   | 否   | "13800138000"         | 手机号       |
    | data.status       | String   | 是   | "ACTIVE"              | 状态         |
    | data.source       | String   | 是   | "LOCAL"               | 数据来源     |
    | data.externalId   | String   | 否   | "feishu_user_123"     | 外部系统ID   |
    | data.personId     | Number   | 否   | 2001                  | 关联人员ID   |
    | data.personName   | String   | 否   | "张三"                | 关联人员姓名 |
    | data.appointments | Object[] | 否   | [...]                 | 任职信息列表 |
    | data.roles        | Object[] | 是   | [...]                 | 角色列表     |
    | data.mfaEnabled   | Boolean  | 是   | false                 | MFA是否启用  |
    | data.lastLoginAt  | String   | 否   | "2026-01-25T10:00:00" | 最后登录时间 |
    | data.createdAt    | String   | 是   | "2026-01-20T10:00:00" | 创建时间     |
    | data.updatedAt    | String   | 是   | "2026-01-25T10:00:00" | 更新时间     |

    表 3.4.4.2.4-3 UR-USR-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "username": "zhangsan",
            "realName": "张三",
            "email": "zhangsan@company.com",
            "mobile": "13800138000",
            "status": "ACTIVE",
            "source": "LOCAL",
            "externalId": null,
            "personId": 2001,
            "personName": "张三",
            "appointments": [
              {
                "orgId": 3001,
                "orgName": "研发一部",
                "positionName": "高级工程师",
                "type": "PRIMARY"
              }
            ],
            "roles": [
              {
                "roleId": "role-dd0e8400-e29b-41d4-a716-446655440001",
                "roleCode": "ur_user",
                "roleName": "普通用户"
              }
            ],
            "mfaEnabled": false,
            "lastLoginAt": "2026-01-25T10:00:00",
            "createdAt": "2026-01-20T10:00:00",
            "updatedAt": "2026-01-25T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.5 UR-USR-04 更新用户信息

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | UR-USR-04                                        |
    | 接口路径   | PUT/api/v1/ur/iam/users/{id}                     |
    | 功能简述   | 更新租户用户基本信息，同步用户仅能更新部分字段   |
    | 所需权限   | ur:iam:user:update                               |
    | 关联功能   | F-USR-04 租户用户信息更新                        |
    | 关联用例   | UC-USR-04 管理员更新用户信息                     |
    | 关联领域   | TenantUser.updateContactInfo()                   |
    | 关联规则   | TU-R-01（同步用户受限）, TU-R-02（邮箱唯一）     |
    | 幂等性     | 是                                               |
    | 关联错误码 | E-400001, E-401001, E-404001, E-409002, E-422010 |

    表 3.4.4.2.5-1 UR-USR-04契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                   | 示例值              | 业务含义 |
    | -------- | ---- | ------ | ---- | ---------------------- | ------------------- | -------- |
    | id       | path | Long   | 是   | BIGINT                 | 1001                | 用户ID   |
    | realName | body | String | 否   | 2-64字符，同步用户受限 | "张三丰"            | 真实姓名 |
    | email    | body | String | 否   | 邮箱格式               | "zhang@company.com" | 邮箱     |
    | mobile   | body | String | 否   | 11位手机号             | "13800138001"       | 手机号   |

    表 3.4.4.2.5-2 UR-USR-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "更新成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.realName  | String | 是   | "张三丰"              | 真实姓名 |
    | data.email     | String | 否   | "zhang@company.com"   | 邮箱     |
    | data.mobile    | String | 否   | "13800138001"         | 手机号   |
    | data.updatedAt | String | 是   | "2026-01-26T10:00:00" | 更新时间 |

    表 3.4.4.2.5-3 UR-USR-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "realName": "张三丰",
          "mobile": "13800138001"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 1001,
            "realName": "张三丰",
            "email": "zhangsan@company.com",
            "mobile": "13800138001",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（同步用户受限）

        ```json
        {
          "code": 422010,
          "message": "同步用户的姓名不可修改，请在源系统中修改",
          "data": {
            "source": "FEISHU",
            "restrictedFields": ["realName"]
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同步用户（source=SYNC）的realName字段不可修改

##### 3.4.4.2.6 UR-USR-05 删除用户

+   **契约概述表**

    | 属性       | 值                                                   |
    | ---------- | ---------------------------------------------------- |
    | API编号    | UR-USR-05                                            |
    | 接口路径   | DELETE/api/v1/ur/iam/users/{id}                      |
    | 功能简述   | 逻辑删除租户用户                                     |
    | 所需权限   | ur:iam:user:delete                                   |
    | 关联功能   | F-USR-05 租户用户删除                                |
    | 关联用例   | UC-USR-05 管理员删除用户                             |
    | 关联领域   | TenantUser.delete()                                  |
    | 关联规则   | TU-R-03（不能删除自己）, TU-R-04（同步用户不可删除） |
    | 幂等性     | 是（已删除返回成功）                                 |
    | 关联错误码 | E-400001, E-401001, E-403002, E-404001, E-422011     |

    表 3.4.4.2.6-1 UR-USR-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.2.6-2 UR-USR-05请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "删除成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.status    | String | 是   | "DELETED"             | 状态     |
    | data.deletedAt | String | 是   | "2026-01-26T10:00:00" | 删除时间 |

    表 3.4.4.2.6-3 UR-USR-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "删除成功",
          "data": {
            "id": 1001,
            "status": "DELETED",
            "deletedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（同步用户不可删除）

        ```json
        {
          "code": 422011,
          "message": "同步用户不可直接删除，请在源系统中处理",
          "data": {
            "source": "FEISHU"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   逻辑删除，状态变为DELETED
    -   同步用户（source=SYNC）不可删除

##### 3.4.4.2.7 UR-USR-06 禁用用户

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | UR-USR-06                                      |
    | 接口路径   | POST/api/v1/ur/iam/users/{id}/disable          |
    | 功能简述   | 禁用租户用户，需填写禁用原因                   |
    | 所需权限   | ur:iam:user:update                             |
    | 关联功能   | F-USR-06 租户用户禁用                          |
    | 关联用例   | UC-USR-06 管理员禁用用户                       |
    | 关联领域   | TenantUser.disable()                           |
    | 关联规则   | TU-R-03（不能禁用自己）, TU-R-05（需填写原因） |
    | 幂等性     | 是（已禁用返回成功）                           |
    | 关联错误码 | E-400001, E-401001, E-403002, E-404001         |

    表 3.4.4.2.7-1 UR-USR-06契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值       | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | ------------ | -------- |
    | id     | path | Long   | 是   | BIGINT   | 1001         | 用户ID   |
    | reason | body | String | 是   | 长度≤200 | "长期未使用" | 禁用原因 |

    表 3.4.4.2.7-2 UR-USR-06请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                | 业务含义 |
    | --------------- | ------ | ---- | --------------------- | -------- |
    | code            | Number | 是   | 0                     | 响应码   |
    | message         | String | 是   | "禁用成功"            | 响应消息 |
    | data.id         | Number | 是   | 1001                  | 用户ID   |
    | data.status     | String | 是   | "DISABLED"            | 状态     |
    | data.reason     | String | 是   | "长期未使用"          | 禁用原因 |
    | data.disabledAt | String | 是   | "2026-01-26T10:00:00" | 禁用时间 |

    表 3.4.4.2.7-3 UR-USR-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reason": "长期未使用"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "禁用成功",
          "data": {
            "id": 1001,
            "status": "DISABLED",
            "reason": "长期未使用",
            "disabledAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.8 UR-USR-07 启用用户

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-USR-07                              |
    | 接口路径   | POST/api/v1/ur/iam/users/{id}/enable   |
    | 功能简述   | 启用已禁用的租户用户                   |
    | 所需权限   | ur:iam:user:update                     |
    | 关联功能   | F-USR-07 租户用户启用                  |
    | 关联用例   | UC-USR-07 管理员启用用户               |
    | 关联领域   | TenantUser.enable()                    |
    | 关联规则   | 无                                     |
    | 幂等性     | 是（已启用返回成功）                   |
    | 关联错误码 | E-400001, E-401001, E-404001, E-422001 |

    表 3.4.4.2.8-1 UR-USR-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.2.8-2 UR-USR-07请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "启用成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.status    | String | 是   | "ACTIVE"              | 状态     |
    | data.enabledAt | String | 是   | "2026-01-26T10:00:00" | 启用时间 |

    表 3.4.4.2.8-3 UR-USR-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "启用成功",
          "data": {
            "id": 1001,
            "status": "ACTIVE",
            "enabledAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅DISABLED状态的用户可以启用

##### 3.4.4.2.9 UR-USR-08 管理员协助重置密码

+   **契约概述表**

    | 属性       | 值                                            |
    | ---------- | --------------------------------------------- |
    | API编号    | UR-USR-08                                     |
    | 接口路径   | POST /api/v1/ur/iam/users/{id}/reset-password |
    | 功能简述   | 管理员为用户发送密码重置验证码                |
    | 所需权限   | ur:iam:user:update                            |
    | 关联功能   | F-USR-08 管理员协助重置密码                   |
    | 关联用例   | UC-USR-08 管理员重置用户密码                  |
    | 关联领域   | TenantUser.resetPassword()                    |
    | 关联规则   | CAP-R-01（发送间隔60秒）                      |
    | 幂等性     | 是（重复调用发送新验证码，旧验证码失效）      |
    | 关联错误码 | E-400001, E-401001, E-404001, E-429001        |

    表 3.4.4.2.9-1 UR-USR-08契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束       | 示例值                 | 业务含义         |
    | -------- | ---- | ------ | ---- | ---------- | ---------------------- | ---------------- |
    | id       | path | Long   | 是   | BIGINT     | 1001                   | 用户ID           |
    | newEmail | body | String | 否   | 邮箱格式   | "newemail@company.com" | 新邮箱（可选）   |
    | newPhone | body | String | 否   | 11位手机号 | "13900139000"          | 新手机号（可选） |

    表 3.4.4.2.9-2 UR-USR-08请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义           |
    | ----------------- | ------ | ---- | --------------------- | ------------------ |
    | code              | Number | 是   | 0                     | 响应码             |
    | message           | String | 是   | "重置验证码已发送"    | 响应消息           |
    | data.id           | Number | 是   | 1001                  | 用户ID             |
    | data.maskedTarget | String | 是   | "zha****@company.com" | 脱敏后的接收目标   |
    | data.expiresIn    | Number | 是   | 900                   | 验证码有效期（秒） |
    | data.sentAt       | String | 是   | "2026-01-26T10:00:00" | 发送时间           |

    表 3.4.4.2.9-3 UR-USR-08响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "重置验证码已发送",
          "data": {
            "id": 1001,
            "maskedTarget": "zha****@company.com",
            "expiresIn": 900,
            "sentAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   重置验证码有效期15分钟
    -   可同时更新用户邮箱或手机号

##### 3.4.4.2.10 UR-USR-09 重发激活验证码

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | UR-USR-09                                                |
    | 接口路径   | POST /api/v1/ur/iam/users/{id}/resend-activation         |
    | 功能简述   | 为待激活用户重新发送激活验证码                           |
    | 所需权限   | ur:iam:user:update                                       |
    | 关联功能   | F-USR-09 重发激活验证码                                  |
    | 关联用例   | UC-USR-09 管理员重发激活验证码                           |
    | 关联领域   | UserActivationService.resendActivation()                 |
    | 关联规则   | TU-R-07（仅PENDING状态可重发）, CAP-R-01（发送间隔60秒） |
    | 幂等性     | 否                                                       |
    | 关联错误码 | E-400001, E-401001, E-404001, E-422002, E-429001         |

    表 3.4.4.2.10-1 UR-USR-09契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 1001   | 用户ID   |

    表 3.4.4.2.10-2 UR-USR-09请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义           |
    | ----------------- | ------ | ---- | --------------------- | ------------------ |
    | code              | Number | 是   | 0                     | 响应码             |
    | message           | String | 是   | "激活验证码已发送"    | 响应消息           |
    | data.id           | Number | 是   | 1001                  | 用户ID             |
    | data.maskedTarget | String | 是   | "zha****@company.com" | 脱敏后的接收目标   |
    | data.expiresIn    | Number | 是   | 900                   | 验证码有效期（秒） |
    | data.sentAt       | String | 是   | "2026-01-26T10:00:00" | 发送时间           |

    表 3.4.4.2.10-3 UR-USR-09响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "激活验证码已发送",
          "data": {
            "id": 1001,
            "maskedTarget": "zha****@company.com",
            "expiresIn": 900,
            "sentAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（用户已激活）

        ```json
        {
          "code": 422002,
          "message": "用户已激活，无需重发激活验证码",
          "data": {
            "currentStatus": "ACTIVE"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅PENDING状态的用户可重发激活验证码
    -   激活验证码有效期15分钟
    -   发送间隔限制60秒

##### 3.4.4.2.11 UR-USR-10 分配组织岗位

+   **契约概述表**

    | 属性       | 值                                                                        |
    | ---------- | ------------------------------------------------------------------------- |
    | API编号    | UR-USR-10                                                                 |
    | 接口路径   | POST/api/v1/ur/iam/users/{id}/assign-org                                  |
    | 功能简述   | 为租户用户分配组织单元和岗位                                              |
    | 所需权限   | ur:iam:user:update                                                        |
    | 关联功能   | F-USR-10 分配组织岗位                                                     |
    | 关联用例   | UC-USR-10 管理员分配用户组织岗位                                          |
    | 关联领域   | TenantUser.assignToOrg(), TenantUser.assignToPosition()                   |
    | 关联规则   | TU-R-07（同步用户只读）, TU-R-08（组织单元有效性）, TU-R-09（岗位有效性） |
    | 幂等性     | 是（重复分配覆盖原值）                                                    |
    | 关联错误码 | E-400001, E-400008, E-400009, E-403001, E-403002, E-404001                |

    表 3.4.4.2.11-1 UR-USR-10契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型 | 必填 | 约束                                 | 示例值 | 业务含义   |
    | ---------- | ---- | ---- | ---- | ------------------------------------ | ------ | ---------- |
    | id         | path | Long | 是   | BIGINT                               | 1001   | 用户ID     |
    | orgId      | body | Long | 否   | BIGINT，需在org_organization表中存在 | 1001   | 组织单元ID |
    | positionId | body | Long | 否   | BIGINT，需在position表中存在         | 2001   | 岗位ID     |

    表 3.4.4.2.11-2 UR-USR-10请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值       | 业务含义       |
    | ----------------- | ------ | ---- | ------------ | -------------- |
    | code              | Number | 是   | 0            | 响应码         |
    | message           | String | 是   | "分配成功"   | 响应消息       |
    | data.orgId        | Number | 否   | 1001         | 分配的组织单元 |
    | data.orgName      | String | 否   | "研发部"     | 组织单元名称   |
    | data.positionId   | Number | 否   | 2001         | 分配的岗位     |
    | data.positionName | String | 否   | "高级工程师" | 岗位名称       |

    表 3.4.4.2.11-3 UR-USR-10响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "orgId": 1001,
          "positionId": 2001
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "分配成功",
          "data": {
            "orgId": 1001,
            "orgName": "研发部",
            "positionId": 2001,
            "positionName": "高级工程师"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.12 UR-USR-11 获取当前用户信息

+   **契约概述表**

    | 属性       | 值                             |
    | ---------- | ------------------------------ |
    | API编号    | UR-USR-11                      |
    | 接口路径   | GET/api/v1/ur/iam/users/me     |
    | 功能简述   | 获取当前登录用户的详细信息     |
    | 所需权限   | authenticated                  |
    | 关联功能   | F-USR-11 获取当前用户信息      |
    | 关联用例   | UC-USR-11 用户查看个人信息     |
    | 关联领域   | TenantUserQueryService.getMe() |
    | 关联规则   | 无                             |
    | 幂等性     | 是                             |
    | 关联错误码 | E-401001, E-401002             |

    表 3.4.4.2.12-1 UR-USR-11契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 3.4.4.2.12-2 UR-USR-11请求契约表

+   **响应契约表**

    | 参数名                       | 类型     | 必有 | 示例值                | 业务含义     |
    | ---------------------------- | -------- | ---- | --------------------- | ------------ |
    | code                         | Number   | 是   | 0                     | 响应码       |
    | message                      | String   | 是   | "success"             | 响应消息     |
    | data.id                      | Number   | 是   | 1001                  | 用户ID       |
    | data.username                | String   | 是   | "zhangsan"            | 用户名       |
    | data.realName                | String   | 是   | "张三"                | 真实姓名     |
    | data.email                   | String   | 否   | "zhang@company.com"   | 邮箱         |
    | data.mobile                  | String   | 否   | "13800138000"         | 手机号       |
    | data.avatar                  | String   | 否   | "https://..."         | 头像URL      |
    | data.status                  | String   | 是   | "ACTIVE"              | 状态         |
    | data.source                  | String   | 是   | "LOCAL"               | 数据来源     |
    | data.personId                | Number   | 否   | 2001                  | 关联人员ID   |
    | data.primaryOrg              | Object   | 否   | {...}                 | 主职组织信息 |
    | data.primaryOrg.orgId        | Number   | 否   | 3001                  | 组织ID       |
    | data.primaryOrg.orgName      | String   | 否   | "研发一部"            | 组织名称     |
    | data.primaryOrg.positionName | String   | 否   | "高级工程师"          | 岗位名称     |
    | data.roles                   | Object[] | 是   | [...]                 | 角色列表     |
    | data.mfaEnabled              | Boolean  | 是   | false                 | MFA是否启用  |
    | data.lastLoginAt             | String   | 否   | "2026-01-25T10:00:00" | 最后登录时间 |

    表 3.4.4.2.12-3 UR-USR-11响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "username": "zhangsan",
            "realName": "张三",
            "email": "zhangsan@company.com",
            "mobile": "13800138000",
            "avatar": "https://cdn.example.com/avatars/zhangsan.jpg",
            "status": "ACTIVE",
            "source": "LOCAL",
            "personId": 2001,
            "primaryOrg": {
              "orgId": 3001,
              "orgName": "研发一部",
              "positionName": "高级工程师"
            },
            "roles": [
              {
                "roleId": "role-dd0e8400-e29b-41d4-a716-446655440001",
                "roleCode": "ur_user",
                "roleName": "普通用户"
              }
            ],
            "mfaEnabled": false,
            "lastLoginAt": "2026-01-25T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.2.13 UR-USR-12 更新当前用户信息

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | UR-USR-12                                        |
    | 接口路径   | PUT/api/v1/ur/iam/users/me                       |
    | 功能简述   | 更新当前登录用户的个人信息，同步用户部分字段受限 |
    | 所需权限   | authenticated                                    |
    | 关联功能   | F-USR-12 更新当前用户信息                        |
    | 关联用例   | UC-USR-12 用户更新个人信息                       |
    | 关联领域   | TenantUser.updateProfile()                       |
    | 关联规则   | TU-R-01（同步用户受限）                          |
    | 幂等性     | 是                                               |
    | 关联错误码 | E-400001, E-401001, E-401002, E-422010           |

    表 3.4.4.2.13-1 UR-USR-12契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                   | 示例值                        | 业务含义 |
    | -------- | ---- | ------ | ---- | ---------------------- | ----------------------------- | -------- |
    | realName | body | String | 否   | 2-64字符，同步用户受限 | "张三丰"                      | 真实姓名 |
    | mobile   | body | String | 否   | 11位手机号             | "13800138001"                 | 手机号   |
    | avatar   | body | String | 否   | URL格式                | "https://cdn.example.com/..." | 头像URL  |

    表 3.4.4.2.13-2 UR-USR-12请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "更新成功"            | 响应消息 |
    | data.id        | Number | 是   | 1001                  | 用户ID   |
    | data.realName  | String | 是   | "张三丰"              | 真实姓名 |
    | data.mobile    | String | 否   | "13800138001"         | 手机号   |
    | data.avatar    | String | 否   | "https://..."         | 头像URL  |
    | data.updatedAt | String | 是   | "2026-01-26T10:00:00" | 更新时间 |

    表 3.4.4.2.13-3 UR-USR-12响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "realName": "张三丰",
          "mobile": "13800138001",
          "avatar": "https://cdn.example.com/avatars/new-avatar.jpg"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 1001,
            "realName": "张三丰",
            "mobile": "13800138001",
            "avatar": "https://cdn.example.com/avatars/new-avatar.jpg",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（同步用户受限）

        ```json
        {
          "code": 422010,
          "message": "同步用户的姓名不可修改，请在源系统中修改",
          "data": {
            "source": "FEISHU",
            "restrictedFields": ["realName"]
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同步用户（source=SYNC）的realName字段不可修改
    -   邮箱修改需要通过邮箱验证流程，不在此接口处理

##### 3.4.4.2.14 UR-USR-13 用户自助注销

+   **契约概述表**

    | 属性       | 值                                                  |
    | ---------- | --------------------------------------------------- |
    | API编号    | UR-USR-13                                           |
    | 接口路径   | POST/api/v1/ur/iam/users/me/cancel                  |
    | 功能简述   | 开放注册的用户自助注销账号，注销后状态变为CANCELLED |
    | 所需权限   | authenticated                                       |
    | 关联功能   | F-USR-13 用户自助注销                               |
    | 关联用例   | UC-USR-13 开放注册用户注销账号                      |
    | 关联领域   | TenantUser.canSelfCancel(), TenantUser.cancel()     |
    | 关联规则   | TU-R-06（自助注销前提）                             |
    | 幂等性     | 否（已注销用户再次调用返回错误）                    |
    | 关联错误码 | E-400001, E-401001, E-401002, E-403002              |

    表 3.4.4.2.14-1 UR-USR-13契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束     | 示例值           | 业务含义             |
    | -------- | ---- | ------ | ---- | -------- | ---------------- | -------------------- |
    | password | body | String | 是   | 非空     | "P@ssw0rd123"    | 当前密码（身份验证） |
    | reason   | body | String | 否   | ≤200字符 | "不再使用该系统" | 注销原因             |

    表 3.4.4.2.14-2 UR-USR-13请求契约表

+   **响应契约表**

    | 参数名       | 类型    | 必有 | 示例值      | 业务含义 |
    | ------------ | ------- | ---- | ----------- | -------- |
    | code         | Number  | 是   | 0           | 响应码   |
    | message      | String  | 是   | "注销成功"  | 响应消息 |
    | data.success | Boolean | 是   | true        | 是否成功 |
    | data.status  | String  | 是   | "CANCELLED" | 新状态   |

    表 3.4.4.2.14-3 UR-USR-13响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "password": "P@ssw0rd123",
          "reason": "不再使用该系统"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注销成功",
          "data": {
            "success": true,
            "status": "CANCELLED"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（非自注册用户）

        ```json
        {
          "code": 403002,
          "message": "仅开放注册用户可自助注销",
          "data": {
            "sourceType": "ADMIN_CREATED",
            "suggestion": "请联系管理员处理账号注销"
          },
          "timestamp": 1737885600000
        }
        ```

#### 3.4.4.3 个人用户接口

##### 3.4.4.3.1 接口清单

+   个人用户接口用于C端用户自我管理。

+   接口清单如下表：

    | API编号   | API名称          | 方法   | 路径                                          | 权限          | 领域方法                                      | 备注               |
    | --------- | ---------------- | ------ | --------------------------------------------- | ------------- | --------------------------------------------- | ------------------ |
    | UC-USR-01 | 获取当前用户信息 | GET    | /api/v1/uc/iam/users/me                       | authenticated | ConsumerUserQueryService.getMe()              | -                  |
    | UC-USR-02 | 更新当前用户信息 | PUT    | /api/v1/uc/iam/users/me                       | authenticated | ConsumerUser.updateProfile()                  | -                  |
    | UC-USR-03 | 申请注销         | POST   | /api/v1/uc/iam/users/me/cancel                | authenticated | ConsumerUser.requestCancel()                  | 7天冷静期          |
    | UC-USR-04 | 撤销注销         | POST   | /api/v1/uc/iam/users/me/cancel/revoke         | authenticated | ConsumerUser.revokeCancel()                   | 冷静期内可撤       |
    | UC-USR-05 | 获取三方绑定列表 | GET    | /api/v1/uc/iam/users/me/oauth                 | authenticated | ConsumerUserQueryService.getOAuthBindings()   | -                  |
    | UC-USR-06 | 绑定三方账号     | POST   | /api/v1/uc/iam/users/me/oauth/{provider}/bind | authenticated | ConsumerUser.bindOAuth()                      | -                  |
    | UC-USR-07 | 解绑三方账号     | DELETE | /api/v1/uc/iam/users/me/oauth/{provider}      | authenticated | ConsumerUser.unbindOAuth()                    | 需保留一种登录方式 |
    | UC-USR-08 | 设置/修改密码    | POST   | /api/v1/uc/iam/users/me/password              | authenticated | ConsumerUser.setPassword() / changePassword() | 首设/修改          |

    表 3.4.4.3.1-1 个人用户REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第3.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 3.4.4.3.2 UC-USR-01 获取当前用户信息

+   **契约概述表**

    | 属性       | 值                               |
    | ---------- | -------------------------------- |
    | API编号    | UC-USR-01                        |
    | 接口路径   | GET  /api/v1/uc/iam/users/me     |
    | 功能简述   | 获取当前登录C端用户的个人信息    |
    | 所需权限   | authenticated                    |
    | 关联功能   | F-USR-01 获取个人信息            |
    | 关联用例   | UC-USR-01 C端用户查看个人信息    |
    | 关联领域   | ConsumerUserQueryService.getMe() |
    | 关联规则   | -                                |
    | 幂等性     | 是（查询接口天然幂等）           |
    | 关联错误码 | E-401001, E-401002               |

    表 3.4.4.3.2-1 UC-USR-01契约概述表

+   **请求契约表**

    | 参数名 | 位置   | 类型   | 必填 | 约束   | 示例值          | 业务含义 |
    | ------ | ------ | ------ | ---- | ------ | --------------- | -------- |
    | -      | header | String | 是   | Bearer | "Bearer eyJ..." | 访问令牌 |

    表 3.4.4.3.2-2 UC-USR-01请求契约表

+   **响应契约表**

    | 参数名                 | 类型     | 必有 | 示例值                                 | 业务含义         |
    | ---------------------- | -------- | ---- | -------------------------------------- | ---------------- |
    | code                   | Number   | 是   | 0                                      | 响应码           |
    | message                | String   | 是   | "success"                              | 响应消息         |
    | data.id                | Number   | 是   | 1001                                   | 用户ID           |
    | data.nickname          | String   | 否   | "小明"                                 | 昵称             |
    | data.avatar            | String   | 否   | "<https://cdn.example.com/avatar.jpg>" | 头像URL          |
    | data.mobile            | String   | 否   | "138****8000"                          | 手机号（脱敏）   |
    | data.mobileVerified    | Boolean  | 是   | true                                   | 手机号是否已验证 |
    | data.email             | String   | 否   | "xiao****@gmail.com"                   | 邮箱（脱敏）     |
    | data.emailVerified     | Boolean  | 是   | false                                  | 邮箱是否已验证   |
    | data.subscriptionLevel | String   | 是   | "FREE"                                 | 订阅级别         |
    | data.oauthBindings     | Object[] | 是   | [{"provider":"wechat","bound":true}]   | 三方账号绑定列表 |
    | data.hasPassword       | Boolean  | 是   | true                                   | 是否已设置密码   |
    | data.createdAt         | String   | 是   | "2026-01-01T10:00:00"                  | 注册时间         |

    表 3.4.4.3.2-3 UC-USR-01响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "nickname": "小明",
            "avatar": "https://cdn.example.com/avatar.jpg",
            "mobile": "138****8000",
            "mobileVerified": true,
            "email": "xiao****@gmail.com",
            "emailVerified": false,
            "subscriptionLevel": "FREE",
            "oauthBindings": [
              {"provider": "wechat", "bound": true, "nickname": "微信昵称"},
              {"provider": "qq", "bound": false, "nickname": null}
            ],
            "hasPassword": true,
            "createdAt": "2026-01-01T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.3.3 UC-USR-02 更新当前用户信息

+   **契约概述表**

    | 属性       | 值                                                                      |
    | ---------- | ----------------------------------------------------------------------- |
    | API编号    | UC-USR-02                                                               |
    | 接口路径   | PUT  /api/v1/uc/iam/users/me                                            |
    | 功能简述   | C端用户更新个人资料，包括昵称、头像、联系方式等                         |
    | 所需权限   | authenticated                                                           |
    | 关联功能   | F-USR-02 更新个人信息                                                   |
    | 关联用例   | UC-USR-02 C端用户更新个人信息                                           |
    | 关联领域   | ConsumerUser.updateProfile()                                            |
    | 关联规则   | CU-R-01（手机号唯一）, CU-R-02（邮箱唯一）, CU-R-03（联系方式至少一项） |
    | 幂等性     | 是（相同数据多次提交结果一致）                                          |
    | 关联错误码 | E-400001, E-400021, E-400022, E-401001, E-409011, E-409012              |

    表 3.4.4.3.3-1 UC-USR-02契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                       | 示例值                            | 业务含义             |
    | ---------- | ---- | ------ | ---- | -------------------------- | --------------------------------- | -------------------- |
    | nickname   | body | String | 否   | 2-32字符                   | "新昵称"                          | 用户昵称             |
    | avatar     | body | String | 否   | URL格式，长度≤512          | "https://cdn.example.com/new.jpg" | 头像URL              |
    | mobile     | body | String | 否   | 11位手机号                 | "13900139000"                     | 新手机号（需验证码） |
    | email      | body | String | 否   | 邮箱格式                   | "new@gmail.com"                   | 新邮箱（需验证码）   |
    | verifyCode | body | String | 否   | 6位数字，更换手机/邮箱必填 | "123456"                          | 短信/邮箱验证码      |

    表 3.4.4.3.3-2 UC-USR-02请求契约表

+   **响应契约表**

    | 参数名        | 类型   | 必有 | 示例值                            | 业务含义           |
    | ------------- | ------ | ---- | --------------------------------- | ------------------ |
    | code          | Number | 是   | 0                                 | 响应码             |
    | message       | String | 是   | "更新成功"                        | 响应消息           |
    | data.id       | Number | 是   | 1001                              | 用户ID             |
    | data.nickname | String | 否   | "新昵称"                          | 更新后的昵称       |
    | data.avatar   | String | 否   | "https://cdn.example.com/new.jpg" | 更新后的头像URL    |
    | data.mobile   | String | 否   | "139****9000"                     | 更新后手机（脱敏） |
    | data.email    | String | 否   | "new****@gmail.com"               | 更新后邮箱（脱敏） |

    表 3.4.4.3.3-3 UC-USR-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "nickname": "新昵称",
          "avatar": "https://cdn.example.com/new.jpg"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 1001,
            "nickname": "新昵称",
            "avatar": "https://cdn.example.com/new.jpg",
            "mobile": "138****8000",
            "email": "xiao****@gmail.com"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.3.4 UC-USR-03 申请注销

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | UC-USR-03                                      |
    | 接口路径   | POST  /api/v1/uc/iam/users/me/cancel           |
    | 功能简述   | C端用户申请注销账号，进入7天冷静期，期间可撤销 |
    | 所需权限   | authenticated                                  |
    | 关联功能   | F-USR-03 申请注销                              |
    | 关联用例   | UC-USR-03 C端用户申请注销账号                  |
    | 关联领域   | ConsumerUser.requestCancel()                   |
    | 关联规则   | CU-R-07（冷静期7天）                           |
    | 幂等性     | 是（重复申请返回当前冷静期状态）               |
    | 关联错误码 | E-401001, E-401018, E-422107                   |

    表 3.4.4.3.4-1 UC-USR-03契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束     | 示例值     | 业务含义                    |
    | ---------- | ---- | ------ | ---- | -------- | ---------- | --------------------------- |
    | verifyCode | body | String | 是   | 6位数字  | "123456"   | 短信/邮箱验证码（身份验证） |
    | reason     | body | String | 否   | 长度≤500 | "不再使用" | 注销原因（用于产品改进）    |

    表 3.4.4.3.4-2 UC-USR-03请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                | 业务含义       |
    | ----------------- | ------- | ---- | --------------------- | -------------- |
    | code              | Number  | 是   | 0                     | 响应码         |
    | message           | String  | 是   | "注销申请已提交"      | 响应消息       |
    | data.coolingEndAt | String  | 是   | "2026-02-01T10:00:00" | 冷静期结束时间 |
    | data.coolingDays  | Number  | 是   | 7                     | 冷静期天数     |
    | data.canRevoke    | Boolean | 是   | true                  | 是否可撤销     |

    表 3.4.4.3.4-3 UC-USR-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "verifyCode": "123456",
          "reason": "不再使用该服务"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注销申请已提交，7天冷静期内可撤销",
          "data": {
            "coolingEndAt": "2026-02-01T10:00:00",
            "coolingDays": 7,
            "canRevoke": true
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（非自注册用户）

        ```json
        {
          "code": 422107,
          "message": "非自注册用户不允许自助注销",
          "data": {
            "suggestion": "请联系管理员处理账号注销"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   申请后进入7天冷静期，冷静期内可正常登录使用
    -   冷静期内可通过UC-USR-04撤销注销申请
    -   冷静期结束后系统定时任务自动完成注销
    -   仅sourceType=SELF_REGISTERED（自注册用户）可自助注销

##### 3.4.4.3.5 UC-USR-04 撤销注销

+   **契约概述表**

    | 属性       | 值                                          |
    | ---------- | ------------------------------------------- |
    | API编号    | UC-USR-04                                   |
    | 接口路径   | POST  /api/v1/uc/iam/users/me/cancel/revoke |
    | 功能简述   | 在冷静期内撤销注销申请，账号恢复正常状态    |
    | 所需权限   | authenticated                               |
    | 关联功能   | F-USR-04 撤销注销                           |
    | 关联用例   | UC-USR-04 C端用户撤销注销申请               |
    | 关联领域   | ConsumerUser.revokeCancel()                 |
    | 关联规则   | CU-R-08（冷静期内可撤销）                   |
    | 幂等性     | 是（重复撤销返回成功）                      |
    | 关联错误码 | E-401001, E-422100                          |

    表 3.4.4.3.5-1 UC-USR-04契约概述表

+   **请求契约表**

    | 参数名 | 位置   | 类型   | 必填 | 约束   | 示例值          | 业务含义 |
    | ------ | ------ | ------ | ---- | ------ | --------------- | -------- |
    | -      | header | String | 是   | Bearer | "Bearer eyJ..." | 访问令牌 |

    表 3.4.4.3.5-2 UC-USR-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义     |
    | -------------- | ------ | ---- | --------------------- | ------------ |
    | code           | Number | 是   | 0                     | 响应码       |
    | message        | String | 是   | "撤销成功"            | 响应消息     |
    | data.status    | String | 是   | "ACTIVE"              | 恢复后的状态 |
    | data.revokedAt | String | 是   | "2026-01-26T10:00:00" | 撤销时间     |

    表 3.4.4.3.5-3 UC-USR-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注销申请已撤销，账号恢复正常",
          "data": {
            "status": "ACTIVE",
            "revokedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（冷静期已过）

        ```json
        {
          "code": 422100,
          "message": "冷静期已过，无法撤销注销申请",
          "data": {
            "cancelledAt": "2026-02-01T00:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅在冷静期内（coolingEndAt之前）可撤销
    -   撤销后账号状态恢复为ACTIVE
    -   撤销后清除cancelRequestedAt和cancelCoolingEndAt字段

##### 3.4.4.3.6 UC-USR-05 获取三方绑定列表

+   **契约概述表**

    | 属性       | 值                                          |
    | ---------- | ------------------------------------------- |
    | API编号    | UC-USR-05                                   |
    | 接口路径   | GET  /api/v1/uc/iam/users/me/oauth          |
    | 功能简述   | 查询当前用户已绑定和未绑定的三方账号列表    |
    | 所需权限   | authenticated                               |
    | 关联功能   | F-USR-05 获取三方绑定列表                   |
    | 关联用例   | UC-USR-05 C端用户查看三方绑定               |
    | 关联领域   | ConsumerUserQueryService.getOAuthBindings() |
    | 关联规则   | -                                           |
    | 幂等性     | 是（查询接口天然幂等）                      |
    | 关联错误码 | E-401001, E-401002                          |

    表 3.4.4.3.6-1 UC-USR-05契约概述表

+   **请求契约表**

    | 参数名 | 位置   | 类型   | 必填 | 约束   | 示例值          | 业务含义 |
    | ------ | ------ | ------ | ---- | ------ | --------------- | -------- |
    | -      | header | String | 是   | Bearer | "Bearer eyJ..." | 访问令牌 |

    表 3.4.4.3.6-2 UC-USR-05请求契约表

+   **响应契约表**

    | 参数名              | 类型    | 必有 | 示例值        | 业务含义                 |
    | ------------------- | ------- | ---- | ------------- | ------------------------ |
    | code                | Number  | 是   | 0             | 响应码                   |
    | message             | String  | 是   | "success"     | 响应消息                 |
    | data[].provider     | String  | 是   | "wechat"      | 三方平台标识             |
    | data[].providerName | String  | 是   | "微信"        | 三方平台显示名称         |
    | data[].bound        | Boolean | 是   | true          | 是否已绑定               |
    | data[].nickname     | String  | 否   | "微信昵称"    | 三方平台昵称（已绑定时） |
    | data[].avatar       | String  | 否   | "https://..." | 三方平台头像（已绑定时） |
    | data[].boundAt      | String  | 否   | "2026-01-01"  | 绑定时间（已绑定时）     |

    表 3.4.4.3.6-3 UC-USR-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "provider": "wechat",
              "providerName": "微信",
              "bound": true,
              "nickname": "微信昵称",
              "avatar": "https://thirdwx.qlogo.cn/xxx",
              "boundAt": "2026-01-01T10:00:00"
            },
            {
              "provider": "qq",
              "providerName": "QQ",
              "bound": false,
              "nickname": null,
              "avatar": null,
              "boundAt": null
            },
            {
              "provider": "dingtalk",
              "providerName": "钉钉",
              "bound": false,
              "nickname": null,
              "avatar": null,
              "boundAt": null
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.3.7 UC-USR-06 绑定三方账号

+   **契约概述表**

    | 属性       | 值                                                  |
    | ---------- | --------------------------------------------------- |
    | API编号    | UC-USR-06                                           |
    | 接口路径   | POST  /api/v1/uc/iam/users/me/oauth/{provider}/bind |
    | 功能简述   | 将三方账号绑定到当前用户，需先完成三方授权          |
    | 所需权限   | authenticated                                       |
    | 关联功能   | F-USR-06 绑定三方账号                               |
    | 关联用例   | UC-USR-06 C端用户绑定三方账号                       |
    | 关联领域   | ConsumerUser.bindOAuth()                            |
    | 关联规则   | CU-R-05（三方账号唯一绑定）, OB-R-01, OB-R-05       |
    | 幂等性     | 是（已绑定返回成功）                                |
    | 关联错误码 | E-401001, E-422204                                  |

    表 3.4.4.3.7-1 UC-USR-06契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束               | 示例值           | 业务含义             |
    | -------- | ---- | ------ | ---- | ------------------ | ---------------- | -------------------- |
    | provider | path | String | 是   | wechat/qq/dingtalk | "wechat"         | 三方平台标识         |
    | code     | body | String | 是   | 三方授权码         | "oauth_code_xxx" | 三方平台返回的授权码 |
    | state    | body | String | 是   | 状态码（防CSRF）   | "state_xxx"      | 授权时传递的状态码   |

    表 3.4.4.3.7-2 UC-USR-06请求契约表

+   **响应契约表**

    | 参数名        | 类型   | 必有 | 示例值        | 业务含义     |
    | ------------- | ------ | ---- | ------------- | ------------ |
    | code          | Number | 是   | 0             | 响应码       |
    | message       | String | 是   | "绑定成功"    | 响应消息     |
    | data.provider | String | 是   | "wechat"      | 三方平台标识 |
    | data.nickname | String | 否   | "微信昵称"    | 三方平台昵称 |
    | data.avatar   | String | 否   | "https://..." | 三方平台头像 |
    | data.boundAt  | String | 是   | "2026-01-26"  | 绑定时间     |

    表 3.4.4.3.7-3 UC-USR-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "code": "oauth_code_from_wechat",
          "state": "state_generated_by_server"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "绑定成功",
          "data": {
            "provider": "wechat",
            "nickname": "微信昵称",
            "avatar": "https://thirdwx.qlogo.cn/xxx",
            "boundAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（已被其他账号绑定）

        ```json
        {
          "code": 422204,
          "message": "该微信账号已被其他用户绑定",
          "data": {
            "provider": "wechat"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.3.8 UC-USR-07 解绑三方账号

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | UC-USR-07                                        |
    | 接口路径   | DELETE  /api/v1/uc/iam/users/me/oauth/{provider} |
    | 功能简述   | 解绑当前用户的指定三方账号                       |
    | 所需权限   | authenticated                                    |
    | 关联功能   | F-USR-07 解绑三方账号                            |
    | 关联用例   | UC-USR-07 C端用户解绑三方账号                    |
    | 关联领域   | ConsumerUser.unbindOAuth()                       |
    | 关联规则   | CU-R-06（最少一种登录方式）                      |
    | 幂等性     | 是（未绑定返回成功）                             |
    | 关联错误码 | E-401001, E-422205                               |

    表 3.4.4.3.8-1 UC-USR-07契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束               | 示例值 | 业务含义     |
    | -------- | ---- | ------ | ---- | ------------------ | ------ | ------------ |
    | provider | path | String | 是   | wechat/qq/dingtalk | "qq"   | 三方平台标识 |

    表 3.4.4.3.8-2 UC-USR-07请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值       | 业务含义       |
    | -------------- | ------ | ---- | ------------ | -------------- |
    | code           | Number | 是   | 0            | 响应码         |
    | message        | String | 是   | "解绑成功"   | 响应消息       |
    | data.provider  | String | 是   | "qq"         | 解绑的平台标识 |
    | data.unboundAt | String | 是   | "2026-01-26" | 解绑时间       |

    表 3.4.4.3.8-3 UC-USR-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "解绑成功",
          "data": {
            "provider": "qq",
            "unboundAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（不能解绑最后一种登录方式）

        ```json
        {
          "code": 422205,
          "message": "不能解绑最后一种登录方式，请先设置密码或绑定其他账号",
          "data": {
            "hasPassword": false,
            "boundProviders": ["qq"]
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   解绑前需确保用户至少保留一种登录方式（密码或其他三方账号）
    -   若用户无密码且仅绑定一个三方账号，解绑将被拒绝

##### 3.4.4.3.9 UC-USR-08 设置/修改密码

+   **契约概述表**

    | 属性       | 值                                                         |
    | ---------- | ---------------------------------------------------------- |
    | API编号    | UC-USR-08                                                  |
    | 接口路径   | POST  /api/v1/uc/iam/users/me/password                     |
    | 功能简述   | 首次设置密码或修改已有密码，根据场景校验验证码或旧密码     |
    | 所需权限   | authenticated                                              |
    | 关联功能   | F-USR-08 设置/修改密码                                     |
    | 关联用例   | UC-USR-08 C端用户设置或修改密码                            |
    | 关联领域   | ConsumerUser.setPassword() / ConsumerUser.changePassword() |
    | 关联规则   | CU-R-04（密码策略）                                        |
    | 幂等性     | 否                                                         |
    | 关联错误码 | E-400023, E-400024, E-401001, E-401017, E-401018           |

    表 3.4.4.3.9-1 UC-USR-08契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                    | 示例值     | 业务含义                        |
    | ----------- | ---- | ------ | ---- | ----------------------- | ---------- | ------------------------------- |
    | oldPassword | body | String | 否   | 已有密码时必填          | "OldP@ss1" | 旧密码（首次设置时不需要）      |
    | newPassword | body | String | 是   | 长度≥6，含字母+数字     | "NewP@ss2" | 新密码                          |
    | verifyCode  | body | String | 否   | 6位数字，首次设置时必填 | "123456"   | 短信/邮箱验证码（首次设置必填） |

    表 3.4.4.3.9-2 UC-USR-08请求契约表

+   **响应契约表**

    | 参数名          | 类型    | 必有 | 示例值                | 业务含义     |
    | --------------- | ------- | ---- | --------------------- | ------------ |
    | code            | Number  | 是   | 0                     | 响应码       |
    | message         | String  | 是   | "密码设置成功"        | 响应消息     |
    | data.isFirstSet | Boolean | 是   | true                  | 是否首次设置 |
    | data.updatedAt  | String  | 是   | "2026-01-26T10:00:00" | 更新时间     |

    表 3.4.4.3.9-3 UC-USR-08响应契约表

+   **Mock示例**

    +   请求Mock（首次设置）

        ```json
        {
          "newPassword": "NewP@ss123",
          "verifyCode": "123456"
        }
        ```

    +   请求Mock（修改密码）

        ```json
        {
          "oldPassword": "OldP@ss123",
          "newPassword": "NewP@ss456"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "密码设置成功",
          "data": {
            "isFirstSet": false,
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（旧密码错误）

        ```json
        {
          "code": 401017,
          "message": "旧密码错误",
          "data": {
            "remainingAttempts": 4
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（密码强度不足）

        ```json
        {
          "code": 400023,
          "message": "密码强度不足，需包含字母和数字",
          "data": {
            "policy": "长度≥6，必须包含字母和数字"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   首次设置密码场景：三方账号注册的用户，需提供verifyCode验证身份
    -   修改密码场景：已有密码的用户，需提供oldPassword验证身份
    -   密码策略：长度≥6，必须同时包含字母和数字

#### 3.4.4.4 公共接口

+   公共接口无需登录即可访问，用于注册、激活等场景。

##### 3.4.4.4.1 接口清单

+   接口清单如下表：

    | API编号 | API名称          | 方法 | 路径                                         | 权限 | 领域方法                                                     | 备注           |
    | ------- | ---------------- | ---- | -------------------------------------------- | ---- | ------------------------------------------------------------ | -------------- |
    | PUB-01  | 个人用户注册     | POST | /api/v1/public/iam/register/consumer         | 无   | ConsumerUser.createByMobile/Email()                          | 注册即登录     |
    | PUB-02  | 租户用户开放注册 | POST | /api/v1/public/iam/register/tenant           | 无   | TenantUser.createByRegistration()                            | 邮箱域匹配租户 |
    | PUB-03  | 激活账号         | POST | /api/v1/public/iam/activate                  | 无   | PlatformUser/TenantUser.activate()                           | 支持UP/UR      |
    | PUB-04  | 忘记密码         | POST | /api/v1/public/iam/password/forgot           | 无   | CaptchaService.send()                                        | 发送重置验证码 |
    | PUB-05  | 重置密码         | POST | /api/v1/public/iam/password/reset            | 无   | User.resetPasswordByCode()                                   | 验证码一次性   |
    | PUB-06  | 发送验证码       | POST | /api/v1/public/iam/captcha/send              | 无   | CaptchaService.send()                                        | 60秒间隔限制   |
    | PUB-07  | 申请企业试用     | POST | /api/v1/public/iam/trial/apply               | 无   | TrialApplicationService.apply()                              | 可配自动审核   |
    | PUB-08  | 获取OAuth授权URL | GET  | /api/v1/public/iam/oauth/{provider}/url      | 无   | OAuthService.generateAuthUrl()                               | state防CSRF    |
    | PUB-09  | 三方授权回调     | POST | /api/v1/public/iam/oauth/{provider}/callback | 无   | OAuthService.handleCallback() + ConsumerUser.createByOAuth() | 新用户自动创建 |

    表 3.4.4.4.1-1 公共REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第3.3节领域模型设计中的聚合方法或应用服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 3.4.4.4.2 PUB-01 个人用户注册

+   **契约概述表**

    | 属性       | 值                                                                                           |
    | ---------- | -------------------------------------------------------------------------------------------- |
    | API编号    | PUB-01                                                                                       |
    | 接口路径   | POST /api/v1/public/iam/register/consumer                                                    |
    | 功能简述   | C端用户通过手机号或邮箱注册，注册成功后自动登录返回令牌                                      |
    | 所需权限   | 无                                                                                           |
    | 关联功能   | F-REG-01 个人用户注册                                                                        |
    | 关联用例   | UC-REG-01 C端用户手机/邮箱注册                                                               |
    | 关联领域   | ConsumerUser.createByMobile() / ConsumerUser.createByEmail()                                 |
    | 关联规则   | CU-R-01（手机号唯一）, CU-R-02（邮箱唯一）, CU-R-03（联系方式至少一项）, CU-R-04（密码策略） |
    | 幂等性     | 否（手机号/邮箱唯一性保证不重复创建）                                                        |
    | 关联错误码 | E-400001, E-400003, E-400004, E-400005, E-400011, E-409001, E-409002                         |

    表 3.4.4.4.2-1 PUB-01契约概述表

+   **请求契约表**

    | 参数名            | 位置 | 类型    | 必填 | 约束                      | 示例值             | 业务含义                   |
    | ----------------- | ---- | ------- | ---- | ------------------------- | ------------------ | -------------------------- |
    | mobile            | body | String  | 否   | 11位手机号，与email二选一 | "13800138000"      | 手机号（注册方式一）       |
    | email             | body | String  | 否   | 邮箱格式，与mobile二选一  | "<user@gmail.com>" | 邮箱（注册方式二）         |
    | verifyCode        | body | String  | 是   | 6位数字                   | "123456"           | 短信/邮箱验证码            |
    | password          | body | String  | 是   | 长度≥6，含字母+数字       | "Pass123"          | 登录密码                   |
    | nickname          | body | String  | 否   | 2-32字符                  | "小明"             | 用户昵称                   |
    | agreementAccepted | body | Boolean | 是   | 必须为true                | true               | 是否同意用户协议和隐私政策 |

    表 3.4.4.4.2-2 PUB-01请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义               |
    | ----------------- | ------ | ---- | --------------------------- | ---------------------- |
    | code              | Number | 是   | 0                           | 响应码                 |
    | message           | String | 是   | "注册成功"                  | 响应消息               |
    | data.userId       | Number | 是   | 1001                        | 用户ID                 |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌（注册即登录） |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌               |
    | data.expiresIn    | Number | 是   | 7200                        | 令牌过期时间（秒）     |

    表 3.4.4.4.2-3 PUB-01响应契约表

+   **Mock示例**

    +   请求Mock（手机号注册）

        ```json
        {
          "mobile": "13800138000",
          "verifyCode": "123456",
          "password": "Pass123",
          "nickname": "小明",
          "agreementAccepted": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注册成功",
          "data": {
            "userId": 1001,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（手机号已存在）

        ```json
        {
          "code": 409001,
          "message": "手机号已被注册",
          "data": {
            "field": "mobile",
            "suggestion": "请使用其他手机号或直接登录"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.4.3 PUB-02 租户用户开放注册

+   **契约概述表**

    | 属性       | 值                                                                       |
    | ---------- | ------------------------------------------------------------------------ |
    | API编号    | PUB-02                                                                   |
    | 接口路径   | POST /api/v1/public/iam/register/tenant                                  |
    | 功能简述   | 员工使用企业邮箱自助注册，系统根据邮箱域名自动关联到对应租户             |
    | 所需权限   | 无                                                                       |
    | 关联功能   | F-REG-02 租户用户开放注册                                                |
    | 关联用例   | UC-REG-02 员工通过企业邮箱注册                                           |
    | 关联领域   | TenantUser.createByRegistration()                                        |
    | 关联规则   | TU-R-01（邮箱唯一）, TU-R-05（密码策略）, SR-R-02（来源SELF_REGISTERED） |
    | 幂等性     | 否（邮箱唯一性保证不重复创建）                                           |
    | 关联错误码 | E-400001, E-400021, E-400023, E-401018, E-409011, E-422106               |

    表 3.4.4.4.3-1 PUB-02契约概述表

+   **请求契约表**

    | 参数名            | 位置 | 类型    | 必填 | 约束                 | 示例值              | 业务含义                       |
    | ----------------- | ---- | ------- | ---- | -------------------- | ------------------- | ------------------------------ |
    | email             | body | String  | 是   | 企业邮箱格式         | "zhang@company.com" | 企业邮箱（域名需匹配租户配置） |
    | verifyCode        | body | String  | 是   | 6位数字              | "123456"            | 邮箱验证码                     |
    | password          | body | String  | 是   | 符合租户密码策略     | "P@ssw0rd123"       | 登录密码                       |
    | realName          | body | String  | 是   | 2-32字符，中文或英文 | "张三"              | 真实姓名                       |
    | agreementAccepted | body | Boolean | 是   | 必须为true           | true                | 是否同意用户协议和隐私政策     |

    表 3.4.4.4.3-2 PUB-02请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义               |
    | ----------------- | ------ | ---- | --------------------------- | ---------------------- |
    | code              | Number | 是   | 0                           | 响应码                 |
    | message           | String | 是   | "注册成功"                  | 响应消息               |
    | data.userId       | Number | 是   | 1001                        | 用户ID                 |
    | data.tenantCode   | String | 是   | "company001"                | 关联的租户编码         |
    | data.tenantName   | String | 是   | "示例企业"                  | 关联的租户名称         |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌（注册即登录） |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌               |
    | data.expiresIn    | Number | 是   | 7200                        | 令牌过期时间（秒）     |

    表 3.4.4.4.3-3 PUB-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "email": "zhang@company.com",
          "verifyCode": "123456",
          "password": "P@ssw0rd123",
          "realName": "张三",
          "agreementAccepted": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "注册成功",
          "data": {
            "userId": 1001,
            "tenantCode": "company001",
            "tenantName": "示例企业",
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（邮箱域名不匹配）

        ```json
        {
          "code": 422106,
          "message": "该邮箱域名未配置开放注册",
          "data": {
            "emailDomain": "unknown.com",
            "suggestion": "请联系企业管理员开通开放注册功能"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   tenantCode参数：用户输入登录时使用的租户编码，后端接收后通过BC-11查询解析为tenant_id，用于数据源路由
    -   邮箱域名必须匹配某个租户的emailDomains配置
    -   用户来源自动标记为SELF_REGISTERED
    -   自动分配租户配置的默认角色（defaultRoleCode）
    -   agreementAccepted必须为true，否则拒绝注册

+   **契约概述表**

    | 属性       | 值                                                                          |
    | ---------- | --------------------------------------------------------------------------- |
    | API编号    | PUB-03                                                                      |
    | 接口路径   | POST /api/v1/public/iam/activate                                            |
    | 功能简述   | 通过激活验证码激活账号并设置密码，激活后状态从PENDING变为ACTIVE             |
    | 所需权限   | 无                                                                          |
    | 关联功能   | F-ACT-01 账号激活                                                           |
    | 关联用例   | UC-ACT-01 用户通过激活验证码激活账号                                        |
    | 关联领域   | UserActivationService.activateByCode()                                      |
    | 关联规则   | CAP-R-01（60秒间隔）, CAP-R-02（15分钟有效期）, PU-R-04/TU-R-05（密码策略） |
    | 幂等性     | 否（验证码一次性使用）                                                      |
    | 关联错误码 | E-400001, E-400004, E-400012, E-400013                                      |

    表 3.4.4.4.4-1 PUB-03契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                   | 示例值         | 业务含义               |
    | ---------- | ---- | ------ | ---- | ---------------------- | -------------- | ---------------------- |
    | target     | body | String | 是   | 手机号或邮箱格式       | "zhang@co.com" | 接收验证码的手机或邮箱 |
    | code       | body | String | 是   | 6位数字                | "382916"       | 激活验证码             |
    | password   | body | String | 是   | 符合对应用户群密码策略 | "P@ssw0rd123"  | 设置的密码             |
    | userPool   | body | String | 是   | 枚举：UP/UR            | "UR"           | 用户群类型             |
    | tenantCode | body | String | 否   | 3-32字符，UR时必填     | "acme"         | 租户编码               |

    表 3.4.4.4.4-2 PUB-03请求契约表

+   **响应契约表**

    | 参数名        | 类型    | 必有 | 示例值                            | 业务含义      |
    | ------------- | ------- | ---- | --------------------------------- | ------------- |
    | code          | Number  | 是   | 0                                 | 响应码        |
    | message       | String  | 是   | "激活成功"                        | 响应消息      |
    | data.success  | Boolean | 是   | true                              | 是否成功      |
    | data.userId   | Number  | 是   | 1001                              | 用户ID        |
    | data.userPool | String  | 是   | "UR"                              | 用户群：UP/UR |
    | data.loginUrl | String  | 是   | "<https://app.example.com/login>" | 登录页面URL   |

    表 3.4.4.4.4-3 PUB-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "target": "zhang@company.com",
          "code": "382916",
          "password": "P@ssw0rd123",
          "userPool": "UR",
          "tenantCode": "acme"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "激活成功",
          "data": {
            "success": true,
            "userId": 1001,
            "userPool": "UR",
            "loginUrl": "https://app.example.com/tenant/login"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（验证码已过期）

        ```json
        {
          "code": 400012,
          "message": "激活验证码已过期或无效",
          "data": {
            "suggestion": "请联系管理员重新发送激活验证码"
          },
          "timestamp": 1737885600000
        }
        ```

##### 3.4.4.4.5 PUB-04 忘记密码

+   **契约概述表**

    | 属性       | 值                                                                  |
    | ---------- | ------------------------------------------------------------------- |
    | API编号    | PUB-04                                                              |
    | 接口路径   | POST /api/v1/public/iam/password/forgot                             |
    | 功能简述   | 用户忘记密码时发起重置请求，系统向用户绑定的手机/邮箱发送重置验证码 |
    | 所需权限   | 无                                                                  |
    | 关联功能   | F-PWD-01 忘记密码                                                   |
    | 关联用例   | UC-PWD-01 用户发起密码重置请求                                      |
    | 关联领域   | CaptchaService.send()                                               |
    | 关联规则   | CAP-R-01（60秒间隔）, CAP-R-02（15分钟有效期）                      |
    | 幂等性     | 是（重复请求发送新验证码，旧验证码失效）                            |
    | 关联错误码 | E-400001, E-400036, E-404001, E-422106                              |

    表 3.4.4.4.5-1 PUB-04契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束               | 示例值         | 业务含义                       |
    | ---------- | ---- | ------ | ---- | ------------------ | -------------- | ------------------------------ |
    | account    | body | String | 是   | 用户名/手机号/邮箱 | "zhang@co.com" | 账号标识                       |
    | userPool   | body | String | 是   | 枚举：UP/UR/UC     | "UR"           | 用户群类型                     |
    | tenantCode | body | String | 否   | 3-32字符，UR时必填 | "acme"         | 租户编码                       |
    | captchaId  | body | String | 否   | 图形验证码ID       | "cap_xxx"      | 图形验证码ID（多次失败后必填） |
    | captcha    | body | String | 否   | 4-6位字符          | "ab3d"         | 图形验证码（多次失败后必填）   |

    表 3.4.4.4.5-2 PUB-04请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                | 业务含义           |
    | ----------------- | ------- | ---- | --------------------- | ------------------ |
    | code              | Number  | 是   | 0                     | 响应码             |
    | message           | String  | 是   | "重置验证码已发送"    | 响应消息           |
    | data.success      | Boolean | 是   | true                  | 是否成功           |
    | data.maskedTarget | String  | 是   | "zha****@company.com" | 脱敏后的接收目标   |
    | data.expiresIn    | Number  | 是   | 900                   | 验证码有效期（秒） |

    表 3.4.4.4.5-3 PUB-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "account": "zhang@company.com",
          "userPool": "UR",
          "tenantCode": "company001"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "重置验证码已发送",
          "data": {
            "success": true,
            "maskedTarget": "zha****@company.com",
            "expiresIn": 900
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（同步用户）

        ```json
        {
          "code": 422106,
          "message": "同步用户不支持自助重置密码",
          "data": {
            "sourceType": "SYNCED",
            "suggestion": "请联系企业管理员或通过企业身份系统重置密码"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   SSO/同步用户（sourceType=SYNCED）返回提示"请联系企业管理员"
    -   重置验证码有效期：UP=15分钟，UR=15分钟，UC=15分钟
    -   多次请求失败后需要图形验证码防刷

##### 3.4.4.4.6 PUB-05 重置密码

+   **契约概述表**

    | 属性       | 值                                         |
    | ---------- | ------------------------------------------ |
    | API编号    | PUB-05                                     |
    | 接口路径   | POST /api/v1/public/iam/password/reset     |
    | 功能简述   | 通过重置验证码设置新密码，验证码一次性使用 |
    | 所需权限   | 无                                         |
    | 关联功能   | F-PWD-02 重置密码                          |
    | 关联用例   | UC-PWD-02 用户通过重置验证码设置新密码     |
    | 关联领域   | User.resetPasswordByCode()                 |
    | 关联规则   | PU-R-04/TU-R-05/CU-R-04（密码策略）        |
    | 幂等性     | 否（验证码一次性使用）                     |
    | 关联错误码 | E-400001, E-400023, E-400024, E-422104     |

    表 3.4.4.4.6-1 PUB-05契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型    | 必填 | 约束               | 示例值           | 业务含义               |
    | ------------ | ---- | ------- | ---- | ------------------ | ---------------- | ---------------------- |
    | target       | body | String  | 是   | 手机号或邮箱格式   | "zhang@co.com"   | 接收验证码的手机或邮箱 |
    | code         | body | String  | 是   | 6位数字            | "382916"         | 重置验证码             |
    | newPassword  | body | String  | 是   | 符合用户群密码策略 | "NewP@ssw0rd123" | 新密码                 |
    | userPool     | body | String  | 是   | 枚举：UP/UR/UC     | "UR"             | 用户群类型             |
    | tenantCode   | body | String  | 否   | 3-32字符，UR时必填 | "acme"           | 租户编码               |
    | logoutOthers | body | Boolean | 否   | 默认true           | true             | 是否强制其他设备下线   |

    表 3.4.4.4.6-2 PUB-05请求契约表

+   **响应契约表**

    | 参数名         | 类型    | 必有 | 示例值                     | 业务含义         |
    | -------------- | ------- | ---- | -------------------------- | ---------------- |
    | code           | Number  | 是   | 0                          | 响应码           |
    | message        | String  | 是   | "密码重置成功"             | 响应消息         |
    | data.success   | Boolean | 是   | true                       | 是否成功         |
    | data.userPool  | String  | 是   | "UR"                       | 用户群类型       |
    | data.loginUrl  | String  | 是   | "https://app.ex.com/login" | 登录页面URL      |
    | data.loggedOut | Number  | 否   | 3                          | 已下线的设备数量 |

    表 3.4.4.4.6-3 PUB-05响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "target": "zhang@company.com",
          "code": "382916",
          "newPassword": "NewP@ssw0rd123",
          "userPool": "UR",
          "tenantCode": "company001",
          "logoutOthers": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "密码重置成功",
          "data": {
            "success": true,
            "userPool": "UR",
            "loginUrl": "https://app.example.com/tenant/company001/login",
            "loggedOut": 3
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（验证码已过期）

        ```json
        {
          "code": 422104,
          "message": "重置验证码已过期或无效",
          "data": {
            "suggestion": "请重新发起忘记密码请求"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   验证码有效期15分钟，使用后立即失效
    -   验证码只能使用一次
    -   密码需符合对应用户群的密码策略
    -   logoutOthers=true时强制其他设备下线

##### 3.4.4.4.7 PUB-06 发送验证码

+   **契约概述表**

    | 属性       | 值                                                                |
    | ---------- | ----------------------------------------------------------------- |
    | API编号    | PUB-06                                                            |
    | 接口路径   | POST /api/v1/public/iam/captcha/send                              |
    | 功能简述   | 发送短信或邮箱验证码，用于注册、激活、重置密码、绑定、登录等场景  |
    | 所需权限   | 无                                                                |
    | 关联功能   | F-CAP-01 发送验证码                                               |
    | 关联用例   | UC-CAP-01 用户获取验证码                                          |
    | 关联领域   | CaptchaService.send()                                             |
    | 关联规则   | CAP-R-01（60秒间隔）, CAP-R-02（5分钟有效）, CAP-R-03（每日上限） |
    | 幂等性     | 否（每次发送新验证码）                                            |
    | 关联错误码 | E-400001, E-400021, E-400022, E-429004                            |

    表 3.4.4.4.7-1 PUB-06契约概述表

+   **请求契约表**

    | 参数名    | 位置 | 类型   | 必填 | 约束                                     | 示例值        | 业务含义           |
    | --------- | ---- | ------ | ---- | ---------------------------------------- | ------------- | ------------------ |
    | target    | body | String | 是   | 手机号或邮箱格式                         | "13800138000" | 目标（手机或邮箱） |
    | type      | body | String | 是   | 枚举：SMS/EMAIL                          | "SMS"         | 发送类型           |
    | scene     | body | String | 是   | 枚举：REGISTER/ACTIVATE/RESET/BIND/LOGIN | "REGISTER"    | 使用场景           |
    | captchaId | body | String | 否   | 图形验证码ID                             | "cap_xxx"     | 图形验证码ID       |
    | captcha   | body | String | 否   | 4-6位字符                                | "ab3d"        | 图形验证码         |

    表 3.4.4.4.7-2 PUB-06请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值         | 业务含义                   |
    | ----------------- | ------- | ---- | -------------- | -------------------------- |
    | code              | Number  | 是   | 0              | 响应码                     |
    | message           | String  | 是   | "验证码已发送" | 响应消息                   |
    | data.success      | Boolean | 是   | true           | 是否成功                   |
    | data.expiresIn    | Number  | 是   | 300            | 验证码有效期（秒）         |
    | data.retryAfter   | Number  | 是   | 60             | 可重新发送的等待时间（秒） |
    | data.maskedTarget | String  | 是   | "138****8000"  | 脱敏后的目标               |

    表 3.4.4.4.7-3 PUB-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "target": "13800138000",
          "type": "SMS",
          "scene": "REGISTER"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "验证码已发送",
          "data": {
            "success": true,
            "expiresIn": 300,
            "retryAfter": 60,
            "maskedTarget": "138****8000"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（发送频率限制）

        ```json
        {
          "code": 429004,
          "message": "验证码发送过于频繁，请稍后再试",
          "data": {
            "retryAfter": 45,
            "dailyRemaining": 8
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同一目标60秒内不可重复发送
    -   验证码有效期5分钟
    -   每日同一目标最多发送10次
    -   多次请求后可能需要图形验证码防刷

##### 3.4.4.4.8 PUB-07 申请企业试用

+   **契约概述表**

    | 属性       | 值                                                         |
    | ---------- | ---------------------------------------------------------- |
    | API编号    | PUB-07                                                     |
    | 接口路径   | POST /api/v1/public/iam/trial/apply                        |
    | 功能简述   | 企业申请试用，系统根据配置自动审核或人工审核后创建试用租户 |
    | 所需权限   | 无                                                         |
    | 关联功能   | F-TRL-01 申请企业试用                                      |
    | 关联用例   | UC-TRL-01 企业用户申请试用                                 |
    | 关联领域   | TrialApplicationService.apply()                            |
    | 关联规则   | TRL-R-01（企业名称唯一）, TRL-R-02（联系方式校验）         |
    | 幂等性     | 否（每次创建新申请单）                                     |
    | 关联错误码 | E-400001, E-400021, E-400022, E-401018, E-409010           |

    表 3.4.4.4.8-1 PUB-07契约概述表

+   **请求契约表**

    | 参数名        | 位置 | 类型   | 必填 | 约束       | 示例值              | 业务含义   |
    | ------------- | ---- | ------ | ---- | ---------- | ------------------- | ---------- |
    | companyName   | body | String | 是   | 2-100字符  | "示例科技有限公司"  | 企业名称   |
    | contactName   | body | String | 是   | 2-32字符   | "张三"              | 联系人姓名 |
    | contactMobile | body | String | 是   | 11位手机号 | "13800138000"       | 联系人手机 |
    | contactEmail  | body | String | 是   | 邮箱格式   | "zhang@example.com" | 联系人邮箱 |
    | verifyCode    | body | String | 是   | 6位数字    | "123456"            | 手机验证码 |
    | industry      | body | String | 否   | 行业枚举   | "TECHNOLOGY"        | 所属行业   |
    | scale         | body | String | 否   | 规模枚举   | "50_200"            | 企业规模   |
    | remark        | body | String | 否   | 长度≤500   | "希望试用..."       | 备注说明   |

    表 3.4.4.4.8-2 PUB-07请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                               | 业务含义               |
    | ------------------ | ------ | ---- | ------------------------------------ | ---------------------- |
    | code               | Number | 是   | 0                                    | 响应码                 |
    | message            | String | 是   | "申请已提交"                         | 响应消息               |
    | data.applicationId | String | 是   | "app-550e8400-e29b-41d4-a716-446655" | 申请单ID               |
    | data.status        | String | 是   | "PENDING"                            | 状态：PENDING/APPROVED |
    | data.statusText    | String | 是   | "待审核"                             | 状态显示文本           |
    | data.expectedReply | String | 否   | "预计1个工作日内回复"                | 预计回复时间说明       |

    表 3.4.4.4.8-3 PUB-07响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "companyName": "示例科技有限公司",
          "contactName": "张三",
          "contactMobile": "13800138000",
          "contactEmail": "zhang@example.com",
          "verifyCode": "123456",
          "industry": "TECHNOLOGY",
          "scale": "50_200",
          "remark": "希望试用企业版功能"
        }
        ```

    +   成功响应Mock（待审核）

        ```json
        {
          "code": 200,
          "message": "申请已提交",
          "data": {
            "applicationId": "app-550e8400-e29b-41d4-a716-446655440000",
            "status": "PENDING",
            "statusText": "待审核",
            "expectedReply": "预计1个工作日内回复"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（自动审核通过）

        ```json
        {
          "code": 200,
          "message": "申请已通过",
          "data": {
            "applicationId": "app-550e8400-e29b-41d4-a716-446655440000",
            "status": "APPROVED",
            "statusText": "已通过",
            "tenantCode": "trial_example001",
            "activationUrl": "https://app.example.com/activate?token=xxx"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   系统可配置自动审核或人工审核模式
    -   自动审核模式下立即创建试用租户并发送激活验证码
    -   人工审核模式下进入PENDING状态等待审批
    -   试用期默认30天，可在租户配置中调整

##### 3.4.4.4.9 PUB-08 获取OAuth授权URL

+   **契约概述表**

    | 属性       | 值                                                     |
    | ---------- | ------------------------------------------------------ |
    | API编号    | PUB-08                                                 |
    | 接口路径   | GET /api/v1/public/iam/oauth/{provider}/url            |
    | 功能简述   | 获取三方平台授权跳转URL，用于前端跳转至三方授权页面    |
    | 所需权限   | 无                                                     |
    | 关联功能   | F-OAU-01 三方登录/绑定                                 |
    | 关联用例   | UC-OAU-01 用户发起三方授权                             |
    | 关联领域   | OAuthService.generateAuthUrl()                         |
    | 关联规则   | OAU-R-01（state防CSRF）, OAU-R-02（state有效期10分钟） |
    | 幂等性     | 否（每次生成新的state）                                |
    | 关联错误码 | E-400001, E-400032                                     |

    表 3.4.4.4.9-1 PUB-08契约概述表

+   **请求契约表**

    | 参数名      | 位置  | 类型   | 必填 | 约束                     | 示例值              | 业务含义              |
    | ----------- | ----- | ------ | ---- | ------------------------ | ------------------- | --------------------- |
    | provider    | path  | String | 是   | 枚举：qq/wechat/dingtalk | "wechat"            | 三方平台标识          |
    | redirectUri | query | String | 否   | URL格式，需在白名单内    | "https://app.ex/cb" | 自定义回调地址        |
    | scene       | query | String | 否   | 枚举：LOGIN/BIND         | "LOGIN"             | 授权场景（登录/绑定） |

    表 3.4.4.4.9-2 PUB-08请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                           | 业务含义           |
    | -------------- | ------ | ---- | -------------------------------- | ------------------ |
    | code           | Number | 是   | 0                                | 响应码             |
    | message        | String | 是   | "success"                        | 响应消息           |
    | data.authUrl   | String | 是   | "https://open.weixin.qq.com/..." | 授权跳转URL        |
    | data.state     | String | 是   | "st_abc123def456"                | 状态码（防CSRF）   |
    | data.expiresIn | Number | 是   | 600                              | 状态码有效期（秒） |
    | data.provider  | String | 是   | "wechat"                         | 三方平台标识       |

    表 3.4.4.4.9-3 PUB-08响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "authUrl": "https://open.weixin.qq.com/connect/qrconnect?appid=wx123&redirect_uri=https%3A%2F%2Fapp.example.com%2Foauth%2Fwechat%2Fcallback&response_type=code&scope=snsapi_login&state=st_abc123def456",
            "state": "st_abc123def456",
            "expiresIn": 600,
            "provider": "wechat"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（无效平台）

        ```json
        {
          "code": 400032,
          "message": "无效的社交平台",
          "data": {
            "provider": "facebook",
            "supportedProviders": ["qq", "wechat", "dingtalk"]
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   state参数由服务端生成并存入Redis，有效期10分钟
    -   回调时需验证state一致性，防止CSRF攻击
    -   redirectUri若提供需在租户白名单内

##### 3.4.4.4.10 PUB-09 三方授权回调

+   **契约概述表**

    | 属性       | 值                                                               |
    | ---------- | ---------------------------------------------------------------- |
    | API编号    | PUB-09                                                           |
    | 接口路径   | POST /api/v1/public/iam/oauth/{provider}/callback                |
    | 功能简述   | 处理三方平台授权回调，已绑定用户直接登录，未绑定则自动创建并登录 |
    | 所需权限   | 无                                                               |
    | 关联功能   | F-OAU-02 三方授权回调处理                                        |
    | 关联用例   | UC-OAU-02 系统处理三方授权回调                                   |
    | 关联领域   | OAuthService.handleCallback() + ConsumerUser.createByOAuth()     |
    | 关联规则   | CU-R-05（三方账号唯一绑定）, OB-R-03（优先unionId匹配）          |
    | 幂等性     | 是（同一授权码多次调用返回相同结果）                             |
    | 关联错误码 | E-400001, E-400032, E-401010, E-401014                           |

    表 3.4.4.4.10-1 PUB-09契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                     | 示例值            | 业务含义         |
    | -------- | ---- | ------ | ---- | ------------------------ | ----------------- | ---------------- |
    | provider | path | String | 是   | 枚举：qq/wechat/dingtalk | "wechat"          | 三方平台标识     |
    | code     | body | String | 是   | 三方平台返回的授权码     | "oauth_code_xxx"  | 授权码           |
    | state    | body | String | 是   | 与PUB-08返回的state一致  | "st_abc123def456" | 状态码（防CSRF） |

    表 3.4.4.4.10-2 PUB-09请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                         | 业务含义           |
    | ----------------- | ------- | ---- | ------------------------------ | ------------------ |
    | code              | Number  | 是   | 0                              | 响应码             |
    | message           | String  | 是   | "登录成功"                     | 响应消息           |
    | data.isNewUser    | Boolean | 是   | false                          | 是否新创建的用户   |
    | data.userId       | Number  | 是   | 1001                           | 用户ID             |
    | data.nickname     | String  | 否   | "微信昵称"                     | 用户昵称           |
    | data.avatar       | String  | 否   | "https://thirdwx.qlogo.cn/xxx" | 用户头像           |
    | data.accessToken  | String  | 是   | "eyJhbGciOiJSUzI1NiIs..."      | 访问令牌           |
    | data.refreshToken | String  | 是   | "dGhpcyBpcyBhIHJlZnJlc2..."    | 刷新令牌           |
    | data.expiresIn    | Number  | 是   | 7200                           | 令牌过期时间（秒） |

    表 3.4.4.4.10-3 PUB-09响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "code": "oauth_code_from_wechat",
          "state": "st_abc123def456"
        }
        ```

    +   成功响应Mock（已有用户）

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "isNewUser": false,
            "userId": 1001,
            "nickname": "小明",
            "avatar": "https://cdn.example.com/avatar.jpg",
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（新用户自动创建）

        ```json
        {
          "code": 200,
          "message": "注册并登录成功",
          "data": {
            "isNewUser": true,
            "userId": 1001,
            "nickname": "微信昵称",
            "avatar": "https://thirdwx.qlogo.cn/xxx",
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（state验证失败）

        ```json
        {
          "code": 401014,
          "message": "授权状态验证失败，请重新发起授权",
          "data": {
            "reason": "STATE_MISMATCH",
            "suggestion": "请返回登录页重新点击社交登录"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   根据unionId（优先）或openId查找是否已有绑定用户
    -   已绑定用户直接签发Token完成登录
    -   未绑定用户自动调用ConsumerUser.createByOAuth()创建并绑定
    -   新用户昵称和头像从三方平台获取

#### 3.4.5.1 API-功能-用例关联表

+   全部REST API与RPC接口的功能-用例追溯关系如下表所示。

    | API编号    | API名称                   | 关联功能编号 | 关联功能      | 关联用例编号 | 用例说明                   |
    | ---------- | ------------------------- | ------------ | ------------- | ------------ | -------------------------- |
    | P-USR-01   | 创建平台用户              | F-USR-01     | 用户创建      | UC-USR-01    | 管理员创建平台用户         |
    | P-USR-02   | 查询平台用户列表          | F-USR-02     | 用户查询      | UC-USR-02    | 管理员查询平台用户列表     |
    | P-USR-03   | 查询平台用户详情          | F-USR-03     | 用户详情      | UC-USR-03    | 管理员查看平台用户详情     |
    | P-USR-04   | 更新平台用户信息          | F-USR-04     | 用户编辑      | UC-USR-04    | 管理员更新平台用户信息     |
    | P-USR-05   | 删除平台用户              | F-USR-05     | 用户删除      | UC-USR-05    | 管理员删除平台用户         |
    | P-USR-06   | 禁用平台用户              | F-USR-06     | 用户禁用      | UC-USR-06    | 管理员禁用平台用户         |
    | P-USR-07   | 启用平台用户              | F-USR-07     | 用户启用      | UC-USR-07    | 管理员启用平台用户         |
    | P-USR-08   | 管理员协助重置密码        | F-USR-08     | 密码重置      | UC-USR-08    | 管理员协助用户重置密码     |
    | P-USR-09   | 重发激活验证码            | F-USR-09     | 重发激活      | UC-USR-09    | 管理员重发激活验证码       |
    | UR-USR-01  | 创建租户用户              | F-USR-10     | 租户用户创建  | UC-USR-10    | 租户管理员创建用户         |
    | UR-USR-02  | 查询租户用户列表          | F-USR-11     | 租户用户查询  | UC-USR-11    | 租户管理员查询用户列表     |
    | UR-USR-03  | 查询租户用户详情          | F-USR-12     | 租户用户详情  | UC-USR-12    | 租户管理员查看用户详情     |
    | UR-USR-04  | 更新租户用户信息          | F-USR-13     | 租户用户编辑  | UC-USR-13    | 租户管理员更新用户信息     |
    | UR-USR-05  | 删除租户用户              | F-USR-14     | 租户用户删除  | UC-USR-14    | 租户管理员删除用户         |
    | UR-USR-06  | 禁用租户用户              | F-USR-15     | 租户用户禁用  | UC-USR-15    | 租户管理员禁用用户         |
    | UR-USR-07  | 启用租户用户              | F-USR-07     | 用户启用      | UC-USR-07    | 租户管理员启用用户         |
    | UR-USR-08  | 管理员协助重置密码        | F-USR-08     | 密码重置      | UC-USR-08    | 租户管理员协助用户重置密码 |
    | UR-USR-09  | 重发激活验证码            | F-USR-16     | 重发激活      | UC-USR-16    | 租户管理员重发激活验证码   |
    | UR-USR-10  | 分配组织岗位              | F-USR-17     | 组织岗位分配  | UC-USR-17    | 管理员分配用户组织岗位     |
    | UR-USR-11  | 获取当前用户信息          | F-USR-18     | 个人信息查询  | UC-USR-18    | 租户用户查看个人信息       |
    | UR-USR-12  | 更新当前用户信息          | F-USR-19     | 个人信息编辑  | UC-USR-19    | 租户用户编辑个人信息       |
    | UR-USR-13  | 用户自助注销              | F-USR-20     | 用户注销      | UC-USR-20    | 开放注册用户注销账号       |
    | UC-USR-01  | 获取当前用户信息          | F-USR-21     | 个人信息查询  | UC-USR-21    | C端用户查看个人信息        |
    | UC-USR-02  | 更新当前用户信息          | F-USR-22     | 个人信息编辑  | UC-USR-22    | C端用户编辑个人信息        |
    | UC-USR-03  | 申请注销                  | F-USR-23     | C端用户注销   | UC-USR-23    | C端用户申请注销账号        |
    | UC-USR-04  | 撤销注销                  | F-USR-24     | 注销撤销      | UC-USR-24    | C端用户撤销注销申请        |
    | UC-USR-05  | 获取三方绑定列表          | F-USR-25     | 三方账号查询  | UC-USR-25    | C端用户查看三方绑定        |
    | UC-USR-06  | 绑定三方账号              | F-USR-26     | 三方账号绑定  | UC-USR-26    | C端用户绑定三方账号        |
    | UC-USR-07  | 解绑三方账号              | F-USR-27     | 三方账号解绑  | UC-USR-27    | C端用户解绑三方账号        |
    | UC-USR-08  | 设置/修改密码             | F-USR-28     | 密码管理      | UC-USR-28    | C端用户设置或修改密码      |
    | PUB-01     | 个人用户注册              | F-REG-01     | C端用户注册   | UC-REG-01    | C端用户手机/邮箱注册       |
    | PUB-02     | 租户用户开放注册          | F-REG-02     | 开放注册      | UC-REG-02    | 员工使用企业邮箱自助注册   |
    | PUB-03     | 激活账号                  | F-ACT-01     | 账号激活      | UC-ACT-01    | 用户通过激活验证码激活账号 |
    | PUB-04     | 忘记密码                  | F-PWD-01     | 忘记密码      | UC-PWD-01    | 用户申请密码重置验证码     |
    | PUB-05     | 重置密码                  | F-PWD-02     | 密码重置      | UC-PWD-02    | 用户通过验证码重置密码     |
    | PUB-06     | 发送验证码                | F-CAP-01     | 验证码发送    | UC-CAP-01    | 用户获取短信/邮箱验证码    |
    | PUB-07     | 申请企业试用              | F-TRI-01     | 企业试用申请  | UC-TRI-01    | 企业申请试用租户           |
    | PUB-08     | 获取OAuth授权URL          | F-OAU-01     | 三方授权      | UC-OAU-01    | 获取三方登录授权链接       |
    | PUB-09     | 三方授权回调              | F-OAU-02     | 三方登录回调  | UC-OAU-02    | 用户通过三方账号登录/注册  |
    | RPC-USR-01 | 查询用户MFA状态           | F-RPC-01     | MFA状态查询   | UC-AUTH-01   | 登录流程MFA判断            |
    | RPC-USR-02 | 获取用户Token签发基本信息 | F-RPC-02     | Token信息查询 | UC-AUTH-02   | Token签发获取用户信息      |

    表 3.4.5.1-1 用户管理API-功能-用例关联表

#### 3.4.5.2 API-领域-权限关联表

+   全部REST API与RPC接口的领域-权限追溯关系如下表所示。

    | API编号    | API名称                   | 关联聚合     | 领域方法                                    | 权限标识                 | 权限说明           |
    | ---------- | ------------------------- | ------------ | ------------------------------------------- | ------------------------ | ------------------ |
    | P-USR-01   | 创建平台用户              | PlatformUser | create()                                    | provider:iam:user:create | 创建用户权限       |
    | P-USR-02   | 查询平台用户列表          | -            | PlatformUserQueryService.getList()          | provider:iam:user:list   | 查询用户权限       |
    | P-USR-03   | 查询平台用户详情          | -            | PlatformUserQueryService.getDetail()        | provider:iam:user:read   | 查看用户权限       |
    | P-USR-04   | 更新平台用户信息          | PlatformUser | updateContactInfo()                         | provider:iam:user:update | 更新用户权限       |
    | P-USR-05   | 删除平台用户              | PlatformUser | delete()                                    | provider:iam:user:delete | 删除用户权限       |
    | P-USR-06   | 禁用平台用户              | PlatformUser | disable()                                   | provider:iam:user:update | 更新用户权限       |
    | P-USR-07   | 启用平台用户              | PlatformUser | enable()                                    | provider:iam:user:update | 更新用户权限       |
    | P-USR-08   | 管理员协助重置密码        | PlatformUser | resetPassword()                             | provider:iam:user:update | 更新用户权限       |
    | P-USR-09   | 重发激活验证码            | -            | UserActivationService.resendActivation()    | provider:iam:user:update | 更新用户权限       |
    | UR-USR-01  | 创建租户用户              | TenantUser   | createByAdmin()                             | ur:iam:user:create       | 创建用户权限       |
    | UR-USR-02  | 查询租户用户列表          | -            | TenantUserQueryService.getList()            | ur:iam:user:list         | 查询用户权限       |
    | UR-USR-03  | 查询租户用户详情          | -            | TenantUserQueryService.getDetail()          | ur:iam:user:read         | 查看用户权限       |
    | UR-USR-04  | 更新租户用户信息          | TenantUser   | updateContactInfo()                         | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-05  | 删除租户用户              | TenantUser   | delete()                                    | ur:iam:user:delete       | 删除用户权限       |
    | UR-USR-06  | 禁用租户用户              | TenantUser   | disable()                                   | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-07  | 启用租户用户              | TenantUser   | enable()                                    | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-08  | 管理员协助重置密码        | TenantUser   | resetPassword()                             | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-09  | 重发激活验证码            | -            | UserActivationService.resendActivation()    | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-10  | 分配组织岗位              | TenantUser   | assignToOrg()                               | ur:iam:user:update       | 更新用户权限       |
    | UR-USR-11  | 获取当前用户信息          | -            | TenantUserQueryService.getMe()              | authenticated            | 登录即可           |
    | UR-USR-12  | 更新当前用户信息          | TenantUser   | updateProfile()                             | authenticated            | 登录即可           |
    | UR-USR-13  | 用户自助注销              | TenantUser   | cancel()                                    | authenticated            | 仅自注册用户可用   |
    | UC-USR-01  | 获取当前用户信息          | -            | ConsumerUserQueryService.getMe()            | authenticated            | 登录即可           |
    | UC-USR-02  | 更新当前用户信息          | ConsumerUser | updateProfile()                             | authenticated            | 登录即可           |
    | UC-USR-03  | 申请注销                  | ConsumerUser | requestCancel()                             | authenticated            | 进入7天冷静期      |
    | UC-USR-04  | 撤销注销                  | ConsumerUser | revokeCancel()                              | authenticated            | 冷静期内可撤       |
    | UC-USR-05  | 获取三方绑定列表          | -            | ConsumerUserQueryService.getOAuthBindings() | authenticated            | 登录即可           |
    | UC-USR-06  | 绑定三方账号              | ConsumerUser | bindOAuth()                                 | authenticated            | 登录即可           |
    | UC-USR-07  | 解绑三方账号              | ConsumerUser | unbindOAuth()                               | authenticated            | 需保留一种登录方式 |
    | UC-USR-08  | 设置/修改密码             | ConsumerUser | setPassword() / changePassword()            | authenticated            | 登录即可           |
    | PUB-01     | 个人用户注册              | ConsumerUser | createByMobile/Email()                      | 无                       | 公开接口           |
    | PUB-02     | 租户用户开放注册          | TenantUser   | createByRegistration()                      | 无                       | 邮箱域需匹配租户   |
    | PUB-03     | 激活账号                  | -            | UserActivationService.activateByCode()      | 无                       | 验证码验证         |
    | PUB-04     | 忘记密码                  | -            | CaptchaService.send()                       | 无                       | 频率限制           |
    | PUB-05     | 重置密码                  | -            | User.resetPasswordByCode()                  | 无                       | 验证码一次性       |
    | PUB-06     | 发送验证码                | -            | CaptchaService.send()                       | 无                       | 频率限制           |
    | PUB-07     | 申请企业试用              | -            | TrialApplicationService.apply()             | 无                       | 可配自动审核       |
    | PUB-08     | 获取OAuth授权URL          | -            | OAuthService.generateAuthUrl()              | 无                       | state防CSRF        |
    | PUB-09     | 三方授权回调              | ConsumerUser | createByOAuth()                             | 无                       | 自动创建用户       |
    | RPC-USR-01 | 查询用户MFA状态           | -            | UserQueryService.getUserMfaStatus()         | internal                 | 内部RPC            |
    | RPC-USR-02 | 获取用户Token签发基本信息 | -            | UserQueryService.getUserBasicInfoForToken() | internal                 | 内部RPC            |

    表 3.4.5.2-1 API-领域-权限关联表

+   权限标识说明：
    -   `无`：公开接口，无需登录
    -   `authenticated`：需要登录，但无需特定权限
    -   `internal`：内部RPC接口，通过服务间认证
    -   `{四段式权限}`：需要登录且拥有对应权限

#### 3.4.5.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。RPC接口无前端页面，不在此表中。

    | API编号   | API名称            | 关联页面编号 | 页面名称       | 触发组件       | 触发时机      |
    | --------- | ------------------ | ------------ | -------------- | -------------- | ------------- |
    | P-USR-01  | 创建平台用户       | PG-P-USR-02  | 用户创建页     | 提交按钮       | 点击提交      |
    | P-USR-02  | 查询平台用户列表   | PG-P-USR-01  | 用户管理列表页 | 搜索按钮       | 页面加载/搜索 |
    | P-USR-03  | 查询平台用户详情   | PG-P-USR-03  | 用户详情页     | -              | 页面加载      |
    | P-USR-04  | 更新平台用户信息   | PG-P-USR-03  | 用户详情页     | 编辑按钮       | 点击保存      |
    | P-USR-05  | 删除平台用户       | PG-P-USR-01  | 用户管理列表页 | 删除按钮       | 点击确认      |
    | P-USR-06  | 禁用平台用户       | PG-P-USR-01  | 用户管理列表页 | 禁用按钮       | 点击确认      |
    | P-USR-07  | 启用平台用户       | PG-P-USR-01  | 用户管理列表页 | 启用按钮       | 点击确认      |
    | P-USR-08  | 管理员协助重置密码 | PG-P-USR-03  | 用户详情页     | 重置密码       | 点击确认      |
    | P-USR-09  | 重发激活验证码     | PG-P-USR-01  | 用户管理列表页 | 重发激活       | 点击确认      |
    | UR-USR-01 | 创建租户用户       | PG-UR-USR-02 | 用户创建页     | 提交按钮       | 点击提交      |
    | UR-USR-02 | 查询租户用户列表   | PG-UR-USR-01 | 用户管理列表页 | 搜索按钮       | 页面加载/搜索 |
    | UR-USR-03 | 查询租户用户详情   | PG-UR-USR-03 | 用户详情页     | -              | 页面加载      |
    | UR-USR-04 | 更新租户用户信息   | PG-UR-USR-03 | 用户详情页     | 编辑按钮       | 点击保存      |
    | UR-USR-05 | 删除租户用户       | PG-UR-USR-01 | 用户管理列表页 | 删除按钮       | 点击确认      |
    | UR-USR-06 | 禁用租户用户       | PG-UR-USR-01 | 用户管理列表页 | 禁用按钮       | 点击确认      |
    | UR-USR-07 | 启用租户用户       | PG-UR-USR-01 | 用户管理列表页 | 启用按钮       | 点击确认      |
    | UR-USR-08 | 管理员协助重置密码 | PG-UR-USR-03 | 用户详情页     | 重置密码按钮   | 点击确认      |
    | UR-USR-09 | 重发激活验证码     | PG-UR-USR-01 | 用户管理列表页 | 重发激活按钮   | 点击确认      |
    | UR-USR-10 | 分配组织岗位       | PG-UR-USR-03 | 用户详情页     | 保存按钮       | 点击保存      |
    | UR-USR-11 | 获取当前用户信息   | PG-UR-USR-04 | 个人设置页     | -              | 页面加载      |
    | UR-USR-12 | 更新当前用户信息   | PG-UR-USR-04 | 个人设置页     | 保存按钮       | 点击保存      |
    | UR-USR-13 | 用户自助注销       | PG-UR-USR-04 | 个人设置页     | 确认注销按钮   | 点击确认      |
    | UC-USR-01 | 获取当前用户信息   | PG-UC-USR-02 | 个人中心页     | -              | 页面加载      |
    | UC-USR-02 | 更新当前用户信息   | PG-UC-USR-02 | 个人中心页     | 保存按钮       | 点击保存      |
    | UC-USR-03 | 申请注销           | PG-UC-USR-04 | 账号注销页     | 确认按钮       | 点击确认      |
    | UC-USR-04 | 撤销注销           | PG-UC-USR-04 | 账号注销页     | 撤销按钮       | 点击确认      |
    | UC-USR-05 | 获取三方绑定列表   | PG-UC-USR-03 | 账号安全页     | -              | 页面加载      |
    | UC-USR-06 | 绑定三方账号       | PG-UC-USR-03 | 账号安全页     | 绑定按钮       | 点击绑定      |
    | UC-USR-07 | 解绑三方账号       | PG-UC-USR-03 | 账号安全页     | 解绑按钮       | 点击确认      |
    | UC-USR-08 | 设置/修改密码      | PG-UC-USR-03 | 账号安全页     | 提交按钮       | 点击保存      |
    | PUB-01    | 个人用户注册       | PG-UC-USR-01 | 注册页         | 注册按钮       | 点击注册      |
    | PUB-02    | 租户用户开放注册   | PG-PUB-05    | 租户用户注册页 | 注册按钮       | 点击注册      |
    | PUB-03    | 激活账号           | PG-PUB-01    | 激活账号页     | 激活按钮       | 点击激活      |
    | PUB-04    | 忘记密码           | PG-PUB-02    | 忘记密码页     | 提交按钮       | 点击提交      |
    | PUB-05    | 重置密码           | PG-PUB-03    | 重置密码页     | 提交按钮       | 点击提交      |
    | PUB-06    | 发送验证码         | 多个页面     | -              | 获取验证码按钮 | 点击获取      |
    | PUB-07    | 申请企业试用       | PG-PUB-04    | 企业试用申请页 | 提交按钮       | 点击提交      |
    | PUB-08    | 获取OAuth授权URL   | PG-UC-USR-01 | 注册页         | 三方登录图标   | 点击图标      |
    | PUB-09    | 三方授权回调       | -            | -              | -              | 自动触发      |

表 3.4.5.3-1 API-页面-组件关联表

+   说明：
    -   关联页面编号对应3.6节前端设计中的页面编号
    -   PUB-06发送验证码在注册页、忘记密码页等多个页面触发
    -   PUB-09为后端回调处理，无直接关联页面

## 3.5 数据模型设计

+   本节设计用户管理子领域的数据库表结构，按数据库分组。
+   数据模型遵循领域模型设计，每个聚合对应独立的表结构。

### 3.5.1 数据库分布

+   用户管理数据分布在三个数据库：

    | 数据库                   | 存储内容 | 用户群   |
    | ------------------------ | -------- | -------- |
    | clarisphere_platform     | 平台用户 | provider |
    | clarisphere_t{tenant_id} | 租户用户 | ur       |
    | clarisphere_consumer     | 个人用户 | uc       |

    表 3.5.1-1 数据库分布

### 3.5.2 平台库表结构（clarisphere_platform）

#### 3.5.2.1 iam_user 平台用户表

+   平台用户表存储运营方用户信息。

    | 字段名               | 数据类型     | 可空 | 默认值         | 说明                 |
    | -------------------- | ------------ | ---- | -------------- | -------------------- |
    | id                   | BIGINT       | NO   | AUTO_INCREMENT | 主键，用户ID         |
    | username             | VARCHAR(64)  | NO   | -              | 用户名，唯一         |
    | real_name            | VARCHAR(64)  | NO   | -              | 真实姓名             |
    | user_type            | VARCHAR(32)  | NO   | -              | 用户类型             |
    | mobile               | VARCHAR(20)  | YES  | NULL           | 手机号               |
    | mobile_verified      | TINYINT(1)   | NO   | 0              | 手机号是否已验证     |
    | email                | VARCHAR(128) | NO   | -              | 邮箱                 |
    | email_verified       | TINYINT(1)   | NO   | 0              | 邮箱是否已验证       |
    | password_hash        | VARCHAR(128) | YES  | NULL           | 密码哈希             |
    | password_salt        | VARCHAR(64)  | YES  | NULL           | 密码盐值             |
    | password_changed_at  | DATETIME     | YES  | NULL           | 密码最后修改时间     |
    | must_change_password | TINYINT(1)   | NO   | 1              | 是否必须修改密码     |
    | auth_source          | VARCHAR(32)  | NO   | 'LOCAL'        | 认证来源：LOCAL/SSO  |
    | status               | VARCHAR(32)  | NO   | 'PENDING'      | 状态                 |
    | disabled_reason      | VARCHAR(256) | YES  | NULL           | 禁用原因             |
    | disabled_at          | DATETIME     | YES  | NULL           | 禁用时间             |
    | mfa_enabled          | TINYINT(1)   | NO   | 0              | 是否启用MFA          |
    | mfa_secret           | VARCHAR(128) | YES  | NULL           | MFA密钥              |
    | last_login_at        | DATETIME     | YES  | NULL           | 最后登录时间         |
    | last_login_ip        | VARCHAR(64)  | YES  | NULL           | 最后登录IP           |
    | created_by           | BIGINT       | NO   | -              | 创建人ID             |
    | created_at           | DATETIME     | NO   | NOW()          | 创建时间             |
    | updated_by           | BIGINT       | YES  | NULL           | 更新人ID             |
    | updated_at           | DATETIME     | NO   | NOW()          | 更新时间             |
    | deleted_at           | DATETIME     | YES  | NULL           | 删除时间（逻辑删除） |

    表 3.5.2.1-1 iam_user 平台用户表结构

+   索引设计：

    | 索引名         | 索引字段   | 类型 | 说明           |
    | -------------- | ---------- | ---- | -------------- |
    | PRIMARY        | id         | 主键 | 主键索引       |
    | uk_username    | username   | 唯一 | 用户名唯一索引 |
    | uk_email       | email      | 唯一 | 邮箱唯一索引   |
    | idx_mobile     | mobile     | 普通 | 手机号索引     |
    | idx_status     | status     | 普通 | 状态索引       |
    | idx_user_type  | user_type  | 普通 | 用户类型索引   |
    | idx_created_at | created_at | 普通 | 创建时间索引   |

    表 3.5.2.1-2 iam_user 索引设计

#### ~~3.5.2.2 iam_activation_token 激活令牌表~~已废弃

+   已废弃。

#### 3.5.2.3 iam_password_history 密码历史表

+   密码历史表用于防止用户使用最近用过的密码。

    | 字段名        | 数据类型     | 可空 | 默认值         | 说明     |
    | ------------- | ------------ | ---- | -------------- | -------- |
    | id            | BIGINT       | NO   | AUTO_INCREMENT | 主键     |
    | user_id       | BIGINT       | NO   | -              | 用户ID   |
    | password_hash | VARCHAR(128) | NO   | -              | 密码哈希 |
    | created_at    | DATETIME     | NO   | NOW()          | 创建时间 |

    表 3.5.2.3-1 iam_password_history 密码历史表结构

+   索引设计：

    | 索引名      | 索引字段 | 类型 | 说明       |
    | ----------- | -------- | ---- | ---------- |
    | PRIMARY     | id       | 主键 | 主键索引   |
    | idx_user_id | user_id  | 普通 | 用户ID索引 |

    表 3.5.2.3-2 iam_password_history 索引设计

+   业务规则：
    -   保留最近5次密码历史
    -   新密码不能与历史密码相同

### 3.5.3 租户库表结构（clarisphere_t{tenant_id}）

+   租户库的用户表结构与平台库类似，增加租户特有字段。

#### 3.5.3.1 iam_user 租户用户表

+   租户用户表存储租户用户群用户信息。

    | 字段名               | 数据类型     | 可空 | 默认值         | 说明                     |
    | -------------------- | ------------ | ---- | -------------- | ------------------------ |
    | id                   | BIGINT       | NO   | AUTO_INCREMENT | 主键，用户ID             |
    | username             | VARCHAR(64)  | NO   | -              | 用户名，租户内唯一       |
    | real_name            | VARCHAR(64)  | NO   | -              | 真实姓名                 |
    | user_type            | VARCHAR(32)  | NO   | -              | 用户类型                 |
    | employee_no          | VARCHAR(64)  | YES  | NULL           | 员工编号                 |
    | mobile               | VARCHAR(20)  | YES  | NULL           | 手机号                   |
    | mobile_verified      | TINYINT(1)   | NO   | 0              | 手机号是否已验证         |
    | email                | VARCHAR(128) | NO   | -              | 邮箱                     |
    | email_verified       | TINYINT(1)   | NO   | 0              | 邮箱是否已验证           |
    | password_hash        | VARCHAR(128) | YES  | NULL           | 密码哈希                 |
    | password_salt        | VARCHAR(64)  | YES  | NULL           | 密码盐值                 |
    | password_changed_at  | DATETIME     | YES  | NULL           | 密码最后修改时间         |
    | must_change_password | TINYINT(1)   | NO   | 0              | 是否必须修改密码         |
    | auth_source          | VARCHAR(32)  | NO   | 'LOCAL'        | 认证来源：LOCAL/SSO/SYNC |
    | source_type          | VARCHAR(32)  | NO   | -              | 用户来源类型             |
    | external_id          | VARCHAR(128) | YES  | NULL           | 外部系统ID（同步用户）   |
    | synced_at            | DATETIME     | YES  | NULL           | 最后同步时间             |
    | org_id               | BIGINT       | YES  | NULL           | 所属组织单元ID           |
    | position_id          | BIGINT       | YES  | NULL           | 所属岗位ID               |
    | status               | VARCHAR(32)  | NO   | 'PENDING'      | 状态                     |
    | disabled_reason      | VARCHAR(256) | YES  | NULL           | 禁用原因                 |
    | disabled_at          | DATETIME     | YES  | NULL           | 禁用时间                 |
    | cancelled_at         | DATETIME     | YES  | NULL           | 注销时间                 |
    | mfa_enabled          | TINYINT(1)   | NO   | 0              | 是否启用MFA              |
    | mfa_secret           | VARCHAR(128) | YES  | NULL           | MFA密钥                  |
    | last_login_at        | DATETIME     | YES  | NULL           | 最后登录时间             |
    | last_login_ip        | VARCHAR(64)  | YES  | NULL           | 最后登录IP               |
    | created_by           | BIGINT       | YES  | NULL           | 创建人ID（自助注册为空） |
    | created_at           | DATETIME     | NO   | NOW()          | 创建时间                 |
    | updated_by           | BIGINT       | YES  | NULL           | 更新人ID                 |
    | updated_at           | DATETIME     | NO   | NOW()          | 更新时间                 |
    | deleted_at           | DATETIME     | YES  | NULL           | 删除时间（逻辑删除）     |

    表 3.5.3.1-1 iam_user 租户用户表结构

+   与平台用户表的差异字段：

    | 字段名       | 说明                                           |
    | ------------ | ---------------------------------------------- |
    | employee_no  | 员工编号，租户特有                             |
    | source_type  | 用户来源：ADMIN_CREATED/SELF_REGISTERED/SYNCED |
    | external_id  | 外部系统ID，企业同步用户使用                   |
    | synced_at    | 最后同步时间                                   |
    | org_id       | 组织单元关联                                   |
    | position_id  | 岗位关联                                       |
    | cancelled_at | 注销时间（支持自助注销）                       |

    表 3.5.3.1-2 租户用户表差异字段说明

+   索引设计：

    | 索引名          | 索引字段    | 类型 | 说明           |
    | --------------- | ----------- | ---- | -------------- |
    | PRIMARY         | id          | 主键 | 主键索引       |
    | uk_username     | username    | 唯一 | 用户名唯一索引 |
    | uk_email        | email       | 唯一 | 邮箱唯一索引   |
    | uk_external_id  | external_id | 唯一 | 外部ID唯一索引 |
    | idx_mobile      | mobile      | 普通 | 手机号索引     |
    | idx_employee_no | employee_no | 普通 | 员工编号索引   |
    | idx_status      | status      | 普通 | 状态索引       |
    | idx_source_type | source_type | 普通 | 来源类型索引   |
    | idx_org_id      | org_id      | 普通 | 组织单元索引   |
    | idx_position_id | position_id | 普通 | 岗位索引       |
    | idx_created_at  | created_at  | 普通 | 创建时间索引   |

    表 3.5.3.1-3 iam_user 租户用户表索引设计

#### ~~3.5.3.2 iam_activation_token 激活令牌表~~已废弃

+   已废弃。

#### 3.5.3.3 iam_password_history 密码历史表

+   结构与平台库相同，见3.5.2.3节。

### 3.5.4 消费者库表结构（clarisphere_consumer）

#### 3.5.4.1 iam_user 个人用户表

+   个人用户表存储C端用户信息。

    | 字段名                | 数据类型     | 可空 | 默认值         | 说明                         |
    | --------------------- | ------------ | ---- | -------------- | ---------------------------- |
    | id                    | BIGINT       | NO   | AUTO_INCREMENT | 主键，用户ID                 |
    | user_type             | VARCHAR(32)  | NO   | 'uc_user'      | 用户类型，固定为uc_user      |
    | nickname              | VARCHAR(64)  | YES  | NULL           | 昵称                         |
    | avatar                | VARCHAR(512) | YES  | NULL           | 头像URL                      |
    | mobile                | VARCHAR(20)  | YES  | NULL           | 手机号                       |
    | mobile_verified       | TINYINT(1)   | NO   | 0              | 手机号是否已验证             |
    | email                 | VARCHAR(128) | YES  | NULL           | 邮箱                         |
    | email_verified        | TINYINT(1)   | NO   | 0              | 邮箱是否已验证               |
    | password_hash         | VARCHAR(128) | YES  | NULL           | 密码哈希（三方登录可无）     |
    | password_salt         | VARCHAR(64)  | YES  | NULL           | 密码盐值                     |
    | password_changed_at   | DATETIME     | YES  | NULL           | 密码最后修改时间             |
    | registration_channel  | VARCHAR(32)  | NO   | -              | 注册渠道：MOBILE/EMAIL/OAUTH |
    | subscription_level    | VARCHAR(32)  | NO   | 'FREE'         | 订阅级别                     |
    | subscription_start    | DATETIME     | YES  | NULL           | 订阅开始时间                 |
    | subscription_end      | DATETIME     | YES  | NULL           | 订阅结束时间                 |
    | status                | VARCHAR(32)  | NO   | 'ACTIVE'       | 状态                         |
    | cancel_requested_at   | DATETIME     | YES  | NULL           | 申请注销时间                 |
    | cancel_cooling_end_at | DATETIME     | YES  | NULL           | 注销冷静期结束时间           |
    | cancelled_at          | DATETIME     | YES  | NULL           | 注销完成时间                 |
    | last_login_at         | DATETIME     | YES  | NULL           | 最后登录时间                 |
    | last_login_ip         | VARCHAR(64)  | YES  | NULL           | 最后登录IP                   |
    | created_at            | DATETIME     | NO   | NOW()          | 创建时间                     |
    | updated_at            | DATETIME     | NO   | NOW()          | 更新时间                     |

    表 3.5.4.1-1 iam_user 个人用户表结构

+   索引设计：

    | 索引名                   | 索引字段              | 类型 | 说明                       |
    | ------------------------ | --------------------- | ---- | -------------------------- |
    | PRIMARY                  | id                    | 主键 | 主键索引                   |
    | uk_mobile                | mobile                | 唯一 | 手机号唯一索引             |
    | uk_email                 | email                 | 唯一 | 邮箱唯一索引               |
    | idx_user_type            | user_type             | 普通 | 用户类型索引               |
    | idx_status               | status                | 普通 | 状态索引                   |
    | idx_subscription_level   | subscription_level    | 普通 | 订阅级别索引               |
    | idx_registration_channel | registration_channel  | 普通 | 注册渠道索引               |
    | idx_cancel_cooling_end   | cancel_cooling_end_at | 普通 | 冷静期结束索引（定时任务） |
    | idx_created_at           | created_at            | 普通 | 创建时间索引               |

    表 3.5.4.1-2 iam_user 个人用户表索引设计

#### 3.5.4.2 iam_oauth_binding 三方账号绑定表

+   三方账号绑定表存储用户与三方平台的绑定关系。

    | 字段名           | 数据类型     | 可空 | 默认值         | 说明                         |
    | ---------------- | ------------ | ---- | -------------- | ---------------------------- |
    | id               | BIGINT       | NO   | AUTO_INCREMENT | 主键                         |
    | user_id          | BIGINT       | NO   | -              | 用户ID                       |
    | provider         | VARCHAR(32)  | NO   | -              | 三方平台：QQ/WECHAT/DINGTALK |
    | open_id          | VARCHAR(128) | NO   | -              | 三方平台openId               |
    | union_id         | VARCHAR(128) | YES  | NULL           | 三方平台unionId              |
    | nickname         | VARCHAR(64)  | YES  | NULL           | 三方平台昵称                 |
    | avatar           | VARCHAR(512) | YES  | NULL           | 三方平台头像                 |
    | access_token     | VARCHAR(512) | YES  | NULL           | 访问令牌（加密存储）         |
    | refresh_token    | VARCHAR(512) | YES  | NULL           | 刷新令牌（加密存储）         |
    | token_expires_at | DATETIME     | YES  | NULL           | 令牌过期时间                 |
    | bound_at         | DATETIME     | NO   | NOW()          | 绑定时间                     |
    | updated_at       | DATETIME     | NO   | NOW()          | 更新时间                     |

    表 3.5.4.2-1 iam_oauth_binding 三方账号绑定表结构

+   索引设计：

    | 索引名            | 索引字段           | 类型 | 说明             |
    | ----------------- | ------------------ | ---- | ---------------- |
    | PRIMARY           | id                 | 主键 | 主键索引         |
    | uk_provider_union | provider, union_id | 唯一 | 平台+unionId唯一 |
    | uk_provider_open  | provider, open_id  | 唯一 | 平台+openId唯一  |
    | idx_user_id       | user_id            | 普通 | 用户ID索引       |

    表 3.5.4.2-2 iam_oauth_binding 索引设计

+   业务规则：
    -   一个用户可以绑定多个三方平台
    -   同一三方平台的unionId/openId只能绑定一个用户

### 3.5.5 表关系图

+   用户管理数据模型关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      用户管理数据模型关系图                                 │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  clarisphere_platform                                                       │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                     │    │
    │  │  ┌─────────────────┐                                                │    │
    │  │  │   iam_user      │                                                │    │
    │  │  │   (平台用户)    │                                                │    │
    │  │  └────────┬────────┘                                                │    │
    │  │           │                                                         │    │
    │  │          1:N                                                        │    │
    │  │           │                                                         │    │
    │  │           ▼                                                         │    │
    │  │  ┌─────────────────────┐                                            │    │
    │  │  │iam_password_history │                                            │    │
    │  │  │   (密码历史)        │                                            │    │
    │  │  └─────────────────────┘                                            │    │
    │  │                                                                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    │  clarisphere_t{tenant_id}                                                   │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                     │    │
    │  │  ┌─────────────────┐                                                │    │
    │  │  │   iam_user      │                                                │    │
    │  │  │   (租户用户)    │                                                │    │
    │  │  └────────┬────────┘                                                │    │
    │  │           │                                                         │    │
    │  │          1:N              ┌─────────────────────┐                   │    │
    │  │           │               │org_organization(组织)◀──┐               │    │
    │  │           ▼               └─────────────────────┘   │               │    │
    │  │  ┌─────────────────────┐  ┌─────────────────────┐   │FK             │    │
    │  │  │iam_password_history │  │  position (岗位)    │◀──┘               │    │
    │  │  │   (密码历史)        │  └─────────────────────┘                   │    │
    │  │  └─────────────────────┘                                            │    │
    │  │                                                                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    │  clarisphere_consumer                                                       │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                     │    │
    │  │  ┌─────────────────┐      ┌─────────────────────┐                   │    │
    │  │  │   iam_user      │      │  iam_oauth_binding  │                   │    │
    │  │  │   (个人用户)    │──1:N─│  (三方账号绑定)     │                   │    │
    │  │  └─────────────────┘      └─────────────────────┘                   │    │
    │  │                                                                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.5.5-1 用户管理数据模型关系图

### 3.5.6 数据字典

#### 3.5.6.1 user_type 用户类型

    | Java枚举值     | 数据库存储值   | 说明         | 所属用户群 | 适用数据库 |
    | -------------- | -------------- | ------------ | ---------- | ---------- |
    | PROVIDER_ADMIN | provider_admin | 平台管理员   | UP         | platform   |
    | PROVIDER_USER  | provider_user  | 平台普通用户 | UP         | platform   |
    | UR_ADMIN       | ur_admin       | 租户管理员   | UR         | tenant     |
    | UR_USER        | ur_user        | 租户普通用户 | UR         | tenant     |
    | UC_USER        | uc_user        | 个人用户     | UC         | consumer   |

    表 3.5.6.1-1 user_type 用户类型枚举

    + **枚举命名规范**：Java代码中使用大写下划线形式（如PROVIDER_ADMIN），数据库存储使用小写下划线形式（如provider_admin）。

#### 3.5.6.2 status 用户状态

    | 枚举值    | 说明   | 可流转到                     |
    | --------- | ------ | ---------------------------- |
    | PENDING   | 待激活 | ACTIVE                       |
    | ACTIVE    | 正常   | DISABLED, DELETED, CANCELLED |
    | DISABLED  | 已禁用 | ACTIVE, DELETED              |
    | DELETED   | 已删除 | -（终态）                    |
    | CANCELLED | 已注销 | -（终态）                    |

    表 3.5.6.2-1 status 用户状态枚举

#### 3.5.6.3 auth_source 认证来源

    | 枚举值 | 说明        | 可改密码 | 适用用户群 |
    | ------ | ----------- | -------- | ---------- |
    | LOCAL  | 本地认证    | 是       | 全部       |
    | SSO    | 企业SSO认证 | 否       | ur         |
    | SYNC   | 企业同步    | 否       | ur         |

    表 3.5.6.3-1 auth_source 认证来源枚举

#### 3.5.6.4 source_type 用户来源类型

    | 枚举值          | 说明       | 可自助注销 | 适用用户群 |
    | --------------- | ---------- | ---------- | ---------- |
    | ADMIN_CREATED   | 管理员创建 | 否         | UP, UR     |
    | SELF_REGISTERED | 开放注册   | 是         | UR, UC     |
    | SYNCED          | 企业同步   | 否         | UR         |

    表 3.5.6.4-1 source_type 用户来源类型枚举

    + **说明**：UP用户群仅支持ADMIN_CREATED来源；UC用户群仅支持SELF_REGISTERED来源；UR用户群支持全部三种来源。

#### 3.5.6.5 registration_channel 注册渠道

    | 枚举值 | 说明         | 适用用户群 |
    | ------ | ------------ | ---------- |
    | MOBILE | 手机号注册   | uc         |
    | EMAIL  | 邮箱注册     | uc         |
    | OAUTH  | 三方账号注册 | uc         |

    表 3.5.6.5-1 registration_channel 注册渠道枚举

#### 3.5.6.6 subscription_level 订阅级别

    | 枚举值     | 说明           |
    | ---------- | -------------- |
    | GUEST      | 游客（未注册） |
    | FREE       | 免费用户       |
    | BASIC      | 基础订阅       |
    | PREMIUM    | 高级订阅       |
    | ENTERPRISE | 企业订阅       |

    表 3.5.6.6-1 subscription_level 订阅级别枚举

#### 3.5.6.7 oauth_provider 三方平台

    | 枚举值   | 说明 |
    | -------- | ---- |
    | QQ       | QQ   |
    | WECHAT   | 微信 |
    | DINGTALK | 钉钉 |

    表 3.5.6.7-1 oauth_provider 三方平台枚举

### 3.5.7 数据迁移与初始化

#### 3.5.7.1 平台库初始化

+   平台库初始化时需要执行以下操作：
    -   创建iam_user、iam_password_history表
    -   插入初始管理员账号（见FL-P-00流程）

+   初始管理员数据：

    | 字段                 | 值              |
    | -------------------- | --------------- |
    | id                   | 系统生成        |
    | username             | admin（可配置） |
    | real_name            | 系统管理员      |
    | user_type            | provider_admin  |
    | email                | 配置文件指定    |
    | status               | PENDING         |
    | auth_source          | LOCAL           |
    | must_change_password | 1               |

    表 3.5.7.1-1 初始管理员数据

#### 3.5.7.2 租户库初始化

+   新租户开通时需要执行以下操作：
    -   创建数据库 clarisphere_t{tenant_id}
    -   执行DDL创建所有表结构
    -   创建租户管理员账号（见FL-UR-00流程）

#### 3.5.7.3 数据清理策略

+   数据清理策略如下：

    | 数据类型       | 清理条件              | 清理方式     |
    | -------------- | --------------------- | ------------ |
    | 过期激活令牌   | expires_at < 当前时间 | 物理删除     |
    | 已使用激活令牌 | used = 1 且 超过30天  | 物理删除     |
    | 密码历史       | 保留最近5条           | 物理删除旧的 |
    | 已删除用户     | deleted_at 超过1年    | 可归档       |
    | 已注销用户     | cancelled_at 超过1年  | 可归档       |

    表 3.5.7.3-1 数据清理策略

## 3.6 前端设计

+   本节设计用户管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   用户管理前端按用户群分组，供给侧与租户侧为管理类列表+表单页面，C端以自助注册和个人设置为主，公共页面提供无需登录的账号激活、密码重置等功能。

### 3.6.1 页面总览

+   用户管理子领域前端页面清单如下表所示。

    | 页面编号     | 页面名称       | 用户群   | 路由路径                        | 说明                   |
    | ------------ | -------------- | -------- | ------------------------------- | ---------------------- |
    | PG-P-USR-01  | 用户管理列表页 | provider | /provider/iam/users             | 供给侧用户管理主入口   |
    | PG-P-USR-02  | 用户创建页     | provider | /provider/iam/users/create      | 列表页新建按钮进入     |
    | PG-P-USR-03  | 用户详情页     | provider | /provider/iam/users/:id         | 列表页点击用户名进入   |
    | PG-UR-USR-01 | 用户管理列表页 | ur       | /tenant/iam/users               | 租户侧用户管理主入口   |
    | PG-UR-USR-02 | 用户创建页     | ur       | /tenant/iam/users/create        | 列表页新建按钮进入     |
    | PG-UR-USR-03 | 用户详情页     | ur       | /tenant/iam/users/:id           | 列表页点击用户名进入   |
    | PG-UR-USR-04 | 个人设置页     | ur       | /tenant/iam/users/me/settings   | 顶部导航头像下拉进入   |
    | PG-UC-USR-01 | 注册页         | uc       | /consumer/register              | 登录页立即注册入口     |
    | PG-UC-USR-02 | 个人中心页     | uc       | /consumer/iam/users/me          | 顶部导航头像下拉进入   |
    | PG-UC-USR-03 | 账号安全页     | uc       | /consumer/iam/users/me/security | 个人中心账号安全入口   |
    | PG-UC-USR-04 | 账号注销页     | uc       | /consumer/iam/users/me/cancel   | 账号安全页注销账号入口 |
    | PG-PUB-01    | 激活账号页     | 公共     | /public/activate                | 激活验证码链接进入     |
    | PG-PUB-02    | 忘记密码页     | 公共     | /public/forgot-password         | 登录页忘记密码入口     |
    | PG-PUB-03    | 重置密码页     | 公共     | /public/reset-password          | 重置邮件链接进入       |
    | PG-PUB-04    | 企业试用申请页 | 公共     | /public/trial-apply             | 官网免费试用入口       |
    | PG-PUB-05    | 租户用户注册页 | 公共     | /public/tenant-register         | 租户登录页注册入口     |

    表 3.6.1-1 用户管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                         用户管理页面导航结构                             │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  供给侧管理后台                                                          │
    │  └── 系统管理 → 用户管理                                                 │
    │      └── [PG-P-USR-01] 用户管理列表页                                    │
    │          ├── [PG-P-USR-02] 用户创建页                                    │
    │          └── [PG-P-USR-03] 用户详情页                                    │
    │                                                                          │
    │  租户管理后台                                                            │
    │  ├── 组织管理 → 用户管理                                                 │
    │  │   └── [PG-UR-USR-01] 用户管理列表页                                   │
    │  │       ├── [PG-UR-USR-02] 用户创建页                                   │
    │  │       └── [PG-UR-USR-03] 用户详情页                                   │
    │  └── 顶部导航 → 头像下拉                                                 │
    │      └── [PG-UR-USR-04] 个人设置页                                       │
    │                                                                          │
    │  C端个人门户                                                             │
    │  ├── [PG-UC-USR-01] 注册页                                               │
    │  └── 顶部导航 → 头像下拉                                                 │
    │      └── [PG-UC-USR-02] 个人中心页                                       │
    │          └── [PG-UC-USR-03] 账号安全页                                   │
    │              └── [PG-UC-USR-04] 账号注销页                               │
    │                                                                          │
    │  公共页面（无需登录）                                                    │
    │  ├── [PG-PUB-01] 激活账号页                                              │
    │  ├── [PG-PUB-02] 忘记密码页                                              │
    │  ├── [PG-PUB-03] 重置密码页                                              │
    │  ├── [PG-PUB-04] 企业试用申请页                                          │
    │  └── [PG-PUB-05] 租户用户注册页                                          │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.1-1 用户管理页面导航结构

### 3.6.2 供给侧用户管理

#### 3.6.2.1 PG-P-USR-01 用户管理列表页

+   页面说明：
    -   用途：管理平台用户，支持查询、创建、禁用、删除等操作
    -   入口：供给侧后台 → 系统管理 → 用户管理
    -   权限：provider:iam:user:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-USR-01 用户管理列表页                                              │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 系统管理 / 用户管理                                               │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 搜索区域 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  用户名/姓名          状态              用户类型                  │   │
    │  │  ┌──────────────┐    ┌──────────┐      ┌──────────┐               │   │
    │  │  │              │    │ 全部   ▼ │      │ 全部   ▼ │               │   │
    │  │  └──────────────┘    └──────────┘      └──────────┘               │   │
    │  │                                                                   │   │
    │  │                                        ┌──────┐    ┌──────┐       │   │
    │  │                                        │ 搜索 │    │ 重置 │       │   │
    │  │                                        └──────┘    └──────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 工具栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                              ┌──────────┐         │   │
    │  │                                              │ + 新建   │         │   │
    │  │                                              └──────────┘         │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 数据列表 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌────────┬──────┬────────────┬────────┬──────┬────────────────┐  │   │
    │  │  │ 用户名 │ 姓名 │   邮箱     │  类型  │ 状态 │     操作       │  │   │
    │  │  ├────────┼──────┼────────────┼────────┼──────┼────────────────┤  │   │
    │  │  │ admin  │ 张三 │ z@xx.com   │ 管理员 │ 正常 │查看 编辑 禁用  │  │   │
    │  │  │        │      │            │        │      │删除            │  │   │
    │  │  ├────────┼──────┼────────────┼────────┼──────┼────────────────┤  │   │
    │  │  │ user01 │ 李四 │ l@xx.com   │ 普通   │待激活│查看 编辑 重发  │  │   │
    │  │  │        │      │            │        │      │删除            │  │   │
    │  │  ├────────┼──────┼────────────┼────────┼──────┼────────────────┤  │   │
    │  │  │ user02 │ 王五 │ w@xx.com   │ 普通   │已禁用│查看 编辑 启用  │  │   │
    │  │  │        │      │            │        │      │删除            │  │   │
    │  │  └────────┴──────┴────────────┴────────┴──────┴────────────────┘  │   │
    │  │                                                                   │   │
    │  │  共 100 条  < 1 2 3 ... 10 >    每页 10 条                        │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.1-1 用户管理列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                           | 关联API  | 前置条件                 |
    | -------- | -------- | -------------- | ---------------------------------------------- | -------- | ------------------------ |
    | F01      | 展示     | 加载列表       | 进入页面时加载用户列表数据，默认按创建时间倒序 | P-USR-02 | provider:iam:user:list   |
    | F02      | 操作     | 搜索           | 按搜索条件查询用户列表                         | P-USR-02 | provider:iam:user:list   |
    | F03      | 操作     | 重置           | 清空搜索条件并重新加载列表                     | -        | -                        |
    | F04      | 操作     | 新建           | 跳转用户创建页                                 | -        | provider:iam:user:create |
    | F05      | 操作     | 查看           | 点击用户名或查看按钮，跳转用户详情页           | P-USR-03 | provider:iam:user:read   |
    | F06      | 操作     | 编辑           | 打开用户编辑弹窗                               | P-USR-04 | provider:iam:user:update |
    | F07      | 操作     | 禁用           | 禁用用户，弹出二次确认对话框                   | P-USR-06 | provider:iam:user:update |
    | F08      | 操作     | 删除           | 逻辑删除用户，弹出二次确认对话框               | P-USR-05 | provider:iam:user:delete |
    | F09      | 操作     | 重发激活验证码 | 对待激活用户重发激活验证码                     | P-USR-09 | provider:iam:user:update |
    | F10      | 操作     | 启用           | 启用已禁用用户                                 | P-USR-07 | provider:iam:user:update |

    表 3.6.2.1-1 用户管理列表页功能说明

+   搜索条件：

    | 字段名      | 组件类型 | 数据来源 | 默认值 | 说明                    |
    | ----------- | -------- | -------- | ------ | ----------------------- |
    | 用户名/姓名 | Input    | 用户输入 | 空     | 模糊匹配用户名或姓名    |
    | 状态        | Select   | 枚举     | 全部   | 待激活/正常/已禁用      |
    | 用户类型    | Select   | 枚举     | 全部   | 平台管理员/平台普通用户 |

    表 3.6.2.1-2 用户管理列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                       |
    | -------- | ---- | ---- | -------- | -------------------------- |
    | 用户名   | 120  | 左   | 是       | 可点击跳转详情页           |
    | 姓名     | 100  | 左   | 是       | -                          |
    | 邮箱     | 180  | 左   | 否       | -                          |
    | 用户类型 | 100  | 中   | 否       | 平台管理员/平台普通用户    |
    | 状态     | 80   | 中   | 否       | 标签展示，颜色见状态标签表 |
    | 操作     | 200  | 中   | 否       | 按钮组，按用户状态动态显示 |

    表 3.6.2.1-3 用户管理列表页列表字段

+   状态标签展示：

    | 状态值 | 标签文本 | 标签颜色 |
    | ------ | -------- | -------- |
    | 待激活 | 待激活   | 橙色     |
    | 正常   | 正常     | 绿色     |
    | 已禁用 | 已禁用   | 红色     |

    表 3.6.2.1-4 用户状态标签

+   交互规则：
    -   操作列按钮根据用户状态动态显示：待激活状态显示查看、编辑、重发激活验证码、删除；正常状态显示查看、编辑、禁用、删除；已禁用状态显示查看、编辑、启用、删除
    -   禁用和删除操作需弹出二次确认对话框
    -   列表默认按创建时间倒序排列，支持用户名和姓名列排序

#### 3.6.2.2 PG-P-USR-02 用户创建页

+   页面说明：
    -   用途：创建新的平台用户
    -   入口：用户管理列表页 → 新建按钮
    -   权限：provider:iam:user:create

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-USR-02 用户创建页                                                  │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 系统管理 / 用户管理 / 新建用户                                    │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 表单区域 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌─ 基本信息 ─────────────────────────────────────────────────┐   │   │
    │  │  │                                                            │   │   │
    │  │  │  用户名 *               姓名 *                             │   │   │
    │  │  │  ┌────────────────┐    ┌────────────────┐                  │   │   │
    │  │  │  │                │    │                │                  │   │   │
    │  │  │  └────────────────┘    └────────────────┘                  │   │   │
    │  │  │                                                            │   │   │
    │  │  │  邮箱 *                 手机号                             │   │   │
    │  │  │  ┌────────────────┐    ┌────────────────┐                  │   │   │
    │  │  │  │                │    │                │                  │   │   │
    │  │  │  └────────────────┘    └────────────────┘                  │   │   │
    │  │  │                                                            │   │   │
    │  │  │  用户类型 *                                                │   │   │
    │  │  │  ○ 平台管理员    ○ 平台普通用户                            │   │   │
    │  │  │                                                            │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  │                                                                   │   │
    │  │  ┌─ 角色分配 ─────────────────────────────────────────────────┐   │   │
    │  │  │  □ 超级管理员  □ 运营管理员  □ 客服专员  □ 财务专员        │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 操作栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                  ┌────────┐    ┌────────┐         │   │
    │  │                                  │  取消  │    │  提交  │         │   │
    │  │                                  └────────┘    └────────┘         │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.2-1 用户创建页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                                 | 关联API   | 前置条件                 |
    | -------- | -------- | -------------- | ---------------------------------------------------- | --------- | ------------------------ |
    | F01      | 展示     | 加载角色列表   | 进入页面时加载可分配角色列表                         | P-PERM-02 | provider:iam:user:create |
    | F02      | 操作     | 用户名唯一校验 | 用户名输入框失焦时触发唯一性校验                     | P-USR-02  | -                        |
    | F03      | 操作     | 取消           | 放弃编辑，返回列表页                                 | -         | -                        |
    | F04      | 操作     | 提交           | 校验通过后创建用户并发送激活验证码，成功后返回列表页 | P-USR-01  | provider:iam:user:create |

    表 3.6.2.2-1 用户创建页功能说明

+   交互规则：
    -   提交前进行必填校验，用户名、姓名、邮箱、用户类型为必填项
    -   提交成功后跳转列表页并显示成功提示
    -   用户名需唯一性校验，失焦时触发

#### 3.6.2.3 PG-P-USR-03 用户详情页

+   页面说明：
    -   用途：查看用户详细信息，管理员可执行协助重置密码操作
    -   入口：用户管理列表页 → 查看按钮
    -   权限：provider:iam:user:read

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-P-USR-03 用户详情页                                                  │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 系统管理 / 用户管理 / 用户详情                                    │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 基本信息卡片 ────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌──────┐                                                         │   │
    │  │  │      │  张三                              ┌──────────────┐     │   │
    │  │  │ 头像 │  admin@platform.com                │ 协助重置密码 │     │   │
    │  │  │      │  平台管理员 | 正常                 └──────────────┘     │   │
    │  │  └──────┘                                                         │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 详细信息 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  用户名：admin              手机号：138****8888                   │   │
    │  │  姓  名：张三               邮  箱：admin@platform.com            │   │
    │  │  用户类型：平台管理员       创建时间：2026-01-01 10:00:00         │   │
    │  │  状  态：正常               最后登录：2026-01-25 09:30:00         │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 角色信息 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  已分配角色：超级管理员、运营管理员                               │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 操作栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                              ┌────────┐           │   │
    │  │                                              │  返回  │           │   │
    │  │                                              └────────┘           │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.2.3-1 用户详情页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                       | 关联API  | 前置条件                 |
    | -------- | -------- | ------------ | ------------------------------------------ | -------- | ------------------------ |
    | F01      | 展示     | 加载用户详情 | 进入页面时根据用户ID加载详情数据           | P-USR-03 | provider:iam:user:read   |
    | F02      | 操作     | 协助重置密码 | 打开重置密码确认弹窗，确认后发送重置验证码 | P-USR-08 | provider:iam:user:update |
    | F03      | 操作     | 返回         | 返回列表页                                 | -        | -                        |

    表 3.6.2.3-1 用户详情页功能说明

### 3.6.3 租户侧用户管理

+   租户侧用户管理页面（PG-UR-USR-01 ~ PG-UR-USR-03）与供给侧（PG-P-USR-01 ~ PG-P-USR-03）结构高度相似，以下仅说明差异部分。

+   租户侧与供给侧页面差异如下表所示。

    | 差异项       | 供给侧（PG-P-USR-*）        | 租户侧（PG-UR-USR-*）                       |
    | ------------ | --------------------------- | ------------------------------------------- |
    | 搜索条件     | 用户名/姓名、状态、用户类型 | 用户名/姓名、状态、用户类型、部门、用户来源 |
    | 列表字段     | 无部门列和来源列            | 增加所属部门列和用户来源列                  |
    | 操作按钮     | 查看、编辑、禁用/启用、删除 | 查看、编辑、禁用/启用、删除（受来源约束）   |
    | 创建页表单   | 基本信息 + 角色分配         | 基本信息 + 组织岗位分配 + 角色分配          |
    | 详情页功能   | 协助重置密码                | 协助重置密码 + 分配组织岗位                 |
    | 用户类型选项 | 平台管理员/平台普通用户     | 租户管理员/租户用户                         |
    | 权限前缀     | provider:iam:user:*         | ur:iam:user:*                               |
    | 接口前缀     | P-USR-*                     | UR-USR-*                                    |

    表 3.6.3-1 供给侧与租户侧用户管理页面差异

#### 3.6.3.1 PG-UR-USR-01 用户管理列表页

+   页面说明：
    -   用途：租户管理员管理本租户用户
    -   入口：租户后台 → 组织管理 → 用户管理
    -   权限：ur:iam:user:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-USR-01 用户管理列表页                                             │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 组织管理 / 用户管理                                               │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 搜索区域 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  用户名/姓名          状态              用户类型                  │   │
    │  │  ┌──────────────┐    ┌──────────┐      ┌──────────┐               │   │
    │  │  │              │    │ 全部   ▼ │      │ 全部   ▼ │               │   │
    │  │  └──────────────┘    └──────────┘      └──────────┘               │   │
    │  │                                                                   │   │
    │  │  部门                用户来源                                     │   │
    │  │  ┌──────────────┐    ┌──────────┐                                 │   │
    │  │  │ 全部     ▼   │    │ 全部   ▼ │                                 │   │
    │  │  └──────────────┘    └──────────┘                                 │   │
    │  │                                                                   │   │
    │  │                                        ┌──────┐    ┌──────┐       │   │
    │  │                                        │ 搜索 │    │ 重置 │       │   │
    │  │                                        └──────┘    └──────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 工具栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                              ┌──────────┐         │   │
    │  │                                              │ + 新建   │         │   │
    │  │                                              └──────────┘         │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 数据列表 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌────────┬──────┬──────┬──────┬──────┬──────┬────────────────┐   │   │
    │  │  │ 用户名 │ 姓名 │ 部门 │ 来源 │ 类型 │ 状态 │     操作       │   │   │
    │  │  ├────────┼──────┼──────┼──────┼──────┼──────┼────────────────┤   │   │
    │  │  │ user01 │ 李四 │ 研发 │ 创建 │ 用户 │ 正常 │查看 编辑 禁用  │   │   │
    │  │  │        │      │      │      │      │      │删除            │   │   │
    │  │  ├────────┼──────┼──────┼──────┼──────┼──────┼────────────────┤   │   │
    │  │  │ user02 │ 王五 │ 财务 │ 同步 │ 用户 │ 正常 │查看            │   │   │
    │  │  └────────┴──────┴──────┴──────┴──────┴──────┴────────────────┘   │   │
    │  │                                                                   │   │
    │  │  共 50 条  < 1 2 3 ... 5 >    每页 10 条                          │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.3.1-1 租户用户管理列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                           | 关联API   | 前置条件           |
    | -------- | -------- | -------------- | ---------------------------------------------- | --------- | ------------------ |
    | F01      | 展示     | 加载列表       | 进入页面时加载用户列表数据，默认按创建时间倒序 | UR-USR-02 | ur:iam:user:list   |
    | F02      | 操作     | 搜索           | 按搜索条件查询用户列表                         | UR-USR-02 | ur:iam:user:list   |
    | F03      | 操作     | 重置           | 清空搜索条件并重新加载列表                     | -         | -                  |
    | F04      | 操作     | 新建           | 跳转用户创建页                                 | -         | ur:iam:user:create |
    | F05      | 操作     | 查看           | 点击用户名或查看按钮，跳转用户详情页           | UR-USR-03 | ur:iam:user:read   |
    | F06      | 操作     | 编辑           | 打开用户编辑弹窗                               | UR-USR-04 | ur:iam:user:update |
    | F07      | 操作     | 禁用           | 禁用用户，弹出二次确认对话框                   | UR-USR-06 | ur:iam:user:update |
    | F08      | 操作     | 删除           | 逻辑删除用户，弹出二次确认对话框               | UR-USR-05 | ur:iam:user:delete |
    | F09      | 操作     | 重发激活验证码 | 对待激活用户重发激活验证码                     | UR-USR-09 | ur:iam:user:update |
    | F10      | 操作     | 启用           | 启用已禁用用户                                 | UR-USR-07 | ur:iam:user:update |

    表 3.6.3.1-1 租户用户管理列表页功能说明

+   搜索条件：

    | 字段名      | 组件类型   | 数据来源 | 默认值 | 说明                                |
    | ----------- | ---------- | -------- | ------ | ----------------------------------- |
    | 用户名/姓名 | Input      | 用户输入 | 空     | 模糊匹配用户名或姓名                |
    | 状态        | Select     | 枚举     | 全部   | 待激活/正常/已禁用                  |
    | 用户类型    | Select     | 枚举     | 全部   | 租户管理员/租户用户                 |
    | 部门        | TreeSelect | 接口     | 全部   | 组织树选择，调用UR-ORG-06查询组织树 |
    | 用户来源    | Select     | 枚举     | 全部   | 管理员创建/开放注册/企业同步        |

    表 3.6.3.1-2 租户用户管理列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                             |
    | -------- | ---- | ---- | -------- | -------------------------------- |
    | 用户名   | 120  | 左   | 是       | 可点击跳转详情页                 |
    | 姓名     | 100  | 左   | 是       | -                                |
    | 所属部门 | 120  | 左   | 否       | 组织树路径，截断显示             |
    | 用户来源 | 100  | 中   | 否       | 管理员创建/开放注册/企业同步     |
    | 用户类型 | 100  | 中   | 否       | 租户管理员/租户用户              |
    | 状态     | 80   | 中   | 否       | 标签展示，颜色见状态标签表       |
    | 操作     | 200  | 中   | 否       | 按钮组，按用户状态和来源动态显示 |

    表 3.6.3.1-3 租户用户管理列表页列表字段

+   状态标签展示：

    | 状态值 | 标签文本 | 标签颜色 |
    | ------ | -------- | -------- |
    | 待激活 | 待激活   | 橙色     |
    | 正常   | 正常     | 绿色     |
    | 已禁用 | 已禁用   | 红色     |

    表 3.6.3.1-4 租户用户状态标签

+   用户来源与可操作性：

    | 用户来源   | 可编辑 | 可禁用 | 可删除 | 说明                     |
    | ---------- | ------ | ------ | ------ | ------------------------ |
    | 管理员创建 | 是     | 是     | 是     | 完全可管理               |
    | 开放注册   | 是     | 是     | 否     | 不可删除，用户可自助注销 |
    | 企业同步   | 否     | 否     | 否     | 仅查看，由源系统管理     |

    表 3.6.3.1-5 用户来源与可操作性

+   交互规则：
    -   操作列按钮根据用户状态和用户来源动态显示：企业同步用户仅显示查看按钮；其他来源用户按状态显示按钮（同供给侧逻辑）
    -   禁用和删除操作需弹出二次确认对话框
    -   列表默认按创建时间倒序排列，支持用户名和姓名列排序

#### 3.6.3.2 PG-UR-USR-02 用户创建页

+   页面说明：
    -   用途：租户管理员创建用户
    -   入口：用户管理列表页 → 新建按钮
    -   权限：ur:iam:user:create

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-USR-02 用户创建页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 组织管理 / 用户管理 / 新建用户                                    │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 表单区域 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌─ 基本信息 ─────────────────────────────────────────────────┐   │   │
    │  │  │                                                            │   │   │
    │  │  │  用户名 *               姓名 *                             │   │   │
    │  │  │  ┌────────────────┐    ┌────────────────┐                  │   │   │
    │  │  │  │                │    │                │                  │   │   │
    │  │  │  └────────────────┘    └────────────────┘                  │   │   │
    │  │  │                                                            │   │   │
    │  │  │  邮箱 *                 手机号              员工编号       │   │   │
    │  │  │  ┌────────────────┐    ┌────────────────┐  ┌────────────┐  │   │   │
    │  │  │  │                │    │                │  │            │  │   │   │
    │  │  │  └────────────────┘    └────────────────┘  └────────────┘  │   │   │
    │  │  │                                                            │   │   │
    │  │  │  用户类型 *                                                │   │   │
    │  │  │  ○ 租户管理员    ○ 租户用户                                │   │   │
    │  │  │                                                            │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  │                                                                   │   │
    │  │  ┌─ 组织岗位分配 ─────────────────────────────────────────────┐   │   │
    │  │  │  所属部门              所属岗位                            │   │   │
    │  │  │  ┌────────────────┐    ┌────────────────┐                  │   │   │
    │  │  │  │ 请选择   ▼     │    │ 请选择   ▼     │                  │   │   │
    │  │  │  └────────────────┘    └────────────────┘                  │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  │                                                                   │   │
    │  │  ┌─ 角色分配 ─────────────────────────────────────────────────┐   │   │
    │  │  │  □ 租户管理员  □ CISO  □ 制度管理员  □ 普通员工            │   │   │
    │  │  └────────────────────────────────────────────────────────────┘   │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 操作栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                  ┌────────┐    ┌────────┐         │   │
    │  │                                  │  取消  │    │  提交  │         │   │
    │  │                                  └────────┘    └────────┘         │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.3.2-1 租户用户创建页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                                 | 关联API    | 前置条件           |
    | -------- | -------- | -------------- | ---------------------------------------------------- | ---------- | ------------------ |
    | F01      | 展示     | 加载组织树     | 进入页面时加载组织树数据供部门选择                   | UR-ORG-06  | ur:iam:user:create |
    | F02      | 展示     | 加载岗位列表   | 根据选中的部门加载该部门下的岗位列表                 | UR-POS-06  | ur:iam:user:create |
    | F03      | 展示     | 加载角色列表   | 进入页面时加载可分配角色列表                         | UR-PERM-02 | ur:iam:user:create |
    | F04      | 操作     | 用户名唯一校验 | 用户名输入框失焦时触发唯一性校验                     | UR-USR-02  | -                  |
    | F05      | 操作     | 取消           | 放弃编辑，返回列表页                                 | -          | -                  |
    | F06      | 操作     | 提交           | 校验通过后创建用户并发送激活验证码，成功后返回列表页 | UR-USR-01  | ur:iam:user:create |

    表 3.6.3.2-1 租户用户创建页功能说明

+   交互规则：
    -   提交前进行必填校验，用户名、姓名、邮箱、用户类型为必填项
    -   选择部门后联动加载该部门下的岗位列表
    -   提交成功后跳转列表页并显示成功提示
    -   用户名需唯一性校验，失焦时触发

#### 3.6.3.3 PG-UR-USR-03 用户详情页

+   页面说明：
    -   用途：查看租户用户详情，管理员可执行协助重置密码、分配组织等操作
    -   入口：用户管理列表页 → 查看按钮
    -   权限：ur:iam:user:read

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-USR-03 用户详情页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 组织管理 / 用户管理 / 用户详情                                    │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 基本信息卡片 ────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  ┌──────┐                                                         │   │
    │  │  │      │  李四              ┌──────────────┐ ┌──────────────┐    │   │
    │  │  │ 头像 │  lisi@tenant.com   │ 协助重置密码 │ │ 分配组织岗位 │    │   │
    │  │  │      │  租户用户 | 正常   └──────────────┘ └──────────────┘    │   │
    │  │  └──────┘                                                         │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 详细信息 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  用户名：user01             手机号：139****9000                   │   │
    │  │  姓  名：李四               邮  箱：lisi@tenant.com               │   │
    │  │  用户类型：租户用户         员工编号：EMP001                      │   │
    │  │  所属部门：研发部           所属岗位：高级工程师                  │   │
    │  │  用户来源：管理员创建       创建时间：2026-01-10 10:00:00         │   │
    │  │  状  态：正常               最后登录：2026-01-25 14:30:00         │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 角色信息 ────────────────────────────────────────────────────────┐   │
    │  │                                                                   │   │
    │  │  已分配角色：租户管理员、制度管理员                               │   │
    │  │                                                                   │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 操作栏 ──────────────────────────────────────────────────────────┐   │
    │  │                                              ┌────────┐           │   │
    │  │                                              │  返回  │           │   │
    │  │                                              └────────┘           │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.3.3-1 租户用户详情页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                       | 关联API   | 前置条件           |
    | -------- | -------- | ------------ | ------------------------------------------ | --------- | ------------------ |
    | F01      | 展示     | 加载用户详情 | 进入页面时根据用户ID加载详情数据           | UR-USR-03 | ur:iam:user:read   |
    | F02      | 操作     | 协助重置密码 | 打开重置密码确认弹窗，确认后发送重置验证码 | UR-USR-08 | ur:iam:user:update |
    | F03      | 操作     | 分配组织岗位 | 打开分配弹窗，选择部门和岗位后保存         | UR-USR-10 | ur:iam:user:update |
    | F04      | 操作     | 返回         | 返回列表页                                 | -         | -                  |

    表 3.6.3.3-1 租户用户详情页功能说明

+   详情弹窗 — 分配组织岗位弹窗：

    ```
    ┌────────────────────────────────────────────────┐
    │  分配组织岗位                             ✕    │
    ├────────────────────────────────────────────────┤
    │                                                │
    │  所属部门 *                                    │
    │  ┌──────────────────────────────────────────┐  │
    │  │ 请选择部门                           ▼   │  │
    │  └──────────────────────────────────────────┘  │
    │                                                │
    │  所属岗位                                      │
    │  ┌──────────────────────────────────────────┐  │
    │  │ 请选择岗位                           ▼   │  │
    │  └──────────────────────────────────────────┘  │
    │                                                │
    │              ┌────────┐    ┌────────┐          │
    │              │  取消  │    │  确定  │          │
    │              └────────┘    └────────┘          │
    │                                                │
    └────────────────────────────────────────────────┘
    ```

    图 3.6.3.3-2 分配组织岗位弹窗线框图

#### 3.6.3.4 PG-UR-USR-04 个人设置页

+   页面说明：
    -   用途：租户用户管理个人信息、修改密码、注销账号
    -   入口：顶部导航 → 头像下拉 → 个人设置
    -   权限：authenticated（登录即可）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-USR-04 个人设置页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 面包屑 ──────────────────────────────────────────────────────────┐   │
    │  │ 个人设置                                                          │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌──────────────┬──────────────┬──────────────┐                          │
    │  │  基本信息    │  账号安全    │  注销账号    │  ← Tab导航               │
    │  └──────────────┴──────────────┴──────────────┘                          │
    │                                                                          │
    │  ┌─ 基本信息Tab ────────────────────────────────────────────────────┐    │
    │  │                                                                  │    │
    │  │  ┌──────┐                                                        │    │
    │  │  │      │  姓名：李四                                            │    │
    │  │  │ 头像 │  邮箱：lisi@tenant.com                                 │    │
    │  │  │      │  手机：139****9000                                     │    │
    │  │  └──────┘                         ┌──────────────┐               │    │
    │  │                                   │   编辑资料   │               │    │
    │  │                                   └──────────────┘               │    │
    │  │                                                                  │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    │  ┌─ 账号安全Tab ────────────────────────────────────────────────────┐    │
    │  │  登录密码        已设置               ┌──────────────┐           │    │
    │  │                                       │  修改密码    │           │    │
    │  │                                       └──────────────┘           │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    │  ┌─ 注销账号Tab ────────────────────────────────────────────────────┐    │
    │  │  注销后账号将无法恢复，请谨慎操作     ┌──────────────┐           │    │
    │  │                                       │  注销账号    │           │    │
    │  │                                       └──────────────┘           │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.3.4-1 个人设置页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                   | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | -------------------------------------- | --------- | ------------- |
    | F01      | 展示     | 加载个人信息 | 进入页面时加载当前用户信息             | UR-USR-11 | authenticated |
    | F02      | 操作     | 编辑资料     | 打开编辑弹窗，修改姓名、手机等基本信息 | UR-USR-12 | authenticated |
    | F03      | 操作     | 修改密码     | 打开修改密码弹窗，需验证旧密码         | UR-USR-12 | authenticated |
    | F04      | 操作     | 注销账号     | 跳转注销确认流程                       | UR-USR-13 | authenticated |

    表 3.6.3.4-1 个人设置页功能说明

+   交互规则：
    -   页面采用Tab布局，包含基本信息、账号安全、注销账号三个Tab
    -   注销账号Tab仅对来源为"开放注册"的用户可见，来源为"管理员创建"或"企业同步"的用户不显示该Tab

### 3.6.4 C端用户自助

#### 3.6.4.1 PG-UC-USR-01 注册页

+   页面说明：
    -   用途：C端用户通过手机号、邮箱或三方账号注册
    -   入口：登录页 → 立即注册
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UC-USR-01 注册页                                                     │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │           LOGO               │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │          注册账号            │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  ┌───────────┬───────────┐   │                    │
    │                      │  │ 手机注册  │ 邮箱注册  │   │                    │
    │                      │  └───────────┴───────────┘   │                    │
    │                      │                              │                    │
    │                      │  手机号                      │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │ +86 ▼│                 │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  验证码                      │                    │
    │                      │  ┌────────────────┬───────┐  │                    │
    │                      │  │                │ 获取  │  │                    │
    │                      │  └────────────────┴───────┘  │                    │
    │                      │                              │                    │
    │                      │  设置密码                    │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │            ┌────────┐  │  │                    │
    │                      │  │            │ 强度条 │  │  │                    │
    │                      │  └────────────┴────────┘  │  │                    │
    │                      │                              │                    │
    │                      │  □ 我已阅读并同意            │                    │
    │                      │    《用户协议》《隐私政策》  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │       立即注册         │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ──── 其他方式注册 ────      │                    │
    │                      │                              │                    │
    │                      │   ┌────┐ ┌────┐ ┌────┐       │                    │
    │                      │   │ QQ │ │微信│ │钉钉│       │                    │
    │                      │   └────┘ └────┘ └────┘       │                    │
    │                      │                              │                    │
    │                      │  已有账号？立即登录          │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.4.1-1 注册页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称   | 说明                                     | 关联API | 前置条件                 |
    | -------- | -------- | ---------- | ---------------------------------------- | ------- | ------------------------ |
    | F01      | 展示     | 加载页面   | 进入页面时默认展示手机注册Tab            | -       | -                        |
    | F02      | 操作     | 手机注册   | 切换到手机注册Tab                        | -       | -                        |
    | F03      | 操作     | 邮箱注册   | 切换到邮箱注册Tab                        | -       | -                        |
    | F04      | 操作     | 获取验证码 | 发送短信/邮箱验证码，60秒倒计时          | PUB-06  | -                        |
    | F05      | 操作     | 立即注册   | 提交注册信息，成功后自动登录进入个人中心 | PUB-01  | 必填校验通过且协议已勾选 |
    | F06      | 操作     | QQ注册     | 跳转QQ OAuth授权页面                     | PUB-08  | -                        |
    | F07      | 操作     | 微信注册   | 跳转微信OAuth授权页面                    | PUB-08  | -                        |
    | F08      | 操作     | 钉钉注册   | 跳转钉钉OAuth授权页面                    | PUB-08  | -                        |
    | F09      | 操作     | 立即登录   | 跳转登录页                               | -       | -                        |

    表 3.6.4.1-1 注册页功能说明

+   交互规则：
    -   手机注册和邮箱注册通过Tab切换，切换时清空已填内容
    -   获取验证码后进入60秒倒计时，倒计时期间按钮置灰不可点击
    -   必须勾选用户协议和隐私政策才可提交注册
    -   密码输入时显示强度指示器

#### 3.6.4.2 PG-UC-USR-02 个人中心页

+   页面说明：
    -   用途：C端用户查看和管理个人信息
    -   入口：顶部导航 → 头像下拉 → 个人中心
    -   权限：authenticated

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UC-USR-02 个人中心页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 用户信息卡片 ───────────────────────────────────────────────────┐    │
    │  │                                                                  │    │
    │  │  ┌──────┐  昵称：小明                                            │    │
    │  │  │      │  手机：138****8000                                     │    │
    │  │  │ 头像 │  邮箱：未绑定              ┌──────────────┐            │    │
    │  │  │      │  会员等级：免费用户        │   编辑资料   │            │    │
    │  │  └──────┘                            └──────────────┘            │    │
    │  │                                                                  │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    │  ┌─ 功能入口 ───────────────────────────────────────────────────────┐    │
    │  │                                                                  │    │
    │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │    │
    │  │  │  账号安全    │  │  我的订阅    │  │  消息通知    │            │    │
    │  │  │  密码、绑定  │  │  订阅管理    │  │  系统消息    │            │    │
    │  │  └──────────────┘  └──────────────┘  └──────────────┘            │    │
    │  │                                                                  │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.4.2-1 个人中心页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                 | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | ------------------------------------ | --------- | ------------- |
    | F01      | 展示     | 加载个人信息 | 进入页面时加载当前用户信息和三方绑定 | UC-USR-01 | authenticated |
    | F02      | 操作     | 编辑资料     | 打开编辑弹窗，修改昵称、头像等信息   | UC-USR-02 | authenticated |
    | F03      | 操作     | 账号安全     | 跳转账号安全页                       | -         | authenticated |
    | F04      | 操作     | 我的订阅     | 跳转订阅管理页（由订阅模块提供）     | -         | authenticated |
    | F05      | 操作     | 消息通知     | 跳转消息中心（由消息模块提供）       | -         | authenticated |

    表 3.6.4.2-1 个人中心页功能说明

#### 3.6.4.3 PG-UC-USR-03 账号安全页

+   页面说明：
    -   用途：管理密码、绑定手机/邮箱、管理三方账号绑定
    -   入口：个人中心 → 账号安全
    -   权限：authenticated

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UC-USR-03 账号安全页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 登录密码 ────────────────────────────────────────────────────────┐   │
    │  │  登录密码        已设置                    ┌──────────────┐       │   │
    │  │  建议定期修改密码以保护账号安全            │  修改密码    │       │   │
    │  │                                            └──────────────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 绑定手机 ────────────────────────────────────────────────────────┐   │
    │  │  绑定手机        138****8888               ┌──────────────┐       │   │
    │  │  用于登录、找回密码、接收通知              │  更换手机    │       │   │
    │  │                                            └──────────────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 绑定邮箱 ────────────────────────────────────────────────────────┐   │
    │  │  绑定邮箱        未绑定                    ┌──────────────┐       │   │
    │  │  用于登录、找回密码                        │  绑定邮箱    │       │   │
    │  │                                            └──────────────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 三方账号 ────────────────────────────────────────────────────────┐   │
    │  │  ┌────┐  QQ        已绑定：小明            ┌──────┐               │   │
    │  │  │ QQ │                                    │ 解绑 │               │   │
    │  │  └────┘                                    └──────┘               │   │
    │  │  ┌────┐  微信      未绑定                  ┌──────┐               │   │
    │  │  │微信│                                    │ 绑定 │               │   │
    │  │  └────┘                                    └──────┘               │   │
    │  │  ┌────┐  钉钉      未绑定                  ┌──────┐               │   │
    │  │  │钉钉│                                    │ 绑定 │               │   │
    │  │  └────┘                                    └──────┘               │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    │  ┌─ 注销账号 ────────────────────────────────────────────────────────┐   │
    │  │  注销账号                                  ┌──────────────┐       │   │
    │  │  注销后账号将无法恢复，请谨慎操作          │  注销账号    │       │   │
    │  │                                            └──────────────┘       │   │
    │  └───────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.4.3-1 账号安全页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                       | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | ------------------------------------------ | --------- | ------------- |
    | F01      | 展示     | 加载安全信息 | 进入页面时加载密码状态、绑定信息、三方绑定 | UC-USR-01 | authenticated |
    | F02      | 展示     | 加载三方绑定 | 加载QQ/微信/钉钉绑定状态                   | UC-USR-05 | authenticated |
    | F03      | 操作     | 修改密码     | 打开修改密码弹窗，需验证旧密码             | UC-USR-08 | authenticated |
    | F04      | 操作     | 更换手机     | 打开更换手机弹窗，需验证旧手机             | UC-USR-02 | authenticated |
    | F05      | 操作     | 绑定邮箱     | 打开绑定邮箱弹窗，需发送验证码             | UC-USR-02 | authenticated |
    | F06      | 操作     | 解绑QQ       | 解绑QQ账号，弹出二次确认对话框             | UC-USR-07 | authenticated |
    | F07      | 操作     | 绑定微信     | 跳转微信OAuth授权页面完成绑定              | UC-USR-06 | authenticated |
    | F08      | 操作     | 绑定钉钉     | 跳转钉钉OAuth授权页面完成绑定              | UC-USR-06 | authenticated |
    | F09      | 操作     | 注销账号     | 跳转账号注销页                             | -         | authenticated |

    表 3.6.4.3-1 账号安全页功能说明

+   交互规则：
    -   三方账号绑定状态动态显示：已绑定时显示解绑按钮，未绑定时显示绑定按钮
    -   解绑操作需弹出二次确认对话框
    -   若用户仅有一种登录方式（如仅QQ注册且未设密码），解绑按钮置灰并提示"请先设置登录密码"

#### 3.6.4.4 PG-UC-USR-04 账号注销页

+   页面说明：
    -   用途：用户确认注销账号，进入冷静期
    -   入口：账号安全 → 注销账号
    -   权限：authenticated

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-UC-USR-04 账号注销页                                                 │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  ┌─ 申请注销阶段 ───────────────────────────────────────────────────┐    │
    │  │                                                                  │    │
    │  │  ⚠ 注销须知                                                      │    │
    │  │  · 注销后账号及所有数据将被永久删除，无法恢复                    │    │
    │  │  · 提交注销申请后有7天冷静期，冷静期内可随时撤销                 │    │
    │  │  · 冷静期结束后系统将自动完成注销                                │    │
    │  │                                                                  │    │
    │  │  请输入验证码以确认操作                                          │    │
    │  │  ┌────────────────────┬───────────┐                              │    │
    │  │  │                    │ 获取验证码│                              │    │
    │  │  └────────────────────┴───────────┘                              │    │
    │  │                                                                  │    │
    │  │  ┌──────────────┐    ┌──────────────┐                            │    │
    │  │  │   我再想想   │    │   确认注销   │                            │    │
    │  │  └──────────────┘    └──────────────┘                            │    │
    │  │                                                                  │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    │  ┌─ 冷静期阶段（注销申请已提交后显示） ─────────────────────────────┐    │
    │  │                                                                  │    │
    │  │  您的注销申请已提交，冷静期剩余：6天23小时                       │    │
    │  │  冷静期结束后账号将被自动注销                                    │    │
    │  │                                                                  │    │
    │  │  ┌──────────────┐                                                │    │
    │  │  │   撤销注销   │                                                │    │
    │  │  └──────────────┘                                                │    │
    │  │                                                                  │    │
    │  └──────────────────────────────────────────────────────────────────┘    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.4.4-1 账号注销页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                     | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | ---------------------------------------- | --------- | ------------- |
    | F01      | 展示     | 加载注销状态 | 进入页面时检查是否已有未完成的注销申请   | UC-USR-01 | authenticated |
    | F02      | 操作     | 获取验证码   | 发送手机/邮箱验证码，60秒倒计时          | PUB-06    | authenticated |
    | F03      | 操作     | 我再想想     | 放弃注销，返回账号安全页                 | -         | authenticated |
    | F04      | 操作     | 确认注销     | 验证码校验通过后提交注销申请，进入冷静期 | UC-USR-03 | authenticated |
    | F05      | 操作     | 撤销注销     | 冷静期内撤销注销申请，恢复正常状态       | UC-USR-04 | authenticated |

    表 3.6.4.4-1 账号注销页功能说明

+   交互规则：
    -   页面分为两个阶段：申请注销阶段显示获取验证码、我再想想、确认注销三个按钮；冷静期阶段显示撤销注销按钮和倒计时提示
    -   冷静期为7天，期间用户可随时撤销注销申请

### 3.6.5 公共页面

#### 3.6.5.1 PG-PUB-01 激活账号页

+   页面说明：
    -   用途：用户通过激活验证码链接激活账号并设置密码
    -   入口：管理员发送的激活验证码
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-01 激活账号页                                                    │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │           LOGO               │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │         激活账号             │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  欢迎，您的账号即将激活      │                    │
    │                      │  请设置您的登录密码          │                    │
    │                      │                              │                    │
    │                      │  新密码 *                    │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  确认密码 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │       激活账号         │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.5.1-1 激活账号页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                      | 关联API | 前置条件     |
    | -------- | -------- | ------------ | ----------------------------------------- | ------- | ------------ |
    | F01      | 展示     | 解析激活令牌 | 进入页面时解析URL中的激活令牌，校验有效性 | -       | -            |
    | F02      | 操作     | 激活账号     | 设置密码并激活账号，成功后跳转登录页      | PUB-03  | 必填校验通过 |

    表 3.6.5.1-1 激活账号页功能说明

+   交互规则：
    -   激活令牌无效或已过期时，显示错误提示并提供"重新发送激活验证码"链接
    -   密码需满足密码策略（长度、复杂度），不满足时实时提示

#### 3.6.5.2 PG-PUB-02 忘记密码页

+   页面说明：
    -   用途：用户忘记密码时，通过手机或邮箱验证身份
    -   入口：登录页 → 忘记密码
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-02 忘记密码页                                                    │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │           LOGO               │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │         忘记密码             │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  请选择您的身份类型          │                    │
    │                      │  ┌───────────┬───────────┐   │                    │
    │                      │  │ 平台用户  │ 企业用户  │   │                    │
    │                      │  └───────────┴───────────┘   │                    │
    │                      │                              │                    │
    │                      │  邮箱 *                      │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  租户编码 *（企业用户时显示）│                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │        下一步          │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  记起密码了？返回登录        │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.5.2-1 忘记密码页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                                       | 关联API | 前置条件     |
    | -------- | -------- | -------- | ------------------------------------------ | ------- | ------------ |
    | F01      | 展示     | 加载页面 | 进入页面时默认选中平台用户Tab              | -       | -            |
    | F02      | 操作     | 平台用户 | 切换到平台用户Tab，隐藏租户编码字段        | -       | -            |
    | F03      | 操作     | 企业用户 | 切换到企业用户Tab，显示租户编码字段        | -       | -            |
    | F04      | 操作     | 下一步   | 发送重置密码邮件，成功后显示邮件已发送提示 | PUB-04  | 必填校验通过 |
    | F05      | 操作     | 返回登录 | 跳转登录页                                 | -       | -            |

    表 3.6.5.2-1 忘记密码页功能说明

+   交互规则：
    -   选择企业用户时，需额外输入租户编码以定位租户
    -   邮件发送成功后显示提示页面，告知用户检查邮箱

#### 3.6.5.3 PG-PUB-03 重置密码页

+   页面说明：
    -   用途：用户通过重置邮件链接设置新密码
    -   入口：重置密码邮件中的链接
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-03 重置密码页                                                    │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │           LOGO               │                    │
    │                      └──────────────────────────────┘                    │
    │                      ┌──────────────────────────────┐                    │
    │                      │         重置密码             │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  请设置您的新密码            │                    │
    │                      │                              │                    │
    │                      │  新密码 *                    │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  确认密码 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │       重置密码         │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.5.3-1 重置密码页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                         | 关联API | 前置条件     |
    | -------- | -------- | -------------- | ---------------------------- | ------- | ------------ |
    | F01      | 展示     | 输入重置验证码 | 用户输入收到的重置验证码     | -       | -            |
    | F02      | 操作     | 重置密码       | 设置新密码，成功后跳转登录页 | PUB-05  | 必填校验通过 |

    表 3.6.5.3-1 重置密码页功能说明

+   交互规则：
    -   重置验证码无效或已过期时，显示错误提示并提供"重新找回密码"链接
    -   密码需满足密码策略（长度、复杂度），两次输入需一致

#### 3.6.5.4 PG-PUB-04 企业试用申请页

+   页面说明：
    -   用途：企业用户申请免费试用
    -   入口：官网 → 免费试用
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-04 企业试用申请页                                                │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │           LOGO               │                    │
    │                      └──────────────────────────────┘                    │
    │                      ┌──────────────────────────────┐                    │
    │                      │       企业免费试用           │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  企业名称 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  联系人 *        职位        │                    │
    │                      │  ┌────────────┐ ┌──────────┐ │                    │
    │                      │  │            │ │          │ │                    │
    │                      │  └────────────┘ └──────────┘ │                    │
    │                      │                              │                    │
    │                      │  手机号 *        验证码      │                    │
    │                      │  ┌────────────┐ ┌────┬─────┐ │                    │
    │                      │  │            │ │    │获取 │ │                    │
    │                      │  └────────────┘ └────┴─────┘ │                    │
    │                      │                              │                    │
    │                      │  企业邮箱 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  企业规模                    │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │ 请选择            ▼   │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │       提交申请         │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.5.4-1 企业试用申请页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称   | 说明                                         | 关联API | 前置条件     |
    | -------- | -------- | ---------- | -------------------------------------------- | ------- | ------------ |
    | F01      | 展示     | 加载页面   | 进入页面时加载企业规模选项枚举               | -       | -            |
    | F02      | 操作     | 获取验证码 | 发送手机验证码，60秒倒计时                   | PUB-06  | -            |
    | F03      | 操作     | 提交申请   | 校验通过后提交试用申请，成功后显示提交成功页 | PUB-07  | 必填校验通过 |

    表 3.6.5.4-1 企业试用申请页功能说明

+   交互规则：
    -   获取验证码后进入60秒倒计时，倒计时期间按钮置灰不可点击
    -   提交成功后跳转至申请成功提示页，告知审核周期

#### 3.6.5.5 PG-PUB-05 租户用户注册页

+   页面说明：
    -   用途：企业员工使用企业邮箱自助注册
    -   入口：租户登录页 → 注册入口
    -   权限：无需登录

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  PG-PUB-05 租户用户注册页                                                │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │                      ┌──────────────────────────────┐                    │
    │                      │        {租户名称} LOGO       │                    │
    │                      └──────────────────────────────┘                    │
    │                      ┌──────────────────────────────┐                    │
    │                      │       员工自助注册           │                    │
    │                      ├──────────────────────────────┤                    │
    │                      │                              │                    │
    │                      │  企业邮箱 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  邮箱验证码                  │                    │
    │                      │  ┌────────────────┬───────┐  │                    │
    │                      │  │                │ 获取  │  │                    │
    │                      │  └────────────────┴───────┘  │                    │
    │                      │                              │                    │
    │                      │  用户名 *                    │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  姓名 *                      │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  设置密码 *                  │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │                        │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  ┌────────────────────────┐  │                    │
    │                      │  │       立即注册         │  │                    │
    │                      │  └────────────────────────┘  │                    │
    │                      │                              │                    │
    │                      │  已有账号？返回登录          │                    │
    │                      │                              │                    │
    │                      └──────────────────────────────┘                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.6.5.5-1 租户用户注册页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                            | 关联API | 前置条件                         |
    | -------- | -------- | ------------ | ----------------------------------------------- | ------- | -------------------------------- |
    | F01      | 展示     | 加载租户信息 | 进入页面时根据URL中的租户编码加载租户名称和LOGO | -       | -                                |
    | F02      | 操作     | 获取验证码   | 发送邮箱验证码，60秒倒计时                      | PUB-06  | -                                |
    | F03      | 操作     | 立即注册     | 校验通过后提交注册，成功后跳转登录页            | PUB-02  | 必填校验通过且租户已开启开放注册 |
    | F04      | 操作     | 返回登录     | 跳转租户登录页                                  | -       | -                                |

    表 3.6.5.5-1 租户用户注册页功能说明

+   交互规则：
    -   注册前需校验邮箱域名是否匹配当前租户配置
    -   租户未开启开放注册时，页面显示提示信息并禁用注册表单
    -   获取验证码后进入60秒倒计时，倒计时期间按钮置灰不可点击

### 3.6.6 页面与接口映射

+   用户管理子领域页面与后端接口的映射关系如下表所示。

    | 页面编号     | 页面功能       | 调用接口                     |
    | ------------ | -------------- | ---------------------------- |
    | PG-P-USR-01  | 加载列表       | P-USR-02 查询用户列表        |
    | PG-P-USR-01  | 搜索           | P-USR-02 查询用户列表        |
    | PG-P-USR-01  | 查看           | P-USR-03 查询用户详情        |
    | PG-P-USR-01  | 编辑           | P-USR-04 更新用户信息        |
    | PG-P-USR-01  | 禁用           | P-USR-06 禁用用户            |
    | PG-P-USR-01  | 删除           | P-USR-05 删除用户            |
    | PG-P-USR-01  | 重发激活验证码 | P-USR-09 重发激活验证码      |
    | PG-P-USR-01  | 启用           | P-USR-07 启用用户            |
    | PG-P-USR-02  | 加载角色列表   | P-PERM-02 查询角色列表       |
    | PG-P-USR-02  | 提交           | P-USR-01 创建用户            |
    | PG-P-USR-03  | 加载用户详情   | P-USR-03 查询用户详情        |
    | PG-P-USR-03  | 协助重置密码   | P-USR-08 管理员协助重置密码  |
    | PG-UR-USR-01 | 加载列表       | UR-USR-02 查询用户列表       |
    | PG-UR-USR-01 | 搜索           | UR-USR-02 查询用户列表       |
    | PG-UR-USR-01 | 查看           | UR-USR-03 查询用户详情       |
    | PG-UR-USR-01 | 编辑           | UR-USR-04 更新用户信息       |
    | PG-UR-USR-01 | 禁用           | UR-USR-06 禁用用户           |
    | PG-UR-USR-01 | 删除           | UR-USR-05 删除用户           |
    | PG-UR-USR-01 | 重发激活验证码 | UR-USR-09 重发激活验证码     |
    | PG-UR-USR-01 | 启用           | UR-USR-07 启用用户           |
    | PG-UR-USR-02 | 加载组织树     | UR-ORG-06 查询组织树         |
    | PG-UR-USR-02 | 加载岗位列表   | UR-POS-06 分页查询岗位       |
    | PG-UR-USR-02 | 加载角色列表   | UR-PERM-02 查询角色列表      |
    | PG-UR-USR-02 | 提交           | UR-USR-01 创建用户           |
    | PG-UR-USR-03 | 加载用户详情   | UR-USR-03 查询用户详情       |
    | PG-UR-USR-03 | 协助重置密码   | UR-USR-08 管理员协助重置密码 |
    | PG-UR-USR-03 | 分配组织岗位   | UR-USR-10 分配组织岗位       |
    | PG-UR-USR-04 | 加载个人信息   | UR-USR-11 获取当前用户信息   |
    | PG-UR-USR-04 | 编辑资料       | UR-USR-12 更新当前用户信息   |
    | PG-UR-USR-04 | 修改密码       | UR-USR-12 更新当前用户信息   |
    | PG-UR-USR-04 | 注销账号       | UR-USR-13 用户自助注销       |
    | PG-UC-USR-01 | 获取验证码     | PUB-06 发送验证码            |
    | PG-UC-USR-01 | 立即注册       | PUB-01 个人用户注册          |
    | PG-UC-USR-01 | QQ注册         | PUB-08 获取OAuth授权URL      |
    | PG-UC-USR-01 | 微信注册       | PUB-08 获取OAuth授权URL      |
    | PG-UC-USR-01 | 钉钉注册       | PUB-08 获取OAuth授权URL      |
    | PG-UC-USR-02 | 加载个人信息   | UC-USR-01 获取当前用户信息   |
    | PG-UC-USR-02 | 编辑资料       | UC-USR-02 更新当前用户信息   |
    | PG-UC-USR-03 | 加载安全信息   | UC-USR-01 获取当前用户信息   |
    | PG-UC-USR-03 | 加载三方绑定   | UC-USR-05 获取三方绑定列表   |
    | PG-UC-USR-03 | 修改密码       | UC-USR-08 设置/修改密码      |
    | PG-UC-USR-03 | 更换手机       | UC-USR-02 更新当前用户信息   |
    | PG-UC-USR-03 | 绑定邮箱       | UC-USR-02 更新当前用户信息   |
    | PG-UC-USR-03 | 解绑QQ         | UC-USR-07 解绑三方账号       |
    | PG-UC-USR-03 | 绑定微信       | UC-USR-06 绑定三方账号       |
    | PG-UC-USR-03 | 绑定钉钉       | UC-USR-06 绑定三方账号       |
    | PG-UC-USR-04 | 加载注销状态   | UC-USR-01 获取当前用户信息   |
    | PG-UC-USR-04 | 获取验证码     | PUB-06 发送验证码            |
    | PG-UC-USR-04 | 确认注销       | UC-USR-03 申请注销           |
    | PG-UC-USR-04 | 撤销注销       | UC-USR-04 撤销注销           |
    | PG-PUB-01    | 激活账号       | PUB-03 激活账号              |
    | PG-PUB-02    | 下一步         | PUB-04 忘记密码              |
    | PG-PUB-03    | 重置密码       | PUB-05 重置密码              |
    | PG-PUB-04    | 获取验证码     | PUB-06 发送验证码            |
    | PG-PUB-04    | 提交申请       | PUB-07 申请企业试用          |
    | PG-PUB-05    | 获取验证码     | PUB-06 发送验证码            |
    | PG-PUB-05    | 立即注册       | PUB-02 租户用户开放注册      |

    表 3.6.6-1 页面与接口映射

### 3.6.7 功能操作汇总

+   用户管理子领域所有功能操作汇总如下表所示。

    | 功能编号         | 所属页面     | 功能类型 | 功能名称       | 关联API    | 权限标识                 |
    | ---------------- | ------------ | -------- | -------------- | ---------- | ------------------------ |
    | PG-P-USR-01.F01  | PG-P-USR-01  | 展示     | 加载列表       | P-USR-02   | provider:iam:user:list   |
    | PG-P-USR-01.F02  | PG-P-USR-01  | 操作     | 搜索           | P-USR-02   | provider:iam:user:list   |
    | PG-P-USR-01.F03  | PG-P-USR-01  | 操作     | 重置           | -          | -                        |
    | PG-P-USR-01.F04  | PG-P-USR-01  | 操作     | 新建           | -          | provider:iam:user:create |
    | PG-P-USR-01.F05  | PG-P-USR-01  | 操作     | 查看           | P-USR-03   | provider:iam:user:read   |
    | PG-P-USR-01.F06  | PG-P-USR-01  | 操作     | 编辑           | P-USR-04   | provider:iam:user:update |
    | PG-P-USR-01.F07  | PG-P-USR-01  | 操作     | 禁用           | P-USR-06   | provider:iam:user:update |
    | PG-P-USR-01.F08  | PG-P-USR-01  | 操作     | 删除           | P-USR-05   | provider:iam:user:delete |
    | PG-P-USR-01.F09  | PG-P-USR-01  | 操作     | 重发激活验证码 | P-USR-09   | provider:iam:user:update |
    | PG-P-USR-01.F10  | PG-P-USR-01  | 操作     | 启用           | P-USR-07   | provider:iam:user:update |
    | PG-P-USR-02.F01  | PG-P-USR-02  | 展示     | 加载角色列表   | P-PERM-02  | provider:iam:user:create |
    | PG-P-USR-02.F02  | PG-P-USR-02  | 操作     | 用户名唯一校验 | P-USR-02   | -                        |
    | PG-P-USR-02.F03  | PG-P-USR-02  | 操作     | 取消           | -          | -                        |
    | PG-P-USR-02.F04  | PG-P-USR-02  | 操作     | 提交           | P-USR-01   | provider:iam:user:create |
    | PG-P-USR-03.F01  | PG-P-USR-03  | 展示     | 加载用户详情   | P-USR-03   | provider:iam:user:read   |
    | PG-P-USR-03.F02  | PG-P-USR-03  | 操作     | 协助重置密码   | P-USR-08   | provider:iam:user:update |
    | PG-P-USR-03.F03  | PG-P-USR-03  | 操作     | 返回           | -          | -                        |
    | PG-UR-USR-01.F01 | PG-UR-USR-01 | 展示     | 加载列表       | UR-USR-02  | ur:iam:user:list         |
    | PG-UR-USR-01.F02 | PG-UR-USR-01 | 操作     | 搜索           | UR-USR-02  | ur:iam:user:list         |
    | PG-UR-USR-01.F03 | PG-UR-USR-01 | 操作     | 重置           | -          | -                        |
    | PG-UR-USR-01.F04 | PG-UR-USR-01 | 操作     | 新建           | -          | ur:iam:user:create       |
    | PG-UR-USR-01.F05 | PG-UR-USR-01 | 操作     | 查看           | UR-USR-03  | ur:iam:user:read         |
    | PG-UR-USR-01.F06 | PG-UR-USR-01 | 操作     | 编辑           | UR-USR-04  | ur:iam:user:update       |
    | PG-UR-USR-01.F07 | PG-UR-USR-01 | 操作     | 禁用           | UR-USR-06  | ur:iam:user:update       |
    | PG-UR-USR-01.F08 | PG-UR-USR-01 | 操作     | 删除           | UR-USR-05  | ur:iam:user:delete       |
    | PG-UR-USR-01.F09 | PG-UR-USR-01 | 操作     | 重发激活验证码 | UR-USR-09  | ur:iam:user:update       |
    | PG-UR-USR-01.F10 | PG-UR-USR-01 | 操作     | 启用           | UR-USR-07  | ur:iam:user:update       |
    | PG-UR-USR-02.F01 | PG-UR-USR-02 | 展示     | 加载组织树     | UR-ORG-06  | ur:iam:user:create       |
    | PG-UR-USR-02.F02 | PG-UR-USR-02 | 展示     | 加载岗位列表   | UR-POS-06  | ur:iam:user:create       |
    | PG-UR-USR-02.F03 | PG-UR-USR-02 | 展示     | 加载角色列表   | UR-PERM-02 | ur:iam:user:create       |
    | PG-UR-USR-02.F04 | PG-UR-USR-02 | 操作     | 用户名唯一校验 | UR-USR-02  | -                        |
    | PG-UR-USR-02.F05 | PG-UR-USR-02 | 操作     | 取消           | -          | -                        |
    | PG-UR-USR-02.F06 | PG-UR-USR-02 | 操作     | 提交           | UR-USR-01  | ur:iam:user:create       |
    | PG-UR-USR-03.F01 | PG-UR-USR-03 | 展示     | 加载用户详情   | UR-USR-03  | ur:iam:user:read         |
    | PG-UR-USR-03.F02 | PG-UR-USR-03 | 操作     | 协助重置密码   | UR-USR-08  | ur:iam:user:update       |
    | PG-UR-USR-03.F03 | PG-UR-USR-03 | 操作     | 分配组织岗位   | UR-USR-10  | ur:iam:user:update       |
    | PG-UR-USR-03.F04 | PG-UR-USR-03 | 操作     | 返回           | -          | -                        |
    | PG-UR-USR-04.F01 | PG-UR-USR-04 | 展示     | 加载个人信息   | UR-USR-11  | authenticated            |
    | PG-UR-USR-04.F02 | PG-UR-USR-04 | 操作     | 编辑资料       | UR-USR-12  | authenticated            |
    | PG-UR-USR-04.F03 | PG-UR-USR-04 | 操作     | 修改密码       | UR-USR-12  | authenticated            |
    | PG-UR-USR-04.F04 | PG-UR-USR-04 | 操作     | 注销账号       | UR-USR-13  | authenticated            |
    | PG-UC-USR-01.F01 | PG-UC-USR-01 | 展示     | 加载页面       | -          | -                        |
    | PG-UC-USR-01.F02 | PG-UC-USR-01 | 操作     | 手机注册       | -          | -                        |
    | PG-UC-USR-01.F03 | PG-UC-USR-01 | 操作     | 邮箱注册       | -          | -                        |
    | PG-UC-USR-01.F04 | PG-UC-USR-01 | 操作     | 获取验证码     | PUB-06     | -                        |
    | PG-UC-USR-01.F05 | PG-UC-USR-01 | 操作     | 立即注册       | PUB-01     | -                        |
    | PG-UC-USR-01.F06 | PG-UC-USR-01 | 操作     | QQ注册         | PUB-08     | -                        |
    | PG-UC-USR-01.F07 | PG-UC-USR-01 | 操作     | 微信注册       | PUB-08     | -                        |
    | PG-UC-USR-01.F08 | PG-UC-USR-01 | 操作     | 钉钉注册       | PUB-08     | -                        |
    | PG-UC-USR-01.F09 | PG-UC-USR-01 | 操作     | 立即登录       | -          | -                        |
    | PG-UC-USR-02.F01 | PG-UC-USR-02 | 展示     | 加载个人信息   | UC-USR-01  | authenticated            |
    | PG-UC-USR-02.F02 | PG-UC-USR-02 | 操作     | 编辑资料       | UC-USR-02  | authenticated            |
    | PG-UC-USR-02.F03 | PG-UC-USR-02 | 操作     | 账号安全       | -          | authenticated            |
    | PG-UC-USR-02.F04 | PG-UC-USR-02 | 操作     | 我的订阅       | -          | authenticated            |
    | PG-UC-USR-02.F05 | PG-UC-USR-02 | 操作     | 消息通知       | -          | authenticated            |
    | PG-UC-USR-03.F01 | PG-UC-USR-03 | 展示     | 加载安全信息   | UC-USR-01  | authenticated            |
    | PG-UC-USR-03.F02 | PG-UC-USR-03 | 展示     | 加载三方绑定   | UC-USR-05  | authenticated            |
    | PG-UC-USR-03.F03 | PG-UC-USR-03 | 操作     | 修改密码       | UC-USR-08  | authenticated            |
    | PG-UC-USR-03.F04 | PG-UC-USR-03 | 操作     | 更换手机       | UC-USR-02  | authenticated            |
    | PG-UC-USR-03.F05 | PG-UC-USR-03 | 操作     | 绑定邮箱       | UC-USR-02  | authenticated            |
    | PG-UC-USR-03.F06 | PG-UC-USR-03 | 操作     | 解绑QQ         | UC-USR-07  | authenticated            |
    | PG-UC-USR-03.F07 | PG-UC-USR-03 | 操作     | 绑定微信       | UC-USR-06  | authenticated            |
    | PG-UC-USR-03.F08 | PG-UC-USR-03 | 操作     | 绑定钉钉       | UC-USR-06  | authenticated            |
    | PG-UC-USR-03.F09 | PG-UC-USR-03 | 操作     | 注销账号       | -          | authenticated            |
    | PG-UC-USR-04.F01 | PG-UC-USR-04 | 展示     | 加载注销状态   | UC-USR-01  | authenticated            |
    | PG-UC-USR-04.F02 | PG-UC-USR-04 | 操作     | 获取验证码     | PUB-06     | authenticated            |
    | PG-UC-USR-04.F03 | PG-UC-USR-04 | 操作     | 我再想想       | -          | authenticated            |
    | PG-UC-USR-04.F04 | PG-UC-USR-04 | 操作     | 确认注销       | UC-USR-03  | authenticated            |
    | PG-UC-USR-04.F05 | PG-UC-USR-04 | 操作     | 撤销注销       | UC-USR-04  | authenticated            |
    | PG-PUB-01.F01    | PG-PUB-01    | 展示     | 解析激活令牌   | -          | -                        |
    | PG-PUB-01.F02    | PG-PUB-01    | 操作     | 激活账号       | PUB-03     | -                        |
    | PG-PUB-02.F01    | PG-PUB-02    | 展示     | 加载页面       | -          | -                        |
    | PG-PUB-02.F02    | PG-PUB-02    | 操作     | 平台用户       | -          | -                        |
    | PG-PUB-02.F03    | PG-PUB-02    | 操作     | 企业用户       | -          | -                        |
    | PG-PUB-02.F04    | PG-PUB-02    | 操作     | 下一步         | PUB-04     | -                        |
    | PG-PUB-02.F05    | PG-PUB-02    | 操作     | 返回登录       | -          | -                        |
    | PG-PUB-03.F01    | PG-PUB-03    | 展示     | 输入重置验证码 | -          | -                        |
    | PG-PUB-03.F02    | PG-PUB-03    | 操作     | 重置密码       | PUB-05     | -                        |
    | PG-PUB-04.F01    | PG-PUB-04    | 展示     | 加载页面       | -          | -                        |
    | PG-PUB-04.F02    | PG-PUB-04    | 操作     | 获取验证码     | PUB-06     | -                        |
    | PG-PUB-04.F03    | PG-PUB-04    | 操作     | 提交申请       | PUB-07     | -                        |
    | PG-PUB-05.F01    | PG-PUB-05    | 展示     | 加载租户信息   | -          | -                        |
    | PG-PUB-05.F02    | PG-PUB-05    | 操作     | 获取验证码     | PUB-06     | -                        |
    | PG-PUB-05.F03    | PG-PUB-05    | 操作     | 立即注册       | PUB-02     | -                        |
    | PG-PUB-05.F04    | PG-PUB-05    | 操作     | 返回登录       | -          | -                        |

    表 3.6.7-1 功能操作汇总

## 3.7 权限设计

+   本节设计用户管理子领域的权限模型，包括权限点定义、页面-功能-API映射和预置角色。
+   权限设计遵循RBAC模型，权限标识采用四段式命名格式。

### 3.7.1 权限模型

#### 3.7.1.1 权限标识格式

+   权限标识采用四段式命名格式：

    ```text
    {用户侧}:{限界上下文}:{资源}:{操作}
    ```

+   各段含义如下表所示：

    | 段位       | 说明                           | 取值示例                               |
    | ---------- | ------------------------------ | -------------------------------------- |
    | 用户侧     | 标识权限所属的用户群体         | UP / UR / UC                           |
    | 限界上下文 | 对应DDD中的限界上下文          | iam / org / tenant                     |
    | 资源       | 操作的目标资源，通常对应聚合根 | user / role / permission               |
    | 操作       | 对资源执行的动作               | create / read / update / delete / list |

    表 3.7.1.1-1 权限标识四段式格式

+   示例：
    -   `provider:iam:user:create` - 运营用户群用户管理-创建用户
    -   `ur:iam:user:list` - 租户用户群用户管理-查询用户列表
    -   `ur:org:department:update` - 租户用户群组织管理-更新部门

#### 3.7.1.2 权限类型

+   权限分为三种类型：

    | 权限类型 | 说明                  | 控制层级       |
    | -------- | --------------------- | -------------- |
    | 页面权限 | 控制页面/菜单的可见性 | 前端路由       |
    | 功能权限 | 控制按钮/操作的可用性 | 前端按钮 + API |
    | 数据权限 | 控制数据的可见范围    | API查询条件    |

    表 3.7.1.2-1 权限类型

+   本子领域主要涉及页面权限和功能权限，数据权限在租户用户群按组织架构控制。

#### 3.7.1.3 权限控制层级

+   权限在前后端分别控制：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          权限控制层级                                       │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   前端控制                                    后端控制                      │
    │  ┌─────────────────────────┐              ┌─────────────────────────┐       │
    │  │                         │              │                         │       │
    │  │  路由守卫               │              │  API网关                │       │
    │  │  ┌───────────────────┐  │              │  ┌───────────────────┐  │       │
    │  │  │ 检查页面权限      │  │              │  │ Token验证         │  │       │
    │  │  │ 无权限→重定向     │  │              │  │ 无效→401          │  │       │
    │  │  └───────────────────┘  │              │  └───────────────────┘  │       │
    │  │           │             │              │           │             │       │
    │  │           ▼             │              │           ▼             │       │
    │  │  页面渲染               │              │  业务服务               │       │
    │  │  ┌───────────────────┐  │              │  ┌───────────────────┐  │       │
    │  │  │ 检查功能权限      │  │   ─────▶     │  │ 检查功能权限      │  │       │
    │  │  │ 无权限→隐藏按钮   │  │    API调用   │  │ 无权限→403        │  │       │
    │  │  └───────────────────┘  │              │  └───────────────────┘  │       │
    │  │                         │              │           │             │       │
    │  │                         │              │           ▼             │       │
    │  │                         │              │  ┌───────────────────┐  │       │
    │  │                         │              │  │ 检查数据权限      │  │       │
    │  │                         │              │  │ 过滤数据范围      │  │       │
    │  │                         │              │  └───────────────────┘  │       │
    │  │                         │              │                         │       │
    │  └─────────────────────────┘              └─────────────────────────┘       │
    │                                                                             │
    │   说明：前端控制用户体验，后端控制安全兜底                                  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.7.1.3-1 权限控制层级

### 3.7.2 权限点清单

#### 3.7.2.1 运营用户群权限点（provider）

+   运营用户群用户管理权限点清单：

    | 权限标识                 | 权限名称     | 权限类型  | 说明                       |
    | ------------------------ | ------------ | --------- | -------------------------- |
    | provider:iam:user:list   | 查询用户列表 | 页面+功能 | 访问用户管理页面，查询列表 |
    | provider:iam:user:read   | 查看用户详情 | 功能      | 查看单个用户详情           |
    | provider:iam:user:create | 创建用户     | 功能      | 创建新用户                 |
    | provider:iam:user:update | 更新用户     | 功能      | 编辑、禁用、启用、重置密码 |
    | provider:iam:user:delete | 删除用户     | 功能      | 删除用户                   |

    表 3.7.2.1-1 运营用户群用户管理权限点

#### 3.7.2.2 租户用户群权限点（ur）

+   租户用户群用户管理权限点清单：

    | 权限标识           | 权限名称     | 权限类型  | 说明                       |
    | ------------------ | ------------ | --------- | -------------------------- |
    | ur:iam:user:list   | 查询用户列表 | 页面+功能 | 访问用户管理页面，查询列表 |
    | ur:iam:user:read   | 查看用户详情 | 功能      | 查看单个用户详情           |
    | ur:iam:user:create | 创建用户     | 功能      | 创建新用户                 |
    | ur:iam:user:update | 更新用户     | 功能      | 编辑、禁用、启用、分配组织 |
    | ur:iam:user:delete | 删除用户     | 功能      | 删除用户                   |

    表 3.7.2.2-1 租户用户群用户管理权限点

#### 3.7.2.3 C端用户群权限说明（uc）

+   C端用户群（UC）不使用RBAC权限模型，采用以下控制方式：

    | 控制类型      | 控制方式     | 说明                 |
    | ------------- | ------------ | -------------------- |
    | authenticated | 登录状态判断 | 登录即可访问         |
    | 订阅级别      | 订阅等级判断 | 部分功能需要付费订阅 |
    | 业务规则      | 业务逻辑判断 | 如注销需验证身份     |

    表 3.7.2.3-1 C端用户群权限控制方式

### 3.7.3 页面-功能-API-权限映射表

#### 3.7.3.1 运营用户群映射表

+   运营用户群页面-功能-API-权限完整映射：

    | 页面编号    | 功能名称     | API编号  | API路径                               | 权限标识                 |
    | ----------- | ------------ | -------- | ------------------------------------- | ------------------------ |
    | PG-P-USR-01 | 访问页面     | -        | -                                     | provider:iam:user:list   |
    | PG-P-USR-01 | 搜索         | P-USR-02 | GET /api/v1/up/iam/users              | provider:iam:user:list   |
    | PG-P-USR-01 | 重置         | -        | -                                     | -                        |
    | PG-P-USR-01 | 新建         | -        | -                                     | provider:iam:user:create |
    | PG-P-USR-01 | 查看         | P-USR-03 | GET /api/v1/up/iam/users/{id}         | provider:iam:user:read   |
    | PG-P-USR-01 | 编辑         | P-USR-04 | PUT /api/v1/up/iam/users/{id}         | provider:iam:user:update |
    | PG-P-USR-01 | 禁用         | P-USR-06 | POST .../users/{id}/disable           | provider:iam:user:update |
    | PG-P-USR-01 | 删除         | P-USR-05 | DELETE /api/v1/up/iam/users/{id}      | provider:iam:user:delete |
    | PG-P-USR-01 | 重发激活     | P-USR-09 | POST .../users/{id}/resend-activation | provider:iam:user:update |
    | PG-P-USR-01 | 启用         | P-USR-07 | POST .../users/{id}/enable            | provider:iam:user:update |
    | PG-P-USR-02 | 访问页面     | -        | -                                     | provider:iam:user:create |
    | PG-P-USR-02 | 取消         | -        | -                                     | -                        |
    | PG-P-USR-02 | 提交         | P-USR-01 | POST /api/v1/up/iam/users             | provider:iam:user:create |
    | PG-P-USR-03 | 访问页面     | P-USR-03 | GET /api/v1/up/iam/users/{id}         | provider:iam:user:read   |
    | PG-P-USR-03 | 协助重置密码 | P-USR-08 | POST .../users/{id}/reset-password    | provider:iam:user:update |
    | PG-P-USR-03 | 返回         | -        | -                                     | -                        |

    表 3.7.3.1-1 运营用户群页面-功能-API-权限映射

#### 3.7.3.2 租户用户群映射表

+   租户用户群页面-功能-API-权限完整映射：

    | 页面编号     | 功能名称     | API编号   | API路径                               | 权限标识           |
    | ------------ | ------------ | --------- | ------------------------------------- | ------------------ |
    | PG-UR-USR-01 | 访问页面     | -         | -                                     | ur:iam:user:list   |
    | PG-UR-USR-01 | 搜索         | UR-USR-02 | GET/api/v1/ur/iam/users               | ur:iam:user:list   |
    | PG-UR-USR-01 | 重置         | -         | -                                     | -                  |
    | PG-UR-USR-01 | 新建         | -         | -                                     | ur:iam:user:create |
    | PG-UR-USR-01 | 查看         | UR-USR-03 | GET/api/v1/ur/iam/users/{id}          | ur:iam:user:read   |
    | PG-UR-USR-01 | 编辑         | UR-USR-04 | PUT/api/v1/ur/iam/users/{id}          | ur:iam:user:update |
    | PG-UR-USR-01 | 禁用         | UR-USR-06 | POST .../users/{id}/disable           | ur:iam:user:update |
    | PG-UR-USR-01 | 删除         | UR-USR-05 | DELETE/api/v1/ur/iam/users/{id}       | ur:iam:user:delete |
    | PG-UR-USR-01 | 重发激活     | UR-USR-09 | POST .../users/{id}/resend-activation | ur:iam:user:update |
    | PG-UR-USR-01 | 启用         | UR-USR-07 | POST .../users/{id}/enable            | ur:iam:user:update |
    | PG-UR-USR-02 | 访问页面     | -         | -                                     | ur:iam:user:create |
    | PG-UR-USR-02 | 取消         | -         | -                                     | -                  |
    | PG-UR-USR-02 | 提交         | UR-USR-01 | POST/api/v1/ur/iam/users              | ur:iam:user:create |
    | PG-UR-USR-03 | 访问页面     | UR-USR-03 | GET/api/v1/ur/iam/users/{id}          | ur:iam:user:read   |
    | PG-UR-USR-03 | 协助重置密码 | UR-USR-08 | POST .../users/{id}/reset-password    | ur:iam:user:update |
    | PG-UR-USR-03 | 分配组织岗位 | UR-USR-10 | POST .../users/{id}/assign-org        | ur:iam:user:update |
    | PG-UR-USR-03 | 返回         | -         | -                                     | -                  |
    | PG-UR-USR-04 | 访问页面     | UR-USR-11 | GET/api/v1/ur/iam/users/me            | authenticated      |
    | PG-UR-USR-04 | 编辑资料     | UR-USR-12 | PUT/api/v1/ur/iam/users/me            | authenticated      |
    | PG-UR-USR-04 | 修改密码     | UR-USR-12 | PUT/api/v1/ur/iam/users/me            | authenticated      |
    | PG-UR-USR-04 | 注销账号     | UR-USR-13 | POST .../users/me/cancel              | authenticated      |

    表 3.7.3.2-1 租户用户群页面-功能-API-权限映射

#### 3.7.3.3 C端用户群映射表

+   C端用户群页面-功能-API-权限完整映射：

    | 页面编号     | 功能名称     | API编号   | API路径                               | 权限标识      |
    | ------------ | ------------ | --------- | ------------------------------------- | ------------- |
    | PG-UC-USR-01 | 访问页面     | -         | -                                     | -             |
    | PG-UC-USR-01 | 手机注册     | -         | -                                     | -             |
    | PG-UC-USR-01 | 邮箱注册     | -         | -                                     | -             |
    | PG-UC-USR-01 | 获取验证码   | PUB-06    | POST /api/v1/public/iam/captcha/send  | -             |
    | PG-UC-USR-01 | 立即注册     | PUB-01    | POST .../register/consumer            | -             |
    | PG-UC-USR-01 | QQ注册       | PUB-08    | GET .../oauth/qq/url                  | -             |
    | PG-UC-USR-01 | 微信注册     | PUB-08    | GET .../oauth/wechat/url              | -             |
    | PG-UC-USR-01 | 钉钉注册     | PUB-08    | GET .../oauth/dingtalk/url            | -             |
    | PG-UC-USR-02 | 访问页面     | UC-USR-01 | GET  /api/v1/uc/iam/users/me          | authenticated |
    | PG-UC-USR-02 | 编辑资料     | UC-USR-02 | PUT  /api/v1/uc/iam/users/me          | authenticated |
    | PG-UC-USR-02 | 账号安全     | -         | -                                     | authenticated |
    | PG-UC-USR-02 | 我的订阅     | -         | -                                     | authenticated |
    | PG-UC-USR-02 | 消息通知     | -         | -                                     | authenticated |
    | PG-UC-USR-03 | 访问页面     | UC-USR-01 | GET  /api/v1/uc/iam/users/me          | authenticated |
    | PG-UC-USR-03 | 加载三方绑定 | UC-USR-05 | GET  /api/v1/uc/iam/users/me/oauth    | authenticated |
    | PG-UC-USR-03 | 修改密码     | UC-USR-08 | POST .../users/me/password            | authenticated |
    | PG-UC-USR-03 | 更换手机     | UC-USR-02 | PUT  /api/v1/uc/iam/users/me          | authenticated |
    | PG-UC-USR-03 | 绑定邮箱     | UC-USR-02 | PUT  /api/v1/uc/iam/users/me          | authenticated |
    | PG-UC-USR-03 | 解绑QQ       | UC-USR-07 | DELETE .../users/me/oauth/qq          | authenticated |
    | PG-UC-USR-03 | 绑定微信     | UC-USR-06 | POST .../users/me/oauth/wechat/bind   | authenticated |
    | PG-UC-USR-03 | 绑定钉钉     | UC-USR-06 | POST .../users/me/oauth/dingtalk/bind | authenticated |
    | PG-UC-USR-03 | 注销账号     | -         | -                                     | authenticated |
    | PG-UC-USR-04 | 访问页面     | -         | -                                     | authenticated |
    | PG-UC-USR-04 | 获取验证码   | PUB-06    | POST /api/v1/public/iam/captcha/send  | authenticated |
    | PG-UC-USR-04 | 我再想想     | -         | -                                     | authenticated |
    | PG-UC-USR-04 | 确认注销     | UC-USR-03 | POST .../users/me/cancel              | authenticated |
    | PG-UC-USR-04 | 撤销注销     | UC-USR-04 | POST .../users/me/cancel/revoke       | authenticated |

    表 3.7.3.3-1 C端用户群页面-功能-API-权限映射

#### 3.7.3.4 公共页面映射表

+   公共页面-功能-API-权限完整映射：

    | 页面编号  | 功能名称   | API编号 | API路径                                 | 权限标识 |
    | --------- | ---------- | ------- | --------------------------------------- | -------- |
    | PG-PUB-01 | 访问页面   | -       | -                                       | -        |
    | PG-PUB-01 | 激活账号   | PUB-03  | POST /api/v1/public/iam/activate        | -        |
    | PG-PUB-02 | 访问页面   | -       | -                                       | -        |
    | PG-PUB-02 | 平台用户   | -       | -                                       | -        |
    | PG-PUB-02 | 企业用户   | -       | -                                       | -        |
    | PG-PUB-02 | 下一步     | PUB-04  | POST /api/v1/public/iam/password/forgot | -        |
    | PG-PUB-03 | 访问页面   | -       | -                                       | -        |
    | PG-PUB-03 | 重置密码   | PUB-05  | POST /api/v1/public/iam/password/reset  | -        |
    | PG-PUB-04 | 访问页面   | -       | -                                       | -        |
    | PG-PUB-04 | 获取验证码 | PUB-06  | POST /api/v1/public/iam/captcha/send    | -        |
    | PG-PUB-04 | 提交申请   | PUB-07  | POST /api/v1/public/iam/trial/apply     | -        |
    | PG-PUB-05 | 访问页面   | -       | -                                       | -        |
    | PG-PUB-05 | 获取验证码 | PUB-06  | POST /api/v1/public/iam/captcha/send    | -        |
    | PG-PUB-05 | 立即注册   | PUB-02  | POST /api/v1/public/iam/register/tenant | -        |

    表 3.7.3.4-1 公共页面-功能-API-权限映射

### 3.7.4 预置角色与权限

#### 3.7.4.1 运营用户群预置角色

+   运营用户群预置角色及权限配置：

    | 角色编码             | 角色名称   | 包含权限                                                                                              | 说明               |
    | -------------------- | ---------- | ----------------------------------------------------------------------------------------------------- | ------------------ |
    | provider_super_admin | 超级管理员 | provider:iam:user:*，provider:iam:role:* ，provider:tenant:*                                          | 拥有所有权限       |
    | provider_admin       | 运营管理员 | provider:iam:user:list ，provider:iam:user:read ，provider:iam:user:create ，provider:iam:user:update | 用户管理（无删除） |
    | provider_support     | 客服专员   | provider:iam:user:list ，provider:iam:user:read                                                       | 仅查看权限         |

    表 3.7.4.1-1 运营用户群预置角色

#### 3.7.4.2 租户用户群预置角色

+   租户用户群预置角色及权限配置：

    | 角色编码        | 角色名称       | 包含权限                                                                      | 说明               |
    | --------------- | -------------- | ----------------------------------------------------------------------------- | ------------------ |
    | ur_super_admin  | 租户超级管理员 | ur:iam:user:*，ur:iam:role:* ，ur:org:*                                       | 拥有租户所有权限   |
    | ur_admin        | 管理员         | ur:iam:user:list ，ur:iam:user:read ，ur:iam:user:create ，ur:iam:user:update | 用户管理（无删除） |
    | ur_dept_manager | 部门经理       | ur:iam:user:list ，ur:iam:user:read                                           | 查看本部门用户     |
    | ur_user         | 普通员工       | -                                                                             | 无用户管理权限     |

    表 3.7.4.2-1 租户用户群预置角色

+   租户超级管理员特殊说明：
    -   租户开通时自动创建并分配给首个管理员
    -   该角色不可删除，不可修改权限
    -   一个租户至少保留一个超级管理员

#### 3.7.4.3 角色权限矩阵

+   运营用户群角色权限矩阵：

    | 权限点                   | 超级管理员 | 运营管理员 | 客服专员 |
    | ------------------------ | ---------- | ---------- | -------- |
    | provider:iam:user:list   | ✓          | ✓          | ✓        |
    | provider:iam:user:read   | ✓          | ✓          | ✓        |
    | provider:iam:user:create | ✓          | ✓          | -        |
    | provider:iam:user:update | ✓          | ✓          | -        |
    | provider:iam:user:delete | ✓          | -          | -        |

    表 3.7.4.3-1 运营用户群角色权限矩阵

+   租户用户群角色权限矩阵：

    | 权限点             | 超级管理员 | 管理员 | 部门经理  | 普通员工 |
    | ------------------ | ---------- | ------ | --------- | -------- |
    | ur:iam:user:list   | ✓          | ✓      | ✓(本部门) | -        |
    | ur:iam:user:read   | ✓          | ✓      | ✓(本部门) | -        |
    | ur:iam:user:create | ✓          | ✓      | -         | -        |
    | ur:iam:user:update | ✓          | ✓      | -         | -        |
    | ur:iam:user:delete | ✓          | -      | -         | -        |

    表 3.7.4.3-2 租户用户群角色权限矩阵

### 3.7.5 API权限配置

+   API权限配置汇总，用于后端权限校验：

    | API编号   | HTTP方法 | API路径                                       | 权限标识                 |
    | --------- | -------- | --------------------------------------------- | ------------------------ |
    | P-USR-01  | POST     | /api/v1/up/iam/users                          | provider:iam:user:create |
    | P-USR-02  | GET      | /api/v1/up/iam/users                          | provider:iam:user:list   |
    | P-USR-03  | GET      | /api/v1/up/iam/users/{id}                     | provider:iam:user:read   |
    | P-USR-04  | PUT      | /api/v1/up/iam/users/{id}                     | provider:iam:user:update |
    | P-USR-05  | DELETE   | /api/v1/up/iam/users/{id}                     | provider:iam:user:delete |
    | P-USR-06  | POST     | /api/v1/up/iam/users/{id}/disable             | provider:iam:user:update |
    | P-USR-07  | POST     | /api/v1/up/iam/users/{id}/enable              | provider:iam:user:update |
    | P-USR-08  | POST     | /api/v1/up/iam/users/{id}/reset-password      | provider:iam:user:update |
    | P-USR-09  | POST     | /api/v1/up/iam/users/{id}/resend-activation   | provider:iam:user:update |
    | UR-USR-01 | POST     | /api/v1/ur/iam/users                          | ur:iam:user:create       |
    | UR-USR-02 | GET      | /api/v1/ur/iam/users                          | ur:iam:user:list         |
    | UR-USR-03 | GET      | /api/v1/ur/iam/users/{id}                     | ur:iam:user:read         |
    | UR-USR-04 | PUT      | /api/v1/ur/iam/users/{id}                     | ur:iam:user:update       |
    | UR-USR-05 | DELETE   | /api/v1/ur/iam/users/{id}                     | ur:iam:user:delete       |
    | UR-USR-06 | POST     | /api/v1/ur/iam/users/{id}/disable             | ur:iam:user:update       |
    | UR-USR-07 | POST     | /api/v1/ur/iam/users/{id}/enable              | ur:iam:user:update       |
    | UR-USR-08 | POST     | /api/v1/ur/iam/users/{id}/reset-password      | ur:iam:user:update       |
    | UR-USR-09 | POST     | /api/v1/ur/iam/users/{id}/resend-activation   | ur:iam:user:update       |
    | UR-USR-10 | POST     | /api/v1/ur/iam/users/{id}/assign-org          | ur:iam:user:update       |
    | UR-USR-11 | GET      | /api/v1/ur/iam/users/me                       | authenticated            |
    | UR-USR-12 | PUT      | /api/v1/ur/iam/users/me                       | authenticated            |
    | UR-USR-13 | POST     | /api/v1/ur/iam/users/me/cancel                | authenticated            |
    | UC-USR-01 | GET      | /api/v1/uc/iam/users/me                       | authenticated            |
    | UC-USR-02 | PUT      | /api/v1/uc/iam/users/me                       | authenticated            |
    | UC-USR-03 | POST     | /api/v1/uc/iam/users/me/cancel                | authenticated            |
    | UC-USR-04 | POST     | /api/v1/uc/iam/users/me/cancel/revoke         | authenticated            |
    | UC-USR-05 | GET      | /api/v1/uc/iam/users/me/oauth                 | authenticated            |
    | UC-USR-06 | POST     | /api/v1/uc/iam/users/me/oauth/{provider}/bind | authenticated            |
    | UC-USR-07 | DELETE   | /api/v1/uc/iam/users/me/oauth/{provider}      | authenticated            |
    | UC-USR-08 | POST     | /api/v1/uc/iam/users/me/password              | authenticated            |
    | PUB-01    | POST     | /api/v1/public/iam/register/consumer          | 无                       |
    | PUB-02    | POST     | /api/v1/public/iam/register/tenant            | 无                       |
    | PUB-03    | POST     | /api/v1/public/iam/activate                   | 无                       |
    | PUB-04    | POST     | /api/v1/public/iam/password/forgot            | 无                       |
    | PUB-05    | POST     | /api/v1/public/iam/password/reset             | 无                       |
    | PUB-06    | POST     | /api/v1/public/iam/captcha/send               | 无                       |
    | PUB-07    | POST     | /api/v1/public/iam/trial/apply                | 无                       |
    | PUB-08    | GET      | /api/v1/public/iam/oauth/{provider}/url       | 无                       |
    | PUB-09    | POST     | /api/v1/public/iam/oauth/{provider}/callback  | 无                       |

    表 3.7.5-1 API权限配置汇总

+   权限标识说明：
    -   `无`：公开接口，无需登录
    -   `authenticated`：需要登录，但无需特定权限
    -   `{四段式权限}`：需要登录且拥有对应权限

## 3.8 后端工程结构设计

+   本节设计用户管理子领域的后端工程结构，包括模块划分、包结构和命名规范。
+   工程结构遵循DDD分层架构，采用Maven多模块组织。

### 3.8.1 模块划分

#### 3.8.1.1 BC-10 服务模块结构

+   BC-10 IAM服务采用Maven多模块结构：

    ```
    bc-10-iam/
    ├── pom.xml                          # 父POM
    ├── bc-10-iam-api/                   # API模块（对外暴露的接口定义）
    ├── bc-10-iam-application/           # 应用层模块
    ├── bc-10-iam-domain/                # 领域层模块
    ├── bc-10-iam-infrastructure/        # 基础设施层模块
    └── bc-10-iam-starter/               # 启动模块
    ```

    图 3.8.1.1-1 BC-10服务模块结构

+   模块职责说明：

    | 模块名称                 | 职责                         | 依赖关系                |
    | ------------------------ | ---------------------------- | ----------------------- |
    | bc-10-iam-api            | 对外API定义、DTO、Feign接口  | 无依赖                  |
    | bc-10-iam-domain         | 领域模型、领域服务、仓储接口 | 无依赖                  |
    | bc-10-iam-application    | 应用服务、命令/查询处理      | 依赖domain              |
    | bc-10-iam-infrastructure | 仓储实现、外部服务集成、配置 | 依赖domain、application |
    | bc-10-iam-starter        | Spring Boot启动、Controller  | 依赖所有模块            |

    表 3.8.1.1-1 模块职责说明

#### 3.8.1.2 模块依赖关系

+   模块依赖关系图：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          模块依赖关系图                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                        ┌─────────────────────┐                              │
    │                        │  bc-10-iam-starter  │                              │
    │                        │     (启动模块)      │                              │
    │                        └──────────┬──────────┘                              │
    │                                   │                                         │
    │                    ┌──────────────┼──────────────┐                          │
    │                    │              │              │                          │
    │                    ▼              ▼              ▼                          │
    │  ┌─────────────────────┐  ┌─────────────┐  ┌────────────────────────┐       │
    │  │ bc-10-iam-api       │  │             │  │bc-10-iam-infrastructure│       │
    │  │ (API定义)           │  │             │  │   (基础设施层)         │       │
    │  └─────────────────────┘  │             │  └──────────┬─────────────┘       │
    │                           │             │             │                     │
    │                           │             │             ▼                     │
    │                           │             │  ┌─────────────────────┐          │
    │                           │             │  │bc-10-iam-application│          │
    │                           │             │  │    (应用层)         │          │
    │                           │             │  └──────────┬──────────┘          │
    │                           │             │             │                     │
    │                           │             │             ▼                     │
    │                           │             │  ┌─────────────────────┐          │
    │                           │             └─▶│  bc-10-iam-domain   │          │
    │                           │                │    (领域层)         │          │
    │                           │                └─────────────────────┘          │
    │                           │                           ▲                     │
    │                           └───────────────────────────┘                     │
    │                                                                             │
    │   说明：箭头表示依赖方向，领域层不依赖任何模块                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 3.8.1.2-1 模块依赖关系图

### 3.8.2 包结构设计

#### 3.8.2.1 bc-10-iam-api 模块

+   API模块包结构：

    ```
    bc-10-iam-api/
    └── src/main/java/
        └── com/clarisphere/iam/api/
            ├── dto/                         # 数据传输对象
            │   ├── provider/                # 运营用户群DTO
            │   │   ├── request/             # 请求DTO
            │   │   │   ├── CreateUserRequest.java
            │   │   │   ├── UpdateUserRequest.java
            │   │   │   └── ResetPasswordRequest.java
            │   │   └── response/            # 响应DTO
            │   │       ├── UserResponse.java
            │   │       └── UserListResponse.java
            │   ├── tenant/                  # 租户用户群DTO
            │   │   ├── request/
            │   │   └── response/
            │   ├── org/                     # 组织DTO（详见第4章）
            │   ├── consumer/                # C端用户群DTO
            │   │   ├── request/
            │   │   └── response/
            │   └── common/                  # 公共DTO
            │       ├── request/
            │       └── response/
            ├── feign/                       # Feign客户端接口
            │   ├── ProviderUserClient.java
            │   ├── TenantUserClient.java
            │   └── ConsumerUserClient.java
            └── constant/                    # API常量
                ├── ApiPaths.java
                └── ApiHeaders.java
    ```

    图 3.8.2.1-1 API模块包结构

#### 3.8.2.2 bc-10-iam-domain 模块

+   领域层模块包结构：

    ```
    bc-10-iam-domain/
    └── src/main/java/
        └── com/clarisphere/iam/domain/
            ├── user/                        # 用户子领域
            │   ├── model/                   # 领域模型
            │   │   ├── aggregate/           # 聚合根
            │   │   │   ├── PlatformUser.java
            │   │   │   ├── TenantUser.java
            │   │   │   └── ConsumerUser.java
            │   │   ├── entity/              # 实体（如有）
            │   │   └── valueobject/         # 值对象
            │   │       ├── Credential.java
            │   │       ├── ContactInfo.java
            │   │       ├── UserStatus.java
            │   │       ├── UserSource.java
            │   │       ├── OAuthBinding.java
            │   │       └── SubscriptionLevel.java
            │   ├── repository/              # 仓储接口
            │   │   ├── PlatformUserRepository.java
            │   │   ├── TenantUserRepository.java
            │   │   └── ConsumerUserRepository.java
            │   ├── service/                 # 领域服务
            │   │   ├── UserCreationService.java
            │   │   ├── UserActivationService.java
            │   │   ├── PasswordService.java
            │   │   └── UserCancellationService.java
            │   ├── event/                   # 领域事件
            │   │   ├── UserCreated.java
            │   │   ├── UserActivated.java
            │   │   ├── TenantAdminActivated.java
            │   │   ├── UserPasswordChanged.java
            │   │   ├── UserDisabled.java
            │   │   ├── UserDeleted.java
            │   │   └── UserCancelled.java
            │   ├── specification/           # 规约
            │   │   ├── UsernameUniqueSpec.java
            │   │   └── EmailUniqueSpec.java
            │   └── exception/               # 领域异常
            │       ├── UserNotFoundException.java
            │       ├── UserAlreadyExistsException.java
            │       ├── InvalidVerificationCodeException.java
            │       └── PasswordPolicyViolationException.java
            ├── org/                         # 组织子领域（仅租户用户群，详见第4章）
            └── shared/                      # 共享内核
                ├── valueobject/             # 共享值对象
                │   ├── UserId.java
                │   ├── Email.java
                │   └── Mobile.java
                └── event/                   # 事件基类
                    └── DomainEvent.java
    ```

    图 3.8.2.2-1 领域层模块包结构

#### 3.8.2.3 bc-10-iam-application 模块

+   应用层模块包结构：

    ```
    bc-10-iam-application/
    └── src/main/java/
        └── com/clarisphere/iam/application/
            ├── user/                        # 用户应用服务
            │   ├── command/                 # 命令对象
            │   │   ├── CreatePlatformUserCommand.java
            │   │   ├── CreateTenantUserCommand.java
            │   │   ├── ActivateUserCommand.java
            │   │   ├── DisableUserCommand.java
            │   │   ├── ResetPasswordCommand.java
            │   │   └── CancelUserCommand.java
            │   ├── query/                   # 查询对象
            │   │   ├── UserQuery.java
            │   │   ├── UserListQuery.java
            │   │   └── UserDetailQuery.java
            │   ├── handler/                 # 命令/查询处理器
            │   │   ├── command/
            │   │   │   ├── CreatePlatformUserHandler.java
            │   │   │   ├── CreateTenantUserHandler.java
            │   │   │   ├── ActivateUserHandler.java
            │   │   │   └── ResetPasswordHandler.java
            │   │   └── query/
            │   │       ├── UserQueryHandler.java
            │   │       └── UserListQueryHandler.java
            │   ├── service/                 # 应用服务
            │   │   ├── PlatformUserAppService.java
            │   │   ├── TenantUserAppService.java
            │   │   ├── ConsumerUserAppService.java
            │   │   └── PublicUserAppService.java
            │   ├── assembler/               # DTO组装器
            │   │   ├── PlatformUserAssembler.java
            │   │   ├── TenantUserAssembler.java
            │   │   └── ConsumerUserAssembler.java
            │   └── eventhandler/            # 事件处理器
            │       ├── UserCreatedEventHandler.java
            │       └── UserActivatedEventHandler.java
            ├── org/                         # 组织管理（详见第4章）
            └── auth/                        # 认证相关应用服务
                └── service/
                    └── AuthAppService.java
    ```

    图 3.8.2.3-1 应用层模块包结构

#### 3.8.2.4 bc-10-iam-infrastructure 模块

+   基础设施层模块包结构：

    ```
    bc-10-iam-infrastructure/
    └── src/main/java/
        └── com/clarisphere/iam/infrastructure/
            ├── persistence/                 # 持久化实现
            │   ├── repository/              # 仓储实现
            │   │   ├── PlatformUserRepositoryImpl.java
            │   │   ├── TenantUserRepositoryImpl.java
            │   │   ├── TenantOrgRepositoryImpl.java  # 组织管理预留
            │   │   └── ConsumerUserRepositoryImpl.java
            │   ├── mapper/                  # MyBatis Mapper
            │   │   ├── PlatformUserMapper.java
            │   │   ├── TenantUserMapper.java
            │   │   ├── TenantOrgMapper.java  # 组织管理预留
            │   │   ├── ConsumerUserMapper.java
            │   │   └── OAuthBindingMapper.java
            │   ├── po/                      # 持久化对象
            │   │   ├── PlatformUserPO.java
            │   │   ├── TenantUserPO.java
            │   │   ├── TenantOrgPO.java  # 组织管理预留
            │   │   ├── ConsumerUserPO.java
            │   │   └── OAuthBindingPO.java
            │   ├── converter/               # PO-DO转换器
            │   │   ├── PlatformUserConverter.java
            │   │   ├── TenantUserConverter.java
            │   │   ├── TenantOrgConverter.java  # 组织管理预留
            │   │   └── ConsumerUserConverter.java
            │   └── datasource/              # 数据源配置
            │       ├── DynamicDataSource.java
            │       └── TenantDataSourceRouter.java
            ├── external/                    # 外部服务集成
            │   ├── notification/            # 通知服务
            │   │   ├── NotificationClient.java
            │   │   └── EmailNotificationAdapter.java
            │   ├── oauth/                   # 三方OAuth
            │   │   ├── OAuthClient.java
            │   │   ├── QQOAuthAdapter.java
            │   │   ├── WechatOAuthAdapter.java
            │   │   └── DingtalkOAuthAdapter.java
            │   └── sso/                     # 企业SSO
            │       └── SsoAdapter.java
            ├── event/                       # 事件基础设施
            │   ├── publisher/
            │   │   └── DomainEventPublisher.java
            │   └── store/
            │       └── EventStore.java
            ├── security/                    # 安全相关
            │   ├── PasswordEncoder.java
            │   └── TokenGenerator.java
            └── config/                      # 配置类
                ├── DataSourceConfig.java
                ├── MyBatisConfig.java
                └── SecurityConfig.java
    ```

    图 3.8.2.4-1 基础设施层模块包结构

#### 3.8.2.5 bc-10-iam-starter 模块

+   启动模块包结构：

    ```
    bc-10-iam-starter/
    └── src/main/java/
        └── com/clarisphere/iam/
            ├── IamApplication.java          # 启动类
            └── interfaces/                  # 接口层
                ├── web/                     # Web控制器
                │   ├── provider/            # 运营用户群API
                │   │   └── ProviderUserController.java
                │   ├── tenant/              # 租户用户群API
                │   │   ├── TenantUserController.java
                │   │   └── TenantOrgController.java  # 组织管理（详见第4章）
                │   ├── consumer/            # C端用户群API
                │   │   └── ConsumerUserController.java
                │   └── pub/                 # 公共API
                │       └── PublicUserController.java
                ├── facade/                  # 门面（Feign实现）
                │   └── UserFacadeImpl.java
                └── advice/                  # 全局处理
                    ├── GlobalExceptionHandler.java
                    └── ResponseAdvice.java
    ```

    图 3.8.2.5-1 启动模块包结构

### 3.8.3 完整目录树

+   BC-10 IAM服务完整目录树：

    ```
    bc-10-iam/
    ├── pom.xml
    │
    ├── bc-10-iam-api/
    │   ├── pom.xml
    │   └── src/main/java/com/clarisphere/iam/api/
    │       ├── dto/
    │       │   ├── provider/request/
    │       │   ├── provider/response/
    │       │   ├── tenant/request/
    │       │   ├── tenant/response/
    │       │   ├── consumer/request/
    │       │   ├── consumer/response/
    │       │   └── common/
    │       ├── feign/
    │       └── constant/
    │
    ├── bc-10-iam-domain/
    │   ├── pom.xml
    │   └── src/main/java/com/clarisphere/iam/domain/
    │       ├── user/
    │       │   ├── model/aggregate/
    │       │   ├── model/valueobject/
    │       │   ├── repository/
    │       │   ├── service/
    │       │   ├── event/
    │       │   ├── specification/
    │       │   └── exception/
    │       └── shared/
    │           ├── valueobject/
    │           └── event/
    │
    ├── bc-10-iam-application/
    │   ├── pom.xml
    │   └── src/main/java/com/clarisphere/iam/application/
    │       ├── user/
    │       │   ├── command/
    │       │   ├── query/
    │       │   ├── handler/command/
    │       │   ├── handler/query/
    │       │   ├── service/
    │       │   ├── assembler/
    │       │   └── eventhandler/
    │       └── auth/
    │
    ├── bc-10-iam-infrastructure/
    │   ├── pom.xml
    │   └── src/main/java/com/clarisphere/iam/infrastructure/
    │       ├── persistence/
    │       │   ├── repository/
    │       │   ├── mapper/
    │       │   ├── po/
    │       │   ├── converter/
    │       │   └── datasource/
    │       ├── external/
    │       │   ├── notification/
    │       │   ├── oauth/
    │       │   └── sso/
    │       ├── event/
    │       ├── security/
    │       └── config/
    │
    └── bc-10-iam-starter/
        ├── pom.xml
        └── src/
            ├── main/java/com/clarisphere/iam/
            │   ├── IamApplication.java
            │   └── interfaces/
            │       ├── web/provider/
            │       ├── web/tenant/
            │       ├── web/consumer/
            │       ├── web/pub/
            │       ├── facade/
            │       └── advice/
            └── main/resources/
                ├── application.yml
                ├── application-dev.yml
                ├── application-prod.yml
                └── mapper/
                    ├── PlatformUserMapper.xml
                    ├── TenantUserMapper.xml
                    └── ConsumerUserMapper.xml
    ```

    图 3.8.3-1 BC-10 IAM服务完整目录树

### 3.8.4 命名规范

#### 3.8.4.1 类命名规范

+   各层类命名规范：

    | 层级        | 类型        | 命名规范                  | 示例                       |
    | ----------- | ----------- | ------------------------- | -------------------------- |
    | API         | 请求DTO     | {Action}{Resource}Request | CreateUserRequest          |
    | API         | 响应DTO     | {Resource}Response        | UserResponse               |
    | API         | Feign客户端 | {Resource}Client          | ProviderUserClient         |
    | Domain      | 聚合根      | {Resource}                | PlatformUser               |
    | Domain      | 值对象      | {Name}                    | Credential、ContactInfo    |
    | Domain      | 仓储接口    | {Resource}Repository      | PlatformUserRepository     |
    | Domain      | 领域服务    | {Function}Service         | UserCreationService        |
    | Domain      | 领域事件    | {Resource}{Action}        | UserCreated、UserActivated |
    | Domain      | 规约        | {Rule}Spec                | UsernameUniqueSpec         |
    | Domain      | 异常        | {Error}Exception          | UserNotFoundException      |
    | Application | 命令        | {Action}{Resource}Command | CreatePlatformUserCommand  |
    | Application | 查询        | {Resource}Query           | UserListQuery              |
    | Application | 命令处理器  | {Action}{Resource}Handler | CreatePlatformUserHandler  |
    | Application | 应用服务    | {Resource}AppService      | PlatformUserAppService     |
    | Application | 组装器      | {Resource}Assembler       | PlatformUserAssembler      |
    | Infra       | 仓储实现    | {Resource}RepositoryImpl  | PlatformUserRepositoryImpl |
    | Infra       | Mapper      | {Resource}Mapper          | PlatformUserMapper         |
    | Infra       | 持久化对象  | {Resource}PO              | PlatformUserPO             |
    | Infra       | 转换器      | {Resource}Converter       | PlatformUserConverter      |
    | Starter     | 控制器      | {Resource}Controller      | ProviderUserController     |

    表 3.8.4.1-1 类命名规范

#### 3.8.4.2 方法命名规范

+   各层方法命名规范：

    | 层级       | 操作类型   | 命名规范                     | 示例                          |
    | ---------- | ---------- | ---------------------------- | ----------------------------- |
    | Controller | 创建       | create{Resource}             | createUser()                  |
    | Controller | 查询单个   | get{Resource}                | getUser()                     |
    | Controller | 查询列表   | list{Resource}s              | listUsers()                   |
    | Controller | 更新       | update{Resource}             | updateUser()                  |
    | Controller | 删除       | delete{Resource}             | deleteUser()                  |
    | Controller | 特定操作   | {action}{Resource}           | disableUser()、activateUser() |
    | AppService | 创建       | create{Resource}             | createUser()                  |
    | AppService | 查询       | get{Resource}/find{Resource} | getUser()、findUserByEmail()  |
    | AppService | 更新       | update{Resource}             | updateUser()                  |
    | AppService | 删除       | delete{Resource}             | deleteUser()                  |
    | Repository | 保存       | save                         | save(user)                    |
    | Repository | 查询       | findById/findBy{Field}       | findById()、findByEmail()     |
    | Repository | 删除       | delete/deleteById            | delete(user)、deleteById(id)  |
    | Repository | 存在性检查 | existsBy{Field}              | existsByEmail()               |

    表 3.8.4.2-1 方法命名规范

#### 3.8.4.3 包命名规范

+   包命名规范：

    | 规范项   | 规范说明                     | 示例                         |
    | -------- | ---------------------------- | ---------------------------- |
    | 基础包名 | com.clarisphere.{bc}.{layer} | com.clarisphere.iam.domain   |
    | 子领域包 | {基础包名}.{subdomain}       | ...domain.user               |
    | 功能包   | {子领域包}.{function}        | ...user.model                |
    | 全小写   | 包名全部使用小写字母         | valueobject（非valueObject） |
    | 单数形式 | 包名使用单数形式             | model（非models）            |

    表 3.8.4.3-1 包命名规范

### 3.8.5 类职责说明

+   关键类职责说明：

    | 类名                       | 所属层    | 职责                             |
    | -------------------------- | --------- | -------------------------------- |
    | PlatformUser               | Domain    | 平台用户聚合根，封装业务规则     |
    | PlatformUserRepository     | Domain    | 仓储接口，定义持久化契约         |
    | UserCreationService        | Domain    | 领域服务，处理跨聚合的创建逻辑   |
    | PasswordService            | Domain    | 领域服务，密码加密验证策略       |
    | CreatePlatformUserCommand  | App       | 命令对象，封装创建用户的输入     |
    | CreatePlatformUserHandler  | App       | 命令处理器，编排创建用户的流程   |
    | PlatformUserAppService     | App       | 应用服务，对外暴露用例           |
    | PlatformUserAssembler      | App       | 组装器，DO与DTO互转              |
    | PlatformUserRepositoryImpl | Infra     | 仓储实现，调用Mapper持久化       |
    | PlatformUserMapper         | Infra     | MyBatis Mapper，SQL操作          |
    | PlatformUserConverter      | Infra     | 转换器，PO与DO互转               |
    | DynamicDataSource          | Infra     | 动态数据源，支持多租户数据源切换 |
    | ProviderUserController     | Interface | 控制器，处理HTTP请求             |

    表 3.8.5-1 关键类职责说明

## 3.9 前端工程结构设计

+   本节设计用户管理子领域的前端工程结构，包括目录划分和命名规范。
+   技术栈：TypeScript + Vue 3 + Element Plus + Vite + Pinia

### 3.9.1 技术栈说明

+   前端技术栈选型：

    | 技术         | 版本要求 | 用途             |
    | ------------ | -------- | ---------------- |
    | Vue          | 3.4+     | 前端框架         |
    | TypeScript   | 5.0+     | 类型安全         |
    | Vite         | 5.0+     | 构建工具         |
    | Element Plus | 2.5+     | UI组件库         |
    | Pinia        | 2.1+     | 状态管理         |
    | Vue Router   | 4.2+     | 路由管理         |
    | Axios        | 1.6+     | HTTP请求         |
    | VueUse       | 10.0+    | 组合式函数工具库 |

    表 3.9.1-1 前端技术栈

### 3.9.2 目录结构设计

#### 3.9.2.1 整体目录结构

+   前端工程整体目录结构：

    ```
    clarisphere-web/
    ├── public/                          # 静态资源
    ├── src/
    │   ├── api/                         # API请求模块
    │   ├── assets/                      # 资源文件
    │   ├── components/                  # 公共组件
    │   ├── composables/                 # 组合式函数（hooks）
    │   ├── directives/                  # 自定义指令
    │   ├── layouts/                     # 布局组件
    │   ├── permission/                  # 权限控制
    │   ├── router/                      # 路由配置
    │   ├── stores/                      # Pinia状态管理
    │   ├── styles/                      # 全局样式
    │   ├── types/                       # TypeScript类型定义
    │   ├── utils/                       # 工具函数
    │   ├── views/                       # 页面组件
    │   ├── App.vue                      # 根组件
    │   └── main.ts                      # 入口文件
    ├── index.html                       # HTML模板
    ├── package.json                     # 依赖配置
    ├── tsconfig.json                    # TypeScript配置
    └── vite.config.ts                   # Vite配置
    ```

    图 3.9.2.1-1 前端工程整体目录结构

#### 3.9.2.2 API模块结构

+   API模块按限界上下文和用户群组织：

    ```
    src/api/
    ├── index.ts                         # API统一导出
    ├── request.ts                       # Axios封装
    ├── iam/                             # IAM限界上下文
    │   ├── index.ts                     # IAM API导出
    │   ├── types.ts                     # IAM类型定义
    │   ├── provider.ts                  # 运营用户群用户API
    │   ├── tenant.ts                    # 租户用户群用户API
    │   ├── consumer.ts                  # C端用户群用户API
    │   ├── public.ts                    # 公共API
    │   └── org.ts                       # 组织管理API（仅租户用户群，详见第4章）
    └── common/                          # 公共API
        ├── captcha.ts                   # 验证码API
        └── upload.ts                    # 文件上传API
    ```

    图 3.9.2.2-1 API模块结构

#### 3.9.2.3 类型定义结构

+   TypeScript类型定义模块结构：

    ```
    src/types/
    ├── index.ts                         # 类型统一导出
    ├── global.d.ts                      # 全局类型声明
    ├── common.ts                        # 通用类型
    └── iam/                             # IAM类型
        ├── index.ts                     # IAM类型导出
        ├── user.ts                      # 用户相关类型
        ├── enums.ts                     # 枚举类型
        ├── dto.ts                       # DTO类型
        └── org.ts                       # 组织相关类型（仅租户用户群，详见第4章）
    ```

    图 3.9.2.3-1 类型定义模块结构

#### 3.9.2.4 页面组件结构

+   页面组件按用户群组织：

    ```
    src/views/
    ├── iam/                             # IAM模块页面
    │   ├── provider/                    # 运营用户群页面
    │   │   ├── user/                    # 用户管理
    │   │   │   ├── index.vue            # PG-P-USR-01 用户列表页
    │   │   │   ├── create.vue           # PG-P-USR-02 用户创建页
    │   │   │   └── detail.vue           # PG-P-USR-03 用户详情页
    │   │   └── components/              # 运营用户群私有组件
    │   │       └── UserEditDialog.vue   # 用户编辑弹窗
    │   ├── tenant/                      # 租户用户群页面
    │   │   ├── user/                    # 用户管理
    │   │   │   ├── index.vue            # PG-UR-USR-01 用户列表页
    │   │   │   ├── create.vue           # PG-UR-USR-02 用户创建页
    │   │   │   └── detail.vue           # PG-UR-USR-03 用户详情页
    │   │   ├── settings/                # 个人设置
    │   │   │   └── index.vue            # PG-UR-USR-04 个人设置页
    │   │   ├── org/                     # 组织管理（详见第4章）
    │   │   └── components/              # 租户用户群私有组件
    │   ├── consumer/                    # C端用户群页面
    │   │   ├── register/                # 注册
    │   │   │   └── index.vue            # PG-UC-USR-01 注册页
    │   │   ├── profile/                 # 个人中心
    │   │   │   └── index.vue            # PG-UC-USR-02 个人中心页
    │   │   ├── security/                # 账号安全
    │   │   │   └── index.vue            # PG-UC-USR-03 账号安全页
    │   │   ├── cancel/                  # 注销
    │   │   │   └── index.vue            # PG-UC-USR-04 账号注销页
    │   │   └── components/              # C端用户群私有组件
    │   └── public/                      # 公共页面
    │       ├── activate/                # 激活账号
    │       │   └── index.vue            # PG-PUB-01 激活账号页
    │       ├── forgot-password/         # 忘记密码
    │       │   └── index.vue            # PG-PUB-02 忘记密码页
    │       ├── reset-password/          # 重置密码
    │       │   └── index.vue            # PG-PUB-03 重置密码页
    │       ├── trial/                   # 企业试用
    │       │   └── index.vue            # PG-PUB-04 企业试用申请页
    │       └── tenant-register/         # 租户用户注册
    │           └── index.vue            # PG-PUB-05 租户用户注册页
    └── error/                           # 错误页面
        ├── 403.vue                      # 无权限
        └── 404.vue                      # 未找到
    ```

    图 3.9.2.4-1 页面组件结构

#### 3.9.2.5 公共组件结构

+   公共组件按功能分类：

    ```
    src/components/
    ├── common/                          # 通用组件
    │   ├── PageHeader.vue               # 页面标题
    │   ├── SearchForm.vue               # 搜索表单
    │   ├── DataTable.vue                # 数据表格
    │   └── ConfirmDialog.vue            # 确认弹窗
    ├── form/                            # 表单组件
    │   ├── PasswordInput.vue            # 密码输入框
    │   ├── CaptchaInput.vue             # 验证码输入框
    │   └── PhoneInput.vue               # 手机号输入框
    └── business/                        # 业务组件
        ├── UserStatusTag.vue            # 用户状态标签
        ├── UserSourceTag.vue            # 用户来源标签
        └── OrgSelector.vue              # 组织选择器
    ```

    图 3.9.2.5-1 公共组件结构

#### 3.9.2.6 路由配置结构

+   路由配置按用户群组织：

    ```
    src/router/
    ├── index.ts                         # 路由入口
    ├── guards.ts                        # 路由守卫
    └── modules/                         # 路由模块
        ├── provider.ts                  # 运营用户群路由
        ├── tenant.ts                    # 租户用户群路由
        ├── consumer.ts                  # C端用户群路由
        └── public.ts                    # 公共路由
    ```

    图 3.9.2.6-1 路由配置结构

#### 3.9.2.7 状态管理结构

+   Pinia状态管理按功能模块组织：

    ```
    src/stores/
    ├── index.ts                         # Store入口
    ├── user.ts                          # 用户状态（登录用户信息）
    ├── permission.ts                    # 权限状态
    ├── app.ts                           # 应用状态（主题、语言等）
    └── modules/                         # 业务模块状态
        └── iam/
            └── userManage.ts            # 用户管理状态
    ```

    图 3.9.2.7-1 状态管理结构

#### 3.9.2.8 权限控制结构

+   权限控制模块结构：

    ```
    src/permission/
    ├── index.ts                         # 权限入口
    ├── directive.ts                     # 权限指令 v-permission
    ├── check.ts                         # 权限检查函数
    └── constants.ts                     # 权限常量
    ```

    图 3.9.2.8-1 权限控制结构

### 3.9.3 命名规范

#### 3.9.3.1 文件命名规范

+   文件命名规范：

    | 文件类型  | 命名规范          | 示例                    |
    | --------- | ----------------- | ----------------------- |
    | 页面组件  | kebab-case或index | index.vue、create.vue   |
    | 公共组件  | PascalCase        | UserStatusTag.vue       |
    | API文件   | kebab-case        | provider.ts、public.ts  |
    | 类型文件  | kebab-case        | user.ts、enums.ts       |
    | 工具文件  | kebab-case        | date-util.ts、format.ts |
    | Store文件 | kebab-case        | user.ts、permission.ts  |
    | 路由文件  | kebab-case        | provider.ts、tenant.ts  |

    表 3.9.3.1-1 文件命名规范

#### 3.9.3.2 组件命名规范

+   组件命名规范：

    | 组件类型   | 命名规范          | 示例           |
    | ---------- | ----------------- | -------------- |
    | 页面组件   | {Feature}Page     | UserListPage   |
    | 弹窗组件   | {Feature}Dialog   | UserEditDialog |
    | 表单组件   | {Feature}Form     | UserCreateForm |
    | 列表组件   | {Feature}List     | UserList       |
    | 详情组件   | {Feature}Detail   | UserDetail     |
    | 标签组件   | {Feature}Tag      | UserStatusTag  |
    | 选择器组件 | {Feature}Selector | OrgSelector    |

    表 3.9.3.2-1 组件命名规范

#### 3.9.3.3 函数与变量命名规范

+   函数与变量命名规范：

    | 类型       | 命名规范           | 示例                       |
    | ---------- | ------------------ | -------------------------- |
    | API函数    | {action}{Resource} | createUser、listUsers      |
    | 事件处理   | handle{Event}      | handleSubmit、handleDelete |
    | 布尔变量   | is/has/can前缀     | isLoading、hasPermission   |
    | 组合式函数 | use前缀            | useUserList、usePermission |
    | 常量       | UPPER_SNAKE_CASE   | USER_STATUS、API_BASE_URL  |

    表 3.9.3.3-1 函数与变量命名规范

#### 3.9.3.4 类型命名规范

+   TypeScript类型命名规范：

    | 类型分类 | 命名规范                   | 示例                      |
    | -------- | -------------------------- | ------------------------- |
    | 接口     | I{Name}                    | IUserResponse、IUserQuery |
    | 类型别名 | T{Name}                    | TUserStatus               |
    | 枚举     | {Name}（PascalCase）       | UserStatus、SourceType    |
    | 请求类型 | I{Action}{Resource}Request | ICreateUserRequest        |
    | 响应类型 | I{Resource}Response        | IUserResponse             |

    表 3.9.3.4-1 类型命名规范

### 3.9.4 页面与组件映射

+   3.6节页面编号与Vue组件文件映射：

    | 页面编号     | 页面名称       | 组件文件路径                                   |
    | ------------ | -------------- | ---------------------------------------------- |
    | PG-P-USR-01  | 用户管理列表页 | src/views/iam/provider/user/index.vue          |
    | PG-P-USR-02  | 用户创建页     | src/views/iam/provider/user/create.vue         |
    | PG-P-USR-03  | 用户详情页     | src/views/iam/provider/user/detail.vue         |
    | PG-UR-USR-01 | 用户管理列表页 | src/views/iam/tenant/user/index.vue            |
    | PG-UR-USR-02 | 用户创建页     | src/views/iam/tenant/user/create.vue           |
    | PG-UR-USR-03 | 用户详情页     | src/views/iam/tenant/user/detail.vue           |
    | PG-UR-USR-04 | 个人设置页     | src/views/iam/tenant/settings/index.vue        |
    | PG-UC-USR-01 | 注册页         | src/views/iam/consumer/register/index.vue      |
    | PG-UC-USR-02 | 个人中心页     | src/views/iam/consumer/profile/index.vue       |
    | PG-UC-USR-03 | 账号安全页     | src/views/iam/consumer/security/index.vue      |
    | PG-UC-USR-04 | 账号注销页     | src/views/iam/consumer/cancel/index.vue        |
    | PG-PUB-01    | 激活账号页     | src/views/iam/public/activate/index.vue        |
    | PG-PUB-02    | 忘记密码页     | src/views/iam/public/forgot-password/index.vue |
    | PG-PUB-03    | 重置密码页     | src/views/iam/public/reset-password/index.vue  |
    | PG-PUB-04    | 企业试用申请页 | src/views/iam/public/trial/index.vue           |
    | PG-PUB-05    | 租户用户注册页 | src/views/iam/public/tenant-register/index.vue |

    表 3.9.4-1 页面与组件映射

# 4 组织管理

+   本章详细设计组织管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   组织管理负责管理"在哪个位置"，核心职责包括组织架构管理、岗位管理、人员管理、任职管理。
+   组织管理仅适用于租户用户群（UR），运营用户群和C端用户群不涉及组织架构。

## 4.1 组织业务场景

+   本节分析组织管理的业务场景，明确组织架构的核心概念、数据来源模式和管理规则。
+   业务场景是后续流程设计和领域模型设计的前提和依据。

### 4.1.1 场景总览

+   组织管理包含四个核心概念，概念之间的关系如下表所示。

    | 概念     | 英文         | 定义                         | 与其他概念的关系             |
    | -------- | ------------ | ---------------------------- | ---------------------------- |
    | 组织单元 | Organization | 企业内部的部门、分公司等单位 | 树形结构，包含子组织单元     |
    | 岗位     | Position     | 职位定义，如"开发工程师"     | 属于组织单元，可被多人担任   |
    | 人员     | Person       | 组织中的自然人               | 可在多个组织单元任职         |
    | 任职     | Appointment  | 人员担任岗位的记录           | 关联人员、组织单元、岗位三者 |

    表 4.1.1-1 组织管理核心概念

+   组织管理与用户管理的关系说明。
    -   人员（Person）可关联一个租户用户（TenantUser）
    -   本地自建模式下，创建人员时可选择是否同时创建用户账号
    -   外部源同步模式下，同步人员时自动创建对应的用户账号
    -   人员与用户的关联是可选的，不需要登录系统的人员可以没有账号

### 4.1.2 数据来源模式

+   组织数据支持多种来源模式，以满足不同企业的管理需求。

#### 4.1.2.1 来源模式分类

+   系统支持三种数据来源模式。

    | 来源模式   | 说明                           | 数据流向                 | 适用场景             |
    | ---------- | ------------------------------ | ------------------------ | -------------------- |
    | 外部源同步 | 从IAM中台/HR系统/AD域同步数据  | 外部系统 → 本系统        | 大型企业、已有HR系统 |
    | 本地自建   | 在平台内手工维护组织和人员数据 | 系统内创建               | 中小企业、无HR系统   |
    | 混合模式   | 外部源同步 + 本地扩展          | 外部系统 → 本系统 + 本地 | 需本地扩展的企业     |

    表 4.1.2.1-1 数据来源模式分类

#### 4.1.2.2 外部源同步模式

+   外部源同步模式的特点如下。
    -   **数据来源**：从IAM中台、HR系统、AD域等外部系统同步组织架构和人员数据
    -   **同步方式**：支持定时拉取和实时推送两种方式
    -   **只读限制**：从外部源同步的组织和人员在本系统中为只读，不允许修改
    -   **自动创建账号**：同步人员时自动创建对应的租户用户账号

+   外部源同步支持的对接方式如下表所示。

    | 对接方式 | 协议/技术    | 适用场景       | 同步方式 |
    | -------- | ------------ | -------------- | -------- |
    | SCIM     | SCIM 2.0协议 | 现代云应用集成 | 实时推送 |
    | LDAP/AD  | LDAP协议     | 微软AD环境     | 定时拉取 |
    | HR API   | REST API     | 自建HR系统     | 定时拉取 |

    表 4.1.2.2-1 外部源对接方式

#### 4.1.2.3 本地自建模式

+   本地自建模式的特点如下。
    -   **数据来源**：管理员在系统中手工创建和维护
    -   **完全可编辑**：本地创建的组织和人员可自由修改
    -   **可选创建账号**：创建人员时可选择是否同时创建用户账号
    -   **灵活调整**：本地组织之间可任意调整层级关系

#### 4.1.2.4 混合模式

+   混合模式的特点如下。
    -   **外部源为主**：核心组织架构从外部源同步
    -   **本地扩展**：在外部源组织下可创建本地组织进行扩展
    -   **权限分离**：外部源数据只读，本地数据可编辑

### 4.1.3 数据来源标识

+   组织和人员需要标识其数据来源，以控制可编辑性。

#### 4.1.3.1 来源标识定义

+   数据来源标识如下表所示。

    | 来源标识 | 英文   | 说明             | 可编辑性 |
    | -------- | ------ | ---------------- | -------- |
    | LOCAL    | 本地   | 在本系统手工创建 | 可编辑   |
    | EXTERNAL | 外部源 | 从外部系统同步   | 只读     |

    表 4.1.3.1-1 数据来源标识

#### 4.1.3.2 可编辑性规则

+   不同来源数据的可编辑性规则如下表所示。

    | 数据类型 | 来源标识 | 创建 | 修改 | 删除 | 移动 |
    | -------- | -------- | ---- | ---- | ---- | ---- |
    | 组织单元 | LOCAL    | 允许 | 允许 | 允许 | 允许 |
    | 组织单元 | EXTERNAL | 禁止 | 禁止 | 禁止 | 禁止 |
    | 岗位     | LOCAL    | 允许 | 允许 | 允许 | -    |
    | 岗位     | EXTERNAL | 禁止 | 禁止 | 禁止 | -    |
    | 人员     | LOCAL    | 允许 | 允许 | 允许 | -    |
    | 人员     | EXTERNAL | 禁止 | 禁止 | 禁止 | -    |

    表 4.1.3.2-1 数据可编辑性规则

### 4.1.4 组织层级规则

+   混合模式下，外部源组织与本地组织之间的层级关系有严格的规则限制。

#### 4.1.4.1 层级规则定义

+   组织层级规则如下。
    -   **允许**：本地组织挂靠在外部源组织下，形成"外部源→本地→本地..."结构
    -   **允许**：本地组织之间可任意调整层级
    -   **禁止**：外部源组织挂靠在本地组织下
    -   **禁止**：交叉嵌套，即"外部源→本地→外部源"结构

+   层级规则示意图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │  允许的层级结构                                                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    [EXTERNAL] 总公司                                                        │
    │         │                                                                   │
    │         ├── [EXTERNAL] 研发中心                                             │
    │         │        │                                                          │
    │         │        ├── [LOCAL] 创新实验室  ← 本地组织挂靠在外部源下（允许）   │
    │         │        │      │                                                   │
    │         │        │      └── [LOCAL] AI小组  ← 本地组织下继续挂本地（允许）  │
    │         │        │                                                          │
    │         │        └── [EXTERNAL] 测试部                                      │
    │         │                                                                   │
    │         └── [EXTERNAL] 销售中心                                             │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────┐
    │  禁止的层级结构                                                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    [LOCAL] 本地公司                                                         │
    │         │                                                                   │
    │         └── [EXTERNAL] 外部部门  ← 外部源挂靠在本地下（禁止）               │
    │                                                                             │
    │    -------------------------------------------------------------------      │
    │                                                                             │
    │    [EXTERNAL] 总公司                                                        │
    │         │                                                                   │
    │         └── [LOCAL] 本地部门                                                │
    │                  │                                                          │
    │                  └── [EXTERNAL] 外部组  ← 交叉嵌套（禁止）                  │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.1.4.1-1 组织层级规则示意图

#### 4.1.4.2 层级校验规则

+   系统在组织变更操作时进行层级校验，校验规则如下表所示。

    | 校验场景       | 校验规则                         | 违规提示                               |
    | -------------- | -------------------------------- | -------------------------------------- |
    | 创建本地组织   | 上级可以是LOCAL或EXTERNAL        | -                                      |
    | 移动本地组织   | 目标上级可以是LOCAL或EXTERNAL    | -                                      |
    | 创建外部源组织 | 上级必须是EXTERNAL或空（根节点） | 外部源组织不能挂靠在本地组织下         |
    | 移动外部源组织 | 禁止移动操作                     | 外部源组织不允许移动                   |
    | 同步外部源组织 | 上级必须是EXTERNAL或空           | 同步数据违反层级规则，请检查外部源数据 |

    表 4.1.4.2-1 层级校验规则

+   校验不通过时，系统应阻止操作并提示违反的具体规则。

### 4.1.5 组织架构管理场景

+   组织架构是企业内部的树形层级结构，用于描述部门、分公司等组织单元之间的隶属关系。

#### 4.1.5.1 组织架构特点

+   组织架构具有以下特点。
    -   **树形结构**：每个组织单元有且仅有一个上级（根节点除外）
    -   **根节点唯一**：每个租户有且仅有一个根组织单元，通常为公司本身
    -   **层级深度**：支持多层级嵌套，建议不超过10层
    -   **编码唯一**：每个组织单元有唯一编码，用于系统集成
    -   **来源标识**：每个组织单元标识其数据来源（LOCAL/EXTERNAL）

#### 4.1.5.2 组织单元类型

+   系统支持的组织单元类型如下表所示。

    | 类型编码 | 类型名称 | 说明                   | 示例           |
    | -------- | -------- | ---------------------- | -------------- |
    | COMPANY  | 公司     | 独立法人实体           | XX有限公司     |
    | BRANCH   | 分公司   | 非独立法人分支机构     | 上海分公司     |
    | DEPT     | 部门     | 职能部门               | 研发部、财务部 |
    | TEAM     | 团队     | 部门下的小组           | 前端组、测试组 |
    | VIRTUAL  | 虚拟组织 | 跨部门项目组等临时组织 | XX项目组       |

    表 4.1.5.2-1 组织单元类型

#### 4.1.5.3 组织架构示例

+   典型的组织架构树形结构示例如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         XX科技有限公司 [EXTERNAL]                           │
    └─────────────────────────────────────────┬───────────────────────────────────┘
                                              │
              ┌───────────────────────────────┼───────────────────────────────┐
              │                               │                               │
              ▼                               ▼                               ▼
    ┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
    │ 北京总部        │           │ 上海分公司      │           │ 深圳分公司      │
    │ [EXTERNAL]      │           │ [EXTERNAL]      │           │ [EXTERNAL]      │
    └────────┬────────┘           └────────┬────────┘           └─────────────────┘
             │                             │
       ┌─────┼─────┐                 ┌─────┴─────┐
       │     │     │                 │           │
       ▼     ▼     ▼                 ▼           ▼
    ┌─────┐┌─────┐┌─────┐         ┌─────┐     ┌─────┐
    │研发 ││市场 ││财务 │         │研发 │     │销售 │
    │[EXT]││[EXT]││[EXT]│         │[EXT]│     │[EXT]│
    └──┬──┘└─────┘└─────┘         └─────┘     └─────┘
       │
    ┌──┴──────┐
    │         │
    ▼         ▼
    ┌─────┐ ┌─────┐
    │前端 │ │创新 │
    │[EXT]│ │实验 │
    └─────┘ │室   │
            │[LOC]│  ← 本地扩展
            └──┬──┘
               │
               ▼
            ┌─────┐
            │AI组 │
            │[LOC]│  ← 本地扩展
            └─────┘
    ```

    图 4.1.5.3-1 组织架构树形结构示例（含本地扩展）

#### 4.1.5.4 组织架构管理操作

+   组织架构管理支持的操作如下表所示。

    | 操作 | 说明                       | LOCAL组织 | EXTERNAL组织 | 影响范围             |
    | ---- | -------------------------- | --------- | ------------ | -------------------- |
    | 创建 | 创建新的组织单元           | 允许      | 禁止         | 无                   |
    | 修改 | 修改组织单元名称、类型等   | 允许      | 禁止         | 无                   |
    | 移动 | 将组织单元移动到新的上级下 | 允许      | 禁止         | 子组织单元跟随移动   |
    | 合并 | 将一个组织单元合并到另一个 | 允许      | 禁止         | 人员、岗位转移到目标 |
    | 撤销 | 撤销/删除组织单元          | 允许      | 禁止         | 岗位同步撤销         |

    表 4.1.5.4-1 组织架构管理操作

### 4.1.6 岗位管理场景

+   岗位是租户层面的职位定义，用于描述工作职责和任职要求。

#### 4.1.6.1 岗位特点

+   岗位具有以下特点。
    -   **租户级定义**：岗位归属于租户，不绑定特定组织单元
    -   **跨组织复用**：同一岗位可被多个分支机构/部门调用
    -   **可被多人担任**：同一岗位在同一组织单元可有多个任职人员
    -   **编码唯一**：每个岗位有唯一编码，租户内全局唯一
    -   **来源标识**：岗位标识其数据来源（LOCAL/EXTERNAL）

#### 4.1.6.2 岗位属性

+   岗位的核心属性如下表所示。

    | 属性     | 说明               | 是否必填 | 示例             |
    | -------- | ------------------ | -------- | ---------------- |
    | 岗位编码 | 唯一标识           | 是       | POS-RD-001       |
    | 岗位名称 | 岗位的显示名称     | 是       | 高级开发工程师   |
    | 岗位类别 | 岗位分类           | 否       | 技术类、管理类   |
    | 岗位职责 | 岗位的工作职责描述 | 否       | 负责系统核心模块 |
    | 任职要求 | 岗位的任职资格要求 | 否       | 5年以上开发经验  |
    | 岗位状态 | 启用/停用          | 是       | 启用             |
    | 来源标识 | LOCAL/EXTERNAL     | 是       | LOCAL            |

    表 4.1.6.2-1 岗位核心属性

#### 4.1.6.3 岗位与任职的关系

+   岗位与组织单元、人员的关系通过任职建立。

    ```graph
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                租户                                       │
    ├───────────────────────────────────────────────────────────────────────────┤
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐  │
    │  │ 岗位（租户级）                                                      │  │
    │  │  ┌───────────────┐  ┌──────────────┐  ┌──────────────┐              │  │
    │  │  │高级开发工程师 │  │ 产品经理     │  │ 测试工程师   │  ...         │  │
    │  │  │ POS-001       │  │ POS-002      │  │ POS-003      │              │  │
    │  │  └──────┬────────┘  └──────┬───────┘  └──────┬───────┘              │  │
    │  └─────────┼──────────────────┼─────────────────┼──────────────────────┘  │
    │            │                  │                 │                         │
    │            │    ┌─────────────┴────────┐        │                         │
    │            │    │                      │        │                         │
    │            ▼    ▼                      ▼        ▼                         │
    │  ┌──────────────────────────┐  ┌──────────────────────────┐               │
    │  │ 北京研发部               │  │ 上海研发部               │               │
    │  │  ┌────────────────────┐  │  │  ┌────────────────────┐  │               │
    │  │  │任职: 张三          │  │  │  │任职: 王五          │  │               │
    │  │  │岗位: 高级开发工程师│  │  │  │岗位: 高级开发工程师│  │               │
    │  │  │类型: 主职          │  │  │  │类型: 主职          │  │               │
    │  │  └────────────────────┘  │  │  └────────────────────┘  │               │
    │  │  ┌────────────────────┐  │  │  ┌────────────────────┐  │               │
    │  │  │任职: 李四          │  │  │  │任职: 赵六          │  │               │
    │  │  │岗位: 产品经理      │  │  │  │岗位: 产品经理      │  │               │
    │  │  │类型: 主职          │  │  │  │类型: 主职          │  │               │
    │  │  └────────────────────┘  │  │  └────────────────────┘  │               │
    │  └──────────────────────────┘  └──────────────────────────┘               │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.1.6.3-1 岗位与任职关系示意图

+   关系说明。
    -   岗位在租户层面统一定义，如"高级开发工程师"、"产品经理"
    -   各组织单元（北京研发部、上海研发部）通过任职引用岗位
    -   同一岗位可被多个组织单元的多个人员同时使用
    -   任职记录人员在某组织单元担任某岗位的事实

#### 4.1.6.4 岗位管理操作

+   岗位管理支持的操作如下表所示。

    | 操作 | 说明                     | LOCAL岗位 | EXTERNAL岗位 | 影响范围       |
    | ---- | ------------------------ | --------- | ------------ | -------------- |
    | 创建 | 创建新岗位               | 允许      | 禁止         | 无             |
    | 修改 | 修改岗位名称、职责等信息 | 允许      | 禁止         | 无             |
    | 停用 | 停用岗位                 | 允许      | 禁止         | 不影响已有任职 |
    | 启用 | 重新启用已停用的岗位     | 允许      | 禁止         | 无             |
    | 删除 | 删除岗位                 | 允许      | 禁止         | 需无在职人员   |

    表 4.1.6.4-1 岗位管理操作

### 4.1.7 人员管理场景

+   人员是组织中的自然人，是组织管理的核心对象。

#### 4.1.7.1 人员特点

+   人员具有以下特点。
    -   **自然人实体**：代表组织中的一个真实的人
    -   **可关联用户**：人员可关联一个租户用户账号
    -   **多组织任职**：一个人员可以在多个组织单元担任不同岗位
    -   **工号唯一**：每个人员有唯一工号，租户内全局唯一
    -   **来源标识**：人员标识其数据来源（LOCAL/EXTERNAL）

#### 4.1.7.2 人员属性

+   人员的核心属性如下表所示。

    | 属性     | 说明             | 是否必填 | 示例              |
    | -------- | ---------------- | -------- | ----------------- |
    | 工号     | 唯一标识         | 是       | EMP001            |
    | 姓名     | 人员姓名         | 是       | 张三              |
    | 性别     | 男/女            | 否       | 男                |
    | 手机号   | 联系手机         | 否       | 138****8888       |
    | 邮箱     | 企业邮箱         | 否       | <zhangsan@xx.com> |
    | 入职日期 | 入职时间         | 否       | 2024-01-01        |
    | 人员状态 | 在职/离职        | 是       | 在职              |
    | 关联用户 | 关联的租户用户ID | 否       | -                 |
    | 来源标识 | LOCAL/EXTERNAL   | 是       | LOCAL             |

    表 4.1.7.2-1 人员核心属性

#### 4.1.7.3 人员来源与账号创建

+   不同来源模式下人员与账号的创建规则如下表所示。

    | 来源方式   | 说明                   | 用户账号处理     | 适用场景         |
    | ---------- | ---------------------- | ---------------- | ---------------- |
    | 手工创建   | 管理员手工录入人员信息 | 可选创建账号     | 逐个添加         |
    | 批量导入   | 通过Excel批量导入人员  | 可选批量创建账号 | 初始化、批量添加 |
    | 外部源同步 | 从HR/AD/SCIM同步       | 自动创建账号     | 企业集成         |

    表 4.1.7.3-1 人员来源与账号创建规则

#### 4.1.7.4 人员管理操作

+   人员管理支持的操作如下表所示。

    | 操作     | 说明                     | LOCAL人员 | EXTERNAL人员 | 影响范围         |
    | -------- | ------------------------ | --------- | ------------ | ---------------- |
    | 创建     | 创建新人员               | 允许      | 禁止         | 可选创建用户账号 |
    | 修改     | 修改人员基本信息         | 允许      | 禁止         | 无               |
    | 关联用户 | 将人员与已有用户账号关联 | 允许      | 禁止         | 无               |
    | 解除关联 | 解除人员与用户的关联关系 | 允许      | 禁止         | 无               |
    | 离职     | 标记人员离职             | 允许      | 禁止         | 终止所有任职     |
    | 复职     | 离职人员重新入职         | 允许      | 禁止         | 无               |
    | 删除     | 删除人员记录             | 允许      | 禁止         | 关联用户可选处理 |

    表 4.1.7.4-1 人员管理操作

### 4.1.8 任职管理场景

+   任职是人员在组织单元担任岗位的记录，是组织架构中人与岗位的关联关系。

#### 4.1.8.1 任职特点

+   任职具有以下特点。
    -   **三方关联**：任职关联人员、组织单元、岗位三者
    -   **主职唯一**：每个人员有且仅有一个主职
    -   **兼职多个**：每个人员可以有多个兼职
    -   **时间范围**：任职有开始时间和结束时间

#### 4.1.8.2 任职类型

+   任职类型定义如下表所示。

    | 类型编码 | 类型名称 | 说明             | 数量限制   |
    | -------- | -------- | ---------------- | ---------- |
    | PRIMARY  | 主职     | 主要工作岗位     | 每人仅一个 |
    | PARTTIME | 兼职     | 兼任的其他岗位   | 不限       |
    | ACTING   | 代理     | 临时代理他人岗位 | 不限       |

    表 4.1.8.2-1 任职类型

#### 4.1.8.3 任职管理操作

+   任职管理支持的操作如下表所示。

    | 操作     | 说明                     | LOCAL人员 | EXTERNAL人员 | 影响范围       |
    | -------- | ------------------------ | --------- | ------------ | -------------- |
    | 新增任职 | 为人员添加新的任职       | 允许      | 禁止         | 主职需唯一检查 |
    | 调岗     | 变更人员的组织单元或岗位 | 允许      | 禁止         | 更新主职归属   |
    | 终止任职 | 结束某项任职             | 允许      | 禁止         | 主职终止需确认 |
    | 设为主职 | 将兼职调整为主职         | 允许      | 禁止         | 原主职变为兼职 |

    表 4.1.8.3-1 任职管理操作

### 4.1.9 场景与流程映射

+   组织管理各场景与业务流程的对应关系如下表所示。

    | 场景分类       | 子分类   | 操作场景     | 对应流程   |
    | -------------- | -------- | ------------ | ---------- |
    | 本地组织架构   | 组织单元 | 创建组织单元 | FL-ORG-01  |
    | 本地组织架构   | 组织单元 | 调整组织单元 | FL-ORG-02  |
    | 本地组织架构   | 组织单元 | 撤销组织单元 | FL-ORG-03  |
    | 本地组织架构   | 岗位     | 创建岗位     | FL-POS-01  |
    | 本地组织架构   | 岗位     | 调整岗位     | FL-POS-02  |
    | 本地组织架构   | 人员     | 创建人员     | FL-PSN-01  |
    | 本地组织架构   | 人员     | 人员离职     | FL-PSN-02  |
    | 本地组织架构   | 任职     | 任职变更     | FL-APT-01  |
    | 外部源组织架构 | 同步     | 全量同步     | FL-SYNC-01 |
    | 外部源组织架构 | 同步     | 增量同步     | FL-SYNC-02 |
    | 外部源组织架构 | 同步     | 异常处理     | FL-SYNC-03 |

    表 4.1.9-1 场景与流程映射

### 4.1.10 外部源同步场景

+   外部源同步是将IAM中台、HR系统、AD域等外部系统的组织和人员数据同步到本系统的过程。

#### 4.1.10.1 同步范围

+   外部源同步的数据范围如下表所示。

    | 数据类型 | 是否同步 | 同步方向      | 说明                   |
    | -------- | -------- | ------------- | ---------------------- |
    | 组织单元 | 是       | 外部 → 本系统 | 同步组织架构树         |
    | 岗位     | 是       | 外部 → 本系统 | 同步岗位定义           |
    | 人员     | 是       | 外部 → 本系统 | 同步人员基本信息       |
    | 任职     | 是       | 外部 → 本系统 | 同步人员的任职关系     |
    | 用户账号 | 自动创建 | -             | 同步人员时自动创建账号 |

    表 4.1.10.1-1 外部源同步数据范围

#### 4.1.10.2 同步模式

+   系统支持两种同步模式。

    | 同步模式 | 触发方式      | 数据范围 | 适用场景           |
    | -------- | ------------- | -------- | ------------------ |
    | 全量同步 | 手动/定时     | 全部数据 | 首次对接、数据校准 |
    | 增量同步 | 定时/事件触发 | 变更数据 | 日常同步           |

    表 4.1.10.2-1 同步模式

#### 4.1.10.3 同步策略

+   同步时的数据处理策略如下表所示。

    | 场景     | 处理策略                        | 说明                     |
    | -------- | ------------------------------- | ------------------------ |
    | 新增数据 | 创建对应记录，来源标识=EXTERNAL | 自动创建用户账号         |
    | 更新数据 | 更新对应记录                    | 仅更新EXTERNAL来源的记录 |
    | 删除数据 | 标记为已删除或禁用              | 不物理删除，保留历史     |
    | 冲突数据 | 以外部源为准                    | 覆盖本系统数据           |
    | 层级违规 | 记录异常，跳过该条数据          | 通知管理员处理           |

    表 4.1.10.3-1 同步数据处理策略

#### 4.1.10.4 同步与用户账号

+   外部源同步人员时，自动创建用户账号的规则如下。
    -   系统根据人员的邮箱或手机号创建租户用户账号
    -   用户名默认使用工号或邮箱前缀
    -   初始密码随机生成，通过邮件/短信发送给用户
    -   用户首次登录需修改密码
    -   人员与用户自动建立关联关系

#### 4.1.10.5 同步异常处理

+   同步过程中可能出现的异常及处理方式如下表所示。

    | 异常类型     | 异常描述                     | 处理方式                       |
    | ------------ | ---------------------------- | ------------------------------ |
    | 连接失败     | 无法连接外部系统             | 重试，超过次数后告警           |
    | 数据格式错误 | 外部数据格式不符合预期       | 记录日志，跳过该条数据         |
    | 层级规则违规 | 同步数据违反层级规则         | 记录异常，通知管理员           |
    | 必填字段缺失 | 缺少必要字段（如工号、姓名） | 记录日志，跳过该条数据         |
    | 编码冲突     | 与LOCAL数据编码冲突          | 记录异常，通知管理员           |
    | 账号创建失败 | 邮箱/手机号已被占用          | 记录异常，人员同步但不创建账号 |

    表 4.1.10.5-1 同步异常处理

## 4.2 业务流程设计

+   本节详细设计组织管理相关的业务流程，分为本地组织架构流程和外部源组织架构流程两大类。
+   本地组织架构流程适用于LOCAL来源的数据，支持完整的增删改操作。
+   外部源组织架构流程适用于EXTERNAL来源的数据，由系统自动同步，不支持手工操作。

### 4.2.1 流程层级说明

+   组织管理流程采用与用户管理一致的层级划分。

    | 层级     | 说明                 | 示例                   |
    | -------- | -------------------- | ---------------------- |
    | 业务流程 | 完整的端到端业务场景 | 创建组织单元、人员入职 |
    | 子流程   | 可复用的流程片段     | 来源校验、层级校验     |
    | 活动     | 单个操作步骤         | 保存数据、发送通知     |

    表 4.2.1-1 流程层级说明

+   组织管理流程编号规则如下。

    | 前缀    | 适用范围       | 示例       |
    | ------- | -------------- | ---------- |
    | FL-ORG  | 组织单元流程   | FL-ORG-01  |
    | FL-POS  | 岗位流程       | FL-POS-01  |
    | FL-PSN  | 人员流程       | FL-PSN-01  |
    | FL-APT  | 任职流程       | FL-APT-01  |
    | FL-SYNC | 外部源同步流程 | FL-SYNC-01 |

    表 4.2.1-2 流程编号规则

### 4.2.2 FL-ORG-01 创建组织单元流程

+   本流程描述管理员手工创建本地组织单元的完整过程。

#### 4.2.2.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                              |
    | -------- | --------------------------------- |
    | 流程名称 | 创建组织单元                      |
    | 流程编号 | FL-ORG-01                         |
    | 触发条件 | 管理员点击"新建组织"按钮          |
    | 前置条件 | 上级组织单元已存在                |
    | 后置条件 | 组织单元创建成功，来源标识为LOCAL |
    | 参与者   | 租户管理员                        |

    表 4.2.2.1-1 创建组织单元流程概述

#### 4.2.2.2 流程步骤

+   创建组织单元流程步骤如下表所示。

    | 步骤 | 操作           | 执行者 | 输入         | 输出             | 异常处理             |
    | ---- | -------------- | ------ | ------------ | ---------------- | -------------------- |
    | 1    | 选择上级组织   | 管理员 | 组织树       | 上级组织ID       | -                    |
    | 2    | 填写组织信息   | 管理员 | 表单         | 组织编码、名称等 | -                    |
    | 3    | 提交创建请求   | 管理员 | 组织信息     | 创建请求         | -                    |
    | 4    | 校验编码唯一性 | 系统   | 组织编码     | 校验结果         | 编码重复则提示       |
    | 5    | 校验层级规则   | 系统   | 上级组织来源 | 校验结果         | 违反规则则阻止并提示 |
    | 6    | 创建组织单元   | 系统   | 组织信息     | 组织单元实体     | -                    |
    | 7    | 设置来源标识   | 系统   | -            | 来源=LOCAL       | -                    |
    | 8    | 返回创建结果   | 系统   | 组织单元     | 成功提示         | -                    |

    表 4.2.2.2-1 创建组织单元流程步骤

#### 4.2.2.3 流程图

+   创建组织单元流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-ORG-01 创建组织单元                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 选择上级组织     │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 填写组织信息     │                                                     │
    │    │ 编码/名称/类型   │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 编码唯一？        ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示编码重复    │──▶ 返回修改       │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 层级规则通过？    ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示规则违反    │──▶ 返回修改       │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 创建组织单元    │                                                      │
    │    │ 来源=LOCAL      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │      ┌─────────┐                                                            │
    │      │  结束   │                                                            │
    │      └─────────┘                                                            │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.2.3-1 创建组织单元流程图

### 4.2.3 FL-ORG-02 调整组织单元流程

+   本流程描述管理员调整本地组织单元的过程，包括修改信息和移动层级。

#### 4.2.3.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                         |
    | -------- | ---------------------------- |
    | 流程名称 | 调整组织单元                 |
    | 流程编号 | FL-ORG-02                    |
    | 触发条件 | 管理员点击"编辑"或"移动"按钮 |
    | 前置条件 | 组织单元存在且来源为LOCAL    |
    | 后置条件 | 组织单元信息更新成功         |
    | 参与者   | 租户管理员                   |

    表 4.2.3.1-1 调整组织单元流程概述

#### 4.2.3.2 流程步骤

+   调整组织单元流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入     | 输出         | 异常处理           |
    | ---- | ------------ | ------ | -------- | ------------ | ------------------ |
    | 1    | 选择组织单元 | 管理员 | 组织树   | 组织ID       | -                  |
    | 2    | 校验来源标识 | 系统   | 组织来源 | 校验结果     | EXTERNAL则禁止操作 |
    | 3    | 选择操作类型 | 管理员 | -        | 编辑/移动    | -                  |
    | 4a   | 修改组织信息 | 管理员 | 表单     | 更新后的信息 | 编码不可修改       |
    | 4b   | 选择新上级   | 管理员 | 组织树   | 新上级ID     | -                  |
    | 5    | 校验层级规则 | 系统   | 移动目标 | 校验结果     | 违反规则则阻止     |
    | 6    | 校验循环引用 | 系统   | 新上级ID | 校验结果     | 不能移动到子节点下 |
    | 7    | 保存变更     | 系统   | 变更信息 | 更新结果     | -                  |
    | 8    | 返回操作结果 | 系统   | -        | 成功提示     | -                  |

    表 4.2.3.2-1 调整组织单元流程步骤

#### 4.2.3.3 流程图

+   调整组织单元流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-ORG-02 调整组织单元                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 选择组织单元     │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 来源=LOCAL？      ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶│ 提示禁止操作     │──▶ 结束            │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 操作类型？        ╲                                                │
    │       ◇───────────────────◇                                                 │
    │         │ 编辑      │ 移动                                                  │
    │         ▼           ▼                                                       │
    │    ┌─────────┐ ┌─────────────────┐                                          │
    │    │修改信息 │ │ 选择新上级       │                                         │
    │    └────┬────┘ └────────┬────────┘                                          │
    │         │               │                                                   │
    │         │               ▼                                                   │
    │         │       ◇─────────────────◇                                         │
    │         │      ╱ 层级规则通过？    ╲  否 ┌───────────────┐                  │
    │         │     ◇───────────────────◇────▶ │提示规则违反   │──▶ 返回          │
    │         │           │ 是                 └───────────────┘                  │
    │         │           ▼                                                       │
    │         │       ◇─────────────────◇                                         │
    │         │      ╱ 非循环引用？      ╲  否 ┌───────────────┐                  │
    │         │     ◇───────────────────◇────▶ │ 提示不可移动  │──▶ 返回          │
    │         │           │ 是                 └───────────────┘                  │
    │         │           │                                                       │
    │         └─────┬─────┘                                                       │
    │               │                                                             │
    │               ▼                                                             │
    │    ┌─────────────────┐                                                      │
    │    │ 保存变更        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.3.3-1 调整组织单元流程图

### 4.2.4 FL-ORG-03 撤销组织单元流程

+   本流程描述管理员撤销/删除本地组织单元的过程。

#### 4.2.4.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                      |
    | -------- | ------------------------- |
    | 流程名称 | 撤销组织单元              |
    | 流程编号 | FL-ORG-03                 |
    | 触发条件 | 管理员点击"删除"按钮      |
    | 前置条件 | 组织单元存在且来源为LOCAL |
    | 后置条件 | 组织单元被删除            |
    | 参与者   | 租户管理员                |

    表 4.2.4.1-1 撤销组织单元流程概述

#### 4.2.4.2 流程步骤

+   撤销组织单元流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入       | 输出     | 异常处理           |
    | ---- | ------------ | ------ | ---------- | -------- | ------------------ |
    | 1    | 选择组织单元 | 管理员 | 组织树     | 组织ID   | -                  |
    | 2    | 校验来源标识 | 系统   | 组织来源   | 校验结果 | EXTERNAL则禁止操作 |
    | 3    | 校验下级组织 | 系统   | 子组织列表 | 校验结果 | 有子组织则禁止     |
    | 4    | 校验在职人员 | 系统   | 任职列表   | 校验结果 | 有在职人员则禁止   |
    | 5    | 二次确认     | 管理员 | 确认弹窗   | 确认结果 | 取消则终止流程     |
    | 6    | 删除组织单元 | 系统   | 组织ID     | 删除结果 | -                  |
    | 7    | 返回操作结果 | 系统   | -          | 成功提示 | -                  |

    表 4.2.4.2-1 撤销组织单元流程步骤

#### 4.2.4.3 流程图

+   撤销组织单元流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-ORG-03 撤销组织单元                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 选择组织单元     │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 来源=LOCAL？      ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示禁止操作    │──▶ 结束           │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 无下级组织？      ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示先删子组织  │──▶ 结束           │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 无在职人员？      ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示先处理人员  │──▶ 结束           │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 确认删除？        ╲    否                                          │
    │       ◇───────────────────◇────────────────────────────▶ 结束               │
    │             │ 是                                                            │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 删除组织单元    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │      ┌─────────┐                                                            │
    │      │  结束   │                                                            │
    │      └─────────┘                                                            │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.4.3-1 撤销组织单元流程图

### 4.2.5 FL-POS-01 创建岗位流程

+   本流程描述管理员创建租户级岗位的过程。

#### 4.2.5.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                          |
    | -------- | ----------------------------- |
    | 流程名称 | 创建岗位                      |
    | 流程编号 | FL-POS-01                     |
    | 触发条件 | 管理员点击"新建岗位"按钮      |
    | 前置条件 | 无                            |
    | 后置条件 | 岗位创建成功，来源标识为LOCAL |
    | 参与者   | 租户管理员                    |

    表 4.2.5.1-1 创建岗位流程概述

#### 4.2.5.2 流程步骤

+   创建岗位流程步骤如下表所示。

    | 步骤 | 操作           | 执行者 | 输入     | 输出             | 异常处理       |
    | ---- | -------------- | ------ | -------- | ---------------- | -------------- |
    | 1    | 填写岗位信息   | 管理员 | 表单     | 岗位编码、名称等 | -              |
    | 2    | 提交创建请求   | 管理员 | 岗位信息 | 创建请求         | -              |
    | 3    | 校验编码唯一性 | 系统   | 岗位编码 | 校验结果         | 编码重复则提示 |
    | 4    | 创建岗位       | 系统   | 岗位信息 | 岗位实体         | -              |
    | 5    | 设置来源标识   | 系统   | -        | 来源=LOCAL       | -              |
    | 6    | 返回创建结果   | 系统   | 岗位     | 成功提示         | -              |

    表 4.2.5.2-1 创建岗位流程步骤

### 4.2.6 FL-POS-02 调整岗位流程

+   本流程描述管理员调整本地岗位的过程。

#### 4.2.6.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                         |
    | -------- | ---------------------------- |
    | 流程名称 | 调整岗位                     |
    | 流程编号 | FL-POS-02                    |
    | 触发条件 | 管理员点击"编辑"或"停用"按钮 |
    | 前置条件 | 岗位存在且来源为LOCAL        |
    | 后置条件 | 岗位信息更新成功             |
    | 参与者   | 租户管理员                   |

    表 4.2.6.1-1 调整岗位流程概述

#### 4.2.6.2 流程步骤

+   调整岗位流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入     | 输出                | 异常处理           |
    | ---- | ------------ | ------ | -------- | ------------------- | ------------------ |
    | 1    | 选择岗位     | 管理员 | 岗位列表 | 岗位ID              | -                  |
    | 2    | 校验来源标识 | 系统   | 岗位来源 | 校验结果            | EXTERNAL则禁止操作 |
    | 3    | 选择操作类型 | 管理员 | -        | 编辑/停用/启用/删除 | -                  |
    | 4a   | 修改岗位信息 | 管理员 | 表单     | 更新后的信息        | 编码不可修改       |
    | 4b   | 停用岗位     | 系统   | 岗位ID   | 状态=停用           | -                  |
    | 4c   | 启用岗位     | 系统   | 岗位ID   | 状态=启用           | -                  |
    | 4d   | 删除岗位     | 系统   | 岗位ID   | 删除结果            | 有在职人员则禁止   |
    | 5    | 返回操作结果 | 系统   | -        | 成功提示            | -                  |

    表 4.2.6.2-1 调整岗位流程步骤

### 4.2.7 FL-PSN-01 创建人员流程

+   本流程描述管理员手工创建本地人员的过程。

#### 4.2.7.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                               |
    | -------- | ---------------------------------- |
    | 流程名称 | 创建人员                           |
    | 流程编号 | FL-PSN-01                          |
    | 触发条件 | 管理员点击"新建人员"按钮           |
    | 前置条件 | 无                                 |
    | 后置条件 | 人员创建成功，可选同时创建用户账号 |
    | 参与者   | 租户管理员                         |

    表 4.2.7.1-1 创建人员流程概述

#### 4.2.7.2 流程步骤

+   创建人员流程步骤如下表所示。

    | 步骤 | 操作             | 执行者 | 输入           | 输出               | 异常处理       |
    | ---- | ---------------- | ------ | -------------- | ------------------ | -------------- |
    | 1    | 填写人员信息     | 管理员 | 表单           | 工号、姓名、邮箱等 | -              |
    | 2    | 选择是否创建账号 | 管理员 | 勾选项         | 是/否              | -              |
    | 3    | 选择任职信息     | 管理员 | 组织/岗位      | 主职信息           | 可选           |
    | 4    | 提交创建请求     | 管理员 | 人员信息       | 创建请求           | -              |
    | 5    | 校验工号唯一性   | 系统   | 工号           | 校验结果           | 工号重复则提示 |
    | 6    | 创建人员         | 系统   | 人员信息       | 人员实体           | -              |
    | 7    | 创建用户账号     | 系统   | 邮箱/手机号    | 用户实体           | 若勾选创建账号 |
    | 8    | 关联人员与用户   | 系统   | 人员ID、用户ID | 关联关系           | 若创建了账号   |
    | 9    | 创建任职记录     | 系统   | 任职信息       | 任职实体           | 若填写了任职   |
    | 10   | 发送账号通知     | 系统   | 邮箱/手机号    | 通知               | 若创建了账号   |
    | 11   | 返回创建结果     | 系统   | 人员           | 成功提示           | -              |

    表 4.2.7.2-1 创建人员流程步骤

#### 4.2.7.3 流程图

+   创建人员流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-PSN-01 创建人员                                 │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌──────────────────┐                                                     │
    │    │ 填写人员信息     │                                                     │
    │    │ 工号/姓名/邮箱   │                                                     │
    │    └────────┬─────────┘                                                     │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌──────────────────┐                                                     │
    │    │ 选择是否创建账号 │                                                     │
    │    │ □ 同时创建账号   │                                                     │
    │    └────────┬─────────┘                                                     │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌──────────────────┐                                                     │
    │    │ 选择任职信息     │                                                     │
    │    │ 组织/岗位（可选）│                                                     │
    │    └────────┬─────────┘                                                     │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 工号唯一？        ╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 提示工号重复     │──▶ 返回修改      │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │    ┌──────────────────┐                                                     │
    │    │ 创建人员         │                                                     │
    │    │ 来源=LOCAL       │                                                     │
    │    └────────┬─────────┘                                                     │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 需创建账号？      ╲    否                                          │
    │       ◇───────────────────◇──────────────────────┐                          │
    │             │ 是                                 │                          │
    │             ▼                                    │                          │
    │    ┌──────────────────┐                          │                          │
    │    │ 创建用户账号     │                          │                          │
    │    │ 关联人员与用户   │                          │                          │
    │    │ 发送账号通知     │                          │                          │
    │    └────────┬─────────┘                          │                          │
    │             │                                    │                          │
    │             ◀────────────────────────────────────┘                          │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 有任职信息？      ╲    否                                          │
    │       ◇───────────────────◇──────────────────────┐                          │
    │             │ 是                                 │                          │
    │             ▼                                    │                          │
    │    ┌─────────────────┐                           │                          │
    │    │ 创建任职记录     │                          │                          │
    │    └────────┬────────┘                           │                          │
    │             │                                    │                          │
    │             ◀────────────────────────────────────┘                          │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.7.3-1 创建人员流程图

### 4.2.8 FL-PSN-02 人员离职流程

+   本流程描述管理员处理本地人员离职的过程。

#### 4.2.8.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                              |
    | -------- | --------------------------------- |
    | 流程名称 | 人员离职                          |
    | 流程编号 | FL-PSN-02                         |
    | 触发条件 | 管理员点击"离职"按钮              |
    | 前置条件 | 人员存在且来源为LOCAL且状态为在职 |
    | 后置条件 | 人员状态变为离职，所有任职终止    |
    | 参与者   | 租户管理员                        |

    表 4.2.8.1-1 人员离职流程概述

#### 4.2.8.2 流程步骤

+   人员离职流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入     | 输出           | 异常处理           |
    | ---- | ------------ | ------ | -------- | -------------- | ------------------ |
    | 1    | 选择人员     | 管理员 | 人员列表 | 人员ID         | -                  |
    | 2    | 校验来源标识 | 系统   | 人员来源 | 校验结果       | EXTERNAL则禁止操作 |
    | 3    | 填写离职信息 | 管理员 | 表单     | 离职日期、原因 | -                  |
    | 4    | 选择账号处理 | 管理员 | 选项     | 保留/禁用/删除 | -                  |
    | 5    | 二次确认     | 管理员 | 确认弹窗 | 确认结果       | 取消则终止流程     |
    | 6    | 终止所有任职 | 系统   | 人员ID   | 任职终止       | -                  |
    | 7    | 更新人员状态 | 系统   | 人员ID   | 状态=离职      | -                  |
    | 8    | 处理关联账号 | 系统   | 用户ID   | 账号处理结果   | 按选择执行         |
    | 9    | 返回操作结果 | 系统   | -        | 成功提示       | -                  |

    表 4.2.8.2-1 人员离职流程步骤

### 4.2.9 FL-APT-01 任职变更流程

+   本流程描述管理员变更人员任职的过程，包括新增任职、调岗、终止任职等操作。

#### 4.2.9.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                              |
    | -------- | --------------------------------- |
    | 流程名称 | 任职变更                          |
    | 流程编号 | FL-APT-01                         |
    | 触发条件 | 管理员进行任职相关操作            |
    | 前置条件 | 人员存在且来源为LOCAL且状态为在职 |
    | 后置条件 | 任职信息更新成功                  |
    | 参与者   | 租户管理员                        |

    表 4.2.9.1-1 任职变更流程概述

#### 4.2.9.2 流程步骤

+   任职变更流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入           | 输出                  | 异常处理           |
    | ---- | ------------ | ------ | -------------- | --------------------- | ------------------ |
    | 1    | 选择人员     | 管理员 | 人员列表       | 人员ID                | -                  |
    | 2    | 校验来源标识 | 系统   | 人员来源       | 校验结果              | EXTERNAL则禁止操作 |
    | 3    | 选择操作类型 | 管理员 | -              | 新增/调岗/终止/设主职 | -                  |
    | 4a   | 新增任职     | 管理员 | 组织/岗位/类型 | 任职信息              | 主职需唯一检查     |
    | 4b   | 调岗         | 管理员 | 新组织/新岗位  | 变更信息              | -                  |
    | 4c   | 终止任职     | 管理员 | 任职ID         | 终止信息              | 主职终止需确认     |
    | 4d   | 设为主职     | 管理员 | 任职ID         | 变更信息              | 原主职自动变兼职   |
    | 5    | 保存变更     | 系统   | 变更信息       | 更新结果              | -                  |
    | 6    | 返回操作结果 | 系统   | -              | 成功提示              | -                  |

    表 4.2.9.2-1 任职变更流程步骤

### 4.2.10 FL-SYNC-01 全量同步流程

+   本流程描述从外部系统全量同步组织架构和人员数据的过程。

#### 4.2.10.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                                 |
    | -------- | ------------------------------------ |
    | 流程名称 | 全量同步                             |
    | 流程编号 | FL-SYNC-01                           |
    | 触发条件 | 管理员手动触发或定时任务触发         |
    | 前置条件 | 外部源连接配置正确                   |
    | 后置条件 | 外部源数据全量同步到本系统           |
    | 参与者   | 系统（自动）/ 租户管理员（手动触发） |

    表 4.2.10.1-1 全量同步流程概述

#### 4.2.10.2 同步顺序

+   全量同步按以下顺序执行，确保数据依赖关系正确。

    | 顺序 | 同步对象 | 依赖关系             | 说明               |
    | ---- | -------- | -------------------- | ------------------ |
    | 1    | 组织单元 | 无                   | 先同步组织架构树   |
    | 2    | 岗位     | 无                   | 同步岗位定义       |
    | 3    | 人员     | 无                   | 同步人员基本信息   |
    | 4    | 任职     | 组织单元、岗位、人员 | 最后同步任职关系   |
    | 5    | 用户账号 | 人员                 | 为人员创建用户账号 |

    表 4.2.10.2-1 全量同步顺序

#### 4.2.10.3 流程步骤

+   全量同步流程步骤如下表所示。

    | 步骤 | 操作         | 执行者      | 输入         | 输出     | 异常处理                 |
    | ---- | ------------ | ----------- | ------------ | -------- | ------------------------ |
    | 1    | 触发全量同步 | 管理员/定时 | 同步配置     | 同步任务 | -                        |
    | 2    | 连接外部系统 | 系统        | 连接配置     | 连接状态 | 连接失败则记录并终止     |
    | 3    | 拉取组织数据 | 系统        | 查询条件     | 组织列表 | 拉取失败则记录并终止     |
    | 4    | 同步组织单元 | 系统        | 组织列表     | 同步结果 | 逐条处理，异常跳过       |
    | 5    | 拉取岗位数据 | 系统        | 查询条件     | 岗位列表 | -                        |
    | 6    | 同步岗位     | 系统        | 岗位列表     | 同步结果 | 逐条处理，异常跳过       |
    | 7    | 拉取人员数据 | 系统        | 查询条件     | 人员列表 | -                        |
    | 8    | 同步人员     | 系统        | 人员列表     | 同步结果 | 逐条处理，异常跳过       |
    | 9    | 创建用户账号 | 系统        | 人员信息     | 用户账号 | 账号创建失败单独记录     |
    | 10   | 拉取任职数据 | 系统        | 查询条件     | 任职列表 | -                        |
    | 11   | 同步任职     | 系统        | 任职列表     | 同步结果 | 逐条处理，异常跳过       |
    | 12   | 处理删除数据 | 系统        | 本地多余数据 | 标记删除 | 标记为已删除，不物理删除 |
    | 13   | 生成同步报告 | 系统        | 同步结果     | 同步报告 | -                        |
    | 14   | 通知管理员   | 系统        | 同步报告     | 通知     | 有异常时发送告警         |

    表 4.2.10.3-1 全量同步流程步骤

#### 4.2.10.4 流程图

+   全量同步流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-SYNC-01 全量同步                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 触发全量同步     │                                                     │
    │    │ 手动/定时        │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 连接外部系统成功？╲    否    ┌─────────────────┐                   │
    │       ◇───────────────────◇────────▶  │ 记录错误并告警  │──▶ 结束           │
    │             │ 是                      └─────────────────┘                   │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 1.拉取并同步    │                                                      │
    │    │   组织单元      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 2.拉取并同步    │                                                      │
    │    │   岗位          │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 3.拉取并同步    │                                                      │
    │    │   人员          │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 4.为人员创建    │                                                      │
    │    │   用户账号      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 5.拉取并同步    │                                                      │
    │    │   任职          │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 6.处理删除数据  │                                                      │
    │    │   标记已删除    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 生成同步报告    │                                                      │
    │    │ 通知管理员      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.10.4-1 全量同步流程图

#### 4.2.10.5 数据处理规则

+   全量同步时的数据处理规则如下表所示。

    | 场景       | 判断条件                   | 处理方式                |
    | ---------- | -------------------------- | ----------------------- |
    | 新增数据   | 外部有，本地无             | 创建记录，来源=EXTERNAL |
    | 更新数据   | 外部有，本地有，内容不同   | 更新本地EXTERNAL记录    |
    | 无变化数据 | 外部有，本地有，内容相同   | 跳过，不处理            |
    | 删除数据   | 外部无，本地有EXTERNAL记录 | 标记为已删除            |
    | 本地数据   | 外部无，本地有LOCAL记录    | 保留，不处理            |
    | 层级违规   | 同步数据违反层级规则       | 跳过并记录异常          |

    表 4.2.10.5-1 全量同步数据处理规则

### 4.2.11 FL-SYNC-02 增量同步流程

+   本流程描述从外部系统增量同步变更数据的过程。

#### 4.2.11.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                           |
    | -------- | ------------------------------ |
    | 流程名称 | 增量同步                       |
    | 流程编号 | FL-SYNC-02                     |
    | 触发条件 | 定时任务触发或外部系统事件推送 |
    | 前置条件 | 已完成至少一次全量同步         |
    | 后置条件 | 变更数据同步到本系统           |
    | 参与者   | 系统（自动）                   |

    表 4.2.11.1-1 增量同步流程概述

#### 4.2.11.2 触发方式

+   增量同步支持两种触发方式。

    | 触发方式 | 说明                       | 同步频率           | 适用场景    |
    | -------- | -------------------------- | ------------------ | ----------- |
    | 定时拉取 | 定时从外部系统拉取变更数据 | 可配置（如每小时） | LDAP/HR API |
    | 事件推送 | 外部系统主动推送变更事件   | 实时               | SCIM协议    |

    表 4.2.11.2-1 增量同步触发方式

#### 4.2.11.3 流程步骤

+   增量同步流程步骤如下表所示。

    | 步骤 | 操作           | 执行者    | 输入              | 输出           | 异常处理           |
    | ---- | -------------- | --------- | ----------------- | -------------- | ------------------ |
    | 1    | 触发增量同步   | 定时/事件 | 上次同步时间      | 同步任务       | -                  |
    | 2    | 获取变更数据   | 系统      | 时间范围/事件内容 | 变更列表       | 获取失败则重试     |
    | 3    | 解析变更类型   | 系统      | 变更数据          | 新增/更新/删除 | -                  |
    | 4    | 校验数据有效性 | 系统      | 变更数据          | 校验结果       | 无效数据跳过并记录 |
    | 5    | 校验层级规则   | 系统      | 组织变更          | 校验结果       | 违规数据跳过并记录 |
    | 6    | 执行数据变更   | 系统      | 变更数据          | 变更结果       | -                  |
    | 7    | 处理关联用户   | 系统      | 人员变更          | 用户处理结果   | 新增人员创建账号   |
    | 8    | 更新同步时间戳 | 系统      | 当前时间          | 时间戳         | -                  |
    | 9    | 记录同步日志   | 系统      | 同步结果          | 日志           | -                  |

    表 4.2.11.3-1 增量同步流程步骤

#### 4.2.11.4 流程图

+   增量同步流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-SYNC-02 增量同步                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 触发增量同步    │                                                      │
    │    │ 定时/事件推送   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 获取变更数据     │                                                     │
    │    │ 自上次同步以来   │                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 有变更数据？      ╲    否                                          │
    │       ◇───────────────────◇──────────────────────────────▶ 结束             │
    │             │ 是                                                            │
    │             ▼                                                               │
    │    ┌─────────────────────────────────────────┐                              │
    │    │ 遍历变更数据                            │                              │
    │    │  ┌─────────────────────────────────┐    │                              │
    │    │  │ 解析变更类型（新增/更新/删除）  │    │                              │
    │    │  └────────────┬────────────────────┘    │                              │
    │    │               │                         │                              │
    │    │               ▼                         │                              │
    │    │      ◇─────────────────◇                │                              │
    │    │     ╱ 数据有效？       ╲    否          │                              │
    │    │    ◇──────────────────◇───▶ 记录跳过    │                              │
    │    │          │ 是                           │                              │
    │    │          ▼                              │                              │
    │    │      ◇─────────────────◇                │                              │
    │    │     ╱ 层级规则通过？   ╲    否          │                              │
    │    │    ◇──────────────────◇───▶ 记录异常    │                              │
    │    │          │ 是                           │                              │
    │    │          ▼                              │                              │
    │    │  ┌─────────────────────────────────┐    │                              │
    │    │  │ 执行数据变更                    │    │                              │
    │    │  └────────────┬────────────────────┘    │                              │
    │    │               │                         │                              │
    │    │               ▼                         │                              │
    │    │      ◇─────────────────◇                │                              │
    │    │     ╱ 是新增人员？     ╲    否          │                              │
    │    │    ◇──────────────────◇────────┐        │                              │
    │    │          │ 是                  │        │                              │
    │    │          ▼                     │        │                              │
    │    │  ┌─────────────────┐           │        │                              │
    │    │  │ 创建用户账号    │           │        │                              │
    │    │  └────────┬────────┘           │        │                              │
    │    │           │                    │        │                              │
    │    │           ◀────────────────────┘        │                              │
    │    │           │                             │                              │
    │    └───────────┼─────────────────────────────┘                              │
    │                │ 循环结束                                                   │
    │                ▼                                                            │
    │    ┌─────────────────┐                                                      │
    │    │ 更新同步时间戳  │                                                      │
    │    │ 记录同步日志    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.11.4-1 增量同步流程图

#### 4.2.11.5 变更类型处理

+   不同变更类型的处理方式如下表所示。

    | 变更类型 | 数据对象 | 处理方式                         |
    | -------- | -------- | -------------------------------- |
    | 新增     | 组织单元 | 创建组织，来源=EXTERNAL          |
    | 新增     | 岗位     | 创建岗位，来源=EXTERNAL          |
    | 新增     | 人员     | 创建人员+用户账号，来源=EXTERNAL |
    | 新增     | 任职     | 创建任职记录                     |
    | 更新     | 组织单元 | 更新组织信息                     |
    | 更新     | 岗位     | 更新岗位信息                     |
    | 更新     | 人员     | 更新人员信息                     |
    | 更新     | 任职     | 更新任职信息                     |
    | 删除     | 组织单元 | 标记组织为已删除                 |
    | 删除     | 岗位     | 标记岗位为已删除                 |
    | 删除     | 人员     | 标记人员为离职，禁用用户账号     |
    | 删除     | 任职     | 终止任职记录                     |

    表 4.2.11.5-1 变更类型处理方式

### 4.2.12 FL-SYNC-03 同步异常处理流程

+   本流程描述同步过程中异常情况的处理方式。

#### 4.2.12.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                                 |
    | -------- | ------------------------------------ |
    | 流程名称 | 同步异常处理                         |
    | 流程编号 | FL-SYNC-03                           |
    | 触发条件 | 同步过程中发生异常                   |
    | 前置条件 | 正在执行同步任务                     |
    | 后置条件 | 异常被记录、通知、或人工处理         |
    | 参与者   | 系统（自动）/ 租户管理员（人工处理） |

    表 4.2.12.1-1 同步异常处理流程概述

#### 4.2.12.2 异常分类

+   同步异常分为以下几类。

    | 异常级别 | 异常类型     | 说明                    | 处理方式           |
    | -------- | ------------ | ----------------------- | ------------------ |
    | 严重     | 连接失败     | 无法连接外部系统        | 重试→告警→人工介入 |
    | 严重     | 认证失败     | 外部系统认证不通过      | 告警→人工介入      |
    | 一般     | 数据格式错误 | 数据格式不符合预期      | 跳过→记录→继续同步 |
    | 一般     | 必填字段缺失 | 缺少必要字段            | 跳过→记录→继续同步 |
    | 一般     | 层级规则违规 | 组织层级违反规则        | 跳过→记录→人工处理 |
    | 一般     | 编码冲突     | 与本地LOCAL数据编码冲突 | 跳过→记录→人工处理 |
    | 轻微     | 账号创建失败 | 邮箱/手机号已被占用     | 记录→人员正常同步  |

    表 4.2.12.2-1 同步异常分类

#### 4.2.12.3 流程步骤

+   同步异常处理流程步骤如下表所示。

    | 步骤 | 操作           | 执行者 | 输入          | 输出       | 说明                |
    | ---- | -------------- | ------ | ------------- | ---------- | ------------------- |
    | 1    | 捕获异常       | 系统   | 异常信息      | 异常对象   | -                   |
    | 2    | 判断异常级别   | 系统   | 异常类型      | 级别       | 严重/一般/轻微      |
    | 3a   | 严重异常处理   | 系统   | 异常信息      | 重试/告警  | 重试3次，失败则告警 |
    | 3b   | 一般异常处理   | 系统   | 异常信息      | 跳过并记录 | 继续处理下一条      |
    | 3c   | 轻微异常处理   | 系统   | 异常信息      | 记录       | 继续处理下一条      |
    | 4    | 记录异常日志   | 系统   | 异常详情      | 日志       | 包含数据内容        |
    | 5    | 更新异常统计   | 系统   | 异常类型      | 统计数据   | -                   |
    | 6    | 判断是否需告警 | 系统   | 异常级别/数量 | 告警决策   | 严重或异常过多      |
    | 7    | 发送告警通知   | 系统   | 告警内容      | 通知       | 邮件/短信/站内信    |
    | 8    | 生成异常报告   | 系统   | 异常列表      | 报告       | 同步完成后生成      |

    表 4.2.12.3-1 同步异常处理流程步骤

#### 4.2.12.4 流程图

+   同步异常处理流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-SYNC-03 同步异常处理                            │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │捕获异常 │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 判断异常级别    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │      ┌──────┼──────┬──────────────┐                                         │
    │      │      │      │              │                                         │
    │   严重▼   一般▼   轻微▼           │                                         │
    │    ┌────┐ ┌────┐ ┌────┐           │                                         │
    │    │重试│ │跳过│ │记录│           │                                         │
    │    │3次 │ │记录│ │    │           │                                         │
    │    └──┬─┘ └──┬─┘ └──┬─┘           │                                         │
    │       │      │      │             │                                         │
    │       ▼      │      │             │                                         │
    │   ◇──────◇   │      │             │                                         │
    │  ╱重试成功?╲ │      │             │                                         │
    │ ◇─────────◇  │      │             │                                         │
    │   │是    │否 │      │             │                                         │
    │   │      ▼   │      │             │                                         │
    │   │  ┌────┐  │      │             │                                         │
    │   │  │告警│  │      │             │                                         │
    │   │  └──┬─┘  │      │             │                                         │
    │   │     │    │      │             │                                         │
    │   └──┬──┴────┴──────┴─────────────┘                                         │
    │      │                                                                      │
    │      ▼                                                                      │
    │    ┌─────────────────┐                                                      │
    │    │ 记录异常日志    │                                                      │
    │    │ 更新异常统计    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 需要告警？        ╲    否                                          │
    │       ◇───────────────────◇──────────────────┐                              │
    │             │ 是                             │                              │
    │             ▼                                │                              │
    │    ┌─────────────────┐                       │                              │
    │    │ 发送告警通知     │                      │                              │
    │    └────────┬────────┘                       │                              │
    │             │                                │                              │
    │             ◀────────────────────────────────┘                              │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.2.12.4-1 同步异常处理流程图

#### 4.2.12.5 异常人工处理

+   需要人工处理的异常情况及处理方式如下表所示。

    | 异常类型     | 人工处理方式                         | 处理入口     |
    | ------------ | ------------------------------------ | ------------ |
    | 连接失败     | 检查网络、检查外部系统状态、检查配置 | 同步配置页面 |
    | 认证失败     | 更新认证凭据（密钥/Token）           | 同步配置页面 |
    | 层级规则违规 | 修改外部源数据或调整本地组织结构     | 异常数据列表 |
    | 编码冲突     | 修改本地LOCAL数据编码或外部源编码    | 异常数据列表 |
    | 账号创建失败 | 手动关联已有用户或修改邮箱/手机号    | 人员详情页面 |

    表 4.2.12.5-1 异常人工处理方式

#### 4.2.12.6 异常数据管理

+   系统提供异常数据管理功能，支持以下操作。
    -   **查看异常列表**：按时间、类型、级别筛选异常记录
    -   **查看异常详情**：查看异常的具体数据内容和错误信息
    -   **重试同步**：对失败的数据重新尝试同步
    -   **忽略异常**：标记异常为已忽略，不再提醒
    -   **导出异常**：导出异常数据供外部处理

## 4.3 领域模型设计

+   本节设计组织管理子领域的领域模型，包括聚合划分、实体、值对象、领域服务和领域事件。
+   组织管理领域模型仅适用于租户用户群，数据存储在租户库中。

### 4.3.1 聚合划分

+   组织管理子领域划分为4个聚合。

    | 聚合名称     | 聚合根       | 职责         | 包含实体/值对象    | 所属数据库               |
    | ------------ | ------------ | ------------ | ------------------ | ------------------------ |
    | Organization | Organization | 组织单元管理 | Organization       | clarisphere_t{tenant_id} |
    | Position     | Position     | 岗位管理     | Position           | clarisphere_t{tenant_id} |
    | Person       | Person       | 人员管理     | Person、PersonUser | clarisphere_t{tenant_id} |
    | Appointment  | Appointment  | 任职管理     | Appointment        | clarisphere_t{tenant_id} |

    表 4.3.1-1 组织管理聚合划分

+   聚合划分原则说明。
    -   **Organization聚合**：管理组织单元的树形结构，独立维护组织信息
    -   **Position聚合**：管理租户级岗位定义，独立于组织单元
    -   **Person聚合**：管理人员基本信息及与用户的关联关系
    -   **Appointment聚合**：管理任职关系，关联人员、组织、岗位三者

### 4.3.2 聚合关系图

+   组织管理各聚合之间的关系如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          组织管理领域模型                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌───────────────────────────────────────────────────────────────────┐    │
    │    │                         租户边界                                  │    │
    │    │                                                                   │    │
    │    │   ┌──────────────────┐                    ┌─────────────────┐     │    │
    │    │   │  Organization    │                    │    Position     │     │    │
    │    │   │    聚合          │                    │     聚合        │     │    │
    │    │   │  ┌────────────┐  │                    │  ┌───────────┐  │     │    │
    │    │   │  │Organization│  │                    │  │ Position  │  │     │    │
    │    │   │  │ (聚合根)   │  │                    │  │ (聚合根)  │  │     │    │
    │    │   │  └────────────┘  │                    │  └───────────┘  │     │    │
    │    │   │        │         │                    │        │        │     │    │
    │    │   │        │parent   │                    │        │        │     │    │
    │    │   │        ▼         │                    │        │        │     │    │
    │    │   │  ┌────────────┐  │                    │        │        │     │    │
    │    │   │  │Organization│  │                    │        │        │     │    │
    │    │   │  │ (子节点)   │  │                    │        │        │     │    │
    │    │   │  └────────────┘  │                    │        │        │     │    │
    │    │   └────────┬─────────┘                    └────────┬────────┘     │    │
    │    │            │                                       │              │    │
    │    │            │ orgId                        positionId              │    │
    │    │            │                                       │              │    │
    │    │            └──────────────┬────────────────────────┘              │    │
    │    │                           │                                       │    │
    │    │                           ▼                                       │    │
    │    │                  ┌─────────────────┐                              │    │
    │    │                  │   Appointment   │                              │    │
    │    │                  │      聚合       │                              │    │
    │    │                  │  ┌───────────┐  │                              │    │
    │    │                  │  │Appointment│  │                              │    │
    │    │                  │  │ (聚合根)  │  │                              │    │
    │    │                  │  └───────────┘  │                              │    │
    │    │                  └────────┬────────┘                              │    │
    │    │                           │                                       │    │
    │    │                           │ personId                              │    │
    │    │                           │                                       │    │
    │    │                           ▼                                       │    │
    │    │                  ┌─────────────────┐                              │    │
    │    │                  │     Person      │                              │    │
    │    │                  │      聚合       │                              │    │
    │    │                  │  ┌───────────┐  │                              │    │
    │    │                  │  │  Person   │  │                              │    │
    │    │                  │  │ (聚合根)  │  │                              │    │
    │    │                  │  └─────┬─────┘  │                              │    │
    │    │                  │        │        │                              │    │
    │    │                  │        ▼        │                              │    │
    │    │                  │  ┌───────────┐  │     ┌─────────────────┐      │    │
    │    │                  │  │PersonUser │──┼────▶│ TenantUser      │      │    │
    │    │                  │  │ (值对象)  │  │     │ (用户管理领域)  │      │    │
    │    │                  │  └───────────┘  │     └─────────────────┘      │    │
    │    │                  └─────────────────┘                              │    │
    │    │                                                                   │    │
    │    └───────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.2-1 组织管理聚合关系图

### 4.3.3 Organization 聚合（组织单元）

+   Organization聚合负责管理组织单元的树形结构。

#### 4.3.3.1 聚合结构

+   Organization聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                     Organization 聚合                           │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │              Organization（聚合根/实体）            │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: OrgId                                        │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - code: OrgCode                                    │      │
    │    │  - name: String                                     │      │
    │    │  - type: OrgType                                    │      │
    │    │  - parentId: OrgId                                  │      │
    │    │  - path: String                                     │      │
    │    │  - level: Integer                                   │      │
    │    │  - sortOrder: Integer                               │      │
    │    │  - status: OrgStatus                                │      │
    │    │  - source: DataSource                               │      │
    │    │  - externalId: String                               │      │
    │    │  - description: String                              │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(command): Organization                    │      │
    │    │  + update(command): void                            │      │
    │    │  + moveTo(newParentId): void                        │      │
    │    │  + disable(): void                                  │      │
    │    │  + enable(): void                                   │      │
    │    │  + isEditable(): boolean                            │      │
    │    │  + isLocal(): boolean                               │      │
    │    │  + isExternal(): boolean                            │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
    │    │   OrgType     │  │  OrgStatus    │  │  DataSource   │      │
    │    │   (枚举)      │  │   (枚举)      │  │   (枚举)      │      │
    │    ├───────────────┤  ├───────────────┤  ├───────────────┤      │
    │    │ COMPANY       │  │ ACTIVE        │  │ LOCAL         │      │
    │    │ BRANCH        │  │ DISABLED      │  │ EXTERNAL      │      │
    │    │ DEPT          │  │ DELETED       │  └───────────────┘      │
    │    │ TEAM          │  └───────────────┘                         │
    │    │ VIRTUAL       │                                            │
    │    └───────────────┘                                            │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.3.1-1 Organization聚合结构

#### 4.3.3.2 Organization 实体

+   Organization是聚合根，管理组织单元的树形结构，采用三表模型定义如下。

##### 属性清单表

 | 属性名      | 数据类型   | 约束                       | 默认值 | 业务含义                                   |
 | ----------- | ---------- | -------------------------- | ------ | ------------------------------------------ |
 | id          | OrgId      | 必填，主键                 | AUTO   | 组织单元唯一标识（BIGINT自增）             |
 | tenantId    | TenantId   | 必填，不可变               | -      | 所属租户ID，租户隔离标识                   |
 | code        | OrgCode    | 必填，长度3-32，租户内唯一 | -      | 组织编码，创建后不可修改                   |
 | name        | String     | 必填，长度2-64             | -      | 组织名称，显示用                           |
 | type        | OrgType    | 必填，枚举                 | DEPT   | 组织类型：COMPANY/BRANCH/DEPT/TEAM/VIRTUAL |
 | parentId    | OrgId      | 可选                       | null   | 上级组织ID，根节点为null                   |
 | path        | String     | 必填，系统计算             | -      | 层级路径，如"/root-id/parent-id/self-id"   |
 | level       | Integer    | 必填，系统计算，范围1-10   | -      | 层级深度，根节点为1                        |
 | sortOrder   | Integer    | 必填                       | 0      | 同级排序序号，数值越小越靠前               |
 | status      | OrgStatus  | 必填，枚举                 | ACTIVE | 组织状态：ACTIVE/DISABLED/DELETED          |
 | source      | DataSource | 必填，枚举，不可变         | LOCAL  | 数据来源：LOCAL本地创建，EXTERNAL外部同步  |
 | externalId  | String     | EXTERNAL时必填，长度≤128   | null   | 外部系统ID，用于同步匹配                   |
 | description | String     | 可选，长度≤500             | null   | 组织描述                                   |
 | createdAt   | DateTime   | 必填，不可变               | NOW()  | 创建时间                                   |
 | updatedAt   | DateTime   | 必填                       | NOW()  | 更新时间                                   |

表 4.3.3.2-1 Organization属性清单表

##### 业务规则表

| 规则编号 | 规则名称          | 规则简述                                            | 验证时机  | 违反后果           |
| -------- | ----------------- | --------------------------------------------------- | --------- | ------------------ |
| ORG-R-01 | 编码唯一          | code在租户内全局唯一                                | 创建      | 拒绝操作，提示重复 |
| ORG-R-02 | 编码不可变        | 创建后code不可修改                                  | 更新      | 拒绝操作           |
| ORG-R-03 | 根节点唯一        | 每个租户有且仅有一个根节点（parentId为空）          | 创建      | 拒绝操作           |
| ORG-R-04 | 层级深度限制      | level不超过10层                                     | 创建/移动 | 拒绝操作           |
| ORG-R-05 | 来源可编辑性      | source=LOCAL时可编辑，source=EXTERNAL时只读         | 更新/删除 | 拒绝操作           |
| ORG-R-06 | 层级规则-LOCAL    | LOCAL组织可挂靠在EXTERNAL或LOCAL组织下              | 创建/移动 | -                  |
| ORG-R-07 | 层级规则-EXTERNAL | EXTERNAL组织只能挂靠在EXTERNAL组织下或作为根节点    | 同步      | 记录异常           |
| ORG-R-08 | 禁止循环引用      | 移动时不能将组织移动到自己或自己的子节点下          | 移动      | 拒绝操作           |
| ORG-R-09 | 删除前提-无子组织 | 删除时不能有子组织单元                              | 删除      | 拒绝操作           |
| ORG-R-10 | 删除前提-无任职   | 删除时不能有关联的在职任职记录                      | 删除      | 拒绝操作           |
| ORG-R-11 | 路径自动计算      | path和level由系统根据parentId自动计算，不可手动设置 | 创建/移动 | -                  |

表 4.3.3.2-2 Organization业务规则表

##### 业务方法表

| 方法名       | 方法简述                          | 关联规则                | 异常                      | 事件                 |
| ------------ | --------------------------------- | ----------------------- | ------------------------- | -------------------- |
| create()     | 创建组织单元，自动计算path和level | ORG-R-01,03,04,06,07,11 | OrgCodeDuplicateException | OrganizationCreated  |
| update()     | 更新组织单元名称、类型、描述等    | ORG-R-02,05             | OrgNotEditableException   | OrganizationUpdated  |
| moveTo()     | 移动组织单元到新的上级下          | ORG-R-04,05,06,08,11    | InvalidMoveException      | OrganizationMoved    |
| disable()    | 禁用组织单元，状态置为DISABLED    | ORG-R-05                | OrgNotEditableException   | OrganizationDisabled |
| enable()     | 启用已禁用的组织单元              | ORG-R-05                | OrgNotEditableException   | OrganizationEnabled  |
| delete()     | 删除组织单元，逻辑删除            | ORG-R-05,09,10          | OrgHasChildrenException   | OrganizationDeleted  |
| isEditable() | 判断是否可编辑，返回布尔值        | ORG-R-05                | -                         | -                    |
| isLocal()    | 判断是否本地创建，source=LOCAL    | -                       | -                         | -                    |
| isExternal() | 判断是否外部同步，source=EXTERNAL | -                       | -                         | -                    |

表 4.3.3.2-3 Organization业务方法表

+   备注：
    -   path格式示例：根节点"/abc123"，二级节点"/abc123/def456"，以此类推
    -   移动组织时，所有子组织的path和level会自动级联更新

### 4.3.4 Position 聚合（岗位）

+   Position聚合负责管理租户级岗位定义。

#### 4.3.4.1 聚合结构

+   Position聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                       Position 聚合                             │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │               Position（聚合根/实体）               │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: PositionId                                   │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - code: PositionCode                               │      │
    │    │  - name: String                                     │      │
    │    │  - category: String                                 │      │
    │    │  - description: String                              │      │
    │    │  - requirements: String                             │      │
    │    │  - status: PositionStatus                           │      │
    │    │  - source: DataSource                               │      │
    │    │  - externalId: String                               │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(command): Position                        │      │
    │    │  + update(command): void                            │      │
    │    │  + disable(): void                                  │      │
    │    │  + enable(): void                                   │      │
    │    │  + isEditable(): boolean                            │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │              ┌───────────────────────────────┐                  │
    │              │       PositionStatus          │                  │
    │              │          (枚举)               │                  │
    │              ├───────────────────────────────┤                  │
    │              │ ACTIVE    - 启用              │                  │
    │              │ DISABLED  - 停用              │                  │
    │              │ DELETED   - 已删除            │                  │
    │              └───────────────────────────────┘                  │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.4.1-1 Position聚合结构

#### 4.3.4.2 Position 实体

+   Position是聚合根，管理租户级岗位定义，采用三表模型定义如下。

##### 属性清单表

 | 属性名       | 数据类型       | 约束                       | 默认值 | 业务含义                                  |
 | ------------ | -------------- | -------------------------- | ------ | ----------------------------------------- |
 | id           | PositionId     | 必填，主键                 | AUTO   | 岗位唯一标识（BIGINT自增）                |
 | tenantId     | TenantId       | 必填，不可变               | -      | 所属租户ID，租户隔离标识                  |
 | code         | PositionCode   | 必填，长度3-32，租户内唯一 | -      | 岗位编码，创建后不可修改                  |
 | name         | String         | 必填，长度2-64             | -      | 岗位名称，显示用                          |
 | category     | String         | 可选，长度≤32              | null   | 岗位类别，如技术类、管理类、职能类        |
 | description  | String         | 可选，长度≤500             | null   | 岗位职责描述                              |
 | requirements | String         | 可选，长度≤500             | null   | 任职要求说明                              |
 | status       | PositionStatus | 必填，枚举                 | ACTIVE | 岗位状态：ACTIVE/DISABLED/DELETED         |
 | source       | DataSource     | 必填，枚举，不可变         | LOCAL  | 数据来源：LOCAL本地创建，EXTERNAL外部同步 |
 | externalId   | String         | EXTERNAL时必填，长度≤128   | null   | 外部系统ID，用于同步匹配                  |
 | createdAt    | DateTime       | 必填，不可变               | NOW()  | 创建时间                                  |
 | updatedAt    | DateTime       | 必填                       | NOW()  | 更新时间                                  |

表 4.3.4.2-1 Position属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                           | 验证时机  | 违反后果           |
| -------- | -------------- | -------------------------------------------------- | --------- | ------------------ |
| POS-R-01 | 编码唯一       | code在租户内全局唯一                               | 创建      | 拒绝操作，提示重复 |
| POS-R-02 | 编码不可变     | 创建后code不可修改                                 | 更新      | 拒绝操作           |
| POS-R-03 | 租户级定义     | 岗位不绑定特定组织单元，可被多个组织单元的任职引用 | -         | -                  |
| POS-R-04 | 来源可编辑性   | source=LOCAL时可编辑，source=EXTERNAL时只读        | 更新/删除 | 拒绝操作           |
| POS-R-05 | 删除前提       | 删除时不能有关联的在职任职记录                     | 删除      | 拒绝操作           |
| POS-R-06 | 停用不影响任职 | 停用岗位不影响已有的任职记录，仅新任职不能选用     | 停用      | -                  |

表 4.3.4.2-2 Position业务规则表

##### 业务方法表

| 方法名       | 方法简述                         | 关联规则    | 异常                           | 事件             |
| ------------ | -------------------------------- | ----------- | ------------------------------ | ---------------- |
| create()     | 创建岗位                         | POS-R-01    | PositionCodeDuplicateException | PositionCreated  |
| update()     | 更新岗位名称、类别、职责、要求等 | POS-R-02,04 | PositionNotEditableException   | PositionUpdated  |
| disable()    | 停用岗位，状态置为DISABLED       | POS-R-04,06 | PositionNotEditableException   | PositionDisabled |
| enable()     | 启用已停用的岗位                 | POS-R-04    | PositionNotEditableException   | PositionEnabled  |
| delete()     | 删除岗位，逻辑删除               | POS-R-04,05 | PositionInUseException         | PositionDeleted  |
| isEditable() | 判断是否可编辑，返回布尔值       | POS-R-04    | -                              | -                |

表 4.3.4.2-3 Position业务方法表

+   备注：
    -   岗位为租户级定义，与组织单元是多对多关系，通过任职（Appointment）建立关联
    -   停用的岗位在新增任职时不显示，但已有任职可继续保持

### 4.3.5 Person 聚合（人员）

+   Person聚合负责管理人员基本信息及与用户的关联关系。

#### 4.3.5.1 聚合结构

+   Person聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                        Person 聚合                              │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │                Person（聚合根/实体）                │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: PersonId                                     │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - employeeNo: EmployeeNo                           │      │
    │    │  - name: String                                     │      │
    │    │  - gender: Gender                                   │      │
    │    │  - mobile: String                                   │      │
    │    │  - email: String                                    │      │
    │    │  - hireDate: LocalDate                              │      │
    │    │  - resignDate: LocalDate                            │      │
    │    │  - status: PersonStatus                             │      │
    │    │  - source: DataSource                               │      │
    │    │  - externalId: String                               │      │
    │    │  - userBinding: PersonUser                          │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(command): Person                          │      │
    │    │  + update(command): void                            │      │
    │    │  + bindUser(userId): void                           │      │
    │    │  + unbindUser(): void                               │      │
    │    │  + resign(resignDate): void                         │      │
    │    │  + reinstate(): void                                │      │
    │    │  + isEditable(): boolean                            │      │
    │    │  + hasUser(): boolean                               │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 包含                             │
    │                              ▼                                  │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │              PersonUser（值对象）                   │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - userId: UserId                                   │      │
    │    │  - bindTime: LocalDateTime                          │      │
    │    │  - bindType: BindType                               │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
    │    │    Gender     │  │ PersonStatus  │  │   BindType    │      │
    │    │    (枚举)     │  │    (枚举)     │  │    (枚举)     │      │
    │    ├───────────────┤  ├───────────────┤  ├───────────────┤      │
    │    │ MALE          │  │ ACTIVE        │  │ AUTO          │      │
    │    │ FEMALE        │  │ RESIGNED      │  │ MANUAL        │      │
    │    │ UNKNOWN       │  │ DELETED       │  └───────────────┘      │
    │    └───────────────┘  └───────────────┘                         │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.5.1-1 Person聚合结构

#### 4.3.5.2 Person 实体

+   Person是聚合根，管理人员基本信息及与用户的关联关系，采用三表模型定义如下。

##### 属性清单表

 | 属性名      | 数据类型     | 约束                       | 默认值  | 业务含义                                  |
 | ----------- | ------------ | -------------------------- | ------- | ----------------------------------------- |
 | id          | PersonId     | 必填，主键                 | AUTO    | 人员唯一标识（BIGINT自增）                |
 | tenantId    | TenantId     | 必填，不可变               | -       | 所属租户ID，租户隔离标识                  |
 | employeeNo  | EmployeeNo   | 必填，长度3-32，租户内唯一 | -       | 员工工号，创建后不可修改                  |
 | name        | String       | 必填，长度2-64             | -       | 人员姓名                                  |
 | gender      | Gender       | 可选，枚举                 | UNKNOWN | 性别：MALE/FEMALE/UNKNOWN                 |
 | mobile      | String       | 可选，手机号格式           | null    | 联系手机号                                |
 | email       | String       | 可选，邮箱格式             | null    | 联系邮箱                                  |
 | hireDate    | LocalDate    | 可选                       | null    | 入职日期                                  |
 | resignDate  | LocalDate    | 可选                       | null    | 离职日期，离职时设置                      |
 | status      | PersonStatus | 必填，枚举                 | ACTIVE  | 人员状态：ACTIVE在职/RESIGNED离职/DELETED |
 | source      | DataSource   | 必填，枚举，不可变         | LOCAL   | 数据来源：LOCAL本地创建，EXTERNAL外部同步 |
 | externalId  | String       | EXTERNAL时必填，长度≤128   | null    | 外部系统ID，用于同步匹配                  |
 | userBinding | PersonUser   | 可选                       | null    | 用户关联信息值对象                        |
 | createdAt   | DateTime     | 必填，不可变               | NOW()   | 创建时间                                  |
 | updatedAt   | DateTime     | 必填                       | NOW()   | 更新时间                                  |

表 4.3.5.2-1 Person属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                           | 验证时机  | 违反后果           |
| -------- | ---------------- | -------------------------------------------------- | --------- | ------------------ |
| PSN-R-01 | 工号唯一         | employeeNo在租户内全局唯一                         | 创建      | 拒绝操作，提示重复 |
| PSN-R-02 | 工号不可变       | 创建后employeeNo不可修改                           | 更新      | 拒绝操作           |
| PSN-R-03 | 人员-用户一对一  | 一个人员最多关联一个用户（见PSNU-R-*）             | 绑定      | 拒绝操作           |
| PSN-R-04 | 用户-人员一对一  | 一个用户最多被一个人员关联（全租户范围检查）       | 绑定      | 拒绝操作           |
| PSN-R-05 | 来源可编辑性     | source=LOCAL时可编辑，source=EXTERNAL时只读        | 更新/删除 | 拒绝操作           |
| PSN-R-06 | 离职终止任职     | 离职时自动调用AppointmentService终止所有在职任职   | 离职      | -                  |
| PSN-R-07 | 离职处理关联账号 | 离职时可选择禁用或保留关联的用户账号               | 离职      | -                  |
| PSN-R-08 | 删除前提-已离职  | 删除时status必须为RESIGNED                         | 删除      | 拒绝操作           |
| PSN-R-09 | 复职条件         | 复职时status必须为RESIGNED，复职后status变为ACTIVE | 复职      | 拒绝操作           |

表 4.3.5.2-2 Person业务规则表

##### 业务方法表

| 方法名       | 方法简述                       | 关联规则                | 异常                         | 事件              |
| ------------ | ------------------------------ | ----------------------- | ---------------------------- | ----------------- |
| create()     | 创建人员                       | PSN-R-01                | EmployeeNoDuplicateException | PersonCreated     |
| update()     | 更新人员姓名、性别、联系方式等 | PSN-R-02,05             | PersonNotEditableException   | PersonUpdated     |
| bindUser()   | 关联用户账号                   | PSN-R-03,04,05,PSNU-R-* | UserAlreadyBoundException    | PersonUserBound   |
| unbindUser() | 解除用户关联                   | PSN-R-05,PSNU-R-04      | PersonNotEditableException   | PersonUserUnbound |
| resign()     | 人员离职，设置离职日期和状态   | PSN-R-05,06,07          | PersonNotEditableException   | PersonResigned    |
| reinstate()  | 人员复职，清除离职信息         | PSN-R-05,09             | InvalidPersonStatusException | PersonReinstated  |
| delete()     | 删除人员，逻辑删除             | PSN-R-05,08             | PersonNotResignedException   | PersonDeleted     |
| isEditable() | 判断是否可编辑，返回布尔值     | PSN-R-05                | -                            | -                 |
| hasUser()    | 判断是否已关联用户，返回布尔值 | -                       | -                            | -                 |

表 4.3.5.2-3 Person业务方法表

+   备注：
    -   人员与用户的关联关系是组织管理与用户管理的桥梁
    -   企业同步场景下，同步人员时会自动创建用户账号并建立关联（bindType=AUTO）
    -   人员离职后，关联账号的处理策略由管理员在离职操作时选择

#### 4.3.5.3 PersonUser 值对象

+   PersonUser值对象封装人员与用户的关联信息，采用三表模型定义如下。

##### 属性清单表

 | 属性名   | 数据类型      | 约束       | 默认值 | 业务含义                                |
 | -------- | ------------- | ---------- | ------ | --------------------------------------- |
 | userId   | UserId        | 必填       | -      | 关联的租户用户ID                        |
 | bindTime | LocalDateTime | 必填       | NOW()  | 关联建立时间                            |
 | bindType | BindType      | 必填，枚举 | MANUAL | 关联类型：AUTO自动（同步时）/MANUAL手动 |

表 4.3.5.3-1 PersonUser属性清单表

##### BindType枚举值表

| 枚举值 | 说明     | 触发场景                       |
| ------ | -------- | ------------------------------ |
| AUTO   | 自动绑定 | 企业同步时自动创建用户并关联   |
| MANUAL | 手动绑定 | 管理员在界面上手动关联已有用户 |

表 4.3.5.3-2 BindType枚举值

##### 业务规则表

| 规则编号  | 规则名称     | 规则简述                                     | 验证时机 | 违反后果 |
| --------- | ------------ | -------------------------------------------- | -------- | -------- |
| PSNU-R-01 | 用户必须存在 | userId必须指向有效存在的TenantUser           | 绑定     | 拒绝操作 |
| PSNU-R-02 | 同租户约束   | 关联的用户必须与人员属于同一租户             | 绑定     | 拒绝操作 |
| PSNU-R-03 | 绑定后不可变 | PersonUser创建后userId不可修改，只能解绑重绑 | 更新     | 拒绝操作 |
| PSNU-R-04 | 解绑清空     | 解绑时整个PersonUser置为null                 | 解绑     | -        |

表 4.3.5.3-3 PersonUser业务规则表

+   备注：
    -   PersonUser为嵌入式值对象，存储在person表中（user_id, user_bind_time, user_bind_type）
    -   人员未绑定用户时，userBinding属性为null

### 4.3.6 Appointment 聚合（任职）

+   Appointment聚合负责管理人员在组织单元担任岗位的记录。

#### 4.3.6.1 聚合结构

+   Appointment聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                      Appointment 聚合                           │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │             Appointment（聚合根/实体）              │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: AppointmentId                                │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - personId: PersonId                               │      │
    │    │  - orgId: OrgId                                     │      │
    │    │  - positionId: PositionId                           │      │
    │    │  - type: AppointmentType                            │      │
    │    │  - startDate: LocalDate                             │      │
    │    │  - endDate: LocalDate                               │      │
    │    │  - status: AppointmentStatus                        │      │
    │    │  - source: DataSource                               │      │
    │    │  - externalId: String                               │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(command): Appointment                     │      │
    │    │  + transfer(newOrgId, newPositionId): void          │      │
    │    │  + setPrimary(): void                               │      │
    │    │  + terminate(endDate): void                         │      │
    │    │  + isPrimary(): boolean                             │      │
    │    │  + isActive(): boolean                              │      │
    │    │  + isEditable(): boolean                            │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌─────────────────────┐  ┌─────────────────────┐             │
    │    │  AppointmentType    │  │  AppointmentStatus  │             │
    │    │      (枚举)         │  │       (枚举)        │             │
    │    ├─────────────────────┤  ├─────────────────────┤             │
    │    │ PRIMARY   - 主职    │  │ ACTIVE    - 在职    │             │
    │    │ PARTTIME  - 兼职    │  │ TERMINATED- 已终止  │             │
    │    │ ACTING    - 代理    │  └─────────────────────┘             │
    │    └─────────────────────┘                                      │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 4.3.6.1-1 Appointment聚合结构

#### 4.3.6.2 Appointment 实体

+   Appointment是聚合根，管理人员在组织单元担任岗位的记录，采用三表模型定义如下。

##### 属性清单表

| 属性       | 类型              | 约束                     | 默认值  | 业务含义                                      |
| ---------- | ----------------- | ------------------------ | ------- | --------------------------------------------- |
| id         | AppointmentId     | 必填，主键               | AUTO    | 任职唯一标识（BIGINT自增）                    |
| tenantId   | TenantId          | 必填，不可变             | -       | 所属租户ID，租户隔离标识                      |
| personId   | PersonId          | 必填，不可变             | -       | 人员ID，关联Person聚合                        |
| orgId      | OrgId             | 必填                     | -       | 组织单元ID，关联Organization聚合              |
| positionId | PositionId        | 必填                     | -       | 岗位ID，关联Position聚合                      |
| type       | AppointmentType   | 必填，枚举               | PRIMARY | 任职类型：PRIMARY主职/PARTTIME兼职/ACTING代理 |
| startDate  | LocalDate         | 必填                     | TODAY   | 任职开始日期                                  |
| endDate    | LocalDate         | 可选                     | null    | 任职结束日期，在职时为null                    |
| status     | AppointmentStatus | 必填，枚举               | ACTIVE  | 任职状态：ACTIVE在职/TERMINATED已终止         |
| source     | DataSource        | 必填，枚举，不可变       | LOCAL   | 数据来源：LOCAL本地创建，EXTERNAL外部同步     |
| externalId | String            | EXTERNAL时必填，长度≤128 | null    | 外部系统ID，用于同步匹配                      |
| createdAt  | DateTime          | 必填，不可变             | NOW()   | 创建时间                                      |
| updatedAt  | DateTime          | 必填                     | NOW()   | 更新时间                                      |

表 4.3.6.2-1 Appointment属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                                   | 验证时机    | 违反后果       |
| -------- | ---------------- | ---------------------------------------------------------- | ----------- | -------------- |
| APT-R-01 | 主职唯一         | 每个人员有且仅有一个type=PRIMARY且status=ACTIVE的任职      | 创建/设主职 | 拒绝或自动转换 |
| APT-R-02 | 兼职不限         | 每个人员可有多个type=PARTTIME或ACTING且status=ACTIVE的任职 | -           | -              |
| APT-R-03 | 设主职自动转换   | 将兼职设为主职时，原主职自动变为PARTTIME                   | 设主职      | -              |
| APT-R-04 | 来源可编辑性     | source=LOCAL时可编辑，source=EXTERNAL时只读                | 更新/终止   | 拒绝操作       |
| APT-R-05 | 人员有效性       | personId必须引用有效的Person且status=ACTIVE                | 创建        | 拒绝操作       |
| APT-R-06 | 组织有效性       | orgId必须引用有效的Organization且status=ACTIVE             | 创建/调岗   | 拒绝操作       |
| APT-R-07 | 岗位有效性       | positionId必须引用有效的Position且status=ACTIVE            | 创建/调岗   | 拒绝操作       |
| APT-R-08 | 终止设置结束日期 | 终止时必须设置endDate，endDate≥startDate                   | 终止        | 自动设为当天   |
| APT-R-09 | 调岗保留记录     | 调岗时终止原任职，创建新任职，保留完整履历                 | 调岗        | -              |
| APT-R-10 | 首个任职为主职   | 人员的第一个在职任职自动设置为PRIMARY                      | 创建        | -              |

表 4.3.6.2-2 Appointment业务规则表

##### 业务方法表

| 方法名       | 方法简述                       | 关联规则             | 异常                            | 事件                   |
| ------------ | ------------------------------ | -------------------- | ------------------------------- | ---------------------- |
| create()     | 创建任职记录                   | APT-R-01,05,06,07,10 | InvalidAppointmentException     | AppointmentCreated     |
| transfer()   | 调岗，终止当前任职并创建新任职 | APT-R-04,06,07,09    | AppointmentNotEditableException | AppointmentTransferred |
| setPrimary() | 设为主职，原主职自动变兼职     | APT-R-01,03,04       | AppointmentNotEditableException | AppointmentSetPrimary  |
| terminate()  | 终止任职，设置结束日期和状态   | APT-R-04,08          | AppointmentNotEditableException | AppointmentTerminated  |
| isPrimary()  | 判断是否为主职，返回布尔值     | -                    | -                               | -                      |
| isActive()   | 判断是否在职，返回布尔值       | -                    | -                               | -                      |
| isEditable() | 判断是否可编辑，返回布尔值     | APT-R-04             | -                               | -                      |

表 4.3.6.2-3 Appointment业务方法表

+   备注：
    -   任职是人员、组织、岗位三者的关联实体，体现"谁在哪里担任什么岗位"
    -   调岗操作不修改原记录，而是终止原任职并创建新任职，保留完整的任职履历
    -   人员离职时，由PersonService调用AppointmentService.terminateAllAppointments()终止所有在职任职

### 4.3.7 领域服务

+   组织管理子领域包含以下领域服务：

    | 服务名称                 | 类型 | 职责         | 说明                                 |
    | ------------------------ | ---- | ------------ | ------------------------------------ |
    | OrganizationService      | 命令 | 组织单元管理 | 组织创建、移动、删除等跨聚合操作     |
    | PersonService            | 命令 | 人员管理     | 人员创建、离职、关联用户等跨聚合操作 |
    | AppointmentService       | 命令 | 任职管理     | 任职创建、调岗、终止等跨聚合操作     |
    | PositionService          | 命令 | 岗位管理     | 岗位创建、删除等跨聚合操作           |
    | OrgSyncService           | 命令 | 组织同步     | 全量/增量同步外部源数据              |
    | OrganizationQueryService | 查询 | 组织查询     | 组织详情、树、分页、子组织查询       |
    | PositionQueryService     | 查询 | 岗位查询     | 岗位详情、分页查询                   |
    | PersonQueryService       | 查询 | 人员查询     | 人员详情、分页查询                   |
    | AppointmentQueryService  | 查询 | 任职查询     | 任职详情、分页查询                   |
    | SyncQueryService         | 查询 | 同步查询     | 同步状态、异常记录查询               |

    表 4.3.7-1 领域服务清单

#### 4.3.7.1 OrganizationService

+   OrganizationService负责组织单元相关的跨聚合操作。

    | 方法                | 参数               | 返回值       | 说明         |
    | ------------------- | ------------------ | ------------ | ------------ |
    | createOrganization  | CreateOrgCommand   | Organization | 创建组织单元 |
    | updateOrganization  | UpdateOrgCommand   | void         | 更新组织单元 |
    | moveOrganization    | orgId, newParentId | void         | 移动组织单元 |
    | deleteOrganization  | orgId              | void         | 删除组织单元 |
    | validateHierarchy   | orgId, newParentId | boolean      | 校验层级规则 |
    | validateCircularRef | orgId, newParentId | boolean      | 校验循环引用 |

    表 4.3.7.1-1 OrganizationService方法

#### 4.3.7.2 PersonService

+   PersonService负责人员相关的跨聚合操作。

    | 方法                 | 参数                 | 返回值 | 说明                   |
    | -------------------- | -------------------- | ------ | ---------------------- |
    | createPerson         | CreatePersonCommand  | Person | 创建人员               |
    | createPersonWithUser | CreatePersonCommand  | Person | 创建人员并创建用户账号 |
    | updatePerson         | UpdatePersonCommand  | void   | 更新人员               |
    | bindUser             | personId, userId     | void   | 关联用户               |
    | unbindUser           | personId             | void   | 解除用户关联           |
    | resignPerson         | personId, resignDate | void   | 人员离职               |
    | reinstatePerson      | personId             | void   | 人员复职               |
    | deletePerson         | personId             | void   | 删除人员（逻辑删除）   |

    表 4.3.7.2-1 PersonService方法

#### 4.3.7.3 AppointmentService

+   AppointmentService负责任职相关的跨聚合操作。

    | 方法                     | 参数                              | 返回值      | 说明             |
    | ------------------------ | --------------------------------- | ----------- | ---------------- |
    | createAppointment        | CreateAppointmentCommand          | Appointment | 创建任职         |
    | transferAppointment      | appointmentId, newOrgId, newPosId | void        | 调岗             |
    | terminateAppointment     | appointmentId, endDate            | void        | 终止任职         |
    | setPrimaryAppointment    | appointmentId                     | void        | 设为主职         |
    | terminateAllAppointments | personId                          | void        | 终止人员所有任职 |
    | getPersonAppointments    | personId                          | List<Appt>  | 获取人员任职列表 |
    | getOrgAppointments       | orgId                             | List<Appt>  | 获取组织任职列表 |

    表 4.3.7.3-1 AppointmentService方法

#### 4.3.7.4 OrgSyncService

+   OrgSyncService负责外部源数据同步操作。

    | 方法                | 参数                          | 返回值     | 说明         |
    | ------------------- | ----------------------------- | ---------- | ------------ |
    | fullSync            | tenantId, sourceConfig        | SyncReport | 执行全量同步 |
    | incrementalSync     | tenantId, sourceConfig, since | SyncReport | 执行增量同步 |
    | syncOrganization    | ExternalOrgData               | SyncResult | 同步单个组织 |
    | syncPosition        | ExternalPositionData          | SyncResult | 同步单个岗位 |
    | syncPerson          | ExternalPersonData            | SyncResult | 同步单个人员 |
    | syncAppointment     | ExternalAppointmentData       | SyncResult | 同步单个任职 |
    | handleSyncException | SyncException                 | void       | 处理同步异常 |

    表 4.3.7.4-1 OrgSyncService方法

#### 4.3.7.5 PositionService

+   PositionService负责岗位相关的跨聚合操作。

    | 方法           | 参数              | 返回值   | 说明                           |
    | -------------- | ----------------- | -------- | ------------------------------ |
    | createPosition | CreatePositionCmd | Position | 创建岗位，校验编码唯一性       |
    | deletePosition | positionId        | void     | 删除岗位，需校验无在职任职引用 |

    表 4.3.7.5-1 PositionService方法

#### 4.3.7.6 OrganizationQueryService

+   OrganizationQueryService负责组织单元的只读查询。

    | 方法        | 参数         | 返回值        | 说明               |
    | ----------- | ------------ | ------------- | ------------------ |
    | getById     | orgId        | Organization  | 查询组织单元详情   |
    | getTree     | tenantId     | List<OrgNode> | 查询组织树         |
    | page        | OrgPageQuery | Page<OrgDTO>  | 分页查询组织单元   |
    | getChildren | orgId        | List<OrgDTO>  | 查询直接子组织列表 |

    表 4.3.7.6-1 OrganizationQueryService方法

#### 4.3.7.7 PositionQueryService

+   PositionQueryService负责岗位的只读查询。

    | 方法    | 参数              | 返回值            | 说明         |
    | ------- | ----------------- | ----------------- | ------------ |
    | getById | positionId        | Position          | 查询岗位详情 |
    | page    | PositionPageQuery | Page<PositionDTO> | 分页查询岗位 |

    表 4.3.7.7-1 PositionQueryService方法

#### 4.3.7.8 PersonQueryService

+   PersonQueryService负责人员的只读查询。

    | 方法    | 参数            | 返回值          | 说明         |
    | ------- | --------------- | --------------- | ------------ |
    | getById | personId        | Person          | 查询人员详情 |
    | page    | PersonPageQuery | Page<PersonDTO> | 分页查询人员 |

    表 4.3.7.8-1 PersonQueryService方法

#### 4.3.7.9 AppointmentQueryService

+   AppointmentQueryService负责任职的只读查询。

    | 方法    | 参数                 | 返回值               | 说明         |
    | ------- | -------------------- | -------------------- | ------------ |
    | getById | appointmentId        | Appointment          | 查询任职详情 |
    | page    | AppointmentPageQuery | Page<AppointmentDTO> | 分页查询任职 |

    表 4.3.7.9-1 AppointmentQueryService方法

#### 4.3.7.10 SyncQueryService

+   SyncQueryService负责同步任务状态和异常记录的只读查询。

    | 方法          | 参数               | 返回值              | 说明             |
    | ------------- | ------------------ | ------------------- | ---------------- |
    | getStatus     | tenantId           | SyncStatusDTO       | 查询最近同步状态 |
    | getExceptions | SyncExceptionQuery | Page<SyncException> | 分页查询同步异常 |

    表 4.3.7.10-1 SyncQueryService方法

### 4.3.8 领域事件

+   组织管理领域定义以下领域事件。

    | 事件名称               | 触发时机       | 事件数据                          | 订阅者                    |
    | ---------------------- | -------------- | --------------------------------- | ------------------------- |
    | OrganizationCreated    | 组织单元创建后 | orgId, tenantId, code, name       | 审计模块、授权管理        |
    | OrganizationUpdated    | 组织单元更新后 | orgId, changedFields              | 审计模块                  |
    | OrganizationMoved      | 组织单元移动后 | orgId, oldParentId, newParentId   | 审计模块、授权管理        |
    | OrganizationDeleted    | 组织单元删除后 | orgId, tenantId                   | 审计模块、授权管理        |
    | PositionCreated        | 岗位创建后     | positionId, tenantId, code        | 审计模块                  |
    | PositionUpdated        | 岗位更新后     | positionId, changedFields         | 审计模块                  |
    | PositionDisabled       | 岗位停用后     | positionId                        | 审计模块                  |
    | PersonCreated          | 人员创建后     | personId, tenantId, employeeNo    | 审计模块、用户管理        |
    | PersonUpdated          | 人员更新后     | personId, changedFields           | 审计模块                  |
    | PersonResigned         | 人员离职后     | personId, resignDate              | 审计模块、用户管理        |
    | PersonUserBound        | 人员关联用户后 | personId, userId                  | 审计模块、用户管理        |
    | PersonUserUnbound      | 人员解除关联后 | personId, userId                  | 审计模块、用户管理        |
    | AppointmentCreated     | 任职创建后     | appointmentId, personId, orgId    | 审计模块、授权管理        |
    | AppointmentTransferred | 任职调岗后     | appointmentId, oldOrgId, newOrgId | 审计模块、授权管理        |
    | AppointmentTerminated  | 任职终止后     | appointmentId, endDate            | 审计模块                  |
    | AppointmentSetPrimary  | 任职设主职后   | appointmentId, personId           | 审计模块、授权管理        |
    | OrgSyncCompleted       | 同步完成后     | tenantId, syncReport              | 审计模块                  |
    | OrgSyncFailed          | 同步失败后     | tenantId, errorInfo               | 审计模块、告警服务、BC-12 |
    | OrganizationDisabled   | 组织单元禁用后 | orgId, tenantId                   | 审计模块、授权管理        |
    | OrganizationEnabled    | 组织单元启用后 | orgId, tenantId                   | 审计模块、授权管理        |
    | PositionEnabled        | 岗位启用后     | positionId, tenantId              | 审计模块                  |
    | PositionDeleted        | 岗位删除后     | positionId, tenantId              | 审计模块                  |
    | PersonReinstated       | 人员复职后     | personId, tenantId                | 审计模块、用户管理        |
    | PersonDeleted          | 人员删除后     | personId, tenantId                | 审计模块、用户管理        |

    表 4.3.8-1 组织管理领域事件

+   组织管理领域订阅以下来自其他子领域的领域事件：

    | 事件名称       | 来源子领域 | 处理逻辑                                                        | 说明                                         |
    | -------------- | ---------- | --------------------------------------------------------------- | -------------------------------------------- |
    | UserCreated    | 用户管理   | 若为企业同步（createBySync）场景，调用PersonService自动创建人员 | 仅当事件携带syncSource标识时触发             |
    | UserRegistered | 用户管理   | 若租户配置了默认部门/岗位，调用AppointmentService创建默认任职   | 需读取ConfigService获取租户默认部门/岗位配置 |
    | UserDisabled   | 用户管理   | 可选更新关联人员的在职状态                                      | 具体策略取决于租户配置，非强制               |
    | UserDeleted    | 用户管理   | 解除人员与用户的关联（PersonService.unbindUser）                | 保留人员记录，仅解除userId关联               |

    表 4.3.8-2 组织管理订阅的外部领域事件

### 4.3.9 协作关系

+   本节梳理组织管理子领域与其他子领域及共享服务之间的协作关系，包括领域内协作、跨领域协作和共享服务协作三个层面。

#### 4.3.9.1 领域内协作

+   组织管理子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方              | 被调用方               | 协作方式 | 触发场景      | 说明                                                              |
    | --------- | ------------------- | ---------------------- | -------- | ------------- | ----------------------------------------------------------------- |
    | INTRA-101 | OrganizationService | Organization（聚合根） | 方法调用 | 创建组织单元  | 调用Organization.create(cmd)，校验层级规则和编码唯一性            |
    | INTRA-102 | OrganizationService | Organization（聚合根） | 方法调用 | 移动组织单元  | 调用Organization.moveTo(newParentId)，校验循环引用和层级约束      |
    | INTRA-103 | PersonService       | Person（聚合根）       | 方法调用 | 创建人员      | 调用Person.create(cmd)                                            |
    | INTRA-104 | PersonService       | Person（聚合根）       | 方法调用 | 关联/解除用户 | 调用Person.bindUser(userId)、Person.unbindUser()                  |
    | INTRA-105 | PersonService       | Person（聚合根）       | 方法调用 | 人员离职      | 调用Person.resign(resignDate)，联动AppointmentService终止所有任职 |
    | INTRA-106 | PersonService       | AppointmentService     | 方法调用 | 人员离职      | 调用AppointmentService.terminateAllAppointments(personId)         |
    | INTRA-107 | AppointmentService  | Appointment（聚合根）  | 方法调用 | 创建任职      | 调用Appointment.create(cmd)，校验人员在职、岗位有效、组织有效     |
    | INTRA-108 | AppointmentService  | Appointment（聚合根）  | 方法调用 | 调岗          | 调用Appointment.transfer(newOrgId, newPosId)                      |
    | INTRA-109 | AppointmentService  | Appointment（聚合根）  | 方法调用 | 设为主职      | 先将原主职变为兼职，再设置新主职                                  |
    | INTRA-110 | PositionService     | Position（聚合根）     | 方法调用 | 创建岗位      | 调用Position.create(cmd)，校验编码唯一性                          |
    | INTRA-111 | OrgSyncService      | OrganizationService    | 方法调用 | 同步组织      | 全量/增量同步时逐条调用createOrganization或updateOrganization     |
    | INTRA-112 | OrgSyncService      | PersonService          | 方法调用 | 同步人员      | 同步时调用createPerson或updatePerson，自动关联用户                |
    | INTRA-113 | OrgSyncService      | PositionService        | 方法调用 | 同步岗位      | 同步时调用createPosition                                          |
    | INTRA-114 | OrgSyncService      | AppointmentService     | 方法调用 | 同步任职      | 同步时调用createAppointment                                       |

    表 4.3.9.1-1 领域内协作关系

#### 4.3.9.2 跨领域协作

+   组织管理子领域与其他子领域的跨领域协作通过事件驱动和RPC调用两种方式实现。

##### 与用户管理子领域（第3章）的协作

+   组织管理与用户管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                               |
    | --------- | ------------------- | -------- | ------------------------------------------- | ------------------------------------------------------------------ |
    | CROSS-101 | 用户管理 → 组织管理 | 领域事件 | UserCreated                                 | 企业同步（createBySync）创建用户后，通知组织管理子领域创建对应人员 |
    | CROSS-102 | 用户管理 → 组织管理 | 领域事件 | UserRegistered                              | 租户用户开放注册后，若租户配置了默认部门/岗位则触发默认任职创建    |
    | CROSS-103 | 用户管理 → 组织管理 | 领域事件 | UserDisabled                                | 用户被禁用后，可选通知组织管理域更新人员在职状态                   |
    | CROSS-104 | 用户管理 → 组织管理 | 领域事件 | UserDeleted                                 | 用户被删除后，通知组织管理域解除人员与用户的关联                   |
    | CROSS-105 | 组织管理 → 用户管理 | RPC调用  | UserQueryService.getUserBasicInfoForToken() | 组织管理需要获取用户基本信息用于人员关联展示                       |
    | CROSS-106 | 组织管理 → 用户管理 | 领域事件 | PersonResigned                              | 人员离职后，通知用户管理域可选禁用关联的用户账号                   |
    | CROSS-107 | 组织管理 → 用户管理 | 领域事件 | PersonUserBound                             | 人员关联用户后，通知用户管理域更新用户的组织归属信息               |
    | CROSS-108 | 组织管理 → 用户管理 | 领域事件 | PersonUserUnbound                           | 人员解除用户关联后，通知用户管理域清除用户的组织归属信息           |

    表 4.3.9.2-1 与用户管理子领域的协作

+   协作说明：
    -   CROSS-101~104与第3章表3.3.8.2-1中CROSS-001~005为同一组协作的双视角描述，此处从组织管理作为接收方的角度补充
    -   CROSS-106~108为组织管理主动发布的事件，第3章3.3.8.2节未从用户管理作为接收方角度列出（见批次2中对第3章的建议）

##### 与授权管理子领域（第6章）的协作

+   组织管理与授权管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                             |
    | --------- | ------------------- | -------- | ------------------------------------------- | ------------------------------------------------ |
    | CROSS-111 | 组织管理 → 授权管理 | 领域事件 | OrganizationCreated / OrganizationDeleted   | 组织变更后，授权子领域刷新数据权限范围缓存       |
    | CROSS-112 | 组织管理 → 授权管理 | 领域事件 | AppointmentCreated / AppointmentTransferred | 任职变更后，授权子领域刷新用户的数据权限范围缓存 |
    | CROSS-113 | 授权管理 → 组织管理 | RPC调用  | OrganizationQueryService.getTree()          | 授权管理在配置数据权限范围时需查询组织树         |

    表 4.3.9.2-2 与授权管理子领域的协作

##### 与审计管理子领域（第7章）的协作

+   组织管理与审计管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口        | 说明                                                  |
    | --------- | ------------------- | -------- | -------------------- | ----------------------------------------------------- |
    | CROSS-121 | 组织管理 → 审计管理 | 领域事件 | 所有组织管理领域事件 | 审计子领域订阅表4.3.8-1中的全部事件，记录操作审计日志 |
    | CROSS-122 | 组织管理 → 审计管理 | 领域事件 | PersonResigned       | 审计子领域额外记录人员离职安全审计日志                |
    | CROSS-123 | 组织管理 → 审计管理 | 领域事件 | OrgSyncFailed        | 审计子领域记录同步失败安全事件                        |

    表 4.3.9.2-3 与审计管理子领域的协作

##### 与配置管理子领域（第9章）的协作

+   组织管理与配置管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                | 说明                                                                               |
    | --------- | ------------------- | -------- | ---------------------------- | ---------------------------------------------------------------------------------- |
    | CROSS-131 | 组织管理 → 配置管理 | RPC调用  | ConfigService.getEffective() | 获取三级合并后的配置生效值，如默认部门编码、默认岗位编码等（用于开放注册默认任职） |
    | CROSS-132 | 组织管理 → 配置管理 | RPC调用  | ConfigService.batchGet()     | 批量获取同步相关配置（同步周期、字段映射规则等）                                   |
    | CROSS-133 | 配置管理 → 组织管理 | 领域事件 | TenantConfigChanged          | 租户配置变更后，组织管理域刷新缓存的配置值（含默认部门/岗位、同步配置等）          |

    表 4.3.9.2-4 与配置管理子领域的协作

##### 与通知上下文（BC-12）的协作

+   组织管理与通知上下文之间的协作关系如下表所示。

    | 协作编号  | 方向             | 协作方式 | 触发事件/接口 | 说明                                       |
    | --------- | ---------------- | -------- | ------------- | ------------------------------------------ |
    | CROSS-141 | 组织管理 → BC-12 | 领域事件 | OrgSyncFailed | 通知上下文发送同步失败告警通知给租户管理员 |

    表 4.3.9.2-5 与通知上下文（BC-12）的协作

#### 4.3.9.3 共享服务协作

+   组织管理子领域使用的共享服务（第8章）协作关系如下表所示。

    | 协作编号  | 共享服务        | 调用方法              | 调用场景                                                   | 参考章节 |
    | --------- | --------------- | --------------------- | ---------------------------------------------------------- | -------- |
    | SHARE-101 | PasswordService | hashPassword()        | PersonService.createPersonWithUser()创建用户时加密初始密码 | 8.3.2    |
    | SHARE-102 | PasswordService | checkPasswordPolicy() | 创建人员并同时创建用户账号时校验密码强度                   | 8.3.2    |
    | SHARE-103 | CaptchaService  | sendEmailCode()       | 创建人员并创建用户账号时发送激活验证码                     | 8.4.2    |

    表 4.3.9.3-1 共享服务协作关系

+   共享服务协作说明：
    -   PasswordService和CaptchaService的方法签名与第8章定义保持一致，详细参数和约束见表8.3.2-1和表8.4.2-1
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口（表9.3.1.3-1）作为基础设施供所有子领域使用，已在4.3.9.2中作为跨领域协作列出
    -   组织管理子领域不直接调用TokenService和MfaService，这两项共享服务的调用由认证管理子领域（第5章）承担

## 4.4 接口设计

+   本节设计组织管理子领域的API接口，按接口类型分为REST API、RPC和消息三类。
+   REST API仅适用于租户用户群，由租户管理员调用。RPC接口供其他子领域内部调用。消息接口通过领域事件发布。

### 4.4.1 接口总览

+   组织管理子领域对外提供REST API、RPC和消息三类接口。

#### 4.4.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明           |
    | -------- | ---- | -------------- |
    | REST API | 33个 | 前端调用       |
    | RPC接口  | 1个  | 微服务内部调用 |
    | 消息接口 | 24个 | 事件发布       |

    表 4.4.1.1-1 接口分类统计

+   说明：
    -   REST API按功能模块分为组织单元（8个）、岗位（6个）、人员（9个）、任职（6个）、同步管理（4个）
    -   RPC接口供授权管理子领域（第6章）通过Feign调用
    -   消息接口通过领域事件发布，事件定义详见表4.3.8-1

#### 4.4.1.2 REST API清单表

+   组织管理 REST API 清单如下表所示。

    | API编号    | API名称          | 方法   | 路径                                    | 权限                      | 领域方法                                   | 备注         |
    | ---------- | ---------------- | ------ | --------------------------------------- | ------------------------- | ------------------------------------------ | ------------ |
    | UR-ORG-01  | 创建组织单元     | POST   | /api/v1/ur/org                          | ur:iam:org:create         | OrganizationService.createOrganization()   | -            |
    | UR-ORG-02  | 更新组织单元     | PUT    | /api/v1/ur/org/{id}                     | ur:iam:org:update         | Organization.update()                      | 仅LOCAL可改  |
    | UR-ORG-03  | 移动组织单元     | PUT    | /api/v1/ur/org/{id}/move                | ur:iam:org:update         | OrganizationService.moveOrganization()     | 仅LOCAL可移  |
    | UR-ORG-04  | 删除组织单元     | DELETE | /api/v1/ur/org/{id}                     | ur:iam:org:delete         | OrganizationService.deleteOrganization()   | 仅LOCAL可删  |
    | UR-ORG-05  | 查询组织单元详情 | GET    | /api/v1/ur/org/{id}                     | ur:iam:org:detail         | OrganizationQueryService.getById()         | -            |
    | UR-ORG-06  | 查询组织树       | GET    | /api/v1/ur/org/tree                     | ur:iam:org:list           | OrganizationQueryService.getTree()         | -            |
    | UR-ORG-07  | 分页查询组织单元 | GET    | /api/v1/ur/org                          | ur:iam:org:list           | OrganizationQueryService.page()            | 支持分页     |
    | UR-ORG-08  | 查询子组织列表   | GET    | /api/v1/ur/org/{id}/children            | ur:iam:org:list           | OrganizationQueryService.getChildren()     | -            |
    | UR-POS-01  | 创建岗位         | POST   | /api/v1/ur/position                     | ur:iam:position:create    | PositionService.createPosition()           | -            |
    | UR-POS-02  | 更新岗位         | PUT    | /api/v1/ur/position/{id}                | ur:iam:position:update    | Position.update()                          | 仅LOCAL可改  |
    | UR-POS-03  | 变更岗位状态     | PUT    | /api/v1/ur/position/{id}/status         | ur:iam:position:update    | Position.changeStatus()                    | 状态机操作   |
    | UR-POS-04  | 删除岗位         | DELETE | /api/v1/ur/position/{id}                | ur:iam:position:delete    | PositionService.deletePosition()           | 仅LOCAL可删  |
    | UR-POS-05  | 查询岗位详情     | GET    | /api/v1/ur/position/{id}                | ur:iam:position:detail    | PositionQueryService.getById()             | -            |
    | UR-POS-06  | 分页查询岗位     | GET    | /api/v1/ur/position                     | ur:iam:position:list      | PositionQueryService.page()                | 支持分页     |
    | UR-PSN-01  | 创建人员         | POST   | /api/v1/ur/person                       | ur:iam:person:create      | PersonService.createPerson()               | -            |
    | UR-PSN-02  | 更新人员         | PUT    | /api/v1/ur/person/{id}                  | ur:iam:person:update      | Person.update()                            | 仅LOCAL可改  |
    | UR-PSN-03  | 关联用户         | PUT    | /api/v1/ur/person/{id}/bind-user        | ur:iam:person:update      | PersonService.bindUser()                   | -            |
    | UR-PSN-04  | 解除用户关联     | PUT    | /api/v1/ur/person/{id}/unbind-user      | ur:iam:person:update      | PersonService.unbindUser()                 | -            |
    | UR-PSN-05  | 人员离职         | PUT    | /api/v1/ur/person/{id}/resign           | ur:iam:person:update      | PersonService.resignPerson()               | 终止所有任职 |
    | UR-PSN-06  | 人员复职         | PUT    | /api/v1/ur/person/{id}/reinstate        | ur:iam:person:update      | PersonService.reinstatePerson()            | -            |
    | UR-PSN-07  | 查询人员详情     | GET    | /api/v1/ur/person/{id}                  | ur:iam:person:detail      | PersonQueryService.getById()               | -            |
    | UR-PSN-08  | 分页查询人员     | GET    | /api/v1/ur/person                       | ur:iam:person:list        | PersonQueryService.page()                  | 支持分页     |
    | UR-PSN-09  | 删除人员         | DELETE | /api/v1/ur/person/{id}                  | ur:iam:person:delete      | PersonService.deletePerson()               | 仅LOCAL可删  |
    | UR-APT-01  | 创建任职         | POST   | /api/v1/ur/appointment                  | ur:iam:appointment:create | AppointmentService.createAppointment()     | -            |
    | UR-APT-02  | 调岗             | PUT    | /api/v1/ur/appointment/{id}/transfer    | ur:iam:appointment:update | AppointmentService.transferAppointment()   | 仅LOCAL可调  |
    | UR-APT-03  | 终止任职         | PUT    | /api/v1/ur/appointment/{id}/terminate   | ur:iam:appointment:update | Appointment.terminate()                    | 仅LOCAL可终  |
    | UR-APT-04  | 设为主职         | PUT    | /api/v1/ur/appointment/{id}/set-primary | ur:iam:appointment:update | AppointmentService.setPrimaryAppointment() | 原主职变兼职 |
    | UR-APT-05  | 查询任职详情     | GET    | /api/v1/ur/appointment/{id}             | ur:iam:appointment:detail | AppointmentQueryService.getById()          | -            |
    | UR-APT-06  | 分页查询任职     | GET    | /api/v1/ur/appointment                  | ur:iam:appointment:list   | AppointmentQueryService.page()             | 支持分页     |
    | UR-SYNC-01 | 触发全量同步     | POST   | /api/v1/ur/sync/full                    | ur:iam:sync:execute       | OrgSyncService.fullSync()                  | -            |
    | UR-SYNC-02 | 触发增量同步     | POST   | /api/v1/ur/sync/incremental             | ur:iam:sync:execute       | OrgSyncService.incrementalSync()           | -            |
    | UR-SYNC-03 | 查询同步状态     | GET    | /api/v1/ur/sync/status                  | ur:iam:sync:list          | SyncQueryService.getStatus()               | -            |
    | UR-SYNC-04 | 查询同步异常     | GET    | /api/v1/ur/sync/exceptions              | ur:iam:sync:list          | SyncQueryService.getExceptions()           | 支持分页     |

    表 4.4.1.2-1 组织管理REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   权限：四段式权限标识，格式为`{用户群}:{限界上下文}:{资源}:{操作}`，详见附录D.3
    -   领域方法：关联到第4.3节领域模型设计中的聚合方法或服务方法
    -   备注：简要说明接口的特殊情况

#### 4.4.1.3 RPC接口清单表

+   组织管理子领域提供的RPC接口清单如下表所示。

    | 接口编号   | 接口名称   | 调用方        | 接口类型 | 领域方法                           | 说明                                     |
    | ---------- | ---------- | ------------- | -------- | ---------------------------------- | ---------------------------------------- |
    | RPC-ORG-01 | 查询组织树 | BC-10授权子域 | Feign    | OrganizationQueryService.getTree() | 授权管理在配置数据权限范围时需查询组织树 |

    表 4.4.1.3-1 RPC接口清单表

#### 4.4.1.4 消息接口清单表

+   组织管理子领域发布的消息接口清单如下表所示。

    | 接口编号   | 消息名称               | 消息类型 | Topic      | 触发领域方法                                | 消费方                    |
    | ---------- | ---------------------- | -------- | ---------- | ------------------------------------------- | ------------------------- |
    | MSG-ORG-01 | OrganizationCreated    | 领域事件 | iam.events | OrganizationService.createOrganization()    | 审计模块、授权管理        |
    | MSG-ORG-02 | OrganizationUpdated    | 领域事件 | iam.events | Organization.update()                       | 审计模块                  |
    | MSG-ORG-03 | OrganizationMoved      | 领域事件 | iam.events | OrganizationService.moveOrganization()      | 审计模块、授权管理        |
    | MSG-ORG-04 | OrganizationDeleted    | 领域事件 | iam.events | OrganizationService.deleteOrganization()    | 审计模块、授权管理        |
    | MSG-ORG-05 | PositionCreated        | 领域事件 | iam.events | PositionService.createPosition()            | 审计模块                  |
    | MSG-ORG-06 | PositionUpdated        | 领域事件 | iam.events | Position.update()                           | 审计模块                  |
    | MSG-ORG-07 | PositionDisabled       | 领域事件 | iam.events | Position.disable()                          | 审计模块                  |
    | MSG-ORG-08 | PersonCreated          | 领域事件 | iam.events | PersonService.createPerson()                | 审计模块、用户管理        |
    | MSG-ORG-09 | PersonUpdated          | 领域事件 | iam.events | Person.update()                             | 审计模块                  |
    | MSG-ORG-10 | PersonResigned         | 领域事件 | iam.events | PersonService.resignPerson()                | 审计模块、用户管理        |
    | MSG-ORG-11 | PersonUserBound        | 领域事件 | iam.events | PersonService.bindUser()                    | 审计模块、用户管理        |
    | MSG-ORG-12 | PersonUserUnbound      | 领域事件 | iam.events | PersonService.unbindUser()                  | 审计模块、用户管理        |
    | MSG-ORG-13 | AppointmentCreated     | 领域事件 | iam.events | AppointmentService.createAppointment()      | 审计模块、授权管理        |
    | MSG-ORG-14 | AppointmentTransferred | 领域事件 | iam.events | AppointmentService.transferAppointment()    | 审计模块、授权管理        |
    | MSG-ORG-15 | AppointmentTerminated  | 领域事件 | iam.events | Appointment.terminate()                     | 审计模块                  |
    | MSG-ORG-16 | OrgSyncCompleted       | 领域事件 | iam.events | OrgSyncService.fullSync()/incrementalSync() | 审计模块                  |
    | MSG-ORG-17 | OrgSyncFailed          | 领域事件 | iam.events | OrgSyncService.fullSync()/incrementalSync() | 审计模块、告警服务、BC-12 |
    | MSG-ORG-18 | OrganizationDisabled   | 领域事件 | iam.events | Organization.disable()                      | 审计模块、授权管理        |
    | MSG-ORG-19 | OrganizationEnabled    | 领域事件 | iam.events | Organization.enable()                       | 审计模块、授权管理        |
    | MSG-ORG-20 | PositionEnabled        | 领域事件 | iam.events | Position.enable()                           | 审计模块                  |
    | MSG-ORG-21 | PositionDeleted        | 领域事件 | iam.events | PositionService.deletePosition()            | 审计模块                  |
    | MSG-ORG-22 | PersonReinstated       | 领域事件 | iam.events | PersonService.reinstatePerson()             | 审计模块、用户管理        |
    | MSG-ORG-23 | PersonDeleted          | 领域事件 | iam.events | PersonService.deletePerson()                | 审计模块、用户管理        |
    | MSG-ORG-24 | AppointmentSetPrimary  | 领域事件 | iam.events | AppointmentService.setPrimaryAppointment()  | 审计模块、授权管理        |

    表 4.4.1.4-1 消息接口清单表

### 4.4.2 RPC接口设计

+   组织管理子领域通过Feign向其他子领域提供内部RPC接口。

#### 4.4.2.1 OrganizationFeignClient

+   **OrganizationFeignClient 概述**

    | 属性     | 值                              |
    | -------- | ------------------------------- |
    | 接口名称 | OrganizationFeignClient         |
    | 职责     | 供BC-10授权子域查询组织架构信息 |
    | 服务名   | svc-iam                         |
    | 路径前缀 | /internal/iam/organizations     |
    | 降级实现 | OrganizationFeignClientFallback |
    | 默认超时 | 5秒                             |

    表 4.4.2.1-1 OrganizationFeignClient概述

+   **方法清单表**

    | 方法              | 简述               | HTTP | 路径  | 入参           | 返回               | 超时 | 降级返回 |
    | ----------------- | ------------------ | ---- | ----- | -------------- | ------------------ | ---- | -------- |
    | getTree(tenantId) | 查询租户完整组织树 | GET  | /tree | tenantId: Long | OrganizationTreeVO | 5秒  | 空树     |

    表 4.4.2.1-2 OrganizationFeignClient方法清单表

+   **RPC-ORG-01 getTree 契约**

    | 属性     | 值                                                       |
    | -------- | -------------------------------------------------------- |
    | 接口编号 | RPC-ORG-01                                               |
    | 调用场景 | 授权子域配置数据权限范围时调用，获取组织树供前端展示选择 |
    | 入参     | tenantId: Long                                           |
    | 返回类型 | OrganizationTreeVO                                       |
    | 幂等性   | 是（只读查询）                                           |

    表 4.4.2.1-3 RPC-ORG-01契约概述

+   **OrganizationTreeVO 结构**

     | 字段名    | 数据类型                 | 说明                     |
     | --------- | ------------------------ | ------------------------ |
     | id        | Long                     | 组织ID                   |
     | code      | String                   | 组织编码                 |
     | name      | String                   | 组织名称                 |
     | type      | String                   | 组织类型枚举值           |
     | parentId  | Long                     | 上级组织ID，根节点为null |
     | sortOrder | Integer                  | 排序号                   |
     | children  | List<OrganizationTreeVO> | 子组织列表（递归结构）   |

    表 4.4.2.1-4 OrganizationTreeVO字段

+   **备注**
    -   接口为只读查询，走只读事务，不修改任何数据
    -   接口定义在 `bc-10-iam-api` 模块的 `feign` 包下
    -   返回结果已按sortOrder排序，调用方无需二次排序
    -   与4.3.9.2 CROSS-113协作关系对应

#### 4.4.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口    | 降级条件        | 降级返回值                        | 日志级别 | 说明                                                     |
    | ------- | --------------- | --------------------------------- | -------- | -------------------------------------------------------- |
    | getTree | 超时/服务不可用 | 空OrganizationTreeVO(children=[]) | WARN     | 授权配置页面显示空树并提示"组织数据暂不可用，请稍后重试" |

    表 4.4.2.2-1 降级策略

+   **降级设计说明**
    -   getTree降级策略偏宽松：组织树不可用仅影响权限范围配置操作，不影响已有权限的正常使用
    -   熔断策略：连续5次调用失败后触发熔断，熔断窗口30秒，半开状态允许1个探测请求
    -   与第3章3.4.2.2降级策略（表3.4.2.2-1）采用相同的熔断参数

### 4.4.3 消息接口设计

+   组织管理子领域通过领域事件发布消息。所有事件共享统一的通道和封装规范。

#### 4.4.3.1 消息通道配置

+   组织管理的消息通道配置如下表所示。

    | 通道名称   | Topic/Exchange | 类型  | 说明        |
    | ---------- | -------------- | ----- | ----------- |
    | iam-events | iam.events     | Topic | IAM领域事件 |

    表 4.4.3.1-1 消息通道配置

+   **消息规范**
    -   所有领域事件统一发布至 `iam.events` Topic，与用户管理子领域（第3章）共享同一Topic，消费方通过事件类型（`type`字段）过滤订阅
    -   事件消息采用CloudEvents规范封装，包含 `type`、`source`、`id`、`time`、`data` 标准字段
    -   事件发布采用本地事务表（Outbox模式）保证与业务操作的原子性，由后台任务异步投递至消息中间件
    -   消费方必须实现幂等处理，以eventId作为去重键

#### 4.4.3.2 事件公共信封结构

+   所有事件共享以下CloudEvents信封字段，各事件的Payload仅定义 `data` 部分。与第3章表3.4.3.2-1采用相同的信封结构。

    | 信封字段        | 类型     | 说明                                   | 示例值                                 |
    | --------------- | -------- | -------------------------------------- | -------------------------------------- |
    | id              | String   | 事件唯一标识（UUID）                   | "f47ac10b-58cc-4372-a567-0e02b2c3d479" |
    | type            | String   | 事件类型，对应消息名称                 | "OrganizationCreated"                  |
    | source          | String   | 事件来源，格式：/{context}/{subdomain} | "/bc-10/organization-management"       |
    | time            | DateTime | 事件发生时间（ISO 8601）               | "2026-01-26T10:30:00Z"                 |
    | datacontenttype | String   | data内容类型                           | "application/json"                     |
    | data            | Object   | 事件Payload（各事件不同，见下文）      | { ... }                                |

    表 4.4.3.2-1 事件公共信封结构

#### 4.4.3.3 组织生命周期事件

+   以下事件覆盖组织单元从创建到删除的完整生命周期。

##### MSG-ORG-01 OrganizationCreated

+   **消息概述**

    | 属性     | 值                                         |
    | -------- | ------------------------------------------ |
    | 消息编号 | MSG-ORG-01                                 |
    | 消息名称 | OrganizationCreated                        |
    | Topic    | iam.events                                 |
    | 消费方   | 审计模块、授权管理                         |
    | 触发时机 | 创建组织单元成功后（含本地创建和同步创建） |

    表 4.4.3.3-1 MSG-ORG-01消息概述

+   **Payload字段说明**

     | 字段名   | 数据类型 | 说明                        |
     | -------- | -------- | --------------------------- |
     | orgId    | Long     | 组织ID                      |
     | tenantId | Long     | 租户ID                      |
     | code     | String   | 组织编码                    |
     | name     | String   | 组织名称                    |
     | type     | String   | 组织类型：COMPANY/DEPT/TEAM |
     | parentId | Long     | 上级组织ID                  |
     | source   | String   | 数据来源：LOCAL/EXTERNAL    |

    表 4.4.3.3-2 MSG-ORG-01 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                 | 幂等策略    | 失败处理      |
    | -------- | ---------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录组织创建操作日志                     | eventId去重 | 重试3次后告警 |
    | 授权管理 | 刷新数据权限范围缓存，新组织加入可选范围 | eventId去重 | 重试3次后告警 |

    表 4.4.3.3-3 MSG-ORG-01消费方处理

##### MSG-ORG-02 ~ MSG-ORG-04 组织变更事件（简表）

+   以下组织变更事件结构与MSG-ORG-01相似，以简表列出差异。

    | 消息编号   | 消息名称             | 触发时机       | 特有Payload字段                 | 消费方             |
    | ---------- | -------------------- | -------------- | ------------------------------- | ------------------ |
    | MSG-ORG-02 | OrganizationUpdated  | 组织信息更新后 | orgId, changedFields            | 审计模块、授权管理 |
    | MSG-ORG-03 | OrganizationMoved    | 组织移动后     | orgId, oldParentId, newParentId | 审计模块、授权管理 |
    | MSG-ORG-04 | OrganizationDeleted  | 组织删除后     | orgId, tenantId                 | 审计模块、授权管理 |
    | MSG-ORG-18 | OrganizationDisabled | 组织禁用后     | orgId, tenantId                 | 审计模块、授权管理 |
    | MSG-ORG-19 | OrganizationEnabled  | 组织启用后     | orgId, tenantId                 | 审计模块、授权管理 |

    表 4.4.3.3-4 组织变更事件简表

+   **公共Payload字段**（与MSG-ORG-01相同）：orgId, tenantId

#### 4.4.3.4 岗位事件

+   以下事件覆盖岗位的创建、更新、启停用和删除，消费方均为审计模块。

    | 消息编号   | 消息名称         | 触发时机   | Payload字段（data部分）                    | 消费方   |
    | ---------- | ---------------- | ---------- | ------------------------------------------ | -------- |
    | MSG-ORG-05 | PositionCreated  | 岗位创建后 | positionId, tenantId, code, name, category | 审计模块 |
    | MSG-ORG-06 | PositionUpdated  | 岗位更新后 | positionId, changedFields                  | 审计模块 |
    | MSG-ORG-07 | PositionDisabled | 岗位停用后 | positionId, disabledBy                     | 审计模块 |
    | MSG-ORG-20 | PositionEnabled  | 岗位启用后 | positionId, enabledBy                      | 审计模块 |
    | MSG-ORG-21 | PositionDeleted  | 岗位删除后 | positionId, tenantId                       | 审计模块 |

    表 4.4.3.4-1 岗位事件汇总

+   **消费方处理契约**（统一）

    | 消费方   | 处理逻辑         | 幂等策略    | 失败处理      |
    | -------- | ---------------- | ----------- | ------------- |
    | 审计模块 | 记录岗位操作日志 | eventId去重 | 重试3次后告警 |

    表 4.4.3.4-2 岗位事件消费方处理

#### 4.4.3.5 人员生命周期事件

+   以下事件覆盖人员从创建到离职、用户关联变更的完整生命周期，涉及跨领域协作。

##### MSG-ORG-08 PersonCreated

+   **消息概述**

    | 属性     | 值                                     |
    | -------- | -------------------------------------- |
    | 消息编号 | MSG-ORG-08                             |
    | 消息名称 | PersonCreated                          |
    | Topic    | iam.events                             |
    | 消费方   | 审计模块、用户管理                     |
    | 触发时机 | 创建人员成功后（含本地创建和同步创建） |

    表 4.4.3.5-1 MSG-ORG-08消息概述

+   **Payload字段说明**

     | 字段名     | 数据类型 | 说明                     |
     | ---------- | -------- | ------------------------ |
     | personId   | Long     | 人员ID                   |
     | tenantId   | Long     | 租户ID                   |
     | employeeNo | String   | 工号                     |
     | name       | String   | 姓名                     |
     | userId     | Long     | 关联用户ID（可能为null） |
     | source     | String   | 数据来源：LOCAL/EXTERNAL |

    表 4.4.3.5-2 MSG-ORG-08 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                           | 幂等策略    | 失败处理      |
    | -------- | -------------------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录人员创建操作日志                               | eventId去重 | 重试3次后告警 |
    | 用户管理 | 若携带userId则通知用户管理域更新用户的组织归属信息 | eventId去重 | 重试3次后告警 |

    表 4.4.3.5-3 MSG-ORG-08消费方处理

##### MSG-ORG-09 ~ MSG-ORG-12 人员变更事件（简表）

+   以下人员变更事件以简表列出差异。

    | 消息编号   | 消息名称          | 触发时机       | 特有Payload字段         | 消费方             |
    | ---------- | ----------------- | -------------- | ----------------------- | ------------------ |
    | MSG-ORG-09 | PersonUpdated     | 人员信息更新后 | personId, changedFields | 审计模块           |
    | MSG-ORG-10 | PersonResigned    | 人员离职后     | personId, resignDate    | 审计模块、用户管理 |
    | MSG-ORG-11 | PersonUserBound   | 人员关联用户后 | personId, userId        | 审计模块、用户管理 |
    | MSG-ORG-12 | PersonUserUnbound | 人员解除关联后 | personId, userId        | 审计模块、用户管理 |
    | MSG-ORG-22 | PersonReinstated  | 人员复职后     | personId, tenantId      | 审计模块、用户管理 |
    | MSG-ORG-23 | PersonDeleted     | 人员删除后     | personId, tenantId      | 审计模块、用户管理 |

    表 4.4.3.5-4 人员变更事件简表

+   **公共Payload字段**：personId, tenantId

+   **跨领域消费方处理说明**
    -   用户管理消费PersonResigned：可选触发禁用关联的用户账号（策略由租户配置决定）
    -   用户管理消费PersonUserBound/Unbound：更新用户的组织归属信息，影响Token claims中的orgId等字段

#### 4.4.3.6 任职变更事件

+   以下事件覆盖任职创建、调岗、终止，涉及授权管理跨领域协作。

##### MSG-ORG-13 AppointmentCreated

+   **消息概述**

    | 属性     | 值                                               |
    | -------- | ------------------------------------------------ |
    | 消息编号 | MSG-ORG-13                                       |
    | 消息名称 | AppointmentCreated                               |
    | Topic    | iam.events                                       |
    | 消费方   | 审计模块、授权管理                               |
    | 触发时机 | 创建任职成功后（含本地创建、同步创建、默认任职） |

    表 4.4.3.6-1 MSG-ORG-13消息概述

+   **Payload字段说明**

     | 字段名        | 数据类型 | 说明     |
     | ------------- | -------- | -------- |
     | appointmentId | Long     | 任职ID   |
     | personId      | Long     | 人员ID   |
     | orgId         | Long     | 组织ID   |
     | positionId    | Long     | 岗位ID   |
     | isPrimary     | Boolean  | 是否主职 |
     | tenantId      | Long     | 租户ID   |

    表 4.4.3.6-2 MSG-ORG-13 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                     | 幂等策略    | 失败处理      |
    | -------- | -------------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录任职创建操作日志                         | eventId去重 | 重试3次后告警 |
    | 授权管理 | 刷新该用户的数据权限范围缓存（新增组织维度） | eventId去重 | 重试3次后告警 |

    表 4.4.3.6-3 MSG-ORG-13消费方处理

##### MSG-ORG-14 ~ MSG-ORG-15 任职变更事件（简表）

+   以下任职变更事件以简表列出差异。

    | 消息编号   | 消息名称               | 触发时机   | 特有Payload字段                                       | 消费方             |
    | ---------- | ---------------------- | ---------- | ----------------------------------------------------- | ------------------ |
    | MSG-ORG-14 | AppointmentTransferred | 任职调岗后 | appointmentId, oldOrgId, newOrgId, oldPosId, newPosId | 审计模块、授权管理 |
    | MSG-ORG-15 | AppointmentTerminated  | 任职终止后 | appointmentId, endDate                                | 审计模块           |
    | MSG-ORG-24 | AppointmentSetPrimary  | 设为主职后 | appointmentId, personId, oldPrimaryId                 | 审计模块、授权管理 |

    表 4.4.3.6-4 任职变更事件简表

#### 4.4.3.7 同步事件

+   以下事件覆盖企业同步的完成和失败，OrgSyncFailed涉及跨上下文协作。

    | 消息编号   | 消息名称         | 触发时机   | Payload字段（data部分）                   | 消费方                    |
    | ---------- | ---------------- | ---------- | ----------------------------------------- | ------------------------- |
    | MSG-ORG-16 | OrgSyncCompleted | 同步完成后 | tenantId, syncType, syncReport            | 审计模块                  |
    | MSG-ORG-17 | OrgSyncFailed    | 同步失败后 | tenantId, syncType, errorInfo, failedStep | 审计模块、告警服务、BC-12 |

    表 4.4.3.7-1 同步事件汇总

+   **消费方处理契约**

    | 消费方   | 处理逻辑                         | 幂等策略    | 失败处理      |
    | -------- | -------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录同步操作日志                 | eventId去重 | 重试3次后告警 |
    | 告警服务 | 触发运维告警                     | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送同步失败告警通知给租户管理员 | eventId去重 | 重试3次后告警 |

    表 4.4.3.7-2 同步事件消费方处理

### 4.4.4 REST接口设计

#### 4.4.4.1 组织单元接口（UR-ORG）

##### 4.4.4.1.1 UR-ORG-01 创建组织单元

+   **契约概述表**

    | 属性       | 值                                                                      |
    | ---------- | ----------------------------------------------------------------------- |
    | API编号    | UR-ORG-01                                                               |
    | 接口路径   | POST /api/v1/ur/org                                                     |
    | 功能简述   | 创建本地组织单元（部门/分支机构/虚拟组织等），支持树形层级结构          |
    | 所需权限   | ur:iam:org:create                                                       |
    | 关联功能   | F-ORG-01 组织单元管理                                                   |
    | 关联用例   | UC-ORG-01 管理员创建组织单元                                            |
    | 关联领域   | OrganizationService.createOrganization()                                |
    | 关联规则   | ORG-R-01（编码唯一）, ORG-R-02（层级深度≤10）, ORG-R-03（父节点有效性） |
    | 幂等性     | 否（编码唯一性保证不重复创建）                                          |
    | 关联错误码 | E-400001, E-404003, E-409020                                            |

    表 4.4.4.1.1-1 UR-ORG-01契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型    | 必填 | 约束                                   | 示例值             | 业务含义               |
    | ----------- | ---- | ------- | ---- | -------------------------------------- | ------------------ | ---------------------- |
    | code        | body | String  | 是   | 3-32字符，字母数字下划线               | "DEPT_RD_001"      | 组织编码（租户内唯一） |
    | name        | body | String  | 是   | 2-64字符                               | "研发一部"         | 组织名称               |
    | type        | body | String  | 是   | 枚举：COMPANY/BRANCH/DEPT/TEAM/VIRTUAL | "DEPT"             | 组织类型               |
    | parentId    | body | Number  | 否   | 正整数，空或0则为根节点                | 100001             | 上级组织ID             |
    | sortOrder   | body | Integer | 否   | ≥0，默认0                              | 10                 | 同级排序序号           |
    | description | body | String  | 否   | 长度≤500                               | "负责核心产品研发" | 组织描述               |

    表 4.4.4.1.1-2 UR-ORG-01请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                   | 业务含义   |
    | -------------- | ------ | ---- | ------------------------ | ---------- |
    | code           | Number | 是   | 200                      | 响应码     |
    | message        | String | 是   | "创建成功"               | 响应消息   |
    | data.id        | Number | 是   | 100002                   | 组织单元ID |
    | data.code      | String | 是   | "DEPT_RD_001"            | 组织编码   |
    | data.name      | String | 是   | "研发一部"               | 组织名称   |
    | data.type      | String | 是   | "DEPT"                   | 组织类型   |
    | data.path      | String | 是   | "/ROOT/TECH/DEPT_RD_001" | 层级路径   |
    | data.level     | Number | 是   | 3                        | 层级深度   |
    | data.source    | String | 是   | "LOCAL"                  | 数据来源   |
    | data.createdAt | String | 是   | "2026-01-26T10:00:00"    | 创建时间   |

    表 4.4.4.1.1-3 UR-ORG-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "code": "DEPT_RD_001",
          "name": "研发一部",
          "type": "DEPT",
          "parentId": 100001,
          "sortOrder": 10,
          "description": "负责核心产品研发"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 100002,
            "code": "DEPT_RD_001",
            "name": "研发一部",
            "type": "DEPT",
            "path": "/ROOT/TECH/DEPT_RD_001",
            "level": 3,
            "source": "LOCAL",
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（编码重复）

        ```json
        {
          "code": 409020,
          "message": "组织编码已存在",
          "data": {
            "conflictCode": "DEPT_RD_001",
            "existingOrgId": 100004
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   code在租户内唯一，重复则返回E-409020
    -   parentId为空时创建为根节点
    -   自动设置source=LOCAL，path和level由系统计算
    -   层级深度不超过10层

##### 4.4.4.1.2 UR-ORG-02 更新组织单元

+   **契约概述表**

    | 属性       | 值                                                     |
    | ---------- | ------------------------------------------------------ |
    | API编号    | UR-ORG-02                                              |
    | 接口路径   | PUT /api/v1/ur/org/{id}                                |
    | 功能简述   | 更新本地组织单元的名称、类型、排序等信息，code不可修改 |
    | 所需权限   | ur:iam:org:update                                      |
    | 关联功能   | F-ORG-01 组织单元管理                                  |
    | 关联用例   | UC-ORG-02 管理员更新组织单元                           |
    | 关联领域   | Organization.update()                                  |
    | 关联规则   | ORG-R-04（仅LOCAL可修改）                              |
    | 幂等性     | 是                                                     |
    | 关联错误码 | E-400001, E-403006, E-404003                           |

    表 4.4.4.1.2-1 UR-ORG-02契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型    | 必填 | 约束                                   | 示例值           | 业务含义     |
    | ----------- | ---- | ------- | ---- | -------------------------------------- | ---------------- | ------------ |
    | id          | path | Number  | 是   | 正整数                                 | 100002           | 组织单元ID   |
    | name        | body | String  | 否   | 2-64字符                               | "研发二部"       | 组织名称     |
    | type        | body | String  | 否   | 枚举：COMPANY/BRANCH/DEPT/TEAM/VIRTUAL | "DEPT"           | 组织类型     |
    | sortOrder   | body | Integer | 否   | ≥0                                     | 20               | 同级排序序号 |
    | description | body | String  | 否   | 长度≤500                               | "负责新产品研发" | 组织描述     |

    表 4.4.4.1.2-2 UR-ORG-02请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义   |
    | -------------- | ------ | ---- | --------------------- | ---------- |
    | code           | Number | 是   | 200                   | 响应码     |
    | message        | String | 是   | "更新成功"            | 响应消息   |
    | data.id        | Number | 是   | 100002                | 组织单元ID |
    | data.code      | String | 是   | "DEPT_RD_001"         | 组织编码   |
    | data.name      | String | 是   | "研发二部"            | 组织名称   |
    | data.updatedAt | String | 是   | "2026-01-26T11:00:00" | 更新时间   |

    表 4.4.4.1.2-3 UR-ORG-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "name": "研发二部",
          "sortOrder": 20,
          "description": "负责新产品研发"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 100002,
            "code": "DEPT_RD_001",
            "name": "研发二部",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（外部源不可修改）

        ```json
        {
          "code": 403006,
          "message": "外部源组织不允许修改",
          "data": {
            "source": "EXTERNAL",
            "suggestion": "请通过HR系统或钉钉管理后台修改"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的组织单元可更新
    -   code不可修改（创建后不变）
    -   source=EXTERNAL时返回E-403006

##### 4.4.4.1.3 UR-ORG-03 移动组织单元

+   **契约概述表**

    | 属性       | 值                                                                       |
    | ---------- | ------------------------------------------------------------------------ |
    | API编号    | UR-ORG-03                                                                |
    | 接口路径   | PUT /api/v1/ur/org/{id}/move                                             |
    | 功能简述   | 移动本地组织单元到新的上级节点下，子组织跟随移动                         |
    | 所需权限   | ur:iam:org:update                                                        |
    | 关联功能   | F-ORG-01 组织单元管理                                                    |
    | 关联用例   | UC-ORG-03 管理员调整组织架构                                             |
    | 关联领域   | OrganizationService.moveOrganization()                                   |
    | 关联规则   | ORG-R-04（仅LOCAL可移动）, ORG-R-05（禁止循环引用）, ORG-R-02（层级≤10） |
    | 幂等性     | 是                                                                       |
    | 关联错误码 | E-400001, E-403006, E-404003, E-422108                                   |

    表 4.4.4.1.3-1 UR-ORG-03契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                   | 示例值 | 业务含义     |
    | ----------- | ---- | ------ | ---- | ---------------------- | ------ | ------------ |
    | id          | path | Number | 是   | 正整数                 | 100002 | 待移动组织ID |
    | newParentId | body | Number | 是   | 正整数，不可等于自身ID | 100003 | 新上级组织ID |

    表 4.4.4.1.3-2 UR-ORG-03请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                   | 业务含义             |
    | --------------- | ------ | ---- | ------------------------ | -------------------- |
    | code            | Number | 是   | 200                      | 响应码               |
    | message         | String | 是   | "移动成功"               | 响应消息             |
    | data.id         | Number | 是   | 100002                   | 组织单元ID           |
    | data.oldPath    | String | 是   | "/ROOT/TECH/DEPT_RD_001" | 移动前路径           |
    | data.newPath    | String | 是   | "/ROOT/OPS/DEPT_RD_001"  | 移动后路径           |
    | data.oldLevel   | Number | 是   | 3                        | 移动前层级           |
    | data.newLevel   | Number | 是   | 3                        | 移动后层级           |
    | data.movedCount | Number | 是   | 5                        | 受影响节点数（含子） |

    表 4.4.4.1.3-3 UR-ORG-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "newParentId": 100003
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "移动成功",
          "data": {
            "id": 100002,
            "oldPath": "/ROOT/TECH/DEPT_RD_001",
            "newPath": "/ROOT/OPS/DEPT_RD_001",
            "oldLevel": 3,
            "newLevel": 3,
            "movedCount": 5
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（循环引用）

        ```json
        {
          "code": 422108,
          "message": "不能移动到自身或子节点下",
          "data": {
            "targetId": 100002,
            "newParentId": 100003,
            "relationship": "CHILD"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的组织单元可移动
    -   禁止移动到自己或自己的子节点下（循环引用校验）
    -   移动后自动更新所有子节点的path和level
    -   移动后层级深度不能超过10层

##### 4.4.4.1.4 UR-ORG-04 删除组织单元

+   **契约概述表**

    | 属性       | 值                                                                  |
    | ---------- | ------------------------------------------------------------------- |
    | API编号    | UR-ORG-04                                                           |
    | 接口路径   | DELETE /api/v1/ur/org/{id}                                          |
    | 功能简述   | 删除本地组织单元，需先清空子组织和在职人员                          |
    | 所需权限   | ur:iam:org:delete                                                   |
    | 关联功能   | F-ORG-01 组织单元管理                                               |
    | 关联用例   | UC-ORG-04 管理员删除组织单元                                        |
    | 关联领域   | OrganizationService.deleteOrganization()                            |
    | 关联规则   | ORG-R-04（仅LOCAL可删除）, ORG-R-06（无子节点）, ORG-R-07（无在职） |
    | 幂等性     | 是（已删除返回成功）                                                |
    | 关联错误码 | E-403006, E-404003, E-422109, E-422110                              |

    表 4.4.4.1.4-1 UR-ORG-04契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义   |
    | ------ | ---- | ------ | ---- | ------ | ------ | ---------- |
    | id     | path | Number | 是   | 正整数 | 100002 | 组织单元ID |

    表 4.4.4.1.4-2 UR-ORG-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义     |
    | -------------- | ------ | ---- | --------------------- | ------------ |
    | code           | Number | 是   | 200                   | 响应码       |
    | message        | String | 是   | "删除成功"            | 响应消息     |
    | data.id        | Number | 是   | 100002                | 已删除组织ID |
    | data.deletedAt | String | 是   | "2026-01-26T12:00:00" | 删除时间     |

    表 4.4.4.1.4-3 UR-ORG-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "删除成功",
          "data": {
            "id": 100002,
            "deletedAt": "2026-01-26T12:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（存在子组织）

        ```json
        {
          "code": 422109,
          "message": "请先删除子组织",
          "data": {
            "childCount": 3,
            "children": [
              {"id": 100002, "name": "研发一组"},
              {"id": 100002, "name": "研发二组"},
              {"id": 100002, "name": "研发三组"}
            ]
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（存在在职人员）

        ```json
        {
          "code": 422110,
          "message": "请先处理在职人员",
          "data": {
            "personCount": 12,
            "suggestion": "请先将在职人员调至其他部门或办理离职"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的组织单元可删除
    -   有子组织时返回E-422109
    -   有在职任职时返回E-422110

##### 4.4.4.1.5 UR-ORG-05 查询组织单元详情

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-ORG-05                                |
    | 接口路径   | GET /api/v1/ur/org/{id}                  |
    | 功能简述   | 查询组织单元详情，包含层级信息和统计数据 |
    | 所需权限   | ur:iam:org:detail                        |
    | 关联功能   | F-ORG-01 组织单元管理                    |
    | 关联用例   | UC-ORG-05 管理员查看组织详情             |
    | 关联领域   | OrganizationQueryService.getById()       |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-404003                                 |

    表 4.4.4.1.5-1 UR-ORG-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义   |
    | ------ | ---- | ------ | ---- | ------ | ------ | ---------- |
    | id     | path | Number | 是   | 正整数 | 100002 | 组织单元ID |

    表 4.4.4.1.5-2 UR-ORG-05请求契约表

+   **响应契约表**

    | 参数名           | 类型   | 必有 | 示例值                   | 业务含义     |
    | ---------------- | ------ | ---- | ------------------------ | ------------ |
    | code             | Number | 是   | 200                      | 响应码       |
    | message          | String | 是   | "success"                | 响应消息     |
    | data.id          | Number | 是   | 100002                   | 组织单元ID   |
    | data.code        | String | 是   | "DEPT_RD_001"            | 组织编码     |
    | data.name        | String | 是   | "研发一部"               | 组织名称     |
    | data.type        | String | 是   | "DEPT"                   | 组织类型     |
    | data.parentId    | Number | 否   | 100001                   | 上级组织ID   |
    | data.parentName  | String | 否   | "技术中心"               | 上级组织名称 |
    | data.path        | String | 是   | "/ROOT/TECH/DEPT_RD_001" | 层级路径     |
    | data.level       | Number | 是   | 3                        | 层级深度     |
    | data.sortOrder   | Number | 是   | 10                       | 排序序号     |
    | data.status      | String | 是   | "ACTIVE"                 | 状态         |
    | data.source      | String | 是   | "LOCAL"                  | 数据来源     |
    | data.description | String | 否   | "负责核心产品研发"       | 组织描述     |
    | data.childCount  | Number | 是   | 3                        | 子组织数量   |
    | data.personCount | Number | 是   | 25                       | 在职人员数量 |
    | data.createdAt   | String | 是   | "2026-01-20T10:00:00"    | 创建时间     |
    | data.updatedAt   | String | 是   | "2026-01-26T11:00:00"    | 更新时间     |

    表 4.4.4.1.5-3 UR-ORG-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 100002,
            "code": "DEPT_RD_001",
            "name": "研发一部",
            "type": "DEPT",
            "parentId": 100001,
            "parentName": "技术中心",
            "path": "/ROOT/TECH/DEPT_RD_001",
            "level": 3,
            "sortOrder": 10,
            "status": "ACTIVE",
            "source": "LOCAL",
            "description": "负责核心产品研发",
            "childCount": 3,
            "personCount": 25,
            "createdAt": "2026-01-20T10:00:00",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（组织不存在）

        ```json
        {
          "code": 404003,
          "message": "组织单元不存在",
          "data": {
            "orgId": 100006
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.1.6 UR-ORG-06 查询组织树

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-ORG-06                              |
    | 接口路径   | GET /api/v1/ur/org/tree                |
    | 功能简述   | 查询完整组织树结构，支持状态和层级过滤 |
    | 所需权限   | ur:iam:org:list                        |
    | 关联功能   | F-ORG-01 组织单元管理                  |
    | 关联用例   | UC-ORG-06 管理员查看组织架构树         |
    | 关联领域   | OrganizationQueryService.getTree()     |
    | 关联规则   | 无                                     |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-400001                               |

    表 4.4.4.1.6-1 UR-ORG-06契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                  | 示例值   | 业务含义             |
    | -------- | ----- | ------- | ---- | --------------------- | -------- | -------------------- |
    | rootId   | query | Number  | 否   | 正整数                | 100001   | 指定根节点ID（可选） |
    | status   | query | String  | 否   | 枚举：ACTIVE/DISABLED | "ACTIVE" | 状态过滤，默认ACTIVE |
    | maxLevel | query | Integer | 否   | 1-10                  | 5        | 最大层级深度         |

    表 4.4.4.1.6-2 UR-ORG-06请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值     | 业务含义           |
    | ------------------ | ------ | ---- | ---------- | ------------------ |
    | code               | Number | 是   | 200        | 响应码             |
    | message            | String | 是   | "success"  | 响应消息           |
    | data[]             | Array  | 是   | [...]      | 组织树节点数组     |
    | data[].id          | Number | 是   | 100001     | 组织单元ID         |
    | data[].code        | String | 是   | "TECH"     | 组织编码           |
    | data[].name        | String | 是   | "技术中心" | 组织名称           |
    | data[].type        | String | 是   | "BRANCH"   | 组织类型           |
    | data[].source      | String | 是   | "LOCAL"    | 数据来源           |
    | data[].personCount | Number | 否   | 50         | 在职人员数量       |
    | data[].children    | Array  | 否   | [...]      | 子节点列表（递归） |

    表 4.4.4.1.6-3 UR-ORG-06响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "id": 100001,
              "code": "TECH",
              "name": "技术中心",
              "type": "BRANCH",
              "source": "LOCAL",
              "personCount": 50,
              "children": [
                {
                  "id": 100002,
                  "code": "DEPT_RD_001",
                  "name": "研发一部",
                  "type": "DEPT",
                  "source": "LOCAL",
                  "personCount": 25,
                  "children": []
                },
                {
                  "id": 100002,
                  "code": "DEPT_RD_002",
                  "name": "研发二部",
                  "type": "DEPT",
                  "source": "EXTERNAL",
                  "personCount": 25,
                  "children": []
                }
              ]
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.1.7 UR-ORG-07 分页查询组织单元

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-ORG-07                                |
    | 接口路径   | GET /api/v1/ur/org                       |
    | 功能简述   | 分页查询组织单元列表，支持多条件组合过滤 |
    | 所需权限   | ur:iam:org:list                          |
    | 关联功能   | F-ORG-01 组织单元管理                    |
    | 关联用例   | UC-ORG-07 管理员查询组织列表             |
    | 关联领域   | OrganizationQueryService.page()          |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-400001                                 |

    表 4.4.4.1.7-1 UR-ORG-07契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                                   | 示例值   | 业务含义                |
    | -------- | ----- | ------- | ---- | -------------------------------------- | -------- | ----------------------- |
    | keyword  | query | String  | 否   | 长度≤50                                | "研发"   | 搜索关键词（编码/名称） |
    | type     | query | String  | 否   | 枚举：COMPANY/BRANCH/DEPT/TEAM/VIRTUAL | "DEPT"   | 组织类型过滤            |
    | parentId | query | Number  | 否   | 正整数                                 | 100001   | 上级组织ID过滤          |
    | source   | query | String  | 否   | 枚举：LOCAL/EXTERNAL                   | "LOCAL"  | 数据来源过滤            |
    | status   | query | String  | 否   | 枚举：ACTIVE/DISABLED                  | "ACTIVE" | 状态过滤                |
    | page     | query | Integer | 否   | ≥1，默认1                              | 1        | 页码                    |
    | size     | query | Integer | 否   | 1-100，默认20                          | 20       | 每页大小                |

    表 4.4.4.1.7-2 UR-ORG-07请求契约表

+   **响应契约表**

    | 参数名                  | 类型   | 必有 | 示例值        | 业务含义     |
    | ----------------------- | ------ | ---- | ------------- | ------------ |
    | code                    | Number | 是   | 200           | 响应码       |
    | message                 | String | 是   | "success"     | 响应消息     |
    | data.list[]             | Array  | 是   | [...]         | 组织列表     |
    | data.list[].id          | Number | 是   | 100002        | 组织单元ID   |
    | data.list[].code        | String | 是   | "DEPT_RD_001" | 组织编码     |
    | data.list[].name        | String | 是   | "研发一部"    | 组织名称     |
    | data.list[].type        | String | 是   | "DEPT"        | 组织类型     |
    | data.list[].parentName  | String | 否   | "技术中心"    | 上级组织名称 |
    | data.list[].source      | String | 是   | "LOCAL"       | 数据来源     |
    | data.list[].status      | String | 是   | "ACTIVE"      | 状态         |
    | data.list[].personCount | Number | 是   | 25            | 在职人员数量 |
    | data.total              | Number | 是   | 45            | 总记录数     |
    | data.page               | Number | 是   | 1             | 当前页码     |
    | data.size               | Number | 是   | 20            | 每页大小     |
    | data.pages              | Number | 是   | 3             | 总页数       |

    表 4.4.4.1.7-3 UR-ORG-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 100002,
                "code": "DEPT_RD_001",
                "name": "研发一部",
                "type": "DEPT",
                "parentName": "技术中心",
                "source": "LOCAL",
                "status": "ACTIVE",
                "personCount": 25
              },
              {
                "id": 100002,
                "code": "DEPT_RD_002",
                "name": "研发二部",
                "type": "DEPT",
                "parentName": "技术中心",
                "source": "EXTERNAL",
                "status": "ACTIVE",
                "personCount": 30
              }
            ],
            "total": 45,
            "page": 1,
            "size": 20,
            "pages": 3
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.1.8 UR-ORG-08 查询子组织列表

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-ORG-08                              |
    | 接口路径   | GET /api/v1/ur/org/{id}/children       |
    | 功能简述   | 查询指定组织的直接子组织列表           |
    | 所需权限   | ur:iam:org:list                        |
    | 关联功能   | F-ORG-08 子组织查询                    |
    | 关联用例   | UC-ORG-08 管理员查询子组织列表         |
    | 关联领域   | OrganizationQueryService.getChildren() |
    | 关联规则   | 无                                     |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-400001, E-401001, E-404002           |

    表 4.4.4.1.8-1 UR-ORG-08契约概述表

+   **请求契约表**

    | 参数名          | 位置  | 类型    | 必填 | 约束                 | 示例值      | 业务含义       |
    | --------------- | ----- | ------- | ---- | -------------------- | ----------- | -------------- |
    | id              | path  | Number  | 是   | 正整数               | 100005      | 父组织ID       |
    | includeDisabled | query | Boolean | 否   | 默认false            | false       | 是否包含已禁用 |
    | orderBy         | query | String  | 否   | 枚举：sortOrder/name | "sortOrder" | 排序字段       |

    表 4.4.4.1.8-2 UR-ORG-08请求契约表

+   **响应契约表**

    | 参数名               | 类型    | 必有 | 示例值       | 业务含义     |
    | -------------------- | ------- | ---- | ------------ | ------------ |
    | code                 | Number  | 是   | 200          | 响应码       |
    | message              | String  | 是   | "success"    | 响应消息     |
    | data[]               | Array   | 是   | [...]        | 子组织列表   |
    | data[].id            | Number  | 是   | 100006       | 组织ID       |
    | data[].orgCode       | String  | 是   | "TECH_DEPT"  | 组织编码     |
    | data[].orgName       | String  | 是   | "技术部"     | 组织名称     |
    | data[].orgType       | String  | 是   | "DEPARTMENT" | 组织类型     |
    | data[].parentId      | Number  | 是   | 100005       | 父组织ID     |
    | data[].status        | String  | 是   | "ENABLED"    | 状态         |
    | data[].sortOrder     | Number  | 是   | 1            | 排序号       |
    | data[].hasChildren   | Boolean | 是   | true         | 是否有子组织 |
    | data[].childrenCount | Number  | 是   | 3            | 子组织数量   |
    | data[].memberCount   | Number  | 是   | 15           | 成员数量     |

    表 4.4.4.1.8-3 UR-ORG-08响应契约表

+   **Mock示例**

    +   成功响应Mock
```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "id": 100002,
              "orgCode": "TECH_DEPT",
              "orgName": "技术部",
              "orgType": "DEPARTMENT",
              "parentId": 100001,
              "status": "ENABLED",
              "sortOrder": 1,
              "hasChildren": true,
              "childrenCount": 3,
              "memberCount": 15
            },
            {
              "id": 100002,
              "orgCode": "SALES_DEPT",
              "orgName": "销售部",
              "orgType": "DEPARTMENT",
              "parentId": 100001,
              "status": "ENABLED",
              "sortOrder": 2,
              "hasChildren": false,
              "childrenCount": 0,
              "memberCount": 8
            }
          ],
          "timestamp": 1737885600000
        }
```

    +   错误响应Mock（父组织不存在）
```json
        {
          "code": 404002,
          "message": "组织单元不存在",
          "data": {
            "orgId": 100006
          },
          "timestamp": 1737885600000
        }
```

+   **备注**
    -   只返回直接子组织，不递归
    -   默认按sortOrder升序排列
    -   hasChildren用于前端懒加载判断

#### 4.4.4.2 岗位接口（UR-POS）

##### 4.4.4.2.1 UR-POS-01 创建岗位

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-POS-01                                |
    | 接口路径   | POST /api/v1/ur/position                 |
    | 功能简述   | 创建租户级岗位，用于组织架构中的岗位定义 |
    | 所需权限   | ur:iam:position:create                   |
    | 关联功能   | F-POS-01 岗位管理                        |
    | 关联用例   | UC-POS-01 管理员创建岗位                 |
    | 关联领域   | PositionService.createPosition()         |
    | 关联规则   | POS-R-01（编码唯一）                     |
    | 幂等性     | 否（编码唯一性保证不重复创建）           |
    | 关联错误码 | E-400001, E-409021                       |

    表 4.4.4.2.1-1 UR-POS-01契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束                     | 示例值                | 业务含义               |
    | ------------ | ---- | ------ | ---- | ------------------------ | --------------------- | ---------------------- |
    | code         | body | String | 是   | 3-32字符，字母数字下划线 | "POS_DEV_SENIOR"      | 岗位编码（租户内唯一） |
    | name         | body | String | 是   | 2-64字符                 | "高级开发工程师"      | 岗位名称               |
    | category     | body | String | 否   | 长度≤50                  | "技术类"              | 岗位类别               |
    | description  | body | String | 否   | 长度≤1000                | "负责核心模块开发..." | 岗位职责描述           |
    | requirements | body | String | 否   | 长度≤1000                | "5年以上Java开发..."  | 任职要求               |

    表 4.4.4.2.1-2 UR-POS-01请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "创建成功"            | 响应消息 |
    | data.id        | Number | 是   | 200001                | 岗位ID   |
    | data.code      | String | 是   | "POS_DEV_SENIOR"      | 岗位编码 |
    | data.name      | String | 是   | "高级开发工程师"      | 岗位名称 |
    | data.source    | String | 是   | "LOCAL"               | 数据来源 |
    | data.createdAt | String | 是   | "2026-01-26T10:00:00" | 创建时间 |

    表 4.4.4.2.1-3 UR-POS-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "code": "POS_DEV_SENIOR",
          "name": "高级开发工程师",
          "category": "技术类",
          "description": "负责核心模块开发，参与架构设计",
          "requirements": "5年以上Java开发经验，熟悉分布式系统"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 200001,
            "code": "POS_DEV_SENIOR",
            "name": "高级开发工程师",
            "source": "LOCAL",
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（编码重复）

        ```json
        {
          "code": 409021,
          "message": "岗位编码已存在",
          "data": {
            "conflictCode": "POS_DEV_SENIOR",
            "existingPositionId": "pos-440e8400-e29b-41d4-a716-446655440000"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   code在租户内唯一，重复则返回E-409021
    -   自动设置source=LOCAL

##### 4.4.4.2.2 UR-POS-02 更新岗位

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-POS-02                            |
    | 接口路径   | PUT /api/v1/ur/position/{id}         |
    | 功能简述   | 更新本地岗位的名称、类别、职责等信息 |
    | 所需权限   | ur:iam:position:update               |
    | 关联功能   | F-POS-01 岗位管理                    |
    | 关联用例   | UC-POS-02 管理员更新岗位信息         |
    | 关联领域   | Position.update()                    |
    | 关联规则   | POS-R-02（仅LOCAL可修改）            |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001, E-403006, E-404004         |

    表 4.4.4.2.2-1 UR-POS-02契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束      | 示例值               | 业务含义     |
    | ------------ | ---- | ------ | ---- | --------- | -------------------- | ------------ |
    | id           | path | Number | 是   | 正整数    | 200001               | 岗位ID       |
    | name         | body | String | 否   | 2-64字符  | "资深开发工程师"     | 岗位名称     |
    | category     | body | String | 否   | 长度≤50   | "技术类"             | 岗位类别     |
    | description  | body | String | 否   | 长度≤1000 | "负责架构设计..."    | 岗位职责描述 |
    | requirements | body | String | 否   | 长度≤1000 | "8年以上开发经验..." | 任职要求     |

    表 4.4.4.2.2-2 UR-POS-02请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "更新成功"            | 响应消息 |
    | data.id        | Number | 是   | 200001                | 岗位ID   |
    | data.name      | String | 是   | "资深开发工程师"      | 岗位名称 |
    | data.updatedAt | String | 是   | "2026-01-26T11:00:00" | 更新时间 |

    表 4.4.4.2.2-3 UR-POS-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "name": "资深开发工程师",
          "description": "负责架构设计和核心模块开发"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 200001,
            "name": "资深开发工程师",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（外部源不可修改）

        ```json
        {
          "code": 403006,
          "message": "外部源岗位不允许修改",
          "data": {
            "source": "EXTERNAL",
            "suggestion": "请通过HR系统修改"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的岗位可更新
    -   code不可修改

##### 4.4.4.2.3 UR-POS-03 变更岗位状态

+   **契约概述表**

    | 属性       | 值                                  |
    | ---------- | ----------------------------------- |
    | API编号    | UR-POS-03                           |
    | 接口路径   | PUT /api/v1/ur/position/{id}/status |
    | 功能简述   | 启用或停用岗位，停用后不能新建任职  |
    | 所需权限   | ur:iam:position:update              |
    | 关联功能   | F-POS-01 岗位管理                   |
    | 关联用例   | UC-POS-03 管理员变更岗位状态        |
    | 关联领域   | Position.changeStatus()             |
    | 关联规则   | POS-R-02（仅LOCAL可修改）           |
    | 幂等性     | 是                                  |
    | 关联错误码 | E-400001, E-403006, E-404004        |

    表 4.4.4.2.3-1 UR-POS-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束                  | 示例值     | 业务含义 |
    | ------ | ---- | ------ | ---- | --------------------- | ---------- | -------- |
    | id     | path | Number | 是   | 正整数                | 200001     | 岗位ID   |
    | status | body | String | 是   | 枚举：ACTIVE/DISABLED | "DISABLED" | 目标状态 |

    表 4.4.4.2.3-2 UR-POS-03请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "状态变更成功"        | 响应消息 |
    | data.id        | Number | 是   | 200001                | 岗位ID   |
    | data.status    | String | 是   | "DISABLED"            | 当前状态 |
    | data.updatedAt | String | 是   | "2026-01-26T11:00:00" | 更新时间 |

    表 4.4.4.2.3-3 UR-POS-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "status": "DISABLED"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "状态变更成功",
          "data": {
            "id": 200001,
            "status": "DISABLED",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的岗位可变更状态
    -   停用岗位不影响已有任职，但不能新建任职

##### 4.4.4.2.4 UR-POS-04 删除岗位

+   **契约概述表**

    | 属性       | 值                                            |
    | ---------- | --------------------------------------------- |
    | API编号    | UR-POS-04                                     |
    | 接口路径   | DELETE /api/v1/ur/position/{id}               |
    | 功能简述   | 删除本地岗位，需先清空该岗位的在职人员        |
    | 所需权限   | ur:iam:position:delete                        |
    | 关联功能   | F-POS-01 岗位管理                             |
    | 关联用例   | UC-POS-04 管理员删除岗位                      |
    | 关联领域   | PositionService.deletePosition()              |
    | 关联规则   | POS-R-02（仅LOCAL可删除）, POS-R-03（无在职） |
    | 幂等性     | 是（已删除返回成功）                          |
    | 关联错误码 | E-403006, E-404004, E-422111                  |

    表 4.4.4.2.4-1 UR-POS-04契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 200001 | 岗位ID   |

    表 4.4.4.2.4-2 UR-POS-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义     |
    | -------------- | ------ | ---- | --------------------- | ------------ |
    | code           | Number | 是   | 200                   | 响应码       |
    | message        | String | 是   | "删除成功"            | 响应消息     |
    | data.id        | Number | 是   | 200001                | 已删除岗位ID |
    | data.deletedAt | String | 是   | "2026-01-26T12:00:00" | 删除时间     |

    表 4.4.4.2.4-3 UR-POS-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "删除成功",
          "data": {
            "id": 200001,
            "deletedAt": "2026-01-26T12:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（存在在职人员）

        ```json
        {
          "code": 422111,
          "message": "该岗位有在职人员，无法删除",
          "data": {
            "personCount": 8,
            "suggestion": "请先将在职人员调至其他岗位"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的岗位可删除
    -   有在职任职时返回E-422111

##### 4.4.4.2.5 UR-POS-05 查询岗位详情

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-POS-05                            |
    | 接口路径   | GET /api/v1/ur/position/{id}         |
    | 功能简述   | 查询岗位详情，包含职责描述和任职要求 |
    | 所需权限   | ur:iam:position:detail               |
    | 关联功能   | F-POS-01 岗位管理                    |
    | 关联用例   | UC-POS-05 管理员查看岗位详情         |
    | 关联领域   | PositionQueryService.getById()       |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-404004                             |

    表 4.4.4.2.5-1 UR-POS-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 200001 | 岗位ID   |

    表 4.4.4.2.5-2 UR-POS-05请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义     |
    | ----------------- | ------ | ---- | --------------------- | ------------ |
    | code              | Number | 是   | 200                   | 响应码       |
    | message           | String | 是   | "success"             | 响应消息     |
    | data.id           | Number | 是   | 200001                | 岗位ID       |
    | data.code         | String | 是   | "POS_DEV_SENIOR"      | 岗位编码     |
    | data.name         | String | 是   | "高级开发工程师"      | 岗位名称     |
    | data.category     | String | 否   | "技术类"              | 岗位类别     |
    | data.description  | String | 否   | "负责核心模块开发..." | 岗位职责描述 |
    | data.requirements | String | 否   | "5年以上Java开发..."  | 任职要求     |
    | data.status       | String | 是   | "ACTIVE"              | 状态         |
    | data.source       | String | 是   | "LOCAL"               | 数据来源     |
    | data.personCount  | Number | 是   | 15                    | 在职人员数量 |
    | data.createdAt    | String | 是   | "2026-01-20T10:00:00" | 创建时间     |
    | data.updatedAt    | String | 是   | "2026-01-26T11:00:00" | 更新时间     |

    表 4.4.4.2.5-3 UR-POS-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 200001,
            "code": "POS_DEV_SENIOR",
            "name": "高级开发工程师",
            "category": "技术类",
            "description": "负责核心模块开发，参与架构设计",
            "requirements": "5年以上Java开发经验，熟悉分布式系统",
            "status": "ACTIVE",
            "source": "LOCAL",
            "personCount": 15,
            "createdAt": "2026-01-20T10:00:00",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（岗位不存在）

        ```json
        {
          "code": 404004,
          "message": "岗位不存在",
          "data": {
            "positionId": 200002
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.2.6 UR-POS-06 分页查询岗位

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-POS-06                            |
    | 接口路径   | GET /api/v1/ur/position              |
    | 功能简述   | 分页查询岗位列表，支持多条件组合过滤 |
    | 所需权限   | ur:iam:position:detail               |
    | 关联功能   | F-POS-01 岗位管理                    |
    | 关联用例   | UC-POS-06 管理员查询岗位列表         |
    | 关联领域   | PositionQueryService.page()          |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001                             |

    表 4.4.4.2.6-1 UR-POS-06契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                  | 示例值   | 业务含义                |
    | -------- | ----- | ------- | ---- | --------------------- | -------- | ----------------------- |
    | keyword  | query | String  | 否   | 长度≤50               | "开发"   | 搜索关键词（编码/名称） |
    | category | query | String  | 否   | 长度≤50               | "技术类" | 岗位类别过滤            |
    | source   | query | String  | 否   | 枚举：LOCAL/EXTERNAL  | "LOCAL"  | 数据来源过滤            |
    | status   | query | String  | 否   | 枚举：ACTIVE/DISABLED | "ACTIVE" | 状态过滤                |
    | page     | query | Integer | 否   | ≥1，默认1             | 1        | 页码                    |
    | size     | query | Integer | 否   | 1-100，默认20         | 20       | 每页大小                |

    表 4.4.4.2.6-2 UR-POS-06请求契约表

+   **响应契约表**

    | 参数名                  | 类型   | 必有 | 示例值           | 业务含义     |
    | ----------------------- | ------ | ---- | ---------------- | ------------ |
    | code                    | Number | 是   | 200              | 响应码       |
    | message                 | String | 是   | "success"        | 响应消息     |
    | data.list[]             | Array  | 是   | [...]            | 岗位列表     |
    | data.list[].id          | Number | 是   | 200001           | 岗位ID       |
    | data.list[].code        | String | 是   | "POS_DEV_SENIOR" | 岗位编码     |
    | data.list[].name        | String | 是   | "高级开发工程师" | 岗位名称     |
    | data.list[].category    | String | 否   | "技术类"         | 岗位类别     |
    | data.list[].source      | String | 是   | "LOCAL"          | 数据来源     |
    | data.list[].status      | String | 是   | "ACTIVE"         | 状态         |
    | data.list[].personCount | Number | 是   | 15               | 在职人员数量 |
    | data.total              | Number | 是   | 32               | 总记录数     |
    | data.page               | Number | 是   | 1                | 当前页码     |
    | data.size               | Number | 是   | 20               | 每页大小     |
    | data.pages              | Number | 是   | 2                | 总页数       |

    表 4.4.4.2.6-3 UR-POS-06响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 200001,
                "code": "POS_DEV_SENIOR",
                "name": "高级开发工程师",
                "category": "技术类",
                "source": "LOCAL",
                "status": "ACTIVE",
                "personCount": 15
              },
              {
                "id": 200001,
                "code": "POS_DEV_JUNIOR",
                "name": "初级开发工程师",
                "category": "技术类",
                "source": "EXTERNAL",
                "status": "ACTIVE",
                "personCount": 25
              }
            ],
            "total": 32,
            "page": 1,
            "size": 20,
            "pages": 2
          },
          "timestamp": 1737885600000
        }
        ```

#### 4.4.4.3 人员接口（UR-PSN）

##### 4.4.4.3.1 UR-PSN-01 创建人员

+   **契约概述表**

    | 属性       | 值                                                                              |
    | ---------- | ------------------------------------------------------------------------------- |
    | API编号    | UR-PSN-01                                                                       |
    | 接口路径   | POST /api/v1/ur/person                                                          |
    | 功能简述   | 创建本地人员档案，可选同时创建用户账号和首次任职                                |
    | 所需权限   | ur:iam:person:create                                                            |
    | 关联功能   | F-PSN-01 人员管理                                                               |
    | 关联用例   | UC-PSN-01 管理员创建人员                                                        |
    | 关联领域   | Person.create() + TenantUser.create()（可选）+ Appointment.create()（可选） 注1 |
    | 关联规则   | PSN-R-01（工号唯一）, PSN-R-02（创建用户需联系方式）                            |
    | 幂等性     | 否（工号唯一性保证不重复创建）                                                  |
    | 关联错误码 | E-400001, E-400021, E-400022, E-404003, E-404004, E-409022                      |

    表 4.4.4.3.1-1 UR-PSN-01契约概述表

    +   注1：UR-PSN-01的可选逻辑（创建用户+任职）移入PersonService.createPerson()内部说明，契约表"关联领域"只写入口方法。

+   **请求契约表**

    | 参数名                 | 位置 | 类型    | 必填 | 约束                            | 示例值              | 业务含义             |
    | ---------------------- | ---- | ------- | ---- | ------------------------------- | ------------------- | -------------------- |
    | employeeNo             | body | String  | 是   | 3-32字符                        | "EMP20260001"       | 工号（租户内唯一）   |
    | name                   | body | String  | 是   | 2-64字符                        | "张三"              | 姓名                 |
    | gender                 | body | String  | 否   | 枚举：MALE/FEMALE/UNKNOWN       | "MALE"              | 性别                 |
    | mobile                 | body | String  | 否   | 11位手机号                      | "13800138000"       | 手机号               |
    | email                  | body | String  | 否   | 邮箱格式                        | "zhang@company.com" | 邮箱                 |
    | hireDate               | body | String  | 否   | yyyy-MM-dd格式                  | "2026-01-20"        | 入职日期             |
    | createUser             | body | Boolean | 否   | 默认false                       | true                | 是否同时创建用户账号 |
    | sendActivation         | body | Boolean | 否   | createUser=true时有效，默认true | true                | 是否发送激活验证码   |
    | appointment            | body | Object  | 否   | 任职信息对象                    | {...}               | 首次任职信息         |
    | appointment.orgId      | body | Number  | 条件 | 正整数，有appointment时必填     | 100001              | 组织单元ID           |
    | appointment.positionId | body | Number  | 条件 | 正整数，有appointment时必填     | 200001              | 岗位ID               |
    | appointment.type       | body | String  | 否   | 枚举，默认PRIMARY               | "PRIMARY"           | 任职类型             |
    | appointment.startDate  | body | String  | 否   | yyyy-MM-dd格式，默认今天        | "2026-01-26"        | 任职开始日期         |

    表 4.4.4.3.1-2 UR-PSN-01请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                | 业务含义                    |
    | ------------------ | ------ | ---- | --------------------- | --------------------------- |
    | code               | Number | 是   | 200                   | 响应码                      |
    | message            | String | 是   | "创建成功"            | 响应消息                    |
    | data.id            | Number | 是   | 300001                | 人员ID                      |
    | data.employeeNo    | String | 是   | "EMP20260001"         | 工号                        |
    | data.name          | String | 是   | "张三"                | 姓名                        |
    | data.source        | String | 是   | "LOCAL"               | 数据来源                    |
    | data.userId        | Number | 否   | 500001                | 用户ID（createUser=true时） |
    | data.appointmentId | Number | 否   | 400003                | 任职ID（有appointment时）   |
    | data.createdAt     | String | 是   | "2026-01-26T10:00:00" | 创建时间                    |

    表 4.4.4.3.1-3 UR-PSN-01响应契约表

+   **Mock示例**

    +   请求Mock（完整创建）

        ```json
        {
          "employeeNo": "EMP20260001",
          "name": "张三",
          "gender": "MALE",
          "mobile": "13800138000",
          "email": "zhang@company.com",
          "hireDate": "2026-01-20",
          "createUser": true,
          "sendActivation": true,
          "appointment": {
            "orgId": 100001,
            "positionId": 200001,
            "type": "PRIMARY",
            "startDate": "2026-01-26"
          }
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 300001,
            "employeeNo": "EMP20260001",
            "name": "张三",
            "source": "LOCAL",
            "userId": 500001,
            "appointmentId": 400003,
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（工号重复）

        ```json
        {
          "code": 409022,
          "message": "工号已存在",
          "data": {
            "conflictEmployeeNo": "EMP20260001",
            "existingPersonId": "psn-440e8400-e29b-41d4-a716-446655440000"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   employeeNo在租户内唯一
    -   createUser=true时，必须提供mobile或email
    -   用户账号创建后自动关联人员
    -   sendActivation=true时向用户邮箱/手机发送激活验证码

##### 4.4.4.3.2 UR-PSN-02 更新人员

+   **契约概述表**

    | 属性       | 值                                               |
    | ---------- | ------------------------------------------------ |
    | API编号    | UR-PSN-02                                        |
    | 接口路径   | PUT /api/v1/ur/person/{id}                       |
    | 功能简述   | 更新本地人员的基本信息，工号不可修改             |
    | 所需权限   | ur:iam:person:update                             |
    | 关联功能   | F-PSN-01 人员管理                                |
    | 关联用例   | UC-PSN-02 管理员更新人员信息                     |
    | 关联领域   | Person.update()                                  |
    | 关联规则   | PSN-R-03（仅LOCAL可修改）                        |
    | 幂等性     | 是                                               |
    | 关联错误码 | E-400001, E-400021, E-400022, E-403006, E-404005 |

    表 4.4.4.3.2-1 UR-PSN-02契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                      | 示例值            | 业务含义 |
    | -------- | ---- | ------ | ---- | ------------------------- | ----------------- | -------- |
    | id       | path | Number | 是   | 正整数                    | 300001            | 人员ID   |
    | name     | body | String | 否   | 2-64字符                  | "张三丰"          | 姓名     |
    | gender   | body | String | 否   | 枚举：MALE/FEMALE/UNKNOWN | "MALE"            | 性别     |
    | mobile   | body | String | 否   | 11位手机号                | "13900139000"     | 手机号   |
    | email    | body | String | 否   | 邮箱格式                  | "zhangsan@co.com" | 邮箱     |
    | hireDate | body | String | 否   | yyyy-MM-dd格式            | "2026-01-15"      | 入职日期 |

    表 4.4.4.3.2-2 UR-PSN-02请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "更新成功"            | 响应消息 |
    | data.id        | Number | 是   | 300001                | 人员ID   |
    | data.name      | String | 是   | "张三丰"              | 姓名     |
    | data.updatedAt | String | 是   | "2026-01-26T11:00:00" | 更新时间 |

    表 4.4.4.3.2-3 UR-PSN-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "name": "张三丰",
          "mobile": "13900139000"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "更新成功",
          "data": {
            "id": 300001,
            "name": "张三丰",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可更新
    -   employeeNo不可修改

##### 4.4.4.3.3 UR-PSN-03 关联用户

+   **契约概述表**

    | 属性       | 值                                                          |
    | ---------- | ----------------------------------------------------------- |
    | API编号    | UR-PSN-03                                                   |
    | 接口路径   | PUT /api/v1/ur/person/{id}/bind-user                        |
    | 功能简述   | 将已有人员与已有用户账号关联，实现人员-用户一对一绑定       |
    | 所需权限   | ur:iam:person:update                                        |
    | 关联功能   | F-PSN-01 人员管理                                           |
    | 关联用例   | UC-PSN-03 管理员关联人员与用户                              |
    | 关联领域   | Person.bindUser()                                           |
    | 关联规则   | PSN-R-03（仅LOCAL可操作）, PSN-R-04（用户未被其他人员关联） |
    | 幂等性     | 是                                                          |
    | 关联错误码 | E-403006, E-404002, E-404005, E-422112                      |

    表 4.4.4.3.3-1 UR-PSN-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 300001 | 人员ID   |
    | userId | body | Number | 是   | 正整数 | 500001 | 用户ID   |

    表 4.4.4.3.3-2 UR-PSN-03请求契约表

+   **响应契约表**

    | 参数名        | 类型   | 必有 | 示例值                | 业务含义 |
    | ------------- | ------ | ---- | --------------------- | -------- |
    | code          | Number | 是   | 200                   | 响应码   |
    | message       | String | 是   | "关联成功"            | 响应消息 |
    | data.personId | Number | 是   | 300001                | 人员ID   |
    | data.userId   | Number | 是   | 500001                | 用户ID   |
    | data.boundAt  | String | 是   | "2026-01-26T11:00:00" | 关联时间 |

    表 4.4.4.3.3-3 UR-PSN-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "userId": 500001
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "关联成功",
          "data": {
            "personId": 300001,
            "userId": 500001,
            "boundAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（用户已被其他人员关联）

        ```json
        {
          "code": 422112,
          "message": "该用户已被其他人员关联",
          "data": {
            "userId": 500001,
            "boundPersonId": "psn-440e8400-e29b-41d4-a716-446655440000",
            "boundPersonName": "李四"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   用户必须存在且属于同一租户
    -   用户未被其他人员关联
    -   人员未关联其他用户

##### 4.4.4.3.4 UR-PSN-04 解除用户关联

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-PSN-04                              |
    | 接口路径   | PUT /api/v1/ur/person/{id}/unbind-user |
    | 功能简述   | 解除人员与用户的关联关系               |
    | 所需权限   | ur:iam:person:update                   |
    | 关联功能   | F-PSN-01 人员管理                      |
    | 关联用例   | UC-PSN-04 管理员解除人员用户关联       |
    | 关联领域   | Person.unbindUser()                    |
    | 关联规则   | PSN-R-03（仅LOCAL可操作）              |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-403006, E-404005, E-422113           |

    表 4.4.4.3.4-1 UR-PSN-04契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 300001 | 人员ID   |

    表 4.4.4.3.4-2 UR-PSN-04请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 200                   | 响应码   |
    | message        | String | 是   | "解除关联成功"        | 响应消息 |
    | data.personId  | Number | 是   | 300001                | 人员ID   |
    | data.unboundAt | String | 是   | "2026-01-26T11:00:00" | 解除时间 |

    表 4.4.4.3.4-3 UR-PSN-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "解除关联成功",
          "data": {
            "personId": 300001,
            "unboundAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（人员未关联用户）

        ```json
        {
          "code": 422113,
          "message": "该人员未关联用户",
          "data": {
            "personId": 300001
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   人员必须已关联用户

##### 4.4.4.3.5 UR-PSN-05 人员离职

+   **契约概述表**

    | 属性       | 值                                                   |
    | ---------- | ---------------------------------------------------- |
    | API编号    | UR-PSN-05                                            |
    | 接口路径   | PUT /api/v1/ur/person/{id}/resign                    |
    | 功能简述   | 标记人员离职，自动终止所有任职，可选处理关联用户账号 |
    | 所需权限   | ur:iam:person:update                                 |
    | 关联功能   | F-PSN-02 人员离职管理                                |
    | 关联用例   | UC-PSN-05 管理员办理人员离职                         |
    | 关联领域   | Person.resign() + Appointment.terminateAll()         |
    | 关联规则   | PSN-R-03（仅LOCAL可操作）, PSN-R-05（离职日期校验）  |
    | 幂等性     | 是                                                   |
    | 关联错误码 | E-400001, E-403006, E-404005, E-422114               |

    表 4.4.4.3.5-1 UR-PSN-05契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束                                   | 示例值       | 业务含义         |
    | ------------ | ---- | ------ | ---- | -------------------------------------- | ------------ | ---------------- |
    | id           | path | Number | 是   | 正整数                                 | 300001       | 人员ID           |
    | resignDate   | body | String | 是   | yyyy-MM-dd格式                         | "2026-01-31" | 离职日期         |
    | userHandling | body | String | 否   | 枚举：KEEP/DISABLE/DELETE，默认DISABLE | "DISABLE"    | 用户账号处理方式 |

    表 4.4.4.3.5-2 UR-PSN-05请求契约表

+   **响应契约表**

    | 参数名               | 类型   | 必有 | 示例值         | 业务含义         |
    | -------------------- | ------ | ---- | -------------- | ---------------- |
    | code                 | Number | 是   | 200            | 响应码           |
    | message              | String | 是   | "离职办理成功" | 响应消息         |
    | data.personId        | Number | 是   | 300001         | 人员ID           |
    | data.resignDate      | String | 是   | "2026-01-31"   | 离职日期         |
    | data.terminatedAppts | Number | 是   | 2              | 终止的任职数     |
    | data.userStatus      | String | 否   | "DISABLED"     | 用户账号当前状态 |

    表 4.4.4.3.5-3 UR-PSN-05响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "resignDate": "2026-01-31",
          "userHandling": "DISABLE"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "离职办理成功",
          "data": {
            "personId": 300001,
            "resignDate": "2026-01-31",
            "terminatedAppts": 2,
            "userStatus": "DISABLED"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   自动终止所有在职任职
    -   userHandling可选：KEEP（保留）、DISABLE（停用）、DELETE（删除）

##### 4.4.4.3.6 UR-PSN-06 人员复职

+   **契约概述表**

    | 属性       | 值                                                    |
    | ---------- | ----------------------------------------------------- |
    | API编号    | UR-PSN-06                                             |
    | 接口路径   | PUT /api/v1/ur/person/{id}/reinstate                  |
    | 功能简述   | 离职人员复职，恢复在职状态                            |
    | 所需权限   | ur:iam:person:update                                  |
    | 关联功能   | F-PSN-02 人员离职管理                                 |
    | 关联用例   | UC-PSN-06 管理员办理人员复职                          |
    | 关联领域   | Person.reinstate()                                    |
    | 关联规则   | PSN-R-03（仅LOCAL可操作）, PSN-R-06（必须为离职状态） |
    | 幂等性     | 是                                                    |
    | 关联错误码 | E-403006, E-404005, E-422115                          |

    表 4.4.4.3.6-1 UR-PSN-06契约概述表

+   **请求契约表**

    | 参数名        | 位置 | 类型    | 必填 | 约束                 | 示例值       | 业务含义         |
    | ------------- | ---- | ------- | ---- | -------------------- | ------------ | ---------------- |
    | id            | path | Number  | 是   | 正整数               | 300001       | 人员ID           |
    | reinstateDate | body | String  | 否   | yyyy-MM-dd，默认今天 | "2026-02-01" | 复职日期         |
    | enableUser    | body | Boolean | 否   | 默认true             | true         | 是否启用关联用户 |

    表 4.4.4.3.6-2 UR-PSN-06请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值         | 业务含义 |
    | ------------------ | ------ | ---- | -------------- | -------- |
    | code               | Number | 是   | 200            | 响应码   |
    | message            | String | 是   | "复职办理成功" | 响应消息 |
    | data.personId      | Number | 是   | 300001         | 人员ID   |
    | data.reinstateDate | String | 是   | "2026-02-01"   | 复职日期 |
    | data.status        | String | 是   | "ACTIVE"       | 当前状态 |

    表 4.4.4.3.6-3 UR-PSN-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "reinstateDate": "2026-02-01",
          "enableUser": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "复职办理成功",
          "data": {
            "personId": 300001,
            "reinstateDate": "2026-02-01",
            "status": "ACTIVE"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（非离职状态）

        ```json
        {
          "code": 422115,
          "message": "仅离职人员可复职",
          "data": {
            "currentStatus": "ACTIVE"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   人员必须为离职状态（RESIGNED）
    -   复职后需重新创建任职
    -   enableUser=true时自动启用关联的用户账号

##### 4.4.4.3.7 UR-PSN-07 查询人员详情

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-PSN-07                                |
    | 接口路径   | GET /api/v1/ur/person/{id}               |
    | 功能简述   | 查询人员详情，包含任职信息和关联用户信息 |
    | 所需权限   | ur:iam:person:detail                     |
    | 关联功能   | F-PSN-01 人员管理                        |
    | 关联用例   | UC-PSN-07 管理员查看人员详情             |
    | 关联领域   | PersonQueryService.getById()             |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-404005                                 |

    表 4.4.4.3.7-1 UR-PSN-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 300001 | 人员ID   |

    表 4.4.4.3.7-2 UR-PSN-07请求契约表

+   **响应契约表**

    | 参数名                           | 类型   | 必有 | 示例值                | 业务含义       |
    | -------------------------------- | ------ | ---- | --------------------- | -------------- |
    | code                             | Number | 是   | 200                   | 响应码         |
    | message                          | String | 是   | "success"             | 响应消息       |
    | data.id                          | Number | 是   | 300001                | 人员ID         |
    | data.employeeNo                  | String | 是   | "EMP20260001"         | 工号           |
    | data.name                        | String | 是   | "张三"                | 姓名           |
    | data.gender                      | String | 否   | "MALE"                | 性别           |
    | data.mobile                      | String | 否   | "138****8000"         | 手机号（脱敏） |
    | data.email                       | String | 否   | "zha****@company.com" | 邮箱（脱敏）   |
    | data.hireDate                    | String | 否   | "2026-01-20"          | 入职日期       |
    | data.resignDate                  | String | 否   | null                  | 离职日期       |
    | data.status                      | String | 是   | "ACTIVE"              | 状态           |
    | data.source                      | String | 是   | "LOCAL"               | 数据来源       |
    | data.userId                      | Number | 否   | 500001                | 关联用户ID     |
    | data.userName                    | String | 否   | "zhangsan"            | 关联用户名     |
    | data.appointments[]              | Array  | 是   | [...]                 | 任职列表       |
    | data.appointments[].id           | Number | 是   | 400003                | 任职ID         |
    | data.appointments[].orgName      | String | 是   | "研发一部"            | 组织名称       |
    | data.appointments[].positionName | String | 是   | "高级开发工程师"      | 岗位名称       |
    | data.appointments[].type         | String | 是   | "PRIMARY"             | 任职类型       |
    | data.appointments[].status       | String | 是   | "ACTIVE"              | 任职状态       |
    | data.createdAt                   | String | 是   | "2026-01-20T10:00:00" | 创建时间       |
    | data.updatedAt                   | String | 是   | "2026-01-26T11:00:00" | 更新时间       |

    表 4.4.4.3.7-3 UR-PSN-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 300001,
            "employeeNo": "EMP20260001",
            "name": "张三",
            "gender": "MALE",
            "mobile": "138****8000",
            "email": "zha****@company.com",
            "hireDate": "2026-01-20",
            "resignDate": null,
            "status": "ACTIVE",
            "source": "LOCAL",
            "userId": 500001,
            "userName": "zhangsan",
            "appointments": [
              {
                "id": 400003,
                "orgName": "研发一部",
                "positionName": "高级开发工程师",
                "type": "PRIMARY",
                "status": "ACTIVE"
              }
            ],
            "createdAt": "2026-01-20T10:00:00",
            "updatedAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（人员不存在）

        ```json
        {
          "code": 404005,
          "message": "人员不存在",
          "data": {
            "personId": 300001
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.3.8 UR-PSN-08 分页查询人员

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-PSN-08                            |
    | 接口路径   | GET /api/v1/ur/person                |
    | 功能简述   | 分页查询人员列表，支持多条件组合过滤 |
    | 所需权限   | ur:iam:person:list                   |
    | 关联功能   | F-PSN-01 人员管理                    |
    | 关联用例   | UC-PSN-08 管理员查询人员列表         |
    | 关联领域   | PersonQueryService.page()            |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001                             |

    表 4.4.4.3.8-1 UR-PSN-08契约概述表

+   **请求契约表**

    | 参数名     | 位置  | 类型    | 必填 | 约束                  | 示例值   | 业务含义                |
    | ---------- | ----- | ------- | ---- | --------------------- | -------- | ----------------------- |
    | keyword    | query | String  | 否   | 长度≤50               | "张"     | 搜索关键词（工号/姓名） |
    | orgId      | query | Number  | 否   | 正整数                | 100001   | 组织单元ID过滤          |
    | positionId | query | Number  | 否   | 正整数                | 200001   | 岗位ID过滤              |
    | source     | query | String  | 否   | 枚举：LOCAL/EXTERNAL  | "LOCAL"  | 数据来源过滤            |
    | status     | query | String  | 否   | 枚举：ACTIVE/RESIGNED | "ACTIVE" | 状态过滤                |
    | hasUser    | query | Boolean | 否   | true/false            | true     | 是否已关联用户          |
    | page       | query | Integer | 否   | ≥1，默认1             | 1        | 页码                    |
    | size       | query | Integer | 否   | 1-100，默认20         | 20       | 每页大小                |

    表 4.4.4.3.8-2 UR-PSN-08请求契约表

+   **响应契约表**

    | 参数名                   | 类型    | 必有 | 示例值           | 业务含义     |
    | ------------------------ | ------- | ---- | ---------------- | ------------ |
    | code                     | Number  | 是   | 200              | 响应码       |
    | message                  | String  | 是   | "success"        | 响应消息     |
    | data.list[]              | Array   | 是   | [...]            | 人员列表     |
    | data.list[].id           | Number  | 是   | 300001           | 人员ID       |
    | data.list[].employeeNo   | String  | 是   | "EMP20260001"    | 工号         |
    | data.list[].name         | String  | 是   | "张三"           | 姓名         |
    | data.list[].orgName      | String  | 否   | "研发一部"       | 主职组织名称 |
    | data.list[].positionName | String  | 否   | "高级开发工程师" | 主职岗位名称 |
    | data.list[].source       | String  | 是   | "LOCAL"          | 数据来源     |
    | data.list[].status       | String  | 是   | "ACTIVE"         | 状态         |
    | data.list[].hasUser      | Boolean | 是   | true             | 是否关联用户 |
    | data.total               | Number  | 是   | 156              | 总记录数     |
    | data.page                | Number  | 是   | 1                | 当前页码     |
    | data.size                | Number  | 是   | 20               | 每页大小     |
    | data.pages               | Number  | 是   | 8                | 总页数       |

    表 4.4.4.3.8-3 UR-PSN-08响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 300001,
                "employeeNo": "EMP20260001",
                "name": "张三",
                "orgName": "研发一部",
                "positionName": "高级开发工程师",
                "source": "LOCAL",
                "status": "ACTIVE",
                "hasUser": true
              },
              {
                "id": 300001,
                "employeeNo": "EMP20260002",
                "name": "李四",
                "orgName": "研发二部",
                "positionName": "初级开发工程师",
                "source": "EXTERNAL",
                "status": "ACTIVE",
                "hasUser": false
              }
            ],
            "total": 156,
            "page": 1,
            "size": 20,
            "pages": 8
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.3.9 UR-PSN-09 删除人员

+   **契约概述表**

    | 属性       | 值                                                     |
    | ---------- | ------------------------------------------------------ |
    | API编号    | UR-PSN-09                                              |
    | 接口路径   | DELETE /api/v1/ur/person/{id}                          |
    | 功能简述   | 删除本地人员记录，需为已离职状态且无有效任职           |
    | 所需权限   | ur:iam:person:delete                                   |
    | 关联功能   | F-PSN-07 人员删除                                      |
    | 关联用例   | UC-PSN-09 管理员删除人员                               |
    | 关联领域   | PersonService.deletePerson()                           |
    | 关联规则   | PSN-R-05（仅LOCAL可操作）, PSN-R-08（删除前提-已离职） |
    | 幂等性     | 是（已删除返回成功）                                   |
    | 关联错误码 | E-403006, E-404005, E-422116                           |

    表 4.4.4.3.9-1 UR-PSN-09契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 300001 | 人员ID   |

    表 4.4.4.3.9-2 UR-PSN-09请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义     |
    | -------------- | ------ | ---- | --------------------- | ------------ |
    | code           | Number | 是   | 200                   | 响应码       |
    | message        | String | 是   | "删除成功"            | 响应消息     |
    | data.id        | Number | 是   | 300001                | 已删除人员ID |
    | data.deletedAt | String | 是   | "2026-01-26T12:00:00" | 删除时间     |

    表 4.4.4.3.9-3 UR-PSN-09响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "删除成功",
          "data": {
            "id": 300001,
            "deletedAt": "2026-01-26T12:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（非离职状态）

        ```json
        {
          "code": 422116,
          "message": "仅离职人员可删除",
          "data": {
            "currentStatus": "ACTIVE"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可删除
    -   人员必须为离职状态（RESIGNED）
    -   逻辑删除，设置deleted=1和deleted_at
    -   同时解除人员与用户的关联

#### 4.4.4.4 任职接口（UR-APT）

##### 4.4.4.4.1 UR-APT-01 创建任职

+   **契约概述表**

    | 属性       | 值                                                         |
    | ---------- | ---------------------------------------------------------- |
    | API编号    | UR-APT-01                                                  |
    | 接口路径   | POST /api/v1/ur/appointment                                |
    | 功能简述   | 为人员创建新任职关系                                       |
    | 所需权限   | ur:iam:appointment:create                                  |
    | 关联功能   | F-APT-01 任职管理                                          |
    | 关联用例   | UC-APT-01 管理员为人员创建任职                             |
    | 关联领域   | Appointment.create()                                       |
    | 关联规则   | APT-R-01（仅LOCAL人员可创建）, APT-R-02（主职唯一性）      |
    | 幂等性     | 否                                                         |
    | 关联错误码 | E-400001, E-404002, E-404003, E-404004, E-422301, E-422302 |

    表 4.4.4.4.1-1 UR-APT-01契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                                        | 示例值       | 业务含义   |
    | ---------- | ---- | ------ | ---- | ------------------------------------------- | ------------ | ---------- |
    | personId   | body | Number | 是   | 正整数                                      | 300001       | 人员ID     |
    | orgId      | body | Number | 是   | 正整数                                      | 100006       | 组织单元ID |
    | positionId | body | Number | 是   | 正整数                                      | 200002       | 岗位ID     |
    | type       | body | String | 否   | 枚举：PRIMARY/PARTTIME/ACTING，默认PARTTIME | "PARTTIME"   | 任职类型   |
    | startDate  | body | String | 否   | ISO8601日期格式，默认今天                   | "2026-01-26" | 开始日期   |

    表 4.4.4.4.1-2 UR-APT-01请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义     |
    | ----------------- | ------ | ---- | --------------------- | ------------ |
    | code              | Number | 是   | 200                   | 响应码       |
    | message           | String | 是   | "创建成功"            | 响应消息     |
    | data.id           | Number | 是   | 400001                | 任职ID       |
    | data.personId     | Number | 是   | 300001                | 人员ID       |
    | data.personName   | String | 是   | "张三"                | 人员姓名     |
    | data.orgId        | Number | 是   | 100006                | 组织单元ID   |
    | data.orgName      | String | 是   | "研发一部"            | 组织单元名称 |
    | data.positionId   | Number | 是   | 200002                | 岗位ID       |
    | data.positionName | String | 是   | "高级工程师"          | 岗位名称     |
    | data.type         | String | 是   | "PARTTIME"            | 任职类型     |
    | data.startDate    | String | 是   | "2026-01-26"          | 开始日期     |
    | data.status       | String | 是   | "ACTIVE"              | 状态         |
    | data.createdAt    | String | 是   | "2026-01-26T10:00:00" | 创建时间     |

    表 4.4.4.4.1-3 UR-APT-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "personId": 300001,
          "orgId": 100006,
          "positionId": 200002,
          "type": "PARTTIME",
          "startDate": "2026-01-26"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "创建成功",
          "data": {
            "id": 400001,
            "personId": 300001,
            "personName": "张三",
            "orgId": 100006,
            "orgName": "研发一部",
            "positionId": 200002,
            "positionName": "高级工程师",
            "type": "PARTTIME",
            "startDate": "2026-01-26",
            "status": "ACTIVE",
            "createdAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（已有主职）

        ```json
        {
          "code": 422302,
          "message": "该人员已有主职，不能再创建主职",
          "data": {
            "existingPrimaryId": 400002,
            "suggestion": "请选择PARTTIME或ACTING类型，或先终止现有主职"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可创建任职
    -   人员必须为在职状态
    -   type=PRIMARY时，若已有主职，返回错误提示

##### 4.4.4.4.2 UR-APT-02 调岗

+   **契约概述表**

    | 属性       | 值                                                      |
    | ---------- | ------------------------------------------------------- |
    | API编号    | UR-APT-02                                               |
    | 接口路径   | PUT /api/v1/ur/appointment/{id}/transfer                |
    | 功能简述   | 变更任职的组织或岗位（调岗）                            |
    | 所需权限   | ur:iam:appointment:update                               |
    | 关联功能   | F-APT-02 调岗管理                                       |
    | 关联用例   | UC-APT-02 管理员为人员调岗                              |
    | 关联领域   | Appointment.transfer()                                  |
    | 关联规则   | APT-R-01（仅LOCAL人员可操作）, APT-R-03（至少变更一项） |
    | 幂等性     | 否                                                      |
    | 关联错误码 | E-400001, E-404005, E-404003, E-404004, E-422303        |

    表 4.4.4.4.2-1 UR-APT-02契约概述表

+   **请求契约表**

    | 参数名        | 位置 | 类型   | 必填 | 约束               | 示例值 | 业务含义     |
    | ------------- | ---- | ------ | ---- | ------------------ | ------ | ------------ |
    | id            | path | Number | 是   | 正整数             | 400001 | 任职ID       |
    | newOrgId      | body | Number | 否   | 正整数，二选一必填 | 100007 | 新组织单元ID |
    | newPositionId | body | Number | 否   | 正整数，二选一必填 | 200003 | 新岗位ID     |

    表 4.4.4.4.2-2 UR-APT-02请求契约表

+   **响应契约表**

    | 参数名                    | 类型   | 必有 | 示例值                | 业务含义       |
    | ------------------------- | ------ | ---- | --------------------- | -------------- |
    | code                      | Number | 是   | 200                   | 响应码         |
    | message                   | String | 是   | "调岗成功"            | 响应消息       |
    | data.id                   | Number | 是   | 400001                | 任职ID         |
    | data.previousOrgId        | Number | 否   | 100006                | 原组织单元ID   |
    | data.previousOrgName      | String | 否   | "研发一部"            | 原组织单元名称 |
    | data.newOrgId             | Number | 否   | 100007                | 新组织单元ID   |
    | data.newOrgName           | String | 否   | "研发二部"            | 新组织单元名称 |
    | data.previousPositionId   | Number | 否   | 200002                | 原岗位ID       |
    | data.previousPositionName | String | 否   | "高级工程师"          | 原岗位名称     |
    | data.newPositionId        | Number | 否   | 200003                | 新岗位ID       |
    | data.newPositionName      | String | 否   | "技术经理"            | 新岗位名称     |
    | data.transferredAt        | String | 是   | "2026-01-26T10:00:00" | 调岗时间       |

    表 4.4.4.4.2-3 UR-APT-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "newOrgId": 100007,
          "newPositionId": 200003
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "调岗成功",
          "data": {
            "id": 400001,
            "previousOrgId": 100006,
            "previousOrgName": "研发一部",
            "newOrgId": 100007,
            "newOrgName": "研发二部",
            "previousPositionId": 200002,
            "previousPositionName": "高级工程师",
            "newPositionId": 200003,
            "newPositionName": "技术经理",
            "transferredAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   newOrgId和newPositionId至少提供一个
    -   调岗会记录变更历史

##### 4.4.4.4.3 UR-APT-03 终止任职

+   **契约概述表**

    | 属性       | 值                                                      |
    | ---------- | ------------------------------------------------------- |
    | API编号    | UR-APT-03                                               |
    | 接口路径   | PUT /api/v1/ur/appointment/{id}/terminate               |
    | 功能简述   | 终止指定任职关系                                        |
    | 所需权限   | ur:iam:appointment:update                               |
    | 关联功能   | F-APT-03 任职终止                                       |
    | 关联用例   | UC-APT-03 管理员终止人员任职                            |
    | 关联领域   | Appointment.terminate()                                 |
    | 关联规则   | APT-R-01（仅LOCAL人员可操作）, APT-R-04（主职终止确认） |
    | 幂等性     | 是（已终止返回成功）                                    |
    | 关联错误码 | E-400001, E-404005, E-422304                            |

    表 4.4.4.4.3-1 UR-APT-03契约概述表

+   **请求契约表**

    | 参数名  | 位置 | 类型   | 必填 | 约束                      | 示例值       | 业务含义 |
    | ------- | ---- | ------ | ---- | ------------------------- | ------------ | -------- |
    | id      | path | Number | 是   | 正整数                    | 400001       | 任职ID   |
    | endDate | body | String | 否   | ISO8601日期格式，默认今天 | "2026-01-26" | 结束日期 |

    表 4.4.4.4.3-2 UR-APT-03请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义 |
    | ----------------- | ------ | ---- | --------------------- | -------- |
    | code              | Number | 是   | 200                   | 响应码   |
    | message           | String | 是   | "终止成功"            | 响应消息 |
    | data.id           | Number | 是   | 400001                | 任职ID   |
    | data.status       | String | 是   | "TERMINATED"          | 状态     |
    | data.endDate      | String | 是   | "2026-01-26"          | 结束日期 |
    | data.terminatedAt | String | 是   | "2026-01-26T10:00:00" | 终止时间 |

    表 4.4.4.4.3-3 UR-APT-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "endDate": "2026-01-26"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "终止成功",
          "data": {
            "id": 400001,
            "status": "TERMINATED",
            "endDate": "2026-01-26",
            "terminatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   type=PRIMARY的任职终止时，需前端二次确认

##### 4.4.4.4.4 UR-APT-04 设为主职

+   **契约概述表**

    | 属性       | 值                                                        |
    | ---------- | --------------------------------------------------------- |
    | API编号    | UR-APT-04                                                 |
    | 接口路径   | PUT /api/v1/ur/appointment/{id}/set-primary               |
    | 功能简述   | 将兼职或代理任职设为主职                                  |
    | 所需权限   | ur:iam:appointment:update                                 |
    | 关联功能   | F-APT-04 主职管理                                         |
    | 关联用例   | UC-APT-04 管理员设置人员主职                              |
    | 关联领域   | Appointment.setPrimary()                                  |
    | 关联规则   | APT-R-01（仅LOCAL人员可操作）, APT-R-05（原主职自动降级） |
    | 幂等性     | 是（已是主职返回成功）                                    |
    | 关联错误码 | E-400001, E-404005, E-422305                              |

    表 4.4.4.4.4-1 UR-APT-04契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 400001 | 任职ID   |

    表 4.4.4.4.4-2 UR-APT-04请求契约表

+   **响应契约表**

    | 参数名                   | 类型   | 必有 | 示例值                | 业务含义         |
    | ------------------------ | ------ | ---- | --------------------- | ---------------- |
    | code                     | Number | 是   | 200                   | 响应码           |
    | message                  | String | 是   | "设置成功"            | 响应消息         |
    | data.id                  | Number | 是   | 400001                | 任职ID           |
    | data.type                | String | 是   | "PRIMARY"             | 新任职类型       |
    | data.previousPrimaryId   | Number | 否   | 400002                | 原主职任职ID     |
    | data.previousPrimaryType | String | 否   | "PARTTIME"            | 原主职变更后类型 |
    | data.updatedAt           | String | 是   | "2026-01-26T10:00:00" | 更新时间         |

    表 4.4.4.4.4-3 UR-APT-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "设置成功",
          "data": {
            "id": 400001,
            "type": "PRIMARY",
            "previousPrimaryId": 400002,
            "previousPrimaryType": "PARTTIME",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   仅source=LOCAL的人员可操作
    -   任职类型必须为PARTTIME或ACTING
    -   原主职自动变为PARTTIME

##### 4.4.4.4.5 UR-APT-05 查询任职详情

+   **契约概述表**

    | 属性       | 值                                |
    | ---------- | --------------------------------- |
    | API编号    | UR-APT-05                         |
    | 接口路径   | GET /api/v1/ur/appointment/{id}   |
    | 功能简述   | 查询指定任职的详细信息            |
    | 所需权限   | ur:iam:appointment:detail         |
    | 关联功能   | F-APT-05 任职查询                 |
    | 关联用例   | UC-APT-05 管理员查看任职详情      |
    | 关联领域   | AppointmentQueryService.getById() |
    | 关联规则   | 无                                |
    | 幂等性     | 是                                |
    | 关联错误码 | E-400001, E-401001, E-404005      |

    表 4.4.4.4.5-1 UR-APT-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 400001 | 任职ID   |

    表 4.4.4.4.5-2 UR-APT-05请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义     |
    | ----------------- | ------ | ---- | --------------------- | ------------ |
    | code              | Number | 是   | 200                   | 响应码       |
    | message           | String | 是   | "success"             | 响应消息     |
    | data.id           | Number | 是   | 400001                | 任职ID       |
    | data.personId     | Number | 是   | 300001                | 人员ID       |
    | data.personName   | String | 是   | "张三"                | 人员姓名     |
    | data.employeeNo   | String | 是   | "EMP001"              | 工号         |
    | data.orgId        | Number | 是   | 100006                | 组织单元ID   |
    | data.orgName      | String | 是   | "研发一部"            | 组织单元名称 |
    | data.positionId   | Number | 是   | 200002                | 岗位ID       |
    | data.positionName | String | 是   | "高级工程师"          | 岗位名称     |
    | data.type         | String | 是   | "PRIMARY"             | 任职类型     |
    | data.startDate    | String | 是   | "2026-01-01"          | 开始日期     |
    | data.endDate      | String | 否   | null                  | 结束日期     |
    | data.status       | String | 是   | "ACTIVE"              | 状态         |
    | data.source       | String | 是   | "LOCAL"               | 数据来源     |
    | data.createdAt    | String | 是   | "2026-01-01T10:00:00" | 创建时间     |
    | data.updatedAt    | String | 是   | "2026-01-26T10:00:00" | 更新时间     |

    表 4.4.4.4.5-3 UR-APT-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 400001,
            "personId": 300001,
            "personName": "张三",
            "employeeNo": "EMP001",
            "orgId": 100006,
            "orgName": "研发一部",
            "positionId": 200002,
            "positionName": "高级工程师",
            "type": "PRIMARY",
            "startDate": "2026-01-01",
            "endDate": null,
            "status": "ACTIVE",
            "source": "LOCAL",
            "createdAt": "2026-01-01T10:00:00",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.4.6 UR-APT-06 分页查询任职

+   **契约概述表**

    | 属性       | 值                               |
    | ---------- | -------------------------------- |
    | API编号    | UR-APT-06                        |
    | 接口路径   | GET /api/v1/ur/appointment       |
    | 功能简述   | 分页查询任职列表，支持多条件过滤 |
    | 所需权限   | ur:iam:appointment:list          |
    | 关联功能   | F-APT-06 任职列表查询            |
    | 关联用例   | UC-APT-06 管理员查询任职列表     |
    | 关联领域   | AppointmentQueryService.page()   |
    | 关联规则   | 无                               |
    | 幂等性     | 是                               |
    | 关联错误码 | E-400001, E-401001               |

    表 4.4.4.4.6-1 UR-APT-06契约概述表

+   **请求契约表**

    | 参数名     | 位置  | 类型    | 必填 | 约束                          | 示例值    | 业务含义     |
    | ---------- | ----- | ------- | ---- | ----------------------------- | --------- | ------------ |
    | personId   | query | Number  | 否   | 正整数                        | 300001    | 人员ID过滤   |
    | orgId      | query | Number  | 否   | 正整数                        | 100006    | 组织单元过滤 |
    | positionId | query | Number  | 否   | 正整数                        | 200002    | 岗位过滤     |
    | type       | query | String  | 否   | 枚举：PRIMARY/PARTTIME/ACTING | "PRIMARY" | 任职类型过滤 |
    | status     | query | String  | 否   | 枚举：ACTIVE/TERMINATED       | "ACTIVE"  | 状态过滤     |
    | page       | query | Integer | 否   | ≥1，默认1                     | 1         | 页码         |
    | size       | query | Integer | 否   | 1-100，默认20                 | 20        | 每页大小     |

    表 4.4.4.4.6-2 UR-APT-06请求契约表

+   **响应契约表**

    | 参数名                   | 类型   | 必有 | 示例值       | 业务含义     |
    | ------------------------ | ------ | ---- | ------------ | ------------ |
    | code                     | Number | 是   | 200          | 响应码       |
    | message                  | String | 是   | "success"    | 响应消息     |
    | data.list[]              | Array  | 是   | [...]        | 任职列表     |
    | data.list[].id           | Number | 是   | 400001       | 任职ID       |
    | data.list[].personId     | Number | 是   | 300001       | 人员ID       |
    | data.list[].personName   | String | 是   | "张三"       | 人员姓名     |
    | data.list[].employeeNo   | String | 是   | "EMP001"     | 工号         |
    | data.list[].orgName      | String | 是   | "研发一部"   | 组织单元名称 |
    | data.list[].positionName | String | 是   | "高级工程师" | 岗位名称     |
    | data.list[].type         | String | 是   | "PRIMARY"    | 任职类型     |
    | data.list[].status       | String | 是   | "ACTIVE"     | 状态         |
    | data.list[].source       | String | 是   | "LOCAL"      | 数据来源     |
    | data.total               | Number | 是   | 100          | 总记录数     |
    | data.page                | Number | 是   | 1            | 当前页码     |
    | data.size                | Number | 是   | 20           | 每页大小     |
    | data.pages               | Number | 是   | 5            | 总页数       |

    表 4.4.4.4.6-3 UR-APT-06响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 400001,
                "personId": 300001,
                "personName": "张三",
                "employeeNo": "EMP001",
                "orgName": "研发一部",
                "positionName": "高级工程师",
                "type": "PRIMARY",
                "status": "ACTIVE",
                "source": "LOCAL"
              }
            ],
            "total": 100,
            "page": 1,
            "size": 20,
            "pages": 5
          },
          "timestamp": 1737885600000
        }
        ```

#### 4.4.4.5 同步管理接口（UR-SYNC）

##### 4.4.4.5.1 UR-SYNC-01 触发全量同步

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-SYNC-01                               |
    | 接口路径   | POST /api/v1/ur/sync/full                |
    | 功能简述   | 手动触发全量同步，从外部系统拉取全部数据 |
    | 所需权限   | ur:iam:sync:execute                      |
    | 关联功能   | F-SYNC-01 全量同步                       |
    | 关联用例   | UC-SYNC-01 管理员触发全量同步            |
    | 关联领域   | OrgSyncService.fullSync()                |
    | 关联规则   | SYNC-R-01（同一时间只能有一个同步任务）  |
    | 幂等性     | 否（每次创建新任务）                     |
    | 关联错误码 | E-400001, E-401001, E-422401             |

    表 4.4.4.5.1-1 UR-SYNC-01契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                     | 示例值   | 业务含义   |
    | ---------- | ---- | ------ | ---- | ------------------------ | -------- | ---------- |
    | sourceType | body | String | 否   | 枚举：FEISHU/DINGTALK/AD | "FEISHU" | 同步源类型 |

    表 4.4.4.5.1-2 UR-SYNC-01请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义   |
    | -------------- | ------ | ---- | --------------------- | ---------- |
    | code           | Number | 是   | 200                   | 响应码     |
    | message        | String | 是   | "同步任务已启动"      | 响应消息   |
    | data.taskId    | Number | 是   | 600001                | 同步任务ID |
    | data.syncType  | String | 是   | "FULL"                | 同步类型   |
    | data.status    | String | 是   | "RUNNING"             | 任务状态   |
    | data.startedAt | String | 是   | "2026-01-26T10:00:00" | 开始时间   |

    表 4.4.4.5.1-3 UR-SYNC-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "sourceType": "FEISHU"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "同步任务已启动",
          "data": {
            "taskId": 600002,
            "syncType": "FULL",
            "status": "RUNNING",
            "startedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（已有任务运行中）

        ```json
        {
          "code": 422401,
          "message": "已有同步任务运行中，请稍后再试",
          "data": {
            "runningTaskId": 600001,
            "runningTaskType": "INCREMENTAL",
            "startedAt": "2026-01-26T09:55:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.5.2 UR-SYNC-02 触发增量同步

+   **契约概述表**

    | 属性       | 值                                      |
    | ---------- | --------------------------------------- |
    | API编号    | UR-SYNC-02                              |
    | 接口路径   | POST /api/v1/ur/sync/incremental        |
    | 功能简述   | 手动触发增量同步，仅同步变更数据        |
    | 所需权限   | ur:iam:sync:execute                     |
    | 关联功能   | F-SYNC-02 增量同步                      |
    | 关联用例   | UC-SYNC-02 管理员触发增量同步           |
    | 关联领域   | OrgSyncService.incrementalSync()        |
    | 关联规则   | SYNC-R-01（同一时间只能有一个同步任务） |
    | 幂等性     | 否（每次创建新任务）                    |
    | 关联错误码 | E-400001, E-401001, E-422401            |

    表 4.4.4.5.2-1 UR-SYNC-02契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 4.4.4.5.2-2 UR-SYNC-02请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义   |
    | -------------- | ------ | ---- | --------------------- | ---------- |
    | code           | Number | 是   | 200                   | 响应码     |
    | message        | String | 是   | "增量同步已启动"      | 响应消息   |
    | data.taskId    | Number | 是   | 600002                | 同步任务ID |
    | data.syncType  | String | 是   | "INCREMENTAL"         | 同步类型   |
    | data.status    | String | 是   | "RUNNING"             | 任务状态   |
    | data.startedAt | String | 是   | "2026-01-26T10:00:00" | 开始时间   |

    表 4.4.4.5.2-3 UR-SYNC-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "增量同步已启动",
          "data": {
            "taskId": 600002,
            "syncType": "INCREMENTAL",
            "status": "RUNNING",
            "startedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.5.3 UR-SYNC-03 查询同步状态

+   **契约概述表**

    | 属性       | 值                            |
    | ---------- | ----------------------------- |
    | API编号    | UR-SYNC-03                    |
    | 接口路径   | GET /api/v1/ur/sync/status    |
    | 功能简述   | 查询当前同步状态和配置信息    |
    | 所需权限   | ur:iam:sync:list              |
    | 关联功能   | F-SYNC-03 同步状态查询        |
    | 关联用例   | UC-SYNC-03 管理员查看同步状态 |
    | 关联领域   | SyncQueryService.getStatus()  |
    | 关联规则   | 无                            |
    | 幂等性     | 是                            |
    | 关联错误码 | E-401001                      |

    表 4.4.4.5.3-1 UR-SYNC-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 4.4.4.5.3-2 UR-SYNC-03请求契约表

+   **响应契约表**

    | 参数名                     | 类型    | 必有 | 示例值                | 业务含义         |
    | -------------------------- | ------- | ---- | --------------------- | ---------------- |
    | code                       | Number  | 是   | 200                   | 响应码           |
    | message                    | String  | 是   | "success"             | 响应消息         |
    | data.lastSyncTime          | String  | 否   | "2026-01-26T09:00:00" | 上次同步时间     |
    | data.lastSyncType          | String  | 否   | "INCREMENTAL"         | 上次同步类型     |
    | data.lastSyncStatus        | String  | 否   | "SUCCESS"             | 上次同步状态     |
    | data.currentTask           | Object  | 否   | {...}                 | 当前进行中的任务 |
    | data.currentTask.taskId    | Number  | 否   | 600003                | 任务ID           |
    | data.currentTask.syncType  | String  | 否   | "FULL"                | 同步类型         |
    | data.currentTask.progress  | Number  | 否   | 45                    | 进度百分比       |
    | data.syncEnabled           | Boolean | 是   | true                  | 同步是否启用     |
    | data.syncConfig.sourceType | String  | 是   | "FEISHU"              | 同步源类型       |
    | data.syncConfig.cronExpr   | String  | 是   | "0 0 2 ** ?"          | 定时任务表达式   |

    表 4.4.4.5.3-3 UR-SYNC-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "lastSyncTime": "2026-01-26T02:00:00",
            "lastSyncType": "FULL",
            "lastSyncStatus": "SUCCESS",
            "currentTask": null,
            "syncEnabled": true,
            "syncConfig": {
              "sourceType": "FEISHU",
              "cronExpr": "0 0 2 * * ?"
            }
          },
          "timestamp": 1737885600000
        }
        ```

##### 4.4.4.5.4 UR-SYNC-04 查询同步异常

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-SYNC-04                               |
    | 接口路径   | GET /api/v1/ur/sync/exceptions           |
    | 功能简述   | 分页查询同步异常记录，用于问题排查和处理 |
    | 所需权限   | ur:iam:sync:list                         |
    | 关联功能   | F-SYNC-04 同步异常管理                   |
    | 关联用例   | UC-SYNC-04 管理员查询同步异常            |
    | 关联领域   | SyncQueryService.getExceptions()         |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-401001                                 |

    表 4.4.4.5.4-1 UR-SYNC-04契约概述表

+   **请求契约表**

    | 参数名    | 位置  | 类型    | 必填 | 约束                    | 示例值                | 业务含义     |
    | --------- | ----- | ------- | ---- | ----------------------- | --------------------- | ------------ |
    | level     | query | String  | 否   | 枚举：ERROR/WARN/INFO   | "ERROR"               | 异常级别过滤 |
    | type      | query | String  | 否   | 枚举：DATA/NETWORK/AUTH | "DATA"                | 异常类型过滤 |
    | startTime | query | String  | 否   | ISO8601格式             | "2026-01-25T00:00:00" | 开始时间     |
    | endTime   | query | String  | 否   | ISO8601格式             | "2026-01-26T23:59:59" | 结束时间     |
    | handled   | query | Boolean | 否   | -                       | false                 | 是否已处理   |
    | page      | query | Integer | 否   | ≥1，默认1               | 1                     | 页码         |
    | size      | query | Integer | 否   | 1-100，默认20           | 20                    | 每页大小     |

    表 4.4.4.5.4-2 UR-SYNC-04请求契约表

+   **响应契约表**

    | 参数名                  | 类型    | 必有 | 示例值                | 业务含义   |
    | ----------------------- | ------- | ---- | --------------------- | ---------- |
    | code                    | Number  | 是   | 200                   | 响应码     |
    | message                 | String  | 是   | "success"             | 响应消息   |
    | data.list[]             | Array   | 是   | [...]                 | 异常列表   |
    | data.list[].id          | Number  | 是   | 700001                | 异常记录ID |
    | data.list[].syncTaskId  | Number  | 是   | 600001                | 同步任务ID |
    | data.list[].level       | String  | 是   | "ERROR"               | 异常级别   |
    | data.list[].type        | String  | 是   | "DATA"                | 异常类型   |
    | data.list[].dataType    | String  | 是   | "PERSON"              | 数据类型   |
    | data.list[].externalId  | String  | 是   | "feishu_user_123"     | 外部系统ID |
    | data.list[].errorMsg    | String  | 是   | "手机号格式错误"      | 错误信息   |
    | data.list[].handled     | Boolean | 是   | false                 | 是否已处理 |
    | data.list[].handledBy   | String  | 否   | null                  | 处理人     |
    | data.list[].handledTime | String  | 否   | null                  | 处理时间   |
    | data.list[].createdAt   | String  | 是   | "2026-01-26T02:01:00" | 创建时间   |
    | data.total              | Number  | 是   | 50                    | 总记录数   |
    | data.page               | Number  | 是   | 1                     | 当前页码   |
    | data.size               | Number  | 是   | 20                    | 每页大小   |
    | data.pages              | Number  | 是   | 3                     | 总页数     |

    表 4.4.4.5.4-3 UR-SYNC-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 700001,
                "syncTaskId": 600001,
                "level": "ERROR",
                "type": "DATA",
                "dataType": "PERSON",
                "externalId": "feishu_user_123",
                "errorMsg": "手机号格式错误：1380013800",
                "handled": false,
                "handledBy": null,
                "handledTime": null,
                "createdAt": "2026-01-26T02:01:00"
              }
            ],
            "total": 50,
            "page": 1,
            "size": 20,
            "pages": 3
          },
          "timestamp": 1737885600000
        }
        ```

### 4.4.5 追溯关联表

#### 4.4.5.1 API-功能-用例关联表

+   全部REST API与RPC接口的功能-用例追溯关系如下表所示。

    | API编号    | API名称          | 关联功能编号 | 关联功能名称 | 关联用例编号 | 关联用例名称             |
    | ---------- | ---------------- | ------------ | ------------ | ------------ | ------------------------ |
    | UR-ORG-01  | 创建组织单元     | F-ORG-01     | 组织单元创建 | UC-ORG-01    | 管理员创建组织单元       |
    | UR-ORG-02  | 更新组织单元     | F-ORG-02     | 组织单元编辑 | UC-ORG-02    | 管理员编辑组织单元       |
    | UR-ORG-03  | 移动组织单元     | F-ORG-03     | 组织单元移动 | UC-ORG-03    | 管理员移动组织单元       |
    | UR-ORG-04  | 删除组织单元     | F-ORG-04     | 组织单元删除 | UC-ORG-04    | 管理员删除组织单元       |
    | UR-ORG-05  | 查询组织单元详情 | F-ORG-05     | 组织单元查询 | UC-ORG-05    | 管理员查看组织单元详情   |
    | UR-ORG-06  | 查询组织树       | F-ORG-05     | 组织单元查询 | UC-ORG-05    | 管理员查看组织架构       |
    | UR-ORG-07  | 分页查询组织单元 | F-ORG-05     | 组织单元查询 | UC-ORG-05    | 管理员查询组织单元列表   |
    | UR-ORG-08  | 查询子组织列表   | F-ORG-05     | 组织单元查询 | UC-ORG-05    | 管理员查看下级组织       |
    | UR-POS-01  | 创建岗位         | F-POS-01     | 岗位创建     | UC-POS-01    | 管理员创建岗位           |
    | UR-POS-02  | 更新岗位         | F-POS-02     | 岗位编辑     | UC-POS-02    | 管理员编辑岗位           |
    | UR-POS-03  | 变更岗位状态     | F-POS-03     | 岗位状态管理 | UC-POS-03    | 管理员启用停用岗位       |
    | UR-POS-04  | 删除岗位         | F-POS-04     | 岗位删除     | UC-POS-04    | 管理员删除岗位           |
    | UR-POS-05  | 查询岗位详情     | F-POS-05     | 岗位查询     | UC-POS-05    | 管理员查看岗位详情       |
    | UR-POS-06  | 分页查询岗位     | F-POS-05     | 岗位查询     | UC-POS-05    | 管理员查询岗位列表       |
    | UR-PSN-01  | 创建人员         | F-PSN-01     | 人员创建     | UC-PSN-01    | 管理员创建人员           |
    | UR-PSN-02  | 更新人员         | F-PSN-02     | 人员编辑     | UC-PSN-02    | 管理员编辑人员           |
    | UR-PSN-03  | 关联用户         | F-PSN-03     | 人员用户关联 | UC-PSN-03    | 管理员关联人员用户       |
    | UR-PSN-04  | 解除用户关联     | F-PSN-03     | 人员用户关联 | UC-PSN-03    | 管理员解除人员用户关联   |
    | UR-PSN-05  | 人员离职         | F-PSN-04     | 人员离职     | UC-PSN-04    | 管理员处理人员离职       |
    | UR-PSN-06  | 人员复职         | F-PSN-05     | 人员复职     | UC-PSN-05    | 管理员处理人员复职       |
    | UR-PSN-07  | 查询人员详情     | F-PSN-06     | 人员查询     | UC-PSN-06    | 管理员查看人员详情       |
    | UR-PSN-08  | 分页查询人员     | F-PSN-06     | 人员查询     | UC-PSN-06    | 管理员查询人员列表       |
    | UR-PSN-09  | 删除人员         | F-PSN-07     | 人员删除     | UC-PSN-09    | 管理员删除人员           |
    | UR-APT-01  | 创建任职         | F-APT-01     | 任职创建     | UC-APT-01    | 管理员创建任职           |
    | UR-APT-02  | 调岗             | F-APT-02     | 任职调岗     | UC-APT-02    | 管理员调岗               |
    | UR-APT-03  | 终止任职         | F-APT-03     | 任职终止     | UC-APT-03    | 管理员终止任职           |
    | UR-APT-04  | 设为主职         | F-APT-04     | 主职设置     | UC-APT-04    | 管理员设置主职           |
    | UR-APT-05  | 查询任职详情     | F-APT-05     | 任职查询     | UC-APT-05    | 管理员查看任职详情       |
    | UR-APT-06  | 分页查询任职     | F-APT-05     | 任职查询     | UC-APT-05    | 管理员查询任职列表       |
    | UR-SYNC-01 | 触发全量同步     | F-SYNC-01    | 企业同步     | UC-SYNC-01   | 管理员触发全量同步       |
    | UR-SYNC-02 | 触发增量同步     | F-SYNC-01    | 企业同步     | UC-SYNC-01   | 管理员触发增量同步       |
    | UR-SYNC-03 | 查询同步状态     | F-SYNC-02    | 同步状态查询 | UC-SYNC-02   | 管理员查看同步状态       |
    | UR-SYNC-04 | 查询同步异常     | F-SYNC-03    | 异常处理     | UC-SYNC-03   | 管理员查看同步异常       |
    | RPC-ORG-01 | 查询组织树       | F-RPC-01     | 组织树查询   | UC-PERM-01   | 授权管理配置数据权限范围 |

    表 4.4.5.1-1 API-功能-用例关联表

#### 4.4.5.2 API-领域-权限关联表

+   全部REST API与RPC接口的领域-权限追溯关系如下表所示。

    | API编号    | API名称          | 关联聚合     | 领域方法                                   | 权限标识                  | 权限说明     |
    | ---------- | ---------------- | ------------ | ------------------------------------------ | ------------------------- | ------------ |
    | UR-ORG-01  | 创建组织单元     | Organization | OrganizationService.createOrganization()   | ur:iam:org:create         | 创建组织权限 |
    | UR-ORG-02  | 更新组织单元     | Organization | Organization.update()                      | ur:iam:org:update         | 修改组织权限 |
    | UR-ORG-03  | 移动组织单元     | Organization | OrganizationService.moveOrganization()     | ur:iam:org:update         | 修改组织权限 |
    | UR-ORG-04  | 删除组织单元     | Organization | OrganizationService.deleteOrganization()   | ur:iam:org:delete         | 删除组织权限 |
    | UR-ORG-05  | 查询组织单元详情 | -            | OrganizationQueryService.getById()         | ur:iam:org:detail         | 查看组织权限 |
    | UR-ORG-06  | 查询组织树       | -            | OrganizationQueryService.getTree()         | ur:iam:org:list           | 查看组织权限 |
    | UR-ORG-07  | 分页查询组织单元 | -            | OrganizationQueryService.page()            | ur:iam:org:list           | 查看组织权限 |
    | UR-ORG-08  | 查询子组织列表   | -            | OrganizationQueryService.getChildren()     | ur:iam:org:list           | 查看组织权限 |
    | UR-POS-01  | 创建岗位         | Position     | PositionService.createPosition()           | ur:iam:position:create    | 创建岗位权限 |
    | UR-POS-02  | 更新岗位         | Position     | Position.update()                          | ur:iam:position:update    | 修改岗位权限 |
    | UR-POS-03  | 变更岗位状态     | Position     | Position.changeStatus()                    | ur:iam:position:update    | 修改岗位权限 |
    | UR-POS-04  | 删除岗位         | Position     | PositionService.deletePosition()           | ur:iam:position:delete    | 删除岗位权限 |
    | UR-POS-05  | 查询岗位详情     | -            | PositionQueryService.getById()             | ur:iam:position:detail    | 查看岗位权限 |
    | UR-POS-06  | 分页查询岗位     | -            | PositionQueryService.page()                | ur:iam:position:list      | 查看岗位权限 |
    | UR-PSN-01  | 创建人员         | Person       | PersonService.createPerson()               | ur:iam:person:create      | 创建人员权限 |
    | UR-PSN-02  | 更新人员         | Person       | Person.update()                            | ur:iam:person:update      | 修改人员权限 |
    | UR-PSN-03  | 关联用户         | Person       | PersonService.bindUser()                   | ur:iam:person:update      | 修改人员权限 |
    | UR-PSN-04  | 解除用户关联     | Person       | PersonService.unbindUser()                 | ur:iam:person:update      | 修改人员权限 |
    | UR-PSN-05  | 人员离职         | Person       | PersonService.resignPerson()               | ur:iam:person:update      | 修改人员权限 |
    | UR-PSN-06  | 人员复职         | Person       | PersonService.reinstatePerson()            | ur:iam:person:update      | 修改人员权限 |
    | UR-PSN-07  | 查询人员详情     | -            | PersonQueryService.getById()               | ur:iam:person:detail      | 查看人员权限 |
    | UR-PSN-08  | 分页查询人员     | -            | PersonQueryService.page()                  | ur:iam:person:list        | 查看人员权限 |
    | UR-PSN-09  | 删除人员         | Person       | PersonService.deletePerson()               | ur:iam:person:delete      | 删除人员权限 |
    | UR-APT-01  | 创建任职         | Appointment  | AppointmentService.createAppointment()     | ur:iam:appointment:create | 创建任职权限 |
    | UR-APT-02  | 调岗             | Appointment  | AppointmentService.transferAppointment()   | ur:iam:appointment:update | 修改任职权限 |
    | UR-APT-03  | 终止任职         | Appointment  | Appointment.terminate()                    | ur:iam:appointment:update | 修改任职权限 |
    | UR-APT-04  | 设为主职         | Appointment  | AppointmentService.setPrimaryAppointment() | ur:iam:appointment:update | 修改任职权限 |
    | UR-APT-05  | 查询任职详情     | -            | AppointmentQueryService.getById()          | ur:iam:appointment:detail | 查看任职权限 |
    | UR-APT-06  | 分页查询任职     | -            | AppointmentQueryService.page()             | ur:iam:appointment:list   | 查看任职权限 |
    | UR-SYNC-01 | 触发全量同步     | -            | OrgSyncService.fullSync()                  | ur:iam:sync:execute       | 执行同步权限 |
    | UR-SYNC-02 | 触发增量同步     | -            | OrgSyncService.incrementalSync()           | ur:iam:sync:execute       | 执行同步权限 |
    | UR-SYNC-03 | 查询同步状态     | -            | SyncQueryService.getStatus()               | ur:iam:sync:list          | 查看同步权限 |
    | UR-SYNC-04 | 查询同步异常     | -            | SyncQueryService.getExceptions()           | ur:iam:sync:list          | 查看同步权限 |
    | RPC-ORG-01 | 查询组织树       | -            | OrganizationQueryService.getTree()         | internal                  | 内部RPC      |

    表 4.4.5.2-1 API-领域-权限关联表

+   权限标识说明：
    -   `internal`：内部RPC接口，通过服务间认证
    -   `{四段式权限}`：需要登录且拥有对应权限，格式见附录D.3

#### 4.4.5.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。RPC接口无前端页面，不在此表中。

    | API编号    | API名称          | 关联页面编号  | 页面名称     | 触发组件      | 触发时机      |
    | ---------- | ---------------- | ------------- | ------------ | ------------- | ------------- |
    | UR-ORG-01  | 创建组织单元     | PG-UR-ORG-01  | 组织架构管理 | 新建组织按钮  | 点击提交      |
    | UR-ORG-02  | 更新组织单元     | PG-UR-ORG-02  | 组织单元详情 | 编辑按钮      | 点击保存      |
    | UR-ORG-03  | 移动组织单元     | PG-UR-ORG-01  | 组织架构管理 | 移动操作      | 拖拽/选择确认 |
    | UR-ORG-04  | 删除组织单元     | PG-UR-ORG-01  | 组织架构管理 | 删除按钮      | 点击确认      |
    | UR-ORG-05  | 查询组织单元详情 | PG-UR-ORG-02  | 组织单元详情 | -             | 页面加载      |
    | UR-ORG-06  | 查询组织树       | PG-UR-ORG-01  | 组织架构管理 | -             | 页面加载      |
    | UR-ORG-07  | 分页查询组织单元 | PG-UR-ORG-01  | 组织架构管理 | 搜索按钮      | 页面加载/搜索 |
    | UR-ORG-08  | 查询子组织列表   | PG-UR-ORG-02  | 组织单元详情 | -             | 页面加载      |
    | UR-POS-01  | 创建岗位         | PG-UR-POS-01  | 岗位管理     | 新建岗位按钮  | 点击提交      |
    | UR-POS-02  | 更新岗位         | PG-UR-POS-02  | 岗位详情     | 编辑按钮      | 点击保存      |
    | UR-POS-03  | 变更岗位状态     | PG-UR-POS-01  | 岗位管理     | 启用/停用按钮 | 点击确认      |
    | UR-POS-04  | 删除岗位         | PG-UR-POS-01  | 岗位管理     | 删除按钮      | 点击确认      |
    | UR-POS-05  | 查询岗位详情     | PG-UR-POS-02  | 岗位详情     | -             | 页面加载      |
    | UR-POS-06  | 分页查询岗位     | PG-UR-POS-01  | 岗位管理     | 搜索按钮      | 页面加载/搜索 |
    | UR-PSN-01  | 创建人员         | PG-UR-PSN-01  | 人员管理     | 新建人员按钮  | 点击提交      |
    | UR-PSN-02  | 更新人员         | PG-UR-PSN-02  | 人员详情     | 编辑按钮      | 点击保存      |
    | UR-PSN-03  | 关联用户         | PG-UR-PSN-02  | 人员详情     | 关联用户按钮  | 点击确认      |
    | UR-PSN-04  | 解除用户关联     | PG-UR-PSN-02  | 人员详情     | 解除关联按钮  | 点击确认      |
    | UR-PSN-05  | 人员离职         | PG-UR-PSN-02  | 人员详情     | 离职按钮      | 点击确认      |
    | UR-PSN-06  | 人员复职         | PG-UR-PSN-02  | 人员详情     | 复职按钮      | 点击确认      |
    | UR-PSN-07  | 查询人员详情     | PG-UR-PSN-02  | 人员详情     | -             | 页面加载      |
    | UR-PSN-08  | 分页查询人员     | PG-UR-PSN-01  | 人员管理     | 搜索按钮      | 页面加载/搜索 |
    | UR-PSN-09  | 删除人员         | PG-UR-PSN-02  | 人员详情     | 删除按钮      | 点击确认      |
    | UR-APT-01  | 创建任职         | PG-UR-PSN-02  | 人员详情     | 新增任职按钮  | 点击提交      |
    | UR-APT-02  | 调岗             | PG-UR-PSN-02  | 人员详情     | 调岗按钮      | 点击确认      |
    | UR-APT-03  | 终止任职         | PG-UR-PSN-02  | 人员详情     | 终止按钮      | 点击确认      |
    | UR-APT-04  | 设为主职         | PG-UR-PSN-02  | 人员详情     | 设主职按钮    | 点击确认      |
    | UR-APT-05  | 查询任职详情     | PG-UR-PSN-02  | 人员详情     | -             | 页面加载      |
    | UR-APT-06  | 分页查询任职     | PG-UR-APT-01  | 任职管理     | 搜索按钮      | 页面加载/搜索 |
    | UR-SYNC-01 | 触发全量同步     | PG-UR-SYNC-01 | 同步管理     | 全量同步按钮  | 点击确认      |
    | UR-SYNC-02 | 触发增量同步     | PG-UR-SYNC-01 | 同步管理     | 增量同步按钮  | 点击确认      |
    | UR-SYNC-03 | 查询同步状态     | PG-UR-SYNC-01 | 同步管理     | -             | 页面加载      |
    | UR-SYNC-04 | 查询同步异常     | PG-UR-SYNC-02 | 同步异常管理 | 搜索按钮      | 页面加载/搜索 |

    表 4.4.5.3-1 API-页面-组件关联表

## 4.5 数据模型设计

+   本节设计组织管理相关的数据库表结构，包括组织单元、岗位、人员、任职及同步相关表。
+   组织管理数据存储在租户库中，每个租户独立一个库。

### 4.5.1 数据库分布

+   组织管理数据存储在租户库中。

    | 数据库                   | 存储内容               | 说明       |
    | ------------------------ | ---------------------- | ---------- |
    | clarisphere_t{tenant_id} | 组织、岗位、人员、任职 | 租户独立库 |

    表 4.5.1-1 数据库分布

+   组织管理相关表清单如下。

    | 表名               | 说明       | 主要字段                           |
    | ------------------ | ---------- | ---------------------------------- |
    | org_organization   | 组织单元表 | id, code, name, parent_id          |
    | org_position       | 岗位表     | id, code, name, category           |
    | org_person         | 人员表     | id, employee_no, name, user_id     |
    | org_appointment    | 任职表     | id, person_id, org_id, position_id |
    | org_sync_task      | 同步任务表 | id, type, status, started_at       |
    | org_sync_exception | 同步异常表 | id, task_id, level, type           |

    表 4.5.1-2 组织管理表清单

### 4.5.2 租户库表结构

#### 4.5.2.1 org_organization 组织单元表

+   组织单元表存储组织架构树形结构。

     | 字段名      | 数据类型     | 可空 | 默认值         | 说明                 |
     | ----------- | ------------ | ---- | -------------- | -------------------- |
     | id          | BIGINT       | 否   | AUTO_INCREMENT | 主键                 |
     | tenant_id   | BIGINT       | 否   | -              | 租户ID               |
     | code        | VARCHAR(64)  | 否   | -              | 组织编码，租户内唯一 |
     | name        | VARCHAR(64)  | 否   | -              | 组织名称             |
     | type        | VARCHAR(32)  | 否   | -              | 组织类型             |
     | parent_id   | BIGINT       | 是   | NULL           | 上级组织ID           |
     | path        | VARCHAR(512) | 否   | -              | 层级路径             |
     | level       | INT          | 否   | 1              | 层级深度             |
     | sort_order  | INT          | 否   | 0              | 排序序号             |
     | status      | VARCHAR(32)  | 否   | 'ACTIVE'       | 状态                 |
     | source      | VARCHAR(32)  | 否   | 'LOCAL'        | 数据来源             |
     | external_id | VARCHAR(128) | 是   | NULL           | 外部系统ID           |
     | description | VARCHAR(512) | 是   | NULL           | 组织描述             |
     | created_by  | BIGINT       | 否   | -              | 创建人               |
     | created_at  | DATETIME     | 否   | NOW()          | 创建时间             |
     | updated_by  | BIGINT       | 是   | NULL           | 更新人               |
     | updated_at  | DATETIME     | 是   | NULL           | 更新时间             |
     | deleted     | TINYINT      | 否   | 0              | 逻辑删除标记         |
     | deleted_at  | DATETIME     | 是   | NULL           | 删除时间             |
     | deleted_by  | BIGINT       | 是   | NULL           | 删除人               |

    表 4.5.2.1-1 org_organization表结构

+   索引设计。

    | 索引名             | 索引字段        | 类型 | 说明           |
    | ------------------ | --------------- | ---- | -------------- |
    | uk_org_tenant_code | tenant_id, code | 唯一 | 租户内编码唯一 |
    | idx_org_parent     | parent_id       | 普通 | 上级组织查询   |
    | idx_org_path       | path            | 普通 | 路径前缀查询   |
    | idx_org_source     | source          | 普通 | 数据来源过滤   |
    | idx_org_external   | external_id     | 普通 | 外部ID查询     |

    表 4.5.2.1-2 org_organization索引设计

#### 4.5.2.2 org_position 岗位表

+   岗位表存储租户级岗位定义。

     | 字段名       | 数据类型     | 可空 | 默认值         | 说明                 |
     | ------------ | ------------ | ---- | -------------- | -------------------- |
     | id           | BIGINT       | 否   | AUTO_INCREMENT | 主键                 |
     | tenant_id    | BIGINT       | 否   | -              | 租户ID               |
     | code         | VARCHAR(64)  | 否   | -              | 岗位编码，租户内唯一 |
     | name         | VARCHAR(64)  | 否   | -              | 岗位名称             |
     | category     | VARCHAR(64)  | 是   | NULL           | 岗位类别             |
     | description  | TEXT         | 是   | NULL           | 岗位职责描述         |
     | requirements | TEXT         | 是   | NULL           | 任职要求             |
     | status       | VARCHAR(32)  | 否   | 'ACTIVE'       | 状态                 |
     | source       | VARCHAR(32)  | 否   | 'LOCAL'        | 数据来源             |
     | external_id  | VARCHAR(128) | 是   | NULL           | 外部系统ID           |
     | created_by   | BIGINT       | 否   | -              | 创建人               |
     | created_at   | DATETIME     | 否   | NOW()          | 创建时间             |
     | updated_by   | BIGINT       | 是   | NULL           | 更新人               |
     | updated_at   | DATETIME     | 是   | NULL           | 更新时间             |
     | deleted      | TINYINT      | 否   | 0              | 逻辑删除标记         |
     | deleted_at   | DATETIME     | 是   | NULL           | 删除时间             |
     | deleted_by   | BIGINT       | 是   | NULL           | 删除人               |

    表 4.5.2.2-1 org_position表结构

+   索引设计。

    | 索引名             | 索引字段        | 类型 | 说明           |
    | ------------------ | --------------- | ---- | -------------- |
    | uk_pos_tenant_code | tenant_id, code | 唯一 | 租户内编码唯一 |
    | idx_pos_category   | category        | 普通 | 类别过滤       |
    | idx_pos_source     | source          | 普通 | 数据来源过滤   |
    | idx_pos_external   | external_id     | 普通 | 外部ID查询     |

    表 4.5.2.2-2 org_position索引设计

#### 4.5.2.3 org_person 人员表

+   人员表存储组织中的人员信息。

     | 字段名         | 数据类型     | 可空 | 默认值         | 说明             |
     | -------------- | ------------ | ---- | -------------- | ---------------- |
     | id             | BIGINT       | 否   | AUTO_INCREMENT | 主键             |
     | tenant_id      | BIGINT       | 否   | -              | 租户ID           |
     | employee_no    | VARCHAR(64)  | 否   | -              | 工号，租户内唯一 |
     | name           | VARCHAR(64)  | 否   | -              | 姓名             |
     | gender         | VARCHAR(16)  | 是   | NULL           | 性别             |
     | mobile         | VARCHAR(32)  | 是   | NULL           | 手机号           |
     | email          | VARCHAR(128) | 是   | NULL           | 邮箱             |
     | hire_date      | DATE         | 是   | NULL           | 入职日期         |
     | resign_date    | DATE         | 是   | NULL           | 离职日期         |
     | status         | VARCHAR(32)  | 否   | 'ACTIVE'       | 状态             |
     | source         | VARCHAR(32)  | 否   | 'LOCAL'        | 数据来源         |
     | external_id    | VARCHAR(128) | 是   | NULL           | 外部系统ID       |
     | user_id        | BIGINT       | 是   | NULL           | 关联用户ID       |
     | user_bind_time | DATETIME     | 是   | NULL           | 用户关联时间     |
     | user_bind_type | VARCHAR(16)  | 是   | NULL           | 用户关联类型     |
     | created_by     | BIGINT       | 否   | -              | 创建人           |
     | created_at     | DATETIME     | 否   | NOW()          | 创建时间         |
     | updated_by     | BIGINT       | 是   | NULL           | 更新人           |
     | updated_at     | DATETIME     | 是   | NULL           | 更新时间         |
     | deleted        | TINYINT      | 否   | 0              | 逻辑删除标记     |
     | deleted_at     | DATETIME     | 是   | NULL           | 删除时间         |
     | deleted_by     | BIGINT       | 是   | NULL           | 删除人           |

    表 4.5.2.3-1 org_person表结构

+   索引设计。

    | 索引名              | 索引字段               | 类型 | 说明                               |
    | ------------------- | ---------------------- | ---- | ---------------------------------- |
    | uk_psn_tenant_empno | tenant_id, employee_no | 唯一 | 租户内工号唯一                     |
    | uk_psn_user         | user_id                | 唯一 | 用户关联唯一（NULL不参与唯一约束） |
    | idx_psn_name        | name                   | 普通 | 姓名查询                           |
    | idx_psn_status      | status                 | 普通 | 状态过滤                           |
    | idx_psn_source      | source                 | 普通 | 数据来源过滤                       |
    | idx_psn_external    | external_id            | 普通 | 外部ID查询                         |

    表 4.5.2.3-2 org_person索引设计

#### 4.5.2.4 org_appointment 任职表

+   任职表存储人员在组织单元担任岗位的记录。

     | 字段名      | 数据类型     | 可空 | 默认值         | 说明         |
     | ----------- | ------------ | ---- | -------------- | ------------ |
     | id          | BIGINT       | 否   | AUTO_INCREMENT | 主键         |
     | tenant_id   | BIGINT       | 否   | -              | 租户ID       |
     | person_id   | BIGINT       | 否   | -              | 人员ID       |
     | org_id      | BIGINT       | 否   | -              | 组织单元ID   |
     | position_id | BIGINT       | 否   | -              | 岗位ID       |
     | type        | VARCHAR(32)  | 否   | 'PRIMARY'      | 任职类型     |
     | start_date  | DATE         | 否   | -              | 开始日期     |
     | end_date    | DATE         | 是   | NULL           | 结束日期     |
     | status      | VARCHAR(32)  | 否   | 'ACTIVE'       | 状态         |
     | source      | VARCHAR(32)  | 否   | 'LOCAL'        | 数据来源     |
     | external_id | VARCHAR(128) | 是   | NULL           | 外部系统ID   |
     | created_by  | BIGINT       | 否   | -              | 创建人       |
     | created_at  | DATETIME     | 否   | NOW()          | 创建时间     |
     | updated_by  | BIGINT       | 是   | NULL           | 更新人       |
     | updated_at  | DATETIME     | 是   | NULL           | 更新时间     |
     | deleted     | TINYINT      | 否   | 0              | 逻辑删除标记 |
     | deleted_at  | DATETIME     | 是   | NULL           | 删除时间     |
     | deleted_by  | BIGINT       | 是   | NULL           | 删除人       |

    表 4.5.2.4-1 org_appointment表结构

+   索引设计。

    | 索引名              | 索引字段             | 类型 | 说明              |
    | ------------------- | -------------------- | ---- | ----------------- |
    | idx_apt_person      | person_id            | 普通 | 人员任职查询      |
    | idx_apt_org         | org_id               | 普通 | 组织任职查询      |
    | idx_apt_position    | position_id          | 普通 | 岗位任职查询      |
    | idx_apt_type_status | type, status         | 普通 | 主职查询          |
    | idx_apt_source      | source               | 普通 | 数据来源过滤      |
    | idx_apt_external    | external_id          | 普通 | 外部ID查询        |
    | idx_apt_tenant      | tenant_id, person_id | 普通 | 租户+人员复合查询 |

    表 4.5.2.4-2 org_appointment索引设计

#### 4.5.2.5 org_sync_task 同步任务表

+   同步任务表记录每次同步任务的执行情况。

     | 字段名        | 数据类型    | 可空 | 默认值         | 说明                         |
     | ------------- | ----------- | ---- | -------------- | ---------------------------- |
     | id            | BIGINT      | 否   | AUTO_INCREMENT | 主键                         |
     | tenant_id     | BIGINT      | 否   | -              | 租户ID                       |
     | type          | VARCHAR(32) | 否   | -              | 同步类型，FULL/INCREMENTAL   |
     | source_type   | VARCHAR(32) | 否   | -              | 数据源类型，SCIM/LDAP/HR_API |
     | status        | VARCHAR(32) | 否   | 'PENDING'      | 状态                         |
     | started_at    | DATETIME    | 是   | NULL           | 开始时间                     |
     | finished_at   | DATETIME    | 是   | NULL           | 结束时间                     |
     | total_count   | INT         | 否   | 0              | 总记录数                     |
     | success_count | INT         | 否   | 0              | 成功数                       |
     | fail_count    | INT         | 否   | 0              | 失败数                       |
     | skip_count    | INT         | 否   | 0              | 跳过数                       |
     | error_message | TEXT        | 是   | NULL           | 错误信息                     |
     | triggered_by  | BIGINT      | 否   | -              | 触发人ID                     |
     | created_at    | DATETIME    | 否   | NOW()          | 创建时间                     |

    表 4.5.2.5-1 org_sync_task表结构

+   索引设计。

    | 索引名               | 索引字段   | 类型 | 说明     |
    | -------------------- | ---------- | ---- | -------- |
    | idx_sync_task_tenant | tenant_id  | 普通 | 租户过滤 |
    | idx_sync_task_status | status     | 普通 | 状态过滤 |
    | idx_sync_task_time   | started_at | 普通 | 时间查询 |

    表 4.5.2.5-2 org_sync_task索引设计

#### 4.5.2.6 org_sync_exception 同步异常表

+   同步异常表记录同步过程中的异常数据。

     | 字段名        | 数据类型     | 可空 | 默认值         | 说明       |
     | ------------- | ------------ | ---- | -------------- | ---------- |
     | id            | BIGINT       | 否   | AUTO_INCREMENT | 主键       |
     | tenant_id     | BIGINT       | 否   | -              | 租户ID     |
     | task_id       | BIGINT       | 否   | -              | 同步任务ID |
     | level         | VARCHAR(16)  | 否   | -              | 异常级别   |
     | type          | VARCHAR(64)  | 否   | -              | 异常类型   |
     | data_type     | VARCHAR(32)  | 否   | -              | 数据类型   |
     | external_id   | VARCHAR(128) | 是   | NULL           | 外部系统ID |
     | error_code    | VARCHAR(64)  | 是   | NULL           | 错误码     |
     | error_message | VARCHAR(512) | 否   | -              | 错误信息   |
     | raw_data      | TEXT         | 是   | NULL           | 原始数据   |
     | handled       | TINYINT      | 否   | 0              | 是否已处理 |
     | handled_by    | BIGINT       | 是   | NULL           | 处理人     |
     | handled_at    | DATETIME     | 是   | NULL           | 处理时间   |
     | handle_result | VARCHAR(256) | 是   | NULL           | 处理结果   |
     | created_at    | DATETIME     | 否   | NOW()          | 创建时间   |

    表 4.5.2.6-1 org_sync_exception表结构

+   索引设计。

    | 索引名               | 索引字段   | 类型 | 说明         |
    | -------------------- | ---------- | ---- | ------------ |
    | idx_sync_exc_tenant  | tenant_id  | 普通 | 租户过滤     |
    | idx_sync_exc_task    | task_id    | 普通 | 任务过滤     |
    | idx_sync_exc_level   | level      | 普通 | 级别过滤     |
    | idx_sync_exc_handled | handled    | 普通 | 处理状态过滤 |
    | idx_sync_exc_time    | created_at | 普通 | 时间查询     |

    表 4.5.2.6-2 org_sync_exception索引设计

### 4.5.3 表关系图

+   组织管理表之间的关系如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          组织管理数据模型                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────────────┐          ┌─────────────────────┐                 │
    │    │  org_organization   │          │    org_position     │                 │
    │    ├─────────────────────┤          ├─────────────────────┤                 │
    │    │ PK id               │          │ PK id               │                 │
    │    │    tenant_id        │          │    tenant_id        │                 │
    │    │    code             │          │    code             │                 │
    │    │    name             │          │    name             │                 │
    │    │ FK parent_id ───────┼─┐        │    category         │                 │
    │    │    path             │ │        │    source           │                 │
    │    │    source           │ │        └──────────┬──────────┘                 │
    │    └─────────┬───────────┘ │                   │                            │
    │              │             │                   │                            │
    │              │ 自关联      │                   │                            │
    │              ├─────────────┘                   │                            │
    │              │                                 │                            │
    │              │ org_id                          │ position_id                │
    │              │                                 │                            │
    │              └────────────────┬────────────────┘                            │
    │                               │                                             │
    │                               ▼                                             │
    │                  ┌─────────────────────┐                                    │
    │                  │   org_appointment   │                                    │
    │                  ├─────────────────────┤                                    │
    │                  │ PK id               │                                    │
    │                  │    tenant_id        │                                    │
    │                  │ FK person_id ───────┼───────────┐                        │
    │                  │ FK org_id           │           │                        │
    │                  │ FK position_id      │           │                        │
    │                  │    type             │           │                        │
    │                  │    start_date       │           │                        │
    │                  │    source           │           │                        │
    │                  └─────────────────────┘           │                        │
    │                                                    │                        │
    │                                                    ▼                        │
    │                                       ┌─────────────────────┐               │
    │                                       │     org_person      │               │
    │                                       ├─────────────────────┤               │
    │                                       │ PK id               │               │
    │                                       │    tenant_id        │               │
    │                                       │    employee_no      │               │
    │                                       │    name             │               │
    │                                       │ FK user_id ─────────┼──┐            │
    │                                       │    source           │  │            │
    │                                       └─────────────────────┘  │            │
    │                                                                │            │
    │    ┌─────────────────────┐                                     │            │
    │    │    ur_user          │◄────────────────────────────────────┘            │
    │    │   (用户管理领域)    │                                                  │
    │    └─────────────────────┘                                                  │
    │                                                                             │
    │    ┌─────────────────────┐          ┌─────────────────────┐                 │
    │    │   org_sync_task     │          │  org_sync_exception │                 │
    │    ├─────────────────────┤          ├─────────────────────┤                 │
    │    │ PK id               │◄─────────│ FK task_id          │                 │
    │    │    tenant_id        │          │ PK id               │                 │
    │    │    type             │          │    tenant_id        │                 │
    │    │    status           │          │    level            │                 │
    │    │    started_at       │          │    type             │                 │
    │    └─────────────────────┘          └─────────────────────┘                 │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.5.3-1 组织管理表关系图

### 4.5.4 数据字典

#### 4.5.4.1 组织类型（org_type）

+   组织类型枚举值定义如下。

    | 枚举值  | 说明     |
    | ------- | -------- |
    | COMPANY | 公司     |
    | BRANCH  | 分公司   |
    | DEPT    | 部门     |
    | TEAM    | 团队     |
    | VIRTUAL | 虚拟组织 |

    表 4.5.4.1-1 组织类型枚举

#### 4.5.4.2 组织状态（org_status）

+   组织状态枚举值定义如下。

    | 枚举值   | 说明   |
    | -------- | ------ |
    | ACTIVE   | 正常   |
    | DISABLED | 停用   |
    | DELETED  | 已删除 |

    表 4.5.4.2-1 组织状态枚举

#### 4.5.4.3 数据来源（data_source）

+   数据来源枚举值定义如下。

    | 枚举值   | 说明             |
    | -------- | ---------------- |
    | LOCAL    | 本地创建，可编辑 |
    | EXTERNAL | 外部源同步，只读 |

    表 4.5.4.3-1 数据来源枚举

#### 4.5.4.4 岗位状态（position_status）

+   岗位状态枚举值定义如下。

    | 枚举值   | 说明   |
    | -------- | ------ |
    | ACTIVE   | 启用   |
    | DISABLED | 停用   |
    | DELETED  | 已删除 |

    表 4.5.4.4-1 岗位状态枚举

#### 4.5.4.5 人员状态（person_status）

+   人员状态枚举值定义如下。

    | 枚举值   | 说明   |
    | -------- | ------ |
    | ACTIVE   | 在职   |
    | RESIGNED | 离职   |
    | DELETED  | 已删除 |

    表 4.5.4.5-1 人员状态枚举

#### 4.5.4.6 性别（gender）

+   性别枚举值定义如下。

    | 枚举值  | 说明 |
    | ------- | ---- |
    | MALE    | 男   |
    | FEMALE  | 女   |
    | UNKNOWN | 未知 |

    表 4.5.4.6-1 性别枚举

#### 4.5.4.7 用户关联类型（bind_type）

+   用户关联类型枚举值定义如下。

    | 枚举值 | 说明                   |
    | ------ | ---------------------- |
    | AUTO   | 自动关联（同步时创建） |
    | MANUAL | 手动关联               |

    表 4.5.4.7-1 用户关联类型枚举

#### 4.5.4.8 任职类型（appointment_type）

+   任职类型枚举值定义如下。

    | 枚举值   | 说明 |
    | -------- | ---- |
    | PRIMARY  | 主职 |
    | PARTTIME | 兼职 |
    | ACTING   | 代理 |

    表 4.5.4.8-1 任职类型枚举

#### 4.5.4.9 任职状态（appointment_status）

+   任职状态枚举值定义如下。

    | 枚举值     | 说明   |
    | ---------- | ------ |
    | ACTIVE     | 在职   |
    | TERMINATED | 已终止 |

    表 4.5.4.9-1 任职状态枚举

#### 4.5.4.10 同步任务类型（sync_type）

+   同步任务类型枚举值定义如下。

    | 枚举值      | 说明     |
    | ----------- | -------- |
    | FULL        | 全量同步 |
    | INCREMENTAL | 增量同步 |

    表 4.5.4.10-1 同步任务类型枚举

#### 4.5.4.11 同步任务状态（sync_status）

+   同步任务状态枚举值定义如下。

    | 枚举值    | 说明   |
    | --------- | ------ |
    | PENDING   | 待执行 |
    | RUNNING   | 执行中 |
    | SUCCESS   | 成功   |
    | FAILED    | 失败   |
    | CANCELLED | 已取消 |

    表 4.5.4.11-1 同步任务状态枚举

#### 4.5.4.12 同步异常级别（exception_level）

+   同步异常级别枚举值定义如下。

    | 枚举值 | 说明 |
    | ------ | ---- |
    | SEVERE | 严重 |
    | NORMAL | 一般 |
    | MINOR  | 轻微 |

    表 4.5.4.12-1 同步异常级别枚举

#### 4.5.4.13 同步异常类型（exception_type）

+   同步异常类型枚举值定义如下。

    | 枚举值              | 说明         |
    | ------------------- | ------------ |
    | CONNECTION_FAILED   | 连接失败     |
    | AUTH_FAILED         | 认证失败     |
    | DATA_FORMAT_ERROR   | 数据格式错误 |
    | FIELD_MISSING       | 必填字段缺失 |
    | HIERARCHY_VIOLATION | 层级规则违规 |
    | CODE_CONFLICT       | 编码冲突     |
    | USER_CREATE_FAILED  | 账号创建失败 |

    表 4.5.4.13-1 同步异常类型枚举

### 4.5.5 数据迁移与初始化

#### 4.5.5.1 租户库初始化

+   新租户开通时，组织管理相关表由BC-10租户IAM初始化接口统一创建（参见第1章1.1节租户开通协作流程第5步）。
+   创建以下表结构：

    | 序号 | 表名               | 初始化数据     |
    | ---- | ------------------ | -------------- |
    | 1    | org_organization   | 创建根组织节点 |
    | 2    | org_position       | 无预置数据     |
    | 3    | org_person         | 无预置数据     |
    | 4    | org_appointment    | 无预置数据     |
    | 5    | org_sync_task      | 无预置数据     |
    | 6    | org_sync_exception | 无预置数据     |

    表 4.5.5.1-1 租户库组织管理表初始化

+   根组织节点初始数据：

    | 列名      | 值         |
    | --------- | ---------- |
    | id        | 系统生成   |
    | code      | ROOT       |
    | name      | {租户名称} |
    | type      | COMPANY    |
    | parent_id | NULL       |
    | path      | /{id}      |
    | level     | 1          |
    | status    | ACTIVE     |
    | source    | LOCAL      |

    表 4.5.5.1-2 根组织节点初始数据

#### 4.5.5.2 数据清理策略

+   组织管理数据清理策略如下：

    | 数据类型     | 清理条件                           | 清理方式 |
    | ------------ | ---------------------------------- | -------- |
    | 已删除组织   | deleted_at超过1年                  | 可归档   |
    | 已删除岗位   | deleted_at超过1年                  | 可归档   |
    | 已删除人员   | deleted_at超过1年且无关联任职      | 可归档   |
    | 已终止任职   | status=TERMINATED且end_date超过2年 | 可归档   |
    | 同步任务记录 | finished_at超过6个月               | 物理删除 |
    | 同步异常记录 | handled=1且created_at超过3个月     | 物理删除 |

    表 4.5.5.2-1 数据清理策略

+   **清理注意事项**：
    -   归档操作应在业务低峰期执行
    -   清理前需确认无其他表引用被清理数据
    -   同步相关记录清理不受逻辑删除影响，直接物理删除

## 4.6 前端设计

+   本节设计组织管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   组织管理前端位于租户管理后台，以树形结构展示和列表管理为主，仅租户管理员可访问。

### 4.6.1 页面总览

+   组织管理前端页面清单如下表所示。

    | 页面编号      | 页面名称     | 用户群 | 路由路径                    | 说明                   |
    | ------------- | ------------ | ------ | --------------------------- | ---------------------- |
    | PG-UR-ORG-01  | 组织架构管理 | ur     | /tenant/org/structure       | 组织树形结构管理       |
    | PG-UR-ORG-02  | 组织单元详情 | ur     | /tenant/org/structure/:id   | 查看和编辑组织单元     |
    | PG-UR-POS-01  | 岗位管理     | ur     | /tenant/org/position        | 岗位列表管理           |
    | PG-UR-POS-02  | 岗位详情     | ur     | /tenant/org/position/:id    | 查看和编辑岗位         |
    | PG-UR-PSN-01  | 人员管理     | ur     | /tenant/org/person          | 人员列表管理           |
    | PG-UR-PSN-02  | 人员详情     | ur     | /tenant/org/person/:id      | 查看和编辑人员及任职   |
    | PG-UR-APT-01  | 任职管理     | ur     | /tenant/org/appointment     | 任职列表管理           |
    | PG-UR-SYNC-01 | 同步管理     | ur     | /tenant/org/sync            | 同步配置与状态监控     |
    | PG-UR-SYNC-02 | 同步异常处理 | ur     | /tenant/org/sync/exceptions | 同步异常数据查看与处理 |

    表 4.6.1-1 组织管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────┐
    │                      租户管理后台导航                            │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │    组织管理                                                      │
    │    ├── 组织架构                                                  │
    │    │   └── [PG-UR-ORG-01] 组织架构管理                           │
    │    │       └── [PG-UR-ORG-02] 组织单元详情                       │
    │    ├── 岗位管理                                                  │
    │    │   └── [PG-UR-POS-01] 岗位管理                               │
    │    │       └── [PG-UR-POS-02] 岗位详情                           │
    │    ├── 人员管理                                                  │
    │    │   └── [PG-UR-PSN-01] 人员管理                               │
    │    │       └── [PG-UR-PSN-02] 人员详情                           │
    │    ├── 任职管理                                                  │
    │    │   └── [PG-UR-APT-01] 任职管理                               │
    │    └── 数据同步                                                  │
    │        ├── [PG-UR-SYNC-01] 同步管理                              │
    │        └── [PG-UR-SYNC-02] 同步异常处理                          │
    │                                                                  │
    └──────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.1-1 组织管理页面导航结构

### 4.6.2 组织架构

#### 4.6.2.1 PG-UR-ORG-01 组织架构管理

+   页面说明：
    -   用途：管理租户的组织树形结构，支持查看、新建、编辑、移动、删除组织单元
    -   入口：租户管理后台 → 组织管理 → 组织架构
    -   权限：ur:iam:org:list（查看），ur:iam:org:create（新建），ur:iam:org:update（编辑/移动），ur:iam:org:delete（删除）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  组织架构管理                                    [+ 新建组织]        │
    ├─────────────────────────┬────────────────────────────────────────────┤
    │                         │                                            │
    │  搜索: [____________]   │  组织单元信息                              │
    │                         │  ┌──────────────────────────────────────┐  │
    │  ▼ □ XX科技有限公司 [E] │  │ 编码: ORG-001                        │  │
    │    ├─ □ 北京总部 [E]    │  │ 名称: 北京总部                       │  │
    │    │  ├─ □ 研发部 [E]   │  │ 类型: 分公司                         │  │
    │    │  │  ├─ □ 前端组[E] │  │ 上级: XX科技有限公司                 │  │
    │    │  │  ├─ □ 后端组[E] │  │ 来源: EXTERNAL (外部源)              │  │
    │    │  │  └─ □ 创新实验  │  │ 状态: 正常                           │  │
    │    │  │      室 [L]     │  │ 子组织: 3                            │  │
    │    │  ├─ □ 市场部 [E]   │  │ 在职人员: 25                         │  │
    │    │  └─ □ 财务部 [E]   │  │                                      │  │
    │    ├─ □ 上海分公司 [E]  │  │ [编辑] [移动] [删除]                 │  │
    │    └─ □ 深圳分公司 [E]  │  │ (外部源组织操作按钮禁用)             │  │
    │                         │  └──────────────────────────────────────┘  │
    │  [E]=外部源 [L]=本地    │                                            │
    │                         │  下级组织                                  │
    │  ────────────────────── │  ┌──────┬──────┬──────┬──────┬──────┐      │
    │  统计                   │  │ 编码 │ 名称 │ 类型 │ 来源 │ 人数 │      │
    │  组织总数: 15           │  ├──────┼──────┼──────┼──────┼──────┤      │
    │  外部源: 12             │  │ ...  │ 研发 │ 部门 │ [E]  │ 15   │      │
    │  本地: 3                │  │ ...  │ 市场 │ 部门 │ [E]  │ 8    │      │
    │                         │  │ ...  │ 财务 │ 部门 │ [E]  │ 5    │      │
    │                         │  └──────┴──────┴──────┴──────┴──────┘      │
    │                         │                                            │
    └─────────────────────────┴────────────────────────────────────────────┘
    ```

    图 4.6.2.1-1 组织架构管理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                       | 关联API   | 前置条件                       |
    | -------- | -------- | ------------ | ------------------------------------------ | --------- | ------------------------------ |
    | F01      | 展示     | 加载组织树   | 进入页面加载完整组织架构树形结构           | UR-ORG-06 | ur:iam:org:list                |
    | F02      | 操作     | 搜索组织     | 按编码或名称搜索，定位到目标节点           | UR-ORG-06 | ur:iam:org:list                |
    | F03      | 操作     | 新建组织     | 创建本地组织单元，默认上级为当前选中节点   | UR-ORG-01 | ur:iam:org:create              |
    | F04      | 展示     | 查看详情     | 点击组织节点，右侧显示该组织的详细信息     | UR-ORG-05 | ur:iam:org:detail              |
    | F05      | 操作     | 编辑组织     | 修改组织信息，仅LOCAL来源组织可操作        | UR-ORG-02 | ur:iam:org:update，仅LOCAL来源 |
    | F06      | 操作     | 移动组织     | 拖拽或选择方式移动组织到新上级             | UR-ORG-03 | ur:iam:org:update，仅LOCAL来源 |
    | F07      | 操作     | 删除组织     | 删除组织单元，需无子组织且无在职人员       | UR-ORG-04 | ur:iam:org:delete，仅LOCAL来源 |
    | F08      | 操作     | 展开/折叠    | 控制树节点的展开折叠状态                   | -         | -                              |
    | F09      | 展示     | 查看下级     | 右侧详情区展示选中节点的下级组织列表       | UR-ORG-08 | ur:iam:org:list                |
    | F10      | 展示     | 统计信息展示 | 左侧底部展示组织总数、外部源数量、本地数量 | UR-ORG-06 | ur:iam:org:list                |

    表 4.6.2.1-1 组织架构管理功能说明

+   搜索条件：

    | 字段名 | 组件类型 | 数据来源 | 默认值 | 说明                   |
    | ------ | -------- | -------- | ------ | ---------------------- |
    | 关键词 | Input    | 用户输入 | 空     | 模糊匹配组织编码或名称 |

    表 4.6.2.1-2 组织架构管理搜索条件

+   交互规则：
    -   树节点显示组织名称，右侧标记来源标识（[E]=外部源，[L]=本地）
    -   选中节点时高亮显示，右侧展示详情面板
    -   LOCAL来源节点显示操作按钮，EXTERNAL来源节点操作按钮禁用
    -   支持拖拽移动LOCAL节点（可选功能）
    -   新建组织时，默认上级为当前选中节点
    -   删除前二次确认，提示影响范围（下级组织数、在职人员数）

#### 4.6.2.2 PG-UR-ORG-02 组织单元详情

+   页面说明：
    -   用途：查看和编辑组织单元的完整信息
    -   入口：组织架构管理页面 → 点击组织节点 → 进入详情页
    -   权限：ur:iam:org:detail（查看），ur:iam:org:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  ← 返回组织架构    组织单元详情                  [编辑] [保存]       │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  基本信息                                                            │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 组织编码: ORG-001               组织名称: 北京总部           │    │
    │  │ 组织类型: 分公司                 上级组织: XX科技有限公司    │    │
    │  │ 数据来源: EXTERNAL              组织状态: 正常               │    │
    │  │ 排序号:   1                      创建时间: 2024-01-01        │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  下级组织                                                            │
    │  ┌────────┬──────────────┬──────────┬──────────┬──────┐              │
    │  │ 编码   │ 名称         │ 类型     │ 来源     │ 人数 │              │
    │  ├────────┼──────────────┼──────────┼──────────┼──────┤              │
    │  │ORG-010 │ 研发部       │ 部门     │ [E]      │ 15   │              │
    │  │ORG-011 │ 市场部       │ 部门     │ [E]      │ 8    │              │
    │  │ORG-012 │ 财务部       │ 部门     │ [E]      │ 5    │              │
    │  └────────┴──────────────┴──────────┴──────────┴──────┘              │
    │                                                                      │
    │  在职人员                                                            │
    │  ┌────────┬──────────┬──────────┬──────────┬──────┐                  │
    │  │ 工号   │ 姓名     │ 岗位     │ 任职类型 │ 来源 │                  │
    │  ├────────┼──────────┼──────────┼──────────┼──────┤                  │
    │  │ E001   │ 张三     │ 高级开发 │ 主职     │ [E]  │                  │
    │  │ E002   │ 李四     │ 产品经理 │ 主职     │ [E]  │                  │
    │  │ ...    │ ...      │ ...      │ ...      │ ...  │                  │
    │  └────────┴──────────┴──────────┴──────────┴──────┘                  │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.2.2-1 组织单元详情线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                             | 关联API   | 前置条件                       |
    | -------- | -------- | ------------ | -------------------------------- | --------- | ------------------------------ |
    | F01      | 展示     | 加载详情     | 进入页面加载组织单元完整信息     | UR-ORG-05 | ur:iam:org:detail              |
    | F02      | 操作     | 编辑信息     | 编辑组织名称、类型、排序号等字段 | UR-ORG-02 | ur:iam:org:update，仅LOCAL来源 |
    | F03      | 展示     | 查看下级组织 | 列表展示该组织的直接下级组织     | UR-ORG-08 | ur:iam:org:list                |
    | F04      | 展示     | 查看在职人员 | 列表展示该组织下的在职人员       | UR-PSN-08 | ur:iam:person:list             |
    | F05      | 操作     | 返回         | 返回组织架构管理页面             | -         | -                              |

    表 4.6.2.2-1 组织单元详情功能说明

### 4.6.3 岗位管理

#### 4.6.3.1 PG-UR-POS-01 岗位管理

+   页面说明：
    -   用途：管理租户级岗位定义，支持查看、新建、编辑、启用/停用、删除岗位
    -   入口：租户管理后台 → 组织管理 → 岗位管理
    -   权限：ur:iam:position:list（查看），ur:iam:position:create（新建），ur:iam:position:update（编辑/启停），ur:iam:position:delete（删除）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  岗位管理                                        [+ 新建岗位]        │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  搜索: [____________]  类别: [全部 ▼]  来源: [全部 ▼]                │
    │  状态: [全部 ▼]                                    [搜索] [重置]     │
    │                                                                      │
    │  ┌────────┬──────────────┬────────┬──────────┬──────┬──────┬─────┐   │
    │  │ 编码   │ 名称         │ 类别   │ 来源     │ 状态 │ 人数 │操作 │   │
    │  ├────────┼──────────────┼────────┼──────────┼──────┼──────┼─────┤   │
    │  │POS-001 │ 高级开发工程 │ 技术类 │ [E]外部源│ 启用 │ 12   │查看 │   │
    │  │POS-002 │ 产品经理     │ 产品类 │ [E]外部源│ 启用 │ 5    │查看 │   │
    │  │POS-003 │ 测试工程师   │ 技术类 │ [L]本地  │ 启用 │ 8    │编辑 │   │
    │  │POS-004 │ UI设计师     │ 设计类 │ [L]本地  │ 停用 │ 0    │编辑 │   │
    │  │ ...    │ ...          │ ...    │ ...      │ ...  │ ...  │ ... │   │
    │  └────────┴──────────────┴────────┴──────────┴──────┴──────┴─────┘   │
    │                                                                      │
    │  共 25 条记录                                  [< 1 2 3 ... 5 >]     │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.3.1-1 岗位管理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称  | 说明                                | 关联API   | 前置条件                            |
    | -------- | -------- | --------- | ----------------------------------- | --------- | ----------------------------------- |
    | F01      | 展示     | 加载列表  | 进入页面加载岗位分页列表            | UR-POS-06 | ur:iam:position:list                |
    | F02      | 操作     | 搜索      | 按编码或名称模糊查询岗位列表        | UR-POS-06 | ur:iam:position:list                |
    | F03      | 操作     | 重置      | 清空搜索条件，恢复默认列表          | -         | -                                   |
    | F04      | 操作     | 筛选      | 按类别、来源、状态筛选岗位          | UR-POS-06 | ur:iam:position:list                |
    | F05      | 操作     | 新建岗位  | 打开新建表单，创建本地岗位          | UR-POS-01 | ur:iam:position:create              |
    | F06      | 操作     | 编辑岗位  | 修改岗位信息，仅LOCAL来源岗位可操作 | UR-POS-02 | ur:iam:position:update，仅LOCAL来源 |
    | F07      | 操作     | 启用/停用 | 变更岗位状态，仅LOCAL来源岗位可操作 | UR-POS-03 | ur:iam:position:update，仅LOCAL来源 |
    | F08      | 操作     | 删除岗位  | 删除岗位，需无在职人员且为LOCAL来源 | UR-POS-04 | ur:iam:position:delete，仅LOCAL来源 |
    | F09      | 操作     | 查看详情  | 跳转岗位详情页                      | -         | ur:iam:position:detail              |

    表 4.6.3.1-1 岗位管理功能说明

+   搜索条件：

    | 字段名 | 组件类型 | 数据来源 | 默认值 | 说明                     |
    | ------ | -------- | -------- | ------ | ------------------------ |
    | 搜索   | Input    | 用户输入 | 空     | 模糊匹配岗位编码或名称   |
    | 类别   | Select   | 字典     | 全部   | 岗位类别枚举             |
    | 来源   | Select   | 字典     | 全部   | 枚举值：全部/外部源/本地 |
    | 状态   | Select   | 字典     | 全部   | 枚举值：全部/启用/停用   |

    表 4.6.3.1-2 岗位管理搜索条件

+   列表字段：

    | 字段名 | 列宽 | 对齐 | 是否排序 | 说明                                          |
    | ------ | ---- | ---- | -------- | --------------------------------------------- |
    | 编码   | 120  | 左   | 是       | 岗位编码                                      |
    | 名称   | auto | 左   | 是       | 岗位名称                                      |
    | 类别   | 100  | 左   | 是       | 岗位类别                                      |
    | 来源   | 100  | 中   | 是       | 标签展示，引用来源标签表                      |
    | 状态   | 80   | 中   | 是       | 标签展示，引用状态标签表                      |
    | 人数   | 80   | 右   | 是       | 该岗位在职人员数                              |
    | 操作   | 120  | 中   | 否       | LOCAL来源：编辑/启停/删除；EXTERNAL来源：查看 |

    表 4.6.3.1-3 岗位管理列表字段

+   状态/标签展示：

    | 枚举值   | 标签文本 | 颜色 |
    | -------- | -------- | ---- |
    | EXTERNAL | 外部源   | 蓝色 |
    | LOCAL    | 本地     | 绿色 |
    | 启用     | 启用     | 绿色 |
    | 停用     | 停用     | 灰色 |

    表 4.6.3.1-4 岗位管理状态标签

#### 4.6.3.2 PG-UR-POS-02 岗位详情

+   页面说明：
    -   用途：查看和编辑岗位的完整信息，展示该岗位下的在职人员
    -   入口：岗位管理页面 → 点击岗位行操作列"查看/编辑"
    -   权限：ur:iam:position:detail（查看），ur:iam:position:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  ← 返回岗位管理    岗位详情                      [编辑] [保存]       │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  基本信息                                                            │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 岗位编码: POS-001              岗位名称: 高级开发工程师      │    │
    │  │ 岗位类别: 技术类               岗位等级: P7                  │    │
    │  │ 数据来源: EXTERNAL             岗位状态: 启用                │    │
    │  │ 创建时间: 2024-01-01           更新时间: 2024-06-15          │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  在职人员                                                            │
    │  ┌────────┬──────────┬──────────────┬──────────┬──────┐              │
    │  │ 工号   │ 姓名     │ 所属组织     │ 任职类型 │ 来源 │              │
    │  ├────────┼──────────┼──────────────┼──────────┼──────┤              │
    │  │ E001   │ 张三     │ 研发部       │ 主职     │ [E]  │              │
    │  │ E005   │ 周八     │ 前端组       │ 主职     │ [E]  │              │
    │  │ ...    │ ...      │ ...          │ ...      │ ...  │              │
    │  └────────┴──────────┴──────────────┴──────────┴──────┘              │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.3.2-1 岗位详情线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                           | 关联API   | 前置条件                            |
    | -------- | -------- | ------------ | ------------------------------ | --------- | ----------------------------------- |
    | F01      | 展示     | 加载详情     | 进入页面加载岗位完整信息       | UR-POS-05 | ur:iam:position:detail              |
    | F02      | 操作     | 编辑信息     | 编辑岗位名称、类别、等级等字段 | UR-POS-02 | ur:iam:position:update，仅LOCAL来源 |
    | F03      | 展示     | 查看在职人员 | 列表展示该岗位下的在职人员     | UR-PSN-08 | ur:iam:person:list                  |
    | F04      | 操作     | 返回         | 返回岗位管理页面               | -         | -                                   |

    表 4.6.3.2-1 岗位详情功能说明

### 4.6.4 人员管理

#### 4.6.4.1 PG-UR-PSN-01 人员管理

+   页面说明：
    -   用途：管理组织中的人员，支持按组织树筛选、搜索、新建、批量导入
    -   入口：租户管理后台 → 组织管理 → 人员管理
    -   权限：ur:iam:person:list（查看），ur:iam:person:create（新建/导入），ur:iam:person:update（编辑/离职）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │  人员管理                                    [批量导入] [+ 新建人员]     │
    ├─────────────────────────┬────────────────────────────────────────────────┤
    │                         │                                                │
    │  组织筛选               │  搜索: [____________]  来源: [全部 ▼]          │
    │  ▼ □ 全部组织           │  状态: [全部 ▼]  账号: [全部 ▼]                │
    │    ├─ □ 北京总部        │                              [搜索] [重置]     │
    │    │  ├─ □ 研发部       │                                                │
    │    │  ├─ □ 市场部       │  ┌──────┬──────┬────────┬────────┬────┬─────┐  │
    │    │  └─ □ 财务部       │  │ 工号 │ 姓名 │主职部门│主职岗位│来源│状态 │  │
    │    ├─ □ 上海分公司      │  ├──────┼──────┼────────┼────────┼────┼─────┤  │
    │    └─ □ 深圳分公司      │  │E001  │ 张三 │ 研发部 │高级开发│[E] │在职 │  │
    │                         │  │E002  │ 李四 │ 研发部 │产品经理│[E] │在职 │  │
    │  已选: 研发部           │  │L003  │ 王五 │ 创新实 │开发工程│[L] │在职 │  │
    │                         │  │E004  │ 赵六 │ 市场部 │市场专员│[E] │离职 │  │
    │                         │  │ ...  │ ...  │ ...    │ ...    │... │ ... │  │
    │                         │  └──────┴──────┴────────┴────────┴────┴─────┘  │
    │                         │                                                │
    │                         │  共 156 条记录              [< 1 2 3 >]        │
    │                         │                                                │
    └─────────────────────────┴────────────────────────────────────────────────┘
    ```

    图 4.6.4.1-1 人员管理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称   | 说明                                           | 关联API   | 前置条件             |
    | -------- | -------- | ---------- | ---------------------------------------------- | --------- | -------------------- |
    | F01      | 展示     | 加载列表   | 进入页面加载人员分页列表                       | UR-PSN-08 | ur:iam:person:list   |
    | F02      | 展示     | 加载组织树 | 加载左侧组织筛选树                             | UR-ORG-06 | ur:iam:org:list      |
    | F03      | 操作     | 搜索       | 按工号或姓名模糊查询人员列表                   | UR-PSN-08 | ur:iam:person:list   |
    | F04      | 操作     | 重置       | 清空搜索条件，恢复默认列表                     | -         | -                    |
    | F05      | 操作     | 组织筛选   | 左侧组织树快速筛选某组织下的人员               | UR-PSN-08 | ur:iam:person:list   |
    | F06      | 操作     | 条件筛选   | 按来源、状态、是否有账号筛选                   | UR-PSN-08 | ur:iam:person:list   |
    | F07      | 操作     | 新建人员   | 打开新建表单，创建本地人员，可选创建账号和任职 | UR-PSN-01 | ur:iam:person:create |
    | F08      | 操作     | 批量导入   | 通过Excel模板批量导入人员                      | UR-PSN-01 | ur:iam:person:create |
    | F09      | 操作     | 查看详情   | 点击人员行，跳转人员详情页                     | -         | ur:iam:person:detail |

    表 4.6.4.1-1 人员管理功能说明

+   搜索条件：

    | 字段名   | 组件类型   | 数据来源 | 默认值 | 说明                           |
    | -------- | ---------- | -------- | ------ | ------------------------------ |
    | 搜索     | Input      | 用户输入 | 空     | 模糊匹配工号或姓名             |
    | 组织筛选 | TreeSelect | 接口     | 全部   | 数据来源：UR-ORG-06 组织树接口 |
    | 来源     | Select     | 字典     | 全部   | 枚举值：全部/外部源/本地       |
    | 状态     | Select     | 字典     | 全部   | 枚举值：全部/在职/离职         |
    | 账号     | Select     | 字典     | 全部   | 枚举值：全部/已关联/未关联     |

    表 4.6.4.1-2 人员管理搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                       |
    | -------- | ---- | ---- | -------- | -------------------------- |
    | 工号     | 100  | 左   | 是       | 人员工号                   |
    | 姓名     | 100  | 左   | 是       | 人员姓名，可点击跳转详情页 |
    | 主职部门 | auto | 左   | 否       | 主职任职所在组织单元名称   |
    | 主职岗位 | auto | 左   | 否       | 主职任职的岗位名称         |
    | 来源     | 80   | 中   | 是       | 标签展示，引用来源标签     |
    | 状态     | 80   | 中   | 是       | 标签展示，引用状态标签     |

    表 4.6.4.1-3 人员管理列表字段

+   状态/标签展示：

    | 枚举值   | 标签文本 | 颜色 |
    | -------- | -------- | ---- |
    | EXTERNAL | 外部源   | 蓝色 |
    | LOCAL    | 本地     | 绿色 |
    | 在职     | 在职     | 绿色 |
    | 离职     | 离职     | 灰色 |

    表 4.6.4.1-4 人员管理状态标签

#### 4.6.4.2 PG-UR-PSN-02 人员详情

+   页面说明：
    -   用途：展示人员完整信息，包括基本信息、账号信息、任职列表，支持编辑和任职管理
    -   入口：人员管理页面 → 点击人员姓名跳转
    -   权限：ur:iam:person:detail（查看），ur:iam:person:update（编辑/关联/离职），ur:iam:person:delete（删除），ur:iam:appointment:create（新增任职），ur:iam:appointment:update（调岗/终止/设主职）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  ← 返回人员管理    人员详情                [编辑] [离职] [删除]      │
    │  (外部源人员操作按钮禁用)                                            │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  基本信息                                                            │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 工号: E001           姓名: 张三            性别: 男          │    │
    │  │ 手机: 138****8888    邮箱: zhang***@xx.com  入职: 2020-01-15 │    │
    │  │ 状态: 在职           来源: EXTERNAL (外部源)                 │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  账号信息                                                            │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 关联用户: zhangsan@xx.com                                    │    │
    │  │ 关联时间: 2020-01-15 10:30:00                                │    │
    │  │ 关联类型: 自动关联                                           │    │
    │  │                                        [解除关联]            │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  任职信息                                           [+ 新增任职]     │
    │  ┌──────────┬────────────┬──────────┬──────────┬──────┬─────────┐    │
    │  │ 类型     │ 组织单元   │ 岗位     │ 开始日期 │ 状态 │ 操作    │    │
    │  ├──────────┼────────────┼──────────┼──────────┼──────┼─────────┤    │
    │  │ ★ 主职   │ 研发部     │ 高级开发 │2020-01-15│ 在职 │调岗 终止│    │
    │  │   兼职   │ 创新实验室 │ 技术顾问 │2023-06-01│ 在职 │设主职   │    │
    │  │   代理   │ 测试部     │ 测试经理 │2024-01-01│ 在职 │终止     │    │
    │  └──────────┴────────────┴──────────┴──────────┴──────┴─────────┘    │
    │  (外部源人员任职操作按钮禁用)                                        │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.4.2-1 人员详情线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                                         | 关联API   | 前置条件                               |
    | -------- | -------- | -------- | -------------------------------------------- | --------- | -------------------------------------- |
    | F01      | 展示     | 加载信息 | 进入页面加载人员基本信息、账号信息、任职列表 | UR-PSN-07 | ur:iam:person:detail                   |
    | F02      | 操作     | 编辑人员 | 修改人员基本信息                             | UR-PSN-02 | ur:iam:person:update，仅LOCAL来源      |
    | F03      | 操作     | 关联用户 | 为人员关联已有用户账号                       | UR-PSN-03 | ur:iam:person:update，仅LOCAL来源      |
    | F04      | 操作     | 解除关联 | 解除人员与用户的关联                         | UR-PSN-04 | ur:iam:person:update，仅LOCAL来源      |
    | F05      | 操作     | 离职处理 | 标记人员离职，同步处理关联账号               | UR-PSN-05 | ur:iam:person:update，仅LOCAL来源      |
    | F06      | 操作     | 删除人员 | 删除人员记录                                 | UR-PSN-09 | ur:iam:person:delete，仅LOCAL且已离职  |
    | F07      | 操作     | 新增任职 | 为人员创建新任职                             | UR-APT-01 | ur:iam:appointment:create，仅LOCAL来源 |
    | F08      | 操作     | 调岗     | 变更任职的组织或岗位                         | UR-APT-02 | ur:iam:appointment:update，仅LOCAL来源 |
    | F09      | 操作     | 终止任职 | 结束某项任职                                 | UR-APT-03 | ur:iam:appointment:update，仅LOCAL来源 |
    | F10      | 操作     | 设为主职 | 将兼职设为主职，原主职自动变为兼职           | UR-APT-04 | ur:iam:appointment:update，仅LOCAL来源 |
    | F11      | 操作     | 返回     | 返回人员管理页面                             | -         | -                                      |

    表 4.6.4.2-1 人员详情功能说明

+   交互规则：
    -   外部源人员（EXTERNAL来源）页面顶部操作按钮（编辑、离职、删除）禁用，并提示"外部源人员不可编辑"
    -   外部源人员任职列表的操作列按钮（调岗、终止、设主职、新增任职）禁用
    -   未关联用户时，账号信息区域显示"未关联"并提供"关联用户"按钮
    -   离职操作前二次确认，提示将终止所有在职任职
    -   删除操作前二次确认，仅已离职且为LOCAL来源的人员可删除

### 4.6.5 任职管理

#### 4.6.5.1 PG-UR-APT-01 任职管理

+   页面说明：
    -   用途：查看全部任职记录，支持按组织、岗位、类型、状态等条件筛选
    -   入口：租户管理后台 → 组织管理 → 任职管理
    -   权限：ur:iam:appointment:list（查看）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  任职管理                                                            │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  搜索: [____________]  组织: [全部 ▼]  岗位: [全部 ▼]                │
    │  类型: [全部 ▼]  状态: [全部 ▼]                    [搜索] [重置]     │
    │                                                                      │
    │  ┌──────┬──────┬────────────┬──────────┬──────┬──────────┬──────┐    │
    │  │ 工号 │ 姓名 │ 组织单元   │ 岗位     │ 类型 │ 开始日期 │ 状态 │    │
    │  ├──────┼──────┼────────────┼──────────┼──────┼──────────┼──────┤    │
    │  │E001  │ 张三 │ 研发部     │ 高级开发 │ 主职 │2020-01-15│ 在职 │    │
    │  │E001  │ 张三 │ 创新实验室 │ 技术顾问 │ 兼职 │2023-06-01│ 在职 │    │
    │  │E002  │ 李四 │ 研发部     │ 产品经理 │ 主职 │2021-03-01│ 在职 │    │
    │  │L003  │ 王五 │ 创新实验室 │ 开发工程 │ 主职 │2023-01-01│ 在职 │    │
    │  │ ...  │ ...  │ ...        │ ...      │ ...  │ ...      │ ...  │    │
    │  └──────┴──────┴────────────┴──────────┴──────┴──────────┴──────┘    │
    │                                                                      │
    │  共 200 条记录                                 [< 1 2 3 ... 8 >]     │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.5.1-1 任职管理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                             | 关联API   | 前置条件                |
    | -------- | -------- | -------- | -------------------------------- | --------- | ----------------------- |
    | F01      | 展示     | 加载列表 | 进入页面加载任职分页列表         | UR-APT-06 | ur:iam:appointment:list |
    | F02      | 操作     | 搜索     | 按工号或姓名模糊查询任职列表     | UR-APT-06 | ur:iam:appointment:list |
    | F03      | 操作     | 重置     | 清空搜索条件，恢复默认列表       | -         | -                       |
    | F04      | 操作     | 条件筛选 | 按组织、岗位、任职类型、状态筛选 | UR-APT-06 | ur:iam:appointment:list |
    | F05      | 操作     | 查看详情 | 点击人员姓名，跳转人员详情页     | -         | ur:iam:person:detail    |

    表 4.6.5.1-1 任职管理功能说明

+   搜索条件：

    | 字段名 | 组件类型   | 数据来源 | 默认值 | 说明                             |
    | ------ | ---------- | -------- | ------ | -------------------------------- |
    | 搜索   | Input      | 用户输入 | 空     | 模糊匹配工号或姓名               |
    | 组织   | TreeSelect | 接口     | 全部   | 数据来源：UR-ORG-06 组织树接口   |
    | 岗位   | Select     | 接口     | 全部   | 数据来源：UR-POS-06 岗位列表接口 |
    | 类型   | Select     | 字典     | 全部   | 枚举值：全部/主职/兼职/代理      |
    | 状态   | Select     | 字典     | 全部   | 枚举值：全部/在职/已终止         |

    表 4.6.5.1-2 任职管理搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                              |
    | -------- | ---- | ---- | -------- | --------------------------------- |
    | 工号     | 100  | 左   | 是       | 人员工号                          |
    | 姓名     | 100  | 左   | 是       | 人员姓名，可点击跳转人员详情页    |
    | 组织单元 | auto | 左   | 否       | 任职所在组织单元名称              |
    | 岗位     | auto | 左   | 否       | 任职岗位名称                      |
    | 类型     | 80   | 中   | 是       | 主职/兼职/代理                    |
    | 开始日期 | 120  | 中   | 是       | 格式 YYYY-MM-DD                   |
    | 状态     | 80   | 中   | 是       | 标签展示：在职(绿色)/已终止(灰色) |

    表 4.6.5.1-3 任职管理列表字段

+   状态/标签展示：

    | 枚举值 | 标签文本 | 颜色 |
    | ------ | -------- | ---- |
    | 在职   | 在职     | 绿色 |
    | 已终止 | 已终止   | 灰色 |

    表 4.6.5.1-4 任职管理状态标签

### 4.6.6 数据同步

#### 4.6.6.1 PG-UR-SYNC-01 同步管理

+   页面说明：
    -   用途：配置和监控外部源数据同步，包括同步状态查看、手动触发同步、同步配置管理、同步历史查看
    -   入口：租户管理后台 → 组织管理 → 数据同步 → 同步管理
    -   权限：ur:iam:sync:list（查看），ur:iam:sync:execute（执行同步），ur:iam:sync:config（配置同步）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  数据同步管理                                                        │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  同步状态                                                            │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 同步状态: ● 已启用         上次同步: 2024-01-15 08:00:00     │    │
    │  │ 同步类型: 增量同步         同步结果: 成功                    │    │
    │  │ 下次同步: 2024-01-15 09:00:00 (预计)                         │    │
    │  │                                                              │    │
    │  │ [立即全量同步]  [立即增量同步]  [查看异常]                   │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  同步配置                                                   [编辑]   │
    │  ┌──────────────────────────────────────────────────────────────┐    │
    │  │ 数据源类型: SCIM 2.0                                         │    │
    │  │ 同步地址:   https://iam.example.com/scim/v2                  │    │
    │  │ 认证方式:   Bearer Token                                     │    │
    │  │ 同步频率:   每小时                                           │    │
    │  │ 同步范围:   组织、岗位、人员、任职                           │    │
    │  └──────────────────────────────────────────────────────────────┘    │
    │                                                                      │
    │  同步历史                                                            │
    │  ┌──────────┬────────┬──────────┬──────┬──────┬──────┬────┬────┐     │
    │  │ 任务ID   │ 类型   │ 开始时间 │ 总数 │ 成功 │ 失败 │状态│操作│     │
    │  ├──────────┼────────┼──────────┼──────┼──────┼──────┼────┼────┤     │
    │  │ SYNC-001 │增量同步│01-15 08: │ 25   │ 24   │ 1    │完成│详情│     │
    │  │ SYNC-002 │增量同步│01-15 07: │ 12   │ 12   │ 0    │完成│详情│     │
    │  │ SYNC-003 │全量同步│01-14 00: │ 500  │ 498  │ 2    │完成│详情│     │
    │  │ ...      │ ...    │ ...      │ ...  │ ...  │ ...  │... │... │     │
    │  └──────────┴────────┴──────────┴──────┴──────┴──────┴────┴────┘     │
    │                                                                      │
    │  共 50 条记录                                  [< 1 2 3 ... 5 >]     │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.6.1-1 同步管理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                             | 关联API    | 前置条件            |
    | -------- | -------- | ------------ | ------------------------------------------------ | ---------- | ------------------- |
    | F01      | 展示     | 加载同步状态 | 进入页面加载当前同步状态和上次结果               | UR-SYNC-03 | ur:iam:sync:list    |
    | F02      | 操作     | 立即全量同步 | 手动触发全量同步任务                             | UR-SYNC-01 | ur:iam:sync:execute |
    | F03      | 操作     | 立即增量同步 | 手动触发增量同步任务                             | UR-SYNC-02 | ur:iam:sync:execute |
    | F04      | 展示     | 加载同步配置 | 展示当前同步配置信息                             | UR-SYNC-03 | ur:iam:sync:list    |
    | F05      | 操作     | 编辑配置     | 修改同步配置，通过ConfigService（第9章）接口实现 | -          | ur:iam:sync:config  |
    | F06      | 展示     | 加载同步历史 | 分页加载同步历史记录                             | UR-SYNC-03 | ur:iam:sync:list    |
    | F07      | 操作     | 查看详情     | 查看单次同步任务的详细执行结果                   | UR-SYNC-03 | ur:iam:sync:list    |
    | F08      | 操作     | 查看异常     | 跳转至同步异常处理页面                           | -          | ur:iam:sync:list    |

    表 4.6.6.1-1 同步管理功能说明

+   交互规则：
    -   同步状态指示灯颜色：已启用(绿色)、已暂停(黄色)、未配置(灰色)
    -   触发全量同步前二次确认，提示全量同步将覆盖增量数据
    -   同步进行中时，同步按钮禁用并显示进度
    -   同步历史失败数大于0时，失败数以红色高亮显示

#### 4.6.6.2 PG-UR-SYNC-02 同步异常处理

+   页面说明：
    -   用途：查看和处理同步过程中的异常数据，支持按级别、类型、状态筛选，支持重试和忽略操作
    -   入口：同步管理页面 → 点击"查看异常"按钮，或租户管理后台 → 组织管理 → 数据同步 → 同步异常处理
    -   权限：ur:iam:sync:list（查看），ur:iam:sync:execute（重试/忽略）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │  同步异常处理                                      [批量忽略]        │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │  级别: [全部 ▼]  类型: [全部 ▼]  状态: [未处理 ▼]                    │
    │  时间: [____] 至 [____]                            [搜索] [重置]     │
    │                                                                      │
    │  ┌──┬──────┬──────────┬────────┬──────────────────┬──────┬──────┐    │
    │  │□ │ 级别 │ 类型     │数据类型│ 错误信息         │ 状态 │ 操作 │    │
    │  ├──┼──────┼──────────┼────────┼──────────────────┼──────┼──────┤    │
    │  │□ │ 一般 │层级规则  │ 组织   │外部源组织不能挂靠│未处理│查看  │    │
    │  │□ │ 一般 │编码冲突  │ 人员   │工号E005已被占用  │未处理│查看  │    │
    │  │□ │ 轻微 │账号创建  │ 人员   │邮箱已被其他用户  │未处理│查看  │    │
    │  │□ │ 一般 │必填缺失  │ 岗位   │缺少岗位名称      │已忽略│ -    │    │
    │  │□ │ 严重 │连接失败  │ -      │无法连接外部系统  │已处理│ -    │    │
    │  │..│ ...  │ ...      │ ...    │ ...              │ ...  │ ...  │    │
    │  └──┴──────┴──────────┴────────┴──────────────────┴──────┴──────┘    │
    │                                                                      │
    │  共 15 条记录                                  [< 1 2 >]             │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 4.6.6.2-1 同步异常处理线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                                 | 关联API    | 前置条件            |
    | -------- | -------- | -------- | ------------------------------------ | ---------- | ------------------- |
    | F01      | 展示     | 加载列表 | 进入页面加载异常记录分页列表         | UR-SYNC-04 | ur:iam:sync:list    |
    | F02      | 操作     | 搜索     | 按级别、类型、状态、时间范围筛选     | UR-SYNC-04 | ur:iam:sync:list    |
    | F03      | 操作     | 重置     | 清空筛选条件，恢复默认列表           | -          | -                   |
    | F04      | 操作     | 查看详情 | 查看异常详情，包括原始数据和错误堆栈 | UR-SYNC-04 | ur:iam:sync:list    |
    | F05      | 操作     | 重试同步 | 对失败数据重新尝试同步               | UR-SYNC-01 | ur:iam:sync:execute |
    | F06      | 操作     | 忽略异常 | 标记单条异常为已忽略                 | UR-SYNC-04 | ur:iam:sync:execute |
    | F07      | 操作     | 批量忽略 | 批量标记选中异常为已忽略             | UR-SYNC-04 | ur:iam:sync:execute |

    表 4.6.6.2-1 同步异常处理功能说明

+   搜索条件：

    | 字段名 | 组件类型  | 数据来源 | 默认值 | 说明                              |
    | ------ | --------- | -------- | ------ | --------------------------------- |
    | 级别   | Select    | 字典     | 全部   | 枚举值：全部/严重/一般/轻微       |
    | 类型   | Select    | 字典     | 全部   | 异常类型枚举                      |
    | 状态   | Select    | 字典     | 未处理 | 枚举值：全部/未处理/已处理/已忽略 |
    | 时间   | DateRange | 用户输入 | 空     | 异常发生时间范围                  |

    表 4.6.6.2-2 同步异常处理搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                                     |
    | -------- | ---- | ---- | -------- | ---------------------------------------- |
    | 复选框   | 40   | 中   | 否       | 用于批量选择                             |
    | 级别     | 80   | 中   | 是       | 标签展示，引用级别标签                   |
    | 类型     | auto | 左   | 是       | 异常类型名称                             |
    | 数据类型 | 80   | 中   | 是       | 组织/岗位/人员/任职                      |
    | 错误信息 | auto | 左   | 否       | 异常错误描述，超长截断显示               |
    | 状态     | 80   | 中   | 是       | 标签展示，引用状态标签                   |
    | 操作     | 100  | 中   | 否       | 未处理：查看/重试/忽略；已处理/已忽略：- |

    表 4.6.6.2-3 同步异常处理列表字段

+   状态/标签展示：

    | 枚举值 | 标签文本 | 颜色 |
    | ------ | -------- | ---- |
    | 严重   | 严重     | 红色 |
    | 一般   | 一般     | 橙色 |
    | 轻微   | 轻微     | 蓝色 |
    | 未处理 | 未处理   | 红色 |
    | 已处理 | 已处理   | 绿色 |
    | 已忽略 | 已忽略   | 灰色 |

    表 4.6.6.2-4 同步异常处理状态标签

### 4.6.7 页面与接口映射

+   组织管理页面与后端接口的映射关系如下表所示。

    | 页面编号      | 页面功能     | 调用接口                   |
    | ------------- | ------------ | -------------------------- |
    | PG-UR-ORG-01  | 加载组织树   | UR-ORG-06 查询组织树       |
    | PG-UR-ORG-01  | 搜索组织     | UR-ORG-06 查询组织树       |
    | PG-UR-ORG-01  | 新建组织     | UR-ORG-01 创建组织单元     |
    | PG-UR-ORG-01  | 查看详情     | UR-ORG-05 查询组织单元详情 |
    | PG-UR-ORG-01  | 编辑组织     | UR-ORG-02 更新组织单元     |
    | PG-UR-ORG-01  | 移动组织     | UR-ORG-03 移动组织单元     |
    | PG-UR-ORG-01  | 删除组织     | UR-ORG-04 删除组织单元     |
    | PG-UR-ORG-01  | 查看下级     | UR-ORG-08 查询子组织列表   |
    | PG-UR-ORG-02  | 加载详情     | UR-ORG-05 查询组织单元详情 |
    | PG-UR-ORG-02  | 编辑信息     | UR-ORG-02 更新组织单元     |
    | PG-UR-ORG-02  | 查看下级组织 | UR-ORG-08 查询子组织列表   |
    | PG-UR-ORG-02  | 查看在职人员 | UR-PSN-08 分页查询人员     |
    | PG-UR-POS-01  | 加载列表     | UR-POS-06 分页查询岗位     |
    | PG-UR-POS-01  | 搜索         | UR-POS-06 分页查询岗位     |
    | PG-UR-POS-01  | 筛选         | UR-POS-06 分页查询岗位     |
    | PG-UR-POS-01  | 新建岗位     | UR-POS-01 创建岗位         |
    | PG-UR-POS-01  | 编辑岗位     | UR-POS-02 更新岗位         |
    | PG-UR-POS-01  | 启用/停用    | UR-POS-03 变更岗位状态     |
    | PG-UR-POS-01  | 删除岗位     | UR-POS-04 删除岗位         |
    | PG-UR-POS-02  | 加载详情     | UR-POS-05 查询岗位详情     |
    | PG-UR-POS-02  | 编辑信息     | UR-POS-02 更新岗位         |
    | PG-UR-POS-02  | 查看在职人员 | UR-PSN-08 分页查询人员     |
    | PG-UR-PSN-01  | 加载列表     | UR-PSN-08 分页查询人员     |
    | PG-UR-PSN-01  | 加载组织树   | UR-ORG-06 查询组织树       |
    | PG-UR-PSN-01  | 搜索         | UR-PSN-08 分页查询人员     |
    | PG-UR-PSN-01  | 组织筛选     | UR-PSN-08 分页查询人员     |
    | PG-UR-PSN-01  | 条件筛选     | UR-PSN-08 分页查询人员     |
    | PG-UR-PSN-01  | 新建人员     | UR-PSN-01 创建人员         |
    | PG-UR-PSN-01  | 批量导入     | UR-PSN-01 创建人员         |
    | PG-UR-PSN-02  | 加载信息     | UR-PSN-07 查询人员详情     |
    | PG-UR-PSN-02  | 编辑人员     | UR-PSN-02 更新人员         |
    | PG-UR-PSN-02  | 关联用户     | UR-PSN-03 关联用户         |
    | PG-UR-PSN-02  | 解除关联     | UR-PSN-04 解除用户关联     |
    | PG-UR-PSN-02  | 离职处理     | UR-PSN-05 人员离职         |
    | PG-UR-PSN-02  | 删除人员     | UR-PSN-09 删除人员         |
    | PG-UR-PSN-02  | 新增任职     | UR-APT-01 创建任职         |
    | PG-UR-PSN-02  | 调岗         | UR-APT-02 调岗             |
    | PG-UR-PSN-02  | 终止任职     | UR-APT-03 终止任职         |
    | PG-UR-PSN-02  | 设为主职     | UR-APT-04 设为主职         |
    | PG-UR-APT-01  | 加载列表     | UR-APT-06 分页查询任职     |
    | PG-UR-APT-01  | 搜索         | UR-APT-06 分页查询任职     |
    | PG-UR-APT-01  | 条件筛选     | UR-APT-06 分页查询任职     |
    | PG-UR-SYNC-01 | 加载同步状态 | UR-SYNC-03 查询同步状态    |
    | PG-UR-SYNC-01 | 立即全量同步 | UR-SYNC-01 触发全量同步    |
    | PG-UR-SYNC-01 | 立即增量同步 | UR-SYNC-02 触发增量同步    |
    | PG-UR-SYNC-01 | 加载同步配置 | UR-SYNC-03 查询同步状态    |
    | PG-UR-SYNC-01 | 加载同步历史 | UR-SYNC-03 查询同步状态    |
    | PG-UR-SYNC-01 | 查看详情     | UR-SYNC-03 查询同步状态    |
    | PG-UR-SYNC-02 | 加载列表     | UR-SYNC-04 查询同步异常    |
    | PG-UR-SYNC-02 | 搜索         | UR-SYNC-04 查询同步异常    |
    | PG-UR-SYNC-02 | 重试同步     | UR-SYNC-01 触发全量同步    |
    | PG-UR-SYNC-02 | 忽略异常     | UR-SYNC-04 查询同步异常    |
    | PG-UR-SYNC-02 | 批量忽略     | UR-SYNC-04 查询同步异常    |

    表 4.6.7-1 页面与接口映射

### 4.6.8 功能操作汇总

+   组织管理全部页面的功能操作汇总如下表所示。

    | 功能编号          | 所属页面      | 功能类型 | 功能名称     | 关联API    | 权限标识                  |
    | ----------------- | ------------- | -------- | ------------ | ---------- | ------------------------- |
    | PG-UR-ORG-01-F01  | PG-UR-ORG-01  | 展示     | 加载组织树   | UR-ORG-06  | ur:iam:org:list           |
    | PG-UR-ORG-01-F02  | PG-UR-ORG-01  | 操作     | 搜索组织     | UR-ORG-06  | ur:iam:org:list           |
    | PG-UR-ORG-01-F03  | PG-UR-ORG-01  | 操作     | 新建组织     | UR-ORG-01  | ur:iam:org:create         |
    | PG-UR-ORG-01-F04  | PG-UR-ORG-01  | 展示     | 查看详情     | UR-ORG-05  | ur:iam:org:detail         |
    | PG-UR-ORG-01-F05  | PG-UR-ORG-01  | 操作     | 编辑组织     | UR-ORG-02  | ur:iam:org:update         |
    | PG-UR-ORG-01-F06  | PG-UR-ORG-01  | 操作     | 移动组织     | UR-ORG-03  | ur:iam:org:update         |
    | PG-UR-ORG-01-F07  | PG-UR-ORG-01  | 操作     | 删除组织     | UR-ORG-04  | ur:iam:org:delete         |
    | PG-UR-ORG-01-F08  | PG-UR-ORG-01  | 操作     | 展开/折叠    | -          | -                         |
    | PG-UR-ORG-01-F09  | PG-UR-ORG-01  | 展示     | 查看下级     | UR-ORG-08  | ur:iam:org:list           |
    | PG-UR-ORG-01-F10  | PG-UR-ORG-01  | 展示     | 统计信息展示 | UR-ORG-06  | ur:iam:org:list           |
    | PG-UR-ORG-02-F01  | PG-UR-ORG-02  | 展示     | 加载详情     | UR-ORG-05  | ur:iam:org:detail         |
    | PG-UR-ORG-02-F02  | PG-UR-ORG-02  | 操作     | 编辑信息     | UR-ORG-02  | ur:iam:org:update         |
    | PG-UR-ORG-02-F03  | PG-UR-ORG-02  | 展示     | 查看下级组织 | UR-ORG-08  | ur:iam:org:list           |
    | PG-UR-ORG-02-F04  | PG-UR-ORG-02  | 展示     | 查看在职人员 | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-ORG-02-F05  | PG-UR-ORG-02  | 操作     | 返回         | -          | -                         |
    | PG-UR-POS-01-F01  | PG-UR-POS-01  | 展示     | 加载列表     | UR-POS-06  | ur:iam:position:list      |
    | PG-UR-POS-01-F02  | PG-UR-POS-01  | 操作     | 搜索         | UR-POS-06  | ur:iam:position:list      |
    | PG-UR-POS-01-F03  | PG-UR-POS-01  | 操作     | 重置         | -          | -                         |
    | PG-UR-POS-01-F04  | PG-UR-POS-01  | 操作     | 筛选         | UR-POS-06  | ur:iam:position:list      |
    | PG-UR-POS-01-F05  | PG-UR-POS-01  | 操作     | 新建岗位     | UR-POS-01  | ur:iam:position:create    |
    | PG-UR-POS-01-F06  | PG-UR-POS-01  | 操作     | 编辑岗位     | UR-POS-02  | ur:iam:position:update    |
    | PG-UR-POS-01-F07  | PG-UR-POS-01  | 操作     | 启用/停用    | UR-POS-03  | ur:iam:position:update    |
    | PG-UR-POS-01-F08  | PG-UR-POS-01  | 操作     | 删除岗位     | UR-POS-04  | ur:iam:position:delete    |
    | PG-UR-POS-01-F09  | PG-UR-POS-01  | 操作     | 查看详情     | -          | ur:iam:position:detail    |
    | PG-UR-POS-02-F01  | PG-UR-POS-02  | 展示     | 加载详情     | UR-POS-05  | ur:iam:position:detail    |
    | PG-UR-POS-02-F02  | PG-UR-POS-02  | 操作     | 编辑信息     | UR-POS-02  | ur:iam:position:update    |
    | PG-UR-POS-02-F03  | PG-UR-POS-02  | 展示     | 查看在职人员 | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-POS-02-F04  | PG-UR-POS-02  | 操作     | 返回         | -          | -                         |
    | PG-UR-PSN-01-F01  | PG-UR-PSN-01  | 展示     | 加载列表     | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-PSN-01-F02  | PG-UR-PSN-01  | 展示     | 加载组织树   | UR-ORG-06  | ur:iam:org:list           |
    | PG-UR-PSN-01-F03  | PG-UR-PSN-01  | 操作     | 搜索         | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-PSN-01-F04  | PG-UR-PSN-01  | 操作     | 重置         | -          | -                         |
    | PG-UR-PSN-01-F05  | PG-UR-PSN-01  | 操作     | 组织筛选     | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-PSN-01-F06  | PG-UR-PSN-01  | 操作     | 条件筛选     | UR-PSN-08  | ur:iam:person:list        |
    | PG-UR-PSN-01-F07  | PG-UR-PSN-01  | 操作     | 新建人员     | UR-PSN-01  | ur:iam:person:create      |
    | PG-UR-PSN-01-F08  | PG-UR-PSN-01  | 操作     | 批量导入     | UR-PSN-01  | ur:iam:person:create      |
    | PG-UR-PSN-01-F09  | PG-UR-PSN-01  | 操作     | 查看详情     | -          | ur:iam:person:detail      |
    | PG-UR-PSN-02-F01  | PG-UR-PSN-02  | 展示     | 加载信息     | UR-PSN-07  | ur:iam:person:detail      |
    | PG-UR-PSN-02-F02  | PG-UR-PSN-02  | 操作     | 编辑人员     | UR-PSN-02  | ur:iam:person:update      |
    | PG-UR-PSN-02-F03  | PG-UR-PSN-02  | 操作     | 关联用户     | UR-PSN-03  | ur:iam:person:update      |
    | PG-UR-PSN-02-F04  | PG-UR-PSN-02  | 操作     | 解除关联     | UR-PSN-04  | ur:iam:person:update      |
    | PG-UR-PSN-02-F05  | PG-UR-PSN-02  | 操作     | 离职处理     | UR-PSN-05  | ur:iam:person:update      |
    | PG-UR-PSN-02-F06  | PG-UR-PSN-02  | 操作     | 删除人员     | UR-PSN-09  | ur:iam:person:delete      |
    | PG-UR-PSN-02-F07  | PG-UR-PSN-02  | 操作     | 新增任职     | UR-APT-01  | ur:iam:appointment:create |
    | PG-UR-PSN-02-F08  | PG-UR-PSN-02  | 操作     | 调岗         | UR-APT-02  | ur:iam:appointment:update |
    | PG-UR-PSN-02-F09  | PG-UR-PSN-02  | 操作     | 终止任职     | UR-APT-03  | ur:iam:appointment:update |
    | PG-UR-PSN-02-F10  | PG-UR-PSN-02  | 操作     | 设为主职     | UR-APT-04  | ur:iam:appointment:update |
    | PG-UR-PSN-02-F11  | PG-UR-PSN-02  | 操作     | 返回         | -          | -                         |
    | PG-UR-APT-01-F01  | PG-UR-APT-01  | 展示     | 加载列表     | UR-APT-06  | ur:iam:appointment:list   |
    | PG-UR-APT-01-F02  | PG-UR-APT-01  | 操作     | 搜索         | UR-APT-06  | ur:iam:appointment:list   |
    | PG-UR-APT-01-F03  | PG-UR-APT-01  | 操作     | 重置         | -          | -                         |
    | PG-UR-APT-01-F04  | PG-UR-APT-01  | 操作     | 条件筛选     | UR-APT-06  | ur:iam:appointment:list   |
    | PG-UR-APT-01-F05  | PG-UR-APT-01  | 操作     | 查看详情     | -          | ur:iam:person:detail      |
    | PG-UR-SYNC-01-F01 | PG-UR-SYNC-01 | 展示     | 加载同步状态 | UR-SYNC-03 | ur:iam:sync:list          |
    | PG-UR-SYNC-01-F02 | PG-UR-SYNC-01 | 操作     | 立即全量同步 | UR-SYNC-01 | ur:iam:sync:execute       |
    | PG-UR-SYNC-01-F03 | PG-UR-SYNC-01 | 操作     | 立即增量同步 | UR-SYNC-02 | ur:iam:sync:execute       |
    | PG-UR-SYNC-01-F04 | PG-UR-SYNC-01 | 展示     | 加载同步配置 | UR-SYNC-03 | ur:iam:sync:list          |
    | PG-UR-SYNC-01-F05 | PG-UR-SYNC-01 | 操作     | 编辑配置     | -          | ur:iam:sync:config        |
    | PG-UR-SYNC-01-F06 | PG-UR-SYNC-01 | 展示     | 加载同步历史 | UR-SYNC-03 | ur:iam:sync:list          |
    | PG-UR-SYNC-01-F07 | PG-UR-SYNC-01 | 操作     | 查看详情     | UR-SYNC-03 | ur:iam:sync:list          |
    | PG-UR-SYNC-01-F08 | PG-UR-SYNC-01 | 操作     | 查看异常     | -          | ur:iam:sync:list          |
    | PG-UR-SYNC-02-F01 | PG-UR-SYNC-02 | 展示     | 加载列表     | UR-SYNC-04 | ur:iam:sync:list          |
    | PG-UR-SYNC-02-F02 | PG-UR-SYNC-02 | 操作     | 搜索         | UR-SYNC-04 | ur:iam:sync:list          |
    | PG-UR-SYNC-02-F03 | PG-UR-SYNC-02 | 操作     | 重置         | -          | -                         |
    | PG-UR-SYNC-02-F04 | PG-UR-SYNC-02 | 操作     | 查看详情     | UR-SYNC-04 | ur:iam:sync:list          |
    | PG-UR-SYNC-02-F05 | PG-UR-SYNC-02 | 操作     | 重试同步     | UR-SYNC-01 | ur:iam:sync:execute       |
    | PG-UR-SYNC-02-F06 | PG-UR-SYNC-02 | 操作     | 忽略异常     | UR-SYNC-04 | ur:iam:sync:execute       |
    | PG-UR-SYNC-02-F07 | PG-UR-SYNC-02 | 操作     | 批量忽略     | UR-SYNC-04 | ur:iam:sync:execute       |

    表 4.6.8-1 功能操作汇总

## 4.7 权限设计

+   本节设计组织管理相关的权限控制，包括权限标识定义和角色权限分配。
+   组织管理权限仅适用于租户用户群，由租户管理员分配。

### 4.7.1 权限标识定义

+   组织管理权限标识定义如下表所示。

    | 权限标识                  | 权限名称     | 权限类型  | 说明                               |
    | ------------------------- | ------------ | --------- | ---------------------------------- |
    | ur:iam:org:list           | 查看组织列表 | 页面+功能 | 访问组织架构页面，查看组织树和列表 |
    | ur:iam:org:detail         | 查看组织详情 | 功能      | 查看单个组织单元详细信息           |
    | ur:iam:org:create         | 创建组织     | 功能      | 创建本地组织单元                   |
    | ur:iam:org:update         | 修改组织     | 功能      | 修改和移动本地组织单元             |
    | ur:iam:org:delete         | 删除组织     | 功能      | 删除本地组织单元                   |
    | ur:iam:position:list      | 查看岗位列表 | 页面+功能 | 访问岗位管理页面，查看岗位列表     |
    | ur:iam:position:detail    | 查看岗位详情 | 功能      | 查看单个岗位详细信息               |
    | ur:iam:position:create    | 创建岗位     | 功能      | 创建本地岗位                       |
    | ur:iam:position:update    | 修改岗位     | 功能      | 修改本地岗位、变更状态             |
    | ur:iam:position:delete    | 删除岗位     | 功能      | 删除本地岗位                       |
    | ur:iam:person:list        | 查看人员列表 | 页面+功能 | 访问人员管理页面，查看人员列表     |
    | ur:iam:person:detail      | 查看人员详情 | 功能      | 查看单个人员详细信息               |
    | ur:iam:person:create      | 创建人员     | 功能      | 创建本地人员，可选创建账号和任职   |
    | ur:iam:person:update      | 修改人员     | 功能      | 修改本地人员、关联用户、离职、复职 |
    | ur:iam:person:delete      | 删除人员     | 功能      | 删除本地人员                       |
    | ur:iam:appointment:list   | 查看任职列表 | 页面+功能 | 访问任职管理页面，查看任职列表     |
    | ur:iam:appointment:detail | 查看任职详情 | 功能      | 查看单个任职详细信息               |
    | ur:iam:appointment:create | 创建任职     | 功能      | 创建任职记录                       |
    | ur:iam:appointment:update | 修改任职     | 功能      | 调岗、终止、设为主职               |
    | ur:iam:sync:list          | 查看同步     | 页面+功能 | 查看同步状态、历史、异常           |
    | ur:iam:sync:execute       | 执行同步     | 功能      | 触发同步、处理异常                 |
    | ur:iam:sync:config        | 配置同步     | 功能      | 修改同步配置                       |

    表 4.7.1-1 组织管理权限标识

### 4.7.2 权限分组

+   权限按功能模块分组如下。

    | 分组         | 包含权限                                                                                                             |
    | ------------ | -------------------------------------------------------------------------------------------------------------------- |
    | 组织架构管理 | ur:iam:org:list, ur:iam:org:detail, ur:iam:org:create, ur:iam:org:update, ur:iam:org:delete                          |
    | 岗位管理     | ur:iam:position:list, ur:iam:position:detail, ur:iam:position:create, ur:iam:position:update, ur:iam:position:delete |
    | 人员管理     | ur:iam:person:list, ur:iam:person:detail, ur:iam:person:create, ur:iam:person:update, ur:iam:person:delete           |
    | 任职管理     | ur:iam:appointment:list, ur:iam:appointment:detail, ur:iam:appointment:create, ur:iam:appointment:update             |
    | 同步管理     | ur:iam:sync:list, ur:iam:sync:execute, ur:iam:sync:config                                                            |

    表 4.7.2-1 权限分组

### 4.7.3 预置角色权限

+   系统预置角色的组织管理权限分配如下表所示。

    | 角色       | 组织架构 | 岗位管理 | 人员管理 | 任职管理 | 同步管理  |
    | ---------- | -------- | -------- | -------- | -------- | --------- |
    | 租户管理员 | 全部     | 全部     | 全部     | 全部     | 查看+执行 |
    | 组织管理员 | 全部     | 全部     | 全部     | 全部     | 查看      |
    | HR管理员   | 查看     | 查看     | 全部     | 全部     | 查看      |
    | 普通用户   | 查看     | 查看     | 查看     | 查看     | -         |

    表 4.7.3-1 预置角色权限分配

+   **权限范围说明**：
    -   "全部"：表示该分组下全部权限（list + detail + create + update + delete）
    -   "查看"：表示该分组下的list + detail权限
    -   预置角色权限可在系统初始化后由租户管理员调整

### 4.7.4 数据权限

+   组织管理支持数据权限控制，限制用户可见和可操作的数据范围。

    | 数据权限类型 | 说明                         | 适用场景   |
    | ------------ | ---------------------------- | ---------- |
    | 全部数据     | 可查看和操作所有组织数据     | 租户管理员 |
    | 本组织及下级 | 可查看和操作本组织及下级数据 | 部门管理员 |
    | 仅本组织     | 仅可查看和操作本组织数据     | 部门HR     |
    | 仅本人       | 仅可查看本人相关数据         | 普通员工   |

    表 4.7.4-1 数据权限类型

## 4.8 后端工程结构设计

+   本节定义组织管理相关的后端代码工程结构。
+   组织管理代码位于用户中心服务（us-user-center）中。

### 4.8.1 模块结构

+   组织管理后端模块结构如下。

    ```
    us-user-center/
    ├── us-user-center-api/                    # API模块
    │   └── src/main/java/.../api/
    │       └── org/                           # 组织管理API
    │           ├── dto/                       # 数据传输对象
    │           │   ├── OrgCreateRequest.java
    │           │   ├── OrgUpdateRequest.java
    │           │   ├── OrgMoveRequest.java
    │           │   ├── OrgResponse.java
    │           │   ├── OrgTreeNode.java
    │           │   ├── PositionCreateRequest.java
    │           │   ├── PositionResponse.java
    │           │   ├── PersonCreateRequest.java
    │           │   ├── PersonResponse.java
    │           │   ├── AppointmentCreateRequest.java
    │           │   ├── AppointmentResponse.java
    │           │   ├── SyncStatusResponse.java
    │           │   └── SyncExceptionResponse.java
    │           ├── enums/                     # 枚举定义
    │           │   ├── OrgType.java
    │           │   ├── OrgStatus.java
    │           │   ├── DataSource.java
    │           │   ├── PersonStatus.java
    │           │   ├── AppointmentType.java
    │           │   └── SyncStatus.java
    │           └── client/                    # Feign客户端
    │               ├── OrgClient.java
    │               ├── PositionClient.java
    │               ├── PersonClient.java
    │               └── AppointmentClient.java
    │
    ├── us-user-center-service/                # 服务模块
    │   └── src/main/java/.../service/
    │       └── org/                           # 组织管理服务
    │           ├── controller/                # 控制器
    │           │   ├── OrgController.java
    │           │   ├── PositionController.java
    │           │   ├── PersonController.java
    │           │   ├── AppointmentController.java
    │           │   └── SyncController.java
    │           ├── service/                   # 应用服务
    │           │   ├── OrgAppService.java
    │           │   ├── PositionAppService.java
    │           │   ├── PersonAppService.java
    │           │   ├── AppointmentAppService.java
    │           │   └── SyncAppService.java
    │           ├── domain/                    # 领域层
    │           │   ├── model/                 # 领域模型
    │           │   │   ├── Organization.java
    │           │   │   ├── Position.java
    │           │   │   ├── Person.java
    │           │   │   ├── PersonUser.java
    │           │   │   └── Appointment.java
    │           │   ├── service/               # 领域服务
    │           │   │   ├── OrganizationService.java
    │           │   │   ├── PositionService.java
    │           │   │   ├── PersonService.java
    │           │   │   ├── AppointmentService.java
    │           │   │   └── OrgSyncService.java
    │           │   ├── query/                 # 查询服务
    │           │   │   ├── OrganizationQueryService.java
    │           │   │   ├── PositionQueryService.java
    │           │   │   ├── PersonQueryService.java
    │           │   │   ├── AppointmentQueryService.java
    │           │   │   └── SyncQueryService.java
    │           │   ├── repository/            # 仓储接口
    │           │   │   ├── OrganizationRepository.java
    │           │   │   ├── PositionRepository.java
    │           │   │   ├── PersonRepository.java
    │           │   │   └── AppointmentRepository.java
    │           │   └── event/                 # 领域事件
    │           │       ├── OrganizationCreated.java
    │           │       ├── PersonCreated.java
    │           │       ├── PersonResigned.java
    │           │       └── OrgSyncCompleted.java
    │           ├── infrastructure/            # 基础设施层
    │           │   ├── persistence/           # 持久化实现
    │           │   │   ├── entity/            # 数据实体
    │           │   │   │   ├── OrgOrganizationEntity.java
    │           │   │   │   ├── OrgPositionEntity.java
    │           │   │   │   ├── OrgPersonEntity.java
    │           │   │   │   ├── OrgAppointmentEntity.java
    │           │   │   │   ├── OrgSyncTaskEntity.java
    │           │   │   │   └── OrgSyncExceptionEntity.java
    │           │   │   ├── mapper/            # MyBatis Mapper
    │           │   │   │   ├── OrgOrganizationMapper.java
    │           │   │   │   ├── OrgPositionMapper.java
    │           │   │   │   ├── OrgPersonMapper.java
    │           │   │   │   ├── OrgAppointmentMapper.java
    │           │   │   │   ├── OrgSyncTaskMapper.java
    │           │   │   │   └── OrgSyncExceptionMapper.java
    │           │   │   └── repository/        # 仓储实现
    │           │   │       ├── OrganizationRepositoryImpl.java
    │           │   │       ├── PositionRepositoryImpl.java
    │           │   │       ├── PersonRepositoryImpl.java
    │           │   │       └── AppointmentRepositoryImpl.java
    │           │   ├── sync/                  # 同步适配器
    │           │   │   ├── SyncAdapter.java
    │           │   │   ├── ScimSyncAdapter.java
    │           │   │   ├── LdapSyncAdapter.java
    │           │   │   └── HrApiSyncAdapter.java
    │           │   ├── rpc/                   # RPC接口实现
    │           │   │   └── OrganizationFeignClient.java
    │           │   └── messaging/             # 消息发布
    │           │       └── OrgEventPublisher.java
    │           └── assembler/                 # 对象转换
    │               ├── OrgAssembler.java
    │               ├── PositionAssembler.java
    │               ├── PersonAssembler.java
    │               └── AppointmentAssembler.java
    │
    └── src/main/resources/
        └── mapper/org/                        # MyBatis XML
            ├── OrgOrganizationMapper.xml
            ├── OrgPositionMapper.xml
            ├── OrgPersonMapper.xml
            ├── OrgAppointmentMapper.xml
            ├── OrgSyncTaskMapper.xml
            └── OrgSyncExceptionMapper.xml
    ```

    图 4.8.1-1 组织管理后端模块结构

### 4.8.2 包依赖关系

+   组织管理各层之间的依赖关系如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          后端分层依赖关系                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                      controller 控制器层                        │      │
    │    │  OrgController, PositionController, PersonController, ...       │      │
    │    └───────────────────────────────┬─────────────────────────────────┘      │
    │                                    │ 调用                                   │
    │                                    ▼                                        │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                      service 应用服务层                         │      │
    │    │  OrgAppService, PositionAppService, PersonAppService, ...       │      │
    │    └───────────────────────────────┬─────────────────────────────────┘      │
    │                                    │ 调用                                   │
    │                                    ▼                                        │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                       domain 领域层                             │      │
    │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │      │
    │    │  │   model     │  │  service    │  │ repository  │              │      │
    │    │  │ 领域模型    │  │ 领域服务    │  │ 仓储接口    │              │      │
    │    │  └─────────────┘  └─────────────┘  └──────┬──────┘              │      │
    │    └───────────────────────────────────────────┼─────────────────────┘      │
    │                                                │ 实现                       │
    │                                                ▼                            │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                   infrastructure 基础设施层                     │      │
    │    │  ┌─────────────────────────────┐  ┌─────────────────────────┐   │      │
    │    │  │       persistence           │  │         sync            │   │      │
    │    │  │  entity, mapper, repository │  │  ScimAdapter, LdapAdapter   │      │
    │    │  └─────────────────────────────┘  └─────────────────────────┘   │      │
    │    └─────────────────────────────────────────────────────────────────┘      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 4.8.2-1 后端分层依赖关系

### 4.8.3 关键类说明

+   组织管理关键类说明如下表所示。

    | 类名                     | 层级       | 职责                           |
    | ------------------------ | ---------- | ------------------------------ |
    | OrgController            | 控制器层   | 处理组织单元相关HTTP请求       |
    | OrgAppService            | 应用服务层 | 编排组织单元业务流程           |
    | Organization             | 领域模型   | 组织单元聚合根                 |
    | OrganizationService      | 领域服务   | 组织单元跨聚合业务逻辑         |
    | OrganizationRepository   | 仓储接口   | 组织单元持久化抽象             |
    | OrgOrganizationEntity    | 基础设施层 | 组织单元数据库实体             |
    | OrgOrganizationMapper    | 基础设施层 | 组织单元MyBatis映射            |
    | OrgSyncService           | 领域服务   | 外部源数据同步业务逻辑         |
    | ScimSyncAdapter          | 基础设施层 | SCIM协议同步适配器             |
    | OrgAssembler             | 转换层     | 领域对象与DTO互转              |
    | PositionService          | 领域服务   | 岗位跨聚合业务逻辑             |
    | PersonService            | 领域服务   | 人员跨聚合业务逻辑             |
    | AppointmentService       | 领域服务   | 任职跨聚合业务逻辑             |
    | OrganizationFeignClient  | 基础设施层 | 组织树RPC接口实现              |
    | OrgEventPublisher        | 基础设施层 | 领域事件消息发布               |
    | OrganizationQueryService | 查询服务   | 组织单元只读查询（CQRS查询侧） |
    | PositionQueryService     | 查询服务   | 岗位只读查询（CQRS查询侧）     |
    | PersonQueryService       | 查询服务   | 人员只读查询（CQRS查询侧）     |
    | AppointmentQueryService  | 查询服务   | 任职只读查询（CQRS查询侧）     |
    | SyncQueryService         | 查询服务   | 同步状态只读查询（CQRS查询侧） |

    表 4.8.3-1 关键类说明

## 4.9 前端工程结构设计

+   本节定义组织管理相关的前端代码工程结构。
+   组织管理前端代码位于租户管理后台项目中。

### 4.9.1 目录结构

+   组织管理前端目录结构如下。

    ```
    src/
    ├── views/
    │   └── admin/
    │       └── org/                           # 组织管理页面
    │           ├── structure/                 # 组织架构
    │           │   ├── index.vue              # P-ORG-01 组织架构管理
    │           │   ├── detail.vue             # P-ORG-02 组织单元详情
    │           │   └── components/
    │           │       ├── OrgTree.vue        # 组织树组件
    │           │       ├── OrgForm.vue        # 组织表单组件
    │           │       └── OrgMoveDialog.vue  # 移动组织弹窗
    │           ├── position/                  # 岗位管理
    │           │   ├── index.vue              # P-POS-01 岗位管理
    │           │   ├── detail.vue             # P-POS-02 岗位详情
    │           │   └── components/
    │           │       └── PositionForm.vue   # 岗位表单组件
    │           ├── person/                    # 人员管理
    │           │   ├── index.vue              # P-PSN-01 人员管理
    │           │   ├── detail.vue             # P-PSN-02 人员详情
    │           │   └── components/
    │           │       ├── PersonForm.vue     # 人员表单组件
    │           │       ├── PersonImport.vue   # 批量导入组件
    │           │       ├── BindUserDialog.vue # 关联用户弹窗
    │           │       ├── ResignDialog.vue   # 离职处理弹窗
    │           │       └── AppointmentList.vue# 任职列表组件
    │           ├── appointment/               # 任职管理
    │           │   ├── index.vue              # P-APT-01 任职管理
    │           │   └── components/
    │           │       ├── AppointmentForm.vue# 任职表单组件
    │           │       └── TransferDialog.vue # 调岗弹窗
    │           └── sync/                      # 数据同步
    │               ├── index.vue              # P-SYNC-01 同步管理
    │               ├── exceptions.vue         # P-SYNC-02 同步异常处理
    │               └── components/
    │                   ├── SyncStatus.vue     # 同步状态组件
    │                   ├── SyncConfig.vue     # 同步配置组件
    │                   ├── SyncHistory.vue    # 同步历史组件
    │                   └── ExceptionDetail.vue# 异常详情弹窗
    │
    ├── api/
    │   └── org/                               # 组织管理API
    │       ├── organization.ts                # 组织单元接口
    │       ├── position.ts                    # 岗位接口
    │       ├── person.ts                      # 人员接口
    │       ├── appointment.ts                 # 任职接口
    │       └── sync.ts                        # 同步接口
    │
    ├── stores/
    │   └── org/                               # 组织管理状态
    │       ├── organization.ts                # 组织状态管理
    │       ├── position.ts                    # 岗位状态管理
    │       └── person.ts                      # 人员状态管理
    │
    ├── types/
    │   └── org/                               # 组织管理类型
    │       ├── organization.ts                # 组织类型定义
    │       ├── position.ts                    # 岗位类型定义
    │       ├── person.ts                      # 人员类型定义
    │       ├── appointment.ts                 # 任职类型定义
    │       └── sync.ts                        # 同步类型定义
    │
    └── router/
        └── modules/
            └── org.ts                         # 组织管理路由
    ```

    图 4.9.1-1 组织管理前端目录结构

### 4.9.2 路由配置

+   组织管理路由配置如下。

    ```typescript
    // src/router/modules/org.ts
    export default {
      path: '/admin/org',
      name: 'OrgManagement',
      meta: { title: '组织管理', icon: 'organization' },
      children: [
        {
          path: 'structure',
          name: 'OrgStructure',
          component: () => import('@/views/admin/org/structure/index.vue'),
          meta: { title: '组织架构', permission: 'org:read' }
        },
        {
          path: 'structure/:id',
          name: 'OrgDetail',
          component: () => import('@/views/admin/org/structure/detail.vue'),
          meta: { title: '组织详情', hidden: true }
        },
        {
          path: 'position',
          name: 'PositionManagement',
          component: () => import('@/views/admin/org/position/index.vue'),
          meta: { title: '岗位管理', permission: 'position:read' }
        },
        {
          path: 'position/:id',
          name: 'PositionDetail',
          component: () => import('@/views/admin/org/position/detail.vue'),
          meta: { title: '岗位详情', hidden: true }
        },
        {
          path: 'person',
          name: 'PersonManagement',
          component: () => import('@/views/admin/org/person/index.vue'),
          meta: { title: '人员管理', permission: 'person:read' }
        },
        {
          path: 'person/:id',
          name: 'PersonDetail',
          component: () => import('@/views/admin/org/person/detail.vue'),
          meta: { title: '人员详情', hidden: true }
        },
        {
          path: 'appointment',
          name: 'AppointmentManagement',
          component: () => import('@/views/admin/org/appointment/index.vue'),
          meta: { title: '任职管理', permission: 'appointment:read' }
        },
        {
          path: 'sync',
          name: 'SyncManagement',
          component: () => import('@/views/admin/org/sync/index.vue'),
          meta: { title: '数据同步', permission: 'sync:read' }
        },
        {
          path: 'sync/exceptions',
          name: 'SyncExceptions',
          component: () => import('@/views/admin/org/sync/exceptions.vue'),
          meta: { title: '同步异常', hidden: true }
        }
      ]
    }
    ```

    图 4.9.2-1 组织管理路由配置

### 4.9.3 API接口封装

+   组织管理API接口封装示例如下。

    ```typescript
    // src/api/org/organization.ts
    import request from '@/utils/request'
    import type { OrgCreateRequest, OrgResponse, OrgTreeNode } from '@/types/org/organization'

    // 创建组织单元
    export function createOrg(data: OrgCreateRequest): Promise<OrgResponse> {
      return request.post('/api/v1/ur/org', data)
    }

    // 更新组织单元
    export function updateOrg(id: number, data: Partial<OrgCreateRequest>): Promise<void> {
      return request.put(`/api/v1/ur/org/${id}`, data)
    }

    // 移动组织单元
    export function moveOrg(id: number, newParentId: number): Promise<void> {
      return request.put(`/api/v1/ur/org/${id}/move`, { newParentId })
    }

    // 删除组织单元
    export function deleteOrg(id: number): Promise<void> {
      return request.delete(`/api/v1/ur/org/${id}`)
    }

    // 查询组织单元详情
    export function getOrg(id: number): Promise<OrgResponse> {
      return request.get(`/api/v1/ur/org/${id}`)
    }

    // 查询组织树
    export function getOrgTree(params?: { status?: string; maxLevel?: number }): Promise<OrgTreeNode[]> {
      return request.get('/api/v1/ur/org/tree', { params })
    }

    // 分页查询组织单元
    export function listOrg(params: {
      keyword?: string
      type?: string
      parentId?: number
      source?: string
      status?: string
      page?: number
      size?: number
    }): Promise<PageResult<OrgResponse>> {
      return request.get('/api/v1/ur/org', { params })
    }
    ```

    图 4.9.3-1 组织管理API接口封装示例

### 4.9.4 组件说明

+   组织管理关键组件说明如下表所示。

    | 组件名              | 路径                                    | 功能说明                   |
    | ------------------- | --------------------------------------- | -------------------------- |
    | OrgTree.vue         | views/admin/org/structure/components/   | 组织树形组件，支持展开折叠 |
    | OrgForm.vue         | views/admin/org/structure/components/   | 组织新建/编辑表单          |
    | OrgMoveDialog.vue   | views/admin/org/structure/components/   | 移动组织弹窗，选择目标上级 |
    | PositionForm.vue    | views/admin/org/position/components/    | 岗位新建/编辑表单          |
    | PersonForm.vue      | views/admin/org/person/components/      | 人员新建/编辑表单          |
    | PersonImport.vue    | views/admin/org/person/components/      | 人员批量导入组件           |
    | BindUserDialog.vue  | views/admin/org/person/components/      | 关联用户弹窗               |
    | ResignDialog.vue    | views/admin/org/person/components/      | 离职处理弹窗               |
    | AppointmentList.vue | views/admin/org/person/components/      | 人员任职列表组件           |
    | AppointmentForm.vue | views/admin/org/appointment/components/ | 任职新建/编辑表单          |
    | TransferDialog.vue  | views/admin/org/appointment/components/ | 调岗弹窗                   |
    | SyncStatus.vue      | views/admin/org/sync/components/        | 同步状态展示组件           |
    | SyncConfig.vue      | views/admin/org/sync/components/        | 同步配置组件               |
    | SyncHistory.vue     | views/admin/org/sync/components/        | 同步历史列表组件           |
    | ExceptionDetail.vue | views/admin/org/sync/components/        | 异常详情弹窗               |

    表 4.9.4-1 组织管理关键组件

# 5 认证管理

+   本章详细设计认证管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   认证管理负责"证明你是谁"，需要针对不同用户群（运营用户群、租户用户群、C端用户群）和不同终端类型（浏览器、移动App、桌面客户端）提供差异化的认证方案。

## 5.1 认证业务场景

+   本节分析认证管理的业务场景，围绕三侧用户体系和多终端类型展开设计。

### 5.1.1 认证与用户群的关系

+   认证管理服务于第3章定义的三侧用户体系，不同用户群的认证需求存在差异。

#### 5.1.1.1 三侧用户认证入口

+   三侧用户通过不同入口进行认证，如下表所示。

    | 用户群           | 用户类型     | 认证入口              | 认证后访问范围 |
    | ---------------- | ------------ | --------------------- | -------------- |
    | 运营用户群（UP） | PlatformUser | 运营管理后台          | 平台管理功能   |
    | 租户用户群（UR） | TenantUser   | 租户管理后台/业务系统 | 租户数据和功能 |
    | C端用户群（UC）  | ConsumerUser | C端App/小程序/H5      | 个人数据和服务 |

    表 5.1.1.1-1 三侧用户认证入口

+   认证入口与用户类型的关系如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        认证入口与用户群关系                                 │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                          ┌─────────────────┐                                │
    │                          │   认证服务      │                                │
    │                          │ Authentication  │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │              ┌────────────────────┼────────────────────┐                    │
    │              │                    │                    │                    │
    │              ▼                    ▼                    ▼                    │
    │    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
    │    │  运营用户群入口     │  │  租户用户群入口     │  │  C端用户群入口     │            │
    │    │  /up/auth/*     │  │  /ur/auth/*     │  │  /uc/auth/*     │            │
    │    └────────┬────────┘  └────────┬────────┘  └────────┬────────┘            │
    │             │                    │                    │                     │
    │             ▼                    ▼                    ▼                     │
    │    ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
    │    │  PlatformUser   │  │  TenantUser     │  │  ConsumerUser   │            │
    │    │  平台用户       │  │  租户用户       │  │  C端用户        │            │
    │    │  (平台库)       │  │  (租户库)       │  │  (平台库)       │            │
    │    └─────────────────┘  └─────────────────┘  └─────────────────┘            │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.1.1.1-1 认证入口与用户群关系

#### 5.1.1.2 三侧用户认证差异

+   三侧用户的认证需求差异如下表所示。

    | 差异点     | 运营用户群（UP） | 租户用户群（UR） | C端用户群（UC） |
    | ---------- | ---------------- | ---------------- | --------------- |
    | 安全级别   | 最高             | 高               | 中              |
    | MFA要求    | 强制             | 可配置           | 用户自选        |
    | 密码策略   | 最严格           | 租户可配置       | 基础要求        |
    | 登录方式   | 用户名密码为主   | 多种方式         | 社交登录为主    |
    | 会话有效期 | 较短（4小时）    | 中等（8小时）    | 较长（30天）    |
    | 多端登录   | 单设备           | 可配置           | 允许多端        |
    | 第三方登录 | 不支持           | 企业身份源       | 社交登录        |
    | IP白名单   | 支持             | 支持             | 不支持          |

    表 5.1.1.2-1 三侧用户认证差异

#### 5.1.1.3 认证上下文

+   认证请求需要携带认证上下文，用于确定用户群和认证策略。

    | 上下文参数  | 说明                     | 来源                  |
    | ----------- | ------------------------ | --------------------- |
    | user_pool   | 用户群标识（UP/UR/UC）   | 认证入口路径          |
    | tenant_code | 租户编码（仅租户用户群） | 用户输入/系统默认配置 |
    | client_type | 终端类型                 | User-Agent解析        |
    | client_id   | 客户端应用ID             | 请求参数              |
    | device_id   | 设备指纹                 | 客户端生成            |

    表 5.1.1.3-1 认证上下文参数

+   **tenantCode获取方式**
    -   **用户输入**：用户在登录界面采用 `tenantCode\username` 格式输入（如 `acme\zhangsan`），前端解析后分别传入
    -   **系统默认配置**：私有化部署场景可在系统配置中设置默认租户编码，用户仅需输入用户名
    -   不再支持通过域名解析获取tenantCode

### 5.1.2 终端类型与认证能力

+   不同终端类型具有不同的认证能力，需要针对性设计认证方案。

#### 5.1.2.1 终端类型分类

+   系统支持的终端类型如下表所示。

    | 终端类型    | 代码    | 典型场景               | 特点                   |
    | ----------- | ------- | ---------------------- | ---------------------- |
    | PC浏览器    | WEB     | 管理后台、Web应用      | 无生物识别、有Cookie   |
    | 移动浏览器  | H5      | H5页面、微信内置浏览器 | 能力受限、可能无Cookie |
    | iOS App     | IOS     | iPhone/iPad原生应用    | Face ID/Touch ID       |
    | Android App | ANDROID | Android原生应用        | 指纹识别、人脸识别     |
    | 小程序      | MINIAPP | 微信/支付宝小程序      | 依赖宿主App能力        |
    | 桌面客户端  | DESKTOP | Windows/Mac客户端      | 可调用本地能力         |

    表 5.1.2.1-1 终端类型分类

#### 5.1.2.2 终端认证能力矩阵

+   各终端类型支持的认证能力如下表所示。

    | 认证方式         | WEB | H5  | IOS | ANDROID | MINIAPP | DESKTOP |
    | ---------------- | --- | --- | --- | ------- | ------- | ------- |
    | 用户名密码       | ✓   | ✓   | ✓   | ✓       | ✓       | ✓       |
    | 手机验证码       | ✓   | ✓   | ✓   | ✓       | ✓       | ✓       |
    | 邮箱验证码       | ✓   | ✓   | ✓   | ✓       | ✓       | ✓       |
    | 图形验证码       | ✓   | ✓   | ✓   | ✓       | ✓       | ✓       |
    | 扫码登录         | ✓   | ✗   | ✗   | ✗       | ✗       | ✓       |
    | 被扫码（确认端） | ✗   | ✗   | ✓   | ✓       | ✓       | ✗       |
    | 微信登录         | ✓   | ✓   | ✓   | ✓       | ✓       | ✗       |
    | 指纹识别         | ✗   | ✗   | ✓   | ✓       | ✗       | ✗       |
    | Face ID          | ✗   | ✗   | ✓   | ✗       | ✗       | ✗       |
    | 人脸识别         | ✗   | ✗   | ✓   | ✓       | ✗       | ✗       |
    | TOTP验证         | ✓   | ✓   | ✓   | ✓       | ✓       | ✓       |
    | 硬件密钥WebAuthn | ✓   | ✗   | ✗   | ✗       | ✗       | ✓       |

    表 5.1.2.2-1 终端认证能力矩阵

+   说明：
    -   ✓ 表示该终端支持此认证方式
    -   ✗ 表示该终端不支持或不适用此认证方式

#### 5.1.2.3 终端与用户群组合

+   终端类型与用户群的典型组合如下表所示。

    | 用户群           | 主要终端     | 次要终端         | 不适用终端  |
    | ---------------- | ------------ | ---------------- | ----------- |
    | 运营用户群（UP） | WEB          | DESKTOP          | H5, MINIAPP |
    | 租户用户群（UR） | WEB          | IOS, ANDROID, H5 | MINIAPP     |
    | C端用户群（UC）  | IOS, ANDROID | H5, MINIAPP, WEB | DESKTOP     |

    表 5.1.2.3-1 终端与用户群组合

### 5.1.3 三侧认证方案设计

+   基于用户群特点和终端能力，设计三侧差异化的认证方案。

#### 5.1.3.1 运营用户群（UP）认证方案

+   运营用户群为平台运营人员，根据部署方式采用不同认证策略。

+   **SaaS公有云部署**：用户名 + 密码 + 短信验证码（双因素）

    | 配置项       | 配置值               | 说明               |
    | ------------ | -------------------- | ------------------ |
    | 认证方式     | 用户名 + 密码 + 短信 | 强制双因素认证     |
    | 第一因素     | 用户名 + 密码        | 主认证             |
    | 第二因素     | 短信验证码           | 每次登录必须       |
    | 密码最小长度 | 12位                 | 严格密码策略       |
    | 密码复杂度   | 大小写+数字+特殊字符 | 必须包含四种字符   |
    | 密码有效期   | 90天                 | 定期强制修改       |
    | 登录失败锁定 | 5次/15分钟           | 严格锁定策略       |
    | 会话有效期   | 4小时                | 较短有效期         |
    | 空闲超时     | 15分钟               | 无操作自动登出     |
    | 多端登录     | 单设备               | 不允许多端同时登录 |
    | IP白名单     | 可配置               | 支持限制登录IP     |

    表 5.1.3.1-1 运营用户群认证方案（SaaS部署）

+   **私有化内网部署**：用户名 + 密码（单因素）

    | 配置项     | 配置值        | 说明               |
    | ---------- | ------------- | ------------------ |
    | 认证方式   | 用户名 + 密码 | 内网环境可简化     |
    | 短信验证码 | 不要求        | 内网无需双因素     |
    | 其他策略   | 同SaaS部署    | 密码策略等保持一致 |

    表 5.1.3.1-2 运营用户群认证方案（私有化部署）

+   运营用户群认证流程如下（SaaS部署）。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        运营用户群认证流程（SaaS部署）                       │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐      │
    │    │ 输入用户名密码  │────▶│ 图形验证码校验  │────▶│ 密码验证        │      │
    │    └─────────────────┘     └─────────────────┘     └────────┬────────┘      │
    │                                                             │               │
    │                                                             ▼               │
    │                                                    ┌─────────────────┐      │
    │                                                    │ 发送短信验证码  │      │
    │                                                    └────────┬────────┘      │
    │                                                             │               │
    │                                                             ▼               │
    │                                                    ┌─────────────────┐      │
    │                                                    │ 输入短信验证码  │      │
    │                                                    └────────┬────────┘      │
    │                                                             │               │
    │                                                             ▼               │
    │                                              ┌─────────────────────────┐    │
    │                                              │ 签发令牌、创建会话      │    │
    │                                              │ 踢出其他设备登录        │    │
    │                                              └─────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.1.3.1-1 运营用户群认证流程

#### 5.1.3.2 租户用户群（UR）认证方案

+   租户用户群为企业用户，支持多种认证方式组合，租户可配置。

+   **支持的认证方式组合**如下表所示。

    | 认证方式             | 说明             | 安全级别 | 适用场景           |
    | -------------------- | ---------------- | -------- | ------------------ |
    | 用户名 + 密码        | 基础认证方式     | 中       | 日常登录           |
    | 用户名 + 短信验证码  | 免密登录         | 中       | 忘记密码、快捷登录 |
    | 用户名 + 密码 + 短信 | 双因素认证       | 高       | 敏感操作、管理员   |
    | SSO单点登录          | 对接企业统一认证 | 高       | 企业内部集成       |
    | 企业内免密登录       | 内网环境自动登录 | -        | 企业内网访问       |

    表 5.1.3.2-1 租户用户群认证方式组合

+   **认证方式配置规则**如下。

    | 配置项         | 默认值           | 租户可配置 | 说明                 |
    | -------------- | ---------------- | ---------- | -------------------- |
    | 允许的认证方式 | 密码、短信验证码 | 是         | 租户选择开放哪些方式 |
    | 是否强制双因素 | 否               | 是         | 可强制特定角色双因素 |
    | SSO配置        | 不启用           | 是         | 可对接企业IdP        |
    | 企业内免密登录 | 不启用           | 是         | 配置内网IP段自动登录 |
    | 密码最小长度   | 8位              | 是（≥8）   | 不低于平台最低要求   |
    | 密码复杂度     | 大小写+数字      | 是         | 可提高不可降低       |
    | 密码有效期     | 不限制           | 是         | 租户可设置           |
    | 登录失败锁定   | 5次/5分钟        | 是         | 租户可调整           |
    | 会话有效期     | 8小时            | 是         | 租户可配置           |
    | 空闲超时       | 30分钟           | 是         | 租户可配置           |
    | 多端登录策略   | 同类型互斥       | 是         | 租户可配置           |

    表 5.1.3.2-2 租户用户群认证配置

+   **SSO单点登录**支持以下协议。

    | SSO协议        | 说明               | 适用场景       |
    | -------------- | ------------------ | -------------- |
    | OAuth 2.0      | 开放授权协议       | 现代Web应用    |
    | OpenID Connect | 基于OAuth2的身份层 | 标准化身份认证 |
    | SAML 2.0       | 安全断言标记语言   | 企业级SSO      |
    | CAS            | 中央认证服务       | 传统SSO方案    |

    表 5.1.3.2-3 租户用户群SSO协议支持

+   **企业内免密登录**的实现方式。
    -   **IP段白名单**：配置企业内网IP段，来自该IP段的请求可免密
    -   **域账号集成**：对接企业AD/LDAP，使用Windows域账号自动认证
    -   **企业应用内嵌**：从企业微信/钉钉/飞书工作台进入时，使用企业身份自动登录

+   租户用户群认证流程如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        租户用户群认证流程                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                          ┌─────────────────┐                                │
    │                          │ 识别租户        │                                │
    │                          │ (用户输入)      │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │ 加载租户认证策略│                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │         ┌─────────────────────────┼─────────────────────────┐               │
    │         │                         │                         │               │
    │         ▼                         ▼                         ▼               │
    │    ┌─────────┐             ┌─────────────┐            ┌─────────┐           │
    │    │ 企业内  │             │ 选择认证方式│            │  SSO    │           │
    │    │ 免密？  │             │             │            │ 登录？  │           │
    │    └────┬────┘             └──────┬──────┘            └────┬────┘           │
    │         │是                       │                        │是              │
    │         ▼                         ▼                        ▼                │
    │    ┌─────────┐    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
    │    │IP/域账号│    │用户名+  │ │用户名+  │ │用户名+  │ │跳转IdP  │           │
    │    │自动认证 │    │密码     │ │短信码   │ │密码+短信│ │认证     │           │
    │    └────┬────┘    └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
    │         │              │           │           │           │                │
    │         └──────────────┴───────────┴───────────┴───────────┘                │
    │                                   │                                         │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │ 签发令牌        │                                │
    │                          │ 创建会话        │                                │
    │                          └─────────────────┘                                │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.1.3.2-1 租户用户群认证流程

#### 5.1.3.3 C端用户群（UC）认证方案

+   C端用户群为C端用户，根据注册或绑定的第三方账号进行认证。

+   **支持的认证方式**如下表所示。

    | 认证方式        | 说明                     | 前提条件     |
    | --------------- | ------------------------ | ------------ |
    | 微信登录        | 使用微信账号授权登录     | 已绑定微信   |
    | 钉钉登录        | 使用钉钉账号授权登录     | 已绑定钉钉   |
    | QQ登录          | 使用QQ账号授权登录       | 已绑定QQ     |
    | 手机号 + 验证码 | 使用手机号接收验证码登录 | 已绑定手机号 |
    | 手机号 + 密码   | 使用手机号和密码登录     | 已设置密码   |

    表 5.1.3.3-1 C端用户群认证方式

+   **认证方式与终端的关系**如下表所示。

    | 认证方式         | IOS | ANDROID | H5  | MINIAPP | WEB |
    | ---------------- | --- | ------- | --- | ------- | --- |
    | 微信登录         | ✓   | ✓       | ✓   | ✓       | ✓   |
    | 钉钉登录         | ✓   | ✓       | ✓   | ✓       | ✓   |
    | QQ登录           | ✓   | ✓       | ✓   | ✗       | ✓   |
    | 手机号 + 验证码  | ✓   | ✓       | ✓   | ✓       | ✓   |
    | 手机号 + 密码    | ✓   | ✓       | ✓   | ✓       | ✓   |
    | 生物识别快捷登录 | ✓   | ✓       | ✗   | ✗       | ✗   |

    表 5.1.3.3-2 C端用户群认证方式与终端

+   **认证配置**如下表所示。

    | 配置项       | 配置值     | 说明               |
    | ------------ | ---------- | ------------------ |
    | 首选认证方式 | 社交登录   | 优先展示第三方登录 |
    | 密码最小长度 | 6位        | 基础要求           |
    | 密码复杂度   | 字母+数字  | 不强制特殊字符     |
    | 登录失败锁定 | 10次/5分钟 | 相对宽松           |
    | 会话有效期   | 30天       | 较长有效期         |
    | 空闲超时     | 不限制     | 保持登录状态       |
    | 多端登录     | 允许多端   | 不限制设备数       |

    表 5.1.3.3-3 C端用户群认证配置

+   **第三方账号绑定规则**如下。
    -   **注册时绑定**：首次使用第三方账号登录时自动创建本地账号并绑定
    -   **登录后绑定**：已有账号可在个人设置中绑定更多第三方账号
    -   **唯一性约束**：同一第三方账号只能绑定一个本地账号
    -   **多账号绑定**：一个本地账号可绑定多个不同渠道的第三方账号

+   **生物识别快捷登录**（仅App端）。
    -   首次需完成一次完整登录（第三方或验证码）
    -   开启后使用Face ID/Touch ID/指纹快速登录
    -   本地验证成功后，使用存储的凭证换取令牌

+   C端用户群认证流程如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        C端用户群认证流程                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                          ┌─────────────────┐                                │
    │                          │ 选择登录方式    │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │    ┌──────────────┬───────────────┼───────────────┬──────────────┐          │
    │    │              │               │               │              │          │
    │    ▼              ▼               ▼               ▼              ▼          │
    │ ┌──────┐     ┌──────┐        ┌──────┐        ┌──────┐       ┌──────┐        │
    │ │ 微信 │     │ 钉钉 │        │  QQ  │        │ 手机 │       │ 生物 │        │
    │ │ 登录 │     │ 登录 │        │ 登录 │        │ 登录 │       │ 识别 │        │
    │ └──┬───┘     └──┬───┘        └──┬───┘        └──┬───┘       └──┬───┘        │
    │    │            │               │               │              │            │
    │    ▼            ▼               ▼               │              │            │
    │ ┌──────────────────────────────────┐            │              │            │
    │ │ 跳转第三方授权页面               │            │              │            │
    │ │ 用户授权后回调                   │            │              │            │
    │ └────────────────┬─────────────────┘            │              │            │
    │                  │                              │              │            │
    │                  ▼                              ▼              │            │
    │         ┌─────────────────┐            ┌─────────────┐         │            │
    │         │ 查询绑定关系    │            │ 验证码/密码 │         │            │
    │         └────────┬────────┘            │ 验证        │         │            │
    │                  │                     └──────┬──────┘         │            │
    │         ┌────────┴────────┐                   │                │            │
    │         │                 │                   │                │            │
    │    已绑定▼            未绑定▼                 │                │            │
    │ ┌─────────────┐   ┌─────────────┐             │                │            │
    │ │ 直接登录    │   │ 自动注册    │             │                │            │
    │ │             │   │ 并绑定      │             │                │            │
    │ └──────┬──────┘   └──────┬──────┘             │                │            │
    │        │                 │                    │                │            │
    │        └─────────────────┴────────────────────┴────────────────┘            │
    │                                   │                                         │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │ 签发令牌        │                                │
    │                          │ 创建会话        │                                │
    │                          └─────────────────┘                                │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.1.3.3-1 C端用户群认证流程

### 5.1.4 认证方式详细设计

+   本节详细设计各认证方式的规则和流程。

#### 5.1.4.1 密码认证

+   密码认证的规则如下表所示。

    | 规则项         | 运营用户群（UP）     | 租户用户群（UR）      | C端用户群（UC） |
    | -------------- | -------------------- | --------------------- | --------------- |
    | 支持的登录标识 | 用户名               | 用户名、邮箱、手机号  | 手机号          |
    | 密码哈希算法   | Argon2id             | Argon2id              | BCrypt          |
    | 传输加密       | HTTPS + RSA加密      | HTTPS + RSA加密       | HTTPS           |
    | 图形验证码     | 必须                 | 可配置                | 失败后触发      |
    | 密码最小长度   | 12位                 | 8位（可配置）         | 6位             |
    | 密码复杂度     | 大小写+数字+特殊字符 | 大小写+数字（可配置） | 字母+数字       |

    表 5.1.4.1-1 密码认证规则

#### 5.1.4.2 验证码认证

+   短信验证码认证规则如下表所示。

    | 配置项       | 默认值 | 说明                     |
    | ------------ | ------ | ------------------------ |
    | 验证码长度   | 6位    | 支持配置4位/6位          |
    | 有效期       | 5分钟  | 过期自动失效             |
    | 发送间隔     | 60秒   | 同一号码发送间隔         |
    | 每日上限     | 10次   | 同一号码每日最多发送次数 |
    | 错误次数限制 | 5次    | 超限需重新获取           |
    | 使用后失效   | 是     | 防止重放攻击             |

    表 5.1.4.2-1 验证码认证规则

+   验证码用途场景如下表所示。

    | 用途场景   | 场景代码       | 适用用户群 | 模板内容示例               |
    | ---------- | -------------- | ---------- | -------------------------- |
    | 登录验证   | LOGIN          | UR/UC      | 您的登录验证码是{code}     |
    | 登录双因素 | LOGIN_MFA      | UP/UR      | 您的安全验证码是{code}     |
    | 注册验证   | REGISTER       | UR/UC      | 您的注册验证码是{code}     |
    | 找回密码   | RESET_PASSWORD | UP/UR/UC   | 您的密码重置验证码是{code} |
    | 绑定手机   | BIND_MOBILE    | UP/UR/UC   | 您的绑定验证码是{code}     |
    | 敏感操作   | SENSITIVE      | UP/UR/UC   | 您的操作验证码是{code}     |

    表 5.1.4.2-2 验证码用途场景

#### 5.1.4.3 第三方登录

+   第三方登录支持情况如下表所示。

    | 第三方渠道 | 运营用户群（UP） | 租户用户群（UR） | C端用户群（UC） |
    | ---------- | ---------------- | ---------------- | --------------- |
    | 微信       | ✗                | ✗                | ✓               |
    | 钉钉       | ✗                | ✓（企业身份源）  | ✓               |
    | QQ         | ✗                | ✗                | ✓               |
    | 企业微信   | ✗                | ✓（企业身份源）  | ✗               |
    | 飞书       | ✗                | ✓（企业身份源）  | ✗               |
    | LDAP/AD    | ✗                | ✓（企业身份源）  | ✗               |

    表 5.1.4.3-1 第三方登录支持情况

+   **C端用户群第三方登录流程**如下。

    | 步骤 | 操作                           | 说明               |
    | ---- | ------------------------------ | ------------------ |
    | 1    | 用户点击第三方登录按钮         | 选择微信/钉钉/QQ   |
    | 2    | 跳转到第三方授权页面           | 用户授权           |
    | 3    | 第三方回调，携带授权码         | 系统获取授权码     |
    | 4    | 系统换取access_token           | 调用第三方API      |
    | 5    | 获取用户信息（openid/unionid） | 获取唯一标识       |
    | 6    | 查找绑定关系                   | 是否已绑定本地账号 |
    | 7a   | 已绑定：直接登录               | 签发令牌           |
    | 7b   | 未绑定：自动注册并绑定         | 创建账号           |

    表 5.1.4.3-2 C端用户群第三方登录流程

+   **租户用户群企业身份源登录流程**如下。

    | 步骤 | 操作                     | 说明                 |
    | ---- | ------------------------ | -------------------- |
    | 1    | 识别租户，加载身份源配置 | 根据域名或参数       |
    | 2    | 跳转到企业IdP            | 企业微信/钉钉/飞书   |
    | 3    | 用户在企业IdP完成认证    | 使用企业账号         |
    | 4    | IdP回调，携带用户身份    | 获取员工标识         |
    | 5    | 匹配租户用户             | 根据员工标识查找用户 |
    | 5a   | 已存在：直接登录         | 签发令牌             |
    | 5b   | 不存在：自动创建用户     | 若开启自动同步       |

    表 5.1.4.3-3 租户用户群企业身份源登录流程

#### 5.1.4.4 SSO单点登录

+   SSO仅适用于租户用户群（UR），支持租户作为SP对接外部IdP。

    | SSO模式       | 说明                   | 适用场景         |
    | ------------- | ---------------------- | ---------------- |
    | 本系统作为SP  | 对接外部企业IdP        | 企业已有统一认证 |
    | 本系统作为IdP | 为租户其他系统提供认证 | 租户多系统集成   |

    表 5.1.4.4-1 SSO模式

#### 5.1.4.5 企业内免密登录

+   企业内免密登录仅适用于租户用户群（UR），实现方式如下。

    | 免密方式     | 实现原理                       | 配置要求         |
    | ------------ | ------------------------------ | ---------------- |
    | IP段白名单   | 来自指定IP段的请求自动认证     | 配置内网IP段     |
    | 域账号集成   | 对接AD/LDAP，Windows域账号认证 | 配置AD/LDAP连接  |
    | 企业应用内嵌 | 从企业微信/钉钉进入自动登录    | 配置企业应用集成 |

    表 5.1.4.5-1 企业内免密登录方式

#### 5.1.4.6 扫码登录

+   扫码登录适用于PC端（WEB/DESKTOP），需要移动端App配合。

    | 角色   | 终端        | 操作                 | 适用用户群 |
    | ------ | ----------- | -------------------- | ---------- |
    | PC端   | WEB/DESKTOP | 展示二维码，轮询状态 | UR/UC      |
    | 移动端 | IOS/ANDROID | 扫码、确认登录       | UR/UC      |

    表 5.1.4.6-1 扫码登录角色

+   扫码登录状态流转如下。

    | 状态      | 说明                | PC端展示             |
    | --------- | ------------------- | -------------------- |
    | PENDING   | 等待扫码            | 显示二维码           |
    | SCANNED   | 已扫码，待确认      | 提示"已扫码，请确认" |
    | CONFIRMED | 已确认              | 登录成功             |
    | CANCELLED | 用户取消            | 提示"已取消"         |
    | EXPIRED   | 二维码过期（2分钟） | 提示刷新二维码       |

    表 5.1.4.6-2 扫码登录状态

#### 5.1.4.7 生物识别

+   生物识别仅适用于C端用户群（UC）移动端App，作为快捷登录方式。

    | 识别方式 | 适用终端 | 前提条件         | 说明                  |
    | -------- | -------- | ---------------- | --------------------- |
    | Face ID  | IOS      | 用户已登录并开启 | iPhone X及以上        |
    | Touch ID | IOS      | 用户已登录并开启 | 带指纹识别的iPhone    |
    | 指纹识别 | ANDROID  | 用户已登录并开启 | 支持指纹的Android设备 |

    表 5.1.4.7-1 生物识别方式

+   生物识别使用规则。
    -   **必须先完成一次完整登录**：生物识别是快捷登录，首次需第三方或验证码登录
    -   **本地验证+服务端确认**：生物识别在本地完成，成功后使用本地存储的凭证向服务端换取令牌
    -   **有效期限制**：生物识别授权有效期30天，过期需重新完整登录
    -   **安全降级**：连续失败3次后降级为完整登录

### 5.1.5 令牌与会话管理

+   令牌和会话管理需要根据用户群和终端类型进行差异化配置。

#### 5.1.5.1 令牌配置对比

+   三侧令牌配置对比如下表所示。

    | 配置项              | 运营用户群（UP） | 租户用户群（UR） | C端用户群（UC） |
    | ------------------- | ---------------- | ---------------- | --------------- |
    | Access Token有效期  | 15分钟           | 30分钟（可配置） | 2小时           |
    | Refresh Token有效期 | 4小时            | 8小时（可配置）  | 30天            |
    | 令牌签名算法        | RS256            | RS256            | RS256           |
    | 令牌存储方式        | HttpOnly Cookie  | HttpOnly Cookie  | 终端自行存储    |

    表 5.1.5.1-1 三侧令牌配置

#### 5.1.5.2 会话配置对比

+   三侧会话配置对比如下表所示。

    | 配置项       | 运营用户群（UP） | 租户用户群（UR）     | C端用户群（UC） |
    | ------------ | ---------------- | -------------------- | --------------- |
    | 会话绝对超时 | 4小时            | 8小时（可配置）      | 30天            |
    | 会话空闲超时 | 15分钟           | 30分钟（可配置）     | 不限制          |
    | 多端登录策略 | 单设备           | 同类型互斥（可配置） | 不限制          |
    | 会话续期     | 不支持           | 支持                 | 支持            |
    | 记住登录     | 不支持           | 支持（可配置）       | 默认开启        |

    表 5.1.5.2-1 三侧会话配置

#### 5.1.5.3 终端类型与令牌存储

+   不同终端类型的令牌存储方式如下表所示。

    | 终端类型 | Access Token存储     | Refresh Token存储   | 说明           |
    | -------- | -------------------- | ------------------- | -------------- |
    | WEB      | 内存/HttpOnly Cookie | HttpOnly Cookie     | 防XSS攻击      |
    | H5       | 内存                 | 内存                | 页面关闭即失效 |
    | IOS      | Keychain             | Keychain            | 系统安全存储   |
    | ANDROID  | EncryptedSharedPref  | EncryptedSharedPref | 加密存储       |
    | MINIAPP  | Storage              | Storage             | 小程序存储     |
    | DESKTOP  | 安全存储             | 安全存储            | 平台相关       |

    表 5.1.5.3-1 终端类型与令牌存储

### 5.1.6 认证安全

+   认证安全措施需要根据用户群差异化配置。

#### 5.1.6.1 登录失败处理

+   三侧登录失败处理策略如下表所示。

    | 失败次数 | 运营用户群（UP） | 租户用户群（UR）    | C端用户群（UC） |
    | -------- | ---------------- | ------------------- | --------------- |
    | 1-2次    | 提示错误         | 提示错误            | 提示错误        |
    | 3次      | 要求图形验证码   | 要求图形验证码      | 提示错误        |
    | 5次      | 锁定15分钟       | 锁定5分钟（可配置） | 要求图形验证码  |
    | 10次     | 锁定1小时        | 锁定15分钟          | 锁定5分钟       |
    | 20次     | 锁定24小时       | 锁定1小时           | 锁定15分钟      |

    表 5.1.6.1-1 登录失败处理策略

#### 5.1.6.2 风险登录处理

+   检测到风险登录时的处理措施如下表所示。

    | 风险类型       | 检测方式       | 处理措施           | 适用用户群 |
    | -------------- | -------------- | ------------------ | ---------- |
    | 新设备登录     | 设备指纹不匹配 | 发送通知、额外验证 | UP/UR      |
    | 异地登录       | IP地理位置变化 | 发送通知           | UP/UR      |
    | 异常时间登录   | 非常用时段     | 要求额外验证       | UP         |
    | 高风险IP       | IP信誉库匹配   | 增强验证或阻止     | UP/UR      |
    | 短时间多次失败 | 频率检测       | 临时锁定           | UP/UR/UC   |

    表 5.1.6.2-1 风险登录处理

### 5.1.7 场景与流程映射

+   认证管理各场景与业务流程的对应关系如下表所示。

    | 场景分类   | 子分类     | 操作场景               | 对应流程      | 适用用户群 |
    | ---------- | ---------- | ---------------------- | ------------- | ---------- |
    | 密码认证   | 登录       | 用户名 + 密码登录      | FL-AUTH-01    | UP/UR/UC   |
    | 密码认证   | 双因素登录 | 用户名 + 密码 + 短信   | FL-AUTH-02    | UP/UR      |
    | 验证码认证 | 登录       | 用户名 + 短信验证码    | FL-AUTH-03    | UR/UC      |
    | 第三方认证 | 社交登录   | 微信/钉钉/QQ登录       | FL-AUTH-04    | UC         |
    | 第三方认证 | 企业身份源 | 企业微信/钉钉/飞书登录 | FL-AUTH-05    | UR         |
    | SSO认证    | 单点登录   | SSO登录                | FL-AUTH-06    | UR         |
    | 免密认证   | 企业内免密 | IP白名单/域账号登录    | FL-AUTH-07    | UR         |
    | 扫码认证   | 扫码登录   | PC扫码登录             | FL-AUTH-08    | UR/UC      |
    | 生物识别   | 快捷登录   | 指纹/面容登录          | FL-AUTH-09    | UC         |
    | 令牌管理   | 签发       | 令牌签发               | FL-TOKEN-01   | UP/UR/UC   |
    | 令牌管理   | 刷新       | 令牌刷新               | FL-TOKEN-02   | UP/UR/UC   |
    | 令牌管理   | 撤销       | 令牌撤销/登出          | FL-TOKEN-03   | UP/UR/UC   |
    | 会话管理   | 会话       | 会话创建与管理         | FL-SESSION-01 | UP/UR/UC   |

    表 5.1.7-1 场景与流程映射

## 5.2 业务流程设计

+   本节设计认证管理的业务流程，覆盖三侧用户的各类认证场景。
+   流程编号规则：FL-AUTH-xx（认证流程）、FL-TOKEN-xx（令牌流程）、FL-SESSION-xx（会话流程）。

### 5.2.0 租户用户登录输入与路由机制

+   本节描述租户用户群（UR）登录时租户标识的输入格式、前端解析规则和后端数据源路由机制。

#### 5.2.0.1 登录输入格式说明

+   租户用户登录时需要提供租户标识（tenantCode）和用户名（username），系统支持以下输入方式。

    | 输入方式     | 格式示例            | 适用场景           | 说明                           |
    | ------------ | ------------------- | ------------------ | ------------------------------ |
    | 组合格式输入 | `acme\zhangsan`     | SaaS多租户场景     | 用户在用户名输入框输入组合格式 |
    | 分离输入     | 租户编码+用户名分开 | 租户选择下拉框场景 | 前端提供租户选择器             |
    | 默认租户输入 | `zhangsan`          | 私有化单租户场景   | 系统配置默认租户编码           |

    表 5.2.0.1-1 登录输入格式

+   **组合格式规则**
    -   分隔符使用反斜杠 `\`，与Windows域账号格式一致
    -   格式：`{tenantCode}\{username}`
    -   示例：`acme\zhangsan` 表示租户编码为 `acme`，用户名为 `zhangsan`
    -   用户名中不应包含反斜杠字符

#### 5.2.0.2 前端解析规则

+   前端负责解析用户输入，提取tenantCode和username后分别传入API请求参数。

+   解析规则如下表所示。

    | 输入内容        | 解析结果                             | 说明                     |
    | --------------- | ------------------------------------ | ------------------------ |
    | `acme\zhangsan` | tenantCode=acme, username=zhangsan   | 标准组合格式解析         |
    | `zhangsan`      | tenantCode=默认值, username=zhangsan | 使用系统配置默认租户编码 |
    | `a\b\c`         | tenantCode=a, username=b\c           | 仅第一个\为分隔符        |

    表 5.2.0.2-1 前端解析规则

+   **前端处理伪代码**

    ```javascript
    function parseLoginInput(input, defaultTenantCode) {
      const separatorIndex = input.indexOf('\\');
      if (separatorIndex > 0) {
        return {
          tenantCode: input.substring(0, separatorIndex),
          username: input.substring(separatorIndex + 1)
        };
      }
      return {
        tenantCode: defaultTenantCode || '',
        username: input
      };
    }
    ```

#### 5.2.0.3 后端数据源路由机制

+   后端根据tenantCode查询租户信息获取tenant_id，再以tenant_id进行数据源路由，连接到对应的租户数据库。

+   路由流程如下表所示。

    | 步骤 | 操作           | 输入       | 输出                    | 异常处理                 |
    | ---- | -------------- | ---------- | ----------------------- | ------------------------ |
    | 1    | 接收登录请求   | tenantCode | -                       | tenantCode为空则拒绝     |
    | 2    | 查询租户信息   | tenantCode | 租户记录（含tenant_id） | 租户不存在返回E-404002   |
    | 3    | 检查租户状态   | 租户状态   | 校验结果                | 租户已禁用返回E-403003   |
    | 4    | 获取数据源连接 | tenant_id  | 数据源                  | 数据源不可用返回E-503001 |
    | 5    | 设置租户上下文 | 租户信息   | ThreadLocal存储         | -                        |
    | 6    | 执行认证逻辑   | username等 | 认证结果                | 参见FL-AUTH-01           |

    表 5.2.0.3-1 数据源路由流程

+   **数据源路由规则**
    -   数据库名称格式：`clarisphere_t{tenant_id}`
    -   示例：tenantCode=acme → 查询获得tenant_id=789 → 连接数据库 `clarisphere_t789`
    -   租户信息缓存：从platform库的platform_tenant表查询，结果缓存5分钟

#### 5.2.0.4 登录处理流程图

+   租户用户登录完整处理流程如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      租户用户登录处理流程                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │  用户输入: acme\zhangsan                                        │      │
    │    │  (或分离输入: 租户编码 + 用户名)                                │      │
    │    └────────────────────────────┬────────────────────────────────────┘      │
    │                                 │                                           │
    │                                 ▼                                           │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │  [前端] 解析输入                                                │      │
    │    │  tenantCode = "acme"                                            │      │
    │    │  username = "zhangsan"                                          │      │
    │    └────────────────────────────┬────────────────────────────────────┘      │
    │                                 │                                           │
    │                                 ▼                                           │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │  [前端] 发送登录请求                                            │      │
    │    │  POST /api/v1/ur/auth/login/password                            │      │
    │    │  { tenantCode: "acme", username: "zhangsan", password: "..." }  │      │
    │    └────────────────────────────┬────────────────────────────────────┘      │
    │                                 │                                           │
    │                                 ▼                                           │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │  [后端] 查询租户信息 (platform库.platform_tenant表)             │      │
    │    │  SELECT * FROM platform_tenant WHERE tenant_code = 'acme'       │      │
    │    └────────────────────────────┬────────────────────────────────────┘      │
    │                                 │                                           │
    │                     ┌───────────┴───────────┐                               │
    │                     ▼                       ▼                               │
    │              租户不存在?                租户存在                            │
    │                     │                       │                               │
    │                     ▼                       ▼                               │
    │              ┌──────────────┐      ┌─────────────────┐                      │
    │              │ 返回E-404002 │      │ 检查租户状态    │                      │
    │              │ 租户不存在   │      └────────┬────────┘                      │
    │              └──────────────┘               │                               │
    │                                 ┌───────────┴───────────┐                   │
    │                                 ▼                       ▼                   │
    │                          租户已禁用?              租户状态正常              │
    │                                 │                       │                   │
    │                                 ▼                       ▼                   │
    │                          ┌──────────────┐      ┌─────────────────┐          │
    │                          │ 返回E-403003 │      │ 路由数据源      │          │
    │                          │ 租户已禁用   │      │ clarisphere_t789│          │
    │                          └──────────────┘      └────────┬────────┘          │
    │                                                         │                   │
    │                                                         ▼                   │
    │                                                ┌─────────────────┐          │
    │                                                │ 执行认证逻辑    │          │
    │                                                │ (FL-AUTH-01)    │          │
    │                                                └────────┬────────┘          │
    │                                                         │                   │
    │                                                         ▼                   │
    │                                                ┌─────────────────┐          │
    │                                                │ 签发Token       │          │
    │                                                │ (含tenantId+tenantCode)    │
    │                                                └────────┬────────┘          │
    │                                                         │                   │
    │                                                         ▼                   │
    │                                                ┌─────────────────┐          │
    │                                                │ 返回登录结果    │          │
    │                                                └────────┬────────┘          │
    │                                                         │                   │
    │                                                         ▼                   │
    │                                                    ┌─────────┐              │
    │                                                    │  结束   │              │
    │                                                    └─────────┘              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.0.4-1 租户用户登录处理流程图

#### 5.2.0.5 私有化部署默认租户配置

+   私有化部署场景支持配置默认租户编码，简化用户登录操作。

+   配置说明如下表所示。

    | 配置项                          | 默认值 | 说明                             |
    | ------------------------------- | ------ | -------------------------------- |
    | system.auth.defaultTenantCode   | 空     | 默认租户编码，为空则要求用户输入 |
    | system.auth.allowTenantOverride | true   | 是否允许用户覆盖默认租户编码     |

    表 5.2.0.5-1 私有化部署默认租户配置

+   **配置生效逻辑**
    -   若 `defaultTenantCode` 非空且用户未输入tenantCode，则使用默认值
    -   若 `allowTenantOverride` 为true，用户可通过 `tenantCode\username` 格式覆盖默认值
    -   若 `allowTenantOverride` 为false，用户输入的tenantCode被忽略，强制使用默认值

+   **典型场景配置示例**

    | 场景                 | defaultTenantCode | allowTenantOverride | 用户输入要求         |
    | -------------------- | ----------------- | ------------------- | -------------------- |
    | SaaS多租户           | 空                | true                | 必须输入tenantCode   |
    | 私有化单租户         | default           | false               | 仅输入username       |
    | 私有化多租户（默认） | primary           | true                | 可省略默认租户的编码 |

    表 5.2.0.5-2 典型场景配置示例

### 5.2.1 流程层级说明

+   认证管理流程分为三个层级。

    | 层级     | 说明               | 示例               |
    | -------- | ------------------ | ------------------ |
    | 业务流程 | 完整的认证业务流程 | 用户名密码登录流程 |
    | 子流程   | 可复用的流程片段   | 密码验证子流程     |
    | 活动     | 最小执行单元       | 校验密码哈希       |

    表 5.2.1-1 流程层级说明

+   认证流程清单如下表所示。

    | 流程编号      | 流程名称                 | 适用用户群 | 优先级 |
    | ------------- | ------------------------ | ---------- | ------ |
    | FL-AUTH-01    | 用户名密码登录           | UP/UR/UC   | P1     |
    | FL-AUTH-02    | 用户名密码短信双因素登录 | UP/UR      | P1     |
    | FL-AUTH-03    | 用户名短信验证码登录     | UR/UC      | P1     |
    | FL-AUTH-04    | 第三方社交登录           | UC         | P2     |
    | FL-AUTH-05    | 企业身份源登录           | UR         | P2     |
    | FL-AUTH-06    | SSO单点登录              | UR         | P3     |
    | FL-AUTH-07    | 企业内免密登录           | UR         | P3     |
    | FL-AUTH-08    | 扫码登录                 | UR/UC      | P2     |
    | FL-AUTH-09    | 生物识别快捷登录         | UC         | P3     |
    | FL-TOKEN-01   | 令牌签发                 | UP/UR/UC   | P1     |
    | FL-TOKEN-02   | 令牌刷新                 | UP/UR/UC   | P1     |
    | FL-TOKEN-03   | 令牌撤销（登出）         | UP/UR/UC   | P1     |
    | FL-SESSION-01 | 会话管理                 | UP/UR/UC   | P1     |

    表 5.2.1-2 认证流程清单

### 5.2.2 FL-AUTH-01 用户名密码登录流程

+   本流程适用于三侧用户的基础密码登录。

#### 5.2.2.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                                    |
    | ---------- | --------------------------------------- |
    | 流程名称   | 用户名密码登录                          |
    | 流程编号   | FL-AUTH-01                              |
    | 触发条件   | 用户在登录页面提交用户名和密码          |
    | 前置条件   | 用户已注册且账号状态正常                |
    | 后置条件   | 登录成功，签发令牌，创建会话            |
    | 适用用户群 | UP（私有化部署）、UR、UC                |
    | 适用终端   | WEB、H5、IOS、ANDROID、MINIAPP、DESKTOP |

    表 5.2.2.1-1 用户名密码登录流程概述

#### 5.2.2.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作             | 执行者 | 输入               | 输出                              | 异常处理            |
    | ---- | ---------------- | ------ | ------------------ | --------------------------------- | ------------------- |
    | 1    | 输入登录信息     | 用户   | 用户名、密码       | -                                 | -                   |
    | 2    | 解析认证上下文   | 系统   | 请求头、路径       | user_pool、tenant_code、tenant_id | 无法识别则拒绝      |
    | 3    | 校验图形验证码   | 系统   | 验证码             | 校验结果                          | 失败则提示重新输入  |
    | 4    | 路由租户数据源   | 系统   | tenant_id          | 数据源连接                        | 租户不存在则拒绝    |
    | 5    | 查找用户         | 系统   | 用户名、user_pool  | 用户信息                          | 不存在则提示错误    |
    | 6    | 检查账号状态     | 系统   | 用户状态           | 状态结果                          | 锁定/禁用则拒绝登录 |
    | 7    | 检查登录失败次数 | 系统   | 失败计数           | 是否锁定                          | 超限则临时锁定      |
    | 8    | 验证密码         | 系统   | 密码、密码哈希     | 验证结果                          | 失败则累计失败次数  |
    | 9    | 清除失败计数     | 系统   | 用户ID             | -                                 | -                   |
    | 10   | 调用令牌签发流程 | 系统   | 用户信息、上下文   | 令牌                              | 参见FL-TOKEN-01     |
    | 11   | 调用会话创建流程 | 系统   | 用户信息、设备信息 | 会话                              | 参见FL-SESSION-01   |
    | 12   | 记录登录日志     | 系统   | 登录信息           | -                                 | -                   |
    | 13   | 返回登录结果     | 系统   | 令牌、用户信息     | 响应                              | -                   |

    表 5.2.2.2-1 用户名密码登录流程步骤

#### 5.2.2.3 流程图

+   流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUTH-01 用户名密码登录                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 用户输入        │                                                      │
    │    │ 用户名、密码    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 解析认证上下文  │                                                      │
    │    │ user_pool等     │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 需要图形验证码？  ╲    否                                          │
    │       ◇───────────────────◇───────────────────┐                             │
    │             │ 是                              │                             │
    │             ▼                                 │                             │
    │    ┌─────────────────┐                        │                             │
    │    │ 校验图形验证码  │                        │                             │
    │    └────────┬────────┘                        │                             │
    │             │                                 │                             │
    │         ◇───────◇                             │                             │
    │        ╱ 通过？  ╲    否    ┌─────────────┐   │                             │
    │       ◇─────────◇─────────▶ │ 返回错误    │   │                             │
    │             │ 是            └─────────────┘   │                             │
    │             ◀─────────────────────────────────┘                             │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 查找用户        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────◇                                                           │
    │        ╱ 存在？  ╲    否    ┌───────────────────────┐                       │
    │       ◇─────────◇─────────▶ │ 返回"用户名或密码错误"│                       │
    │             │ 是            └───────────────────────┘                       │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 账号状态正常？    ╲    否    ┌──────────────────────┐              │
    │       ◇───────────────────◇─────────▶ │ 返回"账号已禁用/锁定"│              │
    │             │ 是                      └──────────────────────┘              │
    │             ▼                                                               │
    │         ◇─────────────────◇                                                 │
    │        ╱ 是否被临时锁定？  ╲    是    ┌─────────────────────┐               │
    │       ◇───────────────────◇─────────▶ │ 返回"账号临时锁定"  │               │
    │             │ 否                      └─────────────────────┘               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 验证密码        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────◇                                                           │
    │        ╱ 正确？  ╲    否    ┌─────────────────────┐                         │
    │       ◇─────────◇─────────▶ │ 累计失败次数        │                         │
    │             │ 是            │ 返回错误            │                         │
    │             │               └─────────────────────┘                         │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 清除失败计数    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 签发令牌        │                                                      │
    │    │ (FL-TOKEN-01)   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 创建会话        │                                                      │
    │    │ (FL-SESSION-01) │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 记录登录日志    │                                                      │
    │    │ 返回成功        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.2.3-1 用户名密码登录流程图

### 5.2.3 FL-AUTH-02 用户名密码短信双因素登录流程

+   本流程适用于运营用户群SaaS部署和租户用户群强制双因素场景。

#### 5.2.3.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                               |
    | ---------- | ---------------------------------- |
    | 流程名称   | 用户名密码短信双因素登录           |
    | 流程编号   | FL-AUTH-02                         |
    | 触发条件   | 用户在登录页面提交用户名和密码     |
    | 前置条件   | 用户已注册、已绑定手机号           |
    | 后置条件   | 登录成功，签发令牌，创建会话       |
    | 适用用户群 | UP（SaaS部署）、UR（配置双因素时） |
    | 适用终端   | WEB、DESKTOP                       |

    表 5.2.3.1-1 双因素登录流程概述

#### 5.2.3.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作               | 执行者 | 输入               | 输出     | 异常处理           |
    | ---- | ------------------ | ------ | ------------------ | -------- | ------------------ |
    | 1    | 输入用户名密码     | 用户   | 用户名、密码       | -        | -                  |
    | 2    | 校验图形验证码     | 系统   | 验证码             | 校验结果 | 失败则提示重新输入 |
    | 3    | 验证密码           | 系统   | 密码               | 验证结果 | 失败则累计失败次数 |
    | 4    | 生成临时票据       | 系统   | 用户ID             | 临时票据 | -                  |
    | 5    | 发送短信验证码     | 系统   | 手机号             | 发送结果 | 发送失败则提示     |
    | 6    | 返回等待输入短信码 | 系统   | 临时票据           | 响应     | -                  |
    | 7    | 输入短信验证码     | 用户   | 短信码、临时票据   | -        | -                  |
    | 8    | 校验短信验证码     | 系统   | 短信码             | 校验结果 | 失败则提示重新输入 |
    | 9    | 签发令牌           | 系统   | 用户信息           | 令牌     | -                  |
    | 10   | 创建会话           | 系统   | 用户信息、设备信息 | 会话     | -                  |
    | 11   | 返回登录成功       | 系统   | 令牌               | 响应     | -                  |

    表 5.2.3.2-1 双因素登录流程步骤

#### 5.2.3.3 流程图

+   流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                    FL-AUTH-02 用户名密码短信双因素登录                      │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐      │
    │    │ 输入用户名密码  │────▶│ 校验图形验证码  │────▶│ 验证密码        │      │
    │    └─────────────────┘     └─────────────────┘     └────────┬────────┘      │
    │                                                              │              │
    │                                                          ◇───────◇          │
    │                                                         ╱ 正确？  ╲         │
    │                                        ┌───────────────◇─────────◇          │
    │                                        │ 否                  │ 是           │
    │                                        ▼                     ▼              │
    │                            ┌─────────────────┐     ┌─────────────────┐      │
    │                            │ 返回错误        │     │ 生成临时票据    │      │
    │                            └─────────────────┘     └────────┬────────┘      │
    │                                                              │              │
    │                                                              ▼              │
    │                                                    ┌─────────────────┐      │
    │                                                    │ 发送短信验证码  │      │
    │                                                    │ 到绑定手机      │      │
    │                                                    └────────┬────────┘      │
    │                                                              │              │
    │                                                              ▼              │
    │                                                    ┌─────────────────┐      │
    │                                                    │ 返回临时票据    │      │
    │                                                    │ 等待输入短信码  │      │
    │                                                    └────────┬────────┘      │
    │                                                              │              │
    │                                                              ▼              │
    │                                                    ┌─────────────────┐      │
    │                                                    │ 用户输入短信码  │      │
    │                                                    └────────┬────────┘      │
    │                                                              │              │
    │                                                          ◇───────◇          │
    │                                                         ╱ 正确？  ╲         │
    │                                        ┌───────────────◇─────────◇          │
    │                                        │ 否                  │ 是           │
    │                                        ▼                     ▼              │
    │                            ┌─────────────────┐     ┌─────────────────┐      │
    │                            │ 返回错误        │     │ 签发令牌        │      │
    │                            │ 可重试          │     │ 创建会话        │      │
    │                            └─────────────────┘     └────────┬────────┘      │
    │                                                              │              │
    │                                                              ▼              │
    │                                                    ┌─────────┐              │
    │                                                    │  结束   │              │
    │                                                    └─────────┘              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.3.3-1 双因素登录流程图

### 5.2.4 FL-AUTH-03 用户名短信验证码登录流程

+   本流程适用于租户用户群和C端用户群的免密登录。

#### 5.2.4.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                         |
    | ---------- | ---------------------------- |
    | 流程名称   | 用户名短信验证码登录         |
    | 流程编号   | FL-AUTH-03                   |
    | 触发条件   | 用户选择短信验证码登录方式   |
    | 前置条件   | 用户已注册、手机号已验证     |
    | 后置条件   | 登录成功，签发令牌，创建会话 |
    | 适用用户群 | UR、UC                       |
    | 适用终端   | 全部终端                     |

    表 5.2.4.1-1 短信验证码登录流程概述

#### 5.2.4.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入               | 输出       | 异常处理           |
    | ---- | ------------ | ------ | ------------------ | ---------- | ------------------ |
    | 1    | 输入手机号   | 用户   | 手机号             | -          | -                  |
    | 2    | 检查发送频率 | 系统   | 手机号             | 是否可发送 | 频率过高则拒绝     |
    | 3    | 查找用户     | 系统   | 手机号、user_pool  | 用户信息   | 不存在则提示       |
    | 4    | 检查账号状态 | 系统   | 用户状态           | 状态结果   | 异常则拒绝         |
    | 5    | 生成验证码   | 系统   | -                  | 6位验证码  | -                  |
    | 6    | 发送短信     | 系统   | 手机号、验证码     | 发送结果   | 失败则提示         |
    | 7    | 存储验证码   | 系统   | 手机号、验证码     | -          | -                  |
    | 8    | 输入验证码   | 用户   | 验证码             | -          | -                  |
    | 9    | 校验验证码   | 系统   | 验证码             | 校验结果   | 失败则累计错误次数 |
    | 10   | 签发令牌     | 系统   | 用户信息           | 令牌       | -                  |
    | 11   | 创建会话     | 系统   | 用户信息、设备信息 | 会话       | -                  |
    | 12   | 返回登录成功 | 系统   | 令牌               | 响应       | -                  |

    表 5.2.4.2-1 短信验证码登录流程步骤

### 5.2.5 FL-AUTH-04 第三方社交登录流程

+   本流程适用于C端用户群用户使用微信、钉钉、QQ等社交账号登录。

#### 5.2.5.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                      |
    | ---------- | ------------------------- |
    | 流程名称   | 第三方社交登录            |
    | 流程编号   | FL-AUTH-04                |
    | 触发条件   | 用户点击社交登录按钮      |
    | 前置条件   | 已配置第三方应用          |
    | 后置条件   | 登录成功或引导绑定/注册   |
    | 适用用户群 | UC                        |
    | 适用终端   | 根据渠道不同（见5.1.3.3） |

    表 5.2.5.1-1 社交登录流程概述

#### 5.2.5.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作             | 执行者 | 输入               | 输出             | 异常处理       |
    | ---- | ---------------- | ------ | ------------------ | ---------------- | -------------- |
    | 1    | 点击社交登录按钮 | 用户   | 渠道类型           | -                | -              |
    | 2    | 生成授权URL      | 系统   | 渠道、回调地址     | 授权URL          | -              |
    | 3    | 跳转授权页面     | 系统   | 授权URL            | -                | -              |
    | 4    | 用户授权         | 用户   | -                  | 授权码           | 用户取消则返回 |
    | 5    | 接收回调         | 系统   | 授权码             | -                | -              |
    | 6    | 换取AccessToken  | 系统   | 授权码             | access_token     | 失败则提示重试 |
    | 7    | 获取用户信息     | 系统   | access_token       | openid、用户信息 | 失败则提示重试 |
    | 8    | 查找绑定关系     | 系统   | 渠道、openid       | 绑定记录         | -              |
    | 9a   | 已绑定：获取用户 | 系统   | 绑定记录           | 用户信息         | -              |
    | 9b   | 未绑定：自动注册 | 系统   | 第三方用户信息     | 新用户           | -              |
    | 10   | 签发令牌         | 系统   | 用户信息           | 令牌             | -              |
    | 11   | 创建会话         | 系统   | 用户信息、设备信息 | 会话             | -              |
    | 12   | 返回登录成功     | 系统   | 令牌               | 响应             | -              |

    表 5.2.5.2-1 社交登录流程步骤

#### 5.2.5.3 流程图

+   流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                       FL-AUTH-04 第三方社交登录                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 用户点击        │                                                      │
    │    │ 微信/钉钉/QQ    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 跳转第三方      │                                                      │
    │    │ 授权页面        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────────◇                                                       │
    │        ╱ 用户授权？   ╲                                                     │
    │       ◇──────────────◇                                                      │
    │        │ 否       │ 是                                                      │
    │        ▼          ▼                                                         │
    │    ┌───────┐  ┌─────────────────┐                                           │
    │    │ 返回  │  │ 回调携带授权码  │                                           │
    │    │ 取消  │  └────────┬────────┘                                           │
    │    └───────┘           │                                                    │
    │                        ▼                                                    │
    │               ┌─────────────────┐                                           │
    │               │ 换取AccessToken │                                           │
    │               │ 获取用户信息    │                                           │
    │               └────────┬────────┘                                           │
    │                        │                                                    │
    │                        ▼                                                    │
    │               ┌─────────────────┐                                           │
    │               │ 查找绑定关系    │                                           │
    │               │ (渠道+openid)   │                                           │
    │               └────────┬────────┘                                           │
    │                        │                                                    │
    │                ┌───────┴───────┐                                            │
    │                │               │                                            │
    │            已绑定▼           未绑定▼                                        │
    │        ┌───────────┐    ┌───────────────┐                                   │
    │        │ 获取已有  │    │ 自动创建用户  │                                   │
    │        │ 用户信息  │    │ 创建绑定关系  │                                   │
    │        └─────┬─────┘    └───────┬───────┘                                   │
    │              │                  │                                           │
    │              └────────┬─────────┘                                           │
    │                       │                                                     │
    │                       ▼                                                     │
    │              ┌─────────────────┐                                            │
    │              │ 签发令牌        │                                            │
    │              │ 创建会话        │                                            │
    │              └────────┬────────┘                                            │
    │                       │                                                     │
    │                       ▼                                                     │
    │              ┌─────────┐                                                    │
    │              │  结束   │                                                    │
    │              └─────────┘                                                    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.5.3-1 社交登录流程图

### 5.2.6 FL-AUTH-05 企业身份源登录流程

+   本流程适用于租户用户群用户通过企业微信、钉钉、飞书等企业身份源登录。

#### 5.2.6.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                   |
    | ---------- | ---------------------- |
    | 流程名称   | 企业身份源登录         |
    | 流程编号   | FL-AUTH-05             |
    | 触发条件   | 用户选择企业身份源登录 |
    | 前置条件   | 租户已配置企业身份源   |
    | 后置条件   | 登录成功或自动创建用户 |
    | 适用用户群 | UR                     |
    | 适用终端   | WEB、H5、企业App内嵌   |

    表 5.2.6.1-1 企业身份源登录流程概述

#### 5.2.6.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作             | 执行者 | 输入               | 输出       | 异常处理           |
    | ---- | ---------------- | ------ | ------------------ | ---------- | ------------------ |
    | 1    | 识别租户         | 系统   | 域名/参数          | tenant_id  | 无法识别则拒绝     |
    | 2    | 加载身份源配置   | 系统   | tenant_id          | 身份源配置 | 未配置则不显示入口 |
    | 3    | 用户选择身份源   | 用户   | 身份源类型         | -          | -                  |
    | 4    | 跳转企业IdP      | 系统   | IdP地址            | -          | -                  |
    | 5    | 用户在IdP认证    | 用户   | 企业账号密码       | -          | -                  |
    | 6    | IdP回调          | 系统   | 身份信息           | 员工标识   | -                  |
    | 7    | 匹配租户用户     | 系统   | 员工标识           | 用户信息   | -                  |
    | 8a   | 已存在：直接登录 | 系统   | 用户信息           | -          | -                  |
    | 8b   | 不存在：自动创建 | 系统   | 员工信息           | 新用户     | 若未开启则拒绝     |
    | 9    | 签发令牌         | 系统   | 用户信息           | 令牌       | -                  |
    | 10   | 创建会话         | 系统   | 用户信息、设备信息 | 会话       | -                  |

    表 5.2.6.2-1 企业身份源登录流程步骤

### 5.2.7 FL-AUTH-06 SSO单点登录流程

+   本流程适用于租户用户群通过SSO协议对接外部IdP。

#### 5.2.7.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                     |
    | ---------- | ------------------------ |
    | 流程名称   | SSO单点登录              |
    | 流程编号   | FL-AUTH-06               |
    | 触发条件   | 用户访问租户系统，未登录 |
    | 前置条件   | 租户已配置SSO            |
    | 后置条件   | 登录成功，创建本地会话   |
    | 适用用户群 | UR                       |
    | 适用终端   | WEB                      |

    表 5.2.7.1-1 SSO单点登录流程概述

#### 5.2.7.2 流程图

+   SSO登录流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                         FL-AUTH-06 SSO单点登录                              │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  用户浏览器              本系统(SP)                  企业IdP                │
    │      │                      │                          │                    │
    │      │  1.访问租户系统      │                          │                    │
    │      │─────────────────────▶│                          │                    │
    │      │                      │                          │                    │
    │      │                      │ 2.检测未登录             │                    │
    │      │                      │   加载SSO配置            │                    │
    │      │                      │                          │                    │
    │      │  3.重定向到IdP       │                          │                    │
    │      │◀─────────────────────│                          │                    │
    │      │                      │                          │                    │
    │      │  4.携带认证请求      │                          │                    │
    │      │────────────────────────────────────────────────▶│                    │
    │      │                      │                          │                    │
    │      │                      │              5.用户在IdP完成认证              │
    │      │◀────────────────────────────────────────────────│                    │
    │      │                      │                          │                    │
    │      │  6.携带令牌/断言     │                          │                    │
    │      │─────────────────────▶│                          │                    │
    │      │                      │                          │                    │
    │      │                      │ 7.验证令牌/断言          │                    │
    │      │                      │ 8.查找/创建用户          │                    │
    │      │                      │ 9.签发本地令牌           │                    │
    │      │                      │ 10.创建会话              │                    │
    │      │                      │                          │                    │
    │      │  11.返回登录成功     │                          │                    │
    │      │◀─────────────────────│                          │                    │
    │      │                      │                          │                    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.7.2-1 SSO单点登录流程图

### 5.2.8 FL-AUTH-07 企业内免密登录流程

+   本流程适用于租户用户群企业内网环境的免密登录。

#### 5.2.8.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                   |
    | ---------- | ---------------------- |
    | 流程名称   | 企业内免密登录         |
    | 流程编号   | FL-AUTH-07             |
    | 触发条件   | 用户从企业内网访问系统 |
    | 前置条件   | 租户已配置免密规则     |
    | 后置条件   | 自动登录成功           |
    | 适用用户群 | UR                     |
    | 适用终端   | WEB、企业应用内嵌      |

    表 5.2.8.1-1 企业内免密登录流程概述

#### 5.2.8.2 免密方式

+   支持三种免密方式。

    | 免密方式     | 实现原理                  | 流程差异     |
    | ------------ | ------------------------- | ------------ |
    | IP段白名单   | 检测请求IP是否在白名单内  | 需输入用户名 |
    | 域账号集成   | 获取Windows域账号自动匹配 | 完全自动     |
    | 企业应用内嵌 | 从企业微信等获取用户身份  | 完全自动     |

    表 5.2.8.2-1 免密方式

#### 5.2.8.3 流程步骤（IP白名单方式）

+   IP白名单方式流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入               | 输出         | 异常处理         |
    | ---- | ------------ | ------ | ------------------ | ------------ | ---------------- |
    | 1    | 用户访问系统 | 用户   | -                  | -            | -                |
    | 2    | 获取请求IP   | 系统   | 请求头             | 客户端IP     | -                |
    | 3    | 检查IP白名单 | 系统   | IP、租户配置       | 是否在白名单 | 不在则走正常登录 |
    | 4    | 输入用户名   | 用户   | 用户名             | -            | -                |
    | 5    | 查找用户     | 系统   | 用户名             | 用户信息     | 不存在则提示     |
    | 6    | 签发令牌     | 系统   | 用户信息           | 令牌         | -                |
    | 7    | 创建会话     | 系统   | 用户信息、设备信息 | 会话         | -                |

    表 5.2.8.3-1 IP白名单免密登录流程步骤

### 5.2.9 FL-AUTH-08 扫码登录流程

+   本流程适用于PC端通过移动端扫码完成登录。

#### 5.2.9.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                                         |
    | ---------- | -------------------------------------------- |
    | 流程名称   | 扫码登录                                     |
    | 流程编号   | FL-AUTH-08                                   |
    | 触发条件   | 用户在PC端选择扫码登录                       |
    | 前置条件   | 用户已在移动端登录                           |
    | 后置条件   | PC端登录成功                                 |
    | 适用用户群 | UR、UC                                       |
    | 适用终端   | WEB/DESKTOP（展示端）、IOS/ANDROID（扫码端） |

    表 5.2.9.1-1 扫码登录流程概述

#### 5.2.9.2 流程图

+   扫码登录流程图如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          FL-AUTH-08 扫码登录                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  PC浏览器                   服务端                      移动端App           │
    │      │                        │                            │                │
    │      │  1.请求二维码          │                            │                │
    │      │───────────────────────▶│                            │                │
    │      │                        │                            │                │
    │      │  2.返回二维码+ticket   │                            │                │
    │      │◀───────────────────────│                            │                │
    │      │                        │                            │                │
    │      │  3.展示二维码          │                            │                │
    │      │  4.开始轮询状态        │                            │                │
    │      │───────────────────────▶│                            │                │
    │      │                        │                            │                │
    │      │                        │    5.扫描二维码            │                │
    │      │                        │◀───────────────────────────│                │
    │      │                        │                            │                │
    │      │                        │    6.返回登录信息          │                │
    │      │                        │───────────────────────────▶│                │
    │      │                        │                            │                │
    │      │                        │    7.用户确认登录          │                │
    │      │                        │◀───────────────────────────│                │
    │      │                        │                            │                │
    │      │  8.轮询获取到CONFIRMED │                            │                │
    │      │◀───────────────────────│                            │                │
    │      │                        │                            │                │
    │      │  9.使用ticket换取令牌  │                            │                │
    │      │───────────────────────▶│                            │                │
    │      │                        │                            │                │
    │      │  10.返回令牌           │                            │                │
    │      │◀───────────────────────│                            │                │
    │      │                        │                            │                │
    │      │  11.登录成功           │                            │                │
    │      │                        │                            │                │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.2.9.2-1 扫码登录流程图

### 5.2.10 FL-AUTH-09 生物识别快捷登录流程

+   本流程适用于C端用户群App端的快捷登录。

#### 5.2.10.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                               |
    | ---------- | ---------------------------------- |
    | 流程名称   | 生物识别快捷登录                   |
    | 流程编号   | FL-AUTH-09                         |
    | 触发条件   | 用户在App端选择指纹/面容登录       |
    | 前置条件   | 用户已开启生物识别、本地有有效凭证 |
    | 后置条件   | 登录成功                           |
    | 适用用户群 | UC                                 |
    | 适用终端   | IOS、ANDROID                       |

    表 5.2.10.1-1 生物识别快捷登录流程概述

#### 5.2.10.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作         | 执行者 | 输入          | 输出          | 异常处理         |
    | ---- | ------------ | ------ | ------------- | ------------- | ---------------- |
    | 1    | 打开App      | 用户   | -             | -             | -                |
    | 2    | 检查本地凭证 | App    | -             | 凭证状态      | 无效则走完整登录 |
    | 3    | 弹出生物识别 | App    | -             | -             | -                |
    | 4    | 用户验证     | 用户   | 指纹/面容     | 验证结果      | 失败则重试或降级 |
    | 5    | 获取本地凭证 | App    | -             | refresh_token | -                |
    | 6    | 请求刷新令牌 | App    | refresh_token | 新令牌        | 失效则走完整登录 |
    | 7    | 登录成功     | App    | -             | -             | -                |

    表 5.2.10.2-1 生物识别快捷登录流程步骤

### 5.2.11 FL-TOKEN-01 令牌签发流程

+   本流程在认证成功后调用，负责签发访问令牌和刷新令牌。

#### 5.2.11.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                            |
    | ---------- | ------------------------------- |
    | 流程名称   | 令牌签发                        |
    | 流程编号   | FL-TOKEN-01                     |
    | 触发条件   | 认证成功后调用                  |
    | 前置条件   | 用户身份已验证                  |
    | 后置条件   | 返回access_token和refresh_token |
    | 适用用户群 | UP/UR/UC                        |

    表 5.2.11.1-1 令牌签发流程概述

#### 5.2.11.2 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作                | 执行者 | 输入             | 输出          |
    | ---- | ------------------- | ------ | ---------------- | ------------- |
    | 1    | 获取用户信息        | 系统   | 用户ID           | 用户详情      |
    | 2    | 获取令牌配置        | 系统   | user_pool        | 有效期等配置  |
    | 3    | 构建Payload         | 系统   | 用户信息、上下文 | JWT Payload   |
    | 4    | 签名生成AccessToken | 系统   | Payload、私钥    | access_token  |
    | 5    | 生成RefreshToken    | 系统   | 用户ID、设备ID   | refresh_token |
    | 6    | 存储RefreshToken    | 系统   | refresh_token    | -             |
    | 7    | 返回令牌            | 系统   | 两个令牌         | 响应          |

    表 5.2.11.2-1 令牌签发流程步骤

### 5.2.12 FL-TOKEN-02 令牌刷新流程

+   本流程用于使用refresh_token获取新的access_token。

#### 5.2.12.1 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作                   | 执行者 | 输入          | 输出            | 异常处理           |
    | ---- | ---------------------- | ------ | ------------- | --------------- | ------------------ |
    | 1    | 提交刷新请求           | 客户端 | refresh_token | -               | -                  |
    | 2    | 验证refresh_token      | 系统   | refresh_token | 验证结果        | 无效则要求重新登录 |
    | 3    | 检查是否在黑名单       | 系统   | token_id      | 是否撤销        | 已撤销则拒绝       |
    | 4    | 获取用户信息           | 系统   | 用户ID        | 用户详情        | -                  |
    | 5    | 检查用户状态           | 系统   | 用户状态      | 是否正常        | 异常则拒绝         |
    | 6    | 签发新AccessToken      | 系统   | 用户信息      | 新access_token  | -                  |
    | 7    | 可选：轮换RefreshToken | 系统   | -             | 新refresh_token | -                  |
    | 8    | 返回新令牌             | 系统   | 令牌          | 响应            | -                  |

    表 5.2.12.1-1 令牌刷新流程步骤

### 5.2.13 FL-TOKEN-03 令牌撤销流程（登出）

+   本流程用于用户登出或管理员强制下线。

#### 5.2.13.1 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作                    | 执行者 | 输入               | 输出             |
    | ---- | ----------------------- | ------ | ------------------ | ---------------- |
    | 1    | 发起登出请求            | 用户   | access_token       | -                |
    | 2    | 解析令牌                | 系统   | access_token       | token_id、用户ID |
    | 3    | 将令牌加入黑名单        | 系统   | token_id、过期时间 | -                |
    | 4    | 撤销关联的refresh_token | 系统   | 用户ID、设备ID     | -                |
    | 5    | 销毁会话                | 系统   | session_id         | -                |
    | 6    | 清理客户端存储          | 客户端 | -                  | -                |
    | 7    | 记录登出日志            | 系统   | 登出信息           | -                |

    表 5.2.13.1-1 令牌撤销流程步骤

### 5.2.14 FL-SESSION-01 会话管理流程

+   本流程负责会话的创建、维护和销毁。

#### 5.2.14.1 会话创建

+   会话创建步骤如下表所示。

    | 步骤 | 操作             | 执行者 | 输入             | 输出           |
    | ---- | ---------------- | ------ | ---------------- | -------------- |
    | 1    | 收集设备信息     | 系统   | User-Agent、IP   | 设备详情       |
    | 2    | 生成会话ID       | 系统   | -                | session_id     |
    | 3    | 检查多端登录策略 | 系统   | user_pool配置    | 是否踢出旧会话 |
    | 4    | 踢出冲突会话     | 系统   | 用户ID、设备类型 | -              |
    | 5    | 创建会话记录     | 系统   | 会话信息         | 会话           |
    | 6    | 设置会话超时     | 系统   | 超时配置         | -              |

    表 5.2.14.1-1 会话创建步骤

#### 5.2.14.2 多端登录策略执行

+   多端登录策略执行规则如下表所示。

    | 策略       | 运营用户群（UP）     | 租户用户群（UR） | C端用户群（UC） |
    | ---------- | -------------------- | ---------------- | --------------- |
    | 单设备     | 新登录踢出所有旧会话 | -                | -               |
    | 同类型互斥 | -                    | 新WEB踢出旧WEB   | -               |
    | 不限制     | -                    | -                | 不踢出          |

    表 5.2.14.2-1 多端登录策略执行

## 5.3 领域模型设计

+   本节设计认证管理子领域的领域模型，包括聚合划分、实体、值对象、领域服务、领域事件和协作关系。
+   认证管理领域模型需要支持三侧用户体系，数据分别存储在平台库和租户库。

### 5.3.1 聚合划分

+   认证管理子领域划分为6个聚合。

    | 聚合名称         | 聚合根           | 职责                 | 存储位置      |
    | ---------------- | ---------------- | -------------------- | ------------- |
    | Credential       | Credential       | 用户凭证管理（密码） | 平台库/租户库 |
    | LoginAttempt     | LoginAttempt     | 登录尝试记录与锁定   | 平台库/租户库 |
    | Token            | Token            | 令牌签发与管理       | Redis         |
    | Session          | Session          | 会话管理             | Redis         |
    | SocialConnection | SocialConnection | 第三方社交账号绑定   | 平台库        |
    | VerificationCode | VerificationCode | 验证码管理           | Redis         |

    表 5.3.1-1 认证管理聚合划分

+   聚合划分原则说明。
    -   **Credential聚合**：管理用户密码凭证，与用户一一对应，但独立存储
    -   **LoginAttempt聚合**：记录登录尝试，用于失败锁定和安全审计
    -   **Token聚合**：管理JWT令牌的签发、刷新和撤销
    -   **Session聚合**：管理用户登录会话和设备信息
    -   **SocialConnection聚合**：管理C端用户群用户的第三方账号绑定
    -   **VerificationCode聚合**：管理短信/邮件验证码的生成和验证

### 5.3.2 聚合关系图

+   认证管理各聚合之间的关系如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          认证管理领域模型                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                         用户管理领域                            │      │
    │    │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │      │
    │    │   │PlatformUser │  │ TenantUser  │  │ConsumerUser │             │      │
    │    │   │  (UP)       │  │   (UR)      │  │   (UC)      │             │      │
    │    │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │      │
    │    └──────────┼────────────────┼────────────────┼────────────────────┘      │
    │               │                │                │                           │
    │               │ userId         │ userId         │ userId                    │
    │               │                │                │                           │
    │    ┌──────────┼────────────────┼────────────────┼────────────────────┐      │
    │    │          ▼                ▼                ▼                    │      │
    │    │   ┌─────────────────────────────────────────────────────┐       │      │
    │    │   │                  Credential 聚合                    │       │      │
    │    │   │  ┌───────────────────────────────────────────────┐  │       │      │
    │    │   │  │ Credential (聚合根)                           │  │       │      │
    │    │   │  │ - userId, userPool, passwordHash, ...         │  │       │      │
    │    │   │  └───────────────────────────────────────────────┘  │       │      │
    │    │   └─────────────────────────────────────────────────────┘       │      │
    │    │                                                                 │      │
    │    │   ┌─────────────────┐  ┌─────────────────┐                      │      │
    │    │   │ LoginAttempt    │  │VerificationCode │                      │      │
    │    │   │     聚合        │  │      聚合       │                      │      │
    │    │   │ ┌────────────┐  │  │ ┌───────────┐   │                      │      │
    │    │   │ │LoginAttempt│  │  │ │VerifyCode │   │                      │      │
    │    │   │ │ (聚合根)   │  │  │ │ (聚合根)  │   │                      │      │
    │    │   │ └────────────┘  │  │ └───────────┘   │                      │      │
    │    │   └─────────────────┘  └─────────────────┘                      │      │
    │    │                                                                 │      │
    │    │          认证成功后                                             │      │
    │    │               │                                                 │      │
    │    │               ▼                                                 │      │
    │    │   ┌─────────────────┐  ┌─────────────────┐                      │      │
    │    │   │    Token        │  │    Session      │                      │      │
    │    │   │     聚合        │  │      聚合       │                      │      │
    │    │   │ ┌────────────┐  │  │ ┌───────────┐   │                      │      │
    │    │   │ │RefreshToken│  │  │ │  Session  │   │                      │      │
    │    │   │ │ (聚合根)   │  │  │ │ (聚合根)  │   │                      │      │
    │    │   │ └────────────┘  │  │ └───────────┘   │                      │      │
    │    │   └─────────────────┘  └─────────────────┘                      │      │
    │    │                                                                 │      │
    │    │   ┌─────────────────────────────────────────────────────┐       │      │
    │    │   │              SocialConnection 聚合                  │       │      │
    │    │   │  (仅C端用户群UC)                                       │       │      │
    │    │   │  ┌───────────────────────────────────────────────┐  │       │      │
    │    │   │  │ SocialConnection (聚合根)                     │  │       │      │
    │    │   │  │ - userId, provider, openId, unionId, ...      │  │       │      │
    │    │   │  └───────────────────────────────────────────────┘  │       │      │
    │    │   └─────────────────────────────────────────────────────┘       │      │
    │    │                                                                 │      │
    │    │                        认证管理领域                             │      │
    │    └─────────────────────────────────────────────────────────────────┘      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.2-1 认证管理聚合关系图

### 5.3.3 Credential 聚合（凭证）

+   Credential聚合负责管理用户的密码凭证。

#### 5.3.3.1 聚合结构

+   Credential聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                      Credential 聚合                            │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │              Credential（聚合根/实体）              │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: CredentialId                                 │      │
    │    │  - userId: UserId                                   │      │
    │    │  - userPool: UserPool                               │      │
    │    │  - tenantId: TenantId (UR时必填)                    │      │
    │    │  - passwordHash: String                             │      │
    │    │  - passwordSalt: String                             │      │
    │    │  - algorithm: HashAlgorithm                         │      │
    │    │  - passwordSetAt: LocalDateTime                     │      │
    │    │  - passwordExpireAt: LocalDateTime                  │      │
    │    │  - mustChangePassword: Boolean                      │      │
    │    │  - historyHashes: List<String>                      │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(userId, password, policy): Credential     │      │
    │    │  + verifyPassword(password): Boolean                │      │
    │    │  + changePassword(oldPwd, newPwd, policy): void     │      │
    │    │  + resetPassword(newPwd, policy): void              │      │
    │    │  + isExpired(): Boolean                             │      │
    │    │  + requireChange(): void                            │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
    │    │   UserPool    │  │ HashAlgorithm │  │ PasswordPolicy│      │
    │    │   (枚举)      │  │    (枚举)     │  │   (值对象)    │      │
    │    ├───────────────┤  ├───────────────┤  ├───────────────┤      │
    │    │ UP - 运营用户群  │ BCRYPT        │  │ minLength     │      │
    │    │ UR - 租户用户群  │ ARGON2ID      │  │ requireUpper  │      │
    │    │ UC - C端用户群   │ SCRYPT        │  │ requireLower  │      │
    │    └───────────────┘  └───────────────┘  │ requireDigit  │      │
    │                                          │ requireSpecial│      │
    │                                          │ expireDays    │      │
    │                                          │ historyCount  │      │
    │                                          └───────────────┘      │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.3.1-1 Credential聚合结构

#### 5.3.3.2 Credential 实体

+   Credential是聚合根，管理用户的密码凭证，采用三表模型定义如下。

##### 属性清单表

| 属性               | 类型          | 约束               | 默认值         | 业务含义                            |
| ------------------ | ------------- | ------------------ | -------------- | ----------------------------------- |
| id                 | CredentialId  | 必填，主键         | AUTO_INCREMENT | 凭证唯一标识                        |
| userId             | UserId        | 必填，唯一，不可变 | -              | 关联的用户ID，一对一关系            |
| userPool           | UserPool      | 必填，枚举，不可变 | -              | 用户群标识：UP/UR/UC                |
| tenantId           | TenantId      | UR时必填，不可变   | null           | 租户ID，UR用户群时必填              |
| passwordHash       | String        | 必填，长度≤256     | -              | 密码哈希值，禁止明文存储            |
| passwordSalt       | String        | 可选，长度≤64      | null           | 密码盐值，部分算法需要              |
| algorithm          | HashAlgorithm | 必填，枚举         | ARGON2ID       | 哈希算法：ARGON2ID/BCRYPT/PBKDF2    |
| passwordSetAt      | LocalDateTime | 必填               | NOW()          | 密码设置时间                        |
| passwordExpireAt   | LocalDateTime | 可选               | null           | 密码过期时间，null表示不过期        |
| mustChangePassword | Boolean       | 必填               | false          | 是否必须修改密码（首次登录/重置后） |
| historyHashes      | List<String>  | 可选，最多保留N条  | []             | 历史密码哈希列表，用于防止重复使用  |
| createdAt          | DateTime      | 必填，不可变       | NOW()          | 创建时间                            |
| updatedAt          | DateTime      | 必填               | NOW()          | 更新时间                            |

表 5.3.3.2-1 Credential属性清单表

##### 业务规则表

| 规则编号  | 规则名称     | 规则简述                                                    | 验证时机  | 违反后果     |
| --------- | ------------ | ----------------------------------------------------------- | --------- | ------------ |
| CRED-R-01 | 一对一关联   | 每个用户有且仅有一个Credential记录                          | 创建      | 拒绝操作     |
| CRED-R-02 | 禁止明文存储 | 密码必须使用指定算法哈希存储，禁止明文                      | 创建/修改 | -            |
| CRED-R-03 | 算法按用户群 | UP/UR使用Argon2id，UC使用BCrypt                             | 创建/修改 | -            |
| CRED-R-04 | 密码策略校验 | 密码修改时必须符合对应用户群的PasswordPolicy（见PP-R-*）    | 设置/修改 | 拒绝操作     |
| CRED-R-05 | 历史密码检查 | 新密码不能与最近historyCount个密码相同（见PP-R-01）         | 修改      | 拒绝操作     |
| CRED-R-06 | 过期强制修改 | 密码过期后（passwordExpireAt < NOW）必须修改才能登录        | 登录      | 要求修改密码 |
| CRED-R-07 | 首次强制修改 | mustChangePassword=true时登录后必须修改密码                 | 登录      | 要求修改密码 |
| CRED-R-08 | 历史记录保留 | 密码修改后，旧密码哈希加入historyHashes，超出数量删除最早的 | 修改      | -            |

表 5.3.3.2-2 Credential业务规则表

##### 业务方法表

| 方法名            | 方法简述             | 关联规则                     | 异常                        | 事件              |
| ----------------- | -------------------- | ---------------------------- | --------------------------- | ----------------- |
| create()          | 创建密码凭证         | CRED-R-01,02,03,04,PP-R-*    | UserAlreadyHasCredentialExc | CredentialCreated |
| setPassword()     | 设置/重置密码        | CRED-R-02,03,04,05,08,PP-R-* | PasswordPolicyViolationExc  | PasswordChanged   |
| verifyPassword()  | 验证密码是否正确     | -                            | -                           | -                 |
| checkExpired()    | 检查密码是否过期     | CRED-R-06                    | -                           | -                 |
| checkMustChange() | 检查是否必须修改密码 | CRED-R-07                    | -                           | -                 |
| markMustChange()  | 标记为必须修改密码   | -                            | -                           | -                 |
| clearMustChange() | 清除必须修改标记     | -                            | -                           | -                 |

表 5.3.3.2-3 Credential业务方法表

+   备注：
    -   Credential与用户是一对一关系，但独立为聚合以隔离安全敏感数据
    -   PasswordPolicy为策略配置类，详见5.3.3.3节

#### 5.3.3.3 PasswordPolicy 值对象

+   PasswordPolicy值对象封装密码策略配置，**不存储在Credential表中**，而是从系统配置或租户配置中获取，采用三表模型定义如下。

##### 属性清单表

| 属性           | 类型    | 约束            | 默认值 | 业务含义                        |
| -------------- | ------- | --------------- | ------ | ------------------------------- |
| minLength      | Integer | 必填，范围6-32  | 8      | 密码最小长度                    |
| requireUpper   | Boolean | 必填            | true   | 是否要求包含大写字母            |
| requireLower   | Boolean | 必填            | true   | 是否要求包含小写字母            |
| requireDigit   | Boolean | 必填            | true   | 是否要求包含数字                |
| requireSpecial | Boolean | 必填            | false  | 是否要求包含特殊字符            |
| expireDays     | Integer | 必填，范围0-365 | 0      | 密码有效期（天），0表示永不过期 |
| historyCount   | Integer | 必填，范围0-12  | 5      | 历史密码检查数量，0表示不检查   |

表 5.3.3.3-1 PasswordPolicy属性清单表

##### 用户群默认策略表

| 用户群 | minLength | requireUpper | requireLower | requireDigit | requireSpecial | expireDays | historyCount |
| ------ | --------- | ------------ | ------------ | ------------ | -------------- | ---------- | ------------ |
| UP     | 12        | true         | true         | true         | true           | 90         | 5            |
| UR     | 8         | true         | true         | true         | false          | 0          | 5            |
| UC     | 6         | false        | false        | true         | false          | 0          | 0            |

表 5.3.3.3-2 用户群默认密码策略

##### 配置来源表

| 用户群 | 配置来源 | 配置位置                    | 是否可修改     |
| ------ | -------- | --------------------------- | -------------- |
| UP     | 系统配置 | application.yml或系统配置表 | 仅运维可改     |
| UR     | 租户配置 | 租户配置表tenant_config     | 租户管理员可改 |
| UC     | 系统配置 | application.yml或系统配置表 | 仅运维可改     |

表 5.3.3.3-3 PasswordPolicy配置来源

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                 | 验证时机 | 违反后果 |
| -------- | -------------- | -------------------------------------------------------- | -------- | -------- |
| PP-R-01  | 策略动态获取   | 密码校验时从配置源动态获取策略，不硬编码                 | 校验     | -        |
| PP-R-02  | 租户策略下限   | UR租户自定义策略不能低于平台最低要求（minLength>=6）     | 配置     | 拒绝保存 |
| PP-R-03  | 策略变更不溯及 | 策略变更后，已有密码不受影响，下次修改密码时才校验       | 登录     | -        |
| PP-R-04  | 过期时间计算   | Credential.passwordExpireAt = passwordSetAt + expireDays | 设置密码 | -        |

表 5.3.3.3-4 PasswordPolicy业务规则表

+   备注：
    -   PasswordPolicy不是Credential的存储属性，而是校验时使用的策略配置
    -   UR租户可自定义策略，但必须满足平台最低安全要求

### 5.3.4 LoginAttempt 聚合（登录尝试）

+   LoginAttempt聚合负责记录登录尝试，用于失败锁定和安全审计。

#### 5.3.4.1 聚合结构

+   LoginAttempt聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                     LoginAttempt 聚合                           │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │             LoginAttempt（聚合根/实体）             │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: AttemptId                                    │      │
    │    │  - loginIdentifier: String                          │      │
    │    │  - userPool: UserPool                               │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - attemptTime: LocalDateTime                       │      │
    │    │  - success: Boolean                                 │      │
    │    │  - failReason: FailReason                           │      │
    │    │  - clientIp: String                                 │      │
    │    │  - userAgent: String                                │      │
    │    │  - deviceId: String                                 │      │
    │    │  - location: GeoLocation                            │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + record(attemptInfo): LoginAttempt                │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌───────────────────────────────────────────────────────┐    │
    │    │                   FailReason (枚举)                   │    │
    │    ├───────────────────────────────────────────────────────┤    │
    │    │ USER_NOT_FOUND    - 用户不存在                        │    │
    │    │ WRONG_PASSWORD    - 密码错误                          │    │
    │    │ WRONG_CAPTCHA     - 验证码错误                        │    │
    │    │ ACCOUNT_LOCKED    - 账号锁定                          │    │
    │    │ ACCOUNT_DISABLED  - 账号禁用                          │    │
    │    │ IP_BLOCKED        - IP被阻止                          │    │
    │    │ MFA_FAILED        - 双因素验证失败                    │    │
    │    └───────────────────────────────────────────────────────┘    │
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │             LoginLockout（实体）                    │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: LockoutId                                    │      │
    │    │  - loginIdentifier: String                          │      │
    │    │  - userPool: UserPool                               │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - failCount: Integer                               │      │
    │    │  - lastFailTime: LocalDateTime                      │      │
    │    │  - lockoutUntil: LocalDateTime                      │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + increment(): void                                │      │
    │    │  + isLocked(): Boolean                              │      │
    │    │  + reset(): void                                    │      │
    │    │  + getRemainingLockTime(): Duration                 │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.4.1-1 LoginAttempt聚合结构

#### 5.3.4.2 LoginAttempt 实体

+   LoginAttempt是聚合根，记录登录尝试用于失败锁定和安全审计，采用三表模型定义如下。

##### 属性清单表

| 属性            | 类型          | 约束             | 默认值         | 业务含义                       |
| --------------- | ------------- | ---------------- | -------------- | ------------------------------ |
| id              | AttemptId     | 必填，主键       | AUTO_INCREMENT | 尝试记录唯一标识               |
| loginIdentifier | String        | 必填，长度≤128   | -              | 登录标识（用户名/邮箱/手机号） |
| userPool        | UserPool      | 必填，枚举       | -              | 用户群标识：UP/UR/UC           |
| tenantId        | TenantId      | UR时必填         | null           | 租户ID                         |
| attemptTime     | LocalDateTime | 必填             | NOW()          | 尝试时间                       |
| success         | Boolean       | 必填             | -              | 是否成功                       |
| failReason      | FailReason    | 失败时必填，枚举 | null           | 失败原因                       |
| clientIp        | String        | 必填，IP格式     | -              | 客户端IP地址                   |
| userAgent       | String        | 可选，长度≤512   | null           | 用户代理字符串                 |
| deviceId        | String        | 可选，长度≤64    | null           | 设备唯一标识                   |
| location        | GeoLocation   | 可选             | null           | 地理位置信息                   |

表 5.3.4.2-1 LoginAttempt属性清单表

##### LoginLockout实体属性清单表

| 属性            | 类型          | 约束       | 默认值         | 业务含义         |
| --------------- | ------------- | ---------- | -------------- | ---------------- |
| id              | LockoutId     | 必填，主键 | AUTO_INCREMENT | 锁定记录唯一标识 |
| loginIdentifier | String        | 必填，唯一 | -              | 登录标识         |
| userPool        | UserPool      | 必填，枚举 | -              | 用户群标识       |
| tenantId        | TenantId      | UR时必填   | null           | 租户ID           |
| failCount       | Integer       | 必填       | 0              | 连续失败次数     |
| lastFailTime    | LocalDateTime | 可选       | null           | 最后一次失败时间 |
| lockoutUntil    | LocalDateTime | 可选       | null           | 锁定截止时间     |

表 5.3.4.2-2 LoginLockout属性清单表

+   不同用户群的登录锁定策略如下表所示。

| 用户群 | 最大失败次数 | 统计时间窗口  | 锁定时长      | 说明                   |
| ------ | ------------ | ------------- | ------------- | ---------------------- |
| UP     | 5次          | 5分钟         | 30分钟        | 最严格，平台管理安全   |
| UR     | 5次（可配）  | 5分钟（可配） | 5分钟（可配） | 租户可配置             |
| UC     | 10次         | 5分钟         | 5分钟         | 相对宽松，用户体验优先 |

表 5.3.4.2-3 用户群登录锁定策略

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                         | 验证时机 | 违反后果 |
| -------- | ------------ | ------------------------------------------------ | -------- | -------- |
| LA-R-01  | 失败计数累加 | 登录失败时failCount+1，记录lastFailTime          | 登录失败 | -        |
| LA-R-02  | 成功后清零   | 登录成功后failCount清零，清除lockoutUntil        | 登录成功 | -        |
| LA-R-03  | 超窗口重置   | 距离lastFailTime超过统计窗口时，failCount重置为1 | 登录失败 | -        |
| LA-R-04  | 达阈值锁定   | failCount达到阈值时，设置lockoutUntil            | 登录失败 | 账号锁定 |
| LA-R-05  | 锁定期间拒绝 | lockoutUntil > NOW时拒绝登录，返回剩余锁定时间   | 登录     | 拒绝登录 |
| LA-R-06  | 到期自动解锁 | lockoutUntil ≤ NOW时自动解锁，但不清零failCount  | 登录     | -        |
| LA-R-07  | 审计记录保留 | LoginAttempt记录保留90天，用于安全审计           | -        | -        |
| LA-R-08  | IP维度统计   | 支持按IP维度统计失败次数，防止撞库攻击           | 登录失败 | IP锁定   |

表 5.3.4.2-4 LoginAttempt业务规则表

##### 业务方法表

| 方法名                   | 方法简述                 | 关联规则      | 异常 | 事件           |
| ------------------------ | ------------------------ | ------------- | ---- | -------------- |
| record()                 | 记录一次登录尝试         | LA-R-01,02,07 | -    | LoginAttempted |
| LoginLockout.increment() | 失败计数+1，判断是否锁定 | LA-R-01,03,04 | -    | AccountLocked  |
| LoginLockout.isLocked()  | 判断是否处于锁定状态     | LA-R-05,06    | -    | -              |
| LoginLockout.reset()     | 清零失败计数             | LA-R-02       | -    | -              |
| getRemainingLockTime()   | 获取剩余锁定时间         | LA-R-05       | -    | -              |

表 5.3.4.2-5 LoginAttempt业务方法表

### 5.3.5 Token 聚合（令牌）

+   Token聚合负责管理访问令牌（AccessToken）、刷新令牌（RefreshToken）和令牌黑名单（TokenBlacklist）。

#### 5.3.5.1 聚合结构

+   Token聚合的结构如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                            Token 聚合                                   │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │    ┌─────────────────────────────────────────────────────────────┐      │
    │    │                  AccessToken（值对象）                      │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  - jti: String (JWT ID)                                     │      │
    │    │  - sub: UserId (用户ID)                                     │      │
    │    │  - userPool: UserPool                                       │      │
    │    │  - tenantCode: String (租户编码，路由用)                    │      │
    │    │  - tenantId: TenantId (租户ID)                              │      │
    │    │  - username: String                                         │      │
    │    │  - sessionId: SessionId (会话ID)                            │      │
    │    │  - iat: LocalDateTime (签发时间)                            │      │
    │    │  - exp: LocalDateTime (过期时间)                            │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  + generate(user, ttl): AccessToken                         │      │
    │    │  + parse(tokenString): AccessToken                          │      │
    │    │  + toJwtString(): String                                    │      │
    │    │  + isExpired(): Boolean                                     │      │
    │    │  + verify(publicKey): Boolean                               │      │
    │    │  + getTenantCode(): String                                  │      │
    │    │  + getSessionId(): SessionId                                │      │
    │    └─────────────────────────────────────────────────────────────┘      │
    │                                                                         │
    │    ┌─────────────────────────────────────────────────────────────┐      │
    │    │                RefreshToken（聚合根/实体）                  │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  - id: TokenId                                              │      │
    │    │  - tokenValue: String                                       │      │
    │    │  - userId: UserId                                           │      │
    │    │  - userPool: UserPool                                       │      │
    │    │  - tenantCode: String                                       │      │
    │    │  - tenantId: TenantId                                       │      │
    │    │  - deviceId: String                                         │      │
    │    │  - sessionId: SessionId                                     │      │
    │    │  - issuedAt: LocalDateTime                                  │      │
    │    │  - expiresAt: LocalDateTime                                 │      │
    │    │  - revokedAt: LocalDateTime                                 │      │
    │    │  - revokeReason: RevokeReason                               │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  + issue(userId, deviceId, ttl): RefreshToken               │      │
    │    │  + revoke(reason): void                                     │      │
    │    │  + isValid(): Boolean                                       │      │
    │    │  + isExpired(): Boolean                                     │      │
    │    │  + isRevoked(): Boolean                                     │      │
    │    └─────────────────────────────────────────────────────────────┘      │
    │                              │                                          │
    │                              │ 使用                                     │
    │                              ▼                                          │
    │              ┌───────────────────────────────────┐                      │
    │              │       RevokeReason (枚举)         │                      │
    │              ├───────────────────────────────────┤                      │
    │              │ USER_LOGOUT      - 用户登出       │                      │
    │              │ PASSWORD_CHANGED - 密码修改       │                      │
    │              │ ADMIN_REVOKE     - 管理员撤销     │                      │
    │              │ SECURITY_RISK    - 安全风险       │                      │
    │              │ SESSION_KICKED   - 会话被踢出     │                      │
    │              └───────────────────────────────────┘                      │
    │                                                                         │
    │    ┌─────────────────────────────────────────────────────────────┐      │
    │    │                  TokenBlacklist（实体）                     │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  - jti: String (JWT的jti)                                   │      │
    │    │  - expireAt: LocalDateTime                                  │      │
    │    │  - revokeReason: RevokeReason                               │      │
    │    │  - revokedAt: LocalDateTime                                 │      │
    │    ├─────────────────────────────────────────────────────────────┤      │
    │    │  + add(jti, expireAt, reason): void                         │      │
    │    │  + addBatch(List<BlacklistEntry>): void                     │      │
    │    │  + contains(jti): Boolean                                   │      │
    │    └─────────────────────────────────────────────────────────────┘      │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.5.1-1 Token聚合结构

#### 5.3.5.2 AccessToken 值对象

+   AccessToken是值对象，采用JWT（JSON Web Token）格式，无状态存储，通过签名验证有效性。采用三表模型定义如下。

##### 属性清单表

+   AccessToken属性清单表
    | 属性       | 类型          | 约束           | 默认值 | 业务含义                            |
    | ---------- | ------------- | -------------- | ------ | ----------------------------------- |
    | jti        | String        | 必填，全局唯一 | UUID   | JWT ID，用于黑名单校验              |
    | sub        | UserId        | 必填           | -      | Subject，用户ID                     |
    | userPool   | UserPool      | 必填，枚举     | -      | 用户群标识：UP/UR/UC                |
    | tenantCode | String        | UR时必填，≤32  | null   | 租户编码，用于数据源路由（如 acme） |
    | tenantId   | TenantId      | UR时必填       | null   | 租户ID，用于业务数据隔离            |
    | username   | String        | 必填，长度≤64  | -      | 用户名，用于日志和显示              |
    | sessionId  | SessionId     | 必填           | -      | 关联的会话ID，用于会话管理和审计    |
    | iat        | LocalDateTime | 必填           | NOW()  | Issued At，签发时间                 |
    | exp        | LocalDateTime | 必填           | -      | Expiration，过期时间                |

    表 5.3.5.2-1 AccessToken属性清单表

+   **tenantCode vs tenantId 说明**：

    | 字段       | 用途                                                 | 示例 |
    | ---------- | ---------------------------------------------------- | ---- |
    | tenantCode | 人类可读标识，登录输入、日志显示                     | acme |
    | tenantId   | 数据源路由（clarisphere_t{tenant_id}）、业务数据隔离 | 789  |

    表 5.3.5.2-2 租户标识字段说明

+   **JWT完整结构**：

    | 部分      | 内容                                                                                              |
    | --------- | ------------------------------------------------------------------------------------------------- |
    | Header    | `{"alg": "RS256", "typ": "JWT"}`                                                                  |
    | Payload   | `{"jti", "sub", "user_pool", "tenant_code", "tenant_id", "username", "session_id", "iat", "exp"}` |
    | Signature | RS256签名，使用平台私钥签发，公钥验证                                                             |

    表 5.3.5.2-3 JWT结构说明

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                                     | 验证时机  | 违反后果 |
| -------- | ------------ | ------------------------------------------------------------ | --------- | -------- |
| AT-R-01  | 无状态验证   | AccessToken不存储，通过签名验证有效性                        | 每次请求  | -        |
| AT-R-02  | 黑名单校验   | 验证时需检查jti是否在TokenBlacklist中                        | 每次请求  | 拒绝访问 |
| AT-R-03  | 过期校验     | 验证时需检查exp是否已过期                                    | 每次请求  | 拒绝访问 |
| AT-R-04  | 签名算法     | 使用RS256非对称加密算法，私钥签发，公钥验证                  | 签发/验证 | -        |
| AT-R-05  | 不含敏感信息 | Payload中不存储密码、权限列表等敏感或易变信息                | 签发      | -        |
| AT-R-06  | 有效期差异   | 不同用户群有效期不同：UP=15分钟，UR=30分钟（可配），UC=2小时 | 签发      | -        |
| AT-R-07  | 租户路由必填 | UR用户的Token必须包含tenantCode，用于数据源路由              | 签发      | 签发失败 |

表 5.3.5.2-4 AccessToken业务规则表

##### 业务方法表

| 方法名          | 参数        | 返回值      | 说明                                    |
| --------------- | ----------- | ----------- | --------------------------------------- |
| generate()      | user, ttl   | AccessToken | 静态工厂方法，根据用户信息生成Token     |
| parse()         | tokenString | AccessToken | 从JWT字符串解析为值对象                 |
| toJwtString()   | -           | String      | 序列化为JWT字符串（Header.Payload.Sig） |
| isExpired()     | -           | Boolean     | 判断是否已过期                          |
| verify()        | publicKey   | Boolean     | 验证签名有效性                          |
| getJti()        | -           | String      | 获取JWT ID，用于黑名单操作              |
| getTenantCode() | -           | String      | 获取租户编码，用于数据源路由            |
| getSessionId()  | -           | SessionId   | 获取会话ID，用于会话管理和审计          |

表 5.3.5.2-5 AccessToken业务方法表

+   **备注**：
    -   AccessToken为值对象，不可变，不存储在数据库或Redis中
    -   权限信息不存储在Token中，而是在每次请求时实时查询（通过缓存优化）
    -   Token撤销通过将jti加入TokenBlacklist实现

#### 5.3.5.3 RefreshToken 实体

+   RefreshToken是聚合根，管理刷新令牌的存储和撤销，采用三表模型定义如下。

##### 属性清单表

| 属性         | 类型          | 约束                 | 默认值 | 业务含义                     |
| ------------ | ------------- | -------------------- | ------ | ---------------------------- |
| id           | TokenId       | 必填，主键           | UUID   | 令牌唯一标识                 |
| tokenValue   | String        | 必填，唯一，长度≤512 | -      | 令牌值，安全随机字符串       |
| userId       | UserId        | 必填                 | -      | 关联的用户ID                 |
| userPool     | UserPool      | 必填，枚举           | -      | 用户群标识：UP/UR/UC         |
| tenantCode   | String        | UR时必填，≤32        | null   | 租户编码，用于数据源路由     |
| tenantId     | TenantId      | UR时必填             | null   | 租户ID                       |
| deviceId     | String        | 必填，长度≤64        | -      | 设备唯一标识，令牌与设备绑定 |
| sessionId    | SessionId     | 必填                 | -      | 关联的会话ID                 |
| issuedAt     | LocalDateTime | 必填                 | NOW()  | 签发时间                     |
| expiresAt    | LocalDateTime | 必填                 | -      | 过期时间                     |
| revokedAt    | LocalDateTime | 可选                 | null   | 撤销时间，未撤销时为null     |
| revokeReason | RevokeReason  | 撤销时必填，枚举     | null   | 撤销原因                     |

表 5.3.5.3-1 RefreshToken属性清单表

+   不同用户群的令牌有效期配置如下表所示。

| 用户群 | AccessToken有效期 | RefreshToken有效期 | 支持轮换 | 说明                   |
| ------ | ----------------- | ------------------ | -------- | ---------------------- |
| UP     | 15分钟            | 4小时              | 是       | 短有效期，高安全       |
| UR     | 30分钟（可配）    | 8小时（可配）      | 是       | 租户可配置             |
| UC     | 2小时             | 30天               | 是       | 长有效期，用户体验优先 |

表 5.3.5.3-2 用户群令牌有效期配置

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                            | 验证时机 | 违反后果   |
| -------- | ------------ | --------------------------------------------------- | -------- | ---------- |
| RT-R-01  | Redis存储    | RefreshToken存储在Redis中，支持快速查询和自动过期   | 签发     | -          |
| RT-R-02  | 设备绑定     | RefreshToken与deviceId绑定，刷新时验证设备一致性    | 刷新     | 拒绝刷新   |
| RT-R-03  | 撤销级联     | 撤销RefreshToken时，关联的AccessToken也需加入黑名单 | 撤销     | -          |
| RT-R-04  | 密码变更撤销 | 用户密码修改后，撤销该用户所有令牌                  | 密码修改 | 需重新登录 |
| RT-R-05  | 轮换策略     | 刷新时可选择轮换RefreshToken，提高安全性            | 刷新     | -          |
| RT-R-06  | 过期清理     | 过期的RefreshToken记录由Redis TTL自动清理           | 定时     | -          |
| RT-R-07  | 租户路由必填 | UR用户的RefreshToken必须包含tenantCode              | 签发     | 签发失败   |

表 5.3.5.3-3 RefreshToken业务规则表

##### 业务方法表

| 方法名      | 参数                  | 返回值       | 关联规则      | 事件         |
| ----------- | --------------------- | ------------ | ------------- | ------------ |
| issue()     | userId, deviceId, ttl | RefreshToken | RT-R-01,02,07 | TokenIssued  |
| revoke()    | reason                | void         | RT-R-03       | TokenRevoked |
| isValid()   | -                     | Boolean      | -             | -            |
| isExpired() | -                     | Boolean      | -             | -            |
| isRevoked() | -                     | Boolean      | -             | -            |

表 5.3.5.3-4 RefreshToken业务方法表

+   **备注**：
    -   RefreshToken不采用JWT格式，而是安全随机字符串，需要查Redis验证
    -   存储在Redis中，Key格式：`auth:refresh:{tokenId}`

#### 5.3.5.4 TokenBlacklist 实体

+   TokenBlacklist实体管理已撤销但未过期的AccessToken黑名单，采用三表模型定义如下。

##### 属性清单表

| 属性         | 类型          | 约束                   | 默认值 | 业务含义                                    |
| ------------ | ------------- | ---------------------- | ------ | ------------------------------------------- |
| jti          | String        | 必填，主键（JWT的jti） | -      | AccessToken的jti声明值                      |
| expireAt     | LocalDateTime | 必填                   | -      | 黑名单记录过期时间（与原Token过期时间一致） |
| revokeReason | RevokeReason  | 必填，枚举             | -      | 撤销原因                                    |
| revokedAt    | LocalDateTime | 必填                   | NOW()  | 加入黑名单的时间                            |

表 5.3.5.4-1 TokenBlacklist属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                            | 验证时机 | 违反后果 |
| -------- | ------------ | --------------------------------------------------- | -------- | -------- |
| TB-R-01  | Redis存储    | TokenBlacklist存储在Redis中，利用TTL自动过期清理    | 添加     | -        |
| TB-R-02  | TTL与原Token | 黑名单记录的TTL设置为原AccessToken的剩余有效时间    | 添加     | -        |
| TB-R-03  | 幂等添加     | 重复添加同一jti不报错，更新TTL为较大值              | 添加     | -        |
| TB-R-04  | 高频查询优化 | 每次API请求都需查询黑名单，需保证O(1)查询性能       | 验证     | -        |
| TB-R-05  | 批量撤销     | 密码修改等场景需批量添加该用户所有活跃Token到黑名单 | 撤销     | -        |

表 5.3.5.4-2 TokenBlacklist业务规则表

##### 业务方法表

| 方法名     | 参数                  | 返回值  | 关联规则      | 说明                            |
| ---------- | --------------------- | ------- | ------------- | ------------------------------- |
| add()      | jti, expireAt, reason | void    | TB-R-01,02,03 | 将AccessToken的jti加入黑名单    |
| addBatch() | List<BlacklistEntry>  | void    | TB-R-05       | 批量添加到黑名单                |
| contains() | jti                   | Boolean | TB-R-04       | 检查jti是否在黑名单中           |
| remove()   | jti                   | void    | -             | 手动移除（一般不用，靠TTL过期） |

表 5.3.5.4-3 TokenBlacklist业务方法表

+   **备注**：
    -   存储在Redis中，Key格式：`auth:blacklist:{jti}`
    -   TTL设置为原AccessToken的剩余有效时间，自动过期清理
    -   每次API请求都需要查询黑名单，Redis保证O(1)性能

### 5.3.6 Session 聚合（会话）

+   Session聚合负责管理用户的登录会话。

#### 5.3.6.1 聚合结构

+   Session聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                       Session 聚合                              │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │               Session（聚合根/实体）                │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: SessionId                                    │      │
    │    │  - userId: UserId                                   │      │
    │    │  - userPool: UserPool                               │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - deviceInfo: DeviceInfo                           │      │
    │    │  - loginTime: LocalDateTime                         │      │
    │    │  - lastActiveTime: LocalDateTime                    │      │
    │    │  - expireTime: LocalDateTime                        │      │
    │    │  - status: SessionStatus                            │      │
    │    │  - loginMethod: LoginMethod                         │      │
    │    │  - loginIp: String                                  │      │
    │    │  - loginLocation: GeoLocation                       │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + create(userId, deviceInfo, config): Session      │      │
    │    │  + refresh(): void                                  │      │
    │    │  + terminate(reason): void                          │      │
    │    │  + isActive(): Boolean                              │      │
    │    │  + isExpired(): Boolean                             │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 包含                             │
    │                              ▼                                  │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │              DeviceInfo（值对象）                   │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - deviceId: String                                 │      │
    │    │  - deviceType: DeviceType                           │      │
    │    │  - deviceName: String                               │      │
    │    │  - osName: String                                   │      │
    │    │  - osVersion: String                                │      │
    │    │  - browserName: String                              │      │
    │    │  - browserVersion: String                           │      │
    │    │  - appVersion: String                               │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                                                                 │
    │    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
    │    │ SessionStatus │  │  DeviceType   │  │  LoginMethod  │      │
    │    │    (枚举)     │  │    (枚举)     │  │    (枚举)     │      │
    │    ├───────────────┤  ├───────────────┤  ├───────────────┤      │
    │    │ ACTIVE        │  │ WEB           │  │ PASSWORD      │      │
    │    │ EXPIRED       │  │ H5            │  │ SMS_CODE      │      │
    │    │ TERMINATED    │  │ IOS           │  │ SOCIAL        │      │
    │    │ KICKED        │  │ ANDROID       │  │ SSO           │      │
    │    └───────────────┘  │ MINIAPP       │  │ SCAN_CODE     │      │
    │                       │ DESKTOP       │  │ BIOMETRIC     │      │
    │                       └───────────────┘  │ PASSWORDLESS  │      │
    │                                          └───────────────┘      │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.6.1-1 Session聚合结构

#### 5.3.6.2 Session 实体

+   Session是聚合根，管理用户的登录会话，采用三表模型定义如下。

##### 属性清单表

| 属性           | 类型          | 约束         | 默认值 | 业务含义                                   |
| -------------- | ------------- | ------------ | ------ | ------------------------------------------ |
| id             | SessionId     | 必填，主键   | UUID   | 会话唯一标识                               |
| userId         | UserId        | 必填         | -      | 关联的用户ID                               |
| userPool       | UserPool      | 必填，枚举   | -      | 用户群标识：UP/UR/UC                       |
| tenantId       | TenantId      | UR时必填     | null   | 租户ID                                     |
| deviceInfo     | DeviceInfo    | 必填         | -      | 设备信息值对象                             |
| loginTime      | LocalDateTime | 必填         | NOW()  | 登录时间                                   |
| lastActiveTime | LocalDateTime | 必填         | NOW()  | 最后活跃时间                               |
| expireTime     | LocalDateTime | 必填         | -      | 会话过期时间（绝对超时）                   |
| status         | SessionStatus | 必填，枚举   | ACTIVE | 会话状态：ACTIVE/EXPIRED/TERMINATED/KICKED |
| loginMethod    | LoginMethod   | 必填，枚举   | -      | 登录方式                                   |
| loginIp        | String        | 必填，IP格式 | -      | 登录IP地址                                 |
| loginLocation  | GeoLocation   | 可选         | null   | 登录地理位置                               |

表 5.3.6.2-1 Session属性清单表

+   不同用户群的会话策略配置如下表所示。

| 用户群 | 会话有效期    | 空闲超时       | 多端策略           | 说明                 |
| ------ | ------------- | -------------- | ------------------ | -------------------- |
| UP     | 4小时         | 15分钟         | 单设备             | 最严格，单设备登录   |
| UR     | 8小时（可配） | 30分钟（可配） | 同类型互斥（可配） | 租户可配置           |
| UC     | 30天          | 不限制         | 允许多端           | 用户体验优先，不限制 |

表 5.3.6.2-2 用户群会话策略配置

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                                      | 验证时机 | 违反后果     |
| -------- | ------------ | ------------------------------------------------------------- | -------- | ------------ |
| SS-R-01  | 设备用户唯一 | 同一设备同一用户只能有一个ACTIVE状态的会话                    | 创建     | 终止旧会话   |
| SS-R-02  | 多端策略执行 | 根据用户群的多端策略，决定是否踢出其他设备的会话（见DI-R-04） | 创建     | 踢出冲突会话 |
| SS-R-03  | 活跃时刷新   | 用户有活动请求时，更新lastActiveTime，延长空闲超时            | 请求     | -            |
| SS-R-04  | 空闲超时检测 | NOW - lastActiveTime > 空闲超时阈值时，会话失效               | 请求     | 要求重新登录 |
| SS-R-05  | 绝对超时检测 | NOW > expireTime时，会话失效，不论是否活跃                    | 请求     | 要求重新登录 |
| SS-R-06  | 踢出通知     | 会话被踢出时（KICKED），应通知被踢出的客户端                  | 踢出     | -            |
| SS-R-07  | 关联令牌撤销 | 会话终止时，关联的RefreshToken也应撤销                        | 终止     | -            |

表 5.3.6.2-3 Session业务规则表

+   多端登录策略详细说明如下表所示。

| 策略名称       | 策略说明                                       | 适用用户群 | 设备分组依据 |
| -------------- | ---------------------------------------------- | ---------- | ------------ |
| ALLOW_MULTI    | 允许多端同时登录，无限制                       | UC         | 不限制       |
| SAME_TYPE_KICK | 同类型设备互斥，新登录踢出旧设备（如WEB踢WEB） | UP、UR     | DI-R-04分组  |
| SINGLE_ONLY    | 只允许单设备，新登录踢出所有旧设备             | 高安全场景 | 所有设备互斥 |

表 5.3.6.2-4 多端登录策略说明

##### 业务方法表

| 方法名          | 方法简述         | 关联规则          | 异常 | 事件              |
| --------------- | ---------------- | ----------------- | ---- | ----------------- |
| create()        | 创建会话         | SS-R-01,02,DI-R-* | -    | SessionCreated    |
| refresh()       | 刷新会话活跃时间 | SS-R-03           | -    | -                 |
| terminate()     | 终止会话         | SS-R-07           | -    | SessionTerminated |
| kick()          | 踢出会话         | SS-R-06,07        | -    | SessionKicked     |
| isActive()      | 判断会话是否活跃 | SS-R-04,05        | -    | -                 |
| isExpired()     | 判断会话是否过期 | SS-R-05           | -    | -                 |
| isIdleTimeout() | 判断是否空闲超时 | SS-R-04           | -    | -                 |

表 5.3.6.2-5 Session业务方法表

#### 5.3.6.3 DeviceInfo 值对象

+   DeviceInfo值对象封装设备信息，采用三表模型定义如下。

##### 属性清单表

| 属性           | 类型       | 约束           | 默认值 | 业务含义                                     |
| -------------- | ---------- | -------------- | ------ | -------------------------------------------- |
| deviceId       | String     | 必填，长度<=64 | -      | 设备唯一标识                                 |
| deviceType     | DeviceType | 必填，枚举     | -      | 设备类型：WEB/H5/IOS/ANDROID/MINIAPP/DESKTOP |
| deviceName     | String     | 可选，长度<=64 | null   | 设备名称                                     |
| osName         | String     | 可选，长度<=32 | null   | 操作系统名称                                 |
| osVersion      | String     | 可选，长度<=32 | null   | 操作系统版本                                 |
| browserName    | String     | 可选，长度<=32 | null   | 浏览器名称（WEB/H5时）                       |
| browserVersion | String     | 可选，长度<=32 | null   | 浏览器版本                                   |
| appVersion     | String     | 可选，长度<=32 | null   | App版本号（移动端时）                        |

表 5.3.6.3-1 DeviceInfo属性清单表

##### DeviceType枚举值表

| 枚举值  | 说明     | 典型场景            | 多端策略分组 |
| ------- | -------- | ------------------- | ------------ |
| WEB     | 网页端   | 浏览器访问          | WEB组        |
| H5      | H5移动端 | 手机浏览器          | WEB组        |
| IOS     | iOS App  | iPhone/iPad App     | MOBILE组     |
| ANDROID | 安卓App  | Android手机/平板App | MOBILE组     |
| MINIAPP | 小程序   | 微信/支付宝小程序   | MINIAPP组    |
| DESKTOP | 桌面端   | Windows/Mac桌面应用 | DESKTOP组    |

表 5.3.6.3-2 DeviceType枚举值

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                   | 验证时机 | 违反后果 |
| -------- | -------------- | ------------------------------------------ | -------- | -------- |
| DI-R-01  | deviceId生成   | 客户端首次访问时生成并持久化到本地存储     | 登录     | -        |
| DI-R-02  | deviceId不可变 | 同一设备的deviceId应保持不变，用于设备识别 | 登录     | -        |
| DI-R-03  | 类型自动检测   | deviceType从User-Agent或客户端SDK自动检测  | 登录     | -        |
| DI-R-04  | 多端分组       | 多端策略按DeviceType分组判断，同组内互斥   | 创建会话 | -        |

表 5.3.6.3-3 DeviceInfo业务规则表

+   备注：
    -   DeviceInfo为嵌入式值对象，存储在session表中（device_id, device_type等列）
    -   deviceId由客户端生成，Web端存localStorage，App端存本地存储
    -   多端策略分组用于SAME_TYPE_KICK策略，同组内设备互斥

### 5.3.7 SocialConnection 聚合（社交绑定）

+   SocialConnection聚合负责管理C端用户群用户的第三方账号绑定。

#### 5.3.7.1 聚合结构

+   SocialConnection聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                   SocialConnection 聚合                         │
    │                      (仅C端用户群UC)                            │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │            SocialConnection（聚合根/实体）          │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: ConnectionId                                 │      │
    │    │  - userId: UserId                                   │      │
    │    │  - provider: SocialProvider                         │      │
    │    │  - openId: String                                   │      │
    │    │  - unionId: String                                  │      │
    │    │  - accessToken: String                              │      │
    │    │  - refreshToken: String                             │      │
    │    │  - tokenExpireAt: LocalDateTime                     │      │
    │    │  - nickname: String                                 │      │
    │    │  - avatar: String                                   │      │
    │    │  - bindTime: LocalDateTime                          │      │
    │    │  - lastLoginTime: LocalDateTime                     │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + bind(userId, providerInfo): SocialConnection     │      │
    │    │  + unbind(): void                                   │      │
    │    │  + updateToken(token): void                         │      │
    │    │  + recordLogin(): void                              │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │              ┌───────────────────────────────┐                  │
    │              │     SocialProvider (枚举)     │                  │
    │              ├───────────────────────────────┤                  │
    │              │ WECHAT       - 微信           │                  │
    │              │ DINGTALK     - 钉钉           │                  │
    │              │ QQ           - QQ             │                  │
    │              │ WEIBO        - 微博           │                  │
    │              │ APPLE        - Apple          │                  │
    │              └───────────────────────────────┘                  │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.7.1-1 SocialConnection聚合结构

#### 5.3.7.2 SocialConnection 实体

+   SocialConnection是聚合根，管理C端用户群用户的第三方账号绑定（仅UC用户群），采用三表模型定义如下。

##### 属性清单表

| 属性          | 类型           | 约束                     | 默认值         | 业务含义                                   |
| ------------- | -------------- | ------------------------ | -------------- | ------------------------------------------ |
| id            | ConnectionId   | 必填，主键               | AUTO_INCREMENT | 绑定记录唯一标识                           |
| userId        | UserId         | 必填                     | -              | 关联的用户ID                               |
| provider      | SocialProvider | 必填，枚举               | -              | 社交平台：WECHAT/DINGTALK/QQ/WEIBO/APPLE   |
| openId        | String         | 必填，长度≤128           | -              | 平台用户唯一标识（应用维度）               |
| unionId       | String         | 可选，长度≤128           | null           | 平台用户唯一标识（主体维度，部分平台支持） |
| accessToken   | String         | 可选，长度≤512，加密存储 | null           | 平台访问令牌                               |
| refreshToken  | String         | 可选，长度≤512，加密存储 | null           | 平台刷新令牌                               |
| tokenExpireAt | LocalDateTime  | 可选                     | null           | 平台令牌过期时间                           |
| nickname      | String         | 可选，长度≤64            | null           | 平台昵称                                   |
| avatar        | String         | 可选，URL格式，长度≤512  | null           | 平台头像URL                                |
| bindTime      | LocalDateTime  | 必填                     | NOW()          | 绑定时间                                   |
| lastLoginTime | LocalDateTime  | 可选                     | null           | 最后一次使用该方式登录的时间               |

表 5.3.7.2-1 SocialConnection属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                             | 验证时机 | 违反后果   |
| -------- | ---------------- | ---------------------------------------------------- | -------- | ---------- |
| SC-R-01  | openId唯一绑定   | 同一provider的openId只能绑定一个用户                 | 绑定     | 拒绝操作   |
| SC-R-02  | unionId唯一绑定  | 同一provider的unionId只能绑定一个用户（若有）        | 绑定     | 拒绝操作   |
| SC-R-03  | 优先匹配unionId  | 登录时优先使用unionId匹配，其次使用openId            | 登录     | -          |
| SC-R-04  | 多渠道绑定       | 一个用户可绑定多个不同provider的账号                 | -        | -          |
| SC-R-05  | 同渠道单绑定     | 一个用户在同一provider只能绑定一个账号               | 绑定     | 提示已绑定 |
| SC-R-06  | 解绑保留登录方式 | 解绑时必须至少保留一种登录方式（密码或其他社交账号） | 解绑     | 拒绝操作   |
| SC-R-07  | 令牌加密存储     | accessToken和refreshToken必须加密存储                | 存储     | -          |

表 5.3.7.2-2 SocialConnection业务规则表

##### 业务方法表

| 方法名                 | 方法简述                 | 关联规则         | 异常                          | 事件                 |
| ---------------------- | ------------------------ | ---------------- | ----------------------------- | -------------------- |
| bind()                 | 绑定社交账号             | SC-R-01,02,04,05 | SocialAlreadyBoundException   | SocialAccountBound   |
| unbind()               | 解绑社交账号             | SC-R-06          | LastLoginMethodException      | SocialAccountUnbound |
| updateToken()          | 更新平台令牌             | SC-R-07          | -                             | -                    |
| recordLogin()          | 记录一次使用该方式的登录 | -                | -                             | -                    |
| refreshPlatformToken() | 刷新平台令牌（若过期）   | -                | PlatformTokenExpiredException | -                    |

表 5.3.7.2-3 SocialConnection业务方法表

+   备注：
    -   SocialConnection仅适用于C端用户群（UC）用户群
    -   租户用户群的企业身份源（企业微信/钉钉/飞书）登录不使用此聚合，而是通过SSO机制

### 5.3.8 VerificationCode 聚合（验证码）

+   VerificationCode聚合负责管理短信和邮件验证码。

#### 5.3.8.1 聚合结构

+   VerificationCode聚合的结构如下图所示。

    ```graph
    ┌─────────────────────────────────────────────────────────────────┐
    │                   VerificationCode 聚合                         │
    ├─────────────────────────────────────────────────────────────────┤
    │                                                                 │
    │    ┌─────────────────────────────────────────────────────┐      │
    │    │           VerificationCode（聚合根/实体）           │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  - id: CodeId                                       │      │
    │    │  - target: String (手机号/邮箱)                     │      │
    │    │  - targetType: TargetType                           │      │
    │    │  - scene: CodeScene                                 │      │
    │    │  - code: String                                     │      │
    │    │  - userPool: UserPool                               │      │
    │    │  - tenantId: TenantId                               │      │
    │    │  - createdAt: LocalDateTime                         │      │
    │    │  - expireAt: LocalDateTime                          │      │
    │    │  - verifyCount: Integer                             │      │
    │    │  - verified: Boolean                                │      │
    │    ├─────────────────────────────────────────────────────┤      │
    │    │  + generate(target, scene, config): VerificationCode│      │
    │    │  + verify(inputCode): Boolean                       │      │
    │    │  + isExpired(): Boolean                             │      │
    │    │  + canRetry(): Boolean                              │      │
    │    └─────────────────────────────────────────────────────┘      │
    │                              │                                  │
    │                              │ 使用                             │
    │                              ▼                                  │
    │    ┌───────────────┐  ┌───────────────────────────────────┐     │
    │    │  TargetType   │  │          CodeScene                │     │
    │    │    (枚举)     │  │           (枚举)                  │     │
    │    ├───────────────┤  ├───────────────────────────────────┤     │
    │    │ MOBILE        │  │ LOGIN          - 登录验证         │     │
    │    │ EMAIL         │  │ LOGIN_MFA      - 登录双因素       │     │
    │    └───────────────┘  │ REGISTER       - 注册验证         │     │
    │                       │ RESET_PASSWORD - 重置密码         │     │
    │                       │ BIND_MOBILE    - 绑定手机         │     │
    │                       │ BIND_EMAIL     - 绑定邮箱         │     │
    │                       │ SENSITIVE_OP   - 敏感操作         │     │
    │                       └───────────────────────────────────┘     │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
    ```

    图 5.3.8.1-1 VerificationCode聚合结构

#### 5.3.8.2 VerificationCode 实体

+   VerificationCode是聚合根，管理短信和邮件验证码，采用三表模型定义如下。

##### 属性清单表

| 属性        | 类型          | 约束          | 默认值 | 业务含义                 |
| ----------- | ------------- | ------------- | ------ | ------------------------ |
| id          | CodeId        | 必填，主键    | UUID   | 验证码记录唯一标识       |
| target      | String        | 必填，长度≤64 | -      | 接收目标（手机号或邮箱） |
| targetType  | TargetType    | 必填，枚举    | -      | 目标类型：MOBILE/EMAIL   |
| scene       | CodeScene     | 必填，枚举    | -      | 使用场景                 |
| code        | String        | 必填，长度4-8 | -      | 验证码值                 |
| userPool    | UserPool      | 必填，枚举    | -      | 用户群标识：UP/UR/UC     |
| tenantId    | TenantId      | UR时可选      | null   | 租户ID                   |
| createdAt   | LocalDateTime | 必填          | NOW()  | 创建时间                 |
| expireAt    | LocalDateTime | 必填          | -      | 过期时间                 |
| verifyCount | Integer       | 必填          | 0      | 已验证次数               |
| verified    | Boolean       | 必填          | false  | 是否已验证成功           |

表 5.3.8.2-1 VerificationCode属性清单表

+   验证码使用场景枚举说明如下表所示。

| 场景枚举       | 场景名称   | 适用用户群 | 模板内容示例                         |
| -------------- | ---------- | ---------- | ------------------------------------ |
| LOGIN          | 登录验证   | UR/UC      | 您的登录验证码是{code}，5分钟内有效  |
| LOGIN_MFA      | 登录双因素 | UP/UR      | 您的安全验证码是{code}，请勿告知他人 |
| REGISTER       | 注册验证   | UR/UC      | 您的注册验证码是{code}，5分钟内有效  |
| RESET_PASSWORD | 重置密码   | UP/UR/UC   | 您的密码重置验证码是{code}           |
| BIND_MOBILE    | 绑定手机   | UP/UR/UC   | 您的绑定验证码是{code}               |
| BIND_EMAIL     | 绑定邮箱   | UP/UR/UC   | 您的绑定验证码是{code}               |
| SENSITIVE_OP   | 敏感操作   | UP/UR/UC   | 您的操作验证码是{code}，请勿告知他人 |

表 5.3.8.2-2 验证码场景枚举

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                         | 验证时机 | 违反后果       |
| -------- | ------------ | ------------------------------------------------ | -------- | -------------- |
| VC-R-01  | 有效期控制   | 验证码默认5分钟内有效，超过expireAt自动失效      | 验证     | 提示已过期     |
| VC-R-02  | 使用后失效   | 验证成功后立即标记verified=true，不可再次使用    | 验证成功 | -              |
| VC-R-03  | 错误次数限制 | verifyCount达到5次后，验证码失效，需重新获取     | 验证     | 提示需重新获取 |
| VC-R-04  | 发送频率限制 | 同一target+scene，60秒内只能发送一次             | 发送     | 提示稍后重试   |
| VC-R-05  | 每日发送上限 | 同一target，每日最多发送10次（所有场景累计）     | 发送     | 提示已达上限   |
| VC-R-06  | 随机生成     | 验证码为随机数字，长度根据配置（默认6位）        | 生成     | -              |
| VC-R-07  | 新码覆盖旧码 | 同一target+scene发送新验证码时，旧验证码自动失效 | 发送     | -              |
| VC-R-08  | 场景隔离     | 不同scene的验证码相互独立，不可混用              | 验证     | 拒绝验证       |

表 5.3.8.2-3 VerificationCode业务规则表

##### 业务方法表

| 方法名       | 方法简述               | 关联规则         | 异常                       | 事件          |
| ------------ | ---------------------- | ---------------- | -------------------------- | ------------- |
| generate()   | 生成验证码             | VC-R-04,05,06,07 | SendLimitExceededException | CodeGenerated |
| verify()     | 验证验证码是否正确     | VC-R-01,02,03,08 | CodeExpiredException       | CodeVerified  |
| isExpired()  | 判断验证码是否已过期   | VC-R-01          | -                          | -             |
| canRetry()   | 判断是否还可以重试验证 | VC-R-03          | -                          | -             |
| invalidate() | 使验证码失效           | VC-R-07          | -                          | -             |

表 5.3.8.2-4 VerificationCode业务方法表

+   备注：
    -   验证码存储在Redis中，利用TTL实现自动过期清理
    -   发送频率限制也通过Redis计数器实现
    -   验证码发送需调用短信/邮件网关，由基础设施层实现

### 5.3.9 领域服务

+   认证管理领域定义以下领域服务。

#### 5.3.9.1 AuthenticationService

+   AuthenticationService负责各类认证方式的身份验证。

    | 方法                    | 参数                          | 返回值     | 说明           |
    | ----------------------- | ----------------------------- | ---------- | -------------- |
    | authenticateByPassword  | identifier, password, context | AuthResult | 密码认证       |
    | authenticateBySmsCode   | mobile, code, context         | AuthResult | 短信验证码认证 |
    | authenticateBySocial    | provider, authCode, context   | AuthResult | 社交账号认证   |
    | authenticateBySSO       | ssoToken, context             | AuthResult | SSO令牌认证    |
    | authenticateByBiometric | userId, biometricToken        | AuthResult | 生物识别认证   |
    | verifySecondFactor      | ticket, smsCode               | AuthResult | 双因素验证     |

    表 5.3.9.1-1 AuthenticationService方法

#### 5.3.9.2 TokenService

+   TokenService负责令牌的签发、验证和撤销。

    | 方法                | 参数                        | 返回值      | 说明               |
    | ------------------- | --------------------------- | ----------- | ------------------ |
    | issueTokens         | userId, context, deviceInfo | TokenPair   | 签发令牌对         |
    | refreshAccessToken  | refreshToken                | TokenPair   | 刷新访问令牌       |
    | revokeToken         | tokenId, reason             | void        | 撤销令牌           |
    | revokeAllUserTokens | userId, reason              | void        | 撤销用户所有令牌   |
    | validateAccessToken | accessToken                 | TokenClaims | 验证访问令牌       |
    | isTokenRevoked      | tokenId                     | boolean     | 检查令牌是否已撤销 |

    表 5.3.9.2-1 TokenService方法

#### 5.3.9.3 SessionService

+   SessionService负责会话的管理。

    | 方法                 | 参数                            | 返回值        | 说明             |
    | -------------------- | ------------------------------- | ------------- | ---------------- |
    | createSession        | userId, deviceInfo, loginMethod | Session       | 创建会话         |
    | getSession           | sessionId                       | Session       | 获取会话         |
    | refreshSession       | sessionId                       | void          | 刷新会话         |
    | terminateSession     | sessionId, reason               | void          | 终止会话         |
    | getUserSessions      | userId                          | List<Session> | 获取用户所有会话 |
    | kickConflictSessions | userId, newDeviceInfo, policy   | void          | 踢出冲突会话     |

    表 5.3.9.3-1 SessionService方法

#### 5.3.9.4 VerificationCodeService

+   VerificationCodeService负责验证码的发送和验证。

    | 方法           | 参数                   | 返回值     | 说明           |
    | -------------- | ---------------------- | ---------- | -------------- |
    | sendSmsCode    | mobile, scene, context | SendResult | 发送短信验证码 |
    | sendEmailCode  | email, scene, context  | SendResult | 发送邮件验证码 |
    | verifyCode     | target, code, scene    | boolean    | 验证验证码     |
    | checkSendLimit | target, scene          | boolean    | 检查发送限制   |

    表 5.3.9.4-1 VerificationCodeService方法

### 5.3.10 领域事件

+   认证管理领域定义以下领域事件。

    | 事件名称                | 触发时机       | 事件数据                                  | 订阅者                     |
    | ----------------------- | -------------- | ----------------------------------------- | -------------------------- |
    | LoginSucceeded          | 登录成功       | userId, userPool, loginMethod, deviceInfo | 审计模块（同步）、通知     |
    | LoginFailed             | 登录失败       | identifier, userPool, reason, ip          | 审计模块（同步）、安全监控 |
    | LogoutSucceeded         | 登出成功       | userId, sessionId                         | 审计模块（同步）           |
    | PasswordChanged         | 密码修改       | userId, userPool                          | 安全通知、令牌撤销         |
    | PasswordResetRequested  | 密码重置请求   | userId, email/mobile                      | 审计模块、通知             |
    | MfaVerified             | 双因素验证成功 | userId, mfaMethod                         | 审计模块                   |
    | SessionCreated          | 会话创建       | sessionId, userId, deviceInfo             | -                          |
    | SessionTerminated       | 会话终止       | sessionId, reason                         | 审计模块                   |
    | SessionKicked           | 会话被踢出     | sessionId, reason                         | 审计模块、通知             |
    | SocialAccountBound      | 社交账号绑定   | userId, provider                          | -                          |
    | SocialAccountUnbound    | 社交账号解绑   | userId, provider                          | -                          |
    | AccountLocked           | 账号锁定       | identifier, lockUntil                     | 审计模块、通知             |
    | SuspiciousLoginDetected | 检测到可疑登录 | userId, riskType, ip                      | 审计模块、安全监控、通知   |
    | SystemConfigChanged     | 系统配置变更   | configKey, oldValue, newValue             | 审计模块（操作日志）       |
    | TenantConfigChanged     | 租户配置变更   | tenantCode, configKey, oldValue, newValue | 审计模块（操作日志）       |
    | TenantConfigReset       | 租户配置重置   | tenantCode, configKey                     | 审计模块（操作日志）       |

    表 5.3.10-1 认证管理领域事件

+   **配置事件归属说明**：
    -   SystemConfigChanged、TenantConfigChanged、TenantConfigReset 三个事件的发布方为**配置管理子领域**（第9章表9.2.5-1定义），并非认证管理发布
    -   此处列出是因为认证管理包含配置管理的前端页面（5.6节），配置操作由配置管理领域处理并发布事件；认证管理不订阅也不发布这三个事件
    -   审计管理通过@OperationLog注解或领域事件监听记录配置变更操作日志（见7.1.3节）

+   **与用户管理子领域（第3章）的事件归属说明**：
    -   PasswordChanged（认证管理发布）与UserPasswordChanged（用户管理发布）是**同一业务动作的两个视角**：密码修改由认证管理执行密码校验与更新，由用户管理维护密码历史。审计管理统一以UserPasswordChanged为监听事件名（见7.3.8.1节）。PasswordChanged事件仍由认证管理内部发布，用于触发令牌撤销和安全通知，不再重复进入安全事件表
    -   AccountLocked（认证管理发布）与UserLocked（审计管理监听名）指同一事件。以认证管理发布的AccountLocked为准，审计管理按AccountLocked名称监听
    -   SessionKicked（认证管理发布）与ForceLogout（审计管理监听名）指同一事件。以认证管理发布的SessionKicked为准，审计管理按SessionKicked名称监听
    -   SocialAccountBound/Unbound（认证管理）与OAuthBound/Unbound（用户管理）：社交账号绑定/解绑操作归属于**用户管理子领域**（管理用户身份关联），认证管理仅关注认证方式变更。SocialAccountBound/Unbound事件保留但订阅者为"-"，审计记录由用户管理侧的OAuthBound/Unbound事件通过@OperationLog注解覆盖

### 5.3.11 协作关系

+   本节梳理认证管理子领域与其他子领域及共享服务之间的协作关系，包括领域内协作、跨领域协作和共享服务协作三个层面。

#### 5.3.11.1 领域内协作

+   认证管理子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方                  | 被调用方                   | 协作方式 | 触发场景            | 说明                                                              |
    | --------- | ----------------------- | -------------------------- | -------- | ------------------- | ----------------------------------------------------------------- |
    | INTRA-201 | AuthenticationService   | Credential（聚合根）       | 方法调用 | 密码登录            | 调用Credential.verifyPassword()验证密码                           |
    | INTRA-202 | AuthenticationService   | LoginAttempt（聚合根）     | 方法调用 | 任意登录尝试        | 调用LoginAttempt.record()记录登录尝试，调用isLocked()判断锁定状态 |
    | INTRA-203 | AuthenticationService   | VerificationCode（聚合根） | 方法调用 | 短信/邮件验证码登录 | 调用VerificationCode.verify()校验验证码                           |
    | INTRA-204 | AuthenticationService   | SocialConnection（聚合根） | 方法调用 | 社交账号登录        | 调用SocialConnection.authenticate()查找绑定关系                   |
    | INTRA-205 | TokenService            | Token（聚合）              | 方法调用 | 登录成功后签发令牌  | 调用AccessToken.generate()和RefreshToken.create()签发令牌对       |
    | INTRA-206 | TokenService            | TokenBlacklist（实体）     | 方法调用 | 令牌撤销            | 调用TokenBlacklist.add(tokenId)将令牌加入黑名单                   |
    | INTRA-207 | SessionService          | Session（聚合根）          | 方法调用 | 登录成功后创建会话  | 调用Session.create()创建会话，调用Session.terminate()终止会话     |
    | INTRA-208 | SessionService          | Session（聚合根）          | 方法调用 | 多端登录策略执行    | 调用kickConflictSessions()根据策略踢出冲突会话                    |
    | INTRA-209 | VerificationCodeService | VerificationCode（聚合根） | 方法调用 | 发送验证码          | 调用VerificationCode.generate()生成验证码                         |
    | INTRA-210 | AuthenticationService   | TokenService               | 方法调用 | 认证成功后          | 认证通过后调用TokenService.issueTokens()签发令牌                  |
    | INTRA-211 | AuthenticationService   | SessionService             | 方法调用 | 认证成功后          | 认证通过后调用SessionService.createSession()创建会话              |

    表 5.3.11.1-1 领域内协作关系

#### 5.3.11.2 跨领域协作

+   认证管理子领域与其他子领域的跨领域协作通过事件驱动和RPC调用两种方式实现。

##### 与用户管理子领域（第3章）的协作

+   认证管理与用户管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                               |
    | --------- | ------------------- | -------- | ------------------------------------------- | ------------------------------------------------------------------ |
    | CROSS-201 | 认证管理 → 用户管理 | RPC调用  | UserQueryService.getUserMfaStatus()         | 登录流程中判断是否需要双因素验证                                   |
    | CROSS-202 | 认证管理 → 用户管理 | RPC调用  | UserQueryService.getUserBasicInfoForToken() | 签发Token时获取用户基本信息（userId、userPool、tenantCode、roles） |
    | CROSS-203 | 用户管理 → 认证管理 | 领域事件 | UserDisabled                                | 用户禁用后，认证子领域强制终止该用户所有会话并撤销Token            |
    | CROSS-204 | 用户管理 → 认证管理 | 领域事件 | UserDeleted                                 | 用户删除后，认证子领域强制终止该用户所有会话并撤销Token            |
    | CROSS-205 | 用户管理 → 认证管理 | 领域事件 | UserCancelled                               | 用户注销完成后，认证子领域清理该用户所有Token和会话                |
    | CROSS-206 | 用户管理 → 认证管理 | 领域事件 | UserPasswordChanged / UserPasswordReset     | 密码变更后，认证子领域可选撤销该用户现有Token（根据安全策略配置）  |

    表 5.3.11.2-1 与用户管理子领域的协作

+   协作说明：
    -   CROSS-201~206与第3章表3.3.8.2-2中CROSS-011~016为同一组协作的双视角描述，此处从认证管理作为参与方的角度补充
    -   CROSS-201、202为认证管理主动发起的RPC调用，认证管理通过UserQueryService获取用户信息，不直接访问用户管理聚合
    -   CROSS-203~206为认证管理被动接收的领域事件，认证管理通过@EventListener监听并执行令牌/会话清理

##### 与组织管理子领域（第4章）的协作

+   认证管理与组织管理之间无直接协作。组织管理通过用户管理子领域间接与认证管理交互：组织管理发布的PersonResigned事件由用户管理域处理后可能触发UserDisabled事件（CROSS-203），进而由认证管理清理Token和会话。

##### 与授权管理子领域（第6章）的协作

+   认证管理与授权管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                       | 说明                                                                         |
    | --------- | ------------------- | -------- | ----------------------------------- | ---------------------------------------------------------------------------- |
    | CROSS-211 | 授权管理 → 认证管理 | RPC调用  | TokenService.validateAccessToken()  | 授权管理在API网关层调用TokenService验证访问令牌，提取用户身份信息            |
    | CROSS-212 | 认证管理 → 授权管理 | 间接依赖 | Token Payload中包含userId、userPool | 认证管理签发的Token中仅携带用户标识，授权管理据此查询权限，二者通过Token解耦 |

    表 5.3.11.2-2 与授权管理子领域的协作

+   协作说明：
    -   认证管理与授权管理通过Token解耦：认证管理负责签发和验证Token，授权管理负责基于Token中用户信息查询权限
    -   Token中不包含角色和权限列表（参见6.0节设计约定），避免Token过大和权限变更不及时

##### 与审计管理子领域（第7章）的协作

+   认证管理与审计管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                    | 说明                                                                         |
    | --------- | ------------------- | -------- | -------------------------------- | ---------------------------------------------------------------------------- |
    | CROSS-221 | 认证管理 → 审计管理 | 同步调用 | AuditLogService.recordLoginLog() | 登录成功/失败时同步调用审计服务记录登录日志（LOG-L-01至LOG-L-05，见7.2.1节） |
    | CROSS-222 | 认证管理 → 审计管理 | 领域事件 | AccountLocked                    | 账号被锁定后，审计子领域记录安全事件（ACCOUNT_LOCKED，见表7.3.8.1-1）        |
    | CROSS-223 | 认证管理 → 审计管理 | 领域事件 | SessionKicked                    | 会话被踢出后，审计子领域记录安全事件（FORCE_LOGOUT，见表7.3.8.1-1）          |
    | CROSS-224 | 认证管理 → 审计管理 | 领域事件 | SuspiciousLoginDetected          | 检测到可疑登录后，审计子领域记录安全事件（SUSPICIOUS_LOGIN，见表7.3.8.1-1）  |
    | CROSS-225 | 认证管理 → 审计管理 | 领域事件 | PasswordResetRequested           | 请求密码重置后，审计子领域记录安全事件（PASSWORD_RESET_REQ，见表7.3.8.1-1）  |
    | CROSS-226 | 认证管理 → 审计管理 | 领域事件 | MfaVerified                      | 双因素验证成功后，审计子领域记录登录日志（MFA_VERIFIED，见表7.3.8.3-1）      |
    | CROSS-227 | 认证管理 → 审计管理 | 领域事件 | SessionTerminated                | 会话超时失效后，审计子领域记录登录日志（EXPIRED，见表7.3.8.3-1）             |

    表 5.3.11.2-3 与审计管理子领域的协作

+   协作说明：
    -   CROSS-221为同步调用方式，认证管理在登录流程中直接调用审计服务记录登录日志（见7.0节关系说明）
    -   CROSS-222~227为异步领域事件，审计管理通过@EventListener监听，处理失败不影响认证主流程
    -   认证管理发布的PasswordChanged事件不在此表中列出，因审计管理仅监听用户管理侧的UserPasswordChanged事件（见表5.3.10-1事件归属说明）

##### 与配置管理子领域（第9章）的协作

+   认证管理与配置管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                | 说明                                                                                    |
    | --------- | ------------------- | -------- | ---------------------------- | --------------------------------------------------------------------------------------- |
    | CROSS-231 | 认证管理 → 配置管理 | RPC调用  | ConfigService.getEffective() | 获取三级合并后的配置生效值，如令牌有效期、会话超时、登录失败锁定阈值等（见表9.3.1.3-1） |
    | CROSS-232 | 认证管理 → 配置管理 | RPC调用  | ConfigService.batchGet()     | 批量获取多个配置键的生效值，如登录流程中一次性获取密码策略、MFA策略、会话策略等         |
    | CROSS-233 | 配置管理 → 认证管理 | 领域事件 | TenantConfigChanged          | 租户配置变更后，认证管理域刷新缓存的配置值（如令牌有效期、锁定阈值变更即时生效）        |

    表 5.3.11.2-4 与配置管理子领域的协作

+   协作说明：
    -   CROSS-231、232对应第9章表9.3.1.3-1中RPC-CFG-01、RPC-CFG-02，调用方标注为"BC-10认证子域"
    -   认证管理使用ConfigService的典型配置键包括：AccessToken有效期、RefreshToken有效期、会话有效期、空闲超时、登录失败锁定次数/时长、密码最小长度、MFA强制策略、多端登录策略等
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口作为基础设施供所有子领域使用，已在此处作为跨领域协作列出

##### 与通知上下文（BC-12）的协作

+   认证管理与通知上下文之间的协作关系如下表所示。

    | 协作编号  | 方向             | 协作方式 | 触发事件/接口           | 说明                                                     |
    | --------- | ---------------- | -------- | ----------------------- | -------------------------------------------------------- |
    | CROSS-241 | 认证管理 → BC-12 | 领域事件 | LoginSucceeded          | 通知上下文在新设备登录时发送安全提醒通知                 |
    | CROSS-242 | 认证管理 → BC-12 | 领域事件 | PasswordChanged         | 通知上下文发送密码变更安全通知                           |
    | CROSS-243 | 认证管理 → BC-12 | 领域事件 | PasswordResetRequested  | 通知上下文发送密码重置确认通知                           |
    | CROSS-244 | 认证管理 → BC-12 | 领域事件 | AccountLocked           | 通知上下文发送账号锁定告警通知                           |
    | CROSS-245 | 认证管理 → BC-12 | 领域事件 | SessionKicked           | 通知上下文发送被强制下线通知                             |
    | CROSS-246 | 认证管理 → BC-12 | 领域事件 | SuspiciousLoginDetected | 通知上下文发送可疑登录告警通知（异地登录、新设备登录等） |

    表 5.3.11.2-5 与通知上下文（BC-12）的协作

+   协作说明：
    -   CROSS-241~246对应表5.3.10-1中订阅者标注为"通知"或"安全通知"的领域事件
    -   通知上下文的具体通知方式（短信/邮件/站内信）由BC-12自行决策，认证管理仅发布事件
    -   短信/邮件验证码的发送通过CaptchaService（共享服务）经BC-12的防腐层Gateway实现（见8.4.3节），不属于领域事件协作

#### 5.3.11.3 共享服务协作

+   认证管理子领域使用的共享服务（第8章）协作关系如下表所示。

    | 协作编号  | 共享服务        | 调用方法               | 调用场景                                         | 参考章节 |
    | --------- | --------------- | ---------------------- | ------------------------------------------------ | -------- |
    | SHARE-201 | PasswordService | verifyPassword()       | 密码登录时验证用户输入密码与存储哈希是否匹配     | 8.3.2    |
    | SHARE-202 | CaptchaService  | generateImageCaptcha() | 登录页面生成图形验证码                           | 8.4.2    |
    | SHARE-203 | CaptchaService  | verifyImageCaptcha()   | 登录时校验用户输入的图形验证码                   | 8.4.2    |
    | SHARE-204 | CaptchaService  | sendSmsCode()          | 短信验证码登录、双因素验证时发送短信验证码       | 8.4.2    |
    | SHARE-205 | CaptchaService  | verifyCode()           | 校验登录/双因素验证场景下的短信/邮件验证码       | 8.4.2    |
    | SHARE-206 | MfaService      | isUserMfaEnabled()     | 登录流程中查询用户是否启用MFA，决定是否需双因素  | 8.5.2    |
    | SHARE-207 | MfaService      | verifyTotp()           | 双因素认证时验证用户输入的TOTP码                 | 8.5.2    |
    | SHARE-208 | MfaService      | verifyBackupCode()     | 用户无法使用TOTP时，通过备用恢复码完成双因素验证 | 8.5.2    |

    表 5.3.11.3-1 共享服务协作关系

+   共享服务协作说明：
    -   PasswordService和CaptchaService的方法签名与第8章定义保持一致，详细参数和约束见表8.3.2-1和表8.4.2-1
    -   TokenService虽列入共享服务（表8.1.2-1），但在认证管理内以领域服务形式定义（5.3.9.2节），其所有方法均在领域内协作（表5.3.11.1-1中INTRA-205、206）中体现，不再重复列入共享服务协作表
    -   CaptchaService的sendSmsCode()底层通过BC-12（通知上下文）的防腐层Gateway发送短信，认证管理不直接对接短信供应商（见8.4.3节设计约束）
    -   MfaService的绑定/解绑方法（generateSecret、confirmBinding、unbindDevice、generateBackupCodes）归属用户管理子领域调用（MFA设备属于用户身份管理），认证管理仅调用验证类方法
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口（表9.3.1.3-1）作为基础设施供所有子领域使用，已在5.3.11.2中作为跨领域协作列出

## 5.4 接口设计

+   本节设计认证管理子领域的API接口，按接口类型分为REST API、RPC和消息三类。
+   REST API按用户群分为运营用户群（UP-AUTH）、租户用户群（UR-AUTH）、C端用户群（UC-AUTH）和公共接口（COMMON）。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 5.4.1 接口总览

#### 5.4.1.1 接口分类统计

+   认证管理子领域的接口按类型分类统计如下表所示。

    | 接口类型 | 数量 | 说明                          |
    | -------- | ---- | ----------------------------- |
    | REST接口 | 32个 | 面向前端的HTTP API            |
    | RPC接口  | 1个  | 面向授权管理子领域的内部Feign |
    | 消息接口 | 13个 | 领域事件发布                  |

    表 5.4.1.1-1 接口分类统计

+   REST接口按用户群和功能分组如下表所示。

    | 分组    | 前缀            | 接口数量 | 说明               |
    | ------- | --------------- | -------- | ------------------ |
    | UP-AUTH | /api/v1/up/auth | 6        | 运营用户群认证接口 |
    | UR-AUTH | /api/v1/ur/auth | 12       | 租户用户群认证接口 |
    | UC-AUTH | /api/v1/uc/auth | 10       | C端用户群认证接口  |
    | COMMON  | /api/v1/auth    | 4        | 公共认证接口       |

    表 5.4.1.1-2 REST接口分组总览

+   说明：
    -   RPC接口供授权管理子领域（第6章）通过Feign调用
    -   消息接口通过领域事件发布，事件定义详见表 5.3.10-1

#### 5.4.1.2 REST API清单表

+   认证管理REST API清单如下表所示。

    | API编号    | API名称                | 方法   | 路径                               | 权限 | 领域方法                                                | 备注           |
    | ---------- | ---------------------- | ------ | ---------------------------------- | ---- | ------------------------------------------------------- | -------------- |
    | UP-AUTH-01 | 运营用户群登录（密码） | POST   | /api/v1/up/auth/login              | UP   | Credential.verifyPassword() + LoginAttempt.record()     | SaaS需MFA      |
    | UP-AUTH-02 | 运营用户群登录验证短信 | POST   | /api/v1/up/auth/login/verify-sms   | UP   | VerificationCode.verify() + Token.issue()               | MFA第二步      |
    | UP-AUTH-03 | 运营用户群登出         | POST   | /api/v1/up/auth/logout             | UP   | Token.revoke() + Session.destroy()                      | 可登出全设备   |
    | UP-AUTH-04 | 运营用户群刷新令牌     | POST   | /api/v1/up/auth/token/refresh      | UP   | Token.refresh()                                         | -              |
    | UP-AUTH-05 | 查询当前会话           | GET    | /api/v1/up/auth/sessions           | UP   | SessionQueryService.list()                              | -              |
    | UP-AUTH-06 | 修改密码               | POST   | /api/v1/up/auth/password/change    | UP   | Credential.changePassword()                             | 需验证旧密码   |
    | UR-AUTH-01 | 租户用户群密码登录     | POST   | /api/v1/ur/auth/login/password     | UR   | Credential.verifyPassword() + Token.issue()             | 支持rememberMe |
    | UR-AUTH-02 | 租户用户群短信登录     | POST   | /api/v1/ur/auth/login/sms          | UR   | VerificationCode.verify() + Token.issue()               | 需租户开启     |
    | UR-AUTH-03 | 租户用户群双因素登录   | POST   | /api/v1/ur/auth/login/password-sms | UR   | Credential.verifyPassword() + VerificationCode.verify() | 双因素         |
    | UR-AUTH-04 | 租户用户群SSO登录      | POST   | /api/v1/ur/auth/login/sso          | UR   | SsoService.validateToken() + Token.issue()              | OIDC/SAML/CAS  |
    | UR-AUTH-05 | 企业身份源登录         | POST   | /api/v1/ur/auth/login/enterprise   | UR   | EnterpriseIdpService.authenticate()                     | 企微/钉钉/飞书 |
    | UR-AUTH-06 | 企业内免密登录         | POST   | /api/v1/ur/auth/login/passwordless | UR   | PasswordlessService.validate()                          | IP范围限制     |
    | UR-AUTH-07 | 扫码登录确认           | POST   | /api/v1/ur/auth/login/scan         | UR   | ScanLoginService.confirm() + Token.issue()              | 移动端确认     |
    | UR-AUTH-08 | 租户用户群登出         | POST   | /api/v1/ur/auth/logout             | UR   | Token.revoke() + Session.destroy()                      | 可登出全设备   |
    | UR-AUTH-09 | 租户用户群刷新令牌     | POST   | /api/v1/ur/auth/token/refresh      | UR   | Token.refresh()                                         | -              |
    | UR-AUTH-10 | 查询用户会话列表       | GET    | /api/v1/ur/auth/sessions           | UR   | SessionQueryService.list()                              | -              |
    | UR-AUTH-11 | 终止指定会话           | DELETE | /api/v1/ur/auth/sessions/{id}      | UR   | Session.terminate()                                     | 踢出其他设备   |
    | UR-AUTH-12 | 修改密码               | POST   | /api/v1/ur/auth/password/change    | UR   | Credential.changePassword()                             | 同步用户受限   |
    | UC-AUTH-01 | C端用户群短信登录      | POST   | /api/v1/uc/auth/login/sms          | UC   | VerificationCode.verify() + Token.issue()               | 主要登录方式   |
    | UC-AUTH-02 | C端用户群密码登录      | POST   | /api/v1/uc/auth/login/password     | UC   | Credential.verifyPassword() + Token.issue()             | -              |
    | UC-AUTH-03 | 社交账号登录           | POST   | /api/v1/uc/auth/login/social       | UC   | SocialConnection.authenticate()                         | 微信/QQ等      |
    | UC-AUTH-04 | 生物识别登录           | POST   | /api/v1/uc/auth/login/biometric    | UC   | BiometricService.verify()                               | 指纹/面容      |
    | UC-AUTH-05 | C端用户群登出          | POST   | /api/v1/uc/auth/logout             | UC   | Token.revoke() + Session.destroy()                      | -              |
    | UC-AUTH-06 | C端用户群刷新令牌      | POST   | /api/v1/uc/auth/token/refresh      | UC   | Token.refresh()                                         | -              |
    | UC-AUTH-07 | 查询社交绑定列表       | GET    | /api/v1/uc/auth/social/bindList    | UC   | SocialConnectionQueryService.list()                     | -              |
    | UC-AUTH-08 | 绑定社交账号           | POST   | /api/v1/uc/auth/social/bindList    | UC   | SocialConnection.bind()                                 | -              |
    | UC-AUTH-09 | 解绑社交账号           | DELETE | /api/v1/uc/auth/social/{provider}  | UC   | SocialConnection.unbind()                               | 需保留一种方式 |
    | UC-AUTH-10 | 修改密码               | POST   | /api/v1/uc/auth/password/change    | UC   | Credential.changePassword()                             | -              |
    | COMMON-01  | 获取图形验证码         | POST   | /api/v1/auth/captcha               | 公共 | CaptchaService.generate()                               | -              |
    | COMMON-03  | 获取扫码登录二维码     | GET    | /api/v1/auth/scan/qrcode           | 公共 | ScanLoginService.generateQrCode()                       | 有效期5分钟    |
    | COMMON-04  | 查询扫码状态           | GET    | /api/v1/auth/scan/status           | 公共 | ScanLoginService.getStatus()                            | 轮询接口       |

    表 5.4.1.2-1 认证管理REST API清单表

    +   注：原COMMON-02（发送短信验证码）已合并至PUB-06（发送验证码，见3.4.4.4.7节），PUB-06同时支持短信和邮箱通道，统一作为全局验证码发送入口。

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第5.3节领域模型设计中的聚合方法或领域服务方法
    -   备注：简要说明接口的特殊情况或限制条件

#### 5.4.1.3 RPC接口清单表

+   认证管理子领域提供的RPC接口清单如下表所示。

    | 接口编号    | 接口名称     | 调用方        | 接口类型 | 领域方法                           | 说明                                                                     |
    | ----------- | ------------ | ------------- | -------- | ---------------------------------- | ------------------------------------------------------------------------ |
    | RPC-AUTH-01 | 验证访问令牌 | BC-10授权子域 | Feign    | TokenService.validateAccessToken() | 授权管理在API网关层调用，验证访问令牌并提取用户身份信息（对应CROSS-211） |

    表 5.4.1.3-1 RPC接口清单表

+   说明：
    -   RPC-AUTH-01对应5.3.11.2中CROSS-211协作关系，授权管理通过该RPC接口验证请求中的Access Token
    -   认证管理同时作为RPC调用方，调用用户管理子领域的UserFeignClient（RPC-USR-01、RPC-USR-02，见第3章表3.4.1.3-1）和配置管理子领域的ConfigService（CROSS-231、CROSS-232，见第9章表9.3.1.3-1）

#### 5.4.1.4 消息接口清单表

+   认证管理子领域发布的消息接口清单如下表所示。

    | 接口编号    | 消息名称                | 消息类型 | Topic      | 触发领域方法                                          | 消费方                     |
    | ----------- | ----------------------- | -------- | ---------- | ----------------------------------------------------- | -------------------------- |
    | MSG-AUTH-01 | LoginSucceeded          | 领域事件 | iam.events | AuthenticationService.authenticate*()                 | 审计模块（同步）、BC-12    |
    | MSG-AUTH-02 | LoginFailed             | 领域事件 | iam.events | AuthenticationService.authenticate*()                 | 审计模块（同步）、安全监控 |
    | MSG-AUTH-03 | LogoutSucceeded         | 领域事件 | iam.events | Token.revoke() + Session.destroy()                    | 审计模块（同步）           |
    | MSG-AUTH-04 | PasswordChanged         | 领域事件 | iam.events | Credential.changePassword()                           | 令牌撤销、BC-12安全通知    |
    | MSG-AUTH-05 | PasswordResetRequested  | 领域事件 | iam.events | Credential.requestReset()                             | 审计模块、BC-12            |
    | MSG-AUTH-06 | MfaVerified             | 领域事件 | iam.events | AuthenticationService.verifySecondFactor()            | 审计模块                   |
    | MSG-AUTH-07 | SessionCreated          | 领域事件 | iam.events | SessionService.createSession()                        | -                          |
    | MSG-AUTH-08 | SessionTerminated       | 领域事件 | iam.events | SessionService.terminateSession()                     | 审计模块                   |
    | MSG-AUTH-09 | SessionKicked           | 领域事件 | iam.events | SessionService.kickConflictSessions()                 | 审计模块、BC-12            |
    | MSG-AUTH-10 | AccountLocked           | 领域事件 | iam.events | LoginAttempt.record()（连续失败达阈值）               | 审计模块、BC-12            |
    | MSG-AUTH-11 | SuspiciousLoginDetected | 领域事件 | iam.events | AuthenticationService.authenticate*()（风险检测触发） | 审计模块、安全监控、BC-12  |
    | MSG-AUTH-12 | SocialAccountBound      | 领域事件 | iam.events | SocialConnection.bind()                               | -                          |
    | MSG-AUTH-13 | SocialAccountUnbound    | 领域事件 | iam.events | SocialConnection.unbind()                             | -                          |

    表 5.4.1.4-1 消息接口清单表

+   说明：
    -   表中仅列出认证管理子领域自身发布的13个领域事件；表5.3.10-1中SystemConfigChanged、TenantConfigChanged、TenantConfigReset 三个事件由配置管理子领域发布，不计入本表
    -   MSG-AUTH-01（LoginSucceeded）和MSG-AUTH-02（LoginFailed）虽有异步消费方，但登录日志记录（CROSS-221）采用同步调用方式，详见5.3.11.2节
    -   MSG-AUTH-12、MSG-AUTH-13当前消费方为"-"，保留事件定义供未来扩展；审计记录由用户管理侧OAuthBound/Unbound覆盖（见表5.3.10-1事件归属说明）

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第5.3节领域模型设计中的聚合方法或领域服务方法
    -   备注：简要说明接口的特殊情况或限制条件

### 5.4.2 RPC接口设计

+   认证管理子领域通过Feign向BC-10授权子域提供内部RPC接口，供API网关层验证访问令牌。

#### 5.4.2.1 AuthFeignClient

+   **AuthFeignClient 概述**

    | 属性     | 值                                        |
    | -------- | ----------------------------------------- |
    | 接口名称 | AuthFeignClient                           |
    | 职责     | 供BC-10授权子域验证Access Token并提取身份 |
    | 服务名   | svc-iam                                   |
    | 路径前缀 | /internal/iam/auth                        |
    | 降级实现 | AuthFeignClientFallback                   |
    | 默认超时 | 2秒                                       |

    表 5.4.2.1-1 AuthFeignClient概述

+   **方法清单表**

    | 方法                             | 简述                           | HTTP | 路径            | 入参        | 返回        | 超时 | 降级返回     |
    | -------------------------------- | ------------------------------ | ---- | --------------- | ----------- | ----------- | ---- | ------------ |
    | validateAccessToken(accessToken) | 验证访问令牌并提取用户身份信息 | POST | /token/validate | accessToken | TokenClaims | 2秒  | 拒绝放行请求 |

    表 5.4.2.1-2 AuthFeignClient方法清单表

+   **RPC-AUTH-01 validateAccessToken 契约**

    | 属性     | 值                                                                                                         |
    | -------- | ---------------------------------------------------------------------------------------------------------- |
    | 接口编号 | RPC-AUTH-01                                                                                                |
    | 调用场景 | 授权管理在API网关层对每个需鉴权的请求调用，验证请求头中的Bearer Token有效性并提取用户身份（对应CROSS-211） |
    | 入参     | accessToken: String（JWT格式的Access Token）                                                               |
    | 返回类型 | TokenClaims                                                                                                |
    | 幂等性   | 是（只读验证）                                                                                             |

    表 5.4.2.1-3 RPC-AUTH-01契约概述

+   **TokenClaims 结构**

    | 字段名     | 数据类型 | 说明                       |
    | ---------- | -------- | -------------------------- |
    | userId     | Long     | 用户ID                     |
    | username   | String   | 用户名                     |
    | userPool   | String   | 用户群标识：UP / UR / UC   |
    | tenantId   | Long     | 租户ID，UP/UC用户为null    |
    | tenantCode | String   | 租户编码，UP/UC用户为null  |
    | tokenId    | String   | Token唯一标识（jti claim） |
    | issuedAt   | DateTime | 签发时间                   |
    | expiresAt  | DateTime | 过期时间                   |

    表 5.4.2.1-4 TokenClaims字段

+   **备注**
    -   该接口为高频调用（每个鉴权请求均触发），需关注性能：建议授权管理侧对JWT签名进行本地验证（持有公钥），仅在需要检查黑名单时调用该RPC
    -   若采用本地公钥验证+Redis黑名单方案，则该RPC可降级为按需调用（检查tokenId是否在黑名单中），具体方案由第6章授权管理设计决定
    -   接口定义在 `bc-10-iam-api` 模块的 `feign` 包下，与UserFeignClient同模块

#### 5.4.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口                | 降级条件        | 降级返回值                          | 日志级别 | 说明                                                           |
    | ------------------- | --------------- | ----------------------------------- | -------- | -------------------------------------------------------------- |
    | validateAccessToken | 超时/服务不可用 | 抛出AuthServiceUnavailableException | ERROR    | 拒绝放行请求，返回503；Token验证不可静默通过，否则存在安全风险 |

    表 5.4.2.2-1 降级策略

+   **降级设计说明**
    -   validateAccessToken降级策略偏严格：Token验证失败意味着无法确认用户身份，必须拒绝请求，不可降级为"允许通过"
    -   与第3章UserFeignClient的getUserBasicInfoForToken（表3.4.2.2-1）降级思路一致：涉及安全校验的接口不允许静默通过
    -   熔断策略：连续10次调用失败后触发熔断，熔断窗口15秒，半开状态允许2个探测请求（阈值高于UserFeignClient，因调用频率更高）

### 5.4.3 消息接口设计

+   认证管理子领域通过领域事件发布消息。所有事件共享统一的通道和封装规范，与第3章用户管理子领域共用同一Topic。

#### 5.4.3.1 消息通道配置

+   认证管理的消息通道配置如下表所示。

    | 通道名称   | Topic/Exchange | 类型  | 说明                                         |
    | ---------- | -------------- | ----- | -------------------------------------------- |
    | iam-events | iam.events     | Topic | IAM领域事件（与用户管理子领域共用同一Topic） |

    表 5.4.3.1-1 消息通道配置

+   **消息规范**
    -   所有领域事件统一发布至 `iam.events` Topic，消费方通过事件类型（`type`字段）过滤订阅
    -   事件消息采用CloudEvents规范封装，包含 `type`、`source`、`id`、`time`、`data` 标准字段
    -   事件发布采用本地事务表（Outbox模式）保证与业务操作的原子性，由后台任务异步投递至消息中间件
    -   消费方必须实现幂等处理，以eventId作为去重键
    -   认证管理发布的事件source统一为 `/bc-10/authentication`，与用户管理的 `/bc-10/user-management` 区分

#### 5.4.3.2 事件公共信封结构

+   所有事件共享以下CloudEvents信封字段，各事件的Payload仅定义 `data` 部分。信封结构与第3章表3.4.3.2-1一致。

    | 信封字段        | 类型     | 说明                                   | 示例值                                 |
    | --------------- | -------- | -------------------------------------- | -------------------------------------- |
    | id              | String   | 事件唯一标识（UUID）                   | "a83bc10b-48cc-4372-b567-1e02b2c3d987" |
    | type            | String   | 事件类型，对应消息名称                 | "LoginSucceeded"                       |
    | source          | String   | 事件来源，格式：/{context}/{subdomain} | "/bc-10/authentication"                |
    | time            | DateTime | 事件发生时间（ISO 8601）               | "2026-01-26T10:30:00Z"                 |
    | datacontenttype | String   | data内容类型                           | "application/json"                     |
    | data            | Object   | 事件Payload（各事件不同，见下文）      | { ... }                                |

    表 5.4.3.2-1 事件公共信封结构

#### 5.4.3.3 登录与登出事件

+   以下事件覆盖用户登录和登出的完整流程，消费方包括审计模块和通知上下文。

##### MSG-AUTH-01 LoginSucceeded

+   **消息概述**

    | 属性     | 值                                                     |
    | -------- | ------------------------------------------------------ |
    | 消息编号 | MSG-AUTH-01                                            |
    | 消息名称 | LoginSucceeded                                         |
    | Topic    | iam.events                                             |
    | 消费方   | 审计模块（同步CROSS-221）、BC-12通知                   |
    | 触发时机 | 任意方式登录成功后（密码/短信/社交/SSO/免密/生物识别） |

    表 5.4.3.3-1 MSG-AUTH-01消息概述

+   **Payload字段说明**

    | 字段名      | 数据类型 | 说明                                                     |
    | ----------- | -------- | -------------------------------------------------------- |
    | userId      | Long     | 用户ID                                                   |
    | userPool    | String   | 用户群：UP / UR / UC                                     |
    | tenantId    | Long     | 租户ID（UR用户），UP/UC为null                            |
    | tenantCode  | String   | 租户编码（UR用户），UP/UC为null                          |
    | loginMethod | String   | 登录方式：PASSWORD/SMS/SOCIAL/SSO/PASSWORDLESS/BIOMETRIC |
    | deviceInfo  | Object   | 设备信息：{deviceType, os, browser, ip, geo}             |
    | sessionId   | String   | 创建的会话ID                                             |
    | loginAt     | DateTime | 登录时间                                                 |

    表 5.4.3.3-2 MSG-AUTH-01 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                                                    | 幂等策略    | 失败处理      |
    | -------- | ----------------------------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录登录日志（LOG-L-01至LOG-L-05，见7.2.1节），同步调用方式 | eventId去重 | 重试3次后告警 |
    | BC-12    | 新设备登录时发送安全提醒通知（对应CROSS-241）               | eventId去重 | 重试3次后告警 |

    表 5.4.3.3-3 MSG-AUTH-01消费方处理

##### MSG-AUTH-02 LoginFailed

+   **消息概述**

    | 属性     | 值                                    |
    | -------- | ------------------------------------- |
    | 消息编号 | MSG-AUTH-02                           |
    | 消息名称 | LoginFailed                           |
    | Topic    | iam.events                            |
    | 消费方   | 审计模块（同步CROSS-221）、安全监控   |
    | 触发时机 | 登录验证失败后（密码错误/账号锁定等） |

    表 5.4.3.3-4 MSG-AUTH-02消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明                                                     |
    | ---------- | -------- | -------------------------------------------------------- |
    | identifier | String   | 登录标识（用户名/手机号/邮箱）                           |
    | userPool   | String   | 用户群：UP / UR / UC                                     |
    | tenantId   | Long     | 租户ID（UR用户），UP/UC为null                            |
    | tenantCode | String   | 租户编码（UR用户），UP/UC为null                          |
    | reason     | String   | 失败原因：WRONG_PASSWORD/ACCOUNT_LOCKED/CAPTCHA_FAILED等 |
    | ip         | String   | 请求IP                                                   |
    | failedAt   | DateTime | 失败时间                                                 |

    表 5.4.3.3-5 MSG-AUTH-02 Payload字段

##### MSG-AUTH-03 LogoutSucceeded

+   **消息概述**

    | 属性     | 值                 |
    | -------- | ------------------ |
    | 消息编号 | MSG-AUTH-03        |
    | 消息名称 | LogoutSucceeded    |
    | Topic    | iam.events         |
    | 消费方   | 审计模块（同步）   |
    | 触发时机 | 用户主动登出成功后 |

    表 5.4.3.3-6 MSG-AUTH-03消息概述

+   **Payload字段说明**

    | 字段名    | 数据类型 | 说明         |
    | --------- | -------- | ------------ |
    | userId    | Long     | 用户ID       |
    | sessionId | String   | 终止的会话ID |
    | logoutAt  | DateTime | 登出时间     |

    表 5.4.3.3-7 MSG-AUTH-03 Payload字段

#### 5.4.3.4 安全与密码事件

+   以下事件与密码管理和双因素认证相关。

    | 消息编号    | 消息名称               | 触发时机       | Payload字段（data部分）                           | 消费方                                    |
    | ----------- | ---------------------- | -------------- | ------------------------------------------------- | ----------------------------------------- |
    | MSG-AUTH-04 | PasswordChanged        | 密码修改成功   | userId, userPool, tenantId, tenantCode, changedAt | 令牌撤销、BC-12（CROSS-242）              |
    | MSG-AUTH-05 | PasswordResetRequested | 请求密码重置   | userId, userPool, email/mobile                    | 审计模块（CROSS-225）、BC-12（CROSS-243） |
    | MSG-AUTH-06 | MfaVerified            | 双因素验证成功 | userId, userPool, mfaMethod(SMS/TOTP)             | 审计模块（CROSS-226）                     |

    表 5.4.3.4-1 安全与密码事件汇总

+   **消费方处理契约**（统一）

    | 消费方   | 处理逻辑                      | 幂等策略    | 失败处理      |
    | -------- | ----------------------------- | ----------- | ------------- |
    | 审计模块 | 记录安全审计日志/登录日志     | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送密码变更/重置安全通知     | eventId去重 | 重试3次后告警 |
    | 令牌撤销 | 根据安全策略配置可选撤销Token | eventId去重 | 重试3次后告警 |

    表 5.4.3.4-2 安全事件消费方处理

+   **PasswordChanged事件归属说明**：
    -   PasswordChanged由认证管理发布，用于触发令牌撤销和安全通知；与用户管理发布的UserPasswordChanged（MSG-USR-07）是同一业务动作的两个视角
    -   审计管理仅监听UserPasswordChanged，不重复监听PasswordChanged（见表5.3.10-1事件归属说明）

#### 5.4.3.5 会话管理事件

+   以下事件覆盖会话的创建、终止和冲突踢出。

##### MSG-AUTH-07 SessionCreated

+   **消息概述**

    | 属性     | 值                 |
    | -------- | ------------------ |
    | 消息编号 | MSG-AUTH-07        |
    | 消息名称 | SessionCreated     |
    | Topic    | iam.events         |
    | 消费方   | -                  |
    | 触发时机 | 登录成功创建会话后 |

    表 5.4.3.5-1 MSG-AUTH-07消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明                                         |
    | ---------- | -------- | -------------------------------------------- |
    | sessionId  | String   | 会话ID                                       |
    | userId     | Long     | 用户ID                                       |
    | deviceInfo | Object   | 设备信息：{deviceType, os, browser, ip, geo} |
    | createdAt  | DateTime | 创建时间                                     |

    表 5.4.3.5-2 MSG-AUTH-07 Payload字段

##### MSG-AUTH-08 ~ MSG-AUTH-09 会话终止事件（简表）

+   以下会话终止类事件结构相似，以简表列出差异。

    | 消息编号    | 消息名称          | 触发时机           | 特有Payload字段                                 | 消费方                                    |
    | ----------- | ----------------- | ------------------ | ----------------------------------------------- | ----------------------------------------- |
    | MSG-AUTH-08 | SessionTerminated | 会话超时或主动终止 | sessionId, reason(TIMEOUT/MANUAL), terminatedAt | 审计模块（CROSS-227）                     |
    | MSG-AUTH-09 | SessionKicked     | 多端登录策略踢出   | sessionId, reason, kickedBy(策略名), kickedAt   | 审计模块（CROSS-223）、BC-12（CROSS-245） |

    表 5.4.3.5-3 会话终止事件简表

+   **公共Payload字段**：sessionId, userId

+   **MSG-AUTH-09消费方处理契约**

    | 消费方   | 处理逻辑                     | 幂等策略    | 失败处理      |
    | -------- | ---------------------------- | ----------- | ------------- |
    | 审计模块 | 记录安全事件（FORCE_LOGOUT） | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送被强制下线通知           | eventId去重 | 重试3次后告警 |

    表 5.4.3.5-4 MSG-AUTH-09消费方处理

#### 5.4.3.6 风险与锁定事件

+   以下事件覆盖账号锁定和可疑登录检测，涉及审计和安全监控。

##### MSG-AUTH-10 AccountLocked

+   **消息概述**

    | 属性     | 值                                        |
    | -------- | ----------------------------------------- |
    | 消息编号 | MSG-AUTH-10                               |
    | 消息名称 | AccountLocked                             |
    | Topic    | iam.events                                |
    | 消费方   | 审计模块（CROSS-222）、BC-12（CROSS-244） |
    | 触发时机 | 连续登录失败达阈值后账号被锁定            |

    表 5.4.3.6-1 MSG-AUTH-10消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明                          |
    | ---------- | -------- | ----------------------------- |
    | identifier | String   | 登录标识                      |
    | userPool   | String   | 用户群                        |
    | tenantId   | Long     | 租户ID（UR用户），UP/UC为null |
    | tenantCode | String   | 租户编码                      |
    | lockUntil  | DateTime | 锁定截止时间                  |
    | failCount  | Integer  | 连续失败次数                  |
    | lockedAt   | DateTime | 锁定时间                      |

    表 5.4.3.6-2 MSG-AUTH-10 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                       | 幂等策略    | 失败处理      |
    | -------- | ------------------------------ | ----------- | ------------- |
    | 审计模块 | 记录安全事件（ACCOUNT_LOCKED） | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送账号锁定告警通知           | eventId去重 | 重试3次后告警 |

    表 5.4.3.6-3 MSG-AUTH-10消费方处理

##### MSG-AUTH-11 SuspiciousLoginDetected

+   **消息概述**

    | 属性     | 值                                                     |
    | -------- | ------------------------------------------------------ |
    | 消息编号 | MSG-AUTH-11                                            |
    | 消息名称 | SuspiciousLoginDetected                                |
    | Topic    | iam.events                                             |
    | 消费方   | 审计模块（CROSS-224）、安全监控、BC-12（CROSS-246）    |
    | 触发时机 | 登录流程中检测到风险行为（异地登录/新设备/异常时段等） |

    表 5.4.3.6-4 MSG-AUTH-11消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型 | 说明                                          |
    | ---------- | -------- | --------------------------------------------- |
    | userId     | Long     | 用户ID                                        |
    | userPool   | String   | 用户群                                        |
    | riskType   | String   | 风险类型：GEO_ANOMALY/NEW_DEVICE/TIME_ANOMALY |
    | ip         | String   | 请求IP                                        |
    | geo        | String   | IP归属地                                      |
    | detectedAt | DateTime | 检测时间                                      |

    表 5.4.3.6-5 MSG-AUTH-11 Payload字段

#### 5.4.3.7 社交账号事件

+   以下事件与C端用户社交账号绑定/解绑相关，当前消费方为空，保留供未来扩展。

    | 消息编号    | 消息名称             | 触发时机     | Payload字段（data部分）           | 消费方 |
    | ----------- | -------------------- | ------------ | --------------------------------- | ------ |
    | MSG-AUTH-12 | SocialAccountBound   | 社交账号绑定 | userId, provider, openId, boundAt | -      |
    | MSG-AUTH-13 | SocialAccountUnbound | 社交账号解绑 | userId, provider, unboundAt       | -      |

    表 5.4.3.7-1 社交账号事件汇总

+   **社交账号事件归属说明**：
    -   SocialAccountBound/Unbound保留事件定义但消费方为"-"
    -   审计记录由用户管理侧的OAuthBound/Unbound事件通过@OperationLog注解覆盖（见表5.3.10-1事件归属说明）

### 5.4.4 REST接口设计

#### 5.4.4.1 运营用户群认证接口（UP-AUTH）

##### 5.4.4.1.1 UP-AUTH-01 运营用户群登录（密码）

+   **契约概述表**

    | 属性       | 值                                                                                 |
    | ---------- | ---------------------------------------------------------------------------------- |
    | API编号    | UP-AUTH-01                                                                         |
    | 接口路径   | POST /api/v1/up/auth/login                                                         |
    | 功能简述   | 运营用户群用户名密码登录第一步，验证密码后发送短信（SaaS）或直接签发令牌（私有化） |
    | 所需权限   | 无（公开接口）                                                                     |
    | 关联功能   | F-AUTH-01 运营用户群登录                                                           |
    | 关联用例   | UC-AUTH-01 运营用户群用户登录系统                                                  |
    | 关联领域   | Credential.verifyPassword(), LoginAttempt.record(), LoginLockout.isLocked()        |
    | 关联规则   | CR-R-01（密码验证）, LA-R-01（连续失败锁定）, LA-R-02（锁定时长15分钟）            |
    | 幂等性     | 否（每次登录记录尝试）                                                             |
    | 关联错误码 | E-400001, E-400007, E-401003, E-401004, E-401005, E-401006                         |

    表 5.4.4.1.1-1 UP-AUTH-01契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束            | 示例值                   | 业务含义        |
    | ----------- | ---- | ------ | ---- | --------------- | ------------------------ | --------------- |
    | username    | body | String | 是   | 3-32位          | "admin"                  | 登录用户名      |
    | password    | body | String | 是   | RSA加密后的密文 | "YWJjZGVm..."            | 密码（RSA加密） |
    | captchaId   | body | String | 是   | UUID            | "a1b2c3d4-e5f6-..."      | 图形验证码ID    |
    | captchaCode | body | String | 是   | 4位字母数字     | "Ab12"                   | 图形验证码      |
    | deviceId    | body | String | 否   | ≤64字符         | "device_fingerprint_123" | 设备指纹        |

    表 5.4.4.1.1-2 UP-AUTH-01请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                      | 业务含义                       |
    | ----------------- | ------- | ---- | --------------------------- | ------------------------------ |
    | code              | Number  | 是   | 0                           | 响应码                         |
    | message           | String  | 是   | "需要短信验证"              | 响应消息                       |
    | data.requireMfa   | Boolean | 是   | true                        | 是否需要短信验证（SaaS为true） |
    | data.ticket       | String  | 否   | "mfa_ticket_abc123..."      | 临时票据（需要MFA时返回）      |
    | data.maskedMobile | String  | 否   | "138****8000"               | 脱敏手机号（需要MFA时返回）    |
    | data.accessToken  | String  | 否   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌（私有化部署直接返回） |
    | data.refreshToken | String  | 否   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌（私有化部署直接返回） |
    | data.expiresIn    | Number  | 否   | 7200                        | 令牌有效期秒数                 |

    表 5.4.4.1.1-3 UP-AUTH-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "username": "admin",
          "password": "YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXo=",
          "captchaId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          "captchaCode": "Ab12",
          "deviceId": "device_fingerprint_123"
        }
        ```

    +   成功响应Mock（SaaS部署，需MFA）

        ```json
        {
          "code": 200,
          "message": "需要短信验证",
          "data": {
            "requireMfa": true,
            "ticket": "mfa_ticket_abc123def456ghi789",
            "maskedMobile": "138****8000"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（私有化部署，直接登录）

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "requireMfa": false,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 1,
              "username": "admin",
              "realName": "系统管理员"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（账号锁定）

        ```json
        {
          "code": 401004,
          "message": "账号已被锁定，请15分钟后重试",
          "data": {
            "lockoutUntil": "2026-01-26T10:15:00",
            "remainingMinutes": 12
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.1.2 UP-AUTH-02 运营用户群登录验证短信

+   **契约概述表**

    | 属性       | 值                                                          |
    | ---------- | ----------------------------------------------------------- |
    | API编号    | UP-AUTH-02                                                  |
    | 接口路径   | POST /api/v1/up/auth/login/verify-sms                       |
    | 功能简述   | 运营用户群登录第二步，验证短信验证码完成双因素认证          |
    | 所需权限   | 无（公开接口）                                              |
    | 关联功能   | F-AUTH-02 运营用户群双因素登录                              |
    | 关联用例   | UC-AUTH-02 平台用户双因素登录                               |
    | 关联领域   | Credential.verifySms(), Token.issue(), Session.create()     |
    | 关联规则   | TK-R-01（ticket有效期5分钟）, SMS-R-01（验证码有效期5分钟） |
    | 幂等性     | 否（每次验证成功创建新会话）                                |
    | 关联错误码 | E-400001, E-401011, E-401012, E-401018                      |

    表 5.4.4.1.2-1 UP-AUTH-02契约概述表

+   **请求契约表**

    | 参数名  | 位置 | 类型   | 必填 | 约束            | 示例值          | 业务含义             |
    | ------- | ---- | ------ | ---- | --------------- | --------------- | -------------------- |
    | ticket  | body | String | 是   | 64位URL安全字符 | "tkt_abc123..." | 第一步返回的临时票据 |
    | smsCode | body | String | 是   | 6位数字         | "123456"        | 短信验证码           |

    表 5.4.4.1.2-2 UP-AUTH-02请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                      | 业务含义     |
    | ------------------ | ------ | ---- | --------------------------- | ------------ |
    | code               | Number | 是   | 0                           | 响应码       |
    | message            | String | 是   | "登录成功"                  | 响应消息     |
    | data.accessToken   | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌     |
    | data.refreshToken  | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌     |
    | data.expiresIn     | Number | 是   | 7200                        | 有效期秒数   |
    | data.user          | Object | 是   | {...}                       | 用户基本信息 |
    | data.user.id       | Number | 是   | 1                           | 用户ID       |
    | data.user.username | String | 是   | "admin"                     | 用户名       |
    | data.user.realName | String | 是   | "系统管理员"                | 真实姓名     |

    表 5.4.4.1.2-3 UP-AUTH-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "ticket": "tkt_abc123def456ghi789jkl012mno345pqr678stu901vwx234",
          "smsCode": "123456"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 1,
              "username": "admin",
              "realName": "系统管理员"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（ticket已过期）

        ```json
        {
          "code": 401011,
          "message": "登录票据已过期，请重新登录",
          "data": {
            "expiredAt": "2026-01-26T09:55:00",
            "suggestion": "请返回登录页重新输入密码"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（验证码错误）

        ```json
        {
          "code": 401018,
          "message": "短信验证码错误",
          "data": {
            "remainingAttempts": 2
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   ticket有效期5分钟，过期返回E-401011
    -   短信验证码有效期5分钟，错误返回E-401018
    -   验证成功后签发令牌并创建会话

##### 5.4.4.1.3 UP-AUTH-03 运营用户群登出

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UP-AUTH-03                             |
    | 接口路径   | POST /api/v1/up/auth/logout            |
    | 功能简述   | 运营用户群用户登出，可选择登出所有设备 |
    | 所需权限   | 需要Access Token                       |
    | 关联功能   | F-AUTH-03 登出                         |
    | 关联用例   | UC-AUTH-03 平台用户登出系统            |
    | 关联领域   | Token.revoke(), Session.destroy()      |
    | 关联规则   | SS-R-02（会话销毁）                    |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-401001, E-401002                     |

    表 5.4.4.1.3-1 UP-AUTH-03契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型    | 必填 | 约束      | 示例值 | 业务含义         |
    | ---------- | ---- | ------- | ---- | --------- | ------ | ---------------- |
    | allDevices | body | Boolean | 否   | 默认false | false  | 是否登出所有设备 |

    表 5.4.4.1.3-2 UP-AUTH-03请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值     | 业务含义       |
    | ----------------- | ------- | ---- | ---------- | -------------- |
    | code              | Number  | 是   | 0          | 响应码         |
    | message           | String  | 是   | "登出成功" | 响应消息       |
    | data.loggedOut    | Boolean | 是   | true       | 是否成功登出   |
    | data.revokedCount | Number  | 否   | 3          | 撤销的令牌数量 |

    表 5.4.4.1.3-3 UP-AUTH-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "allDevices": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登出成功",
          "data": {
            "loggedOut": true,
            "revokedCount": 3
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   撤销当前令牌并销毁当前会话
    -   allDevices=true时撤销用户所有令牌和会话

##### 5.4.4.1.4 UP-AUTH-04 运营用户群刷新令牌

+   **契约概述表**

    | 属性       | 值                                    |
    | ---------- | ------------------------------------- |
    | API编号    | UP-AUTH-04                            |
    | 接口路径   | POST /api/v1/up/auth/token/refresh    |
    | 功能简述   | 使用Refresh Token获取新的Access Token |
    | 所需权限   | 无（需要有效的Refresh Token）         |
    | 关联功能   | F-AUTH-04 运营用户群令牌刷新          |
    | 关联用例   | UC-AUTH-04 运营用户群用户刷新访问令牌 |
    | 关联领域   | Token.refresh()                       |
    | 关联规则   | TK-R-01（Refresh Token有效性）        |
    | 幂等性     | 否（每次生成新令牌）                  |
    | 关联错误码 | E-400001, E-401005, E-401006          |

    表 5.4.4.1.4-1 UP-AUTH-04契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束    | 示例值                    | 业务含义 |
    | ------------ | ---- | ------ | ---- | ------- | ------------------------- | -------- |
    | refreshToken | body | String | 是   | JWT格式 | "eyJhbGciOiJSUzI1NiIs..." | 刷新令牌 |

    表 5.4.4.1.4-2 UP-AUTH-04请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                    | 业务含义               |
    | ----------------- | ------ | ---- | ------------------------- | ---------------------- |
    | code              | Number | 是   | 0                         | 响应码                 |
    | message           | String | 是   | "刷新成功"                | 响应消息               |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..." | 新的访问令牌           |
    | data.refreshToken | String | 否   | "eyJhbGciOiJSUzI1NiIs..." | 新的刷新令牌（轮换时） |
    | data.expiresIn    | Number | 是   | 7200                      | 访问令牌有效期秒数     |
    | data.tokenType    | String | 是   | "Bearer"                  | 令牌类型               |

    表 5.4.4.1.4-3 UP-AUTH-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "refreshToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "刷新成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.newtoken...",
            "expiresIn": 7200,
            "tokenType": "Bearer"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（Refresh Token已过期）

        ```json
        {
          "code": 401005,
          "message": "刷新令牌已过期，请重新登录",
          "data": {
            "expiredAt": "2026-01-25T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.1.5 UP-AUTH-05 查询当前会话

+   **契约概述表**

    | 属性       | 值                                    |
    | ---------- | ------------------------------------- |
    | API编号    | UP-AUTH-05                            |
    | 接口路径   | GET /api/v1/up/auth/sessions          |
    | 功能简述   | 查询当前用户的所有活跃会话列表        |
    | 所需权限   | 登录即可                              |
    | 关联功能   | F-AUTH-05 运营用户群会话查询          |
    | 关联用例   | UC-AUTH-05 运营用户群用户查看活跃会话 |
    | 关联领域   | SessionQueryService.list()            |
    | 关联规则   | 无                                    |
    | 幂等性     | 是                                    |
    | 关联错误码 | E-401001, E-401002                    |

    表 5.4.4.1.5-1 UP-AUTH-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 5.4.4.1.5-2 UP-AUTH-05请求契约表

+   **响应契约表**

    | 参数名              | 类型    | 必有 | 示例值                | 业务含义     |
    | ------------------- | ------- | ---- | --------------------- | ------------ |
    | code                | Number  | 是   | 0                     | 响应码       |
    | message             | String  | 是   | "success"             | 响应消息     |
    | data[]              | Array   | 是   | [...]                 | 会话列表     |
    | data[].sessionId    | String  | 是   | "sess-aa0e8400-..."   | 会话ID       |
    | data[].deviceType   | String  | 是   | "PC"                  | 设备类型     |
    | data[].deviceName   | String  | 否   | "Chrome on Windows"   | 设备名称     |
    | data[].clientIp     | String  | 是   | "192.168.1.100"       | 客户端IP     |
    | data[].location     | String  | 否   | "北京市"              | IP归属地     |
    | data[].loginAt      | String  | 是   | "2026-01-25T10:00:00" | 登录时间     |
    | data[].lastActiveAt | String  | 是   | "2026-01-26T09:00:00" | 最后活跃时间 |
    | data[].isCurrent    | Boolean | 是   | true                  | 是否当前会话 |

    表 5.4.4.1.5-3 UP-AUTH-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "sessionId": "sess-aa0e8400-e29b-41d4-a716-446655440001",
              "deviceType": "PC",
              "deviceName": "Chrome on Windows",
              "clientIp": "192.168.1.100",
              "location": "北京市",
              "loginAt": "2026-01-25T10:00:00",
              "lastActiveAt": "2026-01-26T09:00:00",
              "isCurrent": true
            },
            {
              "sessionId": "sess-bb0e8400-e29b-41d4-a716-446655440002",
              "deviceType": "MOBILE",
              "deviceName": "iOS App",
              "clientIp": "10.0.0.50",
              "location": "上海市",
              "loginAt": "2026-01-24T15:00:00",
              "lastActiveAt": "2026-01-25T20:00:00",
              "isCurrent": false
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.1.6 UP-AUTH-06 修改密码

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | UP-AUTH-06                                     |
    | 接口路径   | POST /api/v1/up/auth/password/change           |
    | 功能简述   | 修改当前用户密码，需验证旧密码                 |
    | 所需权限   | 登录即可                                       |
    | 关联功能   | F-AUTH-06 运营用户群密码修改                   |
    | 关联用例   | UC-AUTH-06 运营用户群用户修改密码              |
    | 关联领域   | Credential.changePassword()                    |
    | 关联规则   | PWD-R-01（旧密码验证）, PWD-R-02（密码复杂度） |
    | 幂等性     | 否                                             |
    | 关联错误码 | E-400001, E-401001, E-401008, E-422020         |

    表 5.4.4.1.6-1 UP-AUTH-06契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                 | 示例值        | 业务含义 |
    | ----------- | ---- | ------ | ---- | -------------------- | ------------- | -------- |
    | oldPassword | body | String | 是   | -                    | "OldPass123!" | 旧密码   |
    | newPassword | body | String | 是   | 8-32位，含大小写数字 | "NewPass456@" | 新密码   |

    表 5.4.4.1.6-2 UP-AUTH-06请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "密码修改成功"        | 响应消息 |
    | data.changedAt | String | 是   | "2026-01-26T10:00:00" | 修改时间 |

    表 5.4.4.1.6-3 UP-AUTH-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "oldPassword": "OldPass123!",
          "newPassword": "NewPass456@"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "密码修改成功",
          "data": {
            "changedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（旧密码错误）

        ```json
        {
          "code": 401008,
          "message": "旧密码错误",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（密码复杂度不足）

        ```json
        {
          "code": 422020,
          "message": "新密码不符合复杂度要求",
          "data": {
            "requirements": "至少8位，包含大小写字母和数字"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   修改成功后，其他设备的会话不会被强制登出
    -   密码修改记录会写入审计日志

#### 5.4.4.2 租户用户群认证接口（UR-AUTH）

##### 5.4.4.2.1 UR-AUTH-01 租户用户群密码登录

+   **契约概述表**

    | 属性       | 值                                                                                     |
    | ---------- | -------------------------------------------------------------------------------------- |
    | API编号    | UR-AUTH-01                                                                             |
    | 接口路径   | POST /api/v1/ur/auth/login/password                                                    |
    | 功能简述   | 租户用户群用户通过用户名/邮箱/手机号+密码登录                                          |
    | 所需权限   | 无（公开接口）                                                                         |
    | 关联功能   | F-AUTH-01 租户用户群登录                                                               |
    | 关联用例   | UC-AUTH-01 租户用户登录系统                                                            |
    | 关联领域   | Credential.verifyPassword(), Token.issue(), Session.create(), LoginAttempt.record()    |
    | 关联规则   | CR-R-01（密码验证）, LA-R-01（连续失败锁定）, SS-R-01（会话时长）, TU-R-07（同步用户） |
    | 幂等性     | 否（每次登录创建会话）                                                                 |
    | 关联错误码 | E-400001, E-400007, E-401003, E-401004, E-401005, E-401006, E-404002                   |

    表 5.4.4.2.1-1 UR-AUTH-01契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型    | 必填 | 约束                   | 示例值         | 业务含义                         |
    | ----------- | ---- | ------- | ---- | ---------------------- | -------------- | -------------------------------- |
    | tenantCode  | body | String  | 是   | 3-32字符               | "acme"         | 租户编码                         |
    | username    | body | String  | 是   | 用户名/邮箱/手机号格式 | "zhangsan"     | 登录账号                         |
    | password    | body | String  | 是   | RSA加密后的密文        | "YWJjZGVm..."  | 密码（RSA加密）                  |
    | captchaId   | body | String  | 否   | UUID                   | "a1b2c3d4-..." | 图形验证码ID（配置或失败后需要） |
    | captchaCode | body | String  | 否   | 4位字母数字            | "Xy34"         | 图形验证码                       |
    | deviceId    | body | String  | 否   | ≤64字符                | "device_123"   | 设备指纹                         |
    | rememberMe  | body | Boolean | 否   | 默认false              | true           | 记住登录，延长会话有效期         |

    表 5.4.4.2.1-2 UR-AUTH-01请求契约表

+   **tenantCode获取方式说明**
    -   用户在登录界面输入时采用 `tenantCode\username` 格式（如 `acme\zhangsan`）
    -   前端解析该格式，将tenantCode和username分离后分别传入请求参数
    -   私有化部署场景可配置默认tenantCode，用户仅需输入username

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                      | 业务含义       |
    | ------------------ | ------ | ---- | --------------------------- | -------------- |
    | code               | Number | 是   | 0                           | 响应码         |
    | message            | String | 是   | "登录成功"                  | 响应消息       |
    | data.accessToken   | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌       |
    | data.refreshToken  | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌       |
    | data.expiresIn     | Number | 是   | 7200                        | 令牌有效期秒数 |
    | data.user.id       | Number | 是   | 1001                        | 用户ID         |
    | data.user.username | String | 是   | "zhangsan"                  | 用户名         |
    | data.user.realName | String | 是   | "张三"                      | 真实姓名       |
    | data.user.userType | String | 是   | "ur_user"                   | 用户类型       |
    | data.tenant.id     | Number | 是   | 100                         | 租户ID         |
    | data.tenant.name   | String | 是   | "示例企业"                  | 租户名称       |
    | data.tenant.code   | String | 是   | "acme"                      | 租户编码       |

    表 5.4.4.2.1-3 UR-AUTH-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "acme",
          "username": "zhangsan",
          "password": "YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXo=",
          "deviceId": "device_fingerprint_456",
          "rememberMe": true
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 1001,
              "username": "zhangsan",
              "realName": "张三",
              "userType": "ur_user",
              "orgName": "研发部",
              "positionName": "高级工程师"
            },
            "tenant": {
              "id": 100,
              "name": "示例企业",
              "code": "acme",
              "logo": "https://cdn.example.com/logo.png"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（需要验证码）

        ```json
        {
          "code": 400007,
          "message": "请输入图形验证码",
          "data": {
            "requireCaptcha": true,
            "captchaId": "new_captcha_id_123",
            "captchaImage": "data:image/png;base64,..."
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.2.2 UR-AUTH-02 租户用户群短信登录

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | UR-AUTH-02                                               |
    | 接口路径   | POST /api/v1/ur/auth/login/sms                           |
    | 功能简述   | 租户用户群短信验证码免密登录，需租户开启该功能           |
    | 所需权限   | 无（公开接口）                                           |
    | 关联功能   | F-AUTH-02 租户用户群短信登录                             |
    | 关联用例   | UC-AUTH-02 租户用户短信登录                              |
    | 关联领域   | Credential.verifySms(), Token.issue(), Session.create()  |
    | 关联规则   | TN-R-05（租户需开启短信登录）, TU-R-06（手机号需已注册） |
    | 幂等性     | 否（每次登录创建新会话）                                 |
    | 关联错误码 | E-400001, E-401018, E-404002, E-422121                   |

    表 5.4.4.2.2-1 UR-AUTH-02契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束       | 示例值          | 业务含义   |
    | ---------- | ---- | ------ | ---- | ---------- | --------------- | ---------- |
    | tenantCode | body | String | 是   | 3-32字符   | "acme"          | 租户编码   |
    | mobile     | body | String | 是   | 11位手机号 | "13800138000"   | 手机号     |
    | smsCode    | body | String | 是   | 6位数字    | "123456"        | 短信验证码 |
    | deviceId   | body | String | 否   | 长度≤128   | "device_abc123" | 设备指纹   |

    表 5.4.4.2.2-2 UR-AUTH-02请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义     |
    | ----------------- | ------ | ---- | --------------------------- | ------------ |
    | code              | Number | 是   | 0                           | 响应码       |
    | message           | String | 是   | "登录成功"                  | 响应消息     |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌     |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌     |
    | data.expiresIn    | Number | 是   | 7200                        | 有效期秒数   |
    | data.user         | Object | 是   | {...}                       | 用户基本信息 |
    | data.tenant       | Object | 是   | {...}                       | 租户基本信息 |

    表 5.4.4.2.2-3 UR-AUTH-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "acme",
          "mobile": "13800138000",
          "smsCode": "123456",
          "deviceId": "device_abc123"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 1002,
              "username": "zhangsan",
              "realName": "张三"
            },
            "tenant": {
              "id": 100,
              "name": "示例企业",
              "code": "example"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（租户未开启短信登录）

        ```json
        {
          "code": 422121,
          "message": "该租户未开启短信登录功能",
          "data": {
            "tenantCode": "acme",
            "suggestion": "请使用密码登录或联系管理员"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   需租户开启短信登录功能（tenant.smsLoginEnabled=true）
    -   手机号必须在租户内已注册

##### 5.4.4.2.3 UR-AUTH-03 租户用户群双因素登录

+   **契约概述表**

    | 属性       | 值                                                                     |
    | ---------- | ---------------------------------------------------------------------- |
    | API编号    | UR-AUTH-03                                                             |
    | 接口路径   | POST /api/v1/ur/auth/login/password-sms                                |
    | 功能简述   | 租户用户群用户名+密码+短信验证码双因素登录，用于高安全场景             |
    | 所需权限   | 无（公开接口）                                                         |
    | 关联功能   | F-AUTH-03 租户用户群双因素登录                                         |
    | 关联用例   | UC-AUTH-03 租户用户双因素登录                                          |
    | 关联领域   | Credential.verifyPassword(), Credential.verifySms(), Token.issue()     |
    | 关联规则   | CR-R-01（密码验证）, SMS-R-01（短信验证码）, TN-R-06（强制双因素配置） |
    | 幂等性     | 否（每次登录创建新会话）                                               |
    | 关联错误码 | E-400001, E-400007, E-401003, E-401018, E-404002                       |

    表 5.4.4.2.3-1 UR-AUTH-03契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束               | 示例值          | 业务含义     |
    | ----------- | ---- | ------ | ---- | ------------------ | --------------- | ------------ |
    | tenantCode  | body | String | 是   | 3-32字符           | "acme"          | 租户编码     |
    | username    | body | String | 是   | 用户名/邮箱/手机号 | "zhangsan"      | 用户名       |
    | password    | body | String | 是   | 非空               | "P@ssw0rd123"   | 密码         |
    | smsCode     | body | String | 是   | 6位数字            | "123456"        | 短信验证码   |
    | captchaId   | body | String | 否   | 图形验证码ID       | "cap_xxx"       | 图形验证码ID |
    | captchaCode | body | String | 否   | 4-6位字符          | "ab3d"          | 图形验证码   |
    | deviceId    | body | String | 否   | 长度≤128           | "device_abc123" | 设备指纹     |

    表 5.4.4.2.3-2 UR-AUTH-03请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义     |
    | ----------------- | ------ | ---- | --------------------------- | ------------ |
    | code              | Number | 是   | 0                           | 响应码       |
    | message           | String | 是   | "登录成功"                  | 响应消息     |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌     |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌     |
    | data.expiresIn    | Number | 是   | 7200                        | 有效期秒数   |
    | data.user         | Object | 是   | {...}                       | 用户基本信息 |
    | data.tenant       | Object | 是   | {...}                       | 租户基本信息 |

    表 5.4.4.2.3-3 UR-AUTH-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "acme",
          "username": "zhangsan",
          "password": "P@ssw0rd123",
          "smsCode": "123456",
          "deviceId": "device_abc123"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 101,
              "username": "zhangsan",
              "realName": "张三"
            },
            "tenant": {
              "id": 102,
              "name": "示例企业",
              "code": "example"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（密码错误）

        ```json
        {
          "code": 401003,
          "message": "用户名或密码错误",
          "data": {
            "remainingAttempts": 4
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同时验证密码和短信验证码，任一失败则登录失败
    -   用于租户配置强制双因素的场景（tenant.mfaRequired=true）

##### 5.4.4.2.4 UR-AUTH-04 租户用户群SSO登录

+   **契约概述表**

    | 属性       | 值                                                                   |
    | ---------- | -------------------------------------------------------------------- |
    | API编号    | UR-AUTH-04                                                           |
    | 接口路径   | POST /api/v1/ur/auth/login/sso                                       |
    | 功能简述   | 租户用户群SSO单点登录回调，支持OIDC/SAML/CAS协议                     |
    | 所需权限   | 无（公开接口）                                                       |
    | 关联功能   | F-AUTH-04 SSO单点登录                                                |
    | 关联用例   | UC-AUTH-04 租户用户通过SSO登录系统                                   |
    | 关联领域   | SsoService.validateToken(), TenantUser.findOrCreate(), Token.issue() |
    | 关联规则   | SSO-R-01（协议验证）, SSO-R-02（用户匹配）, SSO-R-03（自动创建）     |
    | 幂等性     | 否（每次登录创建会话）                                               |
    | 关联错误码 | E-400001, E-400015, E-401008, E-401009, E-404002                     |

    表 5.4.4.2.4-1 UR-AUTH-04契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束                   | 示例值             | 业务含义       |
    | ------------ | ---- | ------ | ---- | ---------------------- | ------------------ | -------------- |
    | tenantCode   | body | String | 是   | 3-32字符               | "acme"             | 租户编码       |
    | protocol     | body | String | 是   | 枚举：OIDC/SAML/CAS    | "OIDC"             | SSO协议        |
    | code         | body | String | 否   | OIDC时必填             | "auth_code_abc123" | 授权码（OIDC） |
    | samlResponse | body | String | 否   | SAML时必填，Base64编码 | "PHNhbWw..."       | SAML响应       |
    | ticket       | body | String | 否   | CAS时必填              | "ST-12345-..."     | 票据（CAS）    |
    | state        | body | String | 否   | 防CSRF                 | "state_xyz789"     | 状态参数       |

    表 5.4.4.2.4-2 UR-AUTH-04请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                      | 业务含义           |
    | ----------------- | ------- | ---- | --------------------------- | ------------------ |
    | code              | Number  | 是   | 0                           | 响应码             |
    | message           | String  | 是   | "SSO登录成功"               | 响应消息           |
    | data.isNewUser    | Boolean | 是   | false                       | 是否为新创建的用户 |
    | data.accessToken  | String  | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌           |
    | data.refreshToken | String  | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌           |
    | data.expiresIn    | Number  | 是   | 7200                        | 令牌有效期秒数     |
    | data.user         | Object  | 是   | {...}                       | 用户基本信息       |
    | data.tenant       | Object  | 是   | {...}                       | 租户基本信息       |

    表 5.4.4.2.4-3 UR-AUTH-04响应契约表

+   **Mock示例**

    +   请求Mock（OIDC协议）

        ```json
        {
          "tenantCode": "acme",
          "protocol": "OIDC",
          "code": "auth_code_abc123def456",
          "state": "state_xyz789"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "SSO登录成功",
          "data": {
            "isNewUser": false,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 101,
              "username": "sso_user",
              "realName": "SSO用户",
              "sourceType": "SSO"
            },
            "tenant": {
              "id": 102,
              "name": "示例企业",
              "code": "example"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（SSO验证失败）

        ```json
        {
          "code": 401008,
          "message": "SSO令牌验证失败",
          "data": {
            "protocol": "OIDC",
            "errorDetail": "Token expired"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.2.5 UR-AUTH-05 企业身份源登录

+   **契约概述表**

    | 属性       | 值                                                                 |
    | ---------- | ------------------------------------------------------------------ |
    | API编号    | UR-AUTH-05                                                         |
    | 接口路径   | POST /api/v1/ur/auth/login/enterprise                              |
    | 功能简述   | 通过企业身份源（企业微信/钉钉/飞书）登录，支持自动同步创建用户     |
    | 所需权限   | 无（公开接口）                                                     |
    | 关联功能   | F-AUTH-05 企业身份源登录                                           |
    | 关联用例   | UC-AUTH-05 租户用户通过企业身份源登录                              |
    | 关联领域   | EnterpriseIdpService.authenticate(), TenantUser.findOrCreate()     |
    | 关联规则   | EIP-R-01（身份源配置）, EIP-R-02（员工匹配）, EIP-R-03（自动同步） |
    | 幂等性     | 否（每次登录创建新会话）                                           |
    | 关联错误码 | E-400001, E-400032, E-401013, E-401014, E-404002                   |

    表 5.4.4.2.5-1 UR-AUTH-05契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                              | 示例值          | 业务含义   |
    | ---------- | ---- | ------ | ---- | --------------------------------- | --------------- | ---------- |
    | tenantCode | body | String | 是   | 3-32字符                          | "acme"          | 租户编码   |
    | provider   | body | String | 是   | 枚举：WECHAT_WORK/DINGTALK/FEISHU | "DINGTALK"      | 企业身份源 |
    | code       | body | String | 是   | 授权码                            | "auth_code_xxx" | 授权码     |
    | state      | body | String | 否   | 防CSRF                            | "state_xyz789"  | 状态参数   |

    表 5.4.4.2.5-2 UR-AUTH-05请求契约表

+   **响应契约表**

    | 参数名            | 类型    | 必有 | 示例值                      | 业务含义         |
    | ----------------- | ------- | ---- | --------------------------- | ---------------- |
    | code              | Number  | 是   | 0                           | 响应码           |
    | message           | String  | 是   | "登录成功"                  | 响应消息         |
    | data.isNewUser    | Boolean | 是   | false                       | 是否新创建的用户 |
    | data.accessToken  | String  | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌         |
    | data.refreshToken | String  | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌         |
    | data.expiresIn    | Number  | 是   | 7200                        | 有效期秒数       |
    | data.user         | Object  | 是   | {...}                       | 用户基本信息     |
    | data.tenant       | Object  | 是   | {...}                       | 租户基本信息     |

    表 5.4.4.2.5-3 UR-AUTH-05响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "acme",
          "provider": "DINGTALK",
          "code": "auth_code_from_dingtalk",
          "state": "state_xyz789"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "isNewUser": false,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 101,
              "username": "zhangsan",
              "realName": "张三",
              "sourceType": "SYNCED"
            },
            "tenant": {
              "id": 102,
              "name": "示例企业",
              "code": "example"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（身份源未配置）

        ```json
        {
          "code": 401013,
          "message": "该租户未配置钉钉身份源",
          "data": {
            "provider": "DINGTALK",
            "suggestion": "请联系管理员配置企业身份源"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   需租户配置对应的企业身份源
    -   根据员工标识（如钉钉userId）匹配租户用户
    -   若开启自动同步（autoSync=true）则自动创建用户

##### 5.4.4.2.6 UR-AUTH-06 企业内免密登录

+   **契约概述表**

    | 属性       | 值                                                |
    | ---------- | ------------------------------------------------- |
    | API编号    | UR-AUTH-06                                        |
    | 接口路径   | POST /api/v1/ur/auth/login/passwordless           |
    | 功能简述   | 企业内网免密登录，支持IP白名单和AD域认证两种方式  |
    | 所需权限   | 无（公开接口）                                    |
    | 关联功能   | F-AUTH-06 企业内免密登录                          |
    | 关联用例   | UC-AUTH-06 企业内网用户免密登录                   |
    | 关联领域   | PasswordlessService.authenticate(), Token.issue() |
    | 关联规则   | PWL-R-01（IP白名单校验）, PWL-R-02（AD域认证）    |
    | 幂等性     | 否（每次登录创建新会话）                          |
    | 关联错误码 | E-400001, E-401015, E-401016, E-404002            |

    表 5.4.4.2.6-1 UR-AUTH-06契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                         | 示例值         | 业务含义 |
    | ---------- | ---- | ------ | ---- | ---------------------------- | -------------- | -------- |
    | tenantCode | body | String | 是   | 3-32字符，用户输入           | "acme"         | 租户编码 |
    | username   | body | String | 是   | 用户名                       | "zhangsan"     | 用户名   |
    | method     | body | String | 是   | 枚举：IP_WHITELIST/AD_DOMAIN | "IP_WHITELIST" | 免密方式 |

    表 5.4.4.2.6-2 UR-AUTH-06请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义     |
    | ----------------- | ------ | ---- | --------------------------- | ------------ |
    | code              | Number | 是   | 0                           | 响应码       |
    | message           | String | 是   | "登录成功"                  | 响应消息     |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌     |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌     |
    | data.expiresIn    | Number | 是   | 7200                        | 有效期秒数   |
    | data.user         | Object | 是   | {...}                       | 用户基本信息 |
    | data.tenant       | Object | 是   | {...}                       | 租户基本信息 |
    | data.loginMethod  | String | 是   | "IP_WHITELIST"              | 实际登录方式 |

    表 5.4.4.2.6-3 UR-AUTH-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "tenantCode": "acme",
          "username": "zhangsan",
          "method": "IP_WHITELIST"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 101,
              "username": "zhangsan",
              "realName": "张三"
            },
            "tenant": {
              "id": 102,
              "name": "示例企业",
              "code": "example"
            },
            "loginMethod": "IP_WHITELIST"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（IP不在白名单）

        ```json
        {
          "code": 401015,
          "message": "当前IP不在免密登录白名单内",
          "data": {
            "clientIp": "203.0.113.45",
            "suggestion": "请使用密码登录或在企业内网访问"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   IP_WHITELIST：检查请求IP是否在租户配置的白名单内
    -   AD_DOMAIN：从请求头（如X-Remote-User）获取域账号信息
    -   仅在满足条件时允许免密登录

##### 5.4.4.2.7 UR-AUTH-07 扫码登录确认

+   **契约概述表**

    | 属性       | 值                                                  |
    | ---------- | --------------------------------------------------- |
    | API编号    | UR-AUTH-07                                          |
    | 接口路径   | POST /api/v1/ur/auth/login/scan                     |
    | 功能简述   | 移动端扫码确认登录，确认后PC端可获取令牌            |
    | 所需权限   | 需要Access Token                                    |
    | 关联功能   | F-AUTH-07 扫码登录                                  |
    | 关联用例   | UC-AUTH-07 用户通过移动端确认PC登录                 |
    | 关联领域   | ScanLoginService.confirm()                          |
    | 关联规则   | SCN-R-01（票据有效期2分钟）, SCN-R-02（同租户校验） |
    | 幂等性     | 是                                                  |
    | 关联错误码 | E-400001, E-401001, E-401011, E-403007              |

    表 5.4.4.2.7-1 UR-AUTH-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束                 | 示例值          | 业务含义 |
    | ------ | ---- | ------ | ---- | -------------------- | --------------- | -------- |
    | ticket | body | String | 是   | 64位URL安全字符      | "scn_abc123..." | 扫码票据 |
    | action | body | String | 是   | 枚举：CONFIRM/CANCEL | "CONFIRM"       | 操作类型 |

    表 5.4.4.2.7-2 UR-AUTH-07请求契约表

+   **响应契约表**

    | 参数名         | 类型    | 必有 | 示例值     | 业务含义   |
    | -------------- | ------- | ---- | ---------- | ---------- |
    | code           | Number  | 是   | 0          | 响应码     |
    | message        | String  | 是   | "确认成功" | 响应消息   |
    | data.confirmed | Boolean | 是   | true       | 是否已确认 |
    | data.action    | String  | 是   | "CONFIRM"  | 执行的操作 |

    表 5.4.4.2.7-3 UR-AUTH-07响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "ticket": "scn_abc123def456ghi789jkl012mno345pqr678stu901vwx234",
          "action": "CONFIRM"
        }
        ```

    +   成功响应Mock（确认）

        ```json
        {
          "code": 200,
          "message": "确认成功，PC端即将登录",
          "data": {
            "confirmed": true,
            "action": "CONFIRM"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（取消）

        ```json
        {
          "code": 200,
          "message": "已取消登录",
          "data": {
            "confirmed": false,
            "action": "CANCEL"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（票据已过期）

        ```json
        {
          "code": 401011,
          "message": "扫码票据已过期",
          "data": {
            "expiredAt": "2026-01-26T09:58:00",
            "suggestion": "请在PC端重新获取二维码"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   需移动端已登录状态
    -   CONFIRM：确认后PC端轮询可获取令牌
    -   CANCEL：取消登录，PC端轮询返回CANCELLED状态
    -   票据有效期2分钟

##### 5.4.4.2.8 UR-AUTH-08 租户用户群登出

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | UR-AUTH-08                           |
    | 接口路径   | POST /api/v1/ur/auth/logout          |
    | 功能简述   | 租户用户群用户登出，可选登出全部设备 |
    | 所需权限   | 登录即可                             |
    | 关联功能   | F-AUTH-08 租户用户群登出             |
    | 关联用例   | UC-AUTH-08 租户用户群用户登出        |
    | 关联领域   | Token.revoke() + Session.destroy()   |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-401001, E-401002                   |

    表 5.4.4.2.8-1 UR-AUTH-08契约概述表

+   **请求契约表**

    | 参数名    | 位置 | 类型    | 必填 | 约束      | 示例值 | 业务含义         |
    | --------- | ---- | ------- | ---- | --------- | ------ | ---------------- |
    | logoutAll | body | Boolean | 否   | 默认false | false  | 是否登出全部设备 |

    表 5.4.4.2.8-2 UR-AUTH-08请求契约表

+   **响应契约表**

    | 参数名               | 类型   | 必有 | 示例值                | 业务含义     |
    | -------------------- | ------ | ---- | --------------------- | ------------ |
    | code                 | Number | 是   | 0                     | 响应码       |
    | message              | String | 是   | "登出成功"            | 响应消息     |
    | data.logoutAt        | String | 是   | "2026-01-26T10:00:00" | 登出时间     |
    | data.terminatedCount | Number | 否   | 3                     | 终止的会话数 |

    表 5.4.4.2.8-3 UR-AUTH-08响应契约表

+   **Mock示例**

    +   请求Mock（仅当前设备）

        ```json
        {
          "logoutAll": false
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登出成功",
          "data": {
            "logoutAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   请求Mock（全部设备）

        ```json
        {
          "logoutAll": true
        }
        ```

    +   成功响应Mock（全部设备）

        ```json
        {
          "code": 200,
          "message": "已登出全部设备",
          "data": {
            "logoutAt": "2026-01-26T10:00:00",
            "terminatedCount": 3
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.2.9 UR-AUTH-09 租户用户群刷新令牌

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-AUTH-09                             |
    | 接口路径   | POST /api/v1/ur/auth/token/refresh     |
    | 功能简述   | 使用Refresh Token获取新的Access Token  |
    | 所需权限   | 无（需要有效的Refresh Token）          |
    | 关联功能   | F-AUTH-09 租户用户群令牌刷新           |
    | 关联用例   | UC-AUTH-09 租户用户群用户刷新访问令牌  |
    | 关联领域   | Token.refresh()                        |
    | 关联规则   | TK-R-01（Refresh Token有效性）         |
    | 幂等性     | 否（每次生成新令牌）                   |
    | 关联错误码 | E-400001, E-401005, E-401006, E-401007 |

    表 5.4.4.2.9-1 UR-AUTH-09契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束    | 示例值                    | 业务含义 |
    | ------------ | ---- | ------ | ---- | ------- | ------------------------- | -------- |
    | refreshToken | body | String | 是   | JWT格式 | "eyJhbGciOiJSUzI1NiIs..." | 刷新令牌 |

    表 5.4.4.2.9-2 UR-AUTH-09请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                    | 业务含义               |
    | ----------------- | ------ | ---- | ------------------------- | ---------------------- |
    | code              | Number | 是   | 0                         | 响应码                 |
    | message           | String | 是   | "刷新成功"                | 响应消息               |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..." | 新的访问令牌           |
    | data.refreshToken | String | 否   | "eyJhbGciOiJSUzI1NiIs..." | 新的刷新令牌（轮换时） |
    | data.expiresIn    | Number | 是   | 7200                      | 访问令牌有效期秒数     |
    | data.tokenType    | String | 是   | "Bearer"                  | 令牌类型               |

    表 5.4.4.2.9-3 UR-AUTH-09响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "refreshToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "刷新成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.newtoken...",
            "expiresIn": 7200,
            "tokenType": "Bearer"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.2.10 UR-AUTH-10 查询用户会话列表

+   **契约概述表**

    | 属性       | 值                                    |
    | ---------- | ------------------------------------- |
    | API编号    | UR-AUTH-10                            |
    | 接口路径   | GET /api/v1/ur/auth/sessions          |
    | 功能简述   | 查询当前用户的所有活跃会话列表        |
    | 所需权限   | 登录即可                              |
    | 关联功能   | F-AUTH-10 租户用户群会话查询          |
    | 关联用例   | UC-AUTH-10 租户用户群用户查看活跃会话 |
    | 关联领域   | SessionQueryService.list()            |
    | 关联规则   | 无                                    |
    | 幂等性     | 是                                    |
    | 关联错误码 | E-401001, E-401002                    |

    表 5.4.4.2.10-1 UR-AUTH-10契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 5.4.4.2.10-2 UR-AUTH-10请求契约表

+   **响应契约表**

    | 参数名              | 类型    | 必有 | 示例值                | 业务含义     |
    | ------------------- | ------- | ---- | --------------------- | ------------ |
    | code                | Number  | 是   | 0                     | 响应码       |
    | message             | String  | 是   | "success"             | 响应消息     |
    | data[]              | Array   | 是   | [...]                 | 会话列表     |
    | data[].sessionId    | String  | 是   | "sess-aa0e8400-..."   | 会话ID       |
    | data[].deviceType   | String  | 是   | "PC"                  | 设备类型     |
    | data[].deviceName   | String  | 否   | "Chrome on Windows"   | 设备名称     |
    | data[].clientIp     | String  | 是   | "192.168.1.100"       | 客户端IP     |
    | data[].location     | String  | 否   | "北京市"              | IP归属地     |
    | data[].loginAt      | String  | 是   | "2026-01-25T10:00:00" | 登录时间     |
    | data[].lastActiveAt | String  | 是   | "2026-01-26T09:00:00" | 最后活跃时间 |
    | data[].isCurrent    | Boolean | 是   | true                  | 是否当前会话 |

    表 5.4.4.2.10-3 UR-AUTH-10响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "sessionId": "sess-aa0e8400-e29b-41d4-a716-446655440001",
              "deviceType": "PC",
              "deviceName": "Chrome on Windows",
              "clientIp": "192.168.1.100",
              "location": "北京市",
              "loginAt": "2026-01-25T10:00:00",
              "lastActiveAt": "2026-01-26T09:00:00",
              "isCurrent": true
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.2.11 UR-AUTH-11 终止指定会话

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UR-AUTH-11                             |
    | 接口路径   | DELETE /api/v1/ur/auth/sessions/{id}   |
    | 功能简述   | 终止指定会话，用于踢出其他设备         |
    | 所需权限   | 登录即可                               |
    | 关联功能   | F-AUTH-11 会话终止                     |
    | 关联用例   | UC-AUTH-11 用户终止其他设备会话        |
    | 关联领域   | Session.terminate()                    |
    | 关联规则   | SESS-R-01（不能终止当前会话）          |
    | 幂等性     | 是（已终止返回成功）                   |
    | 关联错误码 | E-401001, E-401002, E-404010, E-422030 |

    表 5.4.4.2.11-1 UR-AUTH-11契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束     | 示例值              | 业务含义 |
    | ------ | ---- | ------ | ---- | -------- | ------------------- | -------- |
    | id     | path | String | 是   | UUID格式 | "sess-aa0e8400-..." | 会话ID   |

    表 5.4.4.2.11-2 UR-AUTH-11请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义 |
    | ----------------- | ------ | ---- | --------------------- | -------- |
    | code              | Number | 是   | 0                     | 响应码   |
    | message           | String | 是   | "会话已终止"          | 响应消息 |
    | data.sessionId    | String | 是   | "sess-aa0e8400-..."   | 会话ID   |
    | data.terminatedAt | String | 是   | "2026-01-26T10:00:00" | 终止时间 |

    表 5.4.4.2.11-3 UR-AUTH-11响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "会话已终止",
          "data": {
            "sessionId": "sess-bb0e8400-e29b-41d4-a716-446655440002",
            "terminatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（不能终止当前会话）

        ```json
        {
          "code": 422030,
          "message": "不能终止当前会话，请使用登出接口",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   不能终止当前会话，如需登出当前设备请使用登出接口
    -   会话终止后，对应设备的令牌立即失效

##### 5.4.4.2.12 UR-AUTH-12 修改密码

+   **契约概述表**

    | 属性       | 值                                                                       |
    | ---------- | ------------------------------------------------------------------------ |
    | API编号    | UR-AUTH-12                                                               |
    | 接口路径   | POST /api/v1/ur/auth/password/change                                     |
    | 功能简述   | 修改当前用户密码，同步用户受限                                           |
    | 所需权限   | 登录即可                                                                 |
    | 关联功能   | F-AUTH-12 租户用户群密码修改                                             |
    | 关联用例   | UC-AUTH-12 租户用户修改密码                                              |
    | 关联领域   | Credential.changePassword()                                              |
    | 关联规则   | PWD-R-01（旧密码验证）, PWD-R-02（密码复杂度）, PWD-R-03（同步用户受限） |
    | 幂等性     | 否                                                                       |
    | 关联错误码 | E-400001, E-401001, E-401008, E-422010, E-422020                         |

    表 5.4.4.2.12-1 UR-AUTH-12契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                 | 示例值        | 业务含义 |
    | ----------- | ---- | ------ | ---- | -------------------- | ------------- | -------- |
    | oldPassword | body | String | 是   | -                    | "OldPass123!" | 旧密码   |
    | newPassword | body | String | 是   | 8-32位，含大小写数字 | "NewPass456@" | 新密码   |

    表 5.4.4.2.12-2 UR-AUTH-12请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "密码修改成功"        | 响应消息 |
    | data.changedAt | String | 是   | "2026-01-26T10:00:00" | 修改时间 |

    表 5.4.4.2.12-3 UR-AUTH-12响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "oldPassword": "OldPass123!",
          "newPassword": "NewPass456@"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "密码修改成功",
          "data": {
            "changedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（旧密码错误）

        ```json
        {
          "code": 401008,
          "message": "旧密码错误",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（同步用户受限）

        ```json
        {
          "code": 422010,
          "message": "同步用户不支持在本系统修改密码，请在源系统中修改",
          "data": {
            "source": "FEISHU"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同步用户（source=SYNC）不支持修改密码
    -   修改成功后，其他设备的会话不会被强制登出

#### 5.4.4.3 C端用户群认证接口（UC-AUTH）

##### 5.4.4.3.1 UC-AUTH-01 C端用户群短信登录

+   **契约概述表**

    | 属性       | 值                                                                 |
    | ---------- | ------------------------------------------------------------------ |
    | API编号    | UC-AUTH-01                                                         |
    | 接口路径   | POST /api/v1/uc/auth/login/sms                                     |
    | 功能简述   | C端用户群短信验证码登录，未注册用户自动完成注册                    |
    | 所需权限   | 无（公开接口）                                                     |
    | 关联功能   | F-AUTH-08 C端用户群短信登录                                        |
    | 关联用例   | UC-AUTH-08 个人用户短信登录/注册                                   |
    | 关联领域   | Credential.verifySms(), ConsumerUser.findOrCreate(), Token.issue() |
    | 关联规则   | CU-R-01（手机号唯一）, SMS-R-01（验证码有效期）                    |
    | 幂等性     | 否（可能创建新用户，每次创建新会话）                               |
    | 关联错误码 | E-400001, E-400022, E-401018                                       |

    表 5.4.4.3.1-1 UC-AUTH-01契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束       | 示例值          | 业务含义   |
    | ---------- | ---- | ------ | ---- | ---------- | --------------- | ---------- |
    | mobile     | body | String | 是   | 11位手机号 | "13800138000"   | 手机号     |
    | smsCode    | body | String | 是   | 6位数字    | "123456"        | 短信验证码 |
    | deviceId   | body | String | 否   | 长度≤128   | "device_abc123" | 设备指纹   |
    | inviteCode | body | String | 否   | 长度≤32    | "INV2026ABC"    | 邀请码     |

    表 5.4.4.3.1-2 UC-AUTH-01请求契约表

+   **响应契约表**

    | 参数名             | 类型    | 必有 | 示例值                      | 业务含义       |
    | ------------------ | ------- | ---- | --------------------------- | -------------- |
    | code               | Number  | 是   | 0                           | 响应码         |
    | message            | String  | 是   | "登录成功"                  | 响应消息       |
    | data.isNewUser     | Boolean | 是   | true                        | 是否新注册用户 |
    | data.accessToken   | String  | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌       |
    | data.refreshToken  | String  | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌       |
    | data.expiresIn     | Number  | 是   | 7200                        | 有效期秒数     |
    | data.user          | Object  | 是   | {...}                       | 用户基本信息   |
    | data.user.id       | Number  | 是   | 200001                      | 用户ID         |
    | data.user.mobile   | String  | 是   | "138****8000"               | 手机号（脱敏） |
    | data.user.nickname | String  | 否   | "用户138****8000"           | 昵称           |

    表 5.4.4.3.1-3 UC-AUTH-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "mobile": "13800138000",
          "smsCode": "123456",
          "deviceId": "device_abc123",
          "inviteCode": "INV2026ABC"
        }
        ```

    +   成功响应Mock（新用户）

        ```json
        {
          "code": 200,
          "message": "注册并登录成功",
          "data": {
            "isNewUser": true,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 200001,
              "mobile": "138****8000",
              "nickname": "用户138****8000"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（老用户）

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "isNewUser": false,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 200002,
              "mobile": "138****8000",
              "nickname": "小明"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（验证码错误）

        ```json
        {
          "code": 401018,
          "message": "短信验证码错误",
          "data": {
            "remainingAttempts": 2
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   手机号未注册时自动创建账号，sourceType=SELF_REGISTERED
    -   isNewUser=true表示本次登录完成了注册
    -   inviteCode有效时记录邀请关系

##### 5.4.4.3.2 UC-AUTH-02 C端用户群密码登录

+   **契约概述表**

    | 属性       | 值                                                 |
    | ---------- | -------------------------------------------------- |
    | API编号    | UC-AUTH-02                                         |
    | 接口路径   | POST /api/v1/uc/auth/login/password                |
    | 功能简述   | 个人用户使用手机号+密码登录                        |
    | 所需权限   | 无                                                 |
    | 关联功能   | F-AUTH-12 C端用户群密码登录                        |
    | 关联用例   | UC-AUTH-12 个人用户密码登录                        |
    | 关联领域   | Credential.verifyPassword() + Token.issue()        |
    | 关联规则   | AUTH-R-01（登录失败锁定）, AUTH-R-02（图形验证码） |
    | 幂等性     | 否                                                 |
    | 关联错误码 | E-400001, E-401001, E-401003, E-401004, E-423001   |

    表 5.4.4.3.2-1 UC-AUTH-02契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束       | 示例值         | 业务含义     |
    | ----------- | ---- | ------ | ---- | ---------- | -------------- | ------------ |
    | mobile      | body | String | 是   | 11位手机号 | "13800138000"  | 手机号       |
    | password    | body | String | 是   | -          | "Password123!" | 密码         |
    | captchaId   | body | String | 条件 | 失败后必填 | "cap-aa0e..."  | 图形验证码ID |
    | captchaCode | body | String | 条件 | 失败后必填 | "a3b5"         | 图形验证码   |

    表 5.4.4.3.2-2 UC-AUTH-02请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                    | 业务含义           |
    | ----------------- | ------ | ---- | ------------------------- | ------------------ |
    | code              | Number | 是   | 0                         | 响应码             |
    | message           | String | 是   | "登录成功"                | 响应消息           |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..." | 访问令牌           |
    | data.refreshToken | String | 是   | "eyJhbGciOiJSUzI1NiIs..." | 刷新令牌           |
    | data.expiresIn    | Number | 是   | 7200                      | 访问令牌有效期秒数 |
    | data.tokenType    | String | 是   | "Bearer"                  | 令牌类型           |
    | data.userId       | Number | 是   | 200001                    | 用户ID             |
    | data.nickname     | String | 是   | "用户昵称"                | 用户昵称           |

    表 5.4.4.3.2-3 UC-AUTH-02响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "mobile": "13800138000",
          "password": "Password123!"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "expiresIn": 7200,
            "tokenType": "Bearer",
            "userId": 200001,
            "nickname": "小明"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（密码错误）

        ```json
        {
          "code": 401003,
          "message": "密码错误，还剩4次机会",
          "data": {
            "remainingAttempts": 4,
            "requireCaptcha": true
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（账号锁定）

        ```json
        {
          "code": 423001,
          "message": "账号已锁定，请30分钟后重试",
          "data": {
            "unlockAt": "2026-01-26T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.3.3 UC-AUTH-03 社交账号登录

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | UC-AUTH-03                                               |
    | 接口路径   | POST /api/v1/uc/auth/login/social                        |
    | 功能简述   | 使用微信/钉钉/QQ等社交账号登录，未绑定时自动创建账号     |
    | 所需权限   | 无（公开接口）                                           |
    | 关联功能   | F-AUTH-09 社交账号登录                                   |
    | 关联用例   | UC-AUTH-09 个人用户社交账号登录                          |
    | 关联领域   | OAuthService.authenticate(), ConsumerUser.findOrCreate() |
    | 关联规则   | CU-R-05（三方账号唯一绑定）, OB-R-01（平台+openId唯一）  |
    | 幂等性     | 否（可能创建新用户，每次创建新会话）                     |
    | 关联错误码 | E-400001, E-400032, E-401010, E-401014                   |

    表 5.4.4.3.3-1 UC-AUTH-03契约概述表

+   **请求契约表**

    | 参数名     | 位置 | 类型   | 必填 | 约束                     | 示例值           | 业务含义 |
    | ---------- | ---- | ------ | ---- | ------------------------ | ---------------- | -------- |
    | provider   | body | String | 是   | 枚举：WECHAT/DINGTALK/QQ | "WECHAT"         | 社交渠道 |
    | code       | body | String | 是   | 授权码                   | "oauth_code_xxx" | 授权码   |
    | state      | body | String | 否   | 防CSRF                   | "state_xyz789"   | 状态参数 |
    | deviceId   | body | String | 否   | 长度≤128                 | "device_abc123"  | 设备指纹 |
    | inviteCode | body | String | 否   | 长度≤32                  | "INV2026ABC"     | 邀请码   |

    表 5.4.4.3.3-2 UC-AUTH-03请求契约表

+   **响应契约表**

    | 参数名             | 类型    | 必有 | 示例值                      | 业务含义       |
    | ------------------ | ------- | ---- | --------------------------- | -------------- |
    | code               | Number  | 是   | 0                           | 响应码         |
    | message            | String  | 是   | "登录成功"                  | 响应消息       |
    | data.isNewUser     | Boolean | 是   | false                       | 是否新注册用户 |
    | data.accessToken   | String  | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌       |
    | data.refreshToken  | String  | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌       |
    | data.expiresIn     | Number  | 是   | 7200                        | 有效期秒数     |
    | data.user          | Object  | 是   | {...}                       | 用户基本信息   |
    | data.user.id       | Number  | 是   | 200001                      | 用户ID         |
    | data.user.nickname | String  | 否   | "微信昵称"                  | 昵称           |
    | data.user.avatar   | String  | 否   | "https://..."               | 头像URL        |

    表 5.4.4.3.3-3 UC-AUTH-03响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "provider": "WECHAT",
          "code": "oauth_code_from_wechat",
          "state": "state_xyz789",
          "deviceId": "device_abc123"
        }
        ```

    +   成功响应Mock（已绑定用户）

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "isNewUser": false,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 200001,
              "nickname": "小明",
              "avatar": "https://cdn.example.com/avatar.jpg"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（新用户自动创建）

        ```json
        {
          "code": 200,
          "message": "注册并登录成功",
          "data": {
            "isNewUser": true,
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 200002,
              "nickname": "微信昵称",
              "avatar": "https://thirdwx.qlogo.cn/xxx"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（state验证失败）

        ```json
        {
          "code": 401014,
          "message": "授权状态验证失败",
          "data": {
            "reason": "STATE_MISMATCH",
            "suggestion": "请返回登录页重新点击社交登录"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   已绑定用户直接登录
    -   未绑定时自动创建账号并绑定
    -   新用户昵称和头像从社交平台获取

##### 5.4.4.3.4 UC-AUTH-04 生物识别登录

+   **契约概述表**

    | 属性       | 值                                                                          |
    | ---------- | --------------------------------------------------------------------------- |
    | API编号    | UC-AUTH-04                                                                  |
    | 接口路径   | POST /api/v1/uc/auth/login/biometric                                        |
    | 功能简述   | 使用生物识别快捷登录（指纹/面容），仅移动端支持                             |
    | 所需权限   | 无（公开接口）                                                              |
    | 关联功能   | F-AUTH-10 生物识别登录                                                      |
    | 关联用例   | UC-AUTH-10 个人用户生物识别快捷登录                                         |
    | 关联领域   | BiometricService.verify(), Token.issue()                                    |
    | 关联规则   | BIO-R-01（设备绑定校验）, BIO-R-02（token有效期30天）, BIO-R-03（失败锁定） |
    | 幂等性     | 否（每次创建新会话）                                                        |
    | 关联错误码 | E-400001, E-401019, E-401020, E-404002                                      |

    表 5.4.4.3.4-1 UC-AUTH-04契约概述表

+   **请求契约表**

    | 参数名         | 位置 | 类型   | 必填 | 约束     | 示例值          | 业务含义             |
    | -------------- | ---- | ------ | ---- | -------- | --------------- | -------------------- |
    | userId         | body | Number | 是   | BIGINT   | 200001          | 用户ID               |
    | biometricToken | body | String | 是   | 长度≤256 | "bio_token_xxx" | 生物识别成功后的凭证 |
    | deviceId       | body | String | 是   | 长度≤128 | "device_abc123" | 设备指纹             |

    表 5.4.4.3.4-2 UC-AUTH-04请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义     |
    | ----------------- | ------ | ---- | --------------------------- | ------------ |
    | code              | Number | 是   | 0                           | 响应码       |
    | message           | String | 是   | "登录成功"                  | 响应消息     |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌     |
    | data.refreshToken | String | 是   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌     |
    | data.expiresIn    | Number | 是   | 7200                        | 有效期秒数   |
    | data.user         | Object | 是   | {...}                       | 用户基本信息 |

    表 5.4.4.3.4-3 UC-AUTH-04响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "userId": 200001,
          "biometricToken": "bio_token_abc123def456ghi789",
          "deviceId": "device_abc123"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 200001,
              "nickname": "小明",
              "avatar": "https://cdn.example.com/avatar.jpg"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（生物识别凭证无效）

        ```json
        {
          "code": 401019,
          "message": "生物识别凭证无效或已过期",
          "data": {
            "reason": "TOKEN_EXPIRED",
            "suggestion": "请使用密码或验证码重新登录并开启生物识别"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（设备不匹配）

        ```json
        {
          "code": 401020,
          "message": "设备不匹配",
          "data": {
            "reason": "DEVICE_MISMATCH",
            "suggestion": "请在绑定生物识别的设备上登录"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   验证biometricToken与设备绑定关系
    -   biometricToken有效期30天
    -   连续失败3次后需完整登录

##### 5.4.4.3.5 UC-AUTH-05 C端用户群登出

+   **契约概述表**

    | 属性       | 值                                 |
    | ---------- | ---------------------------------- |
    | API编号    | UC-AUTH-05                         |
    | 接口路径   | POST /api/v1/uc/auth/logout        |
    | 功能简述   | 个人用户登出                       |
    | 所需权限   | 登录即可                           |
    | 关联功能   | F-AUTH-13 C端用户群登出            |
    | 关联用例   | UC-AUTH-13 个人用户登出            |
    | 关联领域   | Token.revoke() + Session.destroy() |
    | 关联规则   | 无                                 |
    | 幂等性     | 是                                 |
    | 关联错误码 | E-401001, E-401002                 |

    表 5.4.4.3.5-1 UC-AUTH-05契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 5.4.4.3.5-2 UC-AUTH-05请求契约表

+   **响应契约表**

    | 参数名        | 类型   | 必有 | 示例值                | 业务含义 |
    | ------------- | ------ | ---- | --------------------- | -------- |
    | code          | Number | 是   | 0                     | 响应码   |
    | message       | String | 是   | "登出成功"            | 响应消息 |
    | data.logoutAt | String | 是   | "2026-01-26T10:00:00" | 登出时间 |

    表 5.4.4.3.5-3 UC-AUTH-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "登出成功",
          "data": {
            "logoutAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.3.6 UC-AUTH-06 C端用户群刷新令牌

+   **契约概述表**

    | 属性       | 值                                    |
    | ---------- | ------------------------------------- |
    | API编号    | UC-AUTH-06                            |
    | 接口路径   | POST /api/v1/uc/auth/token/refresh    |
    | 功能简述   | 使用Refresh Token获取新的Access Token |
    | 所需权限   | 无（需要有效的Refresh Token）         |
    | 关联功能   | F-AUTH-14 C端用户群令牌刷新           |
    | 关联用例   | UC-AUTH-14 个人用户刷新访问令牌       |
    | 关联领域   | Token.refresh()                       |
    | 关联规则   | TK-R-01（Refresh Token有效性）        |
    | 幂等性     | 否（每次生成新令牌）                  |
    | 关联错误码 | E-400001, E-401005, E-401006          |

    表 5.4.4.3.6-1 UC-AUTH-06契约概述表

+   **请求契约表**

    | 参数名       | 位置 | 类型   | 必填 | 约束    | 示例值                    | 业务含义 |
    | ------------ | ---- | ------ | ---- | ------- | ------------------------- | -------- |
    | refreshToken | body | String | 是   | JWT格式 | "eyJhbGciOiJSUzI1NiIs..." | 刷新令牌 |

    表 5.4.4.3.6-2 UC-AUTH-06请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                    | 业务含义               |
    | ----------------- | ------ | ---- | ------------------------- | ---------------------- |
    | code              | Number | 是   | 0                         | 响应码                 |
    | message           | String | 是   | "刷新成功"                | 响应消息               |
    | data.accessToken  | String | 是   | "eyJhbGciOiJSUzI1NiIs..." | 新的访问令牌           |
    | data.refreshToken | String | 否   | "eyJhbGciOiJSUzI1NiIs..." | 新的刷新令牌（轮换时） |
    | data.expiresIn    | Number | 是   | 7200                      | 访问令牌有效期秒数     |
    | data.tokenType    | String | 是   | "Bearer"                  | 令牌类型               |

    表 5.4.4.3.6-3 UC-AUTH-06响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "refreshToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "刷新成功",
          "data": {
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.newtoken...",
            "expiresIn": 7200,
            "tokenType": "Bearer"
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.3.7 UC-AUTH-07 查询社交绑定列表

+   **契约概述表**

    | 属性       | 值                                  |
    | ---------- | ----------------------------------- |
    | API编号    | UC-AUTH-07                          |
    | 接口路径   | GET /api/v1/uc/auth/social/bindings |
    | 功能简述   | 查询当前用户的社交账号绑定列表      |
    | 所需权限   | 需要Access Token                    |
    | 关联功能   | F-AUTH-11 社交账号绑定管理          |
    | 关联用例   | UC-AUTH-11 用户查看社交绑定状态     |
    | 关联领域   | OAuthBindingQueryService.list()     |
    | 关联规则   | 无                                  |
    | 幂等性     | 是                                  |
    | 关联错误码 | E-401001, E-401002                  |

    表 5.4.4.3.7-1 UC-AUTH-07契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束 | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ---- | ------ | -------- |
    | -      | -    | -    | -    | -    | -      | 无参数   |

    表 5.4.4.3.7-2 UC-AUTH-07请求契约表

+   **响应契约表**

    | 参数名                       | 类型    | 必有 | 示例值                | 业务含义   |
    | ---------------------------- | ------- | ---- | --------------------- | ---------- |
    | code                         | Number  | 是   | 0                     | 响应码     |
    | message                      | String  | 是   | "success"             | 响应消息   |
    | data.bindings[]              | Array   | 是   | [...]                 | 绑定列表   |
    | data.bindings[].provider     | String  | 是   | "WECHAT"              | 社交渠道   |
    | data.bindings[].providerName | String  | 是   | "微信"                | 渠道显示名 |
    | data.bindings[].bound        | Boolean | 是   | true                  | 是否已绑定 |
    | data.bindings[].nickname     | String  | 否   | "微信昵称"            | 第三方昵称 |
    | data.bindings[].avatar       | String  | 否   | "https://..."         | 第三方头像 |
    | data.bindings[].boundAt      | String  | 否   | "2026-01-20T10:00:00" | 绑定时间   |

    表 5.4.4.3.7-3 UC-AUTH-07响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "bindings": [
              {
                "provider": "WECHAT",
                "providerName": "微信",
                "bound": true,
                "nickname": "微信昵称",
                "avatar": "https://thirdwx.qlogo.cn/xxx",
                "boundAt": "2026-01-20T10:00:00"
              },
              {
                "provider": "QQ",
                "providerName": "QQ",
                "bound": false,
                "nickname": null,
                "avatar": null,
                "boundAt": null
              },
              {
                "provider": "DINGTALK",
                "providerName": "钉钉",
                "bound": false,
                "nickname": null,
                "avatar": null,
                "boundAt": null
              }
            ]
          },
          "timestamp": 1737885600000
        }
        ```

##### 5.4.4.3.8 UC-AUTH-08 绑定社交账号

+   **契约概述表**

    | 属性       | 值                                                   |
    | ---------- | ---------------------------------------------------- |
    | API编号    | UC-AUTH-08                                           |
    | 接口路径   | POST /api/v1/uc/auth/social/bind                     |
    | 功能简述   | 为当前用户绑定新的社交账号                           |
    | 所需权限   | 需要Access Token                                     |
    | 关联功能   | F-AUTH-11 社交账号绑定管理                           |
    | 关联用例   | UC-AUTH-12 用户绑定社交账号                          |
    | 关联领域   | OAuthBinding.bind()                                  |
    | 关联规则   | CU-R-05（三方账号唯一绑定）, OB-R-05（单平台单用户） |
    | 幂等性     | 否                                                   |
    | 关联错误码 | E-400001, E-400032, E-401001, E-422204               |

    表 5.4.4.3.8-1 UC-AUTH-08契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                     | 示例值           | 业务含义 |
    | -------- | ---- | ------ | ---- | ------------------------ | ---------------- | -------- |
    | provider | body | String | 是   | 枚举：WECHAT/DINGTALK/QQ | "DINGTALK"       | 社交渠道 |
    | code     | body | String | 是   | 授权码                   | "oauth_code_xxx" | 授权码   |
    | state    | body | String | 否   | 防CSRF                   | "state_xyz789"   | 状态参数 |

    表 5.4.4.3.8-2 UC-AUTH-08请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                | 业务含义   |
    | ----------------- | ------ | ---- | --------------------- | ---------- |
    | code              | Number | 是   | 0                     | 响应码     |
    | message           | String | 是   | "绑定成功"            | 响应消息   |
    | data.provider     | String | 是   | "DINGTALK"            | 社交渠道   |
    | data.providerName | String | 是   | "钉钉"                | 渠道显示名 |
    | data.nickname     | String | 否   | "钉钉昵称"            | 第三方昵称 |
    | data.avatar       | String | 否   | "https://..."         | 第三方头像 |
    | data.boundAt      | String | 是   | "2026-01-26T10:00:00" | 绑定时间   |

    表 5.4.4.3.8-3 UC-AUTH-08响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "provider": "DINGTALK",
          "code": "oauth_code_from_dingtalk",
          "state": "state_xyz789"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "绑定成功",
          "data": {
            "provider": "DINGTALK",
            "providerName": "钉钉",
            "nickname": "钉钉昵称",
            "avatar": "https://static.dingtalk.com/xxx",
            "boundAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（该社交账号已被其他用户绑定）

        ```json
        {
          "code": 422204,
          "message": "该社交账号已被其他用户绑定",
          "data": {
            "provider": "DINGTALK",
            "suggestion": "请使用其他社交账号或联系客服"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   同一渠道不可重复绑定
    -   该社交账号未被其他用户绑定

##### 5.4.4.3.9 UC-AUTH-09 解绑社交账号

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UC-AUTH-09                               |
    | 接口路径   | DELETE /api/v1/uc/auth/social/{provider} |
    | 功能简述   | 解绑指定的社交账号                       |
    | 所需权限   | 需要Access Token                         |
    | 关联功能   | F-AUTH-11 社交账号绑定管理               |
    | 关联用例   | UC-AUTH-13 用户解绑社交账号              |
    | 关联领域   | OAuthBinding.unbind()                    |
    | 关联规则   | OB-R-06（至少保留一种登录方式）          |
    | 幂等性     | 是（已解绑返回成功）                     |
    | 关联错误码 | E-400001, E-400032, E-401001, E-422205   |

    表 5.4.4.3.9-1 UC-AUTH-09契约概述表

+   **请求契约表**

    | 参数名   | 位置 | 类型   | 必填 | 约束                     | 示例值   | 业务含义 |
    | -------- | ---- | ------ | ---- | ------------------------ | -------- | -------- |
    | provider | path | String | 是   | 枚举：WECHAT/DINGTALK/QQ | "WECHAT" | 社交渠道 |

    表 5.4.4.3.9-2 UC-AUTH-09请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "解绑成功"            | 响应消息 |
    | data.provider  | String | 是   | "WECHAT"              | 社交渠道 |
    | data.unboundAt | String | 是   | "2026-01-26T11:00:00" | 解绑时间 |

    表 5.4.4.3.9-3 UC-AUTH-09响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "解绑成功",
          "data": {
            "provider": "WECHAT",
            "unboundAt": "2026-01-26T11:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（无法解绑最后一种登录方式）

        ```json
        {
          "code": 422205,
          "message": "无法解绑，请至少保留一种登录方式",
          "data": {
            "hasMobile": false,
            "otherBindings": [],
            "suggestion": "请先绑定手机号或其他社交账号"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   至少保留一种登录方式（手机号或其他社交绑定）
    -   解绑后该社交账号可被其他用户绑定

##### 5.4.4.3.10 UC-AUTH-10 修改密码

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | UC-AUTH-10                                     |
    | 接口路径   | POST /api/v1/uc/auth/password/change           |
    | 功能简述   | 修改当前用户密码                               |
    | 所需权限   | 登录即可                                       |
    | 关联功能   | F-AUTH-15 C端用户群密码修改                    |
    | 关联用例   | UC-AUTH-15 个人用户修改密码                    |
    | 关联领域   | Credential.changePassword()                    |
    | 关联规则   | PWD-R-01（旧密码验证）, PWD-R-02（密码复杂度） |
    | 幂等性     | 否                                             |
    | 关联错误码 | E-400001, E-401001, E-401008, E-422020         |

    表 5.4.4.3.10-1 UC-AUTH-10契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                 | 示例值        | 业务含义 |
    | ----------- | ---- | ------ | ---- | -------------------- | ------------- | -------- |
    | oldPassword | body | String | 是   | -                    | "OldPass123!" | 旧密码   |
    | newPassword | body | String | 是   | 8-32位，含大小写数字 | "NewPass456@" | 新密码   |

    表 5.4.4.3.10-2 UC-AUTH-10请求契约表

+   **响应契约表**

    | 参数名         | 类型   | 必有 | 示例值                | 业务含义 |
    | -------------- | ------ | ---- | --------------------- | -------- |
    | code           | Number | 是   | 0                     | 响应码   |
    | message        | String | 是   | "密码修改成功"        | 响应消息 |
    | data.changedAt | String | 是   | "2026-01-26T10:00:00" | 修改时间 |

    表 5.4.4.3.10-3 UC-AUTH-10响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "oldPassword": "OldPass123!",
          "newPassword": "NewPass456@"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "密码修改成功",
          "data": {
            "changedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（旧密码错误）

        ```json
        {
          "code": 401008,
          "message": "旧密码错误",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（密码复杂度不足）

        ```json
        {
          "code": 422020,
          "message": "新密码不符合复杂度要求",
          "data": {
            "requirements": "至少8位，包含大小写字母和数字"
          },
          "timestamp": 1737885600000
        }
        ```

#### 5.4.4.4 公共认证接口（COMMON）

##### 5.4.4.4.1 COMMON-01 获取图形验证码

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | COMMON-01                              |
    | 接口路径   | POST /api/v1/auth/captcha              |
    | 功能简述   | 获取图形验证码，用于登录和敏感操作防护 |
    | 所需权限   | 无（公开接口）                         |
    | 关联功能   | F-AUTH-12 验证码服务                   |
    | 关联用例   | UC-AUTH-14 获取图形验证码              |
    | 关联领域   | CaptchaService.generate()              |
    | 关联规则   | CAP-R-04（验证码有效期2分钟）          |
    | 幂等性     | 否（每次生成新验证码）                 |
    | 关联错误码 | E-400001                               |

    表 5.4.4.4.1-1 COMMON-01契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型    | 必填 | 约束                         | 示例值  | 业务含义   |
    | ------ | ---- | ------- | ---- | ---------------------------- | ------- | ---------- |
    | type   | body | String  | 否   | 枚举：IMAGE/SLIDE，默认IMAGE | "IMAGE" | 验证码类型 |
    | width  | body | Integer | 否   | 60-200，默认120              | 120     | 宽度像素   |
    | height | body | Integer | 否   | 30-80，默认40                | 40      | 高度像素   |

    表 5.4.4.4.1-2 COMMON-01请求契约表

+   **响应契约表**

    | 参数名           | 类型   | 必有 | 示例值                      | 业务含义       |
    | ---------------- | ------ | ---- | --------------------------- | -------------- |
    | code             | Number | 是   | 0                           | 响应码         |
    | message          | String | 是   | "success"                   | 响应消息       |
    | data.captchaId   | String | 是   | "cap_abc123def456"          | 验证码ID       |
    | data.imageBase64 | String | 是   | "data:image/png;base64,..." | 图片Base64编码 |
    | data.expiresIn   | Number | 是   | 120                         | 有效期秒数     |

    表 5.4.4.4.1-3 COMMON-01响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "type": "IMAGE",
          "width": 120,
          "height": 40
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "captchaId": "cap_abc123def456ghi789",
            "imageBase64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA...",
            "expiresIn": 120
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   验证码有效期2分钟
    -   支持IMAGE（图形验证码）和SLIDE（滑块验证码）两种类型

##### 5.4.4.4.2 COMMON-02 发送短信验证码

+   已废弃，归并到PUB-06

##### 5.4.4.4.3 COMMON-03 获取扫码登录二维码

+   **契约概述表**

    | 属性       | 值                                         |
    | ---------- | ------------------------------------------ |
    | API编号    | COMMON-03                                  |
    | 接口路径   | GET /api/v1/auth/scan/qrcode               |
    | 功能简述   | PC端获取扫码登录二维码，用于移动端扫码登录 |
    | 所需权限   | 无（公开接口）                             |
    | 关联功能   | F-AUTH-14 扫码登录服务                     |
    | 关联用例   | UC-AUTH-16 PC端获取扫码二维码              |
    | 关联领域   | ScanLoginService.generateQrcode()          |
    | 关联规则   | SCN-R-03（二维码有效期2分钟）              |
    | 幂等性     | 否（每次生成新二维码）                     |
    | 关联错误码 | E-400001                                   |

    表 5.4.4.4.3-1 COMMON-03契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型   | 必填 | 约束             | 示例值 | 业务含义 |
    | -------- | ----- | ------ | ---- | ---------------- | ------ | -------- |
    | userPool | query | String | 是   | 枚举：UR/UC      | "UR"   | 用户群   |
    | tenantId | query | Number | 否   | BIGINT，UR时必填 | 789    | 租户ID   |

    表 5.4.4.4.3-2 COMMON-03请求契约表

+   **响应契约表**

    | 参数名          | 类型   | 必有 | 示例值                       | 业务含义      |
    | --------------- | ------ | ---- | ---------------------------- | ------------- |
    | code            | Number | 是   | 0                            | 响应码        |
    | message         | String | 是   | "success"                    | 响应消息      |
    | data.ticket     | String | 是   | "scn_abc123def456..."        | 扫码票据      |
    | data.qrcodeUrl  | String | 是   | "https://qr.example.com/..." | 二维码图片URL |
    | data.qrcodeData | String | 是   | "clarisphere://scan?..."     | 二维码内容    |
    | data.expiresIn  | Number | 是   | 120                          | 有效期秒数    |

    表 5.4.4.4.3-3 COMMON-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "ticket": "scn_abc123def456ghi789jkl012mno345",
            "qrcodeUrl": "https://qr.example.com/scn_abc123def456.png",
            "qrcodeData": "clarisphere://scan?ticket=scn_abc123def456&pool=UR",
            "expiresIn": 120
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   二维码有效期2分钟
    -   PC端需轮询COMMON-04查询扫码状态

##### 5.4.4.4.4 COMMON-04 查询扫码状态

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | COMMON-04                            |
    | 接口路径   | GET /api/v1/auth/scan/status         |
    | 功能简述   | PC端轮询扫码状态，确认后获取登录令牌 |
    | 所需权限   | 无（公开接口）                       |
    | 关联功能   | F-AUTH-14 扫码登录服务               |
    | 关联用例   | UC-AUTH-17 PC端查询扫码状态          |
    | 关联领域   | ScanLoginService.getStatus()         |
    | 关联规则   | SCN-R-04（状态流转）                 |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001, E-404007                   |

    表 5.4.4.4.4-1 COMMON-04契约概述表

+   **请求契约表**

    | 参数名 | 位置  | 类型   | 必填 | 约束            | 示例值                | 业务含义 |
    | ------ | ----- | ------ | ---- | --------------- | --------------------- | -------- |
    | ticket | query | String | 是   | 64位URL安全字符 | "scn_abc123def456..." | 扫码票据 |

    表 5.4.4.4.4-2 COMMON-04请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值                      | 业务含义                  |
    | ----------------- | ------ | ---- | --------------------------- | ------------------------- |
    | code              | Number | 是   | 0                           | 响应码                    |
    | message           | String | 是   | "success"                   | 响应消息                  |
    | data.status       | String | 是   | "PENDING"                   | 扫码状态                  |
    | data.accessToken  | String | 否   | "eyJhbGciOiJSUzI1NiIs..."   | 访问令牌（CONFIRMED时）   |
    | data.refreshToken | String | 否   | "dGhpcyBpcyBhIHJlZnJlc2..." | 刷新令牌（CONFIRMED时）   |
    | data.expiresIn    | Number | 否   | 7200                        | 令牌有效期（CONFIRMED时） |
    | data.user         | Object | 否   | {...}                       | 用户信息（CONFIRMED时）   |

    表 5.4.4.4.4-3 COMMON-04响应契约表

+   **Mock示例**

    +   成功响应Mock（等待扫码）

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "status": "PENDING"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（已扫码待确认）

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "status": "SCANNED"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（已确认登录）

        ```json
        {
          "code": 200,
          "message": "登录成功",
          "data": {
            "status": "CONFIRMED",
            "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
            "expiresIn": 7200,
            "user": {
              "id": 1002,
              "username": "zhangsan",
              "realName": "张三"
            }
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（已取消）

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "status": "CANCELLED"
          },
          "timestamp": 1737885600000
        }
        ```

    +   成功响应Mock（已过期）

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "status": "EXPIRED"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   状态流转：PENDING → SCANNED → CONFIRMED/CANCELLED
    -   EXPIRED表示二维码已过期，需重新获取
    -   建议轮询间隔1-2秒

### 5.4.5 追溯关联表

+   本节提供认证API的追溯关联信息，便于从不同维度理解API的业务上下文。

#### 5.4.5.1 API-功能-用例关联表

+   全部REST API与RPC接口的功能-用例追溯关系如下表所示。

    | API编号     | API名称                | 关联功能编号 | 关联功能名称   | 关联用例编号 | 关联用例名称                   |
    | ----------- | ---------------------- | ------------ | -------------- | ------------ | ------------------------------ |
    | UP-AUTH-01  | 运营用户群登录（密码） | F-AUTH-01    | 运营用户群认证 | UC-AUTH-01   | 运营用户群用户登录系统         |
    | UP-AUTH-02  | 运营用户群登录验证短信 | F-AUTH-02    | MFA验证        | UC-AUTH-02   | 运营用户群用户完成MFA验证      |
    | UP-AUTH-03  | 运营用户群登出         | F-AUTH-03    | 用户登出       | UC-AUTH-03   | 运营用户群用户登出系统         |
    | UP-AUTH-04  | 运营用户群刷新令牌     | F-AUTH-04    | 令牌刷新       | UC-AUTH-04   | 运营用户群用户刷新访问令牌     |
    | UP-AUTH-05  | 查询当前会话           | F-AUTH-05    | 会话管理       | UC-AUTH-05   | 运营用户群用户查看当前会话     |
    | UP-AUTH-06  | 修改密码               | F-AUTH-06    | 密码修改       | UC-AUTH-06   | 运营用户群用户修改密码         |
    | UR-AUTH-01  | 租户用户群密码登录     | F-AUTH-07    | 租户用户群认证 | UC-AUTH-07   | 租户用户密码登录               |
    | UR-AUTH-02  | 租户用户群短信登录     | F-AUTH-08    | 短信验证登录   | UC-AUTH-08   | 租户用户短信免密登录           |
    | UR-AUTH-03  | 租户用户群双因素登录   | F-AUTH-09    | 双因素认证     | UC-AUTH-09   | 租户用户密码+短信双因素登录    |
    | UR-AUTH-04  | 租户用户群SSO登录      | F-AUTH-10    | SSO单点登录    | UC-AUTH-10   | 租户用户通过SSO登录            |
    | UR-AUTH-05  | 企业身份源登录         | F-AUTH-11    | 企业身份源认证 | UC-AUTH-11   | 租户用户通过企微/钉钉/飞书登录 |
    | UR-AUTH-06  | 企业内免密登录         | F-AUTH-12    | 免密登录       | UC-AUTH-12   | 租户用户企业内网免密登录       |
    | UR-AUTH-07  | 扫码登录确认           | F-AUTH-13    | 扫码登录       | UC-AUTH-13   | 租户用户移动端扫码确认登录     |
    | UR-AUTH-08  | 租户用户群登出         | F-AUTH-03    | 用户登出       | UC-AUTH-14   | 租户用户群用户登出系统         |
    | UR-AUTH-09  | 租户用户群刷新令牌     | F-AUTH-04    | 令牌刷新       | UC-AUTH-15   | 租户用户群用户刷新访问令牌     |
    | UR-AUTH-10  | 查询用户会话列表       | F-AUTH-05    | 会话管理       | UC-AUTH-16   | 租户用户查看会话列表           |
    | UR-AUTH-11  | 终止指定会话           | F-AUTH-14    | 会话终止       | UC-AUTH-17   | 租户用户终止指定设备会话       |
    | UR-AUTH-12  | 修改密码               | F-AUTH-06    | 密码修改       | UC-AUTH-18   | 租户用户群用户修改密码         |
    | UC-AUTH-01  | C端用户群短信登录      | F-AUTH-15    | C端用户认证    | UC-AUTH-19   | C端用户短信登录                |
    | UC-AUTH-02  | C端用户群密码登录      | F-AUTH-15    | C端用户认证    | UC-AUTH-20   | C端用户密码登录                |
    | UC-AUTH-03  | 社交账号登录           | F-AUTH-16    | 社交登录       | UC-AUTH-21   | C端用户通过微信/QQ登录         |
    | UC-AUTH-04  | 生物识别登录           | F-AUTH-17    | 生物识别认证   | UC-AUTH-22   | C端用户通过指纹/面容登录       |
    | UC-AUTH-05  | C端用户群登出          | F-AUTH-03    | 用户登出       | UC-AUTH-23   | C端用户群用户登出系统          |
    | UC-AUTH-06  | C端用户群刷新令牌      | F-AUTH-04    | 令牌刷新       | UC-AUTH-24   | C端用户群用户刷新访问令牌      |
    | UC-AUTH-07  | 查询社交绑定列表       | F-AUTH-18    | 社交账号查询   | UC-AUTH-25   | C端用户查看社交账号绑定列表    |
    | UC-AUTH-08  | 绑定社交账号           | F-AUTH-19    | 社交账号绑定   | UC-AUTH-26   | C端用户绑定社交账号            |
    | UC-AUTH-09  | 解绑社交账号           | F-AUTH-20    | 社交账号解绑   | UC-AUTH-27   | C端用户解绑社交账号            |
    | UC-AUTH-10  | 修改密码               | F-AUTH-06    | 密码修改       | UC-AUTH-28   | C端用户群用户修改密码          |
    | COMMON-01   | 获取图形验证码         | F-AUTH-21    | 验证码服务     | UC-AUTH-29   | 用户获取图形验证码             |
    | COMMON-03   | 获取扫码登录二维码     | F-AUTH-13    | 扫码登录       | UC-AUTH-31   | 用户发起扫码登录               |
    | COMMON-04   | 查询扫码状态           | F-AUTH-13    | 扫码登录       | UC-AUTH-31   | 用户轮询扫码登录状态           |
    | RPC-AUTH-01 | 验证访问令牌           | F-AUTH-23    | Token验证      | UC-PERM-01   | 授权管理验证请求令牌           |

    表 5.4.5.1-1 认证API-功能-用例关联表

    +   注：原COMMON-02（发送短信验证码）已合并至PUB-06（发送验证码，见3.4.4.4.7节），PUB-06同时支持短信和邮箱通道，统一作为全局验证码发送入口。

#### 5.4.5.2 API-领域-权限关联表

+   全部REST API与RPC接口的领域-权限追溯关系如下表所示。

    | API编号     | API名称                | 关联聚合         | 领域方法                                                | 权限标识      | 权限说明       |
    | ----------- | ---------------------- | ---------------- | ------------------------------------------------------- | ------------- | -------------- |
    | UP-AUTH-01  | 运营用户群登录（密码） | Credential       | Credential.verifyPassword() + LoginAttempt.record()     | 无            | 公开接口       |
    | UP-AUTH-02  | 运营用户群登录验证短信 | VerificationCode | VerificationCode.verify() + Token.issue()               | 无            | 需ticket       |
    | UP-AUTH-03  | 运营用户群登出         | Token, Session   | Token.revoke() + Session.destroy()                      | authenticated | 需Token        |
    | UP-AUTH-04  | 运营用户群刷新令牌     | Token            | Token.refresh()                                         | authenticated | 需refreshToken |
    | UP-AUTH-05  | 查询当前会话           | -                | SessionQueryService.list()                              | authenticated | 登录即可       |
    | UP-AUTH-06  | 修改密码               | Credential       | Credential.changePassword()                             | authenticated | 需旧密码验证   |
    | UR-AUTH-01  | 租户用户群密码登录     | Credential       | Credential.verifyPassword() + Token.issue()             | 无            | 公开接口       |
    | UR-AUTH-02  | 租户用户群短信登录     | VerificationCode | VerificationCode.verify() + Token.issue()               | 无            | 需租户开启     |
    | UR-AUTH-03  | 租户用户群双因素登录   | Credential       | Credential.verifyPassword() + VerificationCode.verify() | 无            | 公开接口       |
    | UR-AUTH-04  | 租户用户群SSO登录      | -                | SsoService.validateToken() + Token.issue()              | 无            | 公开接口       |
    | UR-AUTH-05  | 企业身份源登录         | -                | EnterpriseIdpService.authenticate()                     | 无            | 公开接口       |
    | UR-AUTH-06  | 企业内免密登录         | -                | PasswordlessService.validate()                          | 无            | IP范围限制     |
    | UR-AUTH-07  | 扫码登录确认           | -                | ScanLoginService.confirm() + Token.issue()              | authenticated | 移动端确认     |
    | UR-AUTH-08  | 租户用户群登出         | Token, Session   | Token.revoke() + Session.destroy()                      | authenticated | 需Token        |
    | UR-AUTH-09  | 租户用户群刷新令牌     | Token            | Token.refresh()                                         | authenticated | 需refreshToken |
    | UR-AUTH-10  | 查询用户会话列表       | -                | SessionQueryService.list()                              | authenticated | 登录即可       |
    | UR-AUTH-11  | 终止指定会话           | Session          | Session.terminate()                                     | authenticated | 仅可操作自己   |
    | UR-AUTH-12  | 修改密码               | Credential       | Credential.changePassword()                             | authenticated | 同步用户受限   |
    | UC-AUTH-01  | C端用户群短信登录      | VerificationCode | VerificationCode.verify() + Token.issue()               | 无            | 公开接口       |
    | UC-AUTH-02  | C端用户群密码登录      | Credential       | Credential.verifyPassword() + Token.issue()             | 无            | 公开接口       |
    | UC-AUTH-03  | 社交账号登录           | SocialConnection | SocialConnection.authenticate()                         | 无            | 公开接口       |
    | UC-AUTH-04  | 生物识别登录           | -                | BiometricService.verify()                               | 无            | 公开接口       |
    | UC-AUTH-05  | C端用户群登出          | Token, Session   | Token.revoke() + Session.destroy()                      | authenticated | 需Token        |
    | UC-AUTH-06  | C端用户群刷新令牌      | Token            | Token.refresh()                                         | authenticated | 需refreshToken |
    | UC-AUTH-07  | 查询社交绑定列表       | -                | SocialConnectionQueryService.list()                     | authenticated | 登录即可       |
    | UC-AUTH-08  | 绑定社交账号           | SocialConnection | SocialConnection.bind()                                 | authenticated | 登录即可       |
    | UC-AUTH-09  | 解绑社交账号           | SocialConnection | SocialConnection.unbind()                               | authenticated | 需保留一种方式 |
    | UC-AUTH-10  | 修改密码               | Credential       | Credential.changePassword()                             | authenticated | 登录即可       |
    | COMMON-01   | 获取图形验证码         | -                | CaptchaService.generate()                               | 无            | 公开接口       |
    | COMMON-03   | 获取扫码登录二维码     | -                | ScanLoginService.generateQrCode()                       | 无            | 公开接口       |
    | COMMON-04   | 查询扫码状态           | -                | ScanLoginService.getStatus()                            | 无            | 公开接口       |
    | RPC-AUTH-01 | 验证访问令牌           | -                | TokenService.validateAccessToken()                      | internal      | 内部RPC        |

    表 5.4.5.2-1 认证API-领域-权限关联表

    +   注：原COMMON-02（发送短信验证码）已合并至PUB-06（发送验证码，见3.4.4.4.7节），PUB-06同时支持短信和邮箱通道，统一作为全局验证码发送入口。

+   权限标识说明：
    -   `无`：公开接口，无需登录
    -   `authenticated`：需要登录，但无需特定权限
    -   `internal`：内部RPC接口，通过服务间认证

#### 5.4.5.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。RPC接口无前端页面，不在此表中。

    | API编号    | API名称                | 关联页面编号  | 页面名称         | 触发组件     | 触发时机      |
    | ---------- | ---------------------- | ------------- | ---------------- | ------------ | ------------- |
    | UP-AUTH-01 | 运营用户群登录（密码） | PG-UP-AUTH-01 | 运营后台登录页   | 登录按钮     | 点击登录      |
    | UP-AUTH-02 | 运营用户群登录验证短信 | PG-UP-AUTH-02 | MFA短信验证页    | 验证按钮     | 点击验证      |
    | UP-AUTH-03 | 运营用户群登出         | 全局Header    | -                | 登出按钮     | 点击登出      |
    | UP-AUTH-04 | 运营用户群刷新令牌     | -             | -                | -            | Token过期自动 |
    | UP-AUTH-05 | 查询当前会话           | PG-UP-AUTH-03 | 会话管理页       | -            | 页面加载      |
    | UP-AUTH-06 | 修改密码               | PG-UP-AUTH-04 | 修改密码页       | 提交按钮     | 点击提交      |
    | UR-AUTH-01 | 租户用户群密码登录     | PG-UR-AUTH-01 | 租户登录页       | 登录按钮     | 点击登录      |
    | UR-AUTH-02 | 租户用户群短信登录     | PG-UR-AUTH-01 | 租户登录页       | 短信登录按钮 | 点击登录      |
    | UR-AUTH-03 | 租户用户群双因素登录   | PG-UR-AUTH-02 | 双因素验证页     | 验证按钮     | 点击验证      |
    | UR-AUTH-04 | 租户用户群SSO登录      | PG-UR-AUTH-03 | SSO登录回调页    | -            | 自动触发      |
    | UR-AUTH-05 | 企业身份源登录         | PG-UR-AUTH-01 | 租户登录页       | 企业登录图标 | 点击图标      |
    | UR-AUTH-06 | 企业内免密登录         | -             | -                | -            | 自动触发      |
    | UR-AUTH-07 | 扫码登录确认           | PG-UR-AUTH-04 | 移动端扫码确认页 | 确认按钮     | 点击确认      |
    | UR-AUTH-08 | 租户用户群登出         | 全局Header    | -                | 登出按钮     | 点击登出      |
    | UR-AUTH-09 | 租户用户群刷新令牌     | -             | -                | -            | Token过期自动 |
    | UR-AUTH-10 | 查询用户会话列表       | PG-UR-AUTH-05 | 会话管理页       | -            | 页面加载      |
    | UR-AUTH-11 | 终止指定会话           | PG-UR-AUTH-05 | 会话管理页       | 终止按钮     | 点击确认      |
    | UR-AUTH-12 | 修改密码               | PG-UR-AUTH-06 | 修改密码页       | 提交按钮     | 点击提交      |
    | UC-AUTH-01 | C端用户群短信登录      | PG-UC-AUTH-01 | C端登录页        | 登录按钮     | 点击登录      |
    | UC-AUTH-02 | C端用户群密码登录      | PG-UC-AUTH-01 | C端登录页        | 密码登录按钮 | 点击登录      |
    | UC-AUTH-03 | 社交账号登录           | PG-UC-AUTH-01 | C端登录页        | 社交登录图标 | 点击图标      |
    | UC-AUTH-04 | 生物识别登录           | PG-UC-AUTH-01 | C端登录页        | 生物识别按钮 | 点击识别      |
    | UC-AUTH-05 | C端用户群登出          | 全局Header    | -                | 登出按钮     | 点击登出      |
    | UC-AUTH-06 | C端用户群刷新令牌      | -             | -                | -            | Token过期自动 |
    | UC-AUTH-07 | 查询社交绑定列表       | PG-UC-AUTH-02 | 账号绑定管理页   | -            | 页面加载      |
    | UC-AUTH-08 | 绑定社交账号           | PG-UC-AUTH-02 | 账号绑定管理页   | 绑定按钮     | 点击绑定      |
    | UC-AUTH-09 | 解绑社交账号           | PG-UC-AUTH-02 | 账号绑定管理页   | 解绑按钮     | 点击确认      |
    | UC-AUTH-10 | 修改密码               | PG-UC-AUTH-03 | 修改密码页       | 提交按钮     | 点击提交      |
    | COMMON-01  | 获取图形验证码         | 多个登录页    | -                | 验证码图片   | 页面加载/点击 |
    | COMMON-03  | 获取扫码登录二维码     | PG-UR-AUTH-04 | 扫码登录页       | -            | 页面加载      |
    | COMMON-04  | 查询扫码状态           | PG-UR-AUTH-04 | 扫码登录页       | -            | 自动轮询      |

    表 5.4.5.3-1 认证API-页面-组件关联表

    +   注：原COMMON-02（发送短信验证码）已合并至PUB-06（发送验证码，见3.4.4.4.7节），PUB-06同时支持短信和邮箱通道，统一作为全局验证码发送入口。

+   说明：
    -   关联页面编号对应5.6节前端设计中的页面编号
    -   UP-AUTH-04、UR-AUTH-09、UC-AUTH-06为刷新令牌接口，由前端HTTP拦截器自动触发，无直接关联页面
    -   UR-AUTH-06为企业内免密登录，通过IP范围自动识别触发，无用户交互页面
    -   COMMON-01获取图形验证码在运营登录页、租户登录页等多个登录页面触发

## 5.5 数据模型设计

+   本节设计认证管理相关的数据库表结构。
+   认证数据分布在平台库和租户库，部分高频数据存储在Redis。

### 5.5.1 数据库分布

+   认证管理数据分布如下表所示。

    | 数据类型       | 存储位置                        | 说明                    |
    | -------------- | ------------------------------- | ----------------------- |
    | 运营用户群凭证 | 平台库 clarisphere_platform     | up_credential表         |
    | C端用户群凭证  | 消费者库 clarisphere_consumer   | uc_credential表         |
    | 租户用户群凭证 | 租户库 clarisphere_t{tenant_id} | ur_credential表         |
    | 社交绑定       | 消费者库 clarisphere_consumer   | iam_oauth_binding表     |
    | 登录尝试记录   | 平台库/租户库                   | auth_login_attempt表    |
    | 登录锁定状态   | Redis                           | 高频读写，TTL自动过期   |
    | RefreshToken   | Redis                           | 高频读写，TTL自动过期   |
    | 会话           | Redis                           | 高频读写，TTL自动过期   |
    | 验证码         | Redis                           | 短生命周期，TTL自动过期 |
    | Token黑名单    | Redis                           | 短生命周期，TTL自动过期 |

    表 5.5.1-1 认证数据分布

### 5.5.2 平台库表结构

#### 5.5.2.1 up_credential（运营用户群凭证表）

+   运营用户群凭证表结构如下。

    | 字段名               | 类型         | 必填 | 默认值         | 说明                 |
    | -------------------- | ------------ | ---- | -------------- | -------------------- |
    | id                   | BIGINT       | 是   | AUTO_INCREMENT | 主键                 |
    | user_id              | BIGINT       | 是   | -              | 关联用户ID           |
    | password_hash        | VARCHAR(256) | 是   | -              | 密码哈希值           |
    | algorithm            | VARCHAR(32)  | 是   | ARGON2ID       | 哈希算法             |
    | password_set_at      | DATETIME     | 是   | -              | 密码设置时间         |
    | password_expire_at   | DATETIME     | 否   | -              | 密码过期时间         |
    | must_change_password | TINYINT      | 是   | 0              | 是否必须修改密码     |
    | history_hashes       | TEXT         | 否   | -              | 历史密码哈希JSON数组 |
    | created_at           | DATETIME     | 是   | NOW()          | 创建时间             |
    | updated_at           | DATETIME     | 是   | NOW()          | 更新时间             |

    表 5.5.2.1-1 up_credential表结构

+   索引设计。

    | 索引名          | 字段    | 类型   | 说明         |
    | --------------- | ------- | ------ | ------------ |
    | uk_up_cred_user | user_id | UNIQUE | 用户唯一索引 |

    表 5.5.2.1-2 up_credential索引

#### 5.5.2.2 uc_credential（C端用户群凭证表）

+   C端用户群凭证表结构如下。

    | 字段名          | 类型         | 必填 | 默认值         | 说明                   |
    | --------------- | ------------ | ---- | -------------- | ---------------------- |
    | id              | BIGINT       | 是   | AUTO_INCREMENT | 主键                   |
    | user_id         | BIGINT       | 是   | -              | 关联用户ID             |
    | password_hash   | VARCHAR(256) | 否   | -              | 密码哈希值（可选设置） |
    | algorithm       | VARCHAR(32)  | 否   | BCRYPT         | 哈希算法               |
    | password_set_at | DATETIME     | 否   | -              | 密码设置时间           |
    | created_at      | DATETIME     | 是   | NOW()          | 创建时间               |
    | updated_at      | DATETIME     | 是   | NOW()          | 更新时间               |

    表 5.5.2.2-1 uc_credential表结构

+   索引设计。

    | 索引名          | 字段    | 类型   | 说明         |
    | --------------- | ------- | ------ | ------------ |
    | uk_uc_cred_user | user_id | UNIQUE | 用户唯一索引 |

    表 5.5.2.2-2 uc_credential索引

#### 5.5.2.3 iam_oauth_binding（三方账号绑定表）

+   三方账号绑定表结构如下。

    | 字段名           | 类型         | 必填 | 默认值         | 说明                         |
    | ---------------- | ------------ | ---- | -------------- | ---------------------------- |
    | id               | BIGINT       | 是   | AUTO_INCREMENT | 主键                         |
    | user_id          | BIGINT       | 是   | -              | 关联用户ID                   |
    | provider         | VARCHAR(32)  | 是   | -              | 三方平台：QQ/WECHAT/DINGTALK |
    | open_id          | VARCHAR(128) | 是   | -              | 三方平台openId               |
    | union_id         | VARCHAR(128) | 否   | -              | 三方平台unionId              |
    | nickname         | VARCHAR(64)  | 否   | -              | 三方平台昵称                 |
    | avatar           | VARCHAR(512) | 否   | -              | 三方平台头像                 |
    | access_token     | VARCHAR(512) | 否   | -              | 访问令牌（加密存储）         |
    | refresh_token    | VARCHAR(512) | 否   | -              | 刷新令牌（加密存储）         |
    | token_expires_at | DATETIME     | 否   | -              | 令牌过期时间                 |
    | bound_at         | DATETIME     | 是   | NOW()          | 绑定时间                     |
    | updated_at       | DATETIME     | 是   | NOW()          | 更新时间                     |

    表 5.5.2.3-1 iam_oauth_binding表结构

+   索引设计。

    | 索引名            | 字段               | 类型   | 说明             |
    | ----------------- | ------------------ | ------ | ---------------- |
    | uk_provider_union | provider, union_id | UNIQUE | 平台+unionId唯一 |
    | uk_provider_open  | provider, open_id  | UNIQUE | 平台+openId唯一  |
    | idx_user_id       | user_id            | NORMAL | 用户ID索引       |

    表 5.5.2.3-2 iam_oauth_binding索引

#### 5.5.2.4 auth_login_attempt（登录尝试表）

+   登录尝试表结构如下（平台库存储UP，租户库存储UR，C端库存储UC）。

    | 字段名            | 类型         | 必填 | 默认值         | 说明                 |
    | ----------------- | ------------ | ---- | -------------- | -------------------- |
    | id                | BIGINT       | 是   | AUTO_INCREMENT | 主键                 |
    | user_pool         | VARCHAR(8)   | 是   | -              | 用户群（UP/UR/UC）   |
    | tenant_id         | BIGINT       | 否   | -              | 租户ID（UR时填写）   |
    | login_identifier  | VARCHAR(128) | 是   | -              | 登录标识             |
    | user_id           | BIGINT       | 否   | -              | 用户ID（成功时填写） |
    | success           | TINYINT      | 是   | -              | 是否成功             |
    | fail_reason       | VARCHAR(32)  | 否   | -              | 失败原因             |
    | login_method      | VARCHAR(32)  | 是   | -              | 登录方式             |
    | client_ip         | VARCHAR(64)  | 是   | -              | 客户端IP             |
    | user_agent        | VARCHAR(512) | 否   | -              | User-Agent           |
    | device_id         | VARCHAR(64)  | 否   | -              | 设备指纹             |
    | device_type       | VARCHAR(16)  | 否   | -              | 设备类型             |
    | location_country  | VARCHAR(64)  | 否   | -              | 国家                 |
    | location_province | VARCHAR(64)  | 否   | -              | 省份                 |
    | location_city     | VARCHAR(64)  | 否   | -              | 城市                 |
    | attempt_time      | DATETIME     | 是   | NOW()          | 尝试时间             |

    表 5.5.2.4-1 auth_login_attempt表结构

+   索引设计。

    | 索引名                 | 字段                        | 类型   | 说明         |
    | ---------------------- | --------------------------- | ------ | ------------ |
    | idx_attempt_identifier | login_identifier, user_pool | NORMAL | 登录标识查询 |
    | idx_attempt_user       | user_id                     | NORMAL | 用户查询     |
    | idx_attempt_time       | attempt_time                | NORMAL | 时间查询     |
    | idx_attempt_ip         | client_ip                   | NORMAL | IP查询       |

    表 5.5.2.4-2 auth_login_attempt索引

### 5.5.3 租户库表结构

#### 5.5.3.1 ur_credential（租户用户群凭证表）

+   租户用户群凭证表结构如下。

    | 字段名               | 类型         | 必填 | 默认值         | 说明                 |
    | -------------------- | ------------ | ---- | -------------- | -------------------- |
    | id                   | BIGINT       | 是   | AUTO_INCREMENT | 主键                 |
    | tenant_id            | BIGINT       | 是   | -              | 租户ID               |
    | user_id              | BIGINT       | 是   | -              | 关联用户ID           |
    | password_hash        | VARCHAR(256) | 是   | -              | 密码哈希值           |
    | algorithm            | VARCHAR(32)  | 是   | ARGON2ID       | 哈希算法             |
    | password_set_at      | DATETIME     | 是   | -              | 密码设置时间         |
    | password_expire_at   | DATETIME     | 否   | -              | 密码过期时间         |
    | must_change_password | TINYINT      | 是   | 0              | 是否必须修改密码     |
    | history_hashes       | TEXT         | 否   | -              | 历史密码哈希JSON数组 |
    | created_at           | DATETIME     | 是   | NOW()          | 创建时间             |
    | updated_at           | DATETIME     | 是   | NOW()          | 更新时间             |

    表 5.5.3.1-1 ur_credential表结构

+   索引设计。

    | 索引名          | 字段               | 类型   | 说明              |
    | --------------- | ------------------ | ------ | ----------------- |
    | uk_ur_cred_user | tenant_id, user_id | UNIQUE | 租户+用户唯一索引 |

    表 5.5.3.1-2 ur_credential索引

### 5.5.4 Redis数据结构

#### 5.5.4.1 登录锁定状态

+   Key格式：`auth:lockout:{userPool}:{tenantId}:{identifier}`
+   Value结构：

    ```json
    {
      "failCount": 5,
      "lastFailTime": "2024-01-15T10:30:00",
      "lockoutUntil": "2024-01-15T10:35:00"
    }
    ```

+   TTL：锁定时长 + 缓冲时间

#### 5.5.4.2 RefreshToken

+   Key格式：`auth:refresh:{tokenId}`
+   Value结构：

    ```json
    {
      "userId": 123456,
      "userPool": "UR",
      "tenantId": 789,
      "deviceId": "device_abc",
      "sessionId": "sess_xyz",
      "issuedAt": "2024-01-15T10:30:00",
      "expiresAt": "2024-01-15T18:30:00"
    }
    ```

+   TTL：Refresh Token有效期

#### 5.5.4.3 会话

+   Key格式：`auth:session:{sessionId}`
+   Value结构：

    ```json
    {
      "userId": 123456,
      "userPool": "UR",
      "tenantId": 789,
      "deviceInfo": {
        "deviceId": "device_abc",
        "deviceType": "WEB",
        "deviceName": "Chrome on Windows",
        "osName": "Windows",
        "browserName": "Chrome"
      },
      "loginTime": "2024-01-15T10:30:00",
      "lastActiveTime": "2024-01-15T11:45:00",
      "loginMethod": "PASSWORD",
      "loginIp": "192.168.1.100",
      "status": "ACTIVE"
    }
    ```

+   TTL：会话绝对超时时间

+   用户会话索引Key格式：`auth:user_sessions:{userPool}:{tenantId}:{userId}`
+   Value类型：SET，存储该用户的所有sessionId

#### 5.5.4.4 验证码

+   Key格式：`auth:code:{scene}:{userPool}:{tenantId}:{target}`
+   Value结构：

    ```json
    {
      "code": "123456",
      "verifyCount": 0,
      "createdAt": "2024-01-15T10:30:00"
    }
    ```

+   TTL：验证码有效期（5分钟）

+   发送频率限制Key格式：`auth:code_limit:{target}`
+   Value：发送次数
+   TTL：24小时

#### 5.5.4.5 Token黑名单

+   Key格式：`auth:blacklist:{tokenId}`
+   Value：1
+   TTL：Token原有效期剩余时间

#### 5.5.4.6 扫码登录

+   Key格式：`auth:scan:{ticket}`
+   Value结构：

    ```json
    {
      "status": "PENDING",
      "userPool": "UR",
      "tenantId": 789,
      "createdAt": "2024-01-15T10:30:00",
      "scannedBy": null,
      "confirmedUserId": null
    }
    ```

+   TTL：2分钟

### 5.5.5 数据字典

+   认证管理相关枚举定义如下表所示。

    | 枚举名称          | 枚举值                                                                                                  | 说明         |
    | ----------------- | ------------------------------------------------------------------------------------------------------- | ------------ |
    | UserPool          | UP, UR, UC                                                                                              | 用户群       |
    | HashAlgorithm     | BCRYPT, ARGON2ID, SCRYPT                                                                                | 哈希算法     |
    | LoginMethod       | PASSWORD, SMS_CODE, SOCIAL, SSO, SCAN_CODE, BIOMETRIC, PASSWORDLESS                                     | 登录方式     |
    | DeviceType        | WEB, H5, IOS, ANDROID, MINIAPP, DESKTOP                                                                 | 设备类型     |
    | SessionStatus     | ACTIVE, EXPIRED, TERMINATED, KICKED                                                                     | 会话状态     |
    | SocialProvider    | WECHAT, DINGTALK, QQ, WEIBO, APPLE                                                                      | 社交渠道     |
    | CodeScene         | LOGIN, LOGIN_MFA, REGISTER, RESET_PASSWORD, BIND_MOBILE, BIND_EMAIL, SENSITIVE_OP                       | 验证码场景   |
    | FailReason        | USER_NOT_FOUND, WRONG_PASSWORD, WRONG_CAPTCHA, ACCOUNT_LOCKED, ACCOUNT_DISABLED, IP_BLOCKED, MFA_FAILED | 失败原因     |
    | RevokeReason      | USER_LOGOUT, PASSWORD_CHANGED, ADMIN_REVOKE, SECURITY_RISK, SESSION_KICKED                              | 撤销原因     |
    | MultiDevicePolicy | NO_LIMIT, SAME_TYPE_KICK, SINGLE_DEVICE                                                                 | 多端登录策略 |
    | ScanStatus        | PENDING, SCANNED, CONFIRMED, CANCELLED, EXPIRED                                                         | 扫码状态     |

    表 5.5.5-1 认证管理数据字典

## 5.6 前端设计

+   本节设计认证管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   认证管理前端以登录表单为核心，按用户群独立设计登录入口，公共页面（修改密码、会话管理等）通过路由参数复用。

### 5.6.1 页面总览

+   认证管理前端页面清单如下表所示。

    | 页面编号       | 页面名称       | 用户群 | 路由路径                  | 说明                        |
    | -------------- | -------------- | ------ | ------------------------- | --------------------------- |
    | PG-P-AUTH-01   | 运营用户群登录 | UP     | /up/login                 | 用户名密码+短信双因素       |
    | PG-UR-AUTH-01  | 租户用户群登录 | UR     | /ur/login                 | 多方式登录，支持Tab切换     |
    | PG-UR-AUTH-02  | 租户SSO回调    | UR     | /ur/sso/callback          | SSO登录回调中转页           |
    | PG-UC-AUTH-01  | C端用户群登录  | UC     | /uc/login                 | 社交一键登录+手机号登录     |
    | PG-UC-AUTH-02  | 社交绑定管理   | UC     | /uc/settings/bindList     | 管理第三方社交账号绑定      |
    | PG-PUB-AUTH-01 | 修改密码       | 公共   | /{pool}/settings/password | UP/UR/UC共用，路由参数区分  |
    | PG-PUB-AUTH-02 | 忘记密码       | 公共   | /{pool}/forgot-password   | UP/UR/UC共用，路由参数区分  |
    | PG-PUB-AUTH-03 | 会话管理       | 公共   | /{pool}/settings/sessions | UP/UR用户查看并管理登录设备 |

    表 5.6.1-1 认证管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────┐
    │                       认证管理页面导航                           │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │    运营用户群（UP）                                              │
    │    └── 登录                                                      │
    │        └── [PG-P-AUTH-01] 运营用户群登录                         │
    │                                                                  │
    │    租户用户群（UR）                                              │
    │    ├── 登录                                                      │
    │    │   ├── [PG-UR-AUTH-01] 租户用户群登录                        │
    │    │   └── [PG-UR-AUTH-02] 租户SSO回调                           │
    │    └── 设置                                                      │
    │                                                                  │
    │    C端用户群（UC）                                               │
    │    ├── 登录                                                      │
    │    │   └── [PG-UC-AUTH-01] C端用户群登录                         │
    │    └── 设置                                                      │
    │        └── [PG-UC-AUTH-02] 社交绑定管理                          │
    │                                                                  │
    │    公共页面                                                      │
    │    ├── [PG-PUB-AUTH-01] 修改密码                                 │
    │    ├── [PG-PUB-AUTH-02] 忘记密码                                 │
    │    └── [PG-PUB-AUTH-03] 会话管理                                 │
    │                                                                  │
    └──────────────────────────────────────────────────────────────────┘
    ```

    图 5.6.1-1 认证管理页面导航结构

### 5.6.2 运营用户群（UP）登录

#### 5.6.2.1 PG-P-AUTH-01 运营用户群登录

+   页面说明：
    -   用途：运营方用户通过用户名密码登录平台运营管理系统，SaaS部署需短信二次验证
    -   入口：直接访问 /up/login，未认证时自动跳转
    -   权限：无需认证（登录前页面）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-P-AUTH-01 运营用户群登录                             │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │       LOGO           │                 │
    │                 │   平台运营管理系统   │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │                      │                 │
    │                 │  步骤1：验证身份     │                 │
    │                 │                      │                 │
    │                 │  用户名              │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │                │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  密码                │                 │
    │                 │  ┌──────────────┐    │                 │
    │                 │  │  ●●●●●●   👁 │    │                 │
    │                 │  └──────────────┘    │                 │
    │                 │                      │                 │
    │                 │  验证码              │                 │
    │                 │  ┌──────────┐ ┌───┐  │                 │
    │                 │  │          │ │图 │  │                 │
    │                 │  └──────────┘ └───┘  │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │    下一步      │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │                      │                 │
    │                 │  步骤2：短信验证     │                 │
    │                 │  (SaaS部署时显示)    │                 │
    │                 │                      │                 │
    │                 │  验证码已发送至      │                 │
    │                 │  138****8888         │                 │
    │                 │                      │                 │
    │                 │  短信验证码          │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │                │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │     登录       │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  59秒后可重新发送    │                 │
    │                 │                      │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.2.1-1 运营用户群登录页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称         | 说明                                          | 关联API    | 前置条件                |
    | -------- | -------- | ---------------- | --------------------------------------------- | ---------- | ----------------------- |
    | F01      | 展示     | 加载登录表单     | 进入页面渲染步骤1登录表单，自动加载图形验证码 | COMMON-01  | -                       |
    | F02      | 操作     | 输入用户名       | 输入登录用户名                                | -          | -                       |
    | F03      | 操作     | 输入密码         | 输入密码，点击眼睛图标切换明文/密文显示       | -          | -                       |
    | F04      | 操作     | 刷新验证码       | 点击图形验证码图片刷新                        | COMMON-01  | -                       |
    | F05      | 操作     | 下一步           | 提交用户名+密码+验证码进行身份验证            | UP-AUTH-01 | 必填校验通过            |
    | F06      | 展示     | 显示短信验证面板 | 步骤1验证通过后显示步骤2面板，展示脱敏手机号  | -          | F05验证通过（SaaS部署） |
    | F07      | 操作     | 发送短信         | 步骤1验证通过后自动发送短信至绑定手机         | PUB-06     | F05验证通过（SaaS部署） |
    | F08      | 操作     | 重新发送         | 重新发送短信验证码                            | PUB-06     | 60秒倒计时结束          |
    | F09      | 操作     | 登录             | 提交短信验证码完成登录，跳转至首页            | UP-AUTH-02 | 6位数字验证码必填       |

    表 5.6.2.1-1 运营用户群登录功能说明

+   交互规则：
    -   SaaS部署模式下，步骤1验证通过后自动切换至步骤2面板；私有化部署时步骤1验证通过后直接登录
    -   图形验证码加载失败时显示"点击刷新"占位文字
    -   密码输入框默认密文显示，点击眼睛图标切换
    -   连续输入错误达到阈值后，登录按钮禁用并显示锁定倒计时

### 5.6.3 租户用户群（UR）登录

#### 5.6.3.1 PG-UR-AUTH-01 租户用户群登录

+   页面说明：
    -   用途：租户用户通过多种方式登录企业工作台，登录方式由租户配置控制
    -   入口：直接访问 /ur/login 或通过租户专属域名访问
    -   权限：无需认证（登录前页面）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-UR-AUTH-01 租户用户群登录                            │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │     租户LOGO/名称    │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │                      │                 │
    │                 │ [密码登录][验证码登录]  ← Tab切换      │
    │                 │ ───────────────────  │                 │
    │                 │                      │                 │
    │                 │ 【密码登录Tab】      │                 │
    │                 │ 用户名/邮箱/手机号   │                 │
    │                 │ ┌────────────────┐   │                 │
    │                 │ │                │   │                 │
    │                 │ └────────────────┘   │                 │
    │                 │                      │                 │
    │                 │ 密码                 │                 │
    │                 │ ┌────────────────┐   │                 │
    │                 │ │  ●●●●●●    👁  │   │                 │
    │                 │ └────────────────┘   │                 │
    │                 │                      │                 │
    │                 │ 验证码（若需要）     │                 │
    │                 │ ┌──────────┐ ┌───┐   │                 │
    │                 │ │          │ │图 │   │                 │
    │                 │ └──────────┘ └───┘   │                 │
    │                 │                      │                 │
    │                 │ □ 记住登录           │                 │
    │                 │                      │                 │
    │                 │ ┌────────────────┐   │                 │
    │                 │ │     登录       │   │                 │
    │                 │ └────────────────┘   │                 │
    │                 │                      │                 │
    │                 │ 忘记密码？           │                 │
    │                 │                      │                 │
    │                 │ ───────────────────  │                 │
    │                 │ 其他登录方式         │                 │
    │                 │ ┌────┐ ┌────┐ ┌────┐ │  ← 按配置显示   │
    │                 │ │企微│ │钉钉│ │SSO │ │                 │
    │                 │ └────┘ └────┘ └────┘ │                 │
    │                 │                      │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.3.1-1 租户用户群登录页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称       | 说明                                              | 关联API    | 前置条件               |
    | -------- | -------- | -------------- | ------------------------------------------------- | ---------- | ---------------------- |
    | F01      | 展示     | 加载登录页     | 进入页面根据租户配置动态渲染登录方式Tab和三方图标 | -          | -                      |
    | F02      | 操作     | 密码登录Tab    | 切换至用户名+密码登录表单                         | -          | 租户开启密码登录       |
    | F03      | 操作     | 验证码登录Tab  | 切换至手机号+短信验证码登录表单                   | -          | 租户开启短信登录       |
    | F04      | 操作     | 密码登录       | 提交用户名+密码，验证后签发Token                  | UR-AUTH-01 | 必填校验通过           |
    | F05      | 操作     | 短信登录       | 提交手机号+短信验证码，验证后签发Token            | UR-AUTH-02 | 必填校验通过           |
    | F06      | 操作     | 获取图形验证码 | 加载图形验证码图片，点击可刷新                    | COMMON-01  | -                      |
    | F07      | 操作     | 发送短信       | 发送短信验证码至手机号                            | PUB-06     | 60秒倒计时限制         |
    | F08      | 操作     | 记住登录       | 勾选后延长会话有效期                              | -          | 租户开启记住登录       |
    | F09      | 操作     | 忘记密码       | 跳转至忘记密码页面                                | -          | -                      |
    | F10      | 操作     | 企业微信登录   | 跳转至企业微信OAuth授权页面                       | UR-AUTH-05 | 租户配置企业微信身份源 |
    | F11      | 操作     | 钉钉登录       | 跳转至钉钉OAuth授权页面                           | UR-AUTH-05 | 租户配置钉钉身份源     |
    | F12      | 操作     | SSO登录        | 跳转至企业SSO IdP认证页面                         | UR-AUTH-04 | 租户配置SSO            |

    表 5.6.3.1-1 租户用户群登录功能说明

+   交互规则：
    -   页面加载时根据租户配置动态渲染登录方式Tab和第三方登录图标，未配置的方式不显示
    -   图形验证码仅在连续登录失败达到阈值后出现
    -   "记住登录"勾选框仅在租户开启该功能时显示
    -   租户用户名输入支持 tenantCode\username 格式，前端自动解析租户编码并路由至对应数据源
    -   当租户仅配置一种第三方登录方式且未开启密码登录时，自动跳转至该第三方登录页面

#### 5.6.3.2 PG-UR-AUTH-02 租户SSO回调

+   页面说明：
    -   用途：SSO单点登录的回调中转页面，接收IdP返回的授权码并完成令牌交换
    -   入口：由SSO IdP认证完成后302重定向至此页面
    -   权限：无需认证（登录流程中间页）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-UR-AUTH-02 租户SSO回调                               │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │                      │                 │
    │                 │    ○ 正在登录...     │                 │
    │                 │                      │                 │
    │                 │  正在验证身份信息，  │                 │
    │                 │  请稍候...           │                 │
    │                 │                      │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.3.2-1 租户SSO回调页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称     | 说明                                                 | 关联API    | 前置条件            |
    | -------- | -------- | ------------ | ---------------------------------------------------- | ---------- | ------------------- |
    | F01      | 展示     | 显示加载状态 | 页面加载后显示加载动画和"正在登录"提示文字           | -          | -                   |
    | F02      | 操作     | SSO令牌交换  | 从URL参数提取授权码，调用后端完成令牌交换            | UR-AUTH-04 | URL中包含有效授权码 |
    | F03      | 操作     | 登录成功跳转 | 令牌交换成功后自动跳转至租户工作台首页               | -          | F02成功             |
    | F04      | 展示     | 异常提示     | 授权码无效或超时，显示错误提示信息并提供返回登录链接 | -          | F02失败             |

    表 5.6.3.2-1 租户SSO回调功能说明

+   交互规则：
    -   页面加载后自动执行令牌交换，无需用户操作
    -   交换过程中显示加载动画和提示文字
    -   超时（默认10秒）或失败后显示"登录失败"并提供"返回登录页"链接

### 5.6.4 C端用户群（UC）登录

#### 5.6.4.1 PG-UC-AUTH-01 C端用户群登录

+   页面说明：
    -   用途：C端个人用户通过社交账号一键登录或手机号登录
    -   入口：直接访问 /uc/login，未认证时自动跳转
    -   权限：无需认证（登录前页面）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-UC-AUTH-01 C端用户群登录                             │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │      APP LOGO        │                 │
    │                 │      应用名称        │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    │                 ┌──────────────────────┐                 │
    │                 │                      │                 │
    │                 │  一键登录            │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │  微信一键登录  │  │  ← 推荐         │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │  钉钉一键登录  │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │  QQ一键登录    │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  ──────── 或 ─────── │                 │
    │                 │                      │                 │
    │                 │  手机号登录          │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │+86│请输入手机号│  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  ┌──────────┐ ┌───┐  │                 │
    │                 │  │输入验证码│ │获取  │                 │
    │                 │  └──────────┘ └───┘  │                 │
    │                 │                      │                 │
    │                 │  ┌────────────────┐  │                 │
    │                 │  │   登录/注册    │  │                 │
    │                 │  └────────────────┘  │                 │
    │                 │                      │                 │
    │                 │  登录即表示同意      │                 │
    │                 │  《用户协议》        │                 │
    │                 │                      │                 │
    │                 └──────────────────────┘                 │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.4.1-1 C端用户群登录页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称     | 说明                                      | 关联API    | 前置条件           |
    | -------- | -------- | ------------ | ----------------------------------------- | ---------- | ------------------ |
    | F01      | 展示     | 加载登录页   | 进入页面根据平台配置动态渲染社交登录按钮  | -          | -                  |
    | F02      | 操作     | 微信一键登录 | 跳转微信OAuth授权页面，授权后自动登录     | UC-AUTH-03 | -                  |
    | F03      | 操作     | 钉钉一键登录 | 跳转钉钉OAuth授权页面，授权后自动登录     | UC-AUTH-03 | -                  |
    | F04      | 操作     | QQ一键登录   | 跳转QQ OAuth授权页面，授权后自动登录      | UC-AUTH-03 | -                  |
    | F05      | 操作     | 获取验证码   | 发送短信验证码至输入的手机号              | PUB-06     | 手机号格式校验通过 |
    | F06      | 操作     | 登录/注册    | 提交手机号+验证码登录，未注册用户自动注册 | UC-AUTH-01 | 必填校验通过       |
    | F07      | 操作     | 用户协议     | 跳转至用户协议页面                        | -          | -                  |

    表 5.6.4.1-1 C端用户群登录功能说明

+   交互规则：
    -   社交登录按钮根据平台配置动态显示，未配置的渠道不显示
    -   手机号输入支持国际区号选择，默认+86
    -   获取验证码按钮点击后进入60秒倒计时，倒计时期间按钮置灰不可点击
    -   未注册手机号首次登录时自动创建账号并跳转至首页
    -   社交登录首次授权且未绑定手机号时，弹出手机号绑定弹窗

### 5.6.5 C端用户群（UC）设置

#### 5.6.5.1 PG-UC-AUTH-02 社交绑定管理

+   页面说明：
    -   用途：C端用户查看并管理已绑定的第三方社交账号
    -   入口：个人设置 → 账号绑定
    -   权限：uc:iam:social:list

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-UC-AUTH-02 社交绑定管理                              │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │  ← 返回   账号绑定                                       │
    │                                                          │
    │  ┌──────────────────────────────────────────────────┐    │
    │  │                                                  │    │
    │  │  ┌────┐  微信                        已绑定      │    │
    │  │  │图标│  昵称: 小明              [解除绑定]      │    │
    │  │  └────┘  绑定时间: 2024-01-15                    │    │
    │  │                                                  │    │
    │  │  ────────────────────────────────────────────    │    │
    │  │                                                  │    │
    │  │  ┌────┐  钉钉                        已绑定      │    │
    │  │  │图标│  昵称: 张三              [解除绑定]      │    │
    │  │  └────┘  绑定时间: 2024-01-10                    │    │
    │  │                                                  │    │
    │  │  ────────────────────────────────────────────    │    │
    │  │                                                  │    │
    │  │  ┌────┐  QQ                          未绑定      │    │
    │  │  │图标│                            [去绑定]      │    │
    │  │  └────┘                                          │    │
    │  │                                                  │    │
    │  └──────────────────────────────────────────────────┘    │
    │                                                          │
    │  提示：至少保留一种登录方式                              │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.5.1-1 社交绑定管理页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称     | 说明                                             | 关联API    | 前置条件             |
    | -------- | -------- | ------------ | ------------------------------------------------ | ---------- | -------------------- |
    | F01      | 展示     | 加载绑定列表 | 进入页面加载当前用户已绑定和可绑定的社交渠道列表 | UC-AUTH-07 | uc:iam:social:list   |
    | F02      | 操作     | 去绑定       | 跳转至对应社交平台OAuth授权页面进行账号绑定      | UC-AUTH-08 | uc:iam:social:create |
    | F03      | 操作     | 解除绑定     | 解除与指定社交平台的账号绑定关系                 | UC-AUTH-09 | uc:iam:social:delete |

    表 5.6.5.1-1 社交绑定管理功能说明

+   列表字段如下表所示。

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                                     |
    | -------- | ---- | ---- | -------- | ---------------------------------------- |
    | 渠道图标 | 48px | 中   | 否       | 社交平台Logo图标                         |
    | 渠道名称 | auto | 左   | 否       | 社交平台名称（微信、钉钉、QQ等）         |
    | 绑定昵称 | auto | 左   | 否       | 已绑定时显示社交账号昵称，未绑定时不显示 |
    | 绑定时间 | auto | 左   | 否       | 已绑定时显示绑定时间，未绑定时不显示     |
    | 绑定状态 | 80px | 中   | 否       | 已绑定/未绑定                            |
    | 操作     | 80px | 中   | 否       | 已绑定显示"解除绑定"，未绑定显示"去绑定" |

    表 5.6.5.1-2 社交绑定管理列表字段

+   状态/标签展示如下表所示。

    | 枚举值  | 标签文本 | 颜色 |
    | ------- | -------- | ---- |
    | BOUND   | 已绑定   | 绿色 |
    | UNBOUND | 未绑定   | 灰色 |

    表 5.6.5.1-3 社交绑定状态标签

+   交互规则：
    -   解除绑定时弹出二次确认对话框，提示"确认解除与{渠道名称}的绑定关系？"
    -   当用户仅剩一种登录方式（仅一个社交绑定且无密码）时，解除绑定按钮置灰并显示Tooltip提示"至少保留一种登录方式"

### 5.6.6 公共页面

#### 5.6.6.1 PG-PUB-AUTH-01 修改密码

+   页面说明：
    -   用途：已登录用户修改自己的登录密码
    -   入口：个人设置 → 安全设置 → 修改密码
    -   权限：{pool}:iam:credential:update（UP/UR/UC各用户群对应权限）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-PUB-AUTH-01 修改密码                                 │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │  ← 返回   修改密码                                       │
    │                                                          │
    │  ┌──────────────────────────────────────────────────┐    │
    │  │                                                  │    │
    │  │  当前密码                                        │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  │  新密码                                          │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │  密码强度：■□□ 弱                                │    │
    │  │                                                  │    │
    │  │  确认新密码                                      │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  │  ┌──────────────────┐                            │    │
    │  │  │     确认修改     │                            │    │
    │  │  └──────────────────┘                            │    │
    │  │                                                  │    │
    │  └──────────────────────────────────────────────────┘    │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.6.1-1 修改密码页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称         | 说明                                       | 关联API                          | 前置条件                     |
    | -------- | -------- | ---------------- | ------------------------------------------ | -------------------------------- | ---------------------------- |
    | F01      | 展示     | 加载修改密码表单 | 进入页面渲染修改密码表单                   | -                                | {pool}:iam:credential:update |
    | F02      | 操作     | 输入旧密码       | 输入当前登录密码                           | -                                | -                            |
    | F03      | 操作     | 输入新密码       | 输入新密码，实时显示密码强度指示           | -                                | -                            |
    | F04      | 展示     | 密码强度提示     | 根据输入实时计算并显示密码强度（弱/中/强） | -                                | -                            |
    | F05      | 操作     | 确认新密码       | 再次输入新密码                             | -                                | -                            |
    | F06      | 展示     | 一致性校验提示   | 两次新密码不一致时实时提示错误信息         | -                                | -                            |
    | F07      | 操作     | 确认修改         | 验证旧密码正确且新密码符合策略后修改密码   | UP-AUTH-06/UR-AUTH-12/UC-AUTH-10 | 必填校验通过，两次新密码一致 |

    表 5.6.6.1-1 修改密码功能说明

+   交互规则：
    -   新密码输入时实时显示密码强度指示（弱/中/强），密码策略由后端配置决定
    -   两次新密码不一致时，确认新密码输入框下方实时提示"两次输入的密码不一致"
    -   修改成功后弹出提示"密码修改成功，请重新登录"，并自动跳转至登录页

#### 5.6.6.2 PG-PUB-AUTH-02 忘记密码

+   页面说明：
    -   用途：用户通过手机号或邮箱验证身份后重置登录密码
    -   入口：登录页面 → "忘记密码？"链接
    -   权限：无需认证（登录前页面）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-PUB-AUTH-02 忘记密码                                 │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │  ← 返回登录   找回密码                                   │
    │                                                          │
    │  ┌──────────────────────────────────────────────────┐    │
    │  │                                                  │    │
    │  │  步骤指示：① 验证身份  ② 设置新密码  ③ 完成      │    │
    │  │                                                  │    │
    │  │  ─────────────────────────────────────────────── │    │
    │  │                                                  │    │
    │  │  【步骤1：验证身份】                             │    │
    │  │  手机号/邮箱                                     │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  │  验证码                                          │    │
    │  │  ┌──────────────────────┐ ┌──────────────┐       │    │
    │  │  │                      │ │ 获取验证码   │       │    │
    │  │  └──────────────────────┘ └──────────────┘       │    │
    │  │                                                  │    │
    │  │  ┌──────────────────┐                            │    │
    │  │  │     下一步       │                            │    │
    │  │  └──────────────────┘                            │    │
    │  │                                                  │    │
    │  │  ─────────────────────────────────────────────── │    │
    │  │                                                  │    │
    │  │  【步骤2：设置新密码】                           │    │
    │  │  新密码                                          │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  │  确认新密码                                      │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  │  ┌──────────────────┐                            │    │
    │  │  │    确认重置      │                            │    │
    │  │  └──────────────────┘                            │    │
    │  │                                                  │    │
    │  │  ─────────────────────────────────────────────── │    │
    │  │                                                  │    │
    │  │  【步骤3：完成】                                 │    │
    │  │  ┌────────────────────────────────────────┐      │    │
    │  │  │                                        │      │    │
    │  │  │   ✓ 密码重置成功                       │      │    │
    │  │  │                                        │      │    │
    │  │  │   3秒后自动跳转至登录页                │      │    │
    │  │  │                                        │      │    │
    │  │  │          [返回登录]                    │      │    │
    │  │  │                                        │      │    │
    │  │  └────────────────────────────────────────┘      │    │
    │  │                                                  │    │
    │  └──────────────────────────────────────────────────┘    │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.6.2-1 忘记密码页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称      | 说明                                       | 关联API | 前置条件                |
    | -------- | -------- | ------------- | ------------------------------------------ | ------- | ----------------------- |
    | F01      | 展示     | 加载步骤表单  | 进入页面渲染步骤指示条和步骤1表单          | -       | -                       |
    | F02      | 操作     | 输入手机/邮箱 | 输入绑定的手机号或邮箱地址                 | -       | -                       |
    | F03      | 操作     | 获取验证码    | 发送短信或邮件验证码                       | PUB-06  | 手机号/邮箱格式校验通过 |
    | F04      | 操作     | 下一步        | 提交手机/邮箱+验证码验证身份，进入步骤2    | PUB-04  | 必填校验通过            |
    | F05      | 操作     | 设置新密码    | 输入新密码和确认密码                       | -       | -                       |
    | F06      | 展示     | 密码强度提示  | 根据输入实时计算并显示密码强度（弱/中/强） | -       | -                       |
    | F07      | 操作     | 确认重置      | 提交新密码完成重置                         | PUB-05  | 两次新密码一致          |
    | F08      | 展示     | 重置成功提示  | 显示"密码重置成功"提示，3秒后自动跳转      | -       | F07成功                 |
    | F09      | 操作     | 返回登录      | 返回对应用户群的登录页面                   | -       | -                       |

    表 5.6.6.2-1 忘记密码功能说明

+   交互规则：
    -   页面顶部显示步骤指示条，标记当前所在步骤
    -   步骤1验证通过后自动切换至步骤2面板，步骤1面板不可编辑
    -   密码重置成功后显示步骤3"密码重置成功"提示页，3秒后自动跳转至登录页

#### 5.6.6.3 PG-PUB-AUTH-03 会话管理

+   页面说明：
    -   用途：已登录用户查看当前活跃的登录设备和会话，支持终止其他设备的会话
    -   入口：个人设置 → 安全设置 → 登录设备
    -   权限：{pool}:iam:session:list（UP/UR对应权限）

+   页面布局如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────┐
    │  PG-PUB-AUTH-03 会话管理                                 │
    ├──────────────────────────────────────────────────────────┤
    │                                                          │
    │  ← 返回   登录设备管理                                   │
    │                                                          │
    │  ┌──────────────────────────────────────────────────┐    │
    │  │                                                  │    │
    │  │  当前设备                                        │    │
    │  │  ┌──────────────────────────────────────────┐    │    │
    │  │  │  💻 Chrome · Windows 10                  │    │    │
    │  │  │  IP: 192.168.1.100                       │    │    │
    │  │  │  登录时间: 2026-01-30 10:30              │    │    │
    │  │  │  状态: 当前设备                          │    │    │
    │  │  └──────────────────────────────────────────┘    │    │
    │  │                                                  │    │
    │  │  其他设备                                        │    │
    │  │  ┌──────────────────────────────────────────┐    │    │
    │  │  │  📱 Safari · iOS 17           [下线]     │    │    │
    │  │  │  IP: 10.0.0.50                           │    │    │
    │  │  │  登录时间: 2026-01-29 08:15              │    │    │
    │  │  └──────────────────────────────────────────┘    │    │
    │  │  ┌──────────────────────────────────────────┐    │    │
    │  │  │  💻 Firefox · macOS           [下线]     │    │    │
    │  │  │  IP: 172.16.0.20                         │    │    │
    │  │  │  登录时间: 2026-01-28 14:00              │    │    │
    │  │  └──────────────────────────────────────────┘    │    │
    │  │                                                  │    │
    │  │  ┌──────────────────────────────────────────┐    │    │
    │  │  │           下线所有其他设备               │    │    │
    │  │  └──────────────────────────────────────────┘    │    │
    │  │                                                  │    │
    │  └──────────────────────────────────────────────────┘    │
    │                                                          │
    └──────────────────────────────────────────────────────────┘
    ```

    图 5.6.6.3-1 会话管理页面线框图

+   功能说明如下表所示。

    | 功能编号 | 功能类型 | 功能名称         | 说明                                   | 关联API               | 前置条件                  |
    | -------- | -------- | ---------------- | -------------------------------------- | --------------------- | ------------------------- |
    | F01      | 展示     | 加载会话列表     | 进入页面加载当前用户所有活跃会话       | UP-AUTH-05/UR-AUTH-10 | {pool}:iam:session:list   |
    | F02      | 展示     | 标记当前设备     | 当前设备的会话卡片高亮并标记"当前设备" | -                     | -                         |
    | F03      | 操作     | 下线指定设备     | 终止指定设备的会话，使其登录失效       | UR-AUTH-11            | {pool}:iam:session:delete |
    | F04      | 操作     | 下线所有其他设备 | 一键终止除当前设备外所有其他设备的会话 | UR-AUTH-11            | {pool}:iam:session:delete |

    表 5.6.6.3-1 会话管理功能说明

+   列表字段如下表所示。

    | 字段名   | 列宽  | 对齐 | 是否排序 | 说明                                       |
    | -------- | ----- | ---- | -------- | ------------------------------------------ |
    | 设备图标 | 48px  | 中   | 否       | 根据设备类型显示电脑/手机/平板图标         |
    | 浏览器   | auto  | 左   | 否       | 浏览器名称 + 操作系统                      |
    | IP地址   | auto  | 左   | 否       | 登录IP地址                                 |
    | 登录时间 | 160px | 左   | 是       | 格式 YYYY-MM-DD HH:mm                      |
    | 状态     | 80px  | 中   | 否       | 当前设备显示"当前设备"，其他显示"在线"     |
    | 操作     | 80px  | 中   | 否       | 当前设备无操作按钮，其他设备显示"下线"按钮 |

    表 5.6.6.3-2 会话管理列表字段

+   状态/标签展示如下表所示。

    | 枚举值  | 标签文本 | 颜色 |
    | ------- | -------- | ---- |
    | CURRENT | 当前设备 | 蓝色 |
    | ONLINE  | 在线     | 绿色 |

    表 5.6.6.3-3 会话管理状态标签

+   交互规则：
    -   当前设备的会话卡片高亮显示并标记"当前设备"，不显示下线按钮
    -   点击"下线"按钮弹出二次确认对话框，提示"确认将该设备下线？下线后该设备需重新登录"
    -   "下线所有其他设备"同样需要二次确认
    -   会话列表按登录时间倒序排列

### 5.6.7 页面与接口映射

+   认证管理页面与后端接口的映射关系如下表所示。

    | 页面编号       | 页面功能           | 调用接口                           |
    | -------------- | ------------------ | ---------------------------------- |
    | PG-P-AUTH-01   | 加载登录表单       | COMMON-01 获取图形验证码           |
    | PG-P-AUTH-01   | 刷新验证码         | COMMON-01 获取图形验证码           |
    | PG-P-AUTH-01   | 下一步（身份验证） | UP-AUTH-01 运营用户群登录（密码）  |
    | PG-P-AUTH-01   | 发送短信           | PUB-06 发送短信验证码              |
    | PG-P-AUTH-01   | 重新发送           | PUB-06 发送短信验证码              |
    | PG-P-AUTH-01   | 登录               | UP-AUTH-02 运营用户群登录验证短信  |
    | PG-UR-AUTH-01  | 密码登录           | UR-AUTH-01 租户用户群密码登录      |
    | PG-UR-AUTH-01  | 短信登录           | UR-AUTH-02 租户用户群短信登录      |
    | PG-UR-AUTH-01  | 获取图形验证码     | COMMON-01 获取图形验证码           |
    | PG-UR-AUTH-01  | 发送短信           | PUB-06 发送短信验证码              |
    | PG-UR-AUTH-01  | 企业微信登录       | UR-AUTH-05 企业身份源登录          |
    | PG-UR-AUTH-01  | 钉钉登录           | UR-AUTH-05 企业身份源登录          |
    | PG-UR-AUTH-01  | SSO登录            | UR-AUTH-04 租户用户群SSO登录       |
    | PG-UR-AUTH-02  | SSO令牌交换        | UR-AUTH-04 租户用户群SSO登录       |
    | PG-UC-AUTH-01  | 微信一键登录       | UC-AUTH-03 社交账号登录            |
    | PG-UC-AUTH-01  | 钉钉一键登录       | UC-AUTH-03 社交账号登录            |
    | PG-UC-AUTH-01  | QQ一键登录         | UC-AUTH-03 社交账号登录            |
    | PG-UC-AUTH-01  | 获取验证码         | PUB-06 发送短信验证码              |
    | PG-UC-AUTH-01  | 登录/注册          | UC-AUTH-01 C端用户群短信登录       |
    | PG-UC-AUTH-02  | 加载绑定列表       | UC-AUTH-07 查询社交绑定列表        |
    | PG-UC-AUTH-02  | 去绑定             | UC-AUTH-08 绑定社交账号            |
    | PG-UC-AUTH-02  | 解除绑定           | UC-AUTH-09 解绑社交账号            |
    | PG-PUB-AUTH-01 | 确认修改           | UP-AUTH-06/UR-AUTH-12/UC-AUTH-10   |
    | PG-PUB-AUTH-02 | 获取验证码         | PUB-06 发送短信验证码              |
    | PG-PUB-AUTH-02 | 下一步             | PUB-04 忘记密码                    |
    | PG-PUB-AUTH-02 | 确认重置           | PUB-05 重置密码                    |
    | PG-PUB-AUTH-03 | 加载会话列表       | UP-AUTH-05/UR-AUTH-10 查询会话列表 |
    | PG-PUB-AUTH-03 | 下线指定设备       | UR-AUTH-11 终止指定会话            |
    | PG-PUB-AUTH-03 | 下线所有其他设备   | UR-AUTH-11 终止指定会话            |

    表 5.6.7-1 页面与接口映射

### 5.6.8 功能操作汇总

+   认证管理所有页面的功能操作汇总如下表所示。

    | 功能编号           | 所属页面       | 功能类型 | 功能名称         | 关联API                          | 权限标识                     |
    | ------------------ | -------------- | -------- | ---------------- | -------------------------------- | ---------------------------- |
    | PG-P-AUTH-01.F01   | PG-P-AUTH-01   | 展示     | 加载登录表单     | COMMON-01                        | -                            |
    | PG-P-AUTH-01.F02   | PG-P-AUTH-01   | 操作     | 输入用户名       | -                                | -                            |
    | PG-P-AUTH-01.F03   | PG-P-AUTH-01   | 操作     | 输入密码         | -                                | -                            |
    | PG-P-AUTH-01.F04   | PG-P-AUTH-01   | 操作     | 刷新验证码       | COMMON-01                        | -                            |
    | PG-P-AUTH-01.F05   | PG-P-AUTH-01   | 操作     | 下一步           | UP-AUTH-01                       | -                            |
    | PG-P-AUTH-01.F06   | PG-P-AUTH-01   | 展示     | 显示短信验证面板 | -                                | -                            |
    | PG-P-AUTH-01.F07   | PG-P-AUTH-01   | 操作     | 发送短信         | PUB-06                           | -                            |
    | PG-P-AUTH-01.F08   | PG-P-AUTH-01   | 操作     | 重新发送         | PUB-06                           | -                            |
    | PG-P-AUTH-01.F09   | PG-P-AUTH-01   | 操作     | 登录             | UP-AUTH-02                       | -                            |
    | PG-UR-AUTH-01.F01  | PG-UR-AUTH-01  | 展示     | 加载登录页       | -                                | -                            |
    | PG-UR-AUTH-01.F02  | PG-UR-AUTH-01  | 操作     | 密码登录Tab      | -                                | -                            |
    | PG-UR-AUTH-01.F03  | PG-UR-AUTH-01  | 操作     | 验证码登录Tab    | -                                | -                            |
    | PG-UR-AUTH-01.F04  | PG-UR-AUTH-01  | 操作     | 密码登录         | UR-AUTH-01                       | -                            |
    | PG-UR-AUTH-01.F05  | PG-UR-AUTH-01  | 操作     | 短信登录         | UR-AUTH-02                       | -                            |
    | PG-UR-AUTH-01.F06  | PG-UR-AUTH-01  | 操作     | 获取图形验证码   | COMMON-01                        | -                            |
    | PG-UR-AUTH-01.F07  | PG-UR-AUTH-01  | 操作     | 发送短信         | PUB-06                           | -                            |
    | PG-UR-AUTH-01.F08  | PG-UR-AUTH-01  | 操作     | 记住登录         | -                                | -                            |
    | PG-UR-AUTH-01.F09  | PG-UR-AUTH-01  | 操作     | 忘记密码         | -                                | -                            |
    | PG-UR-AUTH-01.F10  | PG-UR-AUTH-01  | 操作     | 企业微信登录     | UR-AUTH-05                       | -                            |
    | PG-UR-AUTH-01.F11  | PG-UR-AUTH-01  | 操作     | 钉钉登录         | UR-AUTH-05                       | -                            |
    | PG-UR-AUTH-01.F12  | PG-UR-AUTH-01  | 操作     | SSO登录          | UR-AUTH-04                       | -                            |
    | PG-UR-AUTH-02.F01  | PG-UR-AUTH-02  | 展示     | 显示加载状态     | -                                | -                            |
    | PG-UR-AUTH-02.F02  | PG-UR-AUTH-02  | 操作     | SSO令牌交换      | UR-AUTH-04                       | -                            |
    | PG-UR-AUTH-02.F03  | PG-UR-AUTH-02  | 操作     | 登录成功跳转     | -                                | -                            |
    | PG-UR-AUTH-02.F04  | PG-UR-AUTH-02  | 展示     | 异常提示         | -                                | -                            |
    | PG-UC-AUTH-01.F01  | PG-UC-AUTH-01  | 展示     | 加载登录页       | -                                | -                            |
    | PG-UC-AUTH-01.F02  | PG-UC-AUTH-01  | 操作     | 微信一键登录     | UC-AUTH-03                       | -                            |
    | PG-UC-AUTH-01.F03  | PG-UC-AUTH-01  | 操作     | 钉钉一键登录     | UC-AUTH-03                       | -                            |
    | PG-UC-AUTH-01.F04  | PG-UC-AUTH-01  | 操作     | QQ一键登录       | UC-AUTH-03                       | -                            |
    | PG-UC-AUTH-01.F05  | PG-UC-AUTH-01  | 操作     | 获取验证码       | PUB-06                           | -                            |
    | PG-UC-AUTH-01.F06  | PG-UC-AUTH-01  | 操作     | 登录/注册        | UC-AUTH-01                       | -                            |
    | PG-UC-AUTH-01.F07  | PG-UC-AUTH-01  | 操作     | 用户协议         | -                                | -                            |
    | PG-UC-AUTH-02.F01  | PG-UC-AUTH-02  | 展示     | 加载绑定列表     | UC-AUTH-07                       | uc:iam:social:list           |
    | PG-UC-AUTH-02.F02  | PG-UC-AUTH-02  | 操作     | 去绑定           | UC-AUTH-08                       | uc:iam:social:create         |
    | PG-UC-AUTH-02.F03  | PG-UC-AUTH-02  | 操作     | 解除绑定         | UC-AUTH-09                       | uc:iam:social:delete         |
    | PG-PUB-AUTH-01.F01 | PG-PUB-AUTH-01 | 展示     | 加载修改密码表单 | -                                | {pool}:iam:credential:update |
    | PG-PUB-AUTH-01.F02 | PG-PUB-AUTH-01 | 操作     | 输入旧密码       | -                                | -                            |
    | PG-PUB-AUTH-01.F03 | PG-PUB-AUTH-01 | 操作     | 输入新密码       | -                                | -                            |
    | PG-PUB-AUTH-01.F04 | PG-PUB-AUTH-01 | 展示     | 密码强度提示     | -                                | -                            |
    | PG-PUB-AUTH-01.F05 | PG-PUB-AUTH-01 | 操作     | 确认新密码       | -                                | -                            |
    | PG-PUB-AUTH-01.F06 | PG-PUB-AUTH-01 | 展示     | 一致性校验提示   | -                                | -                            |
    | PG-PUB-AUTH-01.F07 | PG-PUB-AUTH-01 | 操作     | 确认修改         | UP-AUTH-06/UR-AUTH-12/UC-AUTH-10 | {pool}:iam:credential:update |
    | PG-PUB-AUTH-02.F01 | PG-PUB-AUTH-02 | 展示     | 加载步骤表单     | -                                | -                            |
    | PG-PUB-AUTH-02.F02 | PG-PUB-AUTH-02 | 操作     | 输入手机/邮箱    | -                                | -                            |
    | PG-PUB-AUTH-02.F03 | PG-PUB-AUTH-02 | 操作     | 获取验证码       | PUB-06                           | -                            |
    | PG-PUB-AUTH-02.F04 | PG-PUB-AUTH-02 | 操作     | 下一步           | PUB-04                           | -                            |
    | PG-PUB-AUTH-02.F05 | PG-PUB-AUTH-02 | 操作     | 设置新密码       | -                                | -                            |
    | PG-PUB-AUTH-02.F06 | PG-PUB-AUTH-02 | 展示     | 密码强度提示     | -                                | -                            |
    | PG-PUB-AUTH-02.F07 | PG-PUB-AUTH-02 | 操作     | 确认重置         | PUB-05                           | -                            |
    | PG-PUB-AUTH-02.F08 | PG-PUB-AUTH-02 | 展示     | 重置成功提示     | -                                | -                            |
    | PG-PUB-AUTH-02.F09 | PG-PUB-AUTH-02 | 操作     | 返回登录         | -                                | -                            |
    | PG-PUB-AUTH-03.F01 | PG-PUB-AUTH-03 | 展示     | 加载会话列表     | UP-AUTH-05/UR-AUTH-10            | {pool}:iam:session:list      |
    | PG-PUB-AUTH-03.F02 | PG-PUB-AUTH-03 | 展示     | 标记当前设备     | -                                | -                            |
    | PG-PUB-AUTH-03.F03 | PG-PUB-AUTH-03 | 操作     | 下线指定设备     | UR-AUTH-11                       | {pool}:iam:session:delete    |
    | PG-PUB-AUTH-03.F04 | PG-PUB-AUTH-03 | 操作     | 下线所有其他设备 | UR-AUTH-11                       | {pool}:iam:session:delete    |

    表 5.6.8-1 功能操作汇总

## 5.7 权限设计

+   本节设计认证管理相关的权限控制。
+   认证接口大部分为公开接口（登录前调用），仅少数接口需要认证。
+   权限标识采用四段式格式：`{用户侧}:{限界上下文}:{资源}:{操作}`

### 5.7.1 接口认证要求

+   认证管理接口的认证要求如下表所示。

    | 接口分类     | 认证要求          | 说明               |
    | ------------ | ----------------- | ------------------ |
    | 登录接口     | 无需认证          | 登录前调用         |
    | 登出接口     | 需要Access Token  | 已登录用户调用     |
    | 刷新令牌     | 需要Refresh Token | 不需要Access Token |
    | 修改密码     | 需要Access Token  | 已登录用户调用     |
    | 会话管理     | 需要Access Token  | 已登录用户调用     |
    | 社交绑定管理 | 需要Access Token  | 已登录用户调用     |
    | 验证码发送   | 无需认证          | 登录/注册前调用    |
    | 图形验证码   | 无需认证          | 公开接口           |

    表 5.7.1-1 接口认证要求

### 5.7.2 权限标识定义

+   认证管理权限标识采用四段式格式：`{用户侧}:{限界上下文}:{资源}:{操作}`

#### 5.7.2.1 运营用户群（UP）权限标识

+   运营用户群认证管理权限标识如下表所示。

    | 权限标识                  | 权限名称 | 权限类型 | 说明               |
    | ------------------------- | -------- | -------- | ------------------ |
    | up:auth:credential:update | 修改密码 | 功能权限 | 修改自己的密码     |
    | up:auth:session:read      | 查看会话 | 功能权限 | 查看自己的登录会话 |
    | up:auth:session:delete    | 终止会话 | 功能权限 | 终止自己的其他会话 |

    表 5.7.2.1-1 运营用户群认证权限标识

#### 5.7.2.2 租户用户群（UR）权限标识

+   租户用户群认证管理权限标识如下表所示。

    | 权限标识                  | 权限名称 | 权限类型 | 说明               |
    | ------------------------- | -------- | -------- | ------------------ |
    | ur:auth:credential:update | 修改密码 | 功能权限 | 修改自己的密码     |
    | ur:auth:session:read      | 查看会话 | 功能权限 | 查看自己的登录会话 |
    | ur:auth:session:delete    | 终止会话 | 功能权限 | 终止自己的其他会话 |

    表 5.7.2.2-1 租户用户群用户认证权限标识

+   租户用户群管理员认证管理权限标识如下表所示。

    | 权限标识                   | 权限名称       | 权限类型 | 说明                     |
    | -------------------------- | -------------- | -------- | ------------------------ |
    | ur:auth:config:read        | 查看认证配置   | 功能权限 | 查看租户认证策略配置     |
    | ur:auth:config:update      | 修改认证配置   | 功能权限 | 修改密码策略、登录策略等 |
    | ur:auth:sso:read           | 查看SSO配置    | 功能权限 | 查看SSO单点登录配置      |
    | ur:auth:sso:update         | 修改SSO配置    | 功能权限 | 配置SSO单点登录          |
    | ur:auth:idp:read           | 查看身份源配置 | 功能权限 | 查看企业身份源配置       |
    | ur:auth:idp:update         | 修改身份源配置 | 功能权限 | 配置企业微信/钉钉等      |
    | ur:auth:login-log:read     | 查看登录日志   | 功能权限 | 查看租户用户登录日志     |
    | ur:iam:user:reset-password | 重置用户密码   | 功能权限 | 为用户重置密码           |
    | ur:iam:user:force-logout   | 强制下线       | 功能权限 | 强制用户登出所有设备     |
    | ur:iam:user:unlock         | 解除锁定       | 功能权限 | 解除用户的登录锁定       |

    表 5.7.2.2-2 租户用户群管理员认证权限标识

#### 5.7.2.3 C端用户群（UC）权限标识

+   C端用户群认证管理权限标识如下表所示。

    | 权限标识                  | 权限名称     | 权限类型 | 说明                 |
    | ------------------------- | ------------ | -------- | -------------------- |
    | uc:auth:credential:update | 修改密码     | 功能权限 | 修改自己的密码       |
    | uc:auth:social:read       | 查看社交绑定 | 功能权限 | 查看已绑定的社交账号 |
    | uc:auth:social:create     | 绑定社交账号 | 功能权限 | 绑定新的社交账号     |
    | uc:auth:social:delete     | 解绑社交账号 | 功能权限 | 解绑已有的社交账号   |

    表 5.7.2.3-1 C端用户群认证权限标识

### 5.7.3 页面权限

+   认证管理相关页面的权限配置如下表所示。

    | 页面编号     | 页面名称     | 页面权限标识                  | 适用用户群 |
    | ------------ | ------------ | ----------------------------- | ---------- |
    | P-AUTH-XX-01 | 修改密码     | {side}:auth:credential:update | UP/UR/UC   |
    | P-AUTH-XX-03 | 会话管理     | {side}:auth:session:read      | UP/UR      |
    | P-AUTH-UC-02 | 社交绑定管理 | uc:auth:social:read           | UC         |
    | P-AUTH-UR-03 | 认证配置管理 | ur:auth:config:read           | UR管理员   |
    | P-AUTH-UR-04 | SSO配置      | ur:auth:sso:read              | UR管理员   |
    | P-AUTH-UR-05 | 身份源配置   | ur:auth:idp:read              | UR管理员   |
    | P-AUTH-UR-06 | 登录日志     | ur:auth:login-log:read        | UR管理员   |

    表 5.7.3-1 认证管理页面权限

### 5.7.4 预置角色权限分配

+   认证管理相关权限在预置角色中的分配如下表所示。

    | 角色           | 分配的认证权限                                                                                   |
    | -------------- | ------------------------------------------------------------------------------------------------ |
    | 租户超级管理员 | ur:auth:*（全部认证权限）                                                                        |
    | 租户管理员     | ur:auth:login-log:read, ur:iam:user:reset-password, ur:iam:user:force-logout, ur:iam:user:unlock |
    | 普通租户用户   | ur:auth:credential:update, ur:auth:session:read, ur:auth:session:delete                          |
    | 个人用户       | uc:auth:credential:update, uc:auth:social:*                                                      |

    表 5.7.4-1 预置角色认证权限分配

### 5.7.5 API权限映射

+   认证管理API与权限的映射关系如下表所示。

    | 接口编号   | API路径                           | 所需权限                   |
    | ---------- | --------------------------------- | -------------------------- |
    | UP-AUTH-03 | POST /up/auth/logout              | 已登录即可（无需额外权限） |
    | UP-AUTH-05 | GET /up/auth/sessions             | up:auth:session:read       |
    | UP-AUTH-06 | POST /up/auth/password/change     | up:auth:credential:update  |
    | UR-AUTH-08 | POST /ur/auth/logout              | 已登录即可                 |
    | UR-AUTH-10 | GET /ur/auth/sessions             | ur:auth:session:read       |
    | UR-AUTH-11 | DELETE /ur/auth/sessions/{id}     | ur:auth:session:delete     |
    | UR-AUTH-12 | POST /ur/auth/password/change     | ur:auth:credential:update  |
    | UC-AUTH-05 | POST /uc/auth/logout              | 已登录即可                 |
    | UC-AUTH-07 | GET /uc/auth/social/bindList      | uc:auth:social:read        |
    | UC-AUTH-08 | POST /uc/auth/social/bind         | uc:auth:social:create      |
    | UC-AUTH-09 | DELETE /uc/auth/social/{provider} | uc:auth:social:delete      |
    | UC-AUTH-10 | POST /uc/auth/password/change     | uc:auth:credential:update  |

    表 5.7.5-1 API权限映射

## 5.8 后端工程结构设计

+   本节定义认证管理相关的后端代码工程结构。
+   认证管理代码位于独立的认证服务（us-auth）中。

### 5.8.1 模块结构

+   认证管理后端模块结构如下。

    ```
    us-auth/
    ├── us-auth-api/                           # API模块
    │   └── src/main/java/.../api/
    │       └── auth/
    │           ├── dto/                       # 数据传输对象
    │           │   ├── request/
    │           │   │   ├── PasswordLoginRequest.java
    │           │   │   ├── SmsLoginRequest.java
    │           │   │   ├── SocialLoginRequest.java
    │           │   │   ├── RefreshTokenRequest.java
    │           │   │   ├── SendSmsCodeRequest.java
    │           │   │   └── ChangePasswordRequest.java
    │           │   └── response/
    │           │       ├── LoginResponse.java
    │           │       ├── TokenResponse.java
    │           │       ├── SessionResponse.java
    │           │       └── SocialBindingResponse.java
    │           ├── enums/
    │           │   ├── UserPool.java
    │           │   ├── LoginMethod.java
    │           │   ├── DeviceType.java
    │           │   └── SocialProvider.java
    │           └── client/
    │               └── AuthClient.java        # Feign客户端
    │
    ├── us-auth-service/                       # 服务模块
    │   └── src/main/java/.../service/
    │       └── auth/
    │           ├── controller/                # 控制器（按用户群分）
    │           │   ├── up/
    │           │   │   └── UpAuthController.java
    │           │   ├── ur/
    │           │   │   └── UrAuthController.java
    │           │   ├── uc/
    │           │   │   └── UcAuthController.java
    │           │   └── common/
    │           │       ├── CaptchaController.java
    │           │       ├── SmsController.java
    │           │       └── ScanController.java
    │           ├── service/                   # 应用服务
    │           │   ├── AuthAppService.java
    │           │   ├── TokenAppService.java
    │           │   ├── SessionAppService.java
    │           │   ├── SocialAuthAppService.java
    │           │   └── VerificationCodeAppService.java
    │           ├── domain/                    # 领域层
    │           │   ├── model/
    │           │   │   ├── Credential.java
    │           │   │   ├── LoginAttempt.java
    │           │   │   ├── LoginLockout.java
    │           │   │   ├── RefreshToken.java
    │           │   │   ├── Session.java
    │           │   │   ├── SocialConnection.java
    │           │   │   └── VerificationCode.java
    │           │   ├── service/
    │           │   │   ├── AuthenticationService.java
    │           │   │   ├── TokenService.java
    │           │   │   ├── SessionService.java
    │           │   │   ├── PasswordService.java
    │           │   │   └── VerificationCodeService.java
    │           │   ├── repository/
    │           │   │   ├── CredentialRepository.java
    │           │   │   ├── LoginAttemptRepository.java
    │           │   │   ├── SocialConnectionRepository.java
    │           │   │   ├── TokenRepository.java
    │           │   │   └── SessionRepository.java
    │           │   └── event/
    │           │       ├── LoginSucceededEvent.java
    │           │       ├── LoginFailedEvent.java
    │           │       ├── LogoutSucceededEvent.java
    │           │       ├── PasswordChangedEvent.java
    │           │       └── SessionKickedEvent.java
    │           ├── infrastructure/            # 基础设施层
    │           │   ├── persistence/
    │           │   │   ├── entity/
    │           │   │   │   ├── UpCredentialEntity.java
    │           │   │   │   ├── UrCredentialEntity.java
    │           │   │   │   ├── UcCredentialEntity.java
    │           │   │   │   ├── UcSocialConnectionEntity.java
    │           │   │   │   └── AuthLoginAttemptEntity.java
    │           │   │   ├── mapper/
    │           │   │   │   ├── UpCredentialMapper.java
    │           │   │   │   ├── UrCredentialMapper.java
    │           │   │   │   ├── UcCredentialMapper.java
    │           │   │   │   ├── UcSocialConnectionMapper.java
    │           │   │   │   └── AuthLoginAttemptMapper.java
    │           │   │   └── repository/
    │           │   │       ├── CredentialRepositoryImpl.java
    │           │   │       ├── LoginAttemptRepositoryImpl.java
    │           │   │       └── SocialConnectionRepositoryImpl.java
    │           │   ├── redis/
    │           │   │   ├── TokenRedisRepository.java
    │           │   │   ├── SessionRedisRepository.java
    │           │   │   ├── LockoutRedisRepository.java
    │           │   │   ├── VerificationCodeRedisRepository.java
    │           │   │   └── ScanCodeRedisRepository.java
    │           │   ├── social/                # 社交登录适配器
    │           │   │   ├── SocialAuthAdapter.java
    │           │   │   ├── WechatAuthAdapter.java
    │           │   │   ├── DingtalkAuthAdapter.java
    │           │   │   └── QQAuthAdapter.java
    │           │   ├── sso/                   # SSO协议适配器
    │           │   │   ├── SsoAdapter.java
    │           │   │   ├── OidcSsoAdapter.java
    │           │   │   ├── SamlSsoAdapter.java
    │           │   │   └── CasSsoAdapter.java
    │           │   ├── enterprise/            # 企业身份源适配器
    │           │   │   ├── EnterpriseIdpAdapter.java
    │           │   │   ├── WechatWorkAdapter.java
    │           │   │   ├── DingtalkCorpAdapter.java
    │           │   │   └── FeishuAdapter.java
    │           │   └── security/
    │           │       ├── JwtTokenProvider.java
    │           │       ├── PasswordEncoder.java
    │           │       └── RsaKeyProvider.java
    │           └── assembler/
    │               ├── CredentialAssembler.java
    │               ├── SessionAssembler.java
    │               └── SocialConnectionAssembler.java
    │
    └── src/main/resources/
        ├── mapper/auth/
        │   ├── UpCredentialMapper.xml
        │   ├── UrCredentialMapper.xml
        │   ├── UcCredentialMapper.xml
        │   ├── UcSocialConnectionMapper.xml
        │   └── AuthLoginAttemptMapper.xml
        └── application.yml
    ```

    图 5.8.1-1 认证管理后端模块结构

### 5.8.2 包依赖关系

+   认证管理各层之间的依赖关系如下。

    ```graph
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          后端分层依赖关系                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                      controller 控制器层                        │      │
    │    │  UpAuthController, UrAuthController, UcAuthController, ...      │      │
    │    └───────────────────────────────┬─────────────────────────────────┘      │
    │                                    │ 调用                                   │
    │                                    ▼                                        │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                      service 应用服务层                         │      │
    │    │  AuthAppService, TokenAppService, SessionAppService, ...        │      │
    │    └───────────────────────────────┬─────────────────────────────────┘      │
    │                                    │ 调用                                   │
    │                                    ▼                                        │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                       domain 领域层                             │      │
    │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │      │
    │    │  │   model     │  │  service    │  │ repository  │              │      │
    │    │  │ 领域模型    │  │ 领域服务    │  │ 仓储接口    │              │      │
    │    │  └─────────────┘  └─────────────┘  └──────┬──────┘              │      │
    │    └───────────────────────────────────────────┼─────────────────────┘      │
    │                                                │ 实现                       │
    │                                                ▼                            │
    │    ┌─────────────────────────────────────────────────────────────────┐      │
    │    │                   infrastructure 基础设施层                     │      │
    │    │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │      │
    │    │  │ persistence  │ │    redis     │ │   social     │             │      │
    │    │  │ 数据库持久化 │ │ Redis存储    │ │ 社交登录适配 │             │      │
    │    │  └──────────────┘ └──────────────┘ └──────────────┘             │      │
    │    │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │      │
    │    │  │     sso      │ │  enterprise  │ │   security   │             │      │
    │    │  │ SSO协议适配  │ │ 企业身份源   │ │ JWT/加密     │             │      │
    │    │  └──────────────┘ └──────────────┘ └──────────────┘             │      │
    │    └─────────────────────────────────────────────────────────────────┘      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 5.8.2-1 后端分层依赖关系

### 5.8.3 关键类说明

+   认证管理关键类说明如下表所示。

    | 类名                   | 层级       | 职责                       |
    | ---------------------- | ---------- | -------------------------- |
    | UpAuthController       | 控制器层   | 处理运营用户群认证HTTP请求 |
    | UrAuthController       | 控制器层   | 处理租户用户群认证HTTP请求 |
    | UcAuthController       | 控制器层   | 处理C端用户群认证HTTP请求  |
    | AuthAppService         | 应用服务层 | 编排认证业务流程           |
    | TokenAppService        | 应用服务层 | 编排令牌管理流程           |
    | AuthenticationService  | 领域服务   | 各类认证方式的身份验证     |
    | TokenService           | 领域服务   | 令牌签发、验证、撤销       |
    | SessionService         | 领域服务   | 会话创建、管理、销毁       |
    | PasswordService        | 领域服务   | 密码哈希、验证、策略检查   |
    | JwtTokenProvider       | 基础设施层 | JWT令牌生成与验证          |
    | WechatAuthAdapter      | 基础设施层 | 微信OAuth认证适配          |
    | OidcSsoAdapter         | 基础设施层 | OpenID Connect SSO适配     |
    | TokenRedisRepository   | 基础设施层 | RefreshToken Redis存储     |
    | SessionRedisRepository | 基础设施层 | 会话Redis存储              |

    表 5.8.3-1 关键类说明

## 5.9 前端工程结构设计

+   本节定义认证管理相关的前端代码工程结构。
+   认证相关代码分布在三侧前端项目中，但共享部分通用组件。

### 5.9.1 目录结构

+   认证管理前端目录结构如下（以租户用户群为例）。

    ```
    src/
    ├── views/
    │   └── auth/                              # 认证相关页面
    │       ├── login/
    │       │   ├── index.vue                  # 登录页面主入口
    │       │   ├── PasswordLogin.vue          # 密码登录组件
    │       │   ├── SmsLogin.vue               # 短信登录组件
    │       │   └── SocialLogin.vue            # 社交登录组件（UC）
    │       ├── sso/
    │       │   └── callback.vue               # SSO回调页面
    │       ├── forgot-password/
    │       │   └── index.vue                  # 忘记密码页面
    │       └── components/
    │           ├── CaptchaInput.vue           # 图形验证码组件
    │           ├── SmsCodeInput.vue           # 短信验证码组件
    │           ├── PasswordInput.vue          # 密码输入组件
    │           └── LoginMethodTabs.vue        # 登录方式切换组件
    │
    ├── views/
    │   └── settings/
    │       ├── password/
    │       │   └── index.vue                  # 修改密码页面
    │       ├── sessions/
    │       │   └── index.vue                  # 会话管理页面
    │       └── bindList/                    # 社交绑定页面（UC）
    │           └── index.vue
    │
    ├── api/
    │   └── auth/
    │       ├── login.ts                       # 登录相关接口
    │       ├── token.ts                       # 令牌相关接口
    │       ├── password.ts                    # 密码相关接口
    │       ├── session.ts                     # 会话相关接口
    │       ├── social.ts                      # 社交绑定接口（UC）
    │       └── captcha.ts                     # 验证码接口
    │
    ├── stores/
    │   └── auth/
    │       ├── user.ts                        # 用户状态管理
    │       ├── token.ts                       # 令牌状态管理
    │       └── session.ts                     # 会话状态管理
    │
    ├── types/
    │   └── auth/
    │       ├── login.ts                       # 登录类型定义
    │       ├── token.ts                       # 令牌类型定义
    │       ├── session.ts                     # 会话类型定义
    │       └── social.ts                      # 社交绑定类型定义
    │
    ├── utils/
    │   └── auth/
    │       ├── token.ts                       # 令牌存储工具
    │       ├── crypto.ts                      # 加密工具（RSA）
    │       └── device.ts                      # 设备指纹工具
    │
    └── router/
        └── modules/
            └── auth.ts                        # 认证相关路由
    ```

    图 5.9.1-1 认证管理前端目录结构

### 5.9.2 路由配置

+   认证管理路由配置如下。

    ```typescript
    // src/router/modules/auth.ts
    export default [
      {
        path: '/login',
        name: 'Login',
        component: () => import('@/views/auth/login/index.vue'),
        meta: { title: '登录', requiresAuth: false }
      },
      {
        path: '/sso/callback',
        name: 'SsoCallback',
        component: () => import('@/views/auth/sso/callback.vue'),
        meta: { title: 'SSO登录', requiresAuth: false }
      },
      {
        path: '/forgot-password',
        name: 'ForgotPassword',
        component: () => import('@/views/auth/forgot-password/index.vue'),
        meta: { title: '忘记密码', requiresAuth: false }
      },
      {
        path: '/settings/password',
        name: 'ChangePassword',
        component: () => import('@/views/settings/password/index.vue'),
        meta: { title: '修改密码', requiresAuth: true }
      },
      {
        path: '/settings/sessions',
        name: 'SessionManagement',
        component: () => import('@/views/settings/sessions/index.vue'),
        meta: { title: '登录设备管理', requiresAuth: true }
      }
    ]
    ```

    图 5.9.2-1 认证管理路由配置

### 5.9.3 API接口封装

+   认证管理API接口封装示例如下。

    ```typescript
    // src/api/auth/login.ts
    import request from '@/utils/request'
    import type {
      PasswordLoginRequest,
      SmsLoginRequest,
      LoginResponse
    } from '@/types/auth/login'

    // 密码登录
    export function loginByPassword(data: PasswordLoginRequest): Promise<LoginResponse> {
      return request.post('/api/v1/ur/auth/login/password', data)
    }

    // 短信验证码登录
    export function loginBySms(data: SmsLoginRequest): Promise<LoginResponse> {
      return request.post('/api/v1/ur/auth/login/sms', data)
    }

    // 登出
    export function logout(allDevices?: boolean): Promise<void> {
      return request.post('/api/v1/ur/auth/logout', { allDevices })
    }

    // 刷新令牌
    export function refreshToken(refreshToken: string): Promise<LoginResponse> {
      return request.post('/api/v1/ur/auth/token/refresh', { refreshToken })
    }
    ```

    图 5.9.3-1 登录API封装示例

    ```typescript
    // src/api/auth/captcha.ts
    import request from '@/utils/request'

    // 获取图形验证码
    export function getCaptcha(): Promise<{
      captchaId: string
      imageBase64: string
      expireIn: number
    }> {
      return request.post('/api/v1/auth/captcha')
    }

    // 发送短信验证码
    export function sendSmsCode(data: {
      mobile: string
      scene: string
      userPool: string
      tenantId?: number
      captchaId?: string
      captchaCode?: string
    }): Promise<{
      success: boolean
      expireIn: number
      interval: number
    }> {
      return request.post('/api/v1/auth/sms/send', data)
    }
    ```

    图 5.9.3-2 验证码API封装示例

### 5.9.4 状态管理

+   认证状态管理示例如下。

    ```typescript
    // src/stores/auth/user.ts
    import { defineStore } from 'pinia'
    import { loginByPassword, logout } from '@/api/auth/login'
    import { getToken, setToken, removeToken } from '@/utils/auth/token'

    export const useUserStore = defineStore('user', {
      state: () => ({
        accessToken: getToken('access') || '',
        refreshToken: getToken('refresh') || '',
        userInfo: null as UserInfo | null,
        tenantInfo: null as TenantInfo | null
      }),

      getters: {
        isLoggedIn: (state) => !!state.accessToken,
        userId: (state) => state.userInfo?.id
      },

      actions: {
        async login(loginData: PasswordLoginRequest) {
          const res = await loginByPassword(loginData)
          this.accessToken = res.accessToken
          this.refreshToken = res.refreshToken
          this.userInfo = res.user
          this.tenantInfo = res.tenant
          setToken('access', res.accessToken)
          setToken('refresh', res.refreshToken)
          return res
        },

        async logout() {
          await logout()
          this.accessToken = ''
          this.refreshToken = ''
          this.userInfo = null
          this.tenantInfo = null
          removeToken('access')
          removeToken('refresh')
        },

        async refreshAccessToken() {
          const res = await refreshToken(this.refreshToken)
          this.accessToken = res.accessToken
          setToken('access', res.accessToken)
          if (res.refreshToken) {
            this.refreshToken = res.refreshToken
            setToken('refresh', res.refreshToken)
          }
        }
      }
    })
    ```

    图 5.9.4-1 用户状态管理示例

### 5.9.5 组件说明

+   认证管理关键组件说明如下表所示。

    | 组件名              | 路径                     | 功能说明                    |
    | ------------------- | ------------------------ | --------------------------- |
    | PasswordLogin.vue   | views/auth/login/        | 密码登录表单                |
    | SmsLogin.vue        | views/auth/login/        | 短信验证码登录表单          |
    | SocialLogin.vue     | views/auth/login/        | 社交登录按钮组（UC）        |
    | CaptchaInput.vue    | views/auth/components/   | 图形验证码输入组件          |
    | SmsCodeInput.vue    | views/auth/components/   | 短信验证码输入+发送组件     |
    | PasswordInput.vue   | views/auth/components/   | 密码输入组件（可显示/隐藏） |
    | LoginMethodTabs.vue | views/auth/components/   | 登录方式Tab切换组件         |
    | SessionList.vue     | views/settings/sessions/ | 登录会话列表组件            |
    | SocialBindList.vue  | views/settings/bindList/ | 社交绑定列表组件（UC）      |

    表 5.9.5-1 认证管理关键组件

# 6 权限管理

+   本章详细设计权限管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   权限管理负责"控制能做什么"，解决授权（Authorization）问题，与第5章认证管理（Authentication）配合形成完整的IAM体系。
+   权限管理需要针对不同用户群（运营用户群、租户用户群、C端用户群）提供差异化的权限控制方案。

## 6.0 权限与认证的关系

+   权限管理与认证管理是IAM体系的两大核心组件，职责不同但紧密协作。

+   认证与授权的关系如下表所示：

    | 维度     | 认证（Authentication）    | 授权（Authorization） |
    | -------- | ------------------------- | --------------------- |
    | 核心问题 | 你是谁？                  | 你能做什么？          |
    | 解决目标 | 验证身份真伪              | 控制资源访问          |
    | 输入     | 凭证（密码/验证码/Token） | 身份信息 + 目标资源   |
    | 输出     | 身份令牌（JWT Token）     | 允许/拒绝访问         |
    | 执行时机 | 登录时                    | 每次资源访问时        |
    | 详细设计 | 第5章                     | 本章                  |

    表 6.0-1 认证与授权的关系

+   协作流程说明：
    -   **认证管理**验证用户身份后签发Token，Token中仅包含用户ID、用户类型、租户编码等基础信息
    -   **权限管理**基于Token中的用户信息，查询用户角色和权限，判断是否允许访问目标资源
    -   Token中**不包含**角色和权限列表，避免Token过大和权限变更不及时的问题

## 6.1 权限业务场景

+   本节分析权限管理的业务场景，围绕权限模型、三侧用户权限差异、功能权限和数据权限展开设计。
+   业务场景是后续流程设计和领域模型设计的前提和依据。

### 6.1.1 权限模型概述

+   透管云采用 RBAC + ABAC 组合模型，分别解决功能权限和数据权限问题。

#### 6.1.1.1 RBAC模型（功能权限）

+   RBAC（Role-Based Access Control）即基于角色的访问控制。
+   核心链路为：用户 → 角色 → 权限。
+   RBAC模型结构如下图所示：

    ```
    ┌──────────┐         ┌──────────┐         ┌──────────┐
    │          │   N:N   │          │   N:N   │          │
    │   用户   │────────→│   角色   │────────→│   权限   │
    │          │         │          │         │          │
    └──────────┘         └──────────┘         └──────────┘
         │                    │                    │
         │                    │                    │
         ▼                    ▼                    ▼
    ┌──────────┐         ┌──────────┐         ┌──────────┐
    │ 张三     │         │ UP-01    │         │ mandate  │
    │ 李四     │         │ UP-05    │         │ :create  │
    │ 王五     │         │ UR-CISO  │         │ :delete  │
    └──────────┘         └──────────┘         └──────────┘
    ```

    图 6.1.1.1-1 RBAC模型结构

+   判断逻辑如下：
    -   查询用户拥有哪些角色
    -   查询这些角色拥有哪些权限
    -   判断目标权限是否在权限列表中

+   RBAC模型特点：
    -   静态分配：用户与角色的关系预先配置，不随请求动态变化
    -   简单易管理：通过角色批量管理权限，降低管理复杂度
    -   透管云使用RBAC实现**功能权限**控制

#### 6.1.1.2 ABAC模型（数据权限）

+   ABAC（Attribute-Based Access Control）即基于属性的访问控制。
+   根据多种属性动态计算权限，属性类型如下表所示：

    | 属性类型 | 示例                       |
    | -------- | -------------------------- |
    | 用户属性 | 部门、职级、入职时间       |
    | 资源属性 | 创建人、所属部门、数据密级 |
    | 环境属性 | 当前时间、请求IP、设备类型 |

    表 6.1.1.2-1 ABAC属性类型

+   ABAC判断逻辑示例：
    -   用户.部门 == 数据.部门？
    -   用户.职级 >= 3？
    -   当前时间在工作时间内？
    -   全部满足则有权限，否则无权限

+   ABAC模型特点：
    -   动态计算：权限随属性变化实时变化
    -   灵活但复杂：可实现精细化控制，但规则维护成本高
    -   透管云使用ABAC实现**数据权限**控制

#### 6.1.1.3 透管云权限模型（RBAC + ABAC组合）

+   透管云采用RBAC + ABAC组合模型，各司其职：

    | 权限类型 | 采用模型 | 控制内容         | 实现方式          |
    | -------- | -------- | ---------------- | ----------------- |
    | 功能权限 | RBAC     | 能否调用某个接口 | @PreAuthorize注解 |
    | 数据权限 | ABAC     | 能看到哪些数据   | SQL WHERE条件注入 |

    表 6.1.1.3-1 透管云权限模型

+   组合模型的优势：
    -   功能权限使用RBAC，简单直观，易于管理
    -   数据权限使用ABAC，灵活精细，适应复杂场景
    -   两者独立判断，互不干扰

#### 6.1.1.4 功能权限与数据权限对比

+   功能权限控制"能不能做"，数据权限控制"能做多少"。
+   两种权限的对比如下表所示：

    | 维度     | 功能权限               | 数据权限                 |
    | -------- | ---------------------- | ------------------------ |
    | 控制对象 | API接口                | 数据记录/字段            |
    | 控制点   | Controller层           | Service/DAO层            |
    | 实现方式 | 权限注解拦截           | 查询条件注入             |
    | 判断依据 | 用户角色拥有的权限列表 | 用户属性与数据属性的匹配 |
    | 示例     | 有无mandate:create权限 | 只能看本部门的数据       |
    | 失败响应 | HTTP 403 Forbidden     | 返回空数据或过滤后数据   |

    表 6.1.1.4-1 功能权限与数据权限对比

+   核心原则：**前端权限是体验优化，后端权限是安全保障**
    -   前端菜单、路由、按钮的权限控制是为了提升用户体验，避免用户看到无权操作的功能
    -   后端API权限校验是最后一道防线，必须严格执行，不能依赖前端

### 6.1.2 三侧用户权限差异

+   透管云存在三类用户群体，各自的权限控制策略存在本质差异。

#### 6.1.2.1 用户群与权限概览

+   三侧用户的权限特征总览如下表所示：

    | 维度           | 运营用户群（UP）      | 租户用户群（UR）           | C端用户群（UC）           |
    | -------------- | --------------------- | -------------------------- | ------------------------- |
    | 用户类型       | 平台运营人员          | 企业租户员工               | C端个人用户               |
    | 角色来源       | 系统预置 + 平台自定义 | 系统预置 + 租户自定义      | 系统预置（仅2个）         |
    | 预置角色数量   | UP-01 ~ UP-08         | UR-01 ~ UR-09              | UC-01 ~ UC-02             |
    | 数据权限模式   | 数据密级隔离          | 部门层级隔离（data_scope） | 用户个人隔离              |
    | 数据库位置     | clarisphere_platform  | clarisphere_t{tenant_id}   | clarisphere_consumer      |
    | 可访问数据边界 | 知识中台 + 平台配置   | 本租户业务数据             | 知识中台(只读) + 个人数据 |

    表 6.1.2.1-1 三侧用户权限特征总览

#### 6.1.2.2 运营用户群（UP）权限场景

+   运营用户群用户是平台运营方的内部用户，负责知识中台内容生产和平台运营。

+   **数据访问边界**：
    -   **可访问**：知识中台数据（6库3图1包）、平台运营元数据（租户配置、订阅状态）
    -   **禁止访问**：租户业务数据（评估、整改、证据等）、UC个人数据（收藏、学习记录等）

+   **核心安全原则**：
    -   运营用户群用户**永久禁止**访问任何租户业务数据和UC个人数据
    -   问题排查通过**模拟环境**进行，模拟环境使用脱敏/虚构数据，与生产数据物理隔离
    -   不存在"超级管理员"角色，不提供任何绕过数据隔离的机制

+   运营用户群预置角色如下表所示：

    | 角色编码 | 角色名称       | 核心职责                 | data_scope |
    | -------- | -------------- | ------------------------ | ---------- |
    | UP-01    | 内容采集员     | 外规采集、变更监测       | -          |
    | UP-02    | 内容审核员     | 内容审核、质量把控       | -          |
    | UP-03    | 知识工程师     | 控制点、场景点、映射管理 | -          |
    | UP-04    | 质检发布员     | 质量检查、合规包发布     | -          |
    | UP-05    | 知识中台管理员 | 知识中台全量管理         | -          |
    | UP-06    | 租户运营员     | 租户管理、订阅管理       | -          |
    | UP-07    | 运营数据分析师 | 监控大屏、业务指标       | -          |
    | UP-08    | 平台运营管理员 | 平台全量运营管理         | -          |

    表 6.1.2.2-1 运营用户群预置角色

+   **说明**：运营用户群角色不使用data_scope字段，因为其数据权限通过数据密级控制，而非部门层级。

#### 6.1.2.3 租户用户群（UR）权限场景

+   租户用户群用户是企业客户的员工，在租户独立库中管理，数据完全隔离。

+   **数据访问边界**：
    -   **可访问**：本租户业务数据（按data_scope过滤）、订阅的知识中台数据（只读）
    -   **禁止访问**：其他租户数据、运营用户群运营数据、UC个人数据

+   **数据权限计算逻辑**：
    -   **角色**定义「看多大范围」：通过data_scope字段指定范围类型（1-5）
    -   **用户**决定「从哪个点开始算」：根据用户所属部门（dept_id）计算
    -   同一角色分配给不同部门的人，各自看各自部门的数据

+   租户用户群预置角色如下表所示：

    | 角色编码 | 角色名称   | 核心职责                   | data_scope  |
    | -------- | ---------- | -------------------------- | ----------- |
    | UR-01    | CISO       | 信息安全最高负责人         | 1（全部）   |
    | UR-02    | 合规经理   | 合规体系建设与管理         | 1（全部）   |
    | UR-03    | 风险管理员 | 风险识别与处置             | 1（全部）   |
    | UR-04    | 安全审计员 | 安全审计与检查             | 1（全部）   |
    | UR-05    | 制度管理员 | 制度文档管理               | 3（本部门） |
    | UR-06    | 资产管理员 | 资产台账管理               | 3（本部门） |
    | UR-07    | 控制执行人 | 控制措施执行与证据提交     | 4（仅本人） |
    | UR-08    | 整改责任人 | 整改任务执行               | 4（仅本人） |
    | UR-09    | 租户管理员 | 租户系统管理、用户角色管理 | 1（全部）   |

    表 6.1.2.3-1 租户用户群预置角色

+   **数据权限范围类型说明**：

    | data_scope | 含义         | 适用场景                           | 实现方式                      |
    | ---------- | ------------ | ---------------------------------- | ----------------------------- |
    | 1          | 全部数据     | CISO、合规经理等需要全局视角的角色 | 不添加部门过滤条件            |
    | 2          | 本部门及以下 | 部门经理、需要管理下级部门的角色   | Nested Set范围查询            |
    | 3          | 本部门       | 普通管理员、只需处理本部门事务     | dept_id = 用户所属部门        |
    | 4          | 仅本人       | 执行人、只能看自己创建/负责的数据  | creator_id = 当前用户ID       |
    | 5          | 自定义范围   | 跨部门协作、项目组、临时授权       | 查询tenant_user_data_access表 |

    表 6.1.2.3-2 数据权限范围类型

+   **数据权限计算示例**：

    ```
    场景：制度管理员角色（data_scope=3 本部门）分配给不同部门的人

    张三 - 研发部 - 制度管理员  → 只能看研发部的制度
    李四 - 财务部 - 制度管理员  → 只能看财务部的制度

    场景：合规经理角色（data_scope=1 全部）

    王五 - 合规部 - 合规经理    → 能看所有部门的制度

    关键点：
    - 角色（制度管理员）决定「看多大范围」→ 本部门
    - 用户（张三/李四）决定「从哪个部门开始算」→ 研发部/财务部
    - 同一角色，不同用户，看到不同数据
    ```

#### 6.1.2.4 C端用户群（UC）权限场景

+   C端用户群用户是面向公众的C端用户，权限模型最简单。

+   **数据访问边界**：
    -   **可访问**：知识中台公共数据（只读）、个人私有数据（收藏、下载记录、学习进度等）
    -   **禁止访问**：租户业务数据、运营用户群运营数据、其他UC用户数据

+   **核心安全原则**：
    -   UC用户访问知识中台数据时：只读，无需用户过滤
    -   UC用户访问个人私有数据时：强制 `WHERE owner_user_id = #{currentUserId}`
    -   配额控制纳入权限体系：配额超限返回403（权限不足），而非429（请求过多）

+   C端用户群预置角色如下表所示：

    | 角色编码 | 角色名称 | 核心职责                     | 配额限制             |
    | -------- | -------- | ---------------------------- | -------------------- |
    | UC-01    | 免费用户 | 基础检索、有限下载           | 搜索20条、下载3次/天 |
    | UC-02    | 付费会员 | 高级检索、无限下载、学习中心 | 无限制               |

    表 6.1.2.4-1 C端用户群预置角色

+   **UC用户权限特点**：
    -   角色固定为两个，不支持自定义
    -   权限差异主要体现在功能可用性和配额限制
    -   数据权限强制用户隔离，无部门概念

#### 6.1.2.5 数据密级定义

+   为保障数据安全，系统定义四类数据密级：

    | 密级            | 说明             | 可访问角色                   |
    | --------------- | ---------------- | ---------------------------- |
    | PUBLIC          | 知识中台公共数据 | 所有UP角色、所有UC角色       |
    | PLATFORM_CONFIG | 平台系统配置     | 平台管理员、UP-06/08         |
    | TENANT_PRIVATE  | 租户私有业务数据 | **仅租户内用户，禁止UP**     |
    | USER_PRIVATE    | UC用户私有数据   | **仅本人，禁止所有其他角色** |

    表 6.1.2.5-1 数据密级定义

+   **零信任数据访问原则**：
    -   **任何角色（包括平台管理员）均不可访问用户业务数据**
    -   运营用户群（UP）：禁止访问租户业务数据、UC个人数据
    -   平台级：仅可管理系统配置（字典、参数、权限定义等），禁止访问任何用户产生的业务数据
    -   本系统**不存在"超级管理员"角色**，不提供任何绕过数据隔离的机制

### 6.1.3 功能权限设计

+   功能权限控制用户"能否调用某个接口"，采用RBAC模型实现。
+   本节定义功能权限的标识规范、层级结构和管理方式。

#### 6.1.3.1 功能权限定义

+   功能权限是对API接口的访问控制，核心要素如下表所示：

    | 要素       | 说明               | 示例                           |
    | ---------- | ------------------ | ------------------------------ |
    | 权限标识   | 唯一标识一个权限点 | ur:landing:policy:create       |
    | 权限名称   | 权限的中文描述     | 创建制度                       |
    | 权限类型   | 目录/菜单/按钮三级 | 按钮                           |
    | 归属用户侧 | 权限适用的用户群   | ur（租户用户群）               |
    | 关联API    | 权限对应的后端接口 | POST /api/v1/ur/landing/policy |

    表 6.1.3.1-1 功能权限核心要素

+   功能权限的控制层次：

    | 层次      | 控制内容     | 重要性       | 说明                   |
    | --------- | ------------ | ------------ | ---------------------- |
    | 前端-菜单 | 侧边栏显示   | 体验优化     | 无权限的菜单不显示     |
    | 前端-路由 | URL访问      | 体验优化     | 无权限时跳转403页面    |
    | 前端-按钮 | 操作按钮显示 | 体验优化     | 无权限的按钮隐藏或禁用 |
    | 后端-API  | 接口调用     | **安全必须** | 最后一道防线           |

    表 6.1.3.1-2 功能权限控制层次

#### 6.1.3.2 权限标识命名规范（四段式）

+   权限标识采用四段式命名格式：

    ```
    {用户侧}:{限界上下文}:{资源}:{操作}
    ```

+   各段含义如下表所示：

    | 段位       | 说明                           | 示例                             |
    | ---------- | ------------------------------ | -------------------------------- |
    | 用户侧     | 标识权限所属的用户群体         | provider / ur / uc / platform    |
    | 限界上下文 | 对应DDD中的限界上下文          | acquisition / landing / applying |
    | 资源       | 操作的目标资源，通常对应聚合根 | mandate / asset / control        |
    | 操作       | 对资源执行的动作               | create / update / delete / list  |

    表 6.1.3.2-1 权限标识段位说明

+   命名示例：

    | 权限标识                            | 用户侧   | 限界上下文  | 资源     | 操作   | 含义                   |
    | ----------------------------------- | -------- | ----------- | -------- | ------ | ---------------------- |
    | provider:acquisition:mandate:create | provider | acquisition | mandate  | create | 运营用户群创建外规     |
    | ur:landing:policy:list              | ur       | landing     | policy   | list   | 租户用户群查看制度列表 |
    | uc:search:fulltext:query            | uc       | search      | fulltext | query  | C端用户群全文检索      |
    | platform:user:role:assign           | platform | user        | role     | assign | 平台分配角色           |

    表 6.1.3.2-2 权限标识命名示例

+   **权限标识常量化要求**：
    -   所有权限标识必须定义为Java常量，禁止在代码中硬编码字符串
    -   常量类按用户侧和限界上下文组织
    -   Controller中使用常量引用，示例如下：

    ```java
    public interface Perms {
        /** 运营用户群权限 */
        interface Provider {
            interface Acquisition {
                interface Mandate {
                    String LIST = "provider:acquisition:mandate:list";
                    String CREATE = "provider:acquisition:mandate:create";
                    String UPDATE = "provider:acquisition:mandate:update";
                    String DELETE = "provider:acquisition:mandate:delete";
                }
            }
        }
        /** 租户用户群权限 */
        interface Ur {
            interface Landing {
                interface Policy {
                    String LIST = "ur:landing:policy:list";
                    String CREATE = "ur:landing:policy:create";
                    String UPDATE = "ur:landing:policy:update";
                    String DELETE = "ur:landing:policy:delete";
                }
            }
        }
    }
    ```

    代码 6.1.3.2-1 权限常量类结构

#### 6.1.3.3 用户侧与限界上下文定义

+   **用户侧定义**：

    | 用户侧        | 代码     | 说明                           | 数据访问限制                      |
    | ------------- | -------- | ------------------------------ | --------------------------------- |
    | 运营用户群/UP | provider | UP-01 ~ UP-08 运营角色使用     | 仅知识中台+平台配置，禁止用户数据 |
    | 租户用户群/UR | ur       | UR-01 ~ UR-09 企业租户角色使用 | 本租户数据，按data_scope过滤      |
    | C端用户群/UC  | uc       | UC-01 ~ UC-02 个人用户使用     | 仅本人数据+知识中台只读           |
    | 平台级        | platform | 系统配置管理                   | 仅系统配置，禁止所有用户数据      |

    表 6.1.3.3-1 用户侧定义

+   **限界上下文定义**：

    | 用户侧   | 上下文代码   | 上下文名称 | 说明                         |
    | -------- | ------------ | ---------- | ---------------------------- |
    | provider | acquisition  | 内容采集   | 外规采集、变更监测、人工验证 |
    | provider | engineering  | 知识工程   | 控制点、场景点、映射管理     |
    | provider | publishing   | 质检发布   | 质量检查、合规包发布         |
    | provider | operation    | 租户运营   | 租户管理、订阅管理、账单管理 |
    | provider | monitoring   | 运营监控   | 监控大屏、业务指标、SLA监控  |
    | ur       | landing      | 落标域     | 资产、场景、控制、制度、岗位 |
    | ur       | applying     | 用标域     | 评估、风险、证据、整改、报表 |
    | ur       | supporting   | 横切支撑   | 合规中心、治理中心、风险中心 |
    | uc       | search       | 知识检索   | 全文检索、语义检索           |
    | uc       | graph        | 图谱浏览   | 知识图谱可视化               |
    | uc       | template     | 模板下载   | 模板预览、下载               |
    | uc       | learning     | 学习中心   | 学习路径、进度追踪           |
    | uc       | subscription | 订阅管理   | 套餐升级、续费管理           |
    | platform | user         | 用户管理   | 用户、角色、权限             |
    | platform | system       | 系统管理   | 配置、字典、日志             |
    | platform | workflow     | 工作流     | 流程定义、流程实例           |
    | platform | message      | 消息中心   | 消息模板、消息发送           |
    | platform | file         | 文件服务   | 文件上传、下载               |
    | platform | audit        | 审计日志   | 操作日志、访问日志           |

    表 6.1.3.3-2 限界上下文定义

#### 6.1.3.4 常用操作定义

+   操作标识应保持统一，常用操作如下表所示：

    | 操作代码 | 操作名称 | 说明                           |
    | -------- | -------- | ------------------------------ |
    | list     | 查看列表 | 查询列表数据，通常对应菜单权限 |
    | detail   | 查看详情 | 查询单条记录详情               |
    | create   | 创建     | 新增记录                       |
    | update   | 更新     | 修改记录                       |
    | delete   | 删除     | 删除记录                       |
    | export   | 导出     | 导出数据到文件                 |
    | import   | 导入     | 从文件导入数据                 |
    | approve  | 审批     | 审批通过或拒绝                 |
    | reject   | 驳回     | 驳回申请                       |
    | submit   | 提交     | 提交审批                       |
    | publish  | 发布     | 发布上线                       |
    | revoke   | 撤销     | 撤销已发布内容                 |
    | assign   | 分配     | 分配任务或资源                 |
    | start    | 启动     | 启动任务或流程                 |
    | stop     | 停止     | 停止任务或流程                 |
    | upload   | 上传     | 上传文件                       |
    | download | 下载     | 下载文件                       |

    表 6.1.3.4-1 常用操作定义

#### 6.1.3.5 权限层级（目录/菜单/按钮）

+   权限采用树形结构组织，分为三个层级：

    | 层级 | 类型代码 | 说明             | 前端表现       | 示例               |
    | ---- | -------- | ---------------- | -------------- | ------------------ |
    | 1    | 目录     | 一级导航分类     | 侧边栏一级菜单 | 落标管理           |
    | 2    | 菜单     | 具体功能页面入口 | 侧边栏二级菜单 | 制度管理           |
    | 3    | 按钮     | 页面内的操作按钮 | 页面按钮       | 创建制度、删除制度 |

    表 6.1.3.5-1 权限层级说明

+   权限树形结构示例：

    ```
    落标管理（目录）
    ├── 资产管理（菜单）
    │   ├── 查看资产列表（按钮）
    │   ├── 创建资产（按钮）
    │   ├── 编辑资产（按钮）
    │   └── 删除资产（按钮）
    ├── 制度管理（菜单）
    │   ├── 查看制度列表（按钮）
    │   ├── 创建制度（按钮）
    │   ├── 编辑制度（按钮）
    │   ├── 删除制度（按钮）
    │   ├── 提交审批（按钮）
    │   └── 发布制度（按钮）
    └── 控制指派（菜单）
        ├── 查看控制点列表（按钮）
        ├── 订阅控制点（按钮）
        └── 指派责任人（按钮）
    ```

    图 6.1.3.5-1 权限树形结构示例

+   层级规则说明：
    -   目录级别的permission_code可为空，仅用于前端菜单分组
    -   菜单级别必须有permission_code，对应list操作，控制页面入口
    -   按钮级别必须有permission_code，对应具体操作，控制API访问

### 6.1.4 数据权限设计

+   数据权限控制用户"能看到哪些数据"，采用ABAC模型实现。
+   本节定义数据权限的分类、范围类型和计算逻辑。

#### 6.1.4.1 数据权限定义

+   数据权限是对数据记录和字段的访问控制，分为两类：

    | 类型       | 控制内容       | 实现方式            | 示例                   |
    | ---------- | -------------- | ------------------- | ---------------------- |
    | 行级权限   | 能看到哪些记录 | WHERE条件注入       | 只能看本部门的20条记录 |
    | 字段级权限 | 能看到哪些字段 | SELECT字段过滤/脱敏 | 看不到薪资字段         |

    表 6.1.4.1-1 数据权限分类

+   数据权限的核心设计原则：
    -   **角色定义范围类型**：通过data_scope字段指定看"多大范围"
    -   **用户决定起算点**：根据用户所属部门（dept_id）决定"从哪里开始算"
    -   **动态计算**：同一角色分配给不同用户，看到的数据不同

#### 6.1.4.2 行级权限（data_scope）

+   行级权限通过角色的data_scope字段配置，支持五种范围类型。

+   **行级权限SQL示例**（以租户用户群UR用户为例）：

    ```sql
    -- CISO (角色data_scope=1 全部) - 可看租户内所有数据
    -- 租户库天然隔离，无需额外条件
    SELECT * FROM tenant_policy;

    -- 部门经理 (角色data_scope=2 本部门及以下, 用户所属部门lft=5, rgt=20)
    -- 使用Nested Set左右值范围查询，性能O(1)
    SELECT p.* FROM tenant_policy p
    INNER JOIN tenant_dept d ON p.dept_id = d.id
    WHERE d.lft BETWEEN 5 AND 20;

    -- 制度管理员 (角色data_scope=3 本部门, 用户dept_id=20)
    SELECT * FROM tenant_policy WHERE dept_id = 20;

    -- 普通员工 (角色data_scope=4 仅本人, 用户user_id=789)
    SELECT * FROM tenant_policy WHERE creator_id = 789;

    -- 跨部门授权 (角色data_scope=5 自定义范围, 用户有专项组授权)
    SELECT * FROM tenant_policy
    WHERE dept_id IN (
        SELECT target_id FROM tenant_user_data_access
        WHERE user_id = 789
          AND target_type = 'dept'
          AND approval_status = 1
          AND (expire_time IS NULL OR expire_time > NOW())
    );
    ```

    代码 6.1.4.2-1 行级权限SQL示例

+   **Nested Set模型说明**：
    -   每个部门节点存储左值（lft）和右值（rgt）
    -   查询子树只需 `WHERE lft BETWEEN parent.lft AND parent.rgt`
    -   相比 `LIKE '%,x,%'`，性能从O(n)提升到O(1)
    -   详细表结构见6.5.3.1 tenant_dept租户部门表

#### 6.1.4.3 字段级权限（脱敏）

+   V1.0采用**全局敏感字段统一脱敏**策略，不支持按角色动态配置字段可见性。

+   敏感字段脱敏规则如下表所示：

    | 字段类型 | 脱敏规则       | 示例               | 可见完整值的角色 |
    | -------- | -------------- | ------------------ | ---------------- |
    | 手机号   | 保留前3后4位   | 138****1234        | HR、本人         |
    | 身份证号 | 保留前3后4位   | 110***********1234 | HR、本人         |
    | 邮箱     | 用户名部分脱敏 | zha***@example.com | HR、本人         |
    | 银行卡号 | 保留后4位      | ************1234   | 财务、本人       |
    | 薪资     | 完全隐藏       | null或不返回字段   | HR               |

    表 6.1.4.3-1 敏感字段脱敏规则

+   实现机制：
    -   通过自定义注解 `@DataMasking` 标记敏感字段
    -   在Jackson序列化阶段统一处理脱敏逻辑
    -   详见6.6.4字段级权限实现

+   **V2.0规划**：支持按角色配置字段可见性（visible/masked/hidden三种状态）

#### 6.1.4.4 数据权限范围类型（1-5）

+   数据权限范围类型详细说明如下表所示：

    | data_scope | 含义         | 适用场景                          | SQL条件                       | 配置位置      |
    | ---------- | ------------ | --------------------------------- | ----------------------------- | ------------- |
    | 1          | 全部数据     | CISO、合规经理等全局视角角色      | 无额外条件                    | 角色表        |
    | 2          | 本部门及以下 | 部门经理、需要管理下级部门的角色  | Nested Set范围查询            | 角色表        |
    | 3          | 本部门       | 普通管理员、只需处理本部门事务    | dept_id = 用户所属部门        | 角色表        |
    | 4          | 仅本人       | 执行人、只能看自己创建/负责的数据 | creator_id = 当前用户ID       | 角色表        |
    | 5          | 自定义范围   | 跨部门协作、项目组、临时授权      | 查询tenant_user_data_access表 | 角色表+授权表 |

    表 6.1.4.4-1 数据权限范围类型详解

+   **自定义范围（data_scope=5）说明**：
    -   支持矩阵式管理场景：员工可被授权访问非本部门的数据
    -   支持临时授权：可设置授权过期时间（expire_time）
    -   授权粒度：部门（dept）、项目组（project，V2.0）、自定义分组（custom，V2.0）
    -   授权需经过审批流程，详见6.5.3.6 tenant_user_data_access表

#### 6.1.4.5 多角色data_scope合并策略

+   当用户同时拥有多个角色时，需要合并计算最终生效的data_scope。

+   合并规则如下表所示：

    | 场景                     | 合并策略             | 示例                                    |
    | ------------------------ | -------------------- | --------------------------------------- |
    | 同类角色（均为业务角色） | 取最小值（最大权限） | 制度管理员(3) + 合规经理(1) → 生效值为1 |
    | 包含自定义范围(5)        | 自定义范围独立生效   | 部门经理(2) + 专项组成员(5) → 2 ∪ 5     |

    表 6.1.4.5-1 多角色data_scope合并策略

+   **合并策略风险说明**：
    -   "取最小值"策略可能导致权限过度放大
    -   建议在分配角色时遵循最小权限原则，避免为同一用户分配权限差异过大的角色
    -   系统增加data_scope合并审计日志，记录实际生效值及合并过程

+   **审计日志示例**：

    ```json
    {
        "user_id": 10001,
        "roles": ["UR-05", "UR-02"],
        "role_data_scopes": [3, 1],
        "effective_data_scope": 1,
        "merge_strategy": "MIN",
        "timestamp": "2026-01-23T10:30:00Z"
    }
    ```

    代码 6.1.4.5-1 data_scope合并审计日志示例

### 6.1.5 角色管理场景

+   角色是连接用户和权限的桥梁，本节定义角色的分类、管理方式和互斥规则。

#### 6.1.5.1 系统预置角色

+   系统预置角色由平台统一定义，租户不可修改、不可删除。

+   **系统预置角色特点**：
    -   平台统一管理，存储在platform_role表
    -   角色编码全局唯一（如UP-01、UR-01、UC-01）
    -   权限配置固定，通过platform_role_permission关联
    -   租户管理员只能分配系统预置角色给用户，不能修改角色权限

+   **系统预置角色清单**：

    | 用户侧       | 角色数量 | 角色编码范围  | 存储位置             |
    | ------------ | -------- | ------------- | -------------------- |
    | 运营用户群UP | 8个      | UP-01 ~ UP-08 | clarisphere_platform |
    | 租户用户群UR | 9个      | UR-01 ~ UR-09 | clarisphere_platform |
    | C端用户群UC  | 2个      | UC-01 ~ UC-02 | clarisphere_platform |

    表 6.1.5.1-1 系统预置角色清单

+   **系统预置角色的作用**：
    -   提供开箱即用的角色配置，降低租户管理成本
    -   确保核心业务角色的权限标准化
    -   作为租户自定义角色的参考模板

#### 6.1.5.2 自定义角色（平台级/租户级）

+   当系统预置角色无法满足需求时，可创建自定义角色。

+   **自定义角色分类**：

    | 类型           | 适用场景             | 存储位置                 | 管理者     | 权限来源             |
    | -------------- | -------------------- | ------------------------ | ---------- | -------------------- |
    | 平台自定义角色 | 运营用户群UP业务扩展 | clarisphere_platform     | 平台管理员 | 从provider权限中选择 |
    | 租户自定义角色 | 租户UR业务定制       | clarisphere_t{tenant_id} | 租户管理员 | 从ur权限中选择       |

    表 6.1.5.2-1 自定义角色分类

+   **租户自定义角色特点**：
    -   存储在租户独立库tenant_role表，数据天然隔离
    -   租户管理员可创建、修改、删除
    -   权限从platform_permission表中选择组合（仅ur用户侧的权限）
    -   可配置data_scope，控制数据权限范围

+   **租户用户角色分配**：
    -   一个用户可同时拥有系统预置角色和租户自定义角色
    -   通过tenant_user_role表的role_type字段区分角色来源
    -   权限合并时，系统预置角色和自定义角色的权限并集生效

#### 6.1.5.3 角色互斥规则

+   某些角色之间存在职责冲突，不能同时分配给同一用户。

+   **角色互斥场景**：

    | 互斥角色A  | 互斥角色B  | 互斥原因               |
    | ---------- | ---------- | ---------------------- |
    | 制度审批人 | 制度编制人 | 不能自己审批自己的制度 |
    | 证据提交人 | 证据审核人 | 不能自己审核自己的证据 |
    | 风险评估人 | 风险处置人 | 职责分离原则           |

    表 6.1.5.3-1 角色互斥场景示例

+   **互斥规则配置**：
    -   通过platform_role_conflict表配置互斥关系
    -   分配角色时自动校验互斥规则
    -   违反互斥规则时拒绝分配并提示原因

+   **互斥检查逻辑**：

    ```java
    public void assignRoleToUser(Long userId, Long roleId) {
        // 1. 查询用户已有角色
        List<Long> existingRoleIds = userRoleMapper.selectRoleIdsByUserId(userId);

        // 2. 查询新角色的互斥角色列表
        List<Long> conflictRoleIds = roleConflictMapper.selectConflictRoleIds(roleId);

        // 3. 检查是否存在互斥
        List<Long> conflicts = existingRoleIds.stream()
            .filter(conflictRoleIds::contains)
            .toList();

        if (!conflicts.isEmpty()) {
            throw new BusinessException("ROLE_CONFLICT",
                "角色互斥，不能同时拥有角色：" + getRoleNames(conflicts));
        }

        // 4. 无互斥，执行分配
        userRoleMapper.insert(userId, roleId);
    }
    ```

    代码 6.1.5.3-1 角色互斥检查逻辑

## 6.2 业务流程设计

+   本节基于6.1业务场景，详细设计各业务流程。
+   流程设计遵循《领域驱动设计详细设计文档编写指南》的流程层级规范。

### 6.2.1 流程层级说明

+   本子领域业务流程采用三层结构组织：

    | 层级     | 说明             | 图示工具    | 读者           |
    | -------- | ---------------- | ----------- | -------------- |
    | 一级流程 | 端到端完整流程   | ASCII流程图 | 产品/业务/架构 |
    | 二级流程 | 子流程（带泳道） | 时序图      | 架构/开发      |
    | 三级流程 | 功能级详细流程   | 步骤表      | 开发/测试      |

    表 6.2.1-1 流程层级说明

+   本章重点描述一级流程和关键二级流程，三级流程在接口设计中体现。

### 6.2.2 流程清单

+   权限管理涉及的业务流程清单如下表所示：

    | 流程编号   | 流程名称           | 触发场景                   | 所属用户侧 |
    | ---------- | ------------------ | -------------------------- | ---------- |
    | FL-PERM-01 | 角色创建流程       | 管理员创建自定义角色       | UP/UR      |
    | FL-PERM-02 | 角色权限配置流程   | 管理员配置角色权限         | UP/UR      |
    | FL-PERM-03 | 用户角色分配流程   | 管理员为用户分配角色       | UP/UR      |
    | FL-PERM-04 | 数据权限授权流程   | 跨部门数据访问授权（审批） | UR         |
    | FL-PERM-05 | 权限校验流程       | 用户访问受保护资源         | 全部       |
    | FL-PERM-06 | 多角色权限合并流程 | 用户登录时加载权限         | 全部       |
    | FL-PERM-07 | 角色回收流程       | 管理员移除用户角色         | UP/UR      |

    表 6.2.2-1 权限管理流程清单

### 6.2.3 FL-PERM-01 角色创建流程

+   本流程描述管理员创建自定义角色的过程。

#### 6.2.3.1 流程概述

+   流程基本信息如下：
    -   流程目标：管理员创建满足业务需求的自定义角色
    -   触发条件：管理员在角色管理页面发起创建角色请求
    -   结束条件：角色创建成功，可用于分配给用户
    -   预计耗时：< 3秒

#### 6.2.3.2 流程图

+   角色创建流程如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                       FL-PERM-01 角色创建流程                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   管理员                           BC-10                                    │
    │  ┌────────┐                      ┌────────┐                                 │
    │  │ 开始   │─────────────────────▶│ 权限   │                                 │
    │  │        │                      │ 校验   │                                 │
    │  └────────┘                      └───┬────┘                                 │
    │                                      │                                      │
    │                               ┌──────┴──────┐                               │
    │                               │             │                               │
    │                          权限不足      权限通过                             │
    │                               │             │                               │
    │                               ▼             ▼                               │
    │                          ┌────────┐   ┌────────┐                            │
    │                          │ 返回   │   │ 填写   │                            │
    │                          │ 403    │   │ 角色   │                            │
    │                          └────────┘   │ 信息   │                            │
    │                                       └───┬────┘                            │
    │                                           │                                 │
    │                                           ▼                                 │
    │                                      ┌────────┐                             │
    │                                      │ 信息   │                             │
    │                                      │ 校验   │                             │
    │                                      └───┬────┘                             │
    │                                          │                                  │
    │                                   ┌──────┴──────┐                           │
    │                                   │             │                           │
    │                              校验失败      校验通过                         │
    │                                   │             │                           │
    │                                   ▼             ▼                           │
    │                              ┌────────┐   ┌────────┐                        │
    │                              │ 返回   │   │ 创建   │                        │
    │                              │ 错误   │   │ 角色   │                        │
    │                              └────────┘   └───┬────┘                        │
    │                                               │                             │
    │                                               ▼                             │
    │                                          ┌────────┐                         │
    │                                          │ 记录   │                         │
    │                                          │ 审计   │                         │
    │                                          └───┬────┘                         │
    │                                               │                             │
    │                                               ▼                             │
    │                                          ┌────────┐                         │
    │                                          │ 返回   │                         │
    │                                          │ 成功   │                         │
    │                                          └────────┘                         │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2.3.2-1 角色创建流程

#### 6.2.3.3 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称   | 执行者 | 输入        | 输出     | 业务规则                                               |
    | ---- | ---------- | ------ | ----------- | -------- | ------------------------------------------------------ |
    | 1    | 权限校验   | BC-10  | 操作者Token | 校验结果 | UP需platform:user:role:create，UR需ur:user:role:create |
    | 2    | 填写信息   | 管理员 | -           | 角色表单 | 必填：角色编码、角色名称、data_scope                   |
    | 3    | 编码唯一性 | BC-10  | 角色编码    | 校验结果 | UP角色在平台库唯一，UR角色在租户库唯一                 |
    | 4    | 创建角色   | BC-10  | 角色信息    | 角色ID   | UP存platform_custom_role，UR存tenant_role              |
    | 5    | 记录审计   | BC-10  | 操作信息    | 审计日志 | 记录角色创建操作                                       |
    | 6    | 返回结果   | BC-10  | 角色ID      | 响应     | 返回创建成功的角色ID                                   |

    表 6.2.3.3-1 角色创建流程步骤

### 6.2.4 FL-PERM-02 角色权限配置流程

+   本流程描述管理员为角色配置功能权限的过程。

#### 6.2.4.1 流程概述

+   流程基本信息如下：
    -   流程目标：管理员为角色分配具体的功能权限
    -   触发条件：管理员在角色详情页面配置权限
    -   结束条件：角色权限配置成功，权限立即生效
    -   预计耗时：< 3秒

#### 6.2.4.2 流程图

+   角色权限配置流程如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     FL-PERM-02 角色权限配置流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   管理员                           BC-10                       缓存         │
    │  ┌────────┐                      ┌────────┐                                 │
    │  │ 选择   │─────────────────────▶│ 加载   │                                 │
    │  │ 角色   │                      │ 权限树 │                                 │
    │  └────────┘                      └───┬────┘                                 │
    │                                      │                                      │
    │                                      ▼                                      │
    │  ┌────────┐                      ┌────────┐                                 │
    │  │ 勾选   │◀─────────────────────│ 展示   │                                 │
    │  │ 权限   │                      │ 权限树 │                                 │
    │  └───┬────┘                      │(已勾选)│                                 │
    │      │                           └────────┘                                 │
    │      │                                                                      │
    │      ▼                                                                      │
    │  ┌────────┐                      ┌────────┐                                 │
    │  │ 提交   │─────────────────────▶│ 权限   │                                 │
    │  │ 保存   │                      │ 校验   │                                 │
    │  └────────┘                      └───┬────┘                                 │
    │                                      │                                      │
    │                               ┌──────┴──────┐                               │
    │                               │             │                               │
    │                          权限不足      权限通过                             │
    │                               │             │                               │
    │                               ▼             ▼                               │
    │                          ┌────────┐   ┌────────┐                            │
    │                          │ 返回   │   │ 校验   │                            │
    │                          │ 403    │   │ 权限ID │                            │
    │                          └────────┘   └───┬────┘                            │
    │                                           │                                 │
    │                                           ▼                                 │
    │                                      ┌────────┐   ┌────────┐                │
    │                                      │ 保存   │──▶│ 清除   │                │
    │                                      │ 关联   │   │ 缓存   │                │
    │                                      └───┬────┘   └────────┘                │
    │                                          │                                  │
    │                                          ▼                                  │
    │                                     ┌────────┐                              │
    │                                     │ 发布   │                              │
    │                                     │ 事件   │                              │
    │                                     └───┬────┘                              │
    │                                         │                                   │
    │                                         ▼                                   │
    │                                    ┌────────┐                               │
    │                                    │ 返回   │                               │
    │                                    │ 成功   │                               │
    │                                    └────────┘                               │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2.4.2-1 角色权限配置流程

#### 6.2.4.3 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称   | 执行者 | 输入            | 输出     | 业务规则                           |
    | ---- | ---------- | ------ | --------------- | -------- | ---------------------------------- |
    | 1    | 选择角色   | 管理员 | -               | 角色ID   | 系统预置角色不可修改权限           |
    | 2    | 加载权限树 | BC-10  | 角色ID+用户侧   | 权限树   | 根据用户侧加载对应权限树           |
    | 3    | 展示已勾选 | BC-10  | 角色权限关联    | 勾选状态 | 已分配的权限显示为勾选状态         |
    | 4    | 勾选权限   | 管理员 | 权限树          | 选中列表 | 支持全选、反选、按目录勾选         |
    | 5    | 提交保存   | 管理员 | 选中权限ID列表  | -        | -                                  |
    | 6    | 权限校验   | BC-10  | 操作者Token     | 校验结果 | 需要角色权限配置权限               |
    | 7    | 校验权限ID | BC-10  | 权限ID列表      | 校验结果 | 所有权限ID必须存在且属于当前用户侧 |
    | 8    | 保存关联   | BC-10  | 角色ID+权限列表 | 关联记录 | 先删后增，保存到角色权限关联表     |
    | 9    | 清除缓存   | BC-10  | 角色ID          | -        | 清除该角色所有用户的权限缓存       |
    | 10   | 发布事件   | BC-10  | 角色ID          | 领域事件 | 发布RolePermissionChangedEvent     |

    表 6.2.4.3-1 角色权限配置流程步骤

+   **权限范围限制说明**：
    -   UP管理员只能配置provider用户侧的权限
    -   UR管理员只能配置ur用户侧的权限
    -   UR管理员创建的自定义角色，权限范围不能超过自己拥有的权限

### 6.2.5 FL-PERM-03 用户角色分配流程

+   本流程描述管理员为用户分配角色的过程。

#### 6.2.5.1 流程概述

+   流程基本信息如下：
    -   流程目标：管理员为用户分配一个或多个角色
    -   触发条件：管理员在用户详情页面或角色详情页面发起分配
    -   结束条件：用户角色分配成功，用户权限立即生效
    -   预计耗时：< 3秒

#### 6.2.5.2 流程图

+   用户角色分配流程如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     FL-PERM-03 用户角色分配流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   管理员                           BC-10                       缓存         │
    │  ┌────────┐                      ┌────────┐                                 │
    │  │ 选择   │─────────────────────▶│ 权限   │                                 │
    │  │ 用户   │                      │ 校验   │                                 │
    │  └────────┘                      └───┬────┘                                 │
    │                                      │                                      │
    │                               ┌──────┴──────┐                               │
    │                               │             │                               │
    │                          权限不足      权限通过                             │
    │                               │             │                               │
    │                               ▼             ▼                               │
    │                          ┌────────┐   ┌────────┐                            │
    │                          │ 返回   │   │ 加载   │                            │
    │                          │ 403    │   │ 角色   │                            │
    │                          └────────┘   │ 列表   │                            │
    │                                       └───┬────┘                            │
    │                                           │                                 │
    │  ┌────────┐                               ▼                                 │
    │  │ 选择   │◀─────────────────────────┌────────┐                             │
    │  │ 角色   │                          │ 展示   │                             │
    │  └───┬────┘                          │ 可选   │                             │
    │      │                               │ 角色   │                             │
    │      │                               └────────┘                             │
    │      ▼                                                                      │
    │  ┌────────┐                          ┌────────┐                             │
    │  │ 提交   │─────────────────────────▶│ 互斥   │                             │
    │  │ 分配   │                          │ 校验   │                             │
    │  └────────┘                          └───┬────┘                             │
    │                                          │                                  │
    │                                   ┌──────┴──────┐                           │
    │                                   │             │                           │
    │                              存在互斥      无互斥                           │
    │                                   │             │                           │
    │                                   ▼             ▼                           │
    │                              ┌────────┐   ┌────────┐   ┌────────┐           │
    │                              │ 返回   │   │ 保存   │──▶│ 清除   │           │
    │                              │ 互斥   │   │ 关联   │   │ 缓存   │           │
    │                              │ 提示   │   └───┬────┘   └────────┘           │
    │                              └────────┘       │                             │
    │                                               ▼                             │
    │                                          ┌────────┐                         │
    │                                          │ 发布   │                         │
    │                                          │ 事件   │                         │
    │                                          └───┬────┘                         │
    │                                               │                             │
    │                                               ▼                             │
    │                                          ┌────────┐                         │
    │                                          │ 返回   │                         │
    │                                          │ 成功   │                         │
    │                                          └────────┘                         │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2.5.2-1 用户角色分配流程

#### 6.2.5.3 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称 | 执行者 | 输入            | 输出     | 业务规则                       |
    | ---- | -------- | ------ | --------------- | -------- | ------------------------------ |
    | 1    | 选择用户 | 管理员 | -               | 用户ID   | -                              |
    | 2    | 权限校验 | BC-10  | 操作者Token     | 校验结果 | 需要用户角色分配权限           |
    | 3    | 加载角色 | BC-10  | 用户类型        | 角色列表 | 加载系统预置角色+自定义角色    |
    | 4    | 展示角色 | BC-10  | 用户已有角色    | 勾选状态 | 已分配的角色显示为勾选状态     |
    | 5    | 选择角色 | 管理员 | 角色列表        | 选中角色 | 可多选                         |
    | 6    | 互斥校验 | BC-10  | 选中角色列表    | 校验结果 | 检查角色互斥规则               |
    | 7    | 保存关联 | BC-10  | 用户ID+角色列表 | 关联记录 | 先删后增，保存到用户角色关联表 |
    | 8    | 清除缓存 | BC-10  | 用户ID          | -        | 清除该用户的权限缓存           |
    | 9    | 发布事件 | BC-10  | 用户ID          | 领域事件 | 发布UserRoleChangedEvent       |

    表 6.2.5.3-1 用户角色分配流程步骤

+   **角色来源说明**：
    -   UR用户可同时拥有系统预置角色（role_type=SYSTEM）和租户自定义角色（role_type=CUSTOM）
    -   保存时通过role_type字段区分角色来源

### 6.2.6 FL-PERM-04 数据权限授权流程

+   本流程描述跨部门数据访问授权的过程，适用于data_scope=5（自定义范围）场景。

#### 6.2.6.1 流程概述

+   流程基本信息如下：
    -   流程目标：为用户授权访问非本部门的数据
    -   触发条件：管理员或用户本人发起跨部门数据访问申请
    -   结束条件：授权审批通过，用户可访问授权范围内的数据
    -   预计耗时：取决于审批流程，通常1-24小时

#### 6.2.6.2 流程图

+   数据权限授权流程如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                     FL-PERM-04 数据权限授权流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   申请人         BC-10           BC-14(工作流)      审批人        缓存      │
    │  ┌────────┐    ┌────────┐                                                   │
    │  │ 发起   │───▶│ 创建   │                                                   │
    │  │ 申请   │    │ 授权   │                                                   │
    │  └────────┘    │ 记录   │                                                   │
    │                └───┬────┘                                                   │
    │                    │                                                        │
    │                    ▼                                                        │
    │               ┌────────┐    ┌────────┐                                      │
    │               │ 判断   │───▶│ 启动   │                                      │
    │               │ 是否   │    │ 审批   │                                      │
    │               │ 需审批 │    │ 流程   │                                      │
    │               └───┬────┘    └───┬────┘                                      │
    │                   │             │                                           │
    │              免审批             │                                           │
    │                   │             ▼                                           │
    │                   │        ┌────────┐    ┌────────┐                         │
    │                   │        │ 等待   │───▶│ 审批   │                         │
    │                   │        │ 审批   │    │ 处理   │                         │
    │                   │        └────────┘    └───┬────┘                         │
    │                   │                          │                              │
    │                   │                   ┌──────┴─────┐                        │
    │                   │                   │            │                        │
    │                   │               拒绝        通过                          │
    │                   │                   │            │                        │
    │                   │                   ▼            │                        │
    │                   │              ┌────────┐        │                        │
    │                   │              │ 更新   │        │                        │
    │                   │              │ 状态   │        │                        │
    │                   │              │ =拒绝  │        │                        │
    │                   │              └────────┘        │                        │
    │                   │                                │                        │
    │                   ▼                                ▼                        │
    │              ┌────────┐                       ┌────────┐   ┌────────┐       │
    │              │ 更新   │                       │ 更新   │──▶│ 清除   │       │
    │              │ 状态   │                       │ 状态   │   │ 缓存   │       │
    │              │ =生效  │                       │ =生效  │   └────────┘       │
    │              └───┬────┘                       └───┬────┘                    │
    │                  │                               │                          │
    │                  ▼                               ▼                          │
    │             ┌────────┐                      ┌────────┐                      │
    │             │ 通知   │                      │ 通知   │                      │
    │             │ 申请人 │                      │ 申请人 │                      │
    │             └────────┘                      └────────┘                      │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2.6.2-1 数据权限授权流程

#### 6.2.6.3 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称   | 执行者 | 输入          | 输出       | 业务规则                                       |
    | ---- | ---------- | ------ | ------------- | ---------- | ---------------------------------------------- |
    | 1    | 发起申请   | 申请人 | 目标部门+原因 | 申请表单   | 填写授权目标、访问范围、有效期、申请原因       |
    | 2    | 创建记录   | BC-10  | 申请信息      | 授权记录ID | 存入tenant_user_data_access，status=待审批     |
    | 3    | 判断审批   | BC-10  | 申请人角色    | 是否免审批 | CISO创建的授权免审批，同部门内授权可配置免审批 |
    | 4    | 启动流程   | BC-14  | 授权记录ID    | 流程实例ID | 调用BC-14工作流启动审批流程                    |
    | 5    | 等待审批   | -      | -             | -          | 通知目标部门负责人审批                         |
    | 6    | 审批处理   | 审批人 | 审批意见      | 通过/拒绝  | 审批人为目标部门负责人                         |
    | 7    | 更新状态   | BC-10  | 审批结果      | 授权记录   | 通过则approval_status=1，拒绝则=2              |
    | 8    | 清除缓存   | BC-10  | 用户ID        | -          | 审批通过时清除用户数据权限缓存                 |
    | 9    | 通知申请人 | BC-12  | 审批结果      | 消息通知   | 通知申请人审批结果                             |

    表 6.2.6.3-1 数据权限授权流程步骤

+   **免审批场景说明**：
    -   CISO（UR-01）创建的授权：默认免审批，因为CISO本身有全部数据权限
    -   同部门内授权：可通过租户配置开启免审批
    -   临时紧急授权：可配置特定场景免审批（需记录审计日志）

### 6.2.7 FL-PERM-05 权限校验流程

+   本流程描述用户访问受保护资源时的权限校验过程。

#### 6.2.7.1 流程概述

+   流程基本信息如下：
    -   流程目标：判断用户是否有权限访问目标资源
    -   触发条件：用户请求到达后端API
    -   结束条件：校验通过放行，或校验失败返回403
    -   预计耗时：< 10ms（缓存命中时）

#### 6.2.7.2 流程图

+   权限校验流程如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                       FL-PERM-05 权限校验流程                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   请求                Filter               PermissionService         缓存   │
    │  ┌────────┐         ┌────────┐                                              │
    │  │ API    │────────▶│ 解析   │                                              │
    │  │ 请求   │         │ Token  │                                              │
    │  └────────┘         └───┬────┘                                              │
    │                         │                                                   │
    │                  ┌──────┴──────┐                                            │
    │                  │             │                                            │
    │             Token无效     Token有效                                         │
    │                  │             │                                            │
    │                  ▼             ▼                                            │
    │             ┌────────┐   ┌────────┐    ┌────────┐                           │
    │             │ 返回   │   │ 查询   │───▶│ 查询   │                           │
    │             │ 401    │   │ 权限   │    │ 缓存   │                           │
    │             └────────┘   └───┬────┘    └───┬────┘                           │
    │                              │             │                                │
    │                              │      ┌──────┴──────┐                         │
    │                              │      │             │                         │
    │                              │ 缓存命中      缓存未命中                     │
    │                              │      │             │                         │
    │                              │      │             ▼                         │
    │                              │      │        ┌────────┐                     │
    │                              │      │        │ 查询   │                     │
    │                              │      │        │ 数据库 │                     │
    │                              │      │        └───┬────┘                     │
    │                              │      │            │                          │
    │                              │      │            ▼                          │
    │                              │      │       ┌────────┐                      │
    │                              │      │       │ 写入   │                      │
    │                              │      │       │ 缓存   │                      │
    │                              │      │       └───┬────┘                      │
    │                              │      │            │                          │
    │                              ◀──────┴────────────┘                          │
    │                              │                                              │
    │                              ▼                                              │
    │                         ┌────────┐                                          │
    │                         │ 判断   │                                          │
    │                         │ 权限   │                                          │
    │                         └───┬────┘                                          │
    │                             │                                               │
    │                      ┌──────┴──────┐                                        │
    │                      │             │                                        │
    │                  无权限          有权限                                     │
    │                      │             │                                        │
    │                      ▼             ▼                                        │
    │                 ┌────────┐   ┌────────┐                                     │
    │                 │ 返回   │   │ 放行   │                                     │
    │                 │ 403    │   │ 请求   │                                     │
    │                 └────────┘   └────────┘                                     │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.2.7.2-1 权限校验流程

#### 6.2.7.3 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称   | 执行者            | 输入     | 输出      | 业务规则                         |
    | ---- | ---------- | ----------------- | -------- | --------- | -------------------------------- |
    | 1    | 解析Token  | JwtAuthFilter     | HTTP请求 | 用户信息  | 从Header中提取JWT Token并解析    |
    | 2    | 查询缓存   | PermissionService | 用户ID   | 权限列表  | 先查L1本地缓存，再查L2 Redis缓存 |
    | 3    | 查询数据库 | PermissionService | 用户ID   | 权限列表  | 缓存未命中时查询数据库           |
    | 4    | 写入缓存   | PermissionService | 权限列表 | -         | 查询结果写入L1+L2缓存            |
    | 5    | 判断权限   | @PreAuthorize     | 权限列表 | 有/无权限 | 检查目标权限是否在权限列表中     |
    | 6    | 返回结果   | -                 | 判断结果 | 响应      | 有权限放行，无权限返回403        |

    表 6.2.7.3-1 权限校验流程步骤

### 6.2.8 FL-PERM-06 多角色权限合并流程

+   本流程描述用户拥有多个角色时的权限合并计算过程。

#### 6.2.8.1 流程概述

+   流程基本信息如下：
    -   流程目标：合并用户所有角色的功能权限和数据权限
    -   触发条件：用户登录或权限缓存失效后重新加载
    -   结束条件：计算出用户的完整权限列表和data_scope
    -   预计耗时：< 50ms

#### 6.2.8.2 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称           | 执行者            | 输入               | 输出           | 业务规则                          |
    | ---- | ------------------ | ----------------- | ------------------ | -------------- | --------------------------------- |
    | 1    | 查询用户角色       | PermissionService | 用户ID             | 角色列表       | 包含系统预置角色和自定义角色      |
    | 2    | 分类角色           | PermissionService | 角色列表           | 分类后角色     | 按role_type分为SYSTEM和CUSTOM两类 |
    | 3    | 查询系统角色权限   | PermissionService | system角色ID列表   | 权限标识列表   | 查询platform_role_permission      |
    | 4    | 查询自定义角色权限 | PermissionService | custom角色ID列表   | 权限标识列表   | 查询tenant_role_permission        |
    | 5    | 合并功能权限       | PermissionService | 两类权限列表       | 功能权限并集   | 取并集，去重                      |
    | 6    | 合并数据权限       | DataScopeService  | 角色data_scope列表 | 生效data_scope | 取最小值（最大权限）              |
    | 7    | 处理自定义范围     | DataScopeService  | 授权记录           | 额外可访问部门 | 若存在data_scope=5，查询授权表    |
    | 8    | 记录审计日志       | AuditService      | 合并过程           | 审计日志       | 记录合并前后的权限变化            |

    表 6.2.8.2-1 多角色权限合并流程步骤

+   **合并策略说明**：

    ```java
    public UserPermission mergeUserPermissions(Long userId, Long tenantId) {
        // 1. 查询用户所有角色
        List<UserRole> roles = userRoleMapper.selectByUserId(userId);

        // 2. 分类：系统预置角色 vs 自定义角色
        List<Long> systemRoleIds = roles.stream()
            .filter(r -> "system".equals(r.getRoleType()))
            .map(UserRole::getRoleId).toList();
        List<Long> customRoleIds = roles.stream()
            .filter(r -> "custom".equals(r.getRoleType()))
            .map(UserRole::getRoleId).toList();

        // 3. 合并功能权限（并集）
        Set<String> permissions = new HashSet<>();
        if (!systemRoleIds.isEmpty()) {
            permissions.addAll(platformRolePermissionMapper.selectPermissionCodes(systemRoleIds));
        }
        if (!customRoleIds.isEmpty()) {
            permissions.addAll(tenantRolePermissionMapper.selectPermissionCodes(customRoleIds));
        }

        // 4. 合并数据权限（取最小值）
        List<Integer> dataScopes = roles.stream()
            .map(this::getRoleDataScope)
            .toList();
        int effectiveDataScope = dataScopes.stream()
            .min(Integer::compareTo)
            .orElse(4);  // 默认仅本人

        // 5. 处理自定义范围（data_scope=5）
        Set<Long> customDeptIds = Collections.emptySet();
        if (dataScopes.contains(5)) {
            customDeptIds = userDataAccessMapper.selectAuthorizedDeptIds(userId);
        }

        return new UserPermission(permissions, effectiveDataScope, customDeptIds);
    }
    ```

    代码 6.2.8.2-1 多角色权限合并逻辑

### 6.2.9 FL-PERM-07 角色回收流程

+   本流程描述管理员移除用户角色的过程。

#### 6.2.9.1 流程概述

+   流程基本信息如下：
    -   流程目标：移除用户的一个或多个角色
    -   触发条件：管理员在用户详情页面发起角色移除
    -   结束条件：角色移除成功，用户权限立即降级
    -   预计耗时：< 3秒

#### 6.2.9.2 流程步骤

+   流程步骤详细说明如下表所示：

    | 步骤 | 步骤名称 | 执行者 | 输入          | 输出       | 业务规则                             |
    | ---- | -------- | ------ | ------------- | ---------- | ------------------------------------ |
    | 1    | 选择用户 | 管理员 | -             | 用户ID     | -                                    |
    | 2    | 权限校验 | BC-10  | 操作者Token   | 校验结果   | 需要用户角色管理权限                 |
    | 3    | 加载角色 | BC-10  | 用户ID        | 已有角色   | 展示用户当前拥有的所有角色           |
    | 4    | 选择移除 | 管理员 | 已有角色      | 待移除角色 | 可多选                               |
    | 5    | 确认操作 | 管理员 | 待移除角色    | 确认       | 二次确认，提示权限将立即降级         |
    | 6    | 删除关联 | BC-10  | 用户ID+角色ID | -          | 从用户角色关联表删除记录             |
    | 7    | 清除缓存 | BC-10  | 用户ID        | -          | 清除用户权限缓存，强制重新加载       |
    | 8    | 发布事件 | BC-10  | 用户ID        | 领域事件   | 发布UserRoleRevokedEvent             |
    | 9    | 记录审计 | BC-10  | 操作信息      | 审计日志   | 记录角色移除操作，包含移除的角色列表 |

    表 6.2.9.2-1 角色回收流程步骤

+   **注意事项**：
    -   角色回收后权限立即生效，用户下次请求将使用新的权限
    -   若用户当前正在操作，可能导致操作中断（返回403）
    -   建议在回收前通知用户，或选择在非工作时间操作

## 6.3 领域模型设计

+   本节设计权限管理子领域的领域模型，包括聚合划分、实体、值对象、领域服务和领域事件。
+   领域模型设计遵循DDD战术设计原则，确保业务概念的准确表达。

### 6.3.1 聚合划分

+   权限管理子领域划分为以下聚合：

    | 聚合名称           | 聚合根             | 职责                     | 所属数据库               |
    | ------------------ | ------------------ | ------------------------ | ------------------------ |
    | 权限定义聚合       | Permission         | 管理功能权限定义         | clarisphere_platform     |
    | 平台角色聚合       | PlatformRole       | 管理系统预置角色         | clarisphere_platform     |
    | 平台自定义角色聚合 | PlatformCustomRole | 管理运营用户群自定义角色 | clarisphere_platform     |
    | 租户角色聚合       | TenantRole         | 管理租户自定义角色       | clarisphere_t{tenant_id} |
    | 用户角色聚合       | UserRole           | 管理用户与角色关联       | 对应用户所在库           |
    | 数据授权聚合       | UserDataAccess     | 管理跨部门数据授权       | clarisphere_t{tenant_id} |

    表 6.3.1-1 权限管理聚合划分

+   聚合划分说明：
    -   权限定义全局共享，存储在平台库，所有用户侧引用同一份权限定义
    -   角色分为平台级（系统预置+运营用户群自定义）和租户级（租户自定义）
    -   用户角色关联根据用户类型存储在对应数据库
    -   数据授权仅适用于租户用户群，存储在租户库

### 6.3.2 聚合关系图

+   权限管理子领域聚合关系如下图所示：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      权限管理子领域聚合关系图                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   clarisphere_platform（平台库）                                            │
    │  ┌───────────────────────────────────────────────────────────────────────┐  │
    │  │                                                                       │  │
    │  │  ┌─────────────────┐                                                  │  │
    │  │  │   Permission    │◀─────────────────────────────────────┐           │  │
    │  │  │  (权限定义聚合) │                                      │           │  │
    │  │  │                 │                                      │           │  │
    │  │  │ • 权限树形结构  │                                      │           │  │
    │  │  │ • 四段式标识    │                                      │           │  │
    │  │  └────────┬────────┘                                      │           │  │
    │  │           │                                               │           │  │
    │  │           │ 引用                                          │ 跨库引用  │  │
    │  │           ▼                                               │           │  │
    │  │  ┌─────────────────┐    ┌─────────────────────┐           │           │  │
    │  │  │  PlatformRole   │    │ PlatformCustomRole  │           │           │  │
    │  │  │ (平台角色聚合)  │    │(平台自定义角色聚合) │           │           │  │
    │  │  │                 │    │                     │           │           │  │
    │  │  │ • 系统预置角色  │    │ • UP自定义角色      │           │           │  │
    │  │  │ • 不可修改删除  │    │ • 可修改删除        │           │           │  │
    │  │  └─────────────────┘    └─────────────────────┘           │           │  │
    │  │                                                           │           │  │
    │  └───────────────────────────────────────────────────────────│───────────┘  │
    │                                                              │              │
    │   clarisphere_t{tenant_id}（租户库）                         │              │
    │  ┌───────────────────────────────────────────────────────────│───────────┐  │
    │  │                                                           │           │  │
    │  │  ┌─────────────────┐    ┌─────────────────────┐           │           │  │
    │  │  │   TenantRole    │────│   UserDataAccess    │           │           │  │
    │  │  │ (租户角色聚合)  │    │  (数据授权聚合)     │           │           │  │
    │  │  │                 │    │                     │           │           │  │
    │  │  │ • UR自定义角色  │    │ • 跨部门授权        │           │           │  │
    │  │  │ • data_scope    │    │ • 审批流程          │           │           │  │
    │  │  └────────┬────────┘    └─────────────────────┘           │           │  │
    │  │           │                                               │           │  │
    │  │           │ 权限引用 ─────────────────────────────────────┘           │  │
    │  │           │                                                           │  │
    │  │           ▼                                                           │  │
    │  │  ┌─────────────────┐                                                  │  │
    │  │  │    UserRole     │                                                  │  │
    │  │  │ (用户角色聚合)  │                                                  │  │
    │  │  │                 │                                                  │  │
    │  │  │ • 用户-角色关联 │                                                  │  │
    │  │  │ • role_type区分 │                                                  │  │
    │  │  └─────────────────┘                                                  │  │
    │  │                                                                       │  │
    │  └───────────────────────────────────────────────────────────────────────┘  │
    │                                                                             │
    │   共享值对象（跨聚合复用）                                                  │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │  PermissionCode │ DataScope │ RoleStatus │ ApprovalStatus           │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.3.2-1 权限管理聚合关系图

### 6.3.3 Permission 聚合（权限定义）

+   Permission聚合管理全局功能权限定义，是权限体系的基础。

#### 6.3.3.1 聚合结构

+   Permission聚合包含以下元素：

    | 元素类型 | 元素名称       | 说明                       |
    | -------- | -------------- | -------------------------- |
    | 聚合根   | Permission     | 权限定义实体               |
    | 值对象   | PermissionCode | 权限标识（四段式）         |
    | 值对象   | PermissionType | 权限类型（目录/菜单/按钮） |

    表 6.3.3.1-1 Permission聚合结构

#### 6.3.3.2 Permission 实体

+   Permission是聚合根，管理全局功能权限定义，采用三表模型定义如下。

##### 属性清单表

| 属性名         | 类型           | 约束                   | 默认值  | 业务含义                               |
| -------------- | -------------- | ---------------------- | ------- | -------------------------------------- |
| id             | Long           | 必填，主键             | 自增    | 权限唯一标识                           |
| permissionCode | PermissionCode | 必填，全局唯一         | -       | 权限标识（四段式）                     |
| permissionName | String         | 必填，长度2-64         | -       | 权限名称，用于显示                     |
| permissionType | PermissionType | 必填，枚举             | -       | 权限类型：CATALOG/MENU/BUTTON          |
| parentId       | Long           | 可选                   | null    | 父权限ID，顶级为null                   |
| userPool       | UserPool       | 必填，枚举，不可变     | -       | 所属用户群：UP/UR/UC（platform已废弃） |
| context        | String         | 必填，长度2-32         | -       | 限界上下文标识（如iam、compliance）    |
| resource       | String         | BUTTON级必填，长度2-32 | null    | 资源名称（如user、role）               |
| action         | String         | BUTTON级必填，长度2-32 | null    | 操作名称（如create、update、delete）   |
| path           | String         | MENU级可选，长度≤128   | null    | 前端路由路径                           |
| component      | String         | MENU级可选，长度≤128   | null    | 前端组件路径                           |
| icon           | String         | 可选，长度≤64          | null    | 图标标识                               |
| sortOrder      | Integer        | 必填                   | 0       | 同级排序号，数值越小越靠前             |
| status         | StatusEnum     | 必填，枚举             | ENABLED | 状态：ENABLED/DISABLED                 |
| createdAt      | DateTime       | 必填，不可变           | NOW()   | 创建时间                               |
| updatedAt      | DateTime       | 必填                   | NOW()   | 更新时间                               |

表 6.3.3.2-1 Permission属性清单表

##### 业务规则表

| 规则编号  | 规则名称     | 规则简述                                                     | 验证时机  | 违反后果 |
| --------- | ------------ | ------------------------------------------------------------ | --------- | -------- |
| PERM-R-01 | 编码全局唯一 | permissionCode在全局范围内唯一                               | 创建      | 拒绝操作 |
| PERM-R-02 | 编码不可变   | 创建后permissionCode不可修改                                 | 更新      | 拒绝操作 |
| PERM-R-03 | 四段式格式   | permissionCode格式：{userPool}:{context}:{resource}:{action} | 创建      | 拒绝操作 |
| PERM-R-04 | BUTTON级必填 | permissionType=BUTTON时，resource和action必填                | 创建/更新 | 拒绝操作 |
| PERM-R-05 | 树形结构约束 | parentId必须引用有效的Permission且userPool一致               | 创建/更新 | 拒绝操作 |
| PERM-R-06 | 禁用级联     | 禁用父权限时，所有子权限也自动禁用                           | 禁用      | -        |
| PERM-R-07 | 删除限制     | 权限不可物理删除，仅可禁用                                   | 删除      | 拒绝操作 |
| PERM-R-08 | 角色引用检查 | 被角色引用的权限不可禁用（需先移除引用）                     | 禁用      | 拒绝操作 |

表 6.3.3.2-2 Permission业务规则表

##### 业务方法表

| 方法名           | 方法简述                         | 关联规则           | 异常                       | 事件               |
| ---------------- | -------------------------------- | ------------------ | -------------------------- | ------------------ |
| create()         | 创建权限定义                     | PERM-R-01,03,04,05 | PermissionCodeDuplicateExc | PermissionCreated  |
| updateInfo()     | 更新权限名称、路径、图标等       | PERM-R-02,04       | InvalidPermissionException | PermissionUpdated  |
| disable()        | 禁用权限                         | PERM-R-06,08       | PermissionInUseException   | PermissionDisabled |
| enable()         | 启用已禁用的权限                 | -                  | -                          | PermissionEnabled  |
| isMenuOrButton() | 判断是否菜单或按钮级，返回布尔值 | -                  | -                          | -                  |
| getFullCode()    | 获取完整的四段式权限标识字符串   | -                  | -                          | -                  |
| getChildren()    | 获取子权限列表                   | -                  | -                          | -                  |

表 6.3.3.2-3 Permission业务方法表

+   备注：
    -   权限定义存储在平台库，全局共享，所有用户侧引用同一份权限定义
    -   权限树通过parentId构建，支持无限层级（建议不超过4层）
    -   权限定义通常通过初始化脚本或后台管理界面维护，不开放给租户

#### 6.3.3.3 PermissionCode 值对象

+   PermissionCode值对象封装四段式权限标识，采用三表模型定义如下。

##### 属性清单表

| 属性名   | 类型     | 约束                     | 默认值 | 业务含义                            |
| -------- | -------- | ------------------------ | ------ | ----------------------------------- |
| userPool | UserPool | 必填，枚举               | -      | 用户群：up/ur/uc                    |
| context  | String   | 必填，长度2-32，小写字母 | -      | 限界上下文标识（如iam、compliance） |
| resource | String   | 可选，长度2-32，小写字母 | null   | 资源名称（如user、role）            |
| action   | String   | 可选，长度2-32，小写字母 | null   | 操作名称（如create、update）        |

表 6.3.3.3-1 PermissionCode属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                            | 验证时机 | 违反后果 |
| -------- | ------------ | --------------------------------------------------- | -------- | -------- |
| PC-R-01  | 四段式格式   | 完整格式为{userPool}:{context}:{resource}:{action}  | 创建     | 拒绝操作 |
| PC-R-02  | 段位省略规则 | CATALOG级可省略resource和action，MENU级可省略action | 创建     | -        |
| PC-R-03  | 小写规范     | context、resource、action必须全部小写               | 创建     | 拒绝操作 |
| PC-R-04  | 不可变性     | 值对象创建后不可修改任何属性                        | -        | -        |

表 6.3.3.3-2 PermissionCode业务规则表

+   PermissionCode核心行为：

    | 方法名     | 参数                             | 返回值         | 说明                 |
    | ---------- | -------------------------------- | -------------- | -------------------- |
    | of()       | userPool,context,resource,action | PermissionCode | 静态工厂方法         |
    | parse()    | codeString                       | PermissionCode | 从字符串解析         |
    | toString() | -                                | String         | 转换为标准格式字符串 |
    | matches()  | pattern                          | boolean        | 模式匹配             |

    表 6.3.3.3-3 PermissionCode核心行为

#### 6.3.3.4 PermissionType 值对象

+   PermissionType值对象定义权限类型，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型         | 约束       | 默认值 | 业务含义       |
| ------ | ------------ | ---------- | ------ | -------------- |
| type   | PermTypeEnum | 必填，枚举 | -      | 权限类型枚举值 |

表 6.3.3.4-1 PermissionType属性清单表

##### 枚举值及特性表

| 枚举值  | 说明      | 有permissionCode | 关联API | 可作为父节点 | 前端展示 |
| ------- | --------- | ---------------- | ------- | ------------ | -------- |
| CATALOG | 目录      | 否               | 否      | 是           | 导航目录 |
| MENU    | 菜单      | 是               | 可选    | 是           | 菜单项   |
| BUTTON  | 按钮/操作 | 是               | 是      | 否           | 按钮     |

表 6.3.3.4-2 PermissionType枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                | 验证时机 | 违反后果 |
| -------- | -------------- | ------------------------------------------------------- | -------- | -------- |
| PT-R-01  | 层级结构约束   | BUTTON只能作为MENU或CATALOG的子节点，不能有子节点       | 创建     | 拒绝操作 |
| PT-R-02  | BUTTON必有Code | type=BUTTON时，关联的Permission必须有完整permissionCode | 创建     | 拒绝操作 |
| PT-R-03  | API关联规则    | type=BUTTON时必须关联API接口                            | 创建     | 警告     |

表 6.3.3.4-3 PermissionType业务规则表

### 6.3.4 PlatformRole 聚合（平台角色）

+   PlatformRole聚合管理系统预置角色，不可修改删除。

#### 6.3.4.1 聚合结构

+   PlatformRole聚合包含以下元素：

    | 元素类型 | 元素名称     | 说明             |
    | -------- | ------------ | ---------------- |
    | 聚合根   | PlatformRole | 系统预置角色实体 |
    | 值对象   | DataScope    | 数据权限范围     |
    | 值对象   | RoleStatus   | 角色状态         |

    表 6.3.4.1-1 PlatformRole聚合结构

#### 6.3.4.2 PlatformRole 实体

+   PlatformRole是聚合根，管理系统预置角色（不可修改删除），采用三表模型定义如下。

##### 属性清单表

| 属性名        | 类型       | 约束                     | 默认值  | 业务含义                          |
| ------------- | ---------- | ------------------------ | ------- | --------------------------------- |
| id            | Long       | 必填，主键               | 自增    | 角色唯一标识                      |
| roleCode      | String     | 必填，全局唯一，长度3-16 | -       | 角色编码（如UP-01、UR-01、UC-01） |
| roleName      | String     | 必填，长度2-32           | -       | 角色名称                          |
| userPool      | UserPool   | 必填，枚举，不可变       | -       | 所属用户群：UP/UR/UC              |
| dataScope     | DataScope  | 必填，枚举               | -       | 数据权限范围                      |
| permissionIds | List<Long> | 必填                     | []      | 关联的权限ID列表                  |
| description   | String     | 可选，长度≤256           | null    | 角色描述                          |
| sortOrder     | Integer    | 必填                     | 0       | 排序号                            |
| status        | RoleStatus | 必填，枚举               | ENABLED | 角色状态：ENABLED/DISABLED        |
| createdAt     | DateTime   | 必填，不可变             | NOW()   | 创建时间                          |
| updatedAt     | DateTime   | 必填                     | NOW()   | 更新时间                          |

表 6.3.4.2-1 PlatformRole属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                                  | 验证时机 | 违反后果 |
| -------- | ---------------- | --------------------------------------------------------- | -------- | -------- |
| PR-R-01  | 系统角色不可修改 | 系统预置角色的roleCode、roleName、permissionIds等不可修改 | 更新     | 拒绝操作 |
| PR-R-02  | 系统角色不可删除 | 系统预置角色不可删除                                      | 删除     | 拒绝操作 |
| PR-R-03  | 编码格式规范     | roleCode格式为{userPool}-{两位数字}，如UP-01、UR-01       | 创建     | -        |
| PR-R-04  | 仅通过脚本维护   | 系统预置角色仅通过数据库初始化脚本或升级脚本维护          | -        | -        |
| PR-R-05  | 权限必须匹配群   | permissionIds中的权限必须与角色userPool匹配               | 创建     | -        |
| PR-R-06  | 禁用不影响已分配 | 禁用角色不影响已分配用户，但不可再分配新用户              | 禁用     | -        |

表 6.3.4.2-2 PlatformRole业务规则表

##### 业务方法表

| 方法名                  | 方法简述                           | 关联规则 | 异常 | 事件 |
| ----------------------- | ---------------------------------- | -------- | ---- | ---- |
| hasPermission()         | 判断角色是否拥有指定权限标识       | -        | -    | -    |
| getPermissions()        | 获取角色所有权限标识列表           | -        | -    | -    |
| isSystemRole()          | 判断是否系统预置角色，始终返回true | -        | -    | -    |
| getEffectiveDataScope() | 获取角色的数据权限范围             | -        | -    | -    |

#### 6.3.4.3 DataScope 值对象

+   DataScope值对象封装数据权限范围，采用三表模型定义如下。

##### 属性清单表

| 属性名    | 类型          | 约束         | 默认值    | 业务含义                    |
| --------- | ------------- | ------------ | --------- | --------------------------- |
| scope     | DataScopeEnum | 必填，枚举   | SELF_ONLY | 数据范围类型                |
| customIds | Set<Long>     | CUSTOM时必填 | null      | 自定义范围的组织/部门ID集合 |

表 6.3.4.3-1 DataScope属性清单表

##### 枚举值及特性表

| 枚举值         | 数值 | 说明         | 适用场景           | SQL条件生成方式         | 优先级（合并时） |
| -------------- | ---- | ------------ | ------------------ | ----------------------- | ---------------- |
| ALL            | 1    | 全部数据     | CISO、合规经理等   | 无条件                  | 最高             |
| DEPT_AND_BELOW | 2    | 本部门及以下 | 部门经理           | dept_id IN (递归子部门) | 次高             |
| DEPT_ONLY      | 3    | 本部门       | 普通管理员         | dept_id = 用户部门      | 中               |
| SELF_ONLY      | 4    | 仅本人       | 执行人             | creator_id = 用户ID     | 次低             |
| CUSTOM         | 5    | 自定义范围   | 跨部门协作、项目组 | dept_id IN (customIds)  | 独立合并         |

表 6.3.4.3-2 DataScopeEnum枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                           | 验证时机 | 违反后果 |
| -------- | ---------------- | -------------------------------------------------- | -------- | -------- |
| DS-R-01  | CUSTOM必填IDs    | scope=CUSTOM时，customIds不能为空                  | 创建     | 拒绝操作 |
| DS-R-02  | 多角色合并规则   | 同类角色取最小值（最大权限），CUSTOM独立合并取并集 | 权限计算 | -        |
| DS-R-03  | 数值越小权限越大 | 数值1-4中，数值越小代表数据权限范围越大            | -        | -        |
| DS-R-04  | 不可变性         | 值对象创建后不可修改                               | -        | -        |

表 6.3.4.3-3 DataScope业务规则表

### 6.3.5 PlatformCustomRole 聚合（平台自定义角色）

+   PlatformCustomRole 聚合管理运营用户群（UP）业务扩展的自定义角色。当系统预置角色无法满足需求时，平台管理员可通过此聚合创建自定义角色。

#### 6.3.5.1 聚合结构

    ```
    PlatformCustomRole [聚合根]
    ├── id : Long                          // 角色ID
    ├── roleCode : String                  // 角色编码（全局唯一）
    ├── roleName : String                  // 角色名称
    ├── userPool : String                  // 固定为"UP"
    ├── status : RoleStatus                // 启用/禁用
    ├── sortOrder : Integer                // 排序号
    ├── remark : String                    // 备注
    ├── permissionIds : Set<Long>          // 关联的权限ID集合
    ├── dataScope : DataScope              // 数据权限范围（复用值对象）
    └── 审计字段
    ```

    图 6.3.5.1-1 PlatformCustomRole聚合结构

#### 6.3.5.2 PlatformCustomRole 实体

+   PlatformCustomRole 实体是聚合根，属性定义如下：

    | 属性名        | 类型          | 约束            | 默认值  | 说明                           |
    | ------------- | ------------- | --------------- | ------- | ------------------------------ |
    | id            | Long          | 必填，自增主键  | -       | 角色ID                         |
    | roleCode      | String        | 必填，长度2-50  | -       | 角色编码，全局唯一             |
    | roleName      | String        | 必填，长度2-100 | -       | 角色名称                       |
    | userPool      | String        | 必填，固定值    | "UP"    | 用户群标识（仅限运营用户群）   |
    | status        | RoleStatus    | 必填            | ENABLED | 状态：ENABLED/DISABLED         |
    | sortOrder     | Integer       | 可选            | 0       | 排序号                         |
    | remark        | String        | 可选，长度≤500  | null    | 备注                           |
    | permissionIds | Set<Long>     | 可选            | []      | 关联权限ID集合（仅provider侧） |
    | dataScope     | DataScope     | 可选            | ALL     | 数据权限范围                   |
    | createdBy     | Long          | 审计字段        | -       | 创建人                         |
    | createdAt     | LocalDateTime | 审计字段        | now()   | 创建时间                       |
    | updatedBy     | Long          | 审计字段        | -       | 更新人                         |
    | updatedAt     | LocalDateTime | 审计字段        | now()   | 更新时间                       |

    表 6.3.5.2-1 PlatformCustomRole实体属性

+   业务方法定义如下：

    | 方法名                 | 参数                    | 返回值             | 前置条件                         | 后置条件         | 产生事件                   |
    | ---------------------- | ----------------------- | ------------------ | -------------------------------- | ---------------- | -------------------------- |
    | create(cmd)            | CreateRoleCommand       | PlatformCustomRole | 角色编码唯一，UP角色数量未达上限 | 角色创建完成     | RoleCreatedEvent           |
    | updateInfo(cmd)        | UpdateRoleCommand       | void               | 角色存在且非预置                 | 角色信息更新完成 | RoleUpdatedEvent           |
    | configurePermissions() | Set<Long> permissionIds | void               | 所有权限属于provider侧           | 角色权限更新完成 | RolePermissionChangedEvent |
    | disable()              | -                       | void               | 角色为启用状态                   | 角色被禁用       | RoleDisabledEvent          |
    | enable()               | -                       | void               | 角色为禁用状态                   | 角色被启用       | RoleEnabledEvent           |
    | delete()               | -                       | void               | 无用户引用此角色                 | 角色被软删除     | RoleDeletedEvent           |

    表 6.3.5.2-2 PlatformCustomRole业务方法

+   聚合规则与约束：
    -   PlatformCustomRole 仅面向运营用户群（UP），userPool 固定为 "UP"
    -   角色编码全局唯一，遵守 ROLE-R-01 规则
    -   关联权限必须属于 provider 侧（ROLE-R-02 权限用户侧一致性）
    -   删除前需校验无用户角色关联（UserRole 中无引用）
    -   与 PlatformRole 的区别：PlatformRole 为系统预置、不可修改删除；PlatformCustomRole 为管理员自建、可增删改

### 6.3.6 TenantRole 聚合（租户角色）

+   TenantRole聚合管理租户自定义角色，存储在租户独立库。

#### 6.3.6.1 聚合结构

+   TenantRole聚合包含以下元素：

    | 元素类型 | 元素名称   | 说明           |
    | -------- | ---------- | -------------- |
    | 聚合根   | TenantRole | 租户自定义角色 |
    | 值对象   | DataScope  | 数据权限范围   |
    | 值对象   | RoleStatus | 角色状态       |

    表 6.3.6.1-1 TenantRole聚合结构

#### 6.3.6.2 TenantRole 实体

+   TenantRole是聚合根，管理租户自定义角色，存储在租户独立库，采用三表模型定义如下。

##### 属性清单表

| 属性名        | 类型       | 约束                       | 默认值    | 业务含义                                        |
| ------------- | ---------- | -------------------------- | --------- | ----------------------------------------------- |
| id            | Long       | 必填，主键                 | 自增      | 角色唯一标识                                    |
| roleCode      | String     | 必填，租户内唯一，长度3-32 | -         | 角色编码，创建后不可修改                        |
| roleName      | String     | 必填，长度2-64             | -         | 角色名称                                        |
| dataScope     | DataScope  | 必填，枚举                 | SELF_ONLY | 数据权限范围                                    |
| permissionIds | List<Long> | 必填                       | []        | 关联的权限ID列表（跨库引用platform_permission） |
| description   | String     | 可选，长度≤256             | null      | 角色描述                                        |
| sortOrder     | Integer    | 必填                       | 0         | 排序号                                          |
| status        | RoleStatus | 必填，枚举                 | ENABLED   | 角色状态：ENABLED/DISABLED/DELETED              |
| createdBy     | Long       | 必填，不可变               | -         | 创建人ID                                        |
| createdAt     | DateTime   | 必填，不可变               | NOW()     | 创建时间                                        |
| updatedBy     | Long       | 可选                       | null      | 最后更新人ID                                    |
| updatedAt     | DateTime   | 必填                       | NOW()     | 更新时间                                        |

表 6.3.6.2-1 TenantRole属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                         | 验证时机 | 违反后果 |
| -------- | ---------------- | ------------------------------------------------ | -------- | -------- |
| TR-R-01  | 编码租户内唯一   | roleCode在租户内唯一                             | 创建     | 拒绝操作 |
| TR-R-02  | 编码不可变       | 创建后roleCode不可修改                           | 更新     | 拒绝操作 |
| TR-R-03  | 权限必须为UR群   | permissionIds只能选择userPool=UR的权限           | 配置权限 | 拒绝操作 |
| TR-R-04  | 权限必须存在有效 | permissionIds中的权限必须存在且status=ENABLED    | 配置权限 | 拒绝操作 |
| TR-R-05  | 删除检查用户引用 | 删除角色前检查是否有用户关联，有则提示先解除     | 删除     | 拒绝操作 |
| TR-R-06  | 禁用不影响已分配 | 禁用角色不影响已分配用户权限，但不可再分配新用户 | 禁用     | -        |
| TR-R-07  | 角色数量上限     | 租户自定义角色数量不超过100个（可配置）          | 创建     | 拒绝操作 |
| TR-R-08  | 权限变更清缓存   | 角色权限变更后，需清除所有关联用户的权限缓存     | 配置权限 | -        |

表 6.3.6.2-2 TenantRole业务规则表

##### 业务方法表

| 方法名                 | 方法简述                        | 关联规则      | 异常                       | 事件                       |
| ---------------------- | ------------------------------- | ------------- | -------------------------- | -------------------------- |
| create()               | 创建租户自定义角色              | TR-R-01,07    | RoleCodeDuplicateException | RoleCreatedEvent           |
| updateInfo()           | 更新角色名称、描述等            | TR-R-02       | RoleCodeImmutableException | RoleUpdatedEvent           |
| configurePermissions() | 配置角色权限列表                | TR-R-03,04,08 | InvalidPermissionException | RolePermissionChangedEvent |
| disable()              | 禁用角色                        | TR-R-06       | -                          | RoleDisabledEvent          |
| enable()               | 启用已禁用的角色                | -             | -                          | RoleEnabledEvent           |
| delete()               | 逻辑删除角色                    | TR-R-05       | RoleInUseException         | RoleDeletedEvent           |
| hasPermission()        | 判断角色是否拥有指定权限        | -             | -                          | -                          |
| isSystemRole()         | 判断是否系统角色，始终返回false | -             | -                          | -                          |

表 6.3.6.2-3 TenantRole业务方法表

+   备注：
    -   租户自定义角色存储在租户独立库tenant_role表，数据天然隔离
    -   permissionIds跨库引用平台库的权限定义，通过ID关联
    -   租户管理员可完全控制自定义角色的创建、修改、删除

### 6.3.7 UserRole 聚合（用户角色）

+   UserRole聚合管理用户与角色的关联关系。

#### 6.3.7.1 聚合结构

+   UserRole聚合包含以下元素：

    | 元素类型 | 元素名称 | 说明                    |
    | -------- | -------- | ----------------------- |
    | 聚合根   | UserRole | 用户角色关联实体        |
    | 值对象   | RoleType | 角色类型（系统/自定义） |

    表 6.3.7.1-1 UserRole聚合结构

#### 6.3.7.2 UserRole 实体

+   UserRole是聚合根，管理用户与角色的关联关系，采用三表模型定义如下。

##### 属性清单表

| 属性名    | 类型     | 约束                                         | 默认值 | 业务含义                |
| --------- | -------- | -------------------------------------------- | ------ | ----------------------- |
| id        | Long     | 必填，主键                                   | 自增   | 关联记录唯一标识        |
| userId    | Long     | 必填，联合唯一(userId+roleId+roleType)       | -      | 用户ID                  |
| roleId    | Long     | 必填，联合唯一(userId+roleId+roleType)       | -      | 角色ID                  |
| roleType  | RoleType | 必填，枚举，联合唯一(userId+roleId+roleType) | -      | 角色类型：SYSTEM/CUSTOM |
| createdBy | Long     | 必填，不可变                                 | -      | 分配人ID                |
| createdAt | DateTime | 必填，不可变                                 | NOW()  | 分配时间                |

表 6.3.7.2-1 UserRole属性清单表

+   RoleType枚举值详细说明如下表所示。

| 枚举值 | 说明           | roleId指向       | 适用用户群 |
| ------ | -------------- | ---------------- | ---------- |
| SYSTEM | 系统预置角色   | platform_role.id | UP/UR/UC   |
| CUSTOM | 租户自定义角色 | tenant_role.id   | 仅UR       |

表 6.3.7.2-2 RoleType枚举值

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                                     | 验证时机  | 违反后果 |
| -------- | ------------ | ------------------------------------------------------------ | --------- | -------- |
| UR-R-01  | 关联唯一     | 同一用户不能重复分配相同的角色（userId+roleId+roleType唯一） | 分配      | 拒绝操作 |
| UR-R-02  | 角色必须有效 | roleId必须引用有效的角色（存在且status=ENABLED）             | 分配      | 拒绝操作 |
| UR-R-03  | 角色互斥检查 | 分配前检查与用户已有角色是否互斥                             | 分配      | 拒绝操作 |
| UR-R-04  | UC仅系统角色 | UC用户群的用户只能分配SYSTEM类型角色                         | 分配      | 拒绝操作 |
| UR-R-05  | 分配清缓存   | 分配或移除角色后，清除用户的权限缓存                         | 分配/移除 | -        |
| UR-R-06  | 审计日志     | 角色分配和移除操作必须记录审计日志                           | 分配/移除 | -        |

表 6.3.7.2-3 UserRole业务规则表

##### 业务方法表

| 方法名        | 方法简述         | 关联规则               | 异常                  | 事件                  |
| ------------- | ---------------- | ---------------------- | --------------------- | --------------------- |
| assign()      | 为用户分配角色   | UR-R-01,02,03,04,05,06 | RoleConflictException | UserRoleAssignedEvent |
| revoke()      | 移除用户角色     | UR-R-05,06             | -                     | UserRoleRevokedEvent  |
| batchAssign() | 批量分配多个角色 | UR-R-01,02,03,04       | RoleConflictException | UserRoleAssignedEvent |
| batchRevoke() | 批量移除多个角色 | UR-R-05,06             | -                     | UserRoleRevokedEvent  |

表 6.3.7.2-4 UserRole业务方法表

+   备注：
    -   UserRole存储在用户所在的数据库（UP在平台库，UR在租户库，UC在个人库）
    -   系统预置角色（SYSTEM）跨库引用platform_role，自定义角色（CUSTOM）引用本库tenant_role
    -   一个用户可同时拥有系统预置角色和租户自定义角色，权限取并集

### 6.3.8 UserDataAccess 聚合（数据授权）

+   UserDataAccess聚合管理跨部门数据访问授权，仅适用于租户用户群。

#### 6.3.8.1 聚合结构

+   UserDataAccess聚合包含以下元素：

    | 元素类型 | 元素名称       | 说明         |
    | -------- | -------------- | ------------ |
    | 聚合根   | UserDataAccess | 数据授权实体 |
    | 值对象   | AccessTarget   | 授权目标     |
    | 值对象   | AccessScope    | 访问范围     |
    | 值对象   | ApprovalStatus | 审批状态     |

    表 6.3.8.1-1 UserDataAccess聚合结构

#### 6.3.8.2 UserDataAccess 实体

+   UserDataAccess是聚合根，管理跨部门数据访问授权（仅租户用户群），采用三表模型定义如下。

##### 属性清单表

| 属性名         | 类型           | 约束           | 默认值  | 业务含义                                     |
| -------------- | -------------- | -------------- | ------- | -------------------------------------------- |
| id             | Long           | 必填，主键     | 自增    | 授权记录唯一标识                             |
| userId         | Long           | 必填           | -       | 被授权用户ID                                 |
| target         | AccessTarget   | 必填           | -       | 授权目标值对象                               |
| accessScope    | AccessScope    | 必填，枚举     | READ    | 访问范围：READ只读/WRITE读写                 |
| expireTime     | DateTime       | 可选           | null    | 过期时间，null表示永久有效                   |
| grantReason    | String         | 可选，长度≤256 | null    | 授权原因/事由                                |
| grantedBy      | Long           | 必填，不可变   | -       | 授权申请人/发起人ID                          |
| approvalStatus | ApprovalStatus | 必填，枚举     | PENDING | 审批状态：PENDING/APPROVED/REJECTED/EXEMPTED |
| approvalId     | String         | 可选，长度≤64  | null    | 审批流程ID（关联BC-14工作流引擎上下文）      |
| approvedBy     | Long           | 可选           | null    | 审批人ID                                     |
| approvedAt     | DateTime       | 可选           | null    | 审批时间                                     |
| rejectReason   | String         | 可选，长度≤256 | null    | 拒绝原因（REJECTED时填写）                   |
| status         | StatusEnum     | 必填，枚举     | ACTIVE  | 状态：ACTIVE有效/REVOKED已撤销               |
| revokedBy      | Long           | 可选           | null    | 撤销人ID                                     |
| revokedAt      | DateTime       | 可选           | null    | 撤销时间                                     |
| createdAt      | DateTime       | 必填，不可变   | NOW()   | 创建时间                                     |
| updatedAt      | DateTime       | 必填           | NOW()   | 更新时间                                     |

表 6.3.8.2-1 UserDataAccess属性清单表

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                                     | 验证时机  | 违反后果 |
| -------- | -------------- | ------------------------------------------------------------ | --------- | -------- |
| DA-R-01  | 审批后生效     | approvalStatus=APPROVED或EXEMPTED且status=ACTIVE时授权生效   | 权限检查  | -        |
| DA-R-02  | 过期自动失效   | expireTime不为null且expireTime < NOW时授权失效               | 权限检查  | -        |
| DA-R-03  | 审批流程触发   | targetType=DEPT且跨部门时需触发审批流程                      | 创建      | 等待审批 |
| DA-R-04  | 免审批场景     | 上级对下级部门授权可免审批，设置approvalStatus=EXEMPTED      | 创建      | -        |
| DA-R-05  | 不可重复授权   | 同一userId+targetType+targetId不能有多条ACTIVE记录           | 创建      | 拒绝操作 |
| DA-R-06  | 撤销后不可恢复 | 授权撤销后不可恢复，需重新申请                               | 撤销      | -        |
| DA-R-07  | 审批回调更新   | 审批完成后通过回调更新approvalStatus、approvedBy、approvedAt | 审批回调  | -        |
| DA-R-08  | 清缓存         | 授权生效或撤销后，清除被授权用户的数据权限缓存               | 生效/撤销 | -        |

表 6.3.8.2-2 UserDataAccess业务规则表

##### 业务方法表

| 方法名         | 方法简述             | 关联规则      | 异常                     | 事件                    |
| -------------- | -------------------- | ------------- | ------------------------ | ----------------------- |
| create()       | 创建数据授权申请     | DA-R-03,04,05 | DuplicateAccessException | DataAccessCreatedEvent  |
| approve()      | 审批通过             | DA-R-01,07,08 | InvalidStatusException   | DataAccessGrantedEvent  |
| reject()       | 审批拒绝             | DA-R-07       | InvalidStatusException   | DataAccessRejectedEvent |
| revoke()       | 撤销授权             | DA-R-06,08    | InvalidStatusException   | DataAccessRevokedEvent  |
| isEffective()  | 判断授权是否当前有效 | DA-R-01,02    | -                        | -                       |
| isExpired()    | 判断授权是否已过期   | DA-R-02       | -                        | -                       |
| needApproval() | 判断是否需要审批     | DA-R-03,04    | -                        | -                       |
| extend()       | 延长授权有效期       | DA-R-02       | InvalidStatusException   | DataAccessExtendedEvent |

表 6.3.8.2-3 UserDataAccess业务方法表

+   备注：
    -   UserDataAccess仅适用于租户用户群（UR），存储在租户库
    -   审批流程通过BC-14（工作流引擎上下文）实现，本聚合仅记录审批结果
    -   授权生效后，用户对目标数据的访问权限通过DataScopeService计算

#### 6.3.8.3 AccessTarget 值对象

+   AccessTarget值对象封装授权目标，采用三表模型定义如下。

##### 属性清单表

| 属性名     | 类型       | 约束          | 默认值 | 业务含义                      |
| ---------- | ---------- | ------------- | ------ | ----------------------------- |
| targetType | TargetType | 必填，枚举    | -      | 目标类型：DEPT/PROJECT/CUSTOM |
| targetId   | Long       | 必填          | -      | 目标ID，指向具体资源          |
| targetName | String     | 可选，长度≤64 | null   | 目标名称（冗余，便于展示）    |

表 6.3.8.3-1 AccessTarget属性清单表

##### 枚举值表

| 枚举值  | 说明   | targetId指向        | 适用场景       |
| ------- | ------ | ------------------- | -------------- |
| DEPT    | 部门   | org_organization.id | 跨部门数据访问 |
| PROJECT | 项目   | project.id          | 项目组数据访问 |
| CUSTOM  | 自定义 | 自定义资源ID        | 其他场景       |

表 6.3.8.3-2 TargetType枚举值

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                   | 验证时机 | 违反后果 |
| -------- | ------------ | ------------------------------------------ | -------- | -------- |
| AT-R-01  | 目标存在性   | targetId必须指向有效存在的资源             | 创建     | 拒绝操作 |
| AT-R-02  | 名称冗余同步 | targetName从目标资源同步，资源改名时需更新 | 创建     | -        |
| AT-R-03  | 不可变性     | 值对象创建后不可修改                       | -        | -        |

表 6.3.8.3-3 AccessTarget业务规则表

#### 6.3.8.4 ApprovalStatus 值对象

+   ApprovalStatus值对象定义审批状态，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型               | 约束       | 默认值  | 业务含义   |
| ------ | ------------------ | ---------- | ------- | ---------- |
| status | ApprovalStatusEnum | 必填，枚举 | PENDING | 审批状态值 |

表 6.3.8.4-1 ApprovalStatus属性清单表

##### 枚举值及特性表

| 枚举值   | 数值 | 说明   | 是否终态 | 授权生效 | 可流转到           |
| -------- | ---- | ------ | -------- | -------- | ------------------ |
| PENDING  | 0    | 待审批 | 否       | 否       | APPROVED, REJECTED |
| APPROVED | 1    | 已通过 | 是       | 是       | -                  |
| REJECTED | 2    | 已拒绝 | 是       | 否       | -                  |
| EXEMPTED | 3    | 免审批 | 是       | 是       | -                  |

表 6.3.8.4-2 ApprovalStatus枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                     | 验证时机 | 违反后果 |
| -------- | ------------ | -------------------------------------------- | -------- | -------- |
| AS-R-01  | 状态流转约束 | 只能从PENDING流转到APPROVED或REJECTED        | 审批     | 拒绝操作 |
| AS-R-02  | 终态不可变   | APPROVED/REJECTED/EXEMPTED为终态，不可再变更 | 更新     | 拒绝操作 |
| AS-R-03  | 生效条件     | 仅APPROVED或EXEMPTED状态的授权才实际生效     | 权限计算 | -        |
| AS-R-04  | 免审批场景   | 上级对下级部门授权时，自动设置为EXEMPTED     | 创建     | -        |

表 6.3.8.4-3 ApprovalStatus业务规则表

### 6.3.9 领域服务

+   权限管理子领域包含以下领域服务：

    | 服务名称               | 职责         | 说明                         |
    | ---------------------- | ------------ | ---------------------------- |
    | PermissionService      | 权限查询     | 查询用户权限，支持缓存       |
    | RoleService            | 角色管理     | 角色CRUD、权限配置、互斥检查 |
    | UserRoleService        | 用户角色管理 | 分配角色、移除角色           |
    | DataScopeService       | 数据权限计算 | 计算用户数据访问范围         |
    | PermissionCacheService | 权限缓存管理 | 缓存维护、失效处理           |
    | DataAccessService      | 数据授权管理 | 跨部门授权、审批回调         |

    表 6.3.9-1 领域服务清单

#### 6.3.9.1 PermissionService

+   PermissionService负责查询用户权限：

    | 方法名               | 参数                       | 返回值           | 说明                 |
    | -------------------- | -------------------------- | ---------------- | -------------------- |
    | getUserPermissions() | userId, userType, tenantId | Set<String>      | 获取用户权限标识列表 |
    | hasPermission()      | userId, permCode           | boolean          | 判断是否有指定权限   |
    | getPermissionTree()  | userPool                   | List<Permission> | 获取权限树           |
    | getUserMenus()       | userId                     | List<Menu>       | 获取用户菜单列表     |

    表 6.3.9.1-1 PermissionService方法

#### 6.3.9.2 DataScopeService

+   DataScopeService负责计算用户数据访问范围：

    | 方法名                    | 参数          | 返回值          | 说明                   |
    | ------------------------- | ------------- | --------------- | ---------------------- |
    | getEffectiveDataScope()   | userId        | DataScopeResult | 获取生效的数据范围     |
    | mergeDataScopes()         | dataScopes    | Integer         | 合并多角色数据范围     |
    | getAccessibleDeptIds()    | userId, scope | Set<Long>       | 获取可访问的部门ID列表 |
    | buildDataScopeCondition() | userId, alias | String          | 构建SQL条件            |
    | getCustomAccessDeptIds()  | userId        | Set<Long>       | 获取自定义授权部门ID   |

    表 6.3.9.2-1 DataScopeService方法

#### 6.3.9.3 RoleService

+   RoleService负责角色管理：

    | 方法名                 | 参数                  | 返回值     | 说明                         |
    | ---------------------- | --------------------- | ---------- | ---------------------------- |
    | createRole()           | createCmd, userPool   | Role       | 创建自定义角色               |
    | updateRole()           | roleId, updateCmd     | Role       | 更新角色信息                 |
    | deleteRole()           | roleId                | void       | 删除自定义角色（需检查引用） |
    | configurePermissions() | roleId, permissionIds | void       | 配置角色权限                 |
    | checkConflict()        | userId, roleId        | boolean    | 检查角色互斥                 |
    | listRoles()            | userPool, query       | Page<Role> | 分页查询角色列表             |

    表 6.3.9.3-1 RoleService方法

#### 6.3.9.4 UserRoleService

+   UserRoleService负责用户角色管理：

    | 方法名         | 参数            | 返回值         | 说明                       |
    | -------------- | --------------- | -------------- | -------------------------- |
    | assignRole()   | userId, roleId  | void           | 为用户分配角色，含互斥检查 |
    | revokeRole()   | userId, roleId  | void           | 移除用户角色               |
    | batchAssign()  | userId, roleIds | void           | 批量分配角色，含互斥检查   |
    | batchRevoke()  | userId, roleIds | void           | 批量移除角色               |
    | getUserRoles() | userId          | List<UserRole> | 查询用户所有角色           |

    表 6.3.9.4-1 UserRoleService方法

#### 6.3.9.5 PermissionCacheService

+   PermissionCacheService负责权限缓存管理：

    | 方法名                     | 参数                | 返回值      | 说明                             |
    | -------------------------- | ------------------- | ----------- | -------------------------------- |
    | getUserPermissionCache()   | userId              | Set<String> | 获取用户权限缓存（L1→L2→DB）     |
    | putUserPermissionCache()   | userId, permissions | void        | 写入用户权限缓存（L1+L2）        |
    | evictUserPermissionCache() | userId              | void        | 清除指定用户的权限缓存           |
    | evictRoleUsersCache()      | roleId              | void        | 清除角色关联的所有用户的权限缓存 |
    | evictAllCache()            | -                   | void        | 清除全部权限缓存（慎用）         |

    表 6.3.9.5-1 PermissionCacheService方法

#### 6.3.9.6 DataAccessService

+   DataAccessService负责跨部门数据授权管理：

    | 方法名                   | 参数                   | 返回值               | 说明                     |
    | ------------------------ | ---------------------- | -------------------- | ------------------------ |
    | applyDataAccess()        | userId, target, reason | UserDataAccess       | 创建数据授权申请         |
    | approveDataAccess()      | accessId, approvedBy   | void                 | 审批通过数据授权         |
    | rejectDataAccess()       | accessId, reason       | void                 | 审批拒绝数据授权         |
    | revokeDataAccess()       | accessId, revokedBy    | void                 | 撤销已生效的数据授权     |
    | handleApprovalCallback() | accessId, result       | void                 | 处理BC-14审批流程回调    |
    | listUserDataAccess()     | userId, query          | Page<UserDataAccess> | 分页查询用户数据授权列表 |

    表 6.3.9.6-1 DataAccessService方法

### 6.3.10 领域事件

+   权限管理子领域定义以下领域事件：

    | 事件名称                   | 触发时机         | 携带数据                      | 消费者                               |
    | -------------------------- | ---------------- | ----------------------------- | ------------------------------------ |
    | RoleCreatedEvent           | 角色创建成功     | roleId, roleCode, userPool    | 审计服务                             |
    | RoleUpdatedEvent           | 角色信息更新     | roleId, changedFields         | 审计服务                             |
    | RolePermissionChangedEvent | 角色权限变更     | roleId, oldPerms, newPerms    | 缓存服务、审计服务                   |
    | RoleDisabledEvent          | 角色被禁用       | roleId, roleCode              | 审计服务                             |
    | RoleEnabledEvent           | 角色被启用       | roleId, roleCode              | 审计服务                             |
    | RoleDeletedEvent           | 角色删除         | roleId, roleCode              | 缓存服务、审计服务                   |
    | UserRoleAssignedEvent      | 用户角色分配     | userId, roleIds               | 缓存服务、审计服务、通知服务         |
    | UserRoleRevokedEvent       | 用户角色移除     | userId, roleIds               | 缓存服务、审计服务                   |
    | DataAccessCreatedEvent     | 数据授权申请创建 | userId, targetType, targetId  | 审计服务                             |
    | DataAccessGrantedEvent     | 数据授权生效     | userId, targetType, targetId  | 缓存服务、审计服务、通知服务         |
    | DataAccessRejectedEvent    | 数据授权被拒绝   | userId, targetType, targetId  | 审计服务、通知服务                   |
    | DataAccessRevokedEvent     | 数据授权撤销     | userId, targetType, targetId  | 缓存服务、审计服务                   |
    | DataAccessExtendedEvent    | 数据授权延期     | userId, targetType, newExpire | 审计服务                             |
    | PermissionCreatedEvent     | 权限定义创建     | permissionId, permissionCode  | 审计服务                             |
    | PermissionUpdatedEvent     | 权限定义更新     | permissionId, changedFields   | 审计服务                             |
    | PermissionDisabledEvent    | 权限定义禁用     | permissionId, permissionCode  | 审计服务、租户角色服务（跨库一致性） |
    | PermissionEnabledEvent     | 权限定义启用     | permissionId, permissionCode  | 审计服务                             |
    | PermissionDeletedEvent     | 权限定义删除     | permissionId, permissionCode  | 审计服务、租户角色服务（跨库一致性） |

    表 6.3.10-1 领域事件清单

+   **事件驱动缓存失效说明**：
    -   角色权限变更时，需清除该角色所有关联用户的权限缓存
    -   用户角色变更时，仅清除该用户的权限缓存
    -   数据授权变更时，清除该用户的数据权限缓存

### 6.3.11 协作关系

+   本节梳理权限管理子领域与其他子领域及共享服务之间的协作关系，包括领域内协作、跨领域协作和共享服务协作三个层面。

#### 6.3.11.1 领域内协作

+   权限管理子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方            | 被调用方                     | 协作方式 | 触发场景               | 说明                                                        |
    | --------- | ----------------- | ---------------------------- | -------- | ---------------------- | ----------------------------------------------------------- |
    | INTRA-301 | RoleService       | TenantRole（聚合根）         | 方法调用 | 创建租户自定义角色     | 调用TenantRole.create(cmd)，校验编码唯一性和角色数量上限    |
    | INTRA-302 | RoleService       | TenantRole（聚合根）         | 方法调用 | 配置角色权限           | 调用TenantRole.configurePermissions()，校验权限归属和有效性 |
    | INTRA-303 | RoleService       | PlatformCustomRole（聚合根） | 方法调用 | 创建平台自定义角色     | 调用PlatformCustomRole.create(cmd)                          |
    | INTRA-304 | UserRoleService   | UserRole（聚合根）           | 方法调用 | 为用户分配角色         | 调用UserRole.assign()，含互斥检查                           |
    | INTRA-305 | UserRoleService   | UserRole（聚合根）           | 方法调用 | 移除用户角色           | 调用UserRole.revoke()，清除权限缓存                         |
    | INTRA-306 | DataAccessService | UserDataAccess（聚合根）     | 方法调用 | 创建跨部门数据授权申请 | 调用UserDataAccess.create()，判断是否需审批                 |
    | INTRA-307 | DataAccessService | UserDataAccess（聚合根）     | 方法调用 | 审批通过/拒绝          | 调用UserDataAccess.approve()或reject()，更新状态并清除缓存  |
    | INTRA-308 | PermissionService | PermissionCacheService       | 方法调用 | 查询用户权限           | 先查缓存，未命中时查询数据库并回填缓存                      |
    | INTRA-309 | DataScopeService  | PermissionCacheService       | 方法调用 | 计算数据权限范围       | 查询用户数据权限缓存，未命中时计算并回填                    |
    | INTRA-310 | PermissionService | DataScopeService             | 方法调用 | 合并多角色权限         | 调用mergeDataScopes()合并多角色data_scope                   |

    表 6.3.11.1-1 领域内协作关系

#### 6.3.11.2 跨领域协作

+   权限管理子领域与其他子领域的跨领域协作通过事件驱动和RPC调用两种方式实现。

##### 与用户管理子领域（第3章）的协作

+   权限管理与用户管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                           |
    | --------- | ------------------- | -------- | ------------------------------------------- | -------------------------------------------------------------- |
    | CROSS-301 | 用户管理 → 权限管理 | 领域事件 | UserCreated                                 | 用户创建后，权限管理为其分配默认角色（根据用户群和租户配置）   |
    | CROSS-302 | 用户管理 → 权限管理 | 领域事件 | UserDeleted                                 | 用户删除后，权限管理清理该用户的所有角色分配和数据授权         |
    | CROSS-303 | 用户管理 → 权限管理 | 领域事件 | UserDisabled                                | 用户禁用后，权限管理清除该用户的权限缓存（可选：撤销数据授权） |
    | CROSS-304 | 权限管理 → 用户管理 | RPC调用  | UserQueryService.getUserBasicInfoForToken() | 权限管理在角色分配时需查询用户信息以校验用户存在性和所属用户群 |

    表 6.3.11.2-1 与用户管理子领域的协作

+   协作说明：
    -   CROSS-301、302与第3章表3.3.8.2-3中CROSS-021、022为同一组协作的双视角描述，此处从权限管理作为接收方的角度补充
    -   CROSS-303为权限管理被动接收的领域事件，用于维护缓存一致性
    -   CROSS-304为权限管理主动发起的RPC调用，权限管理通过UserQueryService获取用户信息，不直接访问用户管理聚合

##### 与组织管理子领域（第4章）的协作

+   权限管理与组织管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                               | 说明                                                           |
    | --------- | ------------------- | -------- | ------------------------------------------- | -------------------------------------------------------------- |
    | CROSS-311 | 组织管理 → 权限管理 | 领域事件 | OrganizationCreated / OrganizationDeleted   | 组织变更后，权限管理刷新数据权限范围缓存                       |
    | CROSS-312 | 组织管理 → 权限管理 | 领域事件 | AppointmentCreated / AppointmentTransferred | 任职变更后，权限管理刷新用户的数据权限范围缓存                 |
    | CROSS-313 | 权限管理 → 组织管理 | RPC调用  | OrganizationQueryService.getTree()          | 权限管理在配置数据权限范围（data_scope=5自定义）时需查询组织树 |

    表 6.3.11.2-2 与组织管理子领域的协作

+   协作说明：
    -   CROSS-311~313与第4章表4.3.9.2-2中CROSS-111~113为同一组协作的双视角描述
    -   组织架构变更可能影响data_scope=2（本部门及以下）和data_scope=5（自定义范围）的计算结果，需及时刷新缓存

##### 与认证管理子领域（第5章）的协作

+   权限管理与认证管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                       | 说明                                                                         |
    | --------- | ------------------- | -------- | ----------------------------------- | ---------------------------------------------------------------------------- |
    | CROSS-321 | 权限管理 → 认证管理 | RPC调用  | TokenService.validateAccessToken()  | 权限管理在API网关层调用TokenService验证访问令牌，提取用户身份信息            |
    | CROSS-322 | 认证管理 → 权限管理 | 间接依赖 | Token Payload中包含userId、userPool | 认证管理签发的Token中仅携带用户标识，权限管理据此查询权限，二者通过Token解耦 |

    表 6.3.11.2-3 与认证管理子领域的协作

+   协作说明：
    -   CROSS-321、322与第5章表5.3.11.2-2中CROSS-211、212为同一组协作的双视角描述
    -   认证管理与权限管理通过Token解耦：认证管理负责签发和验证Token，权限管理负责基于Token中用户信息查询权限
    -   Token中不包含角色和权限列表（参见6.0节设计约定），避免Token过大和权限变更不及时

##### 与审计管理子领域（第7章）的协作

+   权限管理与审计管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                                   | 说明                                                  |
    | --------- | ------------------- | -------- | ----------------------------------------------- | ----------------------------------------------------- |
    | CROSS-331 | 权限管理 → 审计管理 | 领域事件 | 所有权限管理领域事件                            | 审计子领域订阅表6.3.9-1中的全部事件，记录操作审计日志 |
    | CROSS-332 | 权限管理 → 审计管理 | 领域事件 | UserRoleAssignedEvent / UserRoleRevokedEvent    | 审计子领域额外记录权限变更安全审计日志                |
    | CROSS-333 | 权限管理 → 审计管理 | 领域事件 | DataAccessGrantedEvent / DataAccessRevokedEvent | 审计子领域额外记录数据授权安全审计日志                |

    表 6.3.11.2-4 与审计管理子领域的协作

##### 与配置管理子领域（第9章）的协作

+   权限管理与配置管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                | 说明                                                                                 |
    | --------- | ------------------- | -------- | ---------------------------- | ------------------------------------------------------------------------------------ |
    | CROSS-341 | 权限管理 → 配置管理 | RPC调用  | ConfigService.getEffective() | 获取三级合并后的配置生效值，如角色数量上限、数据授权免审批策略、缓存超时时间等       |
    | CROSS-342 | 权限管理 → 配置管理 | RPC调用  | ConfigService.batchGet()     | 批量获取多个配置键的生效值，如权限缓存TTL、data_scope合并策略等                      |
    | CROSS-343 | 配置管理 → 权限管理 | 领域事件 | TenantConfigChanged          | 租户配置变更后，权限管理域刷新缓存的配置值（如角色数量上限、免审批策略变更即时生效） |

    表 6.3.11.2-5 与配置管理子领域的协作

+   协作说明：
    -   CROSS-341、342对应第9章ConfigService的RPC接口
    -   权限管理使用ConfigService的典型配置键包括：租户自定义角色数量上限、权限缓存TTL、data_scope合并策略、数据授权免审批场景配置等
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口作为基础设施供所有子领域使用，已在此处作为跨领域协作列出

##### 与工作流引擎上下文（BC-14）的协作

+   权限管理与工作流引擎上下文之间的协作关系如下表所示。

    | 协作编号  | 方向             | 协作方式 | 触发事件/接口                | 说明                                                    |
    | --------- | ---------------- | -------- | ---------------------------- | ------------------------------------------------------- |
    | CROSS-351 | 权限管理 → BC-14 | RPC调用  | WorkflowService.startProcess | 数据授权申请需审批时，调用BC-14启动审批流程             |
    | CROSS-352 | BC-14 → 权限管理 | 回调     | 审批完成回调                 | 审批完成后BC-14回调权限管理，更新数据授权记录的审批状态 |

    表 6.3.11.2-6 与工作流引擎上下文（BC-14）的协作

##### 与通知上下文（BC-12）的协作

+   权限管理与通知上下文之间的协作关系如下表所示。

    | 协作编号  | 方向             | 协作方式 | 触发事件/接口           | 说明                                   |
    | --------- | ---------------- | -------- | ----------------------- | -------------------------------------- |
    | CROSS-361 | 权限管理 → BC-12 | 领域事件 | UserRoleAssignedEvent   | 通知上下文发送角色分配通知给被分配用户 |
    | CROSS-362 | 权限管理 → BC-12 | 领域事件 | DataAccessGrantedEvent  | 通知上下文发送数据授权生效通知给申请人 |
    | CROSS-363 | 权限管理 → BC-12 | 领域事件 | DataAccessRejectedEvent | 通知上下文发送数据授权拒绝通知给申请人 |

    表 6.3.11.2-7 与通知上下文（BC-12）的协作

#### 6.3.11.3 共享服务协作

+   权限管理子领域使用的共享服务（第8章）协作关系如下表所示。

    | 协作编号  | 共享服务         | 调用方法             | 调用场景                                   | 参考章节 |
    | --------- | ---------------- | -------------------- | ------------------------------------------ | -------- |
    | SHARE-301 | PermissionLoader | loadAllPermissions() | 应用启动时加载全量权限资源点定义到本地缓存 | 8.6.2    |
    | SHARE-302 | PermissionLoader | refreshCache()       | 权限定义变更后刷新全集群缓存               | 8.6.2    |
    | SHARE-303 | PermissionLoader | isPermissionValid()  | 角色配置权限时校验权限编码是否有效         | 8.6.2    |

    表 6.3.11.3-1 共享服务协作关系

+   共享服务协作说明：
    -   PermissionLoader的方法签名与第8章定义保持一致，详细参数和约束见表8.6.2-1
    -   ConfigService虽定义在配置管理子领域（第9章），但其RPC接口（表9.3.1.3-1）作为基础设施供所有子领域使用，已在6.3.11.2中作为跨领域协作列出
    -   权限管理子领域不直接调用PasswordService、CaptchaService、MfaService，这些共享服务的调用由用户管理子领域（第3章）和认证管理子领域（第5章）承担

## 6.4 接口设计

+   本节设计权限管理子领域的API接口，按用户群分组。
+   接口设计遵循RESTful规范，路径按用户群区分以实现数据源路由。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 6.4.1 接口总览

+   权限管理子领域对外提供REST API、RPC和消息三类接口。

#### 6.4.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明           |
    | -------- | ---- | -------------- |
    | REST API | 39个 | 前端调用       |
    | RPC接口  | 1个  | 微服务内部调用 |
    | 消息接口 | 18个 | 事件发布       |

    表 6.4.1.1-1 接口分类统计

+   说明：
    -   REST API按用户群分为运营用户群权限接口（10个）、租户用户群权限接口（16个）、C端用户群权限接口（2个）、运营用户群权限管理接口-管理员（7个）、运营用户群接口共用查询（4个，权限树等被复用）
    -   RPC接口供认证管理子领域（第5章）通过Feign调用
    -   消息接口通过领域事件发布，事件定义详见表 6.3.9-1

#### 6.4.1.2 REST API清单表

+   权限管理 REST API 清单如下表所示。

    | API编号    | API名称          | 方法   | 路径                                         | 权限                          | 领域方法                                  | 备注             |
    | ---------- | ---------------- | ------ | -------------------------------------------- | ----------------------------- | ----------------------------------------- | ---------------- |
    | P-PERM-01  | 查询权限树       | GET    | /api/v1/up/iam/permissions/tree              | provider:user:permission:list | PermissionQueryService.getTree()          | 支持状态过滤     |
    | P-PERM-02  | 查询角色列表     | GET    | /api/v1/up/iam/roles                         | provider:user:role:list       | PlatformRoleQueryService.list()           | 含预置+自定义    |
    | P-PERM-03  | 查询角色详情     | GET    | /api/v1/up/iam/roles/{id}                    | provider:user:role:detail     | PlatformRoleQueryService.getDetail()      | 含权限列表       |
    | P-PERM-04  | 创建自定义角色   | POST   | /api/v1/up/iam/roles                         | provider:user:role:create     | PlatformCustomRole.create()               | -                |
    | P-PERM-05  | 更新角色信息     | PUT    | /api/v1/up/iam/roles/{id}                    | provider:user:role:update     | PlatformCustomRole.updateInfo()           | 预置角色不可改   |
    | P-PERM-06  | 删除自定义角色   | DELETE | /api/v1/up/iam/roles/{id}                    | provider:user:role:delete     | PlatformCustomRole.delete()               | 预置角色不可删   |
    | P-PERM-07  | 配置角色权限     | PUT    | /api/v1/up/iam/roles/{id}/permissions        | provider:user:role:update     | PlatformCustomRole.configurePermissions() | 全量覆盖         |
    | P-PERM-08  | 为用户分配角色   | POST   | /api/v1/up/iam/users/{userId}/roles          | provider:user:role:assign     | UserRole.assign()                         | 检查互斥规则     |
    | P-PERM-09  | 移除用户角色     | DELETE | /api/v1/up/iam/users/{userId}/roles/{roleId} | provider:user:role:assign     | UserRole.remove()                         | 清除缓存         |
    | P-PERM-10  | 查询用户权限列表 | GET    | /api/v1/up/iam/users/{userId}/permissions    | provider:user:permission:list | PermissionQueryService.getUserPerms()     | 合并所有角色权限 |
    | UR-PERM-01 | 查询权限树       | GET    | /api/v1/ur/iam/permissions/tree              | ur:user:permission:list       | PermissionQueryService.getTree()          | 仅含租户可见权限 |
    | UR-PERM-02 | 查询角色列表     | GET    | /api/v1/ur/iam/roles                         | ur:user:role:list             | TenantRoleQueryService.list()             | 含预置+自定义    |
    | UR-PERM-03 | 查询角色详情     | GET    | /api/v1/ur/iam/roles/{id}                    | ur:user:role:detail           | TenantRoleQueryService.getDetail()        | 含权限和数据范围 |
    | UR-PERM-04 | 创建自定义角色   | POST   | /api/v1/ur/iam/roles                         | ur:user:role:create           | TenantRole.create()                       | 含数据权限范围   |
    | UR-PERM-05 | 更新角色信息     | PUT    | /api/v1/ur/iam/roles/{id}                    | ur:user:role:update           | TenantRole.updateInfo()                   | 预置角色不可改   |
    | UR-PERM-06 | 删除自定义角色   | DELETE | /api/v1/ur/iam/roles/{id}                    | ur:user:role:delete           | TenantRole.delete()                       | 预置角色不可删   |
    | UR-PERM-07 | 配置角色权限     | PUT    | /api/v1/ur/iam/roles/{id}/permissions        | ur:user:role:update           | TenantRole.configurePermissions()         | 全量覆盖         |
    | UR-PERM-08 | 为用户分配角色   | POST   | /api/v1/ur/iam/users/{userId}/roles          | ur:user:role:assign           | UserRole.assign()                         | 检查互斥规则     |
    | UR-PERM-09 | 移除用户角色     | DELETE | /api/v1/ur/iam/users/{userId}/roles/{roleId} | ur:user:role:assign           | UserRole.remove()                         | 清除缓存         |
    | UR-PERM-10 | 查询用户权限列表 | GET    | /api/v1/ur/iam/users/{userId}/permissions    | ur:user:permission:list       | PermissionQueryService.getUserPerms()     | 合并所有角色权限 |
    | UR-PERM-11 | 查询当前用户权限 | GET    | /api/v1/ur/iam/users/me/permissions          | authenticated                 | PermissionQueryService.getMyPerms()       | 前端鉴权用       |
    | UR-PERM-12 | 查询当前用户菜单 | GET    | /api/v1/ur/iam/users/me/menus                | authenticated                 | PermissionQueryService.getMyMenus()       | 含层级结构       |
    | UR-PERM-13 | 申请数据授权     | POST   | /api/v1/ur/iam/data-access                   | ur:data:access:apply          | UserDataAccess.apply()                    | 可触发审批流程   |
    | UR-PERM-14 | 查询授权列表     | GET    | /api/v1/ur/iam/data-access                   | ur:data:access:list           | DataAccessQueryService.list()             | 支持分页         |
    | UR-PERM-15 | 撤销数据授权     | DELETE | /api/v1/ur/iam/data-access/{id}              | ur:data:access:revoke         | UserDataAccess.revoke()                   | 清除缓存         |
    | UR-PERM-16 | 审批数据授权     | PUT    | /api/v1/ur/iam/data-access/{id}/approve      | ur:data:access:approve        | UserDataAccess.approve()                  | 审批后生效       |
    | UC-PERM-01 | 查询当前用户权限 | GET    | /api/v1/uc/iam/users/me/permissions          | authenticated                 | PermissionQueryService.getMyPerms()       | 含订阅级别       |
    | UC-PERM-02 | 查询当前用户配额 | GET    | /api/v1/uc/iam/users/me/quota                | authenticated                 | QuotaService.getMyQuota()                 | 每日重置         |
    | UP-PERM-01 | 查询权限定义列表 | GET    | /api/v1/up/iam/permissions                   | up:permission:list            | PermissionQueryService.list()             | 支持分页和过滤   |
    | UP-PERM-02 | 创建权限定义     | POST   | /api/v1/up/iam/permissions                   | up:permission:create          | Permission.create()                       | 四段式编码       |
    | UP-PERM-03 | 更新权限定义     | PUT    | /api/v1/up/iam/permissions/{id}              | up:permission:update          | Permission.updateInfo()                   | 编码不可变       |
    | UP-PERM-04 | 删除权限定义     | DELETE | /api/v1/up/iam/permissions/{id}              | up:permission:delete          | Permission.disable()                      | 实为禁用         |
    | UP-PERM-05 | 查询角色互斥配置 | GET    | /api/v1/up/iam/role-conflicts                | up:role:conflict:list         | RoleConflictQueryService.list()           | -                |
    | UP-PERM-06 | 创建角色互斥配置 | POST   | /api/v1/up/iam/role-conflicts                | up:role:conflict:create       | RoleConflict.create()                     | 双向互斥         |
    | UP-PERM-07 | 删除角色互斥配置 | DELETE | /api/v1/up/iam/role-conflicts/{id}           | up:role:conflict:delete       | RoleConflict.delete()                     | -                |

    表 6.4.1.2-1 权限管理 REST API 清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   领域方法：关联到第6.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况

#### 6.4.1.3 RPC接口清单表

+   权限管理子领域提供的RPC接口清单如下表所示。

    | 接口编号    | 接口名称             | 调用方        | 接口类型 | 领域方法                              | 说明                                      |
    | ----------- | -------------------- | ------------- | -------- | ------------------------------------- | ----------------------------------------- |
    | RPC-PERM-01 | 查询用户权限标识列表 | BC-10认证子域 | Feign    | PermissionQueryService.getUserPerms() | API网关层鉴权时获取用户的全部权限标识列表 |

    表 6.4.1.3-1 RPC接口清单表

#### 6.4.1.4 消息接口清单表

+   权限管理子领域发布的消息接口清单如下表所示。

    | 接口编号    | 消息名称                   | 消息类型 | Topic      | 触发领域方法                                      | 消费方                    |
    | ----------- | -------------------------- | -------- | ---------- | ------------------------------------------------- | ------------------------- |
    | MSG-PERM-01 | RoleCreatedEvent           | 领域事件 | iam.events | PlatformCustomRole.create() / TenantRole.create() | 审计模块                  |
    | MSG-PERM-02 | RoleUpdatedEvent           | 领域事件 | iam.events | *.updateInfo()                                    | 审计模块                  |
    | MSG-PERM-03 | RolePermissionChangedEvent | 领域事件 | iam.events | *.configurePermissions()                          | 缓存服务、审计模块        |
    | MSG-PERM-04 | RoleDisabledEvent          | 领域事件 | iam.events | *.disable()                                       | 审计模块                  |
    | MSG-PERM-05 | RoleEnabledEvent           | 领域事件 | iam.events | *.enable()                                        | 审计模块                  |
    | MSG-PERM-06 | RoleDeletedEvent           | 领域事件 | iam.events | *.delete()                                        | 缓存服务、审计模块        |
    | MSG-PERM-07 | UserRoleAssignedEvent      | 领域事件 | iam.events | UserRole.assign()                                 | 缓存服务、审计模块、BC-12 |
    | MSG-PERM-08 | UserRoleRevokedEvent       | 领域事件 | iam.events | UserRole.remove()                                 | 缓存服务、审计模块        |
    | MSG-PERM-09 | DataAccessCreatedEvent     | 领域事件 | iam.events | UserDataAccess.apply()                            | 审计模块                  |
    | MSG-PERM-10 | DataAccessGrantedEvent     | 领域事件 | iam.events | UserDataAccess.approve()                          | 缓存服务、审计模块、BC-12 |
    | MSG-PERM-11 | DataAccessRejectedEvent    | 领域事件 | iam.events | UserDataAccess.reject()                           | 审计模块、BC-12           |
    | MSG-PERM-12 | DataAccessRevokedEvent     | 领域事件 | iam.events | UserDataAccess.revoke()                           | 缓存服务、审计模块        |
    | MSG-PERM-13 | DataAccessExtendedEvent    | 领域事件 | iam.events | UserDataAccess.extend()                           | 审计模块                  |
    | MSG-PERM-14 | PermissionCreatedEvent     | 领域事件 | iam.events | Permission.create()                               | 审计模块                  |
    | MSG-PERM-15 | PermissionUpdatedEvent     | 领域事件 | iam.events | Permission.updateInfo()                           | 审计模块                  |
    | MSG-PERM-16 | PermissionDisabledEvent    | 领域事件 | iam.events | Permission.disable()                              | 审计模块、租户角色服务    |
    | MSG-PERM-17 | PermissionEnabledEvent     | 领域事件 | iam.events | Permission.enable()                               | 审计模块                  |
    | MSG-PERM-18 | PermissionDeletedEvent     | 领域事件 | iam.events | Permission.delete()                               | 审计模块、租户角色服务    |

    表 6.4.1.4-1 消息接口清单表

### 6.4.2 RPC接口设计

+   权限管理子领域通过Feign向BC-10认证子域提供内部RPC接口。

#### 6.4.2.1 PermissionFeignClient

+   **PermissionFeignClient 概述**

    | 属性     | 值                                       |
    | -------- | ---------------------------------------- |
    | 接口名称 | PermissionFeignClient                    |
    | 职责     | 供BC-10认证子域（API网关层）查询用户权限 |
    | 服务名   | svc-iam                                  |
    | 路径前缀 | /internal/iam/permissions                |
    | 降级实现 | PermissionFeignClientFallback            |
    | 默认超时 | 3秒                                      |

    表 6.4.2.1-1 PermissionFeignClient概述

+   **方法清单表**

    | 方法                                     | 简述                         | HTTP | 路径                  | 入参                       | 返回         | 超时 | 降级返回   |
    | ---------------------------------------- | ---------------------------- | ---- | --------------------- | -------------------------- | ------------ | ---- | ---------- |
    | getUserPerms(userId, userPool, tenantId) | 查询用户合并后的权限标识列表 | GET  | /users/{userId}/perms | userId, userPool, tenantId | UserPermsDTO | 3秒  | 空权限列表 |

    表 6.4.2.1-2 PermissionFeignClient方法清单表

+   **RPC-PERM-01 getUserPerms 契约**

    | 属性     | 值                                                                                         |
    | -------- | ------------------------------------------------------------------------------------------ |
    | 接口编号 | RPC-PERM-01                                                                                |
    | 调用场景 | API网关层在请求转发前调用，获取当前用户的权限标识列表，用于接口级鉴权（@PreAuthorize校验） |
    | 入参     | userId: Long, userPool: String(UP/UR/UC), tenantId: Long（UR用户必填）                     |
    | 返回类型 | UserPermsDTO                                                                               |
    | 幂等性   | 是（只读查询）                                                                             |

    表 6.4.2.1-3 RPC-PERM-01契约概述

+   **UserPermsDTO 结构**

    | 字段名       | 数据类型     | 说明                                                           |
    | ------------ | ------------ | -------------------------------------------------------------- |
    | userId       | Long         | 用户ID                                                         |
    | userPool     | String       | 用户群标识：UP / UR / UC                                       |
    | permissions  | List<String> | 权限标识列表，如["provider:iam:user:create"]                   |
    | dataScope    | Integer      | 数据权限范围：1-全部/2-本部门及以下/3-本部门/4-仅本人/5-自定义 |
    | customOrgIds | List<Long>   | 自定义数据范围组织ID列表，dataScope=5时有值                    |

    表 6.4.2.1-4 UserPermsDTO字段

#### 6.4.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口         | 降级条件        | 降级返回值                                | 日志级别 | 说明                                               |
    | ------------ | --------------- | ----------------------------------------- | -------- | -------------------------------------------------- |
    | getUserPerms | 超时/服务不可用 | UserPermsDTO(permissions=[], dataScope=4) | WARN     | 降级为仅本人数据权限，功能权限为空（拒绝所有操作） |

    表 6.4.2.2-1 降级策略

+   **降级设计说明**
    -   getUserPerms降级策略偏严格：权限为空意味着用户无法执行任何管理操作，数据权限降级为仅本人，避免越权访问
    -   降级期间用户仍可访问不需要特定权限的接口（如查询当前用户信息等 authenticated 级别接口）
    -   熔断策略：连续5次调用失败后触发熔断，熔断窗口30秒，半开状态允许1个探测请求

### 6.4.3 消息接口设计

+   权限管理子领域通过领域事件发布消息。所有事件共享统一的通道和封装规范。

#### 6.4.3.1 消息通道规范

+   **通道配置**

    | 属性       | 值                    |
    | ---------- | --------------------- |
    | Topic      | iam.events            |
    | 消息格式   | JSON                  |
    | 序列化方式 | Jackson               |
    | 消费模式   | 集群模式（每组一个）  |
    | 重试策略   | 最多3次，间隔指数退避 |
    | 死信队列   | iam.events.dlq        |

    表 6.4.3.1-1 消息通道配置

+   **消息封装规范**

    ```json
    {
      "eventId": "evt_perm_20260126_xxxxx",
      "eventType": "RoleCreatedEvent",
      "timestamp": "2026-01-26T10:00:00Z",
      "source": "svc-iam",
      "data": { ... }
    }
    ```

+   消息封装说明：
    -   eventId：全局唯一事件ID，用于幂等去重，格式为`evt_perm_{日期}_{随机}`
    -   eventType：事件类型名，与表6.3.9-1中的事件名称一致
    -   source：发布源服务名
    -   data：业务数据，具体字段见各事件定义

#### 6.4.3.2 角色管理事件

+   以下事件覆盖角色的创建、更新、权限变更、禁用、启用和删除。

##### MSG-PERM-01 RoleCreatedEvent

+   **消息概述**

    | 属性     | 值                                                                             |
    | -------- | ------------------------------------------------------------------------------ |
    | 消息编号 | MSG-PERM-01                                                                    |
    | 消息名称 | RoleCreatedEvent                                                               |
    | Topic    | iam.events                                                                     |
    | 消费方   | 审计模块                                                                       |
    | 触发时机 | 创建角色成功后（含平台自定义角色PlatformCustomRole和租户自定义角色TenantRole） |

    表 6.4.3.2-1 MSG-PERM-01消息概述

+   **Payload字段说明**

    | 字段名   | 数据类型 | 说明                    |
    | -------- | -------- | ----------------------- |
    | roleId   | Long     | 角色ID                  |
    | roleCode | String   | 角色编码                |
    | roleName | String   | 角色名称                |
    | roleType | String   | 角色类型：PRESET/CUSTOM |
    | userPool | String   | 所属用户群：UP/UR       |
    | tenantId | Long     | 租户ID（UP角色为null）  |

    表 6.4.3.2-2 MSG-PERM-01 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑         | 幂等策略    | 失败处理      |
    | -------- | ---------------- | ----------- | ------------- |
    | 审计模块 | 记录角色创建日志 | eventId去重 | 重试3次后告警 |

    表 6.4.3.2-3 MSG-PERM-01消费方处理

##### MSG-PERM-03 RolePermissionChangedEvent

+   **消息概述**

    | 属性     | 值                         |
    | -------- | -------------------------- |
    | 消息编号 | MSG-PERM-03                |
    | 消息名称 | RolePermissionChangedEvent |
    | Topic    | iam.events                 |
    | 消费方   | 缓存服务、审计模块         |
    | 触发时机 | 角色权限配置变更后         |

    表 6.4.3.2-4 MSG-PERM-03消息概述

+   **Payload字段说明**

    | 字段名   | 数据类型     | 说明               |
    | -------- | ------------ | ------------------ |
    | roleId   | Long         | 角色ID             |
    | roleCode | String       | 角色编码           |
    | userPool | String       | 所属用户群         |
    | tenantId | Long         | 租户ID             |
    | oldPerms | List<String> | 变更前权限编码列表 |
    | newPerms | List<String> | 变更后权限编码列表 |

    表 6.4.3.2-5 MSG-PERM-03 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                               | 幂等策略    | 失败处理      |
    | -------- | -------------------------------------- | ----------- | ------------- |
    | 审计模块 | 记录权限变更审计日志（含变更前后差异） | eventId去重 | 重试3次后告警 |
    | 缓存服务 | 清除该角色所有关联用户的权限缓存       | eventId去重 | 重试3次后告警 |

    表 6.4.3.2-6 MSG-PERM-03消费方处理

##### MSG-PERM-02、04~06 角色变更事件（简表）

+   以下角色变更事件以简表列出差异。

    | 消息编号    | 消息名称          | 触发时机       | 特有Payload字段       | 消费方             |
    | ----------- | ----------------- | -------------- | --------------------- | ------------------ |
    | MSG-PERM-02 | RoleUpdatedEvent  | 角色信息更新后 | roleId, changedFields | 审计模块           |
    | MSG-PERM-04 | RoleDisabledEvent | 角色被禁用后   | roleId, roleCode      | 审计模块           |
    | MSG-PERM-05 | RoleEnabledEvent  | 角色被启用后   | roleId, roleCode      | 审计模块           |
    | MSG-PERM-06 | RoleDeletedEvent  | 角色删除后     | roleId, roleCode      | 缓存服务、审计模块 |

    表 6.4.3.2-7 角色变更事件简表

+   **公共Payload字段**：roleId, userPool, tenantId

+   **跨领域消费方处理说明**
    -   缓存服务消费RoleDeletedEvent：清除该角色所有关联用户的权限缓存，避免已删除角色的权限残留
    -   审计模块消费全部角色事件：记录操作审计日志

#### 6.4.3.3 用户角色分配事件

+   以下事件覆盖用户角色的分配和移除，涉及缓存服务和通知服务跨领域协作。

##### MSG-PERM-07 UserRoleAssignedEvent

+   **消息概述**

    | 属性     | 值                        |
    | -------- | ------------------------- |
    | 消息编号 | MSG-PERM-07               |
    | 消息名称 | UserRoleAssignedEvent     |
    | Topic    | iam.events                |
    | 消费方   | 缓存服务、审计模块、BC-12 |
    | 触发时机 | 为用户分配角色成功后      |

    表 6.4.3.3-1 MSG-PERM-07消息概述

+   **Payload字段说明**

    | 字段名     | 数据类型     | 说明               |
    | ---------- | ------------ | ------------------ |
    | userId     | Long         | 用户ID             |
    | userPool   | String       | 用户群             |
    | tenantId   | Long         | 租户ID             |
    | roleIds    | List<Long>   | 分配的角色ID列表   |
    | roleCodes  | List<String> | 分配的角色编码列表 |
    | assignedBy | Long         | 操作人ID           |
    | assignedAt | DateTime     | 分配时间           |

    表 6.4.3.3-2 MSG-PERM-07 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                     | 幂等策略    | 失败处理      |
    | -------- | ---------------------------- | ----------- | ------------- |
    | 审计模块 | 记录角色分配安全审计日志     | eventId去重 | 重试3次后告警 |
    | 缓存服务 | 清除该用户的权限缓存         | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送角色分配通知给被分配用户 | eventId去重 | 重试3次后告警 |

    表 6.4.3.3-3 MSG-PERM-07消费方处理

##### MSG-PERM-08 UserRoleRevokedEvent

+   **消息概述**

    | 属性     | 值                   |
    | -------- | -------------------- |
    | 消息编号 | MSG-PERM-08          |
    | 消息名称 | UserRoleRevokedEvent |
    | Topic    | iam.events           |
    | 消费方   | 缓存服务、审计模块   |
    | 触发时机 | 移除用户角色成功后   |

    表 6.4.3.3-4 MSG-PERM-08消息概述

+   **Payload字段说明**

    | 字段名    | 数据类型     | 说明               |
    | --------- | ------------ | ------------------ |
    | userId    | Long         | 用户ID             |
    | userPool  | String       | 用户群             |
    | tenantId  | Long         | 租户ID             |
    | roleIds   | List<Long>   | 移除的角色ID列表   |
    | roleCodes | List<String> | 移除的角色编码列表 |
    | revokedBy | Long         | 操作人ID           |
    | revokedAt | DateTime     | 移除时间           |

    表 6.4.3.3-5 MSG-PERM-08 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                 | 幂等策略    | 失败处理      |
    | -------- | ------------------------ | ----------- | ------------- |
    | 审计模块 | 记录角色移除安全审计日志 | eventId去重 | 重试3次后告警 |
    | 缓存服务 | 清除该用户的权限缓存     | eventId去重 | 重试3次后告警 |

    表 6.4.3.3-6 MSG-PERM-08消费方处理

#### 6.4.3.4 数据授权事件

+   以下事件覆盖数据授权的申请、生效、拒绝、撤销和延期。

    | 消息编号    | 消息名称                | 触发时机     | Payload字段（data部分）                            | 消费方                    |
    | ----------- | ----------------------- | ------------ | -------------------------------------------------- | ------------------------- |
    | MSG-PERM-09 | DataAccessCreatedEvent  | 授权申请创建 | userId, targetType, targetId, requestedAt          | 审计模块                  |
    | MSG-PERM-10 | DataAccessGrantedEvent  | 授权审批通过 | userId, targetType, targetId, grantedAt, expireAt  | 缓存服务、审计模块、BC-12 |
    | MSG-PERM-11 | DataAccessRejectedEvent | 授权被拒绝   | userId, targetType, targetId, rejectedAt, reason   | 审计模块、BC-12           |
    | MSG-PERM-12 | DataAccessRevokedEvent  | 授权被撤销   | userId, targetType, targetId, revokedAt            | 缓存服务、审计模块        |
    | MSG-PERM-13 | DataAccessExtendedEvent | 授权被延期   | userId, targetType, targetId, oldExpire, newExpire | 审计模块                  |

    表 6.4.3.4-1 数据授权事件汇总

+   **MSG-PERM-10 消费方处理契约**

    | 消费方   | 处理逻辑                     | 幂等策略    | 失败处理      |
    | -------- | ---------------------------- | ----------- | ------------- |
    | 审计模块 | 记录数据授权安全审计日志     | eventId去重 | 重试3次后告警 |
    | 缓存服务 | 刷新该用户的数据权限范围缓存 | eventId去重 | 重试3次后告警 |
    | BC-12    | 发送数据授权生效通知给申请人 | eventId去重 | 重试3次后告警 |

    表 6.4.3.4-2 MSG-PERM-10消费方处理

+   **MSG-PERM-12 消费方处理契约**

    | 消费方   | 处理逻辑                 | 幂等策略    | 失败处理      |
    | -------- | ------------------------ | ----------- | ------------- |
    | 审计模块 | 记录数据授权撤销审计日志 | eventId去重 | 重试3次后告警 |
    | 缓存服务 | 清除该用户的数据权限缓存 | eventId去重 | 重试3次后告警 |

    表 6.4.3.4-3 MSG-PERM-12消费方处理

#### 6.4.3.5 权限定义事件

+   以下事件与权限定义的创建、更新、禁用、启用和删除相关。

    | 消息编号    | 消息名称                | 触发时机     | Payload字段（data部分）      | 消费方                 |
    | ----------- | ----------------------- | ------------ | ---------------------------- | ---------------------- |
    | MSG-PERM-14 | PermissionCreatedEvent  | 权限定义创建 | permissionId, permissionCode | 审计模块               |
    | MSG-PERM-15 | PermissionUpdatedEvent  | 权限定义更新 | permissionId, changedFields  | 审计模块               |
    | MSG-PERM-16 | PermissionDisabledEvent | 权限定义禁用 | permissionId, permissionCode | 审计模块、租户角色服务 |
    | MSG-PERM-17 | PermissionEnabledEvent  | 权限定义启用 | permissionId, permissionCode | 审计模块               |
    | MSG-PERM-18 | PermissionDeletedEvent  | 权限定义删除 | permissionId, permissionCode | 审计模块、租户角色服务 |

    表 6.4.3.5-1 权限定义事件汇总

+   **消费方处理契约**（统一）

    | 消费方       | 处理逻辑                                      | 幂等策略    | 失败处理      |
    | ------------ | --------------------------------------------- | ----------- | ------------- |
    | 审计模块     | 记录权限定义操作日志                          | eventId去重 | 重试3次后告警 |
    | 租户角色服务 | 检查并移除租户角色中引用已禁用/删除权限的关联 | eventId去重 | 重试3次后告警 |

    表 6.4.3.5-2 权限定义事件消费方处理

### 6.4.4 REST接口设计

#### 6.4.4.1 运营用户群权限接口（P-PERM）

+   运营用户群权限接口用于管理平台级角色和权限。

##### 6.4.4.1.1 接口清单

+   接口清单如下表：

    | API编号   | API名称          | 方法   | 路径                                         | 权限                          | 领域方法                                  | 备注             |
    | --------- | ---------------- | ------ | -------------------------------------------- | ----------------------------- | ----------------------------------------- | ---------------- |
    | P-PERM-01 | 查询权限树       | GET    | /api/v1/up/iam/permissions/tree              | provider:user:permission:list | PermissionQueryService.getTree()          | 支持状态过滤     |
    | P-PERM-02 | 查询角色列表     | GET    | /api/v1/up/iam/roles                         | provider:user:role:list       | PlatformRoleQueryService.list()           | 含预置+自定义    |
    | P-PERM-03 | 查询角色详情     | GET    | /api/v1/up/iam/roles/{id}                    | provider:user:role:detail     | PlatformRoleQueryService.getDetail()      | 含权限列表       |
    | P-PERM-04 | 创建自定义角色   | POST   | /api/v1/up/iam/roles                         | provider:user:role:create     | PlatformCustomRole.create()               | -                |
    | P-PERM-05 | 更新角色信息     | PUT    | /api/v1/up/iam/roles/{id}                    | provider:user:role:update     | PlatformCustomRole.updateInfo()           | 预置角色不可改   |
    | P-PERM-06 | 删除自定义角色   | DELETE | /api/v1/up/iam/roles/{id}                    | provider:user:role:delete     | PlatformCustomRole.delete()               | 预置角色不可删   |
    | P-PERM-07 | 配置角色权限     | PUT    | /api/v1/up/iam/roles/{id}/permissions        | provider:user:role:update     | PlatformCustomRole.configurePermissions() | 全量覆盖         |
    | P-PERM-08 | 为用户分配角色   | POST   | /api/v1/up/iam/users/{userId}/roles          | provider:user:role:assign     | UserRole.assign()                         | 检查互斥规则     |
    | P-PERM-09 | 移除用户角色     | DELETE | /api/v1/up/iam/users/{userId}/roles/{roleId} | provider:user:role:assign     | UserRole.remove()                         | 清除缓存         |
    | P-PERM-10 | 查询用户权限列表 | GET    | /api/v1/up/iam/users/{userId}/permissions    | provider:user:permission:list | PermissionQueryService.getUserPerms()     | 合并所有角色权限 |

    表 6.4.4.1.1-1 运营用户群权限REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第6.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 6.4.4.1.2 P-PERM-01 查询权限树

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | P-PERM-01                                    |
    | 接口路径   | GET /api/v1/up/iam/permissions/tree          |
    | 功能简述   | 查询运营用户群权限树形结构，用于角色权限配置 |
    | 所需权限   | provider:user:permission:list                |
    | 关联功能   | F-PERM-01 权限管理                           |
    | 关联用例   | UC-PERM-01 管理员查看权限树                  |
    | 关联领域   | PermissionQueryService.getTree()             |
    | 关联规则   | 无                                           |
    | 幂等性     | 是                                           |
    | 关联错误码 | E-400001, E-401001                           |

    表 6.4.4.1.2-1 P-PERM-01契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型   | 必填 | 约束                   | 示例值    | 业务含义   |
    | -------- | ----- | ------ | ---- | ---------------------- | --------- | ---------- |
    | userPool | query | String | 否   | 枚举：UP/UR/UC，默认UP | "UP"      | 用户群过滤 |
    | status   | query | String | 否   | 枚举：ENABLED/DISABLED | "ENABLED" | 状态过滤   |

    表 6.4.4.1.2-2 P-PERM-01请求契约表

+   **响应契约表**

    | 参数名                | 类型   | 必有 | 示例值               | 业务含义   |
    | --------------------- | ------ | ---- | -------------------- | ---------- |
    | code                  | Number | 是   | 200                  | 响应码     |
    | message               | String | 是   | "success"            | 响应消息   |
    | data[]                | Array  | 是   | [...]                | 权限树     |
    | data[].id             | Number | 是   | 2001                 | 权限ID     |
    | data[].permissionCode | String | 是   | "provider:user:list" | 权限标识   |
    | data[].permissionName | String | 是   | "用户列表"           | 权限名称   |
    | data[].permissionType | String | 是   | "MENU"               | 权限类型   |
    | data[].parentId       | Number | 否   | 2002                 | 父权限ID   |
    | data[].path           | String | 否   | "/provider/users"    | 前端路由   |
    | data[].icon           | String | 否   | "user"               | 图标       |
    | data[].sortOrder      | Number | 是   | 10                   | 排序号     |
    | data[].status         | String | 是   | "ENABLED"            | 状态       |
    | data[].children       | Array  | 否   | [...]                | 子权限列表 |

    表 6.4.4.1.2-3 P-PERM-01响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": [
            {
              "id": 2001,
              "permissionCode": "provider:user",
              "permissionName": "用户管理",
              "permissionType": "CATALOG",
              "parentId": null,
              "path": null,
              "icon": "user",
              "sortOrder": 1,
              "status": "ENABLED",
              "children": [
                {
                  "id": 2002,
                  "permissionCode": "provider:user:list",
                  "permissionName": "用户列表",
                  "permissionType": "MENU",
                  "parentId": 2001,
                  "path": "/provider/users",
                  "icon": "list",
                  "sortOrder": 1,
                  "status": "ENABLED",
                  "children": [
                    {
                      "id": 2003,
                      "permissionCode": "provider:user:create",
                      "permissionName": "创建用户",
                      "permissionType": "BUTTON",
                      "parentId": 2002,
                      "path": null,
                      "icon": null,
                      "sortOrder": 1,
                      "status": "ENABLED",
                      "children": []
                    }
                  ]
                }
              ]
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 6.4.4.1.3 P-PERM-02 查询角色列表

+   **契约概述表**

    | 属性       | 值                                             |
    | ---------- | ---------------------------------------------- |
    | API编号    | P-PERM-02                                      |
    | 接口路径   | GET /api/v1/up/iam/roles                       |
    | 功能简述   | 分页查询运营用户群角色列表，含预置和自定义角色 |
    | 所需权限   | provider:user:role:list                        |
    | 关联功能   | F-PERM-02 运营用户群角色查询                   |
    | 关联用例   | UC-PERM-02 管理员查询角色列表                  |
    | 关联领域   | PlatformRoleQueryService.list()                |
    | 关联规则   | 无                                             |
    | 幂等性     | 是                                             |
    | 关联错误码 | E-400001, E-401001                             |

    表 6.4.4.1.3-1 P-PERM-02契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型    | 必填 | 约束                    | 示例值    | 业务含义 |
    | -------- | ----- | ------- | ---- | ----------------------- | --------- | -------- |
    | roleType | query | String  | 否   | 枚举：PRESET/CUSTOM/ALL | "ALL"     | 角色类型 |
    | keyword  | query | String  | 否   | 模糊匹配角色名/编码     | "admin"   | 关键词   |
    | status   | query | String  | 否   | 枚举：ENABLED/DISABLED  | "ENABLED" | 状态     |
    | page     | query | Integer | 否   | ≥1，默认1               | 1         | 页码     |
    | size     | query | Integer | 否   | 1-100，默认20           | 20        | 每页大小 |

    表 6.4.4.1.3-2 P-PERM-02请求契约表

+   **响应契约表**

    | 参数名                  | 类型   | 必有 | 示例值                | 业务含义   |
    | ----------------------- | ------ | ---- | --------------------- | ---------- |
    | code                    | Number | 是   | 200                   | 响应码     |
    | message                 | String | 是   | "success"             | 响应消息   |
    | data.list[]             | Array  | 是   | [...]                 | 角色列表   |
    | data.list[].id          | Number | 是   | 1001                  | 角色ID     |
    | data.list[].roleCode    | String | 是   | "provider_admin"      | 角色编码   |
    | data.list[].roleName    | String | 是   | "平台管理员"          | 角色名称   |
    | data.list[].roleType    | String | 是   | "PRESET"              | 角色类型   |
    | data.list[].description | String | 否   | "系统预置管理员角色"  | 角色描述   |
    | data.list[].status      | String | 是   | "ENABLED"             | 状态       |
    | data.list[].userCount   | Number | 是   | 5                     | 关联用户数 |
    | data.list[].createdAt   | String | 是   | "2026-01-01T00:00:00" | 创建时间   |
    | data.total              | Number | 是   | 10                    | 总记录数   |
    | data.page               | Number | 是   | 1                     | 当前页码   |
    | data.size               | Number | 是   | 20                    | 每页大小   |
    | data.pages              | Number | 是   | 1                     | 总页数     |

    表 6.4.4.1.3-3 P-PERM-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 1001,
                "roleCode": "provider_admin",
                "roleName": "平台管理员",
                "roleType": "PRESET",
                "description": "系统预置管理员角色，拥有所有权限",
                "status": "ENABLED",
                "userCount": 2,
                "createdAt": "2026-01-01T00:00:00"
              },
              {
                "id": 1003,
                "roleCode": "custom_operator",
                "roleName": "运维人员",
                "roleType": "CUSTOM",
                "description": "自定义运维角色",
                "status": "ENABLED",
                "userCount": 3,
                "createdAt": "2026-01-15T10:00:00"
              }
            ],
            "total": 10,
            "page": 1,
            "size": 20,
            "pages": 1
          },
          "timestamp": 1737885600000
        }
        ```

##### 6.4.4.1.4 P-PERM-03 查询角色详情

+   **契约概述表**

    | 属性       | 值                                   |
    | ---------- | ------------------------------------ |
    | API编号    | P-PERM-03                            |
    | 接口路径   | GET /api/v1/up/iam/roles/{id}        |
    | 功能简述   | 查询角色详情，包含权限列表           |
    | 所需权限   | provider:user:role:detail            |
    | 关联功能   | F-PERM-03 运营用户群角色详情查询     |
    | 关联用例   | UC-PERM-03 管理员查看角色详情        |
    | 关联领域   | PlatformRoleQueryService.getDetail() |
    | 关联规则   | 无                                   |
    | 幂等性     | 是                                   |
    | 关联错误码 | E-400001, E-401001, E-404008         |

    表 6.4.4.1.4-1 P-PERM-03契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ------ | ---- | ------ | ------ | -------- |
    | id     | path | Number | 是   | 正整数 | 1001   | 角色ID   |

    表 6.4.4.1.4-2 P-PERM-03请求契约表

+   **响应契约表**

    | 参数名                  | 类型     | 必有 | 示例值                | 业务含义   |
    | ----------------------- | -------- | ---- | --------------------- | ---------- |
    | code                    | Number   | 是   | 200                   | 响应码     |
    | message                 | String   | 是   | "success"             | 响应消息   |
    | data.id                 | Number   | 是   | 1001                  | 角色ID     |
    | data.roleCode           | String   | 是   | "provider_admin"      | 角色编码   |
    | data.roleName           | String   | 是   | "平台管理员"          | 角色名称   |
    | data.roleType           | String   | 是   | "PRESET"              | 角色类型   |
    | data.description        | String   | 否   | "系统预置管理员角色"  | 角色描述   |
    | data.status             | String   | 是   | "ENABLED"             | 状态       |
    | data.permissions        | Object[] | 是   | [...]                 | 权限列表   |
    | data.permissions[].id   | Number   | 是   | 2003                  | 权限ID     |
    | data.permissions[].code | String   | 是   | "user:create"         | 权限编码   |
    | data.permissions[].name | String   | 是   | "创建用户"            | 权限名称   |
    | data.userCount          | Number   | 是   | 5                     | 关联用户数 |
    | data.createdAt          | String   | 是   | "2026-01-01T00:00:00" | 创建时间   |
    | data.updatedAt          | String   | 是   | "2026-01-15T10:00:00" | 更新时间   |

    表 6.4.4.1.4-3 P-PERM-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 1001,
            "roleCode": "provider_admin",
            "roleName": "平台管理员",
            "roleType": "PRESET",
            "description": "系统预置管理员角色，拥有所有权限",
            "status": "ENABLED",
            "permissions": [
              {
                "id": 2003,
                "code": "user:create",
                "name": "创建用户"
              },
              {
                "id": 2005,
                "code": "user:read",
                "name": "查询用户"
              }
            ],
            "userCount": 5,
            "createdAt": "2026-01-01T00:00:00",
            "updatedAt": "2026-01-15T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 6.4.4.1.5 ~ 6.4.4.1.11 运营用户群剩余接口

+   P-PERM-04 至 P-PERM-10 的详细契约设计（契约概述表、请求契约表、响应契约表、Mock示例）保持与原文一致，此处按原文 6.4.2.5 ~ 6.4.2.11 的完整内容纳入，章节编号调整为 6.4.4.1.5 ~ 6.4.4.1.11。

+   各接口契约的变更说明：仅章节编号和表编号按新体系调整（如原"表 6.4.2.5-1"调整为"表 6.4.4.1.5-1"），接口路径、参数、响应、Mock示例等业务内容不变。

#### 6.4.4.2 租户用户群权限接口（UR-PERM）

+   租户用户群权限接口用于管理租户级角色、权限和数据授权。

##### 6.4.4.2.1 接口清单

+   接口清单如下表：

    | API编号    | API名称          | 方法   | 路径                                         | 权限                    | 领域方法                              | 备注             |
    | ---------- | ---------------- | ------ | -------------------------------------------- | ----------------------- | ------------------------------------- | ---------------- |
    | UR-PERM-01 | 查询权限树       | GET    | /api/v1/ur/iam/permissions/tree              | ur:user:permission:list | PermissionQueryService.getTree()      | 仅含租户可见权限 |
    | UR-PERM-02 | 查询角色列表     | GET    | /api/v1/ur/iam/roles                         | ur:user:role:list       | TenantRoleQueryService.list()         | 含预置+自定义    |
    | UR-PERM-03 | 查询角色详情     | GET    | /api/v1/ur/iam/roles/{id}                    | ur:user:role:detail     | TenantRoleQueryService.getDetail()    | 含权限和数据范围 |
    | UR-PERM-04 | 创建自定义角色   | POST   | /api/v1/ur/iam/roles                         | ur:user:role:create     | TenantRole.create()                   | 含数据权限范围   |
    | UR-PERM-05 | 更新角色信息     | PUT    | /api/v1/ur/iam/roles/{id}                    | ur:user:role:update     | TenantRole.updateInfo()               | 预置角色不可改   |
    | UR-PERM-06 | 删除自定义角色   | DELETE | /api/v1/ur/iam/roles/{id}                    | ur:user:role:delete     | TenantRole.delete()                   | 预置角色不可删   |
    | UR-PERM-07 | 配置角色权限     | PUT    | /api/v1/ur/iam/roles/{id}/permissions        | ur:user:role:update     | TenantRole.configurePermissions()     | 全量覆盖         |
    | UR-PERM-08 | 为用户分配角色   | POST   | /api/v1/ur/iam/users/{userId}/roles          | ur:user:role:assign     | UserRole.assign()                     | 检查互斥规则     |
    | UR-PERM-09 | 移除用户角色     | DELETE | /api/v1/ur/iam/users/{userId}/roles/{roleId} | ur:user:role:assign     | UserRole.remove()                     | 清除缓存         |
    | UR-PERM-10 | 查询用户权限列表 | GET    | /api/v1/ur/iam/users/{userId}/permissions    | ur:user:permission:list | PermissionQueryService.getUserPerms() | 合并所有角色权限 |
    | UR-PERM-11 | 查询当前用户权限 | GET    | /api/v1/ur/iam/users/me/permissions          | authenticated           | PermissionQueryService.getMyPerms()   | 前端鉴权用       |
    | UR-PERM-12 | 查询当前用户菜单 | GET    | /api/v1/ur/iam/users/me/menus                | authenticated           | PermissionQueryService.getMyMenus()   | 含层级结构       |
    | UR-PERM-13 | 申请数据授权     | POST   | /api/v1/ur/iam/data-access                   | ur:data:access:apply    | UserDataAccess.apply()                | 可触发审批流程   |
    | UR-PERM-14 | 查询授权列表     | GET    | /api/v1/ur/iam/data-access                   | ur:data:access:list     | DataAccessQueryService.list()         | 支持分页         |
    | UR-PERM-15 | 撤销数据授权     | DELETE | /api/v1/ur/iam/data-access/{id}              | ur:data:access:revoke   | UserDataAccess.revoke()               | 清除缓存         |
    | UR-PERM-16 | 审批数据授权     | PUT    | /api/v1/ur/iam/data-access/{id}/approve      | ur:data:access:approve  | UserDataAccess.approve()              | 审批后生效       |

    表 6.4.4.2.1-1 租户用户群权限REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第6.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 6.4.4.2.2 ~ 6.4.4.2.17 租户用户群各接口契约

+   UR-PERM-01 至 UR-PERM-16 的详细契约设计（契约概述表、请求契约表、响应契约表、Mock示例）保持与原文一致，此处按原文 6.4.3.2 ~ 6.4.3.17 的完整内容纳入，章节编号调整为 6.4.4.2.2 ~ 6.4.4.2.17。

+   各接口契约的变更说明：仅章节编号和表编号按新体系调整（如原"表 6.4.3.2-1"调整为"表 6.4.4.2.2-1"），接口路径、参数、响应、Mock示例等业务内容不变。

#### 6.4.4.3 C端用户群权限接口（UC-PERM）

+   C端用户群权限接口用于查询个人用户的权限和配额信息。

##### 6.4.4.3.1 接口清单

+   接口清单如下表：

    | API编号    | API名称          | 方法 | 路径                                | 权限          | 领域方法                            | 备注       |
    | ---------- | ---------------- | ---- | ----------------------------------- | ------------- | ----------------------------------- | ---------- |
    | UC-PERM-01 | 查询当前用户权限 | GET  | /api/v1/uc/iam/users/me/permissions | authenticated | PermissionQueryService.getMyPerms() | 含订阅级别 |
    | UC-PERM-02 | 查询当前用户配额 | GET  | /api/v1/uc/iam/users/me/quota       | authenticated | QuotaService.getMyQuota()           | 每日重置   |

    表 6.4.4.3.1-1 C端用户群权限REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第6.3节领域模型设计中的聚合方法或应用服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 6.4.4.3.2 ~ 6.4.4.3.3 C端用户群各接口契约

+   UC-PERM-01 至 UC-PERM-02 的详细契约设计（契约概述表、请求契约表、响应契约表、Mock示例）保持与原文一致，此处按原文 6.4.4.2 ~ 6.4.4.3 的完整内容纳入，章节编号调整为 6.4.4.3.2 ~ 6.4.4.3.3。

+   各接口契约的变更说明：仅章节编号和表编号按新体系调整，接口路径、参数、响应、Mock示例等业务内容不变。

#### 6.4.4.4 运营用户群权限管理接口-管理员（UP-PERM）

+   运营用户群权限管理接口用于管理全局权限定义和角色互斥配置，仅限运营方管理员使用。

##### 6.4.4.4.1 接口清单

+   接口清单如下表：

    | API编号    | API名称          | 方法   | 路径                               | 权限                    | 领域方法                        | 备注           |
    | ---------- | ---------------- | ------ | ---------------------------------- | ----------------------- | ------------------------------- | -------------- |
    | UP-PERM-01 | 查询权限定义列表 | GET    | /api/v1/up/iam/permissions         | up:permission:list      | PermissionQueryService.list()   | 支持分页和过滤 |
    | UP-PERM-02 | 创建权限定义     | POST   | /api/v1/up/iam/permissions         | up:permission:create    | Permission.create()             | 四段式编码     |
    | UP-PERM-03 | 更新权限定义     | PUT    | /api/v1/up/iam/permissions/{id}    | up:permission:update    | Permission.updateInfo()         | 编码不可变     |
    | UP-PERM-04 | 删除权限定义     | DELETE | /api/v1/up/iam/permissions/{id}    | up:permission:delete    | Permission.disable()            | 实为禁用       |
    | UP-PERM-05 | 查询角色互斥配置 | GET    | /api/v1/up/iam/role-conflicts      | up:role:conflict:list   | RoleConflictQueryService.list() | -              |
    | UP-PERM-06 | 创建角色互斥配置 | POST   | /api/v1/up/iam/role-conflicts      | up:role:conflict:create | RoleConflict.create()           | 双向互斥       |
    | UP-PERM-07 | 删除角色互斥配置 | DELETE | /api/v1/up/iam/role-conflicts/{id} | up:role:conflict:delete | RoleConflict.delete()           | -              |

    表 6.4.4.4.1-1 运营用户群权限管理接口（管理员）清单

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   领域方法：关联到第6.3节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

##### 6.4.4.4.2 ~ 6.4.4.4.8 管理员各接口契约

+   UP-PERM-01 至 UP-PERM-07 的详细契约设计（契约概述表、请求契约表、响应契约表、Mock示例）保持与原文一致，此处按原文 6.4.5.2 ~ 6.4.5.8 的完整内容纳入，章节编号调整为 6.4.4.4.2 ~ 6.4.4.4.8。

+   各接口契约的变更说明：仅章节编号和表编号按新体系调整，接口路径、参数、响应、Mock示例等业务内容不变。

### 6.4.5 追溯关联表

#### 6.4.5.1 API-功能-用例关联表

+   全部REST API与RPC接口的功能-用例追溯关系如下表所示。

    | API编号     | API名称          | 关联功能编号 | 关联功能名称     | 关联用例编号 | 关联用例名称               |
    | ----------- | ---------------- | ------------ | ---------------- | ------------ | -------------------------- |
    | P-PERM-01   | 查询权限树       | F-PERM-01    | 权限树查询       | UC-PERM-01   | 管理员查看权限树           |
    | P-PERM-02   | 查询角色列表     | F-PERM-02    | 角色列表查询     | UC-PERM-02   | 管理员查询角色列表         |
    | P-PERM-03   | 查询角色详情     | F-PERM-03    | 角色详情查询     | UC-PERM-03   | 管理员查看角色详情         |
    | P-PERM-04   | 创建自定义角色   | F-PERM-04    | 角色创建         | UC-PERM-04   | 管理员创建自定义角色       |
    | P-PERM-05   | 更新角色信息     | F-PERM-05    | 角色编辑         | UC-PERM-05   | 管理员编辑角色信息         |
    | P-PERM-06   | 删除自定义角色   | F-PERM-06    | 角色删除         | UC-PERM-06   | 管理员删除自定义角色       |
    | P-PERM-07   | 配置角色权限     | F-PERM-07    | 角色权限配置     | UC-PERM-07   | 管理员配置角色权限         |
    | P-PERM-08   | 为用户分配角色   | F-PERM-08    | 用户角色分配     | UC-PERM-08   | 管理员为用户分配角色       |
    | P-PERM-09   | 移除用户角色     | F-PERM-09    | 用户角色移除     | UC-PERM-09   | 管理员移除用户角色         |
    | P-PERM-10   | 查询用户权限列表 | F-PERM-10    | 用户权限查询     | UC-PERM-10   | 管理员查看用户权限         |
    | UR-PERM-01  | 查询权限树       | F-PERM-01    | 权限树查询       | UC-PERM-01   | 租户管理员查看权限树       |
    | UR-PERM-02  | 查询角色列表     | F-PERM-02    | 角色列表查询     | UC-PERM-02   | 租户管理员查询角色列表     |
    | UR-PERM-03  | 查询角色详情     | F-PERM-03    | 角色详情查询     | UC-PERM-03   | 租户管理员查看角色详情     |
    | UR-PERM-04  | 创建自定义角色   | F-PERM-04    | 租户角色创建     | UC-PERM-04   | 租户管理员创建角色         |
    | UR-PERM-05  | 更新角色信息     | F-PERM-05    | 租户角色编辑     | UC-PERM-05   | 租户管理员编辑角色信息     |
    | UR-PERM-06  | 删除自定义角色   | F-PERM-06    | 租户角色删除     | UC-PERM-06   | 租户管理员删除自定义角色   |
    | UR-PERM-07  | 配置角色权限     | F-PERM-07    | 租户角色权限配置 | UC-PERM-07   | 租户管理员配置角色权限     |
    | UR-PERM-08  | 为用户分配角色   | F-PERM-08    | 用户角色分配     | UC-PERM-08   | 租户管理员为用户分配角色   |
    | UR-PERM-09  | 移除用户角色     | F-PERM-09    | 用户角色移除     | UC-PERM-09   | 租户管理员移除用户角色     |
    | UR-PERM-10  | 查询用户权限列表 | F-PERM-10    | 用户权限查询     | UC-PERM-10   | 租户管理员查看用户权限     |
    | UR-PERM-11  | 查询当前用户权限 | F-PERM-11    | 个人权限查询     | UC-PERM-11   | 租户用户获取权限列表       |
    | UR-PERM-12  | 查询当前用户菜单 | F-PERM-12    | 个人菜单查询     | UC-PERM-12   | 租户用户获取菜单树         |
    | UR-PERM-13  | 申请数据授权     | F-PERM-13    | 数据授权申请     | UC-PERM-13   | 用户申请跨部门数据权限     |
    | UR-PERM-14  | 查询授权列表     | F-PERM-14    | 数据授权查询     | UC-PERM-14   | 用户查看数据授权列表       |
    | UR-PERM-15  | 撤销数据授权     | F-PERM-15    | 数据授权撤销     | UC-PERM-15   | 管理员撤销数据授权         |
    | UR-PERM-16  | 审批数据授权     | F-PERM-16    | 数据授权审批     | UC-PERM-16   | 管理员审批数据授权         |
    | UC-PERM-01  | 查询当前用户权限 | F-PERM-17    | C端权限查询      | UC-PERM-17   | C端用户获取权限信息        |
    | UC-PERM-02  | 查询当前用户配额 | F-PERM-18    | C端配额查询      | UC-PERM-18   | C端用户查看配额使用情况    |
    | UP-PERM-01  | 查询权限定义列表 | F-PERM-19    | 权限定义查询     | UC-PERM-19   | 平台管理员查询权限定义列表 |
    | UP-PERM-02  | 创建权限定义     | F-PERM-20    | 权限定义创建     | UC-PERM-20   | 平台管理员创建权限定义     |
    | UP-PERM-03  | 更新权限定义     | F-PERM-21    | 权限定义编辑     | UC-PERM-21   | 平台管理员编辑权限定义     |
    | UP-PERM-04  | 删除权限定义     | F-PERM-22    | 权限定义删除     | UC-PERM-22   | 平台管理员删除权限定义     |
    | UP-PERM-05  | 查询角色互斥配置 | F-PERM-23    | 角色互斥查询     | UC-PERM-23   | 平台管理员查看角色互斥配置 |
    | UP-PERM-06  | 创建角色互斥配置 | F-PERM-24    | 角色互斥创建     | UC-PERM-24   | 平台管理员配置角色互斥     |
    | UP-PERM-07  | 删除角色互斥配置 | F-PERM-25    | 角色互斥删除     | UC-PERM-25   | 平台管理员删除角色互斥配置 |
    | RPC-PERM-01 | 查询用户权限标识 | F-RPC-01     | 权限标识查询     | UC-AUTH-01   | API网关层鉴权获取用户权限  |

    表 6.4.5.1-1 API-功能-用例关联表

#### 6.4.5.2 API-领域-权限关联表

+   全部REST API与RPC接口的领域-权限追溯关系如下表所示。

    | API编号     | API名称          | 关联聚合           | 领域方法                                  | 权限标识                      | 权限说明       |
    | ----------- | ---------------- | ------------------ | ----------------------------------------- | ----------------------------- | -------------- |
    | P-PERM-01   | 查询权限树       | -                  | PermissionQueryService.getTree()          | provider:user:permission:list | 查看权限定义   |
    | P-PERM-02   | 查询角色列表     | -                  | PlatformRoleQueryService.list()           | provider:user:role:list       | 查看角色列表   |
    | P-PERM-03   | 查询角色详情     | -                  | PlatformRoleQueryService.getDetail()      | provider:user:role:detail     | 查看角色详情   |
    | P-PERM-04   | 创建自定义角色   | PlatformCustomRole | PlatformCustomRole.create()               | provider:user:role:create     | 创建角色       |
    | P-PERM-05   | 更新角色信息     | PlatformCustomRole | PlatformCustomRole.updateInfo()           | provider:user:role:update     | 更新角色       |
    | P-PERM-06   | 删除自定义角色   | PlatformCustomRole | PlatformCustomRole.delete()               | provider:user:role:delete     | 删除角色       |
    | P-PERM-07   | 配置角色权限     | PlatformCustomRole | PlatformCustomRole.configurePermissions() | provider:user:role:update     | 配置权限       |
    | P-PERM-08   | 为用户分配角色   | UserRole           | UserRole.assign()                         | provider:user:role:assign     | 分配角色       |
    | P-PERM-09   | 移除用户角色     | UserRole           | UserRole.remove()                         | provider:user:role:assign     | 移除角色       |
    | P-PERM-10   | 查询用户权限列表 | -                  | PermissionQueryService.getUserPerms()     | provider:user:permission:list | 查看用户权限   |
    | UR-PERM-01  | 查询权限树       | -                  | PermissionQueryService.getTree()          | ur:user:permission:list       | 查看权限定义   |
    | UR-PERM-02  | 查询角色列表     | -                  | TenantRoleQueryService.list()             | ur:user:role:list             | 查看角色列表   |
    | UR-PERM-03  | 查询角色详情     | -                  | TenantRoleQueryService.getDetail()        | ur:user:role:detail           | 查看角色详情   |
    | UR-PERM-04  | 创建自定义角色   | TenantRole         | TenantRole.create()                       | ur:user:role:create           | 含数据权限范围 |
    | UR-PERM-05  | 更新角色信息     | TenantRole         | TenantRole.updateInfo()                   | ur:user:role:update           | 更新角色       |
    | UR-PERM-06  | 删除自定义角色   | TenantRole         | TenantRole.delete()                       | ur:user:role:delete           | 删除角色       |
    | UR-PERM-07  | 配置角色权限     | TenantRole         | TenantRole.configurePermissions()         | ur:user:role:update           | 配置权限       |
    | UR-PERM-08  | 为用户分配角色   | UserRole           | UserRole.assign()                         | ur:user:role:assign           | 分配角色       |
    | UR-PERM-09  | 移除用户角色     | UserRole           | UserRole.remove()                         | ur:user:role:assign           | 移除角色       |
    | UR-PERM-10  | 查询用户权限列表 | -                  | PermissionQueryService.getUserPerms()     | ur:user:permission:list       | 查看用户权限   |
    | UR-PERM-11  | 查询当前用户权限 | -                  | PermissionQueryService.getMyPerms()       | authenticated                 | 前端鉴权       |
    | UR-PERM-12  | 查询当前用户菜单 | -                  | PermissionQueryService.getMyMenus()       | authenticated                 | 前端菜单渲染   |
    | UR-PERM-13  | 申请数据授权     | UserDataAccess     | UserDataAccess.apply()                    | ur:data:access:apply          | 触发审批流程   |
    | UR-PERM-14  | 查询授权列表     | -                  | DataAccessQueryService.list()             | ur:data:access:list           | 查看授权记录   |
    | UR-PERM-15  | 撤销数据授权     | UserDataAccess     | UserDataAccess.revoke()                   | ur:data:access:revoke         | 撤销授权       |
    | UR-PERM-16  | 审批数据授权     | UserDataAccess     | UserDataAccess.approve()                  | ur:data:access:approve        | 审批后生效     |
    | UC-PERM-01  | 查询当前用户权限 | -                  | PermissionQueryService.getMyPerms()       | authenticated                 | 含订阅级别     |
    | UC-PERM-02  | 查询当前用户配额 | -                  | QuotaService.getMyQuota()                 | authenticated                 | 配额查询       |
    | UP-PERM-01  | 查询权限定义列表 | -                  | PermissionQueryService.list()             | up:permission:list            | 分页查询       |
    | UP-PERM-02  | 创建权限定义     | Permission         | Permission.create()                       | up:permission:create          | 四段式编码     |
    | UP-PERM-03  | 更新权限定义     | Permission         | Permission.updateInfo()                   | up:permission:update          | 编码不可变     |
    | UP-PERM-04  | 删除权限定义     | Permission         | Permission.disable()                      | up:permission:delete          | 实为禁用       |
    | UP-PERM-05  | 查询角色互斥配置 | -                  | RoleConflictQueryService.list()           | up:role:conflict:list         | 查看互斥配置   |
    | UP-PERM-06  | 创建角色互斥配置 | RoleConflict       | RoleConflict.create()                     | up:role:conflict:create       | 双向互斥       |
    | UP-PERM-07  | 删除角色互斥配置 | RoleConflict       | RoleConflict.delete()                     | up:role:conflict:delete       | 删除互斥配置   |
    | RPC-PERM-01 | 查询用户权限标识 | -                  | PermissionQueryService.getUserPerms()     | internal                      | 内部RPC        |

    表 6.4.5.2-1 API-领域-权限关联表

+   权限标识说明：
    -   `authenticated`：需要登录，但无需特定权限
    -   `internal`：内部RPC接口，通过服务间认证
    -   `{四段式权限}`：需要登录且拥有对应权限

#### 6.4.5.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。RPC接口无前端页面，不在此表中。

    | API编号    | API名称          | 关联页面编号  | 页面名称       | 触发组件     | 触发时机      |
    | ---------- | ---------------- | ------------- | -------------- | ------------ | ------------- |
    | P-PERM-01  | 查询权限树       | PG-P-PERM-01  | 权限管理       | 树形组件     | 页面加载      |
    | P-PERM-02  | 查询角色列表     | PG-P-PERM-02  | 角色管理列表页 | 搜索按钮     | 页面加载/搜索 |
    | P-PERM-03  | 查询角色详情     | PG-P-PERM-03  | 角色详情页     | -            | 页面加载      |
    | P-PERM-04  | 创建自定义角色   | PG-P-PERM-04  | 创建角色页     | 提交按钮     | 点击提交      |
    | P-PERM-05  | 更新角色信息     | PG-P-PERM-03  | 角色详情页     | 编辑按钮     | 点击保存      |
    | P-PERM-06  | 删除自定义角色   | PG-P-PERM-02  | 角色管理列表页 | 删除按钮     | 点击确认      |
    | P-PERM-07  | 配置角色权限     | PG-P-PERM-05  | 角色权限配置页 | 保存按钮     | 点击保存      |
    | P-PERM-08  | 为用户分配角色   | PG-P-USR-03   | 用户详情页     | 角色分配按钮 | 点击确认      |
    | P-PERM-09  | 移除用户角色     | PG-P-USR-03   | 用户详情页     | 角色移除按钮 | 点击确认      |
    | P-PERM-10  | 查询用户权限列表 | PG-P-USR-03   | 用户详情页     | 权限Tab      | 页面加载      |
    | UR-PERM-01 | 查询权限树       | PG-UR-PERM-01 | 权限管理       | 树形组件     | 页面加载      |
    | UR-PERM-02 | 查询角色列表     | PG-UR-PERM-02 | 角色管理列表页 | 搜索按钮     | 页面加载/搜索 |
    | UR-PERM-03 | 查询角色详情     | PG-UR-PERM-03 | 角色详情页     | -            | 页面加载      |
    | UR-PERM-04 | 创建自定义角色   | PG-UR-PERM-04 | 创建角色页     | 提交按钮     | 点击提交      |
    | UR-PERM-05 | 更新角色信息     | PG-UR-PERM-03 | 角色详情页     | 编辑按钮     | 点击保存      |
    | UR-PERM-06 | 删除自定义角色   | PG-UR-PERM-02 | 角色管理列表页 | 删除按钮     | 点击确认      |
    | UR-PERM-07 | 配置角色权限     | PG-UR-PERM-05 | 角色权限配置页 | 保存按钮     | 点击保存      |
    | UR-PERM-08 | 为用户分配角色   | PG-UR-USR-03  | 用户详情页     | 角色分配按钮 | 点击确认      |
    | UR-PERM-09 | 移除用户角色     | PG-UR-USR-03  | 用户详情页     | 角色移除按钮 | 点击确认      |
    | UR-PERM-10 | 查询用户权限列表 | PG-UR-USR-03  | 用户详情页     | 权限Tab      | 页面加载      |
    | UR-PERM-11 | 查询当前用户权限 | 全局          | -              | -            | 登录后自动    |
    | UR-PERM-12 | 查询当前用户菜单 | 全局布局      | -              | 菜单组件     | 登录后自动    |
    | UR-PERM-13 | 申请数据授权     | PG-UR-PERM-06 | 数据授权申请页 | 提交按钮     | 点击提交      |
    | UR-PERM-14 | 查询授权列表     | PG-UR-PERM-07 | 数据授权列表页 | 搜索按钮     | 页面加载/搜索 |
    | UR-PERM-15 | 撤销数据授权     | PG-UR-PERM-08 | 授权详情页     | 撤销按钮     | 点击确认      |
    | UR-PERM-16 | 审批数据授权     | PG-UR-PERM-08 | 授权详情页     | 审批按钮     | 点击审批      |
    | UC-PERM-01 | 查询当前用户权限 | 全局          | -              | -            | 登录后自动    |
    | UC-PERM-02 | 查询当前用户配额 | PG-UC-PERM-01 | 配额查看页     | -            | 页面加载      |
    | UP-PERM-01 | 查询权限定义列表 | PG-UP-PERM-01 | 权限定义管理页 | 搜索按钮     | 页面加载/搜索 |
    | UP-PERM-02 | 创建权限定义     | PG-UP-PERM-02 | 创建权限定义页 | 提交按钮     | 点击提交      |
    | UP-PERM-03 | 更新权限定义     | PG-UP-PERM-01 | 权限定义管理页 | 编辑按钮     | 点击保存      |
    | UP-PERM-04 | 删除权限定义     | PG-UP-PERM-01 | 权限定义管理页 | 删除按钮     | 点击确认      |
    | UP-PERM-05 | 查询角色互斥配置 | PG-UP-PERM-03 | 角色互斥配置页 | -            | 页面加载      |
    | UP-PERM-06 | 创建角色互斥配置 | PG-UP-PERM-03 | 角色互斥配置页 | 新增按钮     | 点击新增      |
    | UP-PERM-07 | 删除角色互斥配置 | PG-UP-PERM-03 | 角色互斥配置页 | 删除按钮     | 点击确认      |

    表 6.4.5.3-1 API-页面-组件关联表

+   说明：
    -   关联页面编号对应6.6节前端设计中的页面编号
    -   UR-PERM-11、UR-PERM-12、UC-PERM-01为全局自动调用，无直接关联页面
    -   P-PERM-08/09和UR-PERM-08/09关联到用户详情页（3.6节定义），实现跨模块操作

## 6.5 数据模型设计

+   本节设计权限管理子领域的数据库表结构，按数据库分组。
+   权限相关数据分布在平台库和租户库，遵循数据隔离原则。

### 6.5.1 数据库分布

+   权限管理数据分布在两个数据库：

    | 数据库                   | 存储内容                                         | 用户群 |
    | ------------------------ | ------------------------------------------------ | ------ |
    | clarisphere_platform     | 权限定义、系统角色、平台自定义角色、角色互斥     | UP     |
    | clarisphere_t{tenant_id} | 租户角色、租户用户角色关联、数据授权、部门（读） | UR     |

    表 6.5.1-1 数据库分布

+   权限管理相关表清单如下。

    | 表名                            | 所属数据库               | 说明                     |
    | ------------------------------- | ------------------------ | ------------------------ |
    | platform_permission             | clarisphere_platform     | 权限定义表（全局共享）   |
    | platform_role                   | clarisphere_platform     | 系统预置角色表           |
    | platform_role_permission        | clarisphere_platform     | 系统角色权限关联表       |
    | platform_custom_role            | clarisphere_platform     | 平台自定义角色表         |
    | platform_custom_role_permission | clarisphere_platform     | 平台自定义角色权限关联表 |
    | platform_role_conflict          | clarisphere_platform     | 角色互斥配置表           |
    | platform_provider_user_role     | clarisphere_platform     | 运营用户群用户角色关联表 |
    | tenant_dept                     | clarisphere_t{tenant_id} | 租户部门表（读优化视图） |
    | tenant_role                     | clarisphere_t{tenant_id} | 租户自定义角色表         |
    | tenant_role_permission          | clarisphere_t{tenant_id} | 租户角色权限关联表       |
    | tenant_user_role                | clarisphere_t{tenant_id} | 租户用户角色关联表       |
    | tenant_user_data_access         | clarisphere_t{tenant_id} | 用户数据访问授权表       |

    表 6.5.1-2 权限管理表清单

### 6.5.2 平台库表结构（clarisphere_platform）

#### 6.5.2.1 platform_permission 权限定义表

+   权限定义表存储目录、菜单、按钮三级权限定义，采用树形结构组织，全局共享。

    | 字段名          | 数据类型     | 可空 | 默认值            | 说明                              |
    | --------------- | ------------ | ---- | ----------------- | --------------------------------- |
    | id              | BIGINT       | 否   | AUTO_INCREMENT    | 主键，权限ID                      |
    | parent_id       | BIGINT       | 否   | 0                 | 父级ID，0表示顶级                 |
    | ancestors       | VARCHAR(500) | 是   | ''                | 祖级列表，逗号分隔，如"0,1,10"    |
    | permission_code | VARCHAR(200) | 是   | NULL              | 四段式权限标识，目录级可为空      |
    | permission_name | VARCHAR(100) | 否   | -                 | 权限名称                          |
    | permission_type | TINYINT      | 否   | -                 | 权限类型：1目录 2菜单 3按钮       |
    | user_pool       | VARCHAR(20)  | 是   | NULL              | 用户群：UP/UR/UC                  |
    | context         | VARCHAR(50)  | 是   | NULL              | 限界上下文，如acquisition/landing |
    | resource        | VARCHAR(50)  | 是   | NULL              | 资源名称，如mandate/policy        |
    | action          | VARCHAR(50)  | 是   | NULL              | 操作名称，如create/update/delete  |
    | path            | VARCHAR(200) | 是   | NULL              | 前端路由路径，目录和菜单使用      |
    | component       | VARCHAR(200) | 是   | NULL              | 前端组件路径，仅菜单使用          |
    | redirect        | VARCHAR(200) | 是   | NULL              | 重定向地址                        |
    | icon            | VARCHAR(100) | 是   | NULL              | 图标标识                          |
    | sort_order      | INT          | 否   | 0                 | 排序号                            |
    | visible         | TINYINT      | 否   | 1                 | 是否显示：1是 0否                 |
    | status          | TINYINT      | 否   | 1                 | 状态：1启用 0禁用                 |
    | is_frame        | TINYINT      | 是   | 0                 | 是否外链：1是 0否                 |
    | is_cache        | TINYINT      | 是   | 1                 | 是否缓存：1是 0否                 |
    | remark          | VARCHAR(500) | 是   | NULL              | 备注                              |
    | created_by      | BIGINT       | 是   | NULL              | 创建人                            |
    | created_at      | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                          |
    | updated_by      | BIGINT       | 是   | NULL              | 更新人                            |
    | updated_at      | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                          |
    | deleted         | TINYINT      | 否   | 0                 | 删除标记：0未删除 1已删除         |

    表 6.5.2.1-1 platform_permission 表结构

+   索引设计：

    | 索引名                | 索引字段           | 类型 | 说明                    |
    | --------------------- | ------------------ | ---- | ----------------------- |
    | PRIMARY               | id                 | 主键 | 主键索引                |
    | uk_permission_code    | permission_code    | 唯一 | 权限标识唯一索引        |
    | idx_parent_id         | parent_id          | 普通 | 父级权限查询            |
    | idx_user_pool         | user_pool          | 普通 | 按用户群过滤            |
    | idx_user_pool_context | user_pool, context | 普通 | 按用户群+上下文联合过滤 |
    | idx_permission_type   | permission_type    | 普通 | 按权限类型过滤          |
    | idx_status            | status             | 普通 | 按状态过滤              |

    表 6.5.2.1-2 platform_permission 索引设计

+   **关键字段说明**：
    -   permission_code：完整的四段式权限标识，格式为 {user_pool}:{context}:{resource}:{action}，目录级别可为空
    -   ancestors：祖级ID列表，便于快速查询上级路径
    -   path/component：前端路由相关字段，目录和菜单必填，按钮级为空

#### 6.5.2.2 platform_role 系统预置角色表

+   系统预置角色表存储平台预定义的角色，通过初始化脚本或升级脚本维护，租户不可修改。

    | 字段名     | 数据类型     | 可空 | 默认值            | 说明                                                  |
    | ---------- | ------------ | ---- | ----------------- | ----------------------------------------------------- |
    | id         | BIGINT       | 否   | AUTO_INCREMENT    | 主键，角色ID                                          |
    | role_code  | VARCHAR(50)  | 否   | -                 | 角色编码，如UP-01、UR-01、UC-01                       |
    | role_name  | VARCHAR(100) | 否   | -                 | 角色名称                                              |
    | user_pool  | VARCHAR(20)  | 否   | -                 | 所属用户群：UP/UR/UC                                  |
    | data_scope | TINYINT      | 否   | 4                 | 数据范围：1全部 2本部门及以下 3本部门 4仅本人 5自定义 |
    | status     | TINYINT      | 否   | 1                 | 状态：1启用 0禁用                                     |
    | sort_order | INT          | 否   | 0                 | 排序号                                                |
    | remark     | VARCHAR(500) | 是   | NULL              | 备注                                                  |
    | created_by | BIGINT       | 是   | NULL              | 创建人                                                |
    | created_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                                              |
    | updated_by | BIGINT       | 是   | NULL              | 更新人                                                |
    | updated_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                                              |
    | deleted    | TINYINT      | 否   | 0                 | 删除标记：0未删除 1已删除                             |

    表 6.5.2.2-1 platform_role 表结构

+   索引设计：

    | 索引名        | 索引字段  | 类型 | 说明             |
    | ------------- | --------- | ---- | ---------------- |
    | PRIMARY       | id        | 主键 | 主键索引         |
    | uk_role_code  | role_code | 唯一 | 角色编码唯一索引 |
    | idx_user_pool | user_pool | 普通 | 按用户群过滤     |
    | idx_status    | status    | 普通 | 按状态过滤       |

    表 6.5.2.2-2 platform_role 索引设计

+   **data_scope 字段说明**：

    | 值  | 含义         | SQL条件生成规则                           | 典型角色   |
    | --- | ------------ | ----------------------------------------- | ---------- |
    | 1   | 全部数据     | 无额外条件（租户隔离仍生效）              | CISO       |
    | 2   | 本部门及以下 | 根据用户dept_id，使用Nested Set查询子树   | 部门经理   |
    | 3   | 本部门       | dept_id = 用户所属部门                    | 普通管理员 |
    | 4   | 仅本人       | creator_id = 当前用户ID                   | 执行人     |
    | 5   | 自定义范围   | 查询tenant_user_data_access表获取授权部门 | 跨部门协作 |

    表 6.5.2.2-3 data_scope 字段说明

+   **核心理解**：角色定义「看多大范围」（data_scope类型），用户决定「从哪个点开始算」（用户所属部门dept_id）。同一角色分配给不同部门的人，各自看各自部门的数据。

#### 6.5.2.3 platform_role_permission 系统角色权限关联表

+   系统角色权限关联表存储系统预置角色与权限的多对多关系。

    | 字段名        | 数据类型 | 可空 | 默认值            | 说明                                |
    | ------------- | -------- | ---- | ----------------- | ----------------------------------- |
    | id            | BIGINT   | 否   | AUTO_INCREMENT    | 主键                                |
    | role_id       | BIGINT   | 否   | -                 | 角色ID，引用 platform_role.id       |
    | permission_id | BIGINT   | 否   | -                 | 权限ID，引用 platform_permission.id |
    | created_by    | BIGINT   | 是   | NULL              | 创建人                              |
    | created_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 创建时间                            |
    | updated_by    | BIGINT   | 是   | NULL              | 更新人                              |
    | updated_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 更新时间                            |

    表 6.5.2.3-1 platform_role_permission 表结构

+   索引设计：

    | 索引名             | 索引字段               | 类型 | 说明                 |
    | ------------------ | ---------------------- | ---- | -------------------- |
    | PRIMARY            | id                     | 主键 | 主键索引             |
    | uk_role_permission | role_id, permission_id | 唯一 | 角色-权限唯一约束    |
    | idx_permission_id  | permission_id          | 普通 | 按权限ID反查关联角色 |

    表 6.5.2.3-2 platform_role_permission 索引设计

#### 6.5.2.4 platform_custom_role 平台自定义角色表

+   平台自定义角色表存储运营用户群（UP）管理员根据业务需要创建的可变角色，与系统预置角色（不可变）互补。

    | 字段名     | 数据类型     | 可空 | 默认值            | 说明                      |
    | ---------- | ------------ | ---- | ----------------- | ------------------------- |
    | id         | BIGINT       | 否   | AUTO_INCREMENT    | 主键，角色ID              |
    | role_code  | VARCHAR(50)  | 否   | -                 | 角色编码                  |
    | role_name  | VARCHAR(100) | 否   | -                 | 角色名称                  |
    | user_pool  | VARCHAR(20)  | 否   | 'UP'              | 用户群，固定为UP          |
    | status     | TINYINT      | 否   | 1                 | 状态：1启用 0禁用         |
    | sort_order | INT          | 否   | 0                 | 排序号                    |
    | remark     | VARCHAR(500) | 是   | NULL              | 备注                      |
    | created_by | BIGINT       | 是   | NULL              | 创建人                    |
    | created_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                  |
    | updated_by | BIGINT       | 是   | NULL              | 更新人                    |
    | updated_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                  |
    | deleted    | TINYINT      | 否   | 0                 | 删除标记：0未删除 1已删除 |

    表 6.5.2.4-1 platform_custom_role 表结构

+   索引设计：

    | 索引名        | 索引字段  | 类型 | 说明             |
    | ------------- | --------- | ---- | ---------------- |
    | PRIMARY       | id        | 主键 | 主键索引         |
    | uk_role_code  | role_code | 唯一 | 角色编码唯一索引 |
    | idx_user_pool | user_pool | 普通 | 按用户群过滤     |
    | idx_status    | status    | 普通 | 按状态过滤       |

    表 6.5.2.4-2 platform_custom_role 索引设计

+   **与 platform_role 的区别**：平台自定义角色不含 data_scope 字段，因运营用户群（UP）无部门概念，不涉及数据权限范围。

#### 6.5.2.5 platform_custom_role_permission 平台自定义角色权限关联表

+   平台自定义角色权限关联表存储平台自定义角色与权限的多对多关系。

    | 字段名        | 数据类型 | 可空 | 默认值            | 说明                                 |
    | ------------- | -------- | ---- | ----------------- | ------------------------------------ |
    | id            | BIGINT   | 否   | AUTO_INCREMENT    | 主键                                 |
    | role_id       | BIGINT   | 否   | -                 | 角色ID，引用 platform_custom_role.id |
    | permission_id | BIGINT   | 否   | -                 | 权限ID，引用 platform_permission.id  |
    | created_by    | BIGINT   | 是   | NULL              | 创建人                               |
    | created_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 创建时间                             |
    | updated_by    | BIGINT   | 是   | NULL              | 更新人                               |
    | updated_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 更新时间                             |

    表 6.5.2.5-1 platform_custom_role_permission 表结构

+   索引设计：

    | 索引名             | 索引字段               | 类型 | 说明                 |
    | ------------------ | ---------------------- | ---- | -------------------- |
    | PRIMARY            | id                     | 主键 | 主键索引             |
    | uk_role_permission | role_id, permission_id | 唯一 | 角色-权限唯一约束    |
    | idx_permission_id  | permission_id          | 普通 | 按权限ID反查关联角色 |

    表 6.5.2.5-2 platform_custom_role_permission 索引设计

#### 6.5.2.6 platform_role_conflict 角色互斥配置表

+   角色互斥配置表定义不能同时分配给同一用户的角色组合，满足合规审计要求。

    | 字段名        | 数据类型     | 可空 | 默认值            | 说明                                          |
    | ------------- | ------------ | ---- | ----------------- | --------------------------------------------- |
    | id            | BIGINT       | 否   | AUTO_INCREMENT    | 主键                                          |
    | role_a_id     | BIGINT       | 否   | -                 | 互斥角色A的ID，约定 role_a_id < role_b_id     |
    | role_b_id     | BIGINT       | 否   | -                 | 互斥角色B的ID                                 |
    | conflict_type | VARCHAR(20)  | 否   | 'MUTUAL'          | 互斥类型：MUTUAL双向互斥/ONE_WAY单向互斥      |
    | scope_type    | VARCHAR(20)  | 否   | 'GLOBAL'          | 范围类型：GLOBAL全局/TENANT租户级（V2.0预留） |
    | status        | TINYINT      | 否   | 1                 | 状态：1启用 0禁用                             |
    | remark        | VARCHAR(500) | 是   | NULL              | 互斥原因说明，用于提示和审计                  |
    | created_by    | BIGINT       | 是   | NULL              | 创建人                                        |
    | created_at    | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                                      |
    | updated_by    | BIGINT       | 是   | NULL              | 更新人                                        |
    | updated_at    | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                                      |

    表 6.5.2.6-1 platform_role_conflict 表结构

+   索引设计：

    | 索引名       | 索引字段             | 类型 | 说明           |
    | ------------ | -------------------- | ---- | -------------- |
    | PRIMARY      | id                   | 主键 | 主键索引       |
    | uk_role_pair | role_a_id, role_b_id | 唯一 | 角色对唯一约束 |
    | idx_role_a   | role_a_id            | 普通 | 按角色A查询    |
    | idx_role_b   | role_b_id            | 普通 | 按角色B查询    |

    表 6.5.2.6-2 platform_role_conflict 索引设计

#### 6.5.2.7 platform_provider_user_role 运营用户群用户角色关联表

+   运营用户群用户角色关联表存储UP用户与角色的关联关系。

    | 字段名     | 数据类型    | 可空 | 默认值            | 说明                                      |
    | ---------- | ----------- | ---- | ----------------- | ----------------------------------------- |
    | id         | BIGINT      | 否   | AUTO_INCREMENT    | 主键                                      |
    | user_id    | BIGINT      | 否   | -                 | 运营用户群用户ID                          |
    | role_id    | BIGINT      | 否   | -                 | 角色ID                                    |
    | role_type  | VARCHAR(20) | 否   | -                 | 角色类型：SYSTEM系统预置/CUSTOM平台自定义 |
    | created_by | BIGINT      | 是   | NULL              | 创建人                                    |
    | created_at | DATETIME    | 否   | CURRENT_TIMESTAMP | 创建时间                                  |
    | updated_by | BIGINT      | 是   | NULL              | 更新人                                    |
    | updated_at | DATETIME    | 否   | CURRENT_TIMESTAMP | 更新时间                                  |

    表 6.5.2.7-1 platform_provider_user_role 表结构

+   索引设计：

    | 索引名       | 索引字段                    | 类型 | 说明                   |
    | ------------ | --------------------------- | ---- | ---------------------- |
    | PRIMARY      | id                          | 主键 | 主键索引               |
    | uk_user_role | user_id, role_id, role_type | 唯一 | 用户-角色-类型唯一约束 |
    | idx_user_id  | user_id                     | 普通 | 按用户查询关联角色     |
    | idx_role_id  | role_id                     | 普通 | 按角色查询关联用户     |

    表 6.5.2.7-2 platform_provider_user_role 索引设计

+   **role_type 字段说明**：

    | role_type | 含义           | role_id 指向            | 权限查询方式                       |
    | --------- | -------------- | ----------------------- | ---------------------------------- |
    | SYSTEM    | 系统预置角色   | platform_role.id        | 查 platform_role_permission        |
    | CUSTOM    | 平台自定义角色 | platform_custom_role.id | 查 platform_custom_role_permission |

    表 6.5.2.7-3 role_type 字段说明

### 6.5.3 租户库表结构（clarisphere_t{tenant_id}）

+   租户库表无需 tenant_id 字段，通过数据库隔离实现多租户。

#### 6.5.3.1 tenant_dept 租户部门表

+   租户部门表存储租户的组织架构，采用 Nested Set 模型优化部门树查询性能。
+   本表为第4章 org_organization（写权限归组织管理领域）的读优化视图，通过组织领域事件（OrganizationCreated/Updated/Deleted）同步维护，权限管理领域仅读取。

    | 字段名     | 数据类型     | 可空 | 默认值            | 说明                      |
    | ---------- | ------------ | ---- | ----------------- | ------------------------- |
    | id         | BIGINT       | 否   | AUTO_INCREMENT    | 主键，部门ID              |
    | parent_id  | BIGINT       | 否   | 0                 | 父部门ID，0表示顶级       |
    | lft        | INT          | 否   | 0                 | 左值（Nested Set）        |
    | rgt        | INT          | 否   | 0                 | 右值（Nested Set）        |
    | level      | INT          | 否   | 1                 | 层级深度，根节点为1       |
    | dept_name  | VARCHAR(100) | 否   | -                 | 部门名称                  |
    | dept_code  | VARCHAR(50)  | 是   | NULL              | 部门编码                  |
    | leader     | VARCHAR(50)  | 是   | NULL              | 负责人                    |
    | phone      | VARCHAR(20)  | 是   | NULL              | 联系电话                  |
    | email      | VARCHAR(100) | 是   | NULL              | 邮箱                      |
    | sort_order | INT          | 否   | 0                 | 排序号                    |
    | status     | TINYINT      | 否   | 1                 | 状态：1启用 0禁用         |
    | created_by | BIGINT       | 是   | NULL              | 创建人                    |
    | created_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                  |
    | updated_by | BIGINT       | 是   | NULL              | 更新人                    |
    | updated_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                  |
    | deleted    | TINYINT      | 否   | 0                 | 删除标记：0未删除 1已删除 |

    表 6.5.3.1-1 tenant_dept 表结构

+   索引设计：

    | 索引名         | 索引字段  | 类型 | 说明               |
    | -------------- | --------- | ---- | ------------------ |
    | PRIMARY        | id        | 主键 | 主键索引           |
    | idx_parent_id  | parent_id | 普通 | 父部门查询         |
    | idx_nested_set | lft, rgt  | 普通 | Nested Set范围查询 |
    | idx_level      | level     | 普通 | 按层级过滤         |

    表 6.5.3.1-2 tenant_dept 索引设计

+   **Nested Set 模型性能对比**：

    | 操作     | 邻接表+path方案 | Nested Set 方案        |
    | -------- | --------------- | ---------------------- |
    | 查询子树 | O(n)，全表扫描  | O(log n)，索引范围查询 |
    | 插入节点 | O(1)            | O(n)，需更新右侧节点   |
    | 删除节点 | O(1)            | O(n)，需更新右侧节点   |

    表 6.5.3.1-3 部门树查询方案性能对比

+   **适用场景**：部门结构变更少、查询频繁的场景（符合数据权限计算特点）。
+   **与第4章的关系**：写操作由组织管理领域（org_organization）负责，本表通过领域事件 OrganizationCreated/Updated/Deleted 被动同步，权限管理领域仅做读取用于 data_scope 计算。

#### 6.5.3.2 tenant_role 租户自定义角色表

+   租户自定义角色表存储租户根据业务需要自建的角色。

    | 字段名     | 数据类型     | 可空 | 默认值            | 说明                                      |
    | ---------- | ------------ | ---- | ----------------- | ----------------------------------------- |
    | id         | BIGINT       | 否   | AUTO_INCREMENT    | 主键，角色ID                              |
    | role_code  | VARCHAR(50)  | 否   | -                 | 角色编码（租户内唯一）                    |
    | role_name  | VARCHAR(100) | 否   | -                 | 角色名称                                  |
    | data_scope | TINYINT      | 否   | 4                 | 数据范围，取值同 platform_role.data_scope |
    | status     | TINYINT      | 否   | 1                 | 状态：1启用 0禁用                         |
    | sort_order | INT          | 否   | 0                 | 排序号                                    |
    | remark     | VARCHAR(500) | 是   | NULL              | 备注                                      |
    | created_by | BIGINT       | 是   | NULL              | 创建人                                    |
    | created_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                                  |
    | updated_by | BIGINT       | 是   | NULL              | 更新人                                    |
    | updated_at | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                                  |
    | deleted    | TINYINT      | 否   | 0                 | 删除标记：0未删除 1已删除                 |

    表 6.5.3.2-1 tenant_role 表结构

+   索引设计：

    | 索引名       | 索引字段  | 类型 | 说明               |
    | ------------ | --------- | ---- | ------------------ |
    | PRIMARY      | id        | 主键 | 主键索引           |
    | uk_role_code | role_code | 唯一 | 租户内角色编码唯一 |
    | idx_status   | status    | 普通 | 按状态过滤         |

    表 6.5.3.2-2 tenant_role 索引设计

#### 6.5.3.3 tenant_role_permission 租户角色权限关联表

+   租户角色权限关联表存储租户自定义角色与权限的多对多关系，permission_id 跨库引用 platform_permission.id。

    | 字段名        | 数据类型 | 可空 | 默认值            | 说明                                    |
    | ------------- | -------- | ---- | ----------------- | --------------------------------------- |
    | id            | BIGINT   | 否   | AUTO_INCREMENT    | 主键                                    |
    | role_id       | BIGINT   | 否   | -                 | 角色ID，引用本库 tenant_role.id         |
    | permission_id | BIGINT   | 否   | -                 | 权限ID，跨库引用 platform_permission.id |
    | created_by    | BIGINT   | 是   | NULL              | 创建人                                  |
    | created_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 创建时间                                |
    | updated_by    | BIGINT   | 是   | NULL              | 更新人                                  |
    | updated_at    | DATETIME | 否   | CURRENT_TIMESTAMP | 更新时间                                |

    表 6.5.3.3-1 tenant_role_permission 表结构

+   索引设计：

    | 索引名             | 索引字段               | 类型 | 说明                 |
    | ------------------ | ---------------------- | ---- | -------------------- |
    | PRIMARY            | id                     | 主键 | 主键索引             |
    | uk_role_permission | role_id, permission_id | 唯一 | 角色-权限唯一约束    |
    | idx_permission_id  | permission_id          | 普通 | 按权限ID反查关联角色 |

    表 6.5.3.3-2 tenant_role_permission 索引设计

#### 6.5.3.4 tenant_user_role 租户用户角色关联表

+   租户用户角色关联表存储UR用户与角色的关联关系，通过 role_type 区分系统预置角色和租户自定义角色。

    | 字段名     | 数据类型    | 可空 | 默认值            | 说明                                      |
    | ---------- | ----------- | ---- | ----------------- | ----------------------------------------- |
    | id         | BIGINT      | 否   | AUTO_INCREMENT    | 主键                                      |
    | user_id    | BIGINT      | 否   | -                 | 租户用户ID                                |
    | role_id    | BIGINT      | 否   | -                 | 角色ID                                    |
    | role_type  | VARCHAR(20) | 否   | -                 | 角色类型：SYSTEM系统预置/CUSTOM租户自定义 |
    | created_by | BIGINT      | 是   | NULL              | 创建人                                    |
    | created_at | DATETIME    | 否   | CURRENT_TIMESTAMP | 创建时间                                  |
    | updated_by | BIGINT      | 是   | NULL              | 更新人                                    |
    | updated_at | DATETIME    | 否   | CURRENT_TIMESTAMP | 更新时间                                  |

    表 6.5.3.4-1 tenant_user_role 表结构

+   索引设计：

    | 索引名       | 索引字段                    | 类型 | 说明                   |
    | ------------ | --------------------------- | ---- | ---------------------- |
    | PRIMARY      | id                          | 主键 | 主键索引               |
    | uk_user_role | user_id, role_id, role_type | 唯一 | 用户-角色-类型唯一约束 |
    | idx_user_id  | user_id                     | 普通 | 按用户查询关联角色     |
    | idx_role_id  | role_id                     | 普通 | 按角色查询关联用户     |

    表 6.5.3.4-2 tenant_user_role 索引设计

+   **role_type 字段说明**：

    | role_type | 含义           | role_id 指向  | 权限查询方式                |
    | --------- | -------------- | ------------- | --------------------------- |
    | SYSTEM    | 系统预置角色   | platform_role | 查 platform_role_permission |
    | CUSTOM    | 租户自定义角色 | tenant_role   | 查 tenant_role_permission   |

    表 6.5.3.4-3 role_type 字段说明

#### 6.5.3.5 tenant_user_data_access 用户数据访问授权表

+   用户数据访问授权表支持跨部门数据访问授权，配合 data_scope=5（自定义范围）使用。

    | 字段名          | 数据类型     | 可空 | 默认值            | 说明                                      |
    | --------------- | ------------ | ---- | ----------------- | ----------------------------------------- |
    | id              | BIGINT       | 否   | AUTO_INCREMENT    | 主键                                      |
    | user_id         | BIGINT       | 否   | -                 | 被授权用户ID                              |
    | target_type     | VARCHAR(20)  | 否   | -                 | 授权目标类型：dept/project/custom         |
    | target_id       | BIGINT       | 否   | -                 | 授权目标ID                                |
    | target_name     | VARCHAR(100) | 是   | NULL              | 授权目标名称（冗余，便于展示）            |
    | access_scope    | TINYINT      | 否   | 3                 | 访问范围：1目标及下级 2仅目标 3只读       |
    | expire_time     | DATETIME     | 是   | NULL              | 过期时间，NULL表示永久有效                |
    | grant_reason    | VARCHAR(500) | 是   | NULL              | 授权原因/说明                             |
    | granted_by      | BIGINT       | 否   | -                 | 授权人ID                                  |
    | approval_status | TINYINT      | 否   | 0                 | 审批状态：0待审批 1已通过 2已拒绝 3免审批 |
    | approval_id     | VARCHAR(64)  | 是   | NULL              | 审批流程ID（关联BC-14工作流）             |
    | approved_by     | BIGINT       | 是   | NULL              | 审批人ID                                  |
    | approved_at     | DATETIME     | 是   | NULL              | 审批时间                                  |
    | reject_reason   | VARCHAR(500) | 是   | NULL              | 拒绝原因（审批拒绝时填写）                |
    | status          | TINYINT      | 否   | 1                 | 状态：1有效 0已撤销                       |
    | created_by      | BIGINT       | 是   | NULL              | 创建人                                    |
    | created_at      | DATETIME     | 否   | CURRENT_TIMESTAMP | 创建时间                                  |
    | updated_by      | BIGINT       | 是   | NULL              | 更新人                                    |
    | updated_at      | DATETIME     | 否   | CURRENT_TIMESTAMP | 更新时间                                  |

    表 6.5.3.5-1 tenant_user_data_access 表结构

+   索引设计：

    | 索引名              | 索引字段                            | 类型 | 说明                   |
    | ------------------- | ----------------------------------- | ---- | ---------------------- |
    | PRIMARY             | id                                  | 主键 | 主键索引               |
    | uk_user_target      | user_id, target_type, target_id     | 唯一 | 用户-目标唯一约束      |
    | idx_user_id         | user_id                             | 普通 | 按用户查询授权列表     |
    | idx_expire_time     | expire_time                         | 普通 | 过期时间索引（清理用） |
    | idx_status          | status                              | 普通 | 按状态过滤             |
    | idx_approval_status | approval_status                     | 普通 | 按审批状态过滤         |
    | idx_zombie_cleanup  | approval_status, status, created_at | 普通 | 僵尸记录清理复合索引   |

    表 6.5.3.5-2 tenant_user_data_access 索引设计

+   **关键字段说明**：

    | 字段名          | 说明                                             |
    | --------------- | ------------------------------------------------ |
    | target_type     | dept=部门，project=项目组（V2.0），custom=自定义 |
    | access_scope    | 1=目标及下级，2=仅目标，3=只读                   |
    | expire_time     | 临时授权场景使用，过期后自动失效                 |
    | approval_status | 0=待审批，1=已通过，2=已拒绝，3=免审批           |
    | approval_id     | 关联BC-14工作流的流程实例ID                      |
    | reject_reason   | 审批拒绝时由审批人填写                           |

    表 6.5.3.5-3 tenant_user_data_access 关键字段说明

### 6.5.4 表关系图

+   权限管理数据模型关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────────┐
    │                       权限管理数据模型关系图                                    │
    ├─────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                 │
    │  clarisphere_platform                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                         │    │
    │  │  ┌──────────────────────┐                                               │    │
    │  │  │ platform_permission  │◄────────────────────────┐                     │    │
    │  │  │   (权限定义)         │◄────────────┐           │                     │    │
    │  │  └──────────────────────┘             │           │                     │    │
    │  │              ▲ 自关联(parent_id)      │           │                     │    │
    │  │                                       │           │                     │    │
    │  │  ┌──────────────────────┐      ┌──────┴───────┐   │                     │    │
    │  │  │   platform_role      │      │platform_role │   │                     │    │
    │  │  │   (系统预置角色)     │──N:N │_permission   │   │                     │    │
    │  │  └──────────┬───────────┘      └──────────────┘   │                     │    │
    │  │             │                                     │                     │    │
    │  │             │    ┌──────────────────────┐       ┌─┴────────────────┐    │    │
    │  │             │    │ platform_custom_role  │      │platform_custom   │    │    │
    │  │             │    │ (平台自定义角色)      │──N:N │_role_permission  │    │    │
    │  │             │    └──────────┬────────────┘      └──────────────────┘    │    │
    │  │             │               │                                           │    │
    │  │             │    ┌──────────┴─────────────┐                             │    │
    │  │             ├───►│ platform_role_conflict │                             │    │
    │  │             │    │ (角色互斥配置)         │                             │    │
    │  │             │    └────────────────────────┘                             │    │
    │  │             │                                                           │    │
    │  │             ▼                                                           │    │
    │  │  ┌───────────────────────────┐                                          │    │
    │  │  │platform_provider_user_role│                                          │    │
    │  │  │ (运营用户角色关联)        │                                          │    │
    │  │  └───────────────────────────┘                                          │    │
    │  │                                                                         │    │
    │  └─────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                 │
    │  clarisphere_t{tenant_id}                                                       │
    │  ┌─────────────────────────────────────────────────────────────────────────┐    │
    │  │                                                                         │    │
    │  │  ┌──────────────────────┐      ┌──────────────────────┐                 │    │
    │  │  │    tenant_role       │      │ tenant_role          │                 │    │
    │  │  │  (租户自定义角色)    │──N:N │ _permission          │                 │    │
    │  │  └──────────┬───────────┘      └──────────────────────┘                 │    │
    │  │             │                      │ permission_id                      │    │
    │  │             │                      ▼ 跨库引用                           │    │
    │  │             │               platform_permission(平台库)                 │    │
    │  │             │                                                           │    │
    │  │             ▼                                                           │    │
    │  │  ┌──────────────────────┐    ┌──────────────────────┐                   │    │
    │  │  │  tenant_user_role    │    │     tenant_dept      │                   │    │
    │  │  │  (租户用户角色关联)  │    │   (租户部门/读视图)  │                   │    │
    │  │  └──────────────────────┘    └──────────┬───────────┘                   │    │
    │  │             │                           │ ▲ 自关联(parent_id)           │    │
    │  │             │                           │                               │    │
    │  │             │                  data_scope=5时                           │    │
    │  │             │                      ▼                                    │    │
    │  │             │               ┌───────────────────────┐                   │    │
    │  │             │               │tenant_user_data_access│                   │    │
    │  │             └──────────────►│ (数据访问授权)        │                   │    │
    │  │                             └───────────────────────┘                   │    │
    │  │                                                                         │    │
    │  └─────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                 │
    └─────────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.5.4-1 权限管理数据模型关系图

### 6.5.5 数据字典

#### 6.5.5.1 permission_type 权限类型

+   权限类型枚举值定义如下。

    | 数据库值 | Java枚举值 | 说明 | 可有子节点 |
    | -------- | ---------- | ---- | ---------- |
    | 1        | CATALOG    | 目录 | 是         |
    | 2        | MENU       | 菜单 | 是         |
    | 3        | BUTTON     | 按钮 | 否         |

    表 6.5.5.1-1 permission_type 枚举

#### 6.5.5.2 data_scope 数据权限范围

+   数据权限范围枚举值定义如下。

    | 数据库值 | Java枚举值 | 说明         | 适用角色 |
    | -------- | ---------- | ------------ | -------- |
    | 1        | ALL        | 全部数据     | UR       |
    | 2        | DEPT_SUB   | 本部门及以下 | UR       |
    | 3        | DEPT_ONLY  | 本部门       | UR       |
    | 4        | SELF_ONLY  | 仅本人       | UR, UP   |
    | 5        | CUSTOM     | 自定义范围   | UR       |

    表 6.5.5.2-1 data_scope 枚举

+   **说明**：UP用户群（运营侧）无部门概念，仅 SELF_ONLY(4) 生效。

#### 6.5.5.3 role_type 角色类型

+   角色类型枚举值定义如下。

    | 数据库存储值 | Java枚举值 | 说明         | role_id 指向                              |
    | ------------ | ---------- | ------------ | ----------------------------------------- |
    | SYSTEM       | SYSTEM     | 系统预置角色 | platform_role.id                          |
    | CUSTOM       | CUSTOM     | 自定义角色   | tenant_role.id 或 platform_custom_role.id |

    表 6.5.5.3-1 role_type 枚举

#### 6.5.5.4 approval_status 审批状态

+   数据授权审批状态枚举值定义如下。

    | 数据库值 | Java枚举值 | 说明   | 可流转到                  |
    | -------- | ---------- | ------ | ------------------------- |
    | 0        | PENDING    | 待审批 | APPROVED, REJECTED        |
    | 1        | APPROVED   | 已通过 | -（终态，但记录可被撤销） |
    | 2        | REJECTED   | 已拒绝 | -（终态，可重新申请）     |
    | 3        | EXEMPTED   | 免审批 | -（直接生效）             |

    表 6.5.5.4-1 approval_status 枚举

#### 6.5.5.5 access_scope 访问范围

+   数据访问授权范围枚举值定义如下。

    | 数据库值 | Java枚举值  | 说明       | 适用场景           |
    | -------- | ----------- | ---------- | ------------------ |
    | 1        | ALL_SUB     | 目标及下级 | 授权整个部门树     |
    | 2        | TARGET_ONLY | 仅目标     | 仅授权指定部门     |
    | 3        | READ_ONLY   | 只读       | 仅可查看，不可操作 |

    表 6.5.5.5-1 access_scope 枚举

#### 6.5.5.6 target_type 授权目标类型

+   数据授权目标类型枚举值定义如下。

    | 数据库存储值 | Java枚举值 | 说明   | target_id 指向   | 版本 |
    | ------------ | ---------- | ------ | ---------------- | ---- |
    | dept         | DEPT       | 部门   | tenant_dept.id   | V1.0 |
    | project      | PROJECT    | 项目组 | project_group.id | V2.0 |
    | custom       | CUSTOM     | 自定义 | 自定义资源ID     | V2.0 |

    表 6.5.5.6-1 target_type 枚举

#### 6.5.5.7 conflict_type 互斥类型

+   角色互斥类型枚举值定义如下。

    | 数据库存储值 | Java枚举值 | 说明     |
    | ------------ | ---------- | -------- |
    | MUTUAL       | MUTUAL     | 双向互斥 |
    | ONE_WAY      | ONE_WAY    | 单向互斥 |

    表 6.5.5.7-1 conflict_type 枚举

#### 6.5.5.8 scope_type 互斥生效范围

+   角色互斥生效范围枚举值定义如下。

    | 数据库存储值 | Java枚举值 | 说明     | 版本      |
    | ------------ | ---------- | -------- | --------- |
    | GLOBAL       | GLOBAL     | 全局生效 | V1.0      |
    | TENANT       | TENANT     | 租户级   | V2.0 预留 |

    表 6.5.5.8-1 scope_type 枚举

### 6.5.6 跨库一致性机制

+   租户角色权限表（tenant_role_permission）的 permission_id 跨库引用平台权限表（platform_permission.id）。当平台权限变更时，需要保证租户库中的引用一致性。

+   通过领域事件实现跨库一致性：

    | 事件                    | 处理逻辑                                               |
    | ----------------------- | ------------------------------------------------------ |
    | PermissionDeletedEvent  | 遍历所有租户库，删除对应的 tenant_role_permission 记录 |
    | PermissionDisabledEvent | 可选：通知租户管理员，或自动移除相关权限               |

    表 6.5.6-1 跨库一致性事件处理

+   **一致性保障说明**：
    -   事件处理采用异步机制（@Async + @EventListener），遍历所有租户库执行清理
    -   每个租户库的处理在独立事务中，单个租户失败不影响其他租户
    -   失败时记录日志并触发告警，由运维人工介入修复

### 6.5.7 数据迁移与初始化

#### 6.5.7.1 平台库初始化

+   平台库初始化时需要执行以下权限相关操作：

    | 序号 | 表名                            | 初始化数据                      |
    | ---- | ------------------------------- | ------------------------------- |
    | 1    | platform_permission             | 插入全量权限定义树（三级结构）  |
    | 2    | platform_role                   | 插入系统预置角色（参见6.1.5.1） |
    | 3    | platform_role_permission        | 插入预置角色与权限的关联        |
    | 4    | platform_custom_role            | 无预置数据                      |
    | 5    | platform_custom_role_permission | 无预置数据                      |
    | 6    | platform_role_conflict          | 插入默认互斥规则（参见6.1.5.3） |
    | 7    | platform_provider_user_role     | 初始管理员分配超级管理员角色    |

    表 6.5.7.1-1 平台库权限表初始化

+   初始管理员角色分配数据：

    | 字段      | 值                  |
    | --------- | ------------------- |
    | user_id   | 初始管理员ID        |
    | role_id   | UP-01（超级管理员） |
    | role_type | SYSTEM              |

    表 6.5.7.1-2 初始管理员角色分配

#### 6.5.7.2 租户库初始化

+   新租户开通时，权限相关表由 BC-10 租户 IAM 初始化接口统一创建。

    | 序号 | 表名                    | 初始化数据                 |
    | ---- | ----------------------- | -------------------------- |
    | 1    | tenant_dept             | 通过组织领域事件同步根部门 |
    | 2    | tenant_role             | 无预置数据                 |
    | 3    | tenant_role_permission  | 无预置数据                 |
    | 4    | tenant_user_role        | 租户管理员分配管理员角色   |
    | 5    | tenant_user_data_access | 无预置数据                 |

    表 6.5.7.2-1 租户库权限表初始化

+   租户管理员角色分配数据：

    | 字段      | 值                  |
    | --------- | ------------------- |
    | user_id   | 租户管理员ID        |
    | role_id   | UR-01（租户管理员） |
    | role_type | SYSTEM              |

    表 6.5.7.2-2 租户管理员角色分配

#### 6.5.7.3 数据清理策略

+   权限管理数据清理策略如下：

    | 数据类型       | 清理条件                                    | 清理方式 |
    | -------------- | ------------------------------------------- | -------- |
    | 已删除角色     | deleted=1 且超过 6 个月                     | 可归档   |
    | 过期数据授权   | expire_time < 当前时间 且超过 3 个月        | 物理删除 |
    | 已撤销数据授权 | status=0 且 updated_at 超过 6 个月          | 物理删除 |
    | 僵尸审批记录   | approval_status=0 且 created_at 超过 30 天  | 物理删除 |
    | 已拒绝数据授权 | approval_status=2 且 created_at 超过 3 个月 | 物理删除 |

    表 6.5.7.3-1 数据清理策略

+   **清理注意事项**：
    -   归档操作应在业务低峰期执行
    -   清理前需确认无其他表引用被清理数据
    -   僵尸审批记录（长期处于待审批状态）清理前应通知相关管理员

## 6.6 后端实现方案

+   本节设计权限校验的后端实现方案，聚焦技术选型、核心机制和关键设计决策。

### 6.6.1 技术选型

+   后端权限实现的技术选型如下表所示：

    | 技术领域   | 选型方案             | 选型理由                          |
    | ---------- | -------------------- | --------------------------------- |
    | 认证框架   | Spring Security 6.x  | 业界标准，与Spring Boot深度集成   |
    | Token方案  | JWT (JSON Web Token) | 无状态，支持分布式部署            |
    | 功能权限   | @PreAuthorize注解    | 声明式，与Spring Security无缝集成 |
    | 数据权限   | AOP + MyBatis拦截器  | 非侵入式，自动注入SQL条件         |
    | 权限缓存   | Caffeine + Redis     | 两级缓存，兼顾性能和一致性        |
    | 部门树查询 | Nested Set模型       | O(1)子树查询，优于递归和LIKE方案  |

    表 6.6.1-1 后端权限技术选型

### 6.6.2 总体架构

+   后端权限校验采用分层架构，请求经过认证层、功能权限层、数据权限层后到达业务逻辑：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                           后端权限校验架构                                  │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   ┌──────────┐                                                              │
    │   │ HTTP请求 │                                                              │
    │   └────┬─────┘                                                              │
    │        │                                                                    │
    │        ▼                                                                    │
    │   ┌─────────────────────────────────────────────────────────────┐           │
    │   │ 认证层 (JwtAuthenticationFilter)                            │           │
    │   │ • 解析JWT Token，提取用户身份                               │           │
    │   │ • 加载用户权限列表（L1本地缓存 → L2 Redis → DB）            │           │
    │   │ • 构建SecurityContext，存入ThreadLocal                      │           │
    │   └────┬────────────────────────────────────────────────────────┘           │
    │        │                                                                    │
    │        ▼                                                                    │
    │   ┌─────────────────────────────────────────────────────────────┐           │
    │   │ 功能权限层 (@PreAuthorize)                                  │           │
    │   │ • Controller方法级权限校验                                  │           │
    │   │ • 判断用户是否拥有目标权限标识                              │           │
    │   │ • 无权限返回403 Forbidden                                   │           │
    │   └────┬────────────────────────────────────────────────────────┘           │
    │        │                                                                    │
    │        ▼                                                                    │
    │   ┌─────────────────────────────────────────────────────────────┐           │
    │   │ 数据权限层 (@DataScope + MyBatis拦截器)                     │           │
    │   │ • Service方法级数据过滤                                     │           │
    │   │ • 根据用户data_scope计算可访问范围                          │           │
    │   │ • 自动向SQL注入WHERE条件                                    │           │
    │   └────┬────────────────────────────────────────────────────────┘           │
    │        │                                                                    │
    │        ▼                                                                    │
    │   ┌─────────────────────────────────────────────────────────────┐           │
    │   │ 数据访问层 (MyBatis Mapper)                                 │           │
    │   │ • 执行带数据权限条件的SQL                                   │           │
    │   │ • 租户隔离由TenantInterceptor自动处理                       │           │
    │   └─────────────────────────────────────────────────────────────┘           │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.6.2-1 后端权限校验架构

### 6.6.3 JWT Token设计

#### 6.6.3.1 Token结构设计

+   JWT Token结构详见 **5.3.5.2 AccessToken值对象**。

+   设计原则：**仅存储身份标识，权限实时查询**。Token中不存储角色和权限列表，避免角色变更时需要等待Token过期。

#### 6.6.3.2 Token不存储roles的设计决策

+   方案对比：

    | 方案               | 优点             | 缺点                                     |
    | ------------------ | ---------------- | ---------------------------------------- |
    | Token中存储roles   | 减少查询         | 角色变更需等Token过期才生效；Token体积大 |
    | 实时查询权限(采用) | 角色变更立即生效 | 每次请求需查询（通过缓存优化）           |

    表 6.6.3.2-1 Token存储方案对比

+   **设计决策**：采用实时查询权限方案，通过两级缓存优化性能，确保角色变更即时生效。

#### 6.6.3.3 Token配置参数

+   Token相关配置参数设计：

    | 配置项                 | 默认值        | 说明                                                |
    | ---------------------- | ------------- | --------------------------------------------------- |
    | jwt.expiration         | 参见AT-R-06   | Access Token有效期（UP=15min, UR=30min可配, UC=2h） |
    | jwt.refresh-expiration | 7天           | Refresh Token有效期                                 |
    | jwt.header             | Authorization | Token请求头                                         |
    | jwt.prefix             | Bearer        | Token前缀                                           |

    表 6.6.3.3-1 JWT配置参数

### 6.6.4 功能权限实现设计

#### 6.6.4.1 权限校验机制

+   功能权限校验流程：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        功能权限校验时序                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   Controller          Spring Security        PermissionService    缓存/DB  │
    │       │                     │                       │               │       │
    │       │  @PreAuthorize      │                       │               │       │
    │       │ ──────────────────▶ │                       │               │       │
    │       │                     │  getUserPermissions   │               │       │
    │       │                     │ ─────────────────────▶│               │       │
    │       │                     │                       │  查询L1缓存   │       │
    │       │                     │                       │ ─────────────▶│       │
    │       │                     │                       │◀──────────────│       │
    │       │                     │                       │               │       │
    │       │                     │                       │ [未命中]查L2  │       │
    │       │                     │                       │ ─────────────▶│       │
    │       │                     │                       │◀──────────────│       │
    │       │                     │                       │               │       │
    │       │                     │  Set<权限标识>        │               │       │
    │       │                     │◀──────────────────────│               │       │
    │       │                     │                       │               │       │
    │       │                     │  判断是否包含目标权限 │               │       │
    │       │                     │                       │               │       │
    │       │  通过/403           │                       │               │       │
    │       │◀─────────────────── │                       │               │       │
    │       │                     │                       │               │       │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.6.4.1-1 功能权限校验时序

#### 6.6.4.2 权限标识常量化规范

+   **设计规范**：权限标识必须使用Java常量类定义，禁止在代码中硬编码字符串。

+   常量类结构设计：

    | 层级       | 示例                           | 说明       |
    | ---------- | ------------------------------ | ---------- |
    | 用户侧     | Perms.Provider / Perms.Ur      | 顶级接口   |
    | 限界上下文 | Perms.Ur.Landing               | 二级接口   |
    | 资源       | Perms.Ur.Landing.Policy        | 三级接口   |
    | 操作       | Perms.Ur.Landing.Policy.CREATE | 常量字符串 |

    表 6.6.4.2-1 权限常量类结构

+   **常量化优势**：
    -   IDE自动提示，避免拼写错误
    -   重构时可全局替换
    -   编译期检查，减少运行时错误

#### 6.6.4.3 权限注解启动校验机制

+   **设计目标**：应用启动时校验代码中的权限标识与数据库一致，不一致则启动失败。

+   校验机制设计：

    | 步骤 | 动作                          | 说明                     |
    | ---- | ----------------------------- | ------------------------ |
    | 1    | 加载数据库所有权限标识        | 构建有效权限集合         |
    | 2    | 扫描Controller的@PreAuthorize | 提取代码中使用的权限标识 |
    | 3    | 比对差异                      | 找出无效的权限标识       |
    | 4    | 处理结果                      | 有差异则抛异常阻止启动   |

    表 6.6.4.3-1 权限注解校验步骤

+   环境配置建议：

    | 环境     | 是否启用 | 说明                   |
    | -------- | -------- | ---------------------- |
    | 开发环境 | 启用     | 快速发现权限配置错误   |
    | 测试环境 | 启用     | 确保测试数据与代码一致 |
    | 生产环境 | 建议启用 | 防止误发布             |

    表 6.6.4.3-2 校验配置建议

### 6.6.5 数据权限实现设计

#### 6.6.5.1 数据权限注入机制

+   数据权限通过AOP切面和MyBatis拦截器协作实现：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        数据权限注入机制                                     │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   Service层                 AOP切面                 MyBatis拦截器           │
    │       │                       │                         │                   │
    │       │  @DataScope           │                         │                   │
    │       │  方法调用             │                         │                   │
    │       │ ────────────────────▶ │                         │                   │
    │       │                       │                         │                   │
    │       │                       │  1.获取当前用户         │                   │
    │       │                       │  2.计算data_scope       │                   │
    │       │                       │  3.生成SQL条件          │                   │
    │       │                       │  4.存入ThreadLocal      │                   │
    │       │                       │                         │                   │
    │       │                       │  执行业务方法           │                   │
    │       │                       │ ───────────────────────▶│                   │
    │       │                       │                         │                   │
    │       │                       │                         │  5.从ThreadLocal  │
    │       │                       │                         │    获取SQL条件    │
    │       │                       │                         │  6.拼接到原SQL    │
    │       │                       │                         │  7.执行查询       │
    │       │                       │                         │                   │
    │       │                       │◀─────────────────────── │                   │
    │       │◀───────────────────── │                         │                   │
    │       │                       │  8.清理ThreadLocal      │                   │
    │       │                       │                         │                   │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.6.5.1-1 数据权限注入机制

#### 6.6.5.2 @DataScope注解设计

+   自定义数据权限注解参数设计：

    | 参数      | 类型   | 默认值       | 说明                    |
    | --------- | ------ | ------------ | ----------------------- |
    | deptAlias | String | ""           | 部门表别名，用于拼接SQL |
    | userAlias | String | ""           | 用户表别名，用于拼接SQL |
    | deptField | String | "dept_id"    | 部门字段名              |
    | userField | String | "creator_id" | 用户字段名              |

    表 6.6.5.2-1 @DataScope注解参数

#### 6.6.5.3 data_scope计算逻辑

+   根据用户角色的data_scope值生成对应的SQL条件：

    | data_scope | 含义         | SQL条件生成规则                         | 适用场景       |
    | ---------- | ------------ | --------------------------------------- | -------------- |
    | 1          | 全部数据     | 不注入条件（租户隔离仍生效）            | CISO、合规经理 |
    | 2          | 本部门及以下 | Nested Set范围查询：lft BETWEEN ? AND ? | 部门经理       |
    | 3          | 本部门       | 等值查询：dept_id = ?                   | 普通管理员     |
    | 4          | 仅本人       | 等值查询：creator_id = ?                | 执行人         |
    | 5          | 自定义范围   | IN查询授权表：dept_id IN (...)          | 跨部门协作     |

    表 6.6.5.3-1 data_scope SQL生成规则

+   **多角色合并策略**：用户拥有多个角色时，取data_scope最小值（权限最大）。

#### 6.6.5.4 SQL注入防护设计

+   **安全风险**：@DataScope注解的别名和字段名参数可能被利用进行SQL注入。

+   **防护机制**：字段白名单校验

    | 白名单类型 | 允许值                                         |
    | ---------- | ---------------------------------------------- |
    | 表别名     | p, t, u, d, a, policy, task, user, dept, asset |
    | 字段名     | dept_id, creator_id, owner_id, assignee_id     |

    表 6.6.5.4-1 字段白名单配置

+   **校验时机**：AOP切面执行前，校验不通过则抛出SecurityException。

#### 6.6.5.5 用户类型分流处理

+   不同用户类型的数据权限处理策略：

    | 用户类型 | 数据权限处理                                 |
    | -------- | -------------------------------------------- |
    | provider | 不处理，运营用户群操作平台级数据，无部门概念 |
    | ur       | 根据角色data_scope和用户dept_id计算          |
    | uc       | 强制按creator_id过滤，仅看自己的数据         |

    表 6.6.5.5-1 用户类型数据权限策略

### 6.6.6 权限缓存设计

#### 6.6.6.1 两级缓存架构

+   采用L1本地缓存 + L2分布式缓存的两级架构：

    | 缓存层级 | 实现方式 | 过期时间 | 特点                   |
    | -------- | -------- | -------- | ---------------------- |
    | L1       | Caffeine | 5分钟    | 速度最快，减少网络开销 |
    | L2       | Redis    | 2小时    | 集群共享，保证一致性   |

    表 6.6.6.1-1 权限缓存层级

+   缓存查询顺序：L1 → L2 → DB → 回写L2 → 回写L1

#### 6.6.6.2 缓存Key设计

+   权限相关缓存Key设计规范：

    | 缓存类型     | Key格式                                           | 示例                         |
    | ------------ | ------------------------------------------------- | ---------------------------- |
    | 用户功能权限 | permission:user:{user_type}:{tenant_id}:{user_id} | permission:user:ur:100:10001 |
    | 用户数据权限 | data_scope:user:{tenant_id}:{user_id}             | data_scope:user:100:10001    |
    | 角色权限     | permission:role:{role_id}                         | permission:role:1001         |

    表 6.6.6.2-1 权限缓存Key设计

#### 6.6.6.3 缓存失效策略

+   权限变更时的缓存失效处理：

    | 变更场景     | 失效范围                     | 实现方式         |
    | ------------ | ---------------------------- | ---------------- |
    | 角色权限变更 | 该角色所有关联用户的权限缓存 | 事件驱动批量清除 |
    | 用户角色变更 | 该用户的权限缓存             | 单用户清除       |
    | 数据授权变更 | 该用户的数据权限缓存         | 单用户清除       |
    | 权限定义变更 | 全量清除（发生频率低）       | 全量清除         |

    表 6.6.6.3-1 缓存失效策略

+   **事件驱动机制**：通过领域事件触发缓存清除，确保权限变更即时生效。

### 6.6.7 字段级权限设计

#### 6.6.7.1 V1.0全局脱敏策略

+   V1.0采用全局敏感字段统一脱敏，不做细粒度的角色区分。

+   脱敏类型定义：

    | 脱敏类型  | 原始值              | 脱敏后             | 适用字段 |
    | --------- | ------------------- | ------------------ | -------- |
    | MOBILE    | 13812345678         | 138****5678        | 手机号   |
    | ID_CARD   | 110101199001011234  | 110***********1234 | 身份证号 |
    | EMAIL     | <zhangsan@test.com> | zha***@test.com    | 邮箱     |
    | BANK_CARD | 6222021234567890    | ************7890   | 银行卡号 |
    | HIDDEN    | 任意值              | null               | 完全隐藏 |

    表 6.6.7.1-1 脱敏类型定义

#### 6.6.7.2 脱敏实现机制

+   脱敏在JSON序列化阶段处理：

    | 层级     | 机制                    | 说明                   |
    | -------- | ----------------------- | ---------------------- |
    | 注解层   | @DataMasking(type=...)  | 标记需要脱敏的字段     |
    | 序列化层 | Jackson自定义Serializer | 序列化时执行脱敏逻辑   |
    | 例外处理 | 特权用户判断            | HR、数据本人可查看明文 |

    表 6.6.7.2-1 脱敏实现层级

#### 6.6.7.3 V2.0演进方向

+   V2.0计划支持按角色配置字段可见性：

    | 功能       | V1.0     | V2.0（规划）            |
    | ---------- | -------- | ----------------------- |
    | 脱敏规则   | 全局统一 | 按角色配置              |
    | 字段可见性 | 不支持   | 支持角色-字段可见性矩阵 |
    | 配置方式   | 硬编码   | 管理界面配置            |

    表 6.6.7.3-1 字段级权限演进规划

## 6.7 前端实现方案

+   本节设计权限管理的前端实现方案，聚焦技术选型、数据流转和控制机制。

### 6.7.1 技术选型

+   前端权限模块技术选型：

    | 技术领域   | 技术选型       | 说明             |
    | ---------- | -------------- | ---------------- |
    | 开发框架   | Vue 3.x        | 主框架           |
    | 状态管理   | Pinia          | 存储用户权限数据 |
    | 路由管理   | Vue Router 4.x | 动态路由生成     |
    | UI组件库   | Element Plus   | 基础组件         |
    | HTTP客户端 | Axios          | 接口请求         |
    | 构建工具   | Vite           | 项目构建         |

    表 6.7.1-1 前端技术选型

### 6.7.2 权限数据流转

+   前端权限数据流转流程：

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                          前端权限数据流转                                   │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌──────────┐     ┌──────────┐     ┌───────────────┐     ┌──────────────┐   │
    │  │ 用户登录 │────▶│ 获取Token│────▶│ 存储Token     │────▶│ 请求用户信息 │   │
    │  └──────────┘     └──────────┘     │ (localStorage)│     └───────┬──────┘   │
    │                                    └───────────────┘             │          │
    │                                                                  ▼          │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │ 后端返回: { userId, username, userType, permissions[], roles[] }    │    │
    │  └────────────────────────────────┬────────────────────────────────────┘    │
    │                                   │                                         │
    │                                   ▼                                         │
    │                          ┌─────────────────┐                                │
    │                          │ 存储到 Pinia    │                                │
    │                          │ (userStore)     │                                │
    │                          └────────┬────────┘                                │
    │                                   │                                         │
    │           ┌───────────────────────┼───────────────────────┐                 │
    │           │                       │                       │                 │
    │           ▼                       ▼                       ▼                 │
    │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
    │  │ 请求菜单接口    │    │ 生成动态路由    │    │ 按钮权限控制    │          │
    │  │ 获取菜单树      │    │ 注册到Router    │    │ v-has-perm指令  │          │
    │  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘          │
    │           │                      │                      │                   │
    │           ▼                      ▼                      ▼                   │
    │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
    │  │ 渲染侧边栏菜单  │    │ 路由守卫校验    │    │ 按钮显示/隐藏   │          │
    │  └─────────────────┘    └─────────────────┘    └─────────────────┘          │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.7.2-1 前端权限数据流转

### 6.7.3 权限控制层次

+   前端权限控制分为四个层次：

    | 控制层次 | 实现方式                    | 权限标识示例             | 说明                |
    | -------- | --------------------------- | ------------------------ | ------------------- |
    | 菜单显示 | 后端返回菜单树 + 侧边栏渲染 | ur:landing:policy:list   | 无权限则菜单不显示  |
    | 路由访问 | 动态路由 + 路由守卫         | ur:landing:policy:list   | 无权限则跳转403页面 |
    | 按钮显示 | v-has-perm 自定义指令       | ur:landing:policy:create | 无权限则按钮隐藏    |
    | 接口请求 | Axios拦截器自动携带Token    | 由后端校验               | 前端不做接口级拦截  |

    表 6.7.3-1 前端权限控制层次

### 6.7.4 菜单权限设计

#### 6.7.4.1 菜单数据来源

+   菜单数据从后端动态获取，而非前端硬编码：

    | 方案     | 优点               | 缺点           | 本系统选择 |
    | -------- | ------------------ | -------------- | ---------- |
    | 前端配置 | 简单，无需后端接口 | 权限变更需发版 | 否         |
    | 后端返回 | 权限变更实时生效   | 需维护菜单接口 | 是         |

    表 6.7.4.1-1 菜单数据来源方案

#### 6.7.4.2 菜单接口响应结构

+   后端返回的菜单树结构设计：

    | 字段      | 类型     | 说明       |
    | --------- | -------- | ---------- |
    | id        | Number   | 菜单ID     |
    | name      | String   | 菜单名称   |
    | path      | String   | 路由路径   |
    | component | String   | 组件路径   |
    | icon      | String   | 图标       |
    | sortOrder | Integer  | 排序号     |
    | children  | Object[] | 子菜单列表 |

    表 6.7.4.2-1 菜单树结构

### 6.7.5 路由权限设计

#### 6.7.5.1 路由分类

+   路由分为静态路由和动态路由两类：

    | 路由类型 | 定义方式         | 示例                |
    | -------- | ---------------- | ------------------- |
    | 静态路由 | 前端固定配置     | 登录页、404页、首页 |
    | 动态路由 | 根据权限动态生成 | 业务功能页面        |

    表 6.7.5.1-1 路由分类

#### 6.7.5.2 路由守卫逻辑

+   路由守卫校验流程：

    | 步骤 | 检查项             | 未通过处理   |
    | ---- | ------------------ | ------------ |
    | 1    | Token是否存在      | 跳转登录页   |
    | 2    | 用户信息是否加载   | 调用接口加载 |
    | 3    | 动态路由是否注册   | 生成并注册   |
    | 4    | 是否有目标路由权限 | 跳转403页面  |

    表 6.7.5.2-1 路由守卫逻辑

### 6.7.6 按钮权限设计

#### 6.7.6.1 v-has-perm指令

+   自定义指令实现按钮级权限控制：

    | 指令名称   | 参数类型 | 功能说明                      |
    | ---------- | -------- | ----------------------------- |
    | v-has-perm | String   | 有权限则显示，无权限则移除DOM |
    | v-has-any  | String[] | 有任一权限则显示              |
    | v-has-all  | String[] | 有全部权限才显示              |

    表 6.7.6.1-1 权限指令设计

#### 6.7.6.2 使用规范

+   按钮权限使用规范：

    | 场景         | 推荐方式   | 说明                           |
    | ------------ | ---------- | ------------------------------ |
    | 单个权限控制 | v-has-perm | 最常用场景                     |
    | 多权限或关系 | v-has-any  | 有任一权限即可                 |
    | 多权限与关系 | v-has-all  | 需同时具备多个权限             |
    | 复杂逻辑     | 函数式判断 | 在setup中使用hasPermission函数 |

    表 6.7.6.2-1 按钮权限使用规范

### 6.7.7 接口请求拦截

#### 6.7.7.1 请求拦截器

+   Axios请求拦截器职责：

    | 职责      | 处理逻辑                      |
    | --------- | ----------------------------- |
    | 携带Token | 自动添加Authorization头       |
    | 租户标识  | UR用户自动添加X-Tenant-Code头 |

    表 6.7.7.1-1 请求拦截器职责

#### 6.7.7.2 响应拦截器

+   Axios响应拦截器对权限相关错误的处理：

    | HTTP状态码 | 错误码             | 处理方式                 |
    | ---------- | ------------------ | ------------------------ |
    | 401        | TOKEN_EXPIRED      | 提示重新登录，跳转登录页 |
    | 403        | PERMISSION_DENIED  | 提示"没有权限访问该资源" |
    | 403        | QUOTA_EXCEEDED     | 提示"今日下载次数已用完" |
    | 403        | DATA_ACCESS_DENIED | 提示"没有权限访问该数据" |

    表 6.7.7.2-1 响应拦截器错误处理

### 6.7.8 前端权限控制原则

+   前端权限控制的核心原则：

    | 原则     | 说明                                |
    | -------- | ----------------------------------- |
    | 体验优化 | 前端权限控制主要用于优化用户体验    |
    | 后端兜底 | 后端必须独立校验，不能依赖前端      |
    | 统一标识 | 前后端使用相同的权限标识            |
    | 友好提示 | Token过期或权限不足时给用户友好提示 |

    表 6.7.8-1 前端权限控制原则

## 6.8 前端设计

+   本节设计授权管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   授权管理前端以角色与权限的配置管理为核心，供给侧侧重全局权限定义与角色互斥管理，租户侧侧重自定义角色与数据授权管理。

### 6.8.1 页面总览

+   授权管理前端页面清单如下表所示。

    | 页面编号      | 页面名称        | 用户群   | 路由路径                             | 说明                               |
    | ------------- | --------------- | -------- | ------------------------------------ | ---------------------------------- |
    | PG-P-PERM-01  | 角色管理列表页  | provider | /provider/permission/roles           | 供给侧角色列表，含预置与自定义角色 |
    | PG-P-PERM-02  | 角色详情页      | provider | /provider/permission/roles/:id       | 查看角色权限配置详情               |
    | PG-P-PERM-03  | 角色创建/编辑页 | provider | /provider/permission/roles/create    | 创建或编辑自定义角色               |
    | PG-UP-PERM-01 | 权限定义管理页  | provider | /platform/permission/definitions     | 平台管理员维护全局权限定义         |
    | PG-UP-PERM-02 | 角色互斥配置页  | provider | /platform/permission/role-conflicts  | 平台管理员配置角色互斥规则         |
    | PG-UR-PERM-01 | 角色管理列表页  | ur       | /tenant/permission/roles             | 租户角色列表，含系统与自定义角色   |
    | PG-UR-PERM-02 | 角色创建/编辑页 | ur       | /tenant/permission/roles/create      | 租户管理员创建或编辑自定义角色     |
    | PG-UR-PERM-03 | 角色详情页      | ur       | /tenant/permission/roles/:id         | 查看角色权限与数据权限配置详情     |
    | PG-UR-PERM-04 | 数据授权列表页  | ur       | /tenant/permission/data-access       | 管理数据授权记录                   |
    | PG-UR-PERM-05 | 数据授权申请页  | ur       | /tenant/permission/data-access/apply | 申请跨部门数据访问权限             |

    表 6.8.1-1 授权管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │                      供给侧后台导航                                  │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │    权限管理                                                          │
    │    ├── 角色管理                                                      │
    │    │   ├── [PG-P-PERM-01] 角色管理列表页                             │
    │    │   │   ├── [PG-P-PERM-02] 角色详情页                             │
    │    │   │   └── [PG-P-PERM-03] 角色创建/编辑页                        │
    │    └── 平台管理（仅管理员可见）                                      │
    │        ├── [PG-UP-PERM-01] 权限定义管理页                            │
    │        └── [PG-UP-PERM-02] 角色互斥配置页                            │
    │                                                                      │
    ├──────────────────────────────────────────────────────────────────────┤
    │                      租户管理后台导航                                │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │    权限管理                                                          │
    │    ├── 角色管理                                                      │
    │    │   ├── [PG-UR-PERM-01] 角色管理列表页                            │
    │    │   │   ├── [PG-UR-PERM-02] 角色创建/编辑页                       │
    │    │   │   └── [PG-UR-PERM-03] 角色详情页                            │
    │    └── 数据授权                                                      │
    │        ├── [PG-UR-PERM-04] 数据授权列表页                            │
    │        │   └── [PG-UR-PERM-05] 数据授权申请页                        │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.1-1 授权管理页面导航结构

### 6.8.2 供给侧角色管理

#### 6.8.2.1 PG-P-PERM-01 角色管理列表页

+   页面说明：
    -   用途：管理供给侧全部角色，包括系统预置角色和平台自定义角色，支持查询、创建、编辑、删除操作
    -   入口：供给侧后台 → 权限管理 → 角色管理
    -   权限：provider:iam:role:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-P-PERM-01 角色管理                                                       │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理                                                    │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 搜索区域 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色名称/编码        角色类型            状态                         │  │
    │  │  ┌────────────────┐  ┌──────────────┐    ┌──────────────┐              │  │
    │  │  │                │  │ 全部       ▼ │    │ 全部       ▼ │              │  │
    │  │  └────────────────┘  └──────────────┘    └──────────────┘              │  │
    │  │                                                                        │  │
    │  │                                              ┌────┐  ┌────┐            │  │
    │  │                                              │搜索│  │重置│            │  │
    │  │                                              └────┘  └────┘            │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 工具栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                                        ┌────────────┐  │  │
    │  │                                                        │ + 新建角色 │  │  │
    │  │                                                        └────────────┘  │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 数据列表 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌────────┬──────────┬──────┬──────┬────────┬────────┬──────────────┐  │  │
    │  │  │角色编码│ 角色名称 │ 类型 │ 状态 │用户数量│创建时间│    操作      │  │  │
    │  │  ├────────┼──────────┼──────┼──────┼────────┼────────┼──────────────┤  │  │
    │  │  │ UP-06  │平台管理员│预置  │●启用 │   3    │系统预置│ 查看         │  │  │
    │  │  ├────────┼──────────┼──────┼──────┼────────┼────────┼──────────────┤  │  │
    │  │  │ C-001  │运营主管  │自定义│●启用 │   2    │01-25   │查看 编辑 删除│  │  │
    │  │  └────────┴──────────┴──────┴──────┴────────┴────────┴──────────────┘  │  │
    │  │                                                                        │  │
    │  │  共 14 条  < 1 2 >     每页 10 条                                      │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.2.1-1 角色管理列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                 | 关联API   | 前置条件                 |
    | -------- | -------- | ------------ | ------------------------------------ | --------- | ------------------------ |
    | F01      | 展示     | 加载角色列表 | 进入页面时加载角色分页列表           | P-PERM-02 | provider:iam:role:list   |
    | F02      | 操作     | 搜索         | 按条件查询角色列表                   | P-PERM-02 | provider:iam:role:list   |
    | F03      | 操作     | 重置         | 清空搜索条件并刷新列表               | -         | -                        |
    | F04      | 操作     | 新建角色     | 跳转至角色创建页                     | -         | provider:iam:role:create |
    | F05      | 操作     | 查看         | 跳转至角色详情页                     | P-PERM-03 | provider:iam:role:detail |
    | F06      | 操作     | 编辑         | 跳转至角色编辑页（仅自定义角色可见） | -         | provider:iam:role:update |
    | F07      | 操作     | 删除         | 删除自定义角色（二次确认弹窗）       | P-PERM-06 | provider:iam:role:delete |

    表 6.8.2.1-1 角色管理列表页功能说明

+   搜索条件：

    | 字段名        | 组件类型 | 数据来源 | 默认值 | 说明                             |
    | ------------- | -------- | -------- | ------ | -------------------------------- |
    | 角色名称/编码 | Input    | 用户输入 | 空     | 模糊匹配角色名称或角色编码       |
    | 角色类型      | Select   | 字典     | 全部   | 枚举值：全部 / 系统预置 / 自定义 |
    | 状态          | Select   | 字典     | 全部   | 枚举值：全部 / 启用 / 禁用       |

    表 6.8.2.1-2 角色管理列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                                       |
    | -------- | ---- | ---- | -------- | ------------------------------------------ |
    | 角色编码 | 120  | 左   | 是       | 预置角色显示UP-xx编码，自定义角色显示C-xxx |
    | 角色名称 | 150  | 左   | 否       | 角色中文名称                               |
    | 类型     | 80   | 中   | 否       | 标签展示，见状态/标签展示                  |
    | 状态     | 80   | 中   | 否       | 标签展示，见状态/标签展示                  |
    | 用户数量 | 80   | 中   | 是       | 已分配该角色的用户数                       |
    | 创建时间 | 150  | 中   | 是       | 预置角色显示"系统预置"，自定义角色显示日期 |
    | 操作     | auto | 中   | 否       | 预置角色仅显示"查看"，自定义角色显示全部   |

    表 6.8.2.1-3 角色管理列表页列表字段

+   状态/标签展示：

    | 枚举值   | 标签文本 | 标签颜色 |
    | -------- | -------- | -------- |
    | PRESET   | 系统预置 | 蓝色     |
    | CUSTOM   | 自定义   | 绿色     |
    | ENABLED  | 启用     | 绿色     |
    | DISABLED | 禁用     | 灰色     |

    表 6.8.2.1-4 角色类型与状态标签展示

+   交互规则：
    -   预置角色行的操作列仅显示"查看"按钮，不显示"编辑"和"删除"
    -   删除操作需二次确认，弹窗提示"确认删除角色'{角色名}'？已分配该角色的用户将失去对应权限。"
    -   删除角色时若仍有用户关联，弹窗追加警告"当前有{N}个用户使用此角色"

#### 6.8.2.2 PG-P-PERM-02 角色详情页

+   页面说明：
    -   用途：查看角色基本信息、已配置的权限树、已分配的用户列表
    -   入口：角色管理列表页 → 查看按钮
    -   权限：provider:iam:role:detail

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-P-PERM-02 角色详情                                                       │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理 / 角色详情                                         │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 基本信息卡片 ─────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色编码：UP-06                    角色类型：系统预置                 │  │
    │  │  角色名称：平台管理员               状  态：●启用                      │  │
    │  │  角色描述：负责平台用户管理和系统配置                                  │  │
    │  │  创建时间：系统预置                 已分配用户数：3                    │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ Tab 页签 ─────────────────────────────────────────────────────────────┐  │
    │  │  [权限配置]  [已分配用户]                                              │  │
    │  ├────────────────────────────────────────────────────────────────────────┤  │
    │  │                                                                        │  │
    │  │  ┌─ 权限树（只读） ─────────────────────────────────────────────────┐  │  │
    │  │  │  ☑ 用户管理                                                      │  │  │
    │  │  │    ☑ 用户列表                                                    │  │  │
    │  │  │      ☑ 创建用户    ☑ 编辑用户    ☑ 删除用户    ☑ 禁用用户        │  │  │
    │  │  │  ☑ 系统配置                                                      │  │  │
    │  │  │    ☑ 参数管理                                                    │  │  │
    │  │  │    ☐ 字典管理                                                    │  │  │
    │  │  │  ☐ 权限管理                                                      │  │  │
    │  │  └──────────────────────────────────────────────────────────────────┘  │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 操作栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                                        ┌────────┐      │  │
    │  │                                                        │  返回  │      │  │
    │  │                                                        └────────┘      │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.2.2-1 角色详情页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                    | 关联API   | 前置条件                 |
    | -------- | -------- | -------------- | --------------------------------------- | --------- | ------------------------ |
    | F08      | 展示     | 加载角色详情   | 进入页面时加载角色基本信息              | P-PERM-03 | provider:iam:role:detail |
    | F09      | 展示     | 加载权限树     | 加载该角色已配置的权限树（只读）        | P-PERM-01 | provider:iam:role:detail |
    | F10      | 展示     | 加载已分配用户 | 切换至"已分配用户"Tab时加载分页用户列表 | P-PERM-02 | provider:iam:role:detail |
    | F11      | 操作     | 返回           | 返回角色管理列表页                      | -         | -                        |

    表 6.8.2.2-1 角色详情页功能说明

+   交互规则：
    -   权限配置Tab：以只读权限树展示该角色已勾选的权限节点，已勾选节点标记为☑，未勾选标记为☐
    -   已分配用户Tab：以分页列表展示已分配该角色的用户，显示用户名、姓名、用户类型、分配时间

#### 6.8.2.3 PG-P-PERM-03 角色创建/编辑页

+   页面说明：
    -   用途：创建新的自定义角色或编辑已有自定义角色，配置角色的权限
    -   入口：角色管理列表页 → 新建角色按钮 / 编辑按钮
    -   权限：provider:iam:role:create（新建） / provider:iam:role:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-P-PERM-03 新建角色 / 编辑角色                                            │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理 / 新建角色                                         │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 基本信息 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色名称 *                    角色编码 *                              │  │
    │  │  ┌────────────────────────┐   ┌────────────────────────┐               │  │
    │  │  │                        │   │                        │               │  │
    │  │  └────────────────────────┘   └────────────────────────┘               │  │
    │  │                                                                        │  │
    │  │  角色描述                                                              │  │
    │  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                                                                  │  │  │
    │  │  └──────────────────────────────────────────────────────────────────┘  │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 权限配置 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌─ 权限树（可勾选） ────────────────────────────────────────────┐     │  │
    │  │  │                                                               │     │  │
    │  │  │  全选/全不选 ☐                    搜索权限 ┌──────────────┐   │     │  │
    │  │  │                                            │              │   │     │  │
    │  │  │                                            └──────────────┘   │     │  │
    │  │  │                                                               │     │  │
    │  │  │  ☐ 用户管理                                                   │     │  │
    │  │  │    ☐ 用户列表                                                 │     │  │
    │  │  │      ☐ 创建用户   ☐ 编辑用户   ☐ 删除用户   ☐ 禁用用户        │     │  │
    │  │  │  ☐ 权限管理                                                   │     │  │
    │  │  │    ☐ 角色管理                                                 │     │  │
    │  │  │      ☐ 创建角色   ☐ 编辑角色   ☐ 删除角色                     │     │  │
    │  │  │    ☐ 权限配置                                                 │     │  │
    │  │  │  ☐ 系统配置                                                   │     │  │
    │  │  │    ☐ 参数管理   ☐ 字典管理                                    │     │  │
    │  │  │                                                               │     │  │
    │  │  └───────────────────────────────────────────────────────────────┘     │  │
    │  │                                                                        │  │
    │  │  已选权限：8 / 共 24                                                   │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 操作栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                    ┌────────┐  ┌────────┐              │  │
    │  │                                    │  取消  │  │  提交  │              │  │
    │  │                                    └────────┘  └────────┘              │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.2.3-1 角色创建/编辑页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                           | 关联API   | 前置条件                               |
    | -------- | -------- | ------------ | ---------------------------------------------- | --------- | -------------------------------------- |
    | F12      | 展示     | 加载权限树   | 进入页面时加载可勾选的权限树                   | P-PERM-01 | provider:iam:role:create               |
    | F13      | 展示     | 加载角色信息 | 编辑模式下加载角色已有信息和已配置的权限       | P-PERM-03 | provider:iam:role:update               |
    | F14      | 操作     | 取消         | 放弃编辑，返回角色管理列表页                   | -         | -                                      |
    | F15      | 操作     | 提交（新建） | 创建角色并保存权限配置                         | P-PERM-04 | provider:iam:role:create，必填校验通过 |
    | F16      | 操作     | 提交（编辑） | 更新角色信息并保存权限配置                     | P-PERM-05 | provider:iam:role:update，必填校验通过 |
    | F17      | 操作     | 配置权限     | 保存角色权限配置（编辑模式下权限树变更时触发） | P-PERM-07 | provider:iam:role:update               |

    表 6.8.2.3-1 角色创建/编辑页功能说明

+   交互规则：
    -   编辑模式下角色编码字段只读，不可修改
    -   权限树支持父子联动：勾选父节点自动勾选全部子节点，取消父节点自动取消全部子节点
    -   当子节点部分勾选时，父节点显示半选状态（▣）
    -   权限树支持关键词搜索过滤，高亮匹配节点
    -   提交前校验：角色名称必填，角色编码必填且唯一，至少勾选一个权限

### 6.8.3 供给侧平台管理

#### 6.8.3.1 PG-UP-PERM-01 权限定义管理页

+   页面说明：
    -   用途：平台管理员维护全局权限定义（CATALOG / MENU / BUTTON三级），仅运营方管理员可访问
    -   入口：供给侧后台 → 平台管理 → 权限定义
    -   权限：up:iam:permission:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UP-PERM-01 权限定义管理                                                  │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 平台管理 / 权限定义                                                    │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 搜索区域 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  权限名称/编码         权限类型            用户群           状态       │  │
    │  │  ┌──────────────┐     ┌──────────┐        ┌─────────┐    ┌─────────┐   │  │
    │  │  │              │     │ 全部   ▼ │        │ 全部  ▼ │    │ 全部  ▼ │   │  │
    │  │  └──────────────┘     └──────────┘        └─────────┘    └─────────┘   │  │
    │  │                                                                        │  │
    │  │                                              ┌────┐  ┌────┐            │  │
    │  │                                              │搜索│  │重置│            │  │
    │  │                                              └────┘  └────┘            │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 工具栏 ───────────────────────────────────────────────────────────────┐  │
    │  │  ┌──────────┐                              ┌────────────┐              │  │
    │  │  │ 树形展示 │                              │ + 新建权限 │              │  │
    │  │  └──────────┘                              └────────────┘              │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 数据列表 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌──────────────────┬──────────┬──────┬──────┬──────┬──────────────┐   │  │
    │  │  │   权限编码       │ 权限名称 │ 类型 │用户群│ 状态 │    操作      │   │  │
    │  │  ├──────────────────┼──────────┼──────┼──────┼──────┼──────────────┤   │  │
    │  │  │ur:iam:user       │ 用户管理 │目录  │  UR  │●启用 │ 编辑  禁用   │   │  │
    │  │  ├──────────────────┼──────────┼──────┼──────┼──────┼──────────────┤   │  │
    │  │  │ur:iam:user:list  │ 用户列表 │菜单  │  UR  │●启用 │ 编辑  禁用   │   │  │
    │  │  ├──────────────────┼──────────┼──────┼──────┼──────┼──────────────┤   │  │
    │  │  │ur:iam:user:create│ 创建用户 │按钮  │  UR  │●启用 │ 编辑  禁用   │   │  │
    │  │  └──────────────────┴──────────┴──────┴──────┴──────┴──────────────┘   │  │
    │  │                                                                        │  │
    │  │  共 86 条  < 1 2 3 ... 5 >     每页 20 条                              │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.3.1-1 权限定义管理页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                             | 关联API    | 前置条件                 |
    | -------- | -------- | ------------ | -------------------------------- | ---------- | ------------------------ |
    | F18      | 展示     | 加载权限列表 | 进入页面时加载权限定义分页列表   | UP-PERM-01 | up:iam:permission:list   |
    | F19      | 操作     | 搜索         | 按条件查询权限定义列表           | UP-PERM-01 | up:iam:permission:list   |
    | F20      | 操作     | 重置         | 清空搜索条件并刷新列表           | -          | -                        |
    | F21      | 展示     | 树形展示     | 切换列表/树形两种展示模式        | P-PERM-01  | up:iam:permission:list   |
    | F22      | 操作     | 新建权限     | 打开权限创建弹窗                 | UP-PERM-02 | up:iam:permission:create |
    | F23      | 操作     | 编辑         | 打开权限编辑弹窗（编码不可修改） | UP-PERM-03 | up:iam:permission:update |
    | F24      | 操作     | 禁用         | 禁用权限定义（二次确认弹窗）     | UP-PERM-04 | up:iam:permission:delete |

    表 6.8.3.1-1 权限定义管理页功能说明

+   搜索条件：

    | 字段名        | 组件类型 | 数据来源 | 默认值 | 说明                                   |
    | ------------- | -------- | -------- | ------ | -------------------------------------- |
    | 权限名称/编码 | Input    | 用户输入 | 空     | 模糊匹配权限名称或四段式编码           |
    | 权限类型      | Select   | 字典     | 全部   | 枚举值：全部 / CATALOG / MENU / BUTTON |
    | 用户群        | Select   | 字典     | 全部   | 枚举值：全部 / UP / UR / UC            |
    | 状态          | Select   | 字典     | 全部   | 枚举值：全部 / 启用 / 禁用             |

    表 6.8.3.1-2 权限定义管理页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                             |
    | -------- | ---- | ---- | -------- | -------------------------------- |
    | 权限编码 | 220  | 左   | 是       | 四段式编码，如ur:iam:user:create |
    | 权限名称 | 150  | 左   | 否       | 中文名称                         |
    | 类型     | 80   | 中   | 否       | 标签展示，见状态/标签展示        |
    | 用户群   | 80   | 中   | 否       | UP / UR / UC                     |
    | 状态     | 80   | 中   | 否       | 标签展示                         |
    | 操作     | auto | 中   | 否       | 编辑、禁用/启用                  |

    表 6.8.3.1-3 权限定义管理页列表字段

+   状态/标签展示：

    | 枚举值  | 标签文本 | 标签颜色 |
    | ------- | -------- | -------- |
    | CATALOG | 目录     | 蓝色     |
    | MENU    | 菜单     | 绿色     |
    | BUTTON  | 按钮     | 橙色     |

    表 6.8.3.1-4 权限类型标签展示

+   详情弹窗/抽屉——权限创建/编辑弹窗：

    | 字段名     | 组件类型    | 必填 | 说明                                      |
    | ---------- | ----------- | ---- | ----------------------------------------- |
    | 权限编码   | Input       | 是   | 四段式格式，创建后不可修改                |
    | 权限名称   | Input       | 是   | 中文名称                                  |
    | 权限类型   | Select      | 是   | CATALOG / MENU / BUTTON                   |
    | 所属用户群 | Select      | 是   | UP / UR / UC                              |
    | 父级权限   | TreeSelect  | 否   | 从已有权限树中选择父节点，CATALOG级可为空 |
    | 排序号     | InputNumber | 否   | 同级权限排序，默认0                       |
    | 描述       | Textarea    | 否   | 权限用途描述                              |

    表 6.8.3.1-5 权限创建/编辑弹窗字段

+   交互规则：
    -   禁用权限时需二次确认，提示"禁用后引用该权限的角色将失去对应功能"
    -   已被角色引用的权限禁用前需展示影响范围（引用此权限的角色列表）
    -   权限编码创建后不可修改，编辑弹窗中编码字段只读

#### 6.8.3.2 PG-UP-PERM-02 角色互斥配置页

+   页面说明：
    -   用途：配置和管理角色互斥规则，防止职责冲突的角色分配给同一用户
    -   入口：供给侧后台 → 平台管理 → 角色互斥
    -   权限：up:iam:role-conflict:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UP-PERM-02 角色互斥配置                                                  │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 平台管理 / 角色互斥配置                                                │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 工具栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                                  ┌──────────────────┐  │  │
    │  │                                                  │ + 新建互斥规则   │  │  │
    │  │                                                  └──────────────────┘  │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 数据列表 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌──────────────┬──────────────┬──────┬──────────────┬──────────────┐  │  │
    │  │  │   角色A      │   角色B      │级别  │   互斥原因   │    操作      │  │  │
    │  │  ├──────────────┼──────────────┼──────┼──────────────┼──────────────┤  │  │
    │  │  │UR-06 内审员  │UR-07 安全经理│●禁止 │职责冲突      │    删除      │  │  │
    │  │  ├──────────────┼──────────────┼──────┼──────────────┼──────────────┤  │  │
    │  │  │UP-04 方案设计│UP-05 质检审核│●禁止 │不能自审自己  │    删除      │  │  │
    │  │  ├──────────────┼──────────────┼──────┼──────────────┼──────────────┤  │  │
    │  │  │UR-02 制度管理│UR-06 内审员  │▲警告 │不宜兼任      │    删除      │  │  │
    │  │  └──────────────┴──────────────┴──────┴──────────────┴──────────────┘  │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.3.2-1 角色互斥配置页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称         | 说明                         | 关联API    | 前置条件                    |
    | -------- | -------- | ---------------- | ---------------------------- | ---------- | --------------------------- |
    | F25      | 展示     | 加载互斥规则列表 | 进入页面时加载互斥规则列表   | UP-PERM-05 | up:iam:role-conflict:list   |
    | F26      | 操作     | 新建互斥规则     | 打开互斥规则创建弹窗         | UP-PERM-06 | up:iam:role-conflict:create |
    | F27      | 操作     | 删除             | 删除互斥规则（二次确认弹窗） | UP-PERM-07 | up:iam:role-conflict:delete |

    表 6.8.3.2-1 角色互斥配置页功能说明

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                      |
    | -------- | ---- | ---- | -------- | ------------------------- |
    | 角色A    | 180  | 左   | 否       | 角色编码 + 角色名称       |
    | 角色B    | 180  | 左   | 否       | 角色编码 + 角色名称       |
    | 级别     | 80   | 中   | 否       | 标签展示，见状态/标签展示 |
    | 互斥原因 | auto | 左   | 否       | 说明互斥原因              |
    | 操作     | 80   | 中   | 否       | 删除                      |

    表 6.8.3.2-2 角色互斥配置页列表字段

+   状态/标签展示：

    | 枚举值  | 标签文本 | 标签颜色 |
    | ------- | -------- | -------- |
    | FORBID  | 禁止     | 红色     |
    | WARNING | 警告     | 橙色     |

    表 6.8.3.2-3 互斥级别标签展示

+   详情弹窗/抽屉——互斥规则创建弹窗：

    | 字段名   | 组件类型 | 必填 | 说明                                        |
    | -------- | -------- | ---- | ------------------------------------------- |
    | 角色A    | Select   | 是   | 从系统预置角色和自定义角色中选择            |
    | 角色B    | Select   | 是   | 从系统预置角色和自定义角色中选择，不可与A同 |
    | 互斥级别 | Select   | 是   | 禁止 / 警告                                 |
    | 互斥原因 | Textarea | 是   | 说明互斥原因                                |

    表 6.8.3.2-4 互斥规则创建弹窗字段

+   交互规则：
    -   角色A和角色B不可选择相同角色
    -   互斥规则为双向生效，A-B和B-A视为同一条规则，系统自动去重
    -   删除操作需二次确认弹窗

### 6.8.4 租户侧角色管理

#### 6.8.4.1 PG-UR-PERM-01 角色管理列表页

+   页面说明：
    -   用途：租户管理员管理本租户角色，包括查看系统预置角色和管理自定义角色
    -   入口：租户后台 → 权限管理 → 角色管理
    -   权限：ur:iam:role:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-PERM-01 角色管理                                                      │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理                                                    │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 搜索区域 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色名称/编码        角色类型            数据权限范围                 │  │
    │  │  ┌────────────────┐  ┌──────────────┐    ┌──────────────┐              │  │
    │  │  │                │  │ 全部       ▼ │    │ 全部       ▼ │              │  │
    │  │  └────────────────┘  └──────────────┘    └──────────────┘              │  │
    │  │                                              ┌────┐  ┌────┐            │  │
    │  │                                              │搜索│  │重置│            │  │
    │  │                                              └────┘  └────┘            │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 工具栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                                  ┌────────────┐        │  │
    │  │                                                  │ + 新建角色 │        │  │
    │  │                                                  └────────────┘        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 数据列表 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌────────┬────────┬──────┬──────────┬────────┬────────┬────────────┐  │  │
    │  │  │角色编码│角色名称│ 类型 │数据权限  │用户数量│创建时间│   操作     │  │  │
    │  │  ├────────┼────────┼──────┼──────────┼────────┼────────┼────────────┤  │  │
    │  │  │UR-01   │ CISO   │预置  │ 全部数据 │   1    │系统预置│ 查看 分配  │  │  │
    │  │  ├────────┼────────┼──────┼──────────┼────────┼────────┼────────────┤  │  │
    │  │  │UR-02   │制度管理│预置  │部门及下级│   5    │系统预置│ 查看 分配  │  │  │
    │  │  ├────────┼────────┼──────┼──────────┼────────┼────────┼────────────┤  │  │
    │  │  │T-001   │安全顾问│自定义│ 仅本人   │   3    │01-20   │查看 编 删  │  │  │
    │  │  └────────┴────────┴──────┴──────────┴────────┴────────┴────────────┘  │  │
    │  │                                                                        │  │
    │  │  共 19 条  < 1 2 >     每页 10 条                                      │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.4.1-1 租户角色管理列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                         | 关联API    | 前置条件           |
    | -------- | -------- | ------------ | -------------------------------------------- | ---------- | ------------------ |
    | F28      | 展示     | 加载角色列表 | 进入页面时加载角色分页列表                   | UR-PERM-02 | ur:iam:role:list   |
    | F29      | 操作     | 搜索         | 按条件查询角色列表                           | UR-PERM-02 | ur:iam:role:list   |
    | F30      | 操作     | 重置         | 清空搜索条件并刷新列表                       | -          | -                  |
    | F31      | 操作     | 新建角色     | 跳转至角色创建页                             | -          | ur:iam:role:create |
    | F32      | 操作     | 查看         | 跳转至角色详情页                             | UR-PERM-03 | ur:iam:role:detail |
    | F33      | 操作     | 分配         | 打开用户选择弹窗，为该角色分配用户           | UR-PERM-08 | ur:iam:role:assign |
    | F34      | 操作     | 编辑         | 跳转至角色编辑页（仅自定义角色可见）         | -          | ur:iam:role:update |
    | F35      | 操作     | 删除         | 删除自定义角色（二次确认弹窗，仅自定义角色） | UR-PERM-06 | ur:iam:role:delete |

    表 6.8.4.1-1 租户角色管理列表页功能说明

+   搜索条件：

    | 字段名        | 组件类型 | 数据来源 | 默认值 | 说明                                                     |
    | ------------- | -------- | -------- | ------ | -------------------------------------------------------- |
    | 角色名称/编码 | Input    | 用户输入 | 空     | 模糊匹配角色名称或角色编码                               |
    | 角色类型      | Select   | 字典     | 全部   | 枚举值：全部 / 系统预置 / 自定义                         |
    | 数据权限范围  | Select   | 字典     | 全部   | 枚举值：全部 / 全部数据 / 部门及下级 / 仅本部门 / 仅本人 |

    表 6.8.4.1-2 租户角色管理列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                                       |
    | -------- | ---- | ---- | -------- | ------------------------------------------ |
    | 角色编码 | 100  | 左   | 是       | 预置角色显示UR-xx，自定义角色显示T-xxx     |
    | 角色名称 | 120  | 左   | 否       | 角色中文名称                               |
    | 类型     | 80   | 中   | 否       | 标签展示，引用表 6.8.2.1-4                 |
    | 数据权限 | 100  | 中   | 否       | 标签展示，见状态/标签展示                  |
    | 用户数量 | 80   | 中   | 是       | 已分配该角色的用户数                       |
    | 创建时间 | 130  | 中   | 是       | 预置角色显示"系统预置"，自定义角色显示日期 |
    | 操作     | auto | 中   | 否       | 按角色类型显示不同操作按钮                 |

    表 6.8.4.1-3 租户角色管理列表页列表字段

+   状态/标签展示：

    | 枚举值 | 标签文本   | 标签颜色 |
    | ------ | ---------- | -------- |
    | 1      | 全部数据   | 蓝色     |
    | 2      | 部门及下级 | 绿色     |
    | 3      | 仅本部门   | 橙色     |
    | 4      | 仅本人     | 灰色     |

    表 6.8.4.1-4 数据权限范围标签展示

+   交互规则：
    -   系统预置角色行操作列显示"查看"和"分配"，不显示"编辑"和"删除"
    -   自定义角色行操作列显示"查看""编辑""删除"
    -   分配操作打开用户选择弹窗，可多选用户并批量分配角色，分配时自动检查互斥规则

#### 6.8.4.2 PG-UR-PERM-02 角色创建/编辑页

+   页面说明：
    -   用途：租户管理员创建或编辑自定义角色，配置功能权限和数据权限范围
    -   入口：角色管理列表页 → 新建角色按钮 / 编辑按钮
    -   权限：ur:iam:role:create（新建） / ur:iam:role:update（编辑）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-PERM-02 新建角色 / 编辑角色                                           │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理 / 新建角色                                         │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 基本信息 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色名称 *                    角色编码 *                              │  │
    │  │  ┌────────────────────────┐   ┌────────────────────────┐               │  │
    │  │  │                        │   │                        │               │  │
    │  │  └────────────────────────┘   └────────────────────────┘               │  │
    │  │                                                                        │  │
    │  │  角色描述                      数据权限范围 *                          │  │
    │  │  ┌────────────────────────┐   ┌────────────────────────┐               │  │
    │  │  │                        │   │ 请选择               ▼ │               │  │
    │  │  └────────────────────────┘   └────────────────────────┘               │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 功能权限配置 ─────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌─ 权限树（可勾选，仅展示UR权限） ──────────────────────────────┐     │  │
    │  │  │                                                               │     │  │
    │  │  │  全选/全不选 ☐                    搜索权限 ┌──────────────┐   │     │  │
    │  │  │                                            │              │   │     │  │
    │  │  │                                            └──────────────┘   │     │  │
    │  │  │                                                               │     │  │
    │  │  │  ☐ 用户管理                                                   │     │  │
    │  │  │    ☐ 用户列表                                                 │     │  │
    │  │  │      ☐ 创建用户   ☐ 编辑用户   ☐ 删除用户                     │     │  │
    │  │  │  ☐ 制度管理                                                   │     │  │
    │  │  │    ☐ 制度列表                                                 │     │  │
    │  │  │      ☐ 创建制度   ☐ 审批制度   ☐ 发布制度                     │     │  │
    │  │  │  ☐ 风险管理                                                   │     │  │
    │  │  │    ☐ 风险评估   ☐ 风险处置                                    │     │  │
    │  │  │                                                               │     │  │
    │  │  └───────────────────────────────────────────────────────────────┘     │  │
    │  │                                                                        │  │
    │  │  已选权限：12 / 共 45                                                  │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 操作栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                    ┌────────┐  ┌────────┐              │  │
    │  │                                    │  取消  │  │  提交  │              │  │
    │  │                                    └────────┘  └────────┘              │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.4.2-1 租户角色创建/编辑页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                           | 关联API    | 前置条件                         |
    | -------- | -------- | ------------ | ---------------------------------------------- | ---------- | -------------------------------- |
    | F36      | 展示     | 加载权限树   | 进入页面时加载UR用户群的可勾选权限树           | UR-PERM-01 | ur:iam:role:create               |
    | F37      | 展示     | 加载角色信息 | 编辑模式下加载角色已有信息和已配置的权限       | UR-PERM-03 | ur:iam:role:update               |
    | F38      | 操作     | 取消         | 放弃编辑，返回角色管理列表页                   | -          | -                                |
    | F39      | 操作     | 提交（新建） | 创建角色并保存权限及数据权限范围配置           | UR-PERM-04 | ur:iam:role:create，必填校验通过 |
    | F40      | 操作     | 提交（编辑） | 更新角色信息并保存权限及数据权限范围配置       | UR-PERM-05 | ur:iam:role:update，必填校验通过 |
    | F41      | 操作     | 配置权限     | 保存角色权限配置（编辑模式下权限树变更时触发） | UR-PERM-07 | ur:iam:role:update               |

    表 6.8.4.2-1 租户角色创建/编辑页功能说明

+   交互规则：
    -   权限树仅展示UR用户群的权限节点
    -   权限树支持父子联动勾选和关键词搜索过滤
    -   数据权限范围为必选项，选项包括：全部数据、部门及下级、仅本部门、仅本人
    -   编辑模式下角色编码字段只读
    -   提交前校验：角色名称必填、角色编码必填且租户内唯一、至少勾选一个权限、数据权限范围必选

#### 6.8.4.3 PG-UR-PERM-03 角色详情页

+   页面说明：
    -   用途：查看角色基本信息、权限配置、数据权限范围和已分配用户
    -   入口：角色管理列表页 → 查看按钮
    -   权限：ur:iam:role:detail

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-PERM-03 角色详情                                                      │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 角色管理 / 角色详情                                         │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 基本信息卡片 ─────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  角色编码：UR-01                    角色类型：系统预置                 │  │
    │  │  角色名称：CISO                     数据权限：全部数据                │  │
    │  │  角色描述：首席信息安全官，拥有全部数据读取与安全配置权限             │  │
    │  │  创建时间：系统预置                 已分配用户数：1                    │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ Tab 页签 ─────────────────────────────────────────────────────────────┐  │
    │  │  [权限配置]  [已分配用户]                                              │  │
    │  ├────────────────────────────────────────────────────────────────────────┤  │
    │  │                                                                        │  │
    │  │  ┌─ 权限树（只读） ─────────────────────────────────────────────────┐  │  │
    │  │  │  ☑ 用户管理                                                      │  │  │
    │  │  │    ☑ 用户列表                                                    │  │  │
    │  │  │  ☑ 制度管理                                                      │  │  │
    │  │  │    ☑ 制度列表     ☑ 审批制度                                     │  │  │
    │  │  │  ☑ 风险管理                                                      │  │  │
    │  │  │    ☑ 风险评估     ☑ 风险处置                                     │  │  │
    │  │  └──────────────────────────────────────────────────────────────────┘  │  │
    │  │                                                                        │  │
    │  │  ── 已分配用户Tab ──────────────────────────────────────────────────   │  │
    │  │  ┌──────────┬──────┬──────────┬──────────┬──────────┐                 │  │
    │  │  │  用户名  │ 姓名 │   部门   │ 分配时间 │   操作   │                 │  │
    │  │  ├──────────┼──────┼──────────┼──────────┼──────────┤                 │  │
    │  │  │ admin    │ 张三 │ 安全部   │ 01-15    │   移除   │                 │  │
    │  │  └──────────┴──────┴──────────┴──────────┴──────────┘                 │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 操作栏 ───────────────────────────────────────────────────────────────┐  │
    │  │  ┌──────────┐                                      ┌────────┐          │  │
    │  │  │ + 分配用户│                                      │  返回  │          │  │
    │  │  └──────────┘                                      └────────┘          │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.4.3-1 租户角色详情页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称       | 说明                                     | 关联API    | 前置条件           |
    | -------- | -------- | -------------- | ---------------------------------------- | ---------- | ------------------ |
    | F42      | 展示     | 加载角色详情   | 进入页面时加载角色基本信息和数据权限范围 | UR-PERM-03 | ur:iam:role:detail |
    | F43      | 展示     | 加载权限树     | 加载该角色已配置的权限树（只读）         | UR-PERM-01 | ur:iam:role:detail |
    | F44      | 展示     | 加载已分配用户 | 切换至"已分配用户"Tab时加载分页用户列表  | UR-PERM-03 | ur:iam:role:detail |
    | F45      | 操作     | 分配用户       | 打开用户选择弹窗，为该角色分配用户       | UR-PERM-08 | ur:iam:role:assign |
    | F46      | 操作     | 移除用户       | 移除用户已分配的角色（二次确认弹窗）     | UR-PERM-09 | ur:iam:role:assign |
    | F47      | 操作     | 返回           | 返回角色管理列表页                       | -          | -                  |

    表 6.8.4.3-1 租户角色详情页功能说明

+   交互规则：
    -   详情页包含两个Tab：权限配置（只读权限树）、已分配用户
    -   已分配用户Tab以列表展示，包含用户名、姓名、部门、分配时间列，支持分配和移除操作
    -   移除用户角色需二次确认弹窗

### 6.8.5 租户侧数据授权

#### 6.8.5.1 PG-UR-PERM-04 数据授权列表页

+   页面说明：
    -   用途：管理跨部门数据授权记录，支持查询、申请和撤销数据授权
    -   入口：租户后台 → 权限管理 → 数据授权
    -   权限：ur:iam:data-access:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-PERM-04 数据授权                                                      │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 数据授权                                                    │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 搜索区域 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  申请人               目标部门            审批状态                     │  │
    │  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │  │
    │  │  │              │    │            ▼ │    │ 全部       ▼ │              │  │
    │  │  └──────────────┘    └──────────────┘    └──────────────┘              │  │
    │  │                                                                        │  │
    │  │  申请时间                                    ┌────┐  ┌────┐            │  │
    │  │  ┌──────────────────────────┐                │搜索│  │重置│            │  │
    │  │  │ 选择日期范围             │                └────┘  └────┘            │  │
    │  │  └──────────────────────────┘                                          │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 工具栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                                  ┌────────────────┐    │  │
    │  │                                                  │ + 申请数据授权 │    │  │
    │  │                                                  └────────────────┘    │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 数据列表 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  ┌──────┬──────────┬──────────┬───────┬──────────┬──────────┬────────┐ │  │
    │  │  │申请人│ 目标部门 │ 授权范围 │ 状态  │ 有效期至 │ 申请时间 │  操作  │ │  │
    │  │  ├──────┼──────────┼──────────┼───────┼──────────┼──────────┼────────┤ │  │
    │  │  │张三  │ 合规部   │ 制度数据 │●已通过│2026-07-01│01-20     │ 撤销   │ │  │
    │  │  ├──────┼──────────┼──────────┼───────┼──────────┼──────────┼────────┤ │  │
    │  │  │李四  │ 安全部   │ 风险数据 │●待审批│  -       │01-25     │ 审批   │ │  │
    │  │  ├──────┼──────────┼──────────┼───────┼──────────┼──────────┼────────┤ │  │
    │  │  │王五  │ 审计部   │ 审计数据 │●已拒绝│  -       │01-22     │   -    │ │  │
    │  │  └──────┴──────────┴──────────┴───────┴──────────┴──────────┴────────┘ │  │
    │  │                                                                        │  │
    │  │  共 12 条  < 1 >     每页 10 条                                        │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.5.1-1 数据授权列表页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                 | 关联API    | 前置条件                   |
    | -------- | -------- | ------------ | ------------------------------------ | ---------- | -------------------------- |
    | F48      | 展示     | 加载授权列表 | 进入页面时加载数据授权分页列表       | UR-PERM-14 | ur:iam:data-access:list    |
    | F49      | 操作     | 搜索         | 按条件查询数据授权记录               | UR-PERM-14 | ur:iam:data-access:list    |
    | F50      | 操作     | 重置         | 清空搜索条件并刷新列表               | -          | -                          |
    | F51      | 操作     | 申请数据授权 | 跳转至数据授权申请页                 | -          | ur:iam:data-access:apply   |
    | F52      | 操作     | 撤销         | 撤销已通过的数据授权（二次确认弹窗） | UR-PERM-15 | ur:iam:data-access:revoke  |
    | F53      | 操作     | 审批         | 打开审批弹窗，审批通过或拒绝         | UR-PERM-16 | ur:iam:data-access:approve |

    表 6.8.5.1-1 数据授权列表页功能说明

+   搜索条件：

    | 字段名   | 组件类型   | 数据来源 | 默认值 | 说明                                    |
    | -------- | ---------- | -------- | ------ | --------------------------------------- |
    | 申请人   | Input      | 用户输入 | 空     | 模糊匹配申请人用户名或姓名              |
    | 目标部门 | TreeSelect | 接口     | 空     | 从组织架构树中选择                      |
    | 审批状态 | Select     | 字典     | 全部   | 枚举值：全部 / 待审批 / 已通过 / 已拒绝 |
    | 申请时间 | DateRange  | 用户选择 | 空     | 开始时间~结束时间                       |

    表 6.8.5.1-2 数据授权列表页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                          |
    | -------- | ---- | ---- | -------- | ----------------------------- |
    | 申请人   | 100  | 左   | 否       | 申请人姓名                    |
    | 目标部门 | 120  | 左   | 否       | 申请访问的目标部门名称        |
    | 授权范围 | 120  | 左   | 否       | 授权的数据范围描述            |
    | 状态     | 80   | 中   | 否       | 标签展示，见状态/标签展示     |
    | 有效期至 | 100  | 中   | 是       | 授权到期日期，未通过则显示"-" |
    | 申请时间 | 130  | 中   | 是       | 申请提交时间，默认降序        |
    | 操作     | 80   | 中   | 否       | 按状态显示不同操作            |

    表 6.8.5.1-3 数据授权列表页列表字段

+   状态/标签展示：

    | 枚举值   | 标签文本 | 标签颜色 |
    | -------- | -------- | -------- |
    | PENDING  | 待审批   | 橙色     |
    | APPROVED | 已通过   | 绿色     |
    | REJECTED | 已拒绝   | 红色     |
    | EXPIRED  | 已过期   | 灰色     |

    表 6.8.5.1-4 数据授权审批状态标签展示

+   交互规则：
    -   "审批"按钮仅对审批状态为"待审批"的记录可见，且仅具有审批权限的管理员可见
    -   "撤销"按钮仅对审批状态为"已通过"的记录可见
    -   审批弹窗包含通过和拒绝两个选项，拒绝时需填写拒绝原因

#### 6.8.5.2 PG-UR-PERM-05 数据授权申请页

+   页面说明：
    -   用途：用户申请跨部门数据访问权限
    -   入口：数据授权列表页 → 申请数据授权按钮
    -   权限：ur:iam:data-access:apply

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  PG-UR-PERM-05 申请数据授权                                                  │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 面包屑 ───────────────────────────────────────────────────────────────┐  │
    │  │ 权限管理 / 数据授权 / 申请数据授权                                     │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 表单区域 ─────────────────────────────────────────────────────────────┐  │
    │  │                                                                        │  │
    │  │  目标部门 *                    授权范围 *                              │  │
    │  │  ┌────────────────────────┐   ┌────────────────────────┐               │  │
    │  │  │ 请选择部门           ▼ │   │ 请选择               ▼ │               │  │
    │  │  └────────────────────────┘   └────────────────────────┘               │  │
    │  │                                                                        │  │
    │  │  有效期 *                                                              │  │
    │  │  ┌────────────────────────┐                                            │  │
    │  │  │ 选择日期               │                                            │  │
    │  │  └────────────────────────┘                                            │  │
    │  │                                                                        │  │
    │  │  申请理由 *                                                            │  │
    │  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
    │  │  │                                                                  │  │  │
    │  │  │                                                                  │  │  │
    │  │  └──────────────────────────────────────────────────────────────────┘  │  │
    │  │                                                                        │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    │  ┌─ 操作栏 ───────────────────────────────────────────────────────────────┐  │
    │  │                                    ┌────────┐  ┌────────┐              │  │
    │  │                                    │  取消  │  │  提交  │              │  │
    │  │                                    └────────┘  └────────┘              │  │
    │  └────────────────────────────────────────────────────────────────────────┘  │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 6.8.5.2-1 数据授权申请页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称 | 说明                       | 关联API    | 前置条件                               |
    | -------- | -------- | -------- | -------------------------- | ---------- | -------------------------------------- |
    | F54      | 操作     | 取消     | 放弃申请，返回数据授权列表 | -          | -                                      |
    | F55      | 操作     | 提交     | 提交数据授权申请           | UR-PERM-13 | ur:iam:data-access:apply，必填校验通过 |

    表 6.8.5.2-1 数据授权申请页功能说明

+   交互规则：
    -   目标部门从组织架构树中选择，不可选择自己所属部门
    -   授权范围为预定义的数据资源类型列表，如制度数据、风险数据、审计数据等
    -   有效期不可选择过去的日期，最长有效期为1年
    -   提交后跳转至数据授权列表页，新记录状态为"待审批"

### 6.8.6 页面与接口映射

+   授权管理页面与后端接口的映射关系如下表所示。

    | 页面编号      | 页面功能     | 调用接口                    |
    | ------------- | ------------ | --------------------------- |
    | PG-P-PERM-01  | 加载角色列表 | P-PERM-02 查询角色列表      |
    | PG-P-PERM-01  | 搜索角色     | P-PERM-02 查询角色列表      |
    | PG-P-PERM-01  | 删除角色     | P-PERM-06 删除自定义角色    |
    | PG-P-PERM-02  | 加载角色详情 | P-PERM-03 查询角色详情      |
    | PG-P-PERM-02  | 加载权限树   | P-PERM-01 查询权限树        |
    | PG-P-PERM-03  | 加载权限树   | P-PERM-01 查询权限树        |
    | PG-P-PERM-03  | 加载角色信息 | P-PERM-03 查询角色详情      |
    | PG-P-PERM-03  | 创建角色     | P-PERM-04 创建自定义角色    |
    | PG-P-PERM-03  | 编辑角色     | P-PERM-05 更新角色信息      |
    | PG-P-PERM-03  | 配置权限     | P-PERM-07 配置角色权限      |
    | PG-UP-PERM-01 | 加载权限列表 | UP-PERM-01 查询权限定义列表 |
    | PG-UP-PERM-01 | 搜索权限     | UP-PERM-01 查询权限定义列表 |
    | PG-UP-PERM-01 | 树形展示     | P-PERM-01 查询权限树        |
    | PG-UP-PERM-01 | 新建权限     | UP-PERM-02 创建权限定义     |
    | PG-UP-PERM-01 | 编辑权限     | UP-PERM-03 更新权限定义     |
    | PG-UP-PERM-01 | 禁用权限     | UP-PERM-04 删除权限定义     |
    | PG-UP-PERM-02 | 加载互斥规则 | UP-PERM-05 查询角色互斥配置 |
    | PG-UP-PERM-02 | 新建互斥规则 | UP-PERM-06 创建角色互斥配置 |
    | PG-UP-PERM-02 | 删除互斥规则 | UP-PERM-07 删除角色互斥配置 |
    | PG-UR-PERM-01 | 加载角色列表 | UR-PERM-02 查询角色列表     |
    | PG-UR-PERM-01 | 搜索角色     | UR-PERM-02 查询角色列表     |
    | PG-UR-PERM-01 | 分配用户角色 | UR-PERM-08 为用户分配角色   |
    | PG-UR-PERM-01 | 删除角色     | UR-PERM-06 删除自定义角色   |
    | PG-UR-PERM-02 | 加载权限树   | UR-PERM-01 查询权限树       |
    | PG-UR-PERM-02 | 加载角色信息 | UR-PERM-03 查询角色详情     |
    | PG-UR-PERM-02 | 创建角色     | UR-PERM-04 创建自定义角色   |
    | PG-UR-PERM-02 | 编辑角色     | UR-PERM-05 更新角色信息     |
    | PG-UR-PERM-02 | 配置权限     | UR-PERM-07 配置角色权限     |
    | PG-UR-PERM-03 | 加载角色详情 | UR-PERM-03 查询角色详情     |
    | PG-UR-PERM-03 | 加载权限树   | UR-PERM-01 查询权限树       |
    | PG-UR-PERM-03 | 分配用户     | UR-PERM-08 为用户分配角色   |
    | PG-UR-PERM-03 | 移除用户     | UR-PERM-09 移除用户角色     |
    | PG-UR-PERM-04 | 加载授权列表 | UR-PERM-14 查询授权列表     |
    | PG-UR-PERM-04 | 搜索授权     | UR-PERM-14 查询授权列表     |
    | PG-UR-PERM-04 | 撤销授权     | UR-PERM-15 撤销数据授权     |
    | PG-UR-PERM-04 | 审批授权     | UR-PERM-16 审批数据授权     |
    | PG-UR-PERM-05 | 提交申请     | UR-PERM-13 申请数据授权     |

    表 6.8.6-1 页面与接口映射

### 6.8.7 功能操作汇总

+   授权管理全子领域功能操作汇总如下表所示。

    | 功能编号          | 所属页面      | 功能类型 | 功能名称         | 关联API    | 权限标识                    |
    | ----------------- | ------------- | -------- | ---------------- | ---------- | --------------------------- |
    | PG-P-PERM-01-F01  | PG-P-PERM-01  | 展示     | 加载角色列表     | P-PERM-02  | provider:iam:role:list      |
    | PG-P-PERM-01-F02  | PG-P-PERM-01  | 操作     | 搜索             | P-PERM-02  | provider:iam:role:list      |
    | PG-P-PERM-01-F03  | PG-P-PERM-01  | 操作     | 重置             | -          | -                           |
    | PG-P-PERM-01-F04  | PG-P-PERM-01  | 操作     | 新建角色         | -          | provider:iam:role:create    |
    | PG-P-PERM-01-F05  | PG-P-PERM-01  | 操作     | 查看             | P-PERM-03  | provider:iam:role:detail    |
    | PG-P-PERM-01-F06  | PG-P-PERM-01  | 操作     | 编辑             | -          | provider:iam:role:update    |
    | PG-P-PERM-01-F07  | PG-P-PERM-01  | 操作     | 删除             | P-PERM-06  | provider:iam:role:delete    |
    | PG-P-PERM-02-F08  | PG-P-PERM-02  | 展示     | 加载角色详情     | P-PERM-03  | provider:iam:role:detail    |
    | PG-P-PERM-02-F09  | PG-P-PERM-02  | 展示     | 加载权限树       | P-PERM-01  | provider:iam:role:detail    |
    | PG-P-PERM-02-F10  | PG-P-PERM-02  | 展示     | 加载已分配用户   | P-PERM-02  | provider:iam:role:detail    |
    | PG-P-PERM-02-F11  | PG-P-PERM-02  | 操作     | 返回             | -          | -                           |
    | PG-P-PERM-03-F12  | PG-P-PERM-03  | 展示     | 加载权限树       | P-PERM-01  | provider:iam:role:create    |
    | PG-P-PERM-03-F13  | PG-P-PERM-03  | 展示     | 加载角色信息     | P-PERM-03  | provider:iam:role:update    |
    | PG-P-PERM-03-F14  | PG-P-PERM-03  | 操作     | 取消             | -          | -                           |
    | PG-P-PERM-03-F15  | PG-P-PERM-03  | 操作     | 提交（新建）     | P-PERM-04  | provider:iam:role:create    |
    | PG-P-PERM-03-F16  | PG-P-PERM-03  | 操作     | 提交（编辑）     | P-PERM-05  | provider:iam:role:update    |
    | PG-P-PERM-03-F17  | PG-P-PERM-03  | 操作     | 配置权限         | P-PERM-07  | provider:iam:role:update    |
    | PG-UP-PERM-01-F18 | PG-UP-PERM-01 | 展示     | 加载权限列表     | UP-PERM-01 | up:iam:permission:list      |
    | PG-UP-PERM-01-F19 | PG-UP-PERM-01 | 操作     | 搜索             | UP-PERM-01 | up:iam:permission:list      |
    | PG-UP-PERM-01-F20 | PG-UP-PERM-01 | 操作     | 重置             | -          | -                           |
    | PG-UP-PERM-01-F21 | PG-UP-PERM-01 | 展示     | 树形展示         | P-PERM-01  | up:iam:permission:list      |
    | PG-UP-PERM-01-F22 | PG-UP-PERM-01 | 操作     | 新建权限         | UP-PERM-02 | up:iam:permission:create    |
    | PG-UP-PERM-01-F23 | PG-UP-PERM-01 | 操作     | 编辑             | UP-PERM-03 | up:iam:permission:update    |
    | PG-UP-PERM-01-F24 | PG-UP-PERM-01 | 操作     | 禁用             | UP-PERM-04 | up:iam:permission:delete    |
    | PG-UP-PERM-02-F25 | PG-UP-PERM-02 | 展示     | 加载互斥规则列表 | UP-PERM-05 | up:iam:role-conflict:list   |
    | PG-UP-PERM-02-F26 | PG-UP-PERM-02 | 操作     | 新建互斥规则     | UP-PERM-06 | up:iam:role-conflict:create |
    | PG-UP-PERM-02-F27 | PG-UP-PERM-02 | 操作     | 删除             | UP-PERM-07 | up:iam:role-conflict:delete |
    | PG-UR-PERM-01-F28 | PG-UR-PERM-01 | 展示     | 加载角色列表     | UR-PERM-02 | ur:iam:role:list            |
    | PG-UR-PERM-01-F29 | PG-UR-PERM-01 | 操作     | 搜索             | UR-PERM-02 | ur:iam:role:list            |
    | PG-UR-PERM-01-F30 | PG-UR-PERM-01 | 操作     | 重置             | -          | -                           |
    | PG-UR-PERM-01-F31 | PG-UR-PERM-01 | 操作     | 新建角色         | -          | ur:iam:role:create          |
    | PG-UR-PERM-01-F32 | PG-UR-PERM-01 | 操作     | 查看             | UR-PERM-03 | ur:iam:role:detail          |
    | PG-UR-PERM-01-F33 | PG-UR-PERM-01 | 操作     | 分配             | UR-PERM-08 | ur:iam:role:assign          |
    | PG-UR-PERM-01-F34 | PG-UR-PERM-01 | 操作     | 编辑             | -          | ur:iam:role:update          |
    | PG-UR-PERM-01-F35 | PG-UR-PERM-01 | 操作     | 删除             | UR-PERM-06 | ur:iam:role:delete          |
    | PG-UR-PERM-02-F36 | PG-UR-PERM-02 | 展示     | 加载权限树       | UR-PERM-01 | ur:iam:role:create          |
    | PG-UR-PERM-02-F37 | PG-UR-PERM-02 | 展示     | 加载角色信息     | UR-PERM-03 | ur:iam:role:update          |
    | PG-UR-PERM-02-F38 | PG-UR-PERM-02 | 操作     | 取消             | -          | -                           |
    | PG-UR-PERM-02-F39 | PG-UR-PERM-02 | 操作     | 提交（新建）     | UR-PERM-04 | ur:iam:role:create          |
    | PG-UR-PERM-02-F40 | PG-UR-PERM-02 | 操作     | 提交（编辑）     | UR-PERM-05 | ur:iam:role:update          |
    | PG-UR-PERM-02-F41 | PG-UR-PERM-02 | 操作     | 配置权限         | UR-PERM-07 | ur:iam:role:update          |
    | PG-UR-PERM-03-F42 | PG-UR-PERM-03 | 展示     | 加载角色详情     | UR-PERM-03 | ur:iam:role:detail          |
    | PG-UR-PERM-03-F43 | PG-UR-PERM-03 | 展示     | 加载权限树       | UR-PERM-01 | ur:iam:role:detail          |
    | PG-UR-PERM-03-F44 | PG-UR-PERM-03 | 展示     | 加载已分配用户   | UR-PERM-03 | ur:iam:role:detail          |
    | PG-UR-PERM-03-F45 | PG-UR-PERM-03 | 操作     | 分配用户         | UR-PERM-08 | ur:iam:role:assign          |
    | PG-UR-PERM-03-F46 | PG-UR-PERM-03 | 操作     | 移除用户         | UR-PERM-09 | ur:iam:role:assign          |
    | PG-UR-PERM-03-F47 | PG-UR-PERM-03 | 操作     | 返回             | -          | -                           |
    | PG-UR-PERM-04-F48 | PG-UR-PERM-04 | 展示     | 加载授权列表     | UR-PERM-14 | ur:iam:data-access:list     |
    | PG-UR-PERM-04-F49 | PG-UR-PERM-04 | 操作     | 搜索             | UR-PERM-14 | ur:iam:data-access:list     |
    | PG-UR-PERM-04-F50 | PG-UR-PERM-04 | 操作     | 重置             | -          | -                           |
    | PG-UR-PERM-04-F51 | PG-UR-PERM-04 | 操作     | 申请数据授权     | -          | ur:iam:data-access:apply    |
    | PG-UR-PERM-04-F52 | PG-UR-PERM-04 | 操作     | 撤销             | UR-PERM-15 | ur:iam:data-access:revoke   |
    | PG-UR-PERM-04-F53 | PG-UR-PERM-04 | 操作     | 审批             | UR-PERM-16 | ur:iam:data-access:approve  |
    | PG-UR-PERM-05-F54 | PG-UR-PERM-05 | 操作     | 取消             | -          | -                           |
    | PG-UR-PERM-05-F55 | PG-UR-PERM-05 | 操作     | 提交             | UR-PERM-13 | ur:iam:data-access:apply    |

    表 6.8.7-1 功能操作汇总

## 6.9 安全设计

+   本节设计权限管理相关的安全机制，确保系统安全可靠。

### 6.9.1 安全威胁与对策

+   权限管理面临的主要安全威胁及对策：

    | 威胁类型  | 威胁描述                     | 对策                          |
    | --------- | ---------------------------- | ----------------------------- |
    | 越权访问  | 用户访问无权限的功能或数据   | 后端强制校验，数据权限SQL注入 |
    | Token窃取 | Token被截获后冒充用户        | HTTPS传输、短有效期、刷新机制 |
    | Token篡改 | 修改Token中的用户信息        | JWT签名验证、密钥安全存储     |
    | 权限绕过  | 通过接口直接访问绕过前端控制 | 后端独立校验，不信任前端      |
    | SQL注入   | 通过权限参数注入恶意SQL      | 字段白名单校验、参数化查询    |
    | 权限提升  | 普通用户获取管理员权限       | 角色互斥检查、权限变更审计    |
    | 数据泄露  | 敏感数据未脱敏暴露           | 字段级脱敏、传输加密          |

    表 6.9.1-1 安全威胁与对策

### 6.9.2 Token安全设计

#### 6.9.2.1 Token生命周期

+   Token生命周期管理：

    | 阶段 | 机制                                    |
    | ---- | --------------------------------------- |
    | 签发 | 登录成功后签发，包含用户身份标识        |
    | 传输 | 仅通过HTTPS传输，Authorization头携带    |
    | 验证 | 每次请求验证签名和有效期                |
    | 刷新 | Access Token过期前使用Refresh Token刷新 |
    | 失效 | 登出时加入黑名单，强制失效              |

    表 6.9.2.1-1 Token生命周期

#### 6.9.2.2 Token黑名单机制

+   强制Token失效的场景：

    | 场景         | 触发条件             | 失效范围                |
    | ------------ | -------------------- | ----------------------- |
    | 用户主动登出 | 用户点击退出         | 当前Token               |
    | 密码修改     | 用户修改密码         | 该用户所有Token         |
    | 账号禁用     | 管理员禁用账号       | 该用户所有Token         |
    | 角色变更     | 用户角色被移除或修改 | 该用户所有Token（可选） |
    | 安全事件     | 检测到异常登录       | 该用户所有Token         |

    表 6.9.2.2-1 Token黑名单触发场景

### 6.9.3 数据权限安全设计

#### 6.9.3.1 零信任原则

+   数据权限校验遵循零信任原则：

    | 原则       | 说明                                       |
    | ---------- | ------------------------------------------ |
    | 默认拒绝   | 未明确授权的数据默认不可访问               |
    | 每次校验   | 每次数据访问都执行权限校验，不信任缓存状态 |
    | 无超级后门 | 即使是超级管理员也受数据权限约束           |
    | 最小授权   | 仅授予完成工作所需的最小数据范围           |

    表 6.9.3.1-1 零信任原则

#### 6.9.3.2 SQL注入防护

+   数据权限SQL注入的防护机制：

    | 防护层级   | 机制                           |
    | ---------- | ------------------------------ |
    | 字段白名单 | 只允许预定义的表别名和字段名   |
    | 参数化查询 | 使用?占位符，不拼接用户输入    |
    | 输入校验   | 校验注解参数格式，拒绝特殊字符 |

    表 6.9.3.2-1 SQL注入防护机制

### 6.9.4 审计日志设计

#### 6.9.4.1 权限操作审计

+   需要记录审计日志的权限操作：

    | 操作类型      | 记录内容                             |
    | ------------- | ------------------------------------ |
    | 角色创建/修改 | 操作人、角色信息、变更前后权限       |
    | 角色删除      | 操作人、角色信息、关联用户数         |
    | 用户角色分配  | 操作人、目标用户、分配的角色         |
    | 用户角色移除  | 操作人、目标用户、移除的角色         |
    | 数据授权      | 授权人、被授权人、授权范围、审批流程 |
    | 数据授权撤销  | 操作人、被撤销用户、撤销原因         |
    | 权限校验失败  | 用户、请求路径、缺少的权限           |

    表 6.9.4.1-1 权限操作审计内容

#### 6.9.4.2 审计日志结构

+   审计日志记录结构：

    | 字段          | 类型     | 说明                           |
    | ------------- | -------- | ------------------------------ |
    | id            | Long     | 日志ID                         |
    | operationType | String   | 操作类型                       |
    | operatorId    | Long     | 操作人ID                       |
    | operatorName  | String   | 操作人姓名                     |
    | targetType    | String   | 目标类型：USER/ROLE/PERMISSION |
    | targetId      | Long     | 目标ID                         |
    | beforeValue   | JSON     | 变更前值                       |
    | afterValue    | JSON     | 变更后值                       |
    | clientIp      | String   | 客户端IP地址                   |
    | userAgent     | String   | 客户端信息                     |
    | createdAt     | DateTime | 操作时间                       |

    表 6.9.4.2-1 审计日志结构

### 6.9.5 敏感操作保护

+   敏感权限操作的额外保护措施：

    | 敏感操作         | 保护措施                             |
    | ---------------- | ------------------------------------ |
    | 删除角色         | 二次确认、检查关联用户、审计日志     |
    | 批量分配角色     | 限制单次操作数量、异步执行、进度反馈 |
    | 修改预置角色权限 | 禁止修改，返回403                    |
    | 授权全部数据范围 | 需CISO或更高级别角色操作             |
    | 跨部门数据授权   | 审批流程、有效期限制                 |

    表 6.9.5-1 敏感操作保护措施

## 6.10 后端工程结构设计

+   本节设计权限管理子领域的后端工程结构。
+   权限管理作为BC-10 IAM服务的一部分，遵循统一的分层架构。

### 6.10.1 模块划分

+   权限管理后端代码分布在bc-10-iam服务的各层模块中：

    | 模块                     | 职责       | 权限相关内容                 |
    | ------------------------ | ---------- | ---------------------------- |
    | bc-10-iam-api            | API契约层  | 权限DTO、Feign客户端         |
    | bc-10-iam-domain         | 领域层     | 权限聚合、领域服务、领域事件 |
    | bc-10-iam-application    | 应用层     | 权限用例、命令/查询处理器    |
    | bc-10-iam-infrastructure | 基础设施层 | 权限仓储实现、缓存、MyBatis  |
    | bc-10-iam-starter        | 启动模块   | 权限Controller、AOP切面      |

    表 6.10.1-1 权限管理模块划分

### 6.10.2 各模块包结构

#### 6.10.2.1 bc-10-iam-api 模块（权限部分）

+   API层权限相关包结构：

    ```
    bc-10-iam-api/
    └── src/main/java/com/clarisphere/iam/api/
        ├── dto/
        │   ├── permission/                  # 权限相关DTO
        │   │   ├── request/
        │   │   │   ├── RoleCreateRequest.java
        │   │   │   ├── RoleUpdateRequest.java
        │   │   │   ├── RolePermissionConfigRequest.java
        │   │   │   ├── UserRoleAssignRequest.java
        │   │   │   └── DataAccessApplyRequest.java
        │   │   └── response/
        │   │       ├── PermissionTreeResponse.java
        │   │       ├── RoleResponse.java
        │   │       ├── RoleDetailResponse.java
        │   │       ├── UserPermissionResponse.java
        │   │       └── MenuTreeResponse.java
        │   └── common/
        │       └── DataScopeEnum.java       # 数据权限范围枚举
        ├── feign/
        │   └── PermissionClient.java        # 权限服务Feign客户端
        └── constant/
            └── Perms.java                   # 权限标识常量类
    ```

    图 6.10.2.1-1 API层权限包结构

#### 6.10.2.2 bc-10-iam-domain 模块（权限部分）

+   领域层权限相关包结构：

    ```
    bc-10-iam-domain/
    └── src/main/java/com/clarisphere/iam/domain/
        └── permission/                      # 权限子领域
            ├── model/
            │   ├── aggregate/               # 聚合根
            │   │   ├── Permission.java      # 权限定义聚合根
            │   │   ├── PlatformRole.java    # 平台角色聚合根
            │   │   ├── PlatformCustomRole.java # 平台自定义角色聚合根
            │   │   ├── TenantRole.java      # 租户角色聚合根
            │   │   ├── UserRole.java        # 用户角色聚合根
            │   │   └── UserDataAccess.java  # 数据授权聚合根
            │   └── valueobject/             # 值对象
            │       ├── PermissionCode.java  # 四段式权限标识
            │       ├── PermissionType.java  # 权限类型枚举
            │       ├── DataScope.java       # 数据权限范围
            │       ├── RoleType.java        # 角色类型枚举
            │       ├── AccessTarget.java    # 授权目标
            │       └── ApprovalStatus.java  # 审批状态枚举
            ├── repository/                  # 仓储接口
            │   ├── PermissionRepository.java
            │   ├── PlatformRoleRepository.java
            │   ├── PlatformCustomRoleRepository.java
            │   ├── TenantRoleRepository.java
            │   ├── UserRoleRepository.java
            │   └── UserDataAccessRepository.java
            ├── service/                     # 领域服务
            │   ├── PermissionService.java   # 权限计算服务
            │   ├── RoleService.java         # 角色管理服务
            │   ├── UserRoleService.java     # 用户角色管理服务
            │   ├── DataScopeService.java    # 数据权限服务
            │   ├── DataAccessService.java   # 数据授权管理服务
            │   └── PermissionCacheService.java  # 权限缓存服务
            ├── event/                       # 领域事件
            │   ├── RoleCreatedEvent.java
            │   ├── RoleUpdatedEvent.java
            │   ├── RolePermissionChangedEvent.java
            │   ├── RoleDisabledEvent.java
            │   ├── RoleEnabledEvent.java
            │   ├── RoleDeletedEvent.java
            │   ├── UserRoleAssignedEvent.java
            │   ├── UserRoleRevokedEvent.java
            │   ├── DataAccessCreatedEvent.java
            │   ├── DataAccessGrantedEvent.java
            │   ├── DataAccessRejectedEvent.java
            │   ├── DataAccessRevokedEvent.java
            │   ├── DataAccessExtendedEvent.java
            │   ├── PermissionCreatedEvent.java
            │   ├── PermissionUpdatedEvent.java
            │   ├── PermissionDisabledEvent.java
            │   ├── PermissionEnabledEvent.java
            │   └── PermissionDeletedEvent.java
            ├── specification/               # 规约
            │   ├── RoleConflictSpec.java    # 角色互斥规约
            │   └── PermissionCodeSpec.java  # 权限标识规约
            └── exception/                   # 领域异常
                ├── RoleConflictException.java
                ├── PermissionDeniedException.java
                └── DataAccessExpiredException.java
    ```

    图 6.10.2.2-1 领域层权限包结构

#### 6.10.2.3 bc-10-iam-application 模块（权限部分）

+   应用层权限相关包结构：

    ```
    bc-10-iam-application/
    └── src/main/java/com/clarisphere/iam/application/
        └── permission/                      # 权限应用服务
            ├── command/                     # 命令对象
            │   ├── CreateRoleCommand.java
            │   ├── UpdateRoleCommand.java
            │   ├── ConfigureRolePermissionCommand.java
            │   ├── AssignUserRoleCommand.java
            │   ├── RevokeUserRoleCommand.java
            │   ├── ApplyDataAccessCommand.java
            │   └── ApproveDataAccessCommand.java
            ├── query/                       # 查询对象
            │   ├── PermissionTreeQuery.java
            │   ├── RoleListQuery.java
            │   ├── UserPermissionQuery.java
            │   └── UserMenuQuery.java
            ├── handler/
            │   ├── command/                 # 命令处理器
            │   │   ├── CreateRoleHandler.java
            │   │   ├── ConfigureRolePermissionHandler.java
            │   │   ├── AssignUserRoleHandler.java
            │   │   └── ApplyDataAccessHandler.java
            │   └── query/                   # 查询处理器
            │       ├── PermissionTreeQueryHandler.java
            │       ├── RoleListQueryHandler.java
            │       ├── UserPermissionQueryHandler.java
            │       └── UserMenuQueryHandler.java
            ├── service/                     # 应用服务
            │   ├── PermissionAppService.java
            │   ├── RoleAppService.java
            │   ├── UserRoleAppService.java
            │   └── DataAccessAppService.java
            ├── assembler/                   # 组装器
            │   ├── PermissionAssembler.java
            │   ├── RoleAssembler.java
            │   └── MenuAssembler.java
            └── eventhandler/                # 事件处理器
                ├── RolePermissionChangedEventHandler.java
                ├── UserRoleChangedEventHandler.java
                └── PermissionCacheEventHandler.java
    ```

    图 6.10.2.3-1 应用层权限包结构

#### 6.10.2.4 bc-10-iam-infrastructure 模块（权限部分）

+   基础设施层权限相关包结构：

    ```
    bc-10-iam-infrastructure/
    └── src/main/java/com/clarisphere/iam/infrastructure/
        └── permission/                      # 权限基础设施
            ├── persistence/
            │   ├── repository/              # 仓储实现
            │   │   ├── PermissionRepositoryImpl.java
            │   │   ├── PlatformRoleRepositoryImpl.java
            │   │   ├── PlatformCustomRoleMapper.java
            │   │   ├── PlatformCustomRolePermissionMapper.java
            │   │   ├── TenantRoleRepositoryImpl.java
            │   │   ├── UserRoleRepositoryImpl.java
            │   │   └── UserDataAccessRepositoryImpl.java
            │   ├── mapper/                  # MyBatis Mapper
            │   │   ├── PlatformPermissionMapper.java
            │   │   ├── PlatformRoleMapper.java
            │   │   ├── PlatformRolePermissionMapper.java
            │   │   ├── PlatformRoleConflictMapper.java
            │   │   ├── TenantRoleMapper.java
            │   │   ├── TenantRolePermissionMapper.java
            │   │   ├── TenantUserRoleMapper.java
            │   │   ├── TenantUserDataAccessMapper.java
            │   │   └── TenantDeptMapper.java
            │   ├── po/                      # 持久化对象
            │   │   ├── PlatformPermissionPO.java
            │   │   ├── PlatformRolePO.java
            │   │   ├── PlatformCustomRolePO.java
            │   │   ├── PlatformCustomRolePermissionPO.java
            │   │   ├── PlatformRolePermissionPO.java
            │   │   ├── PlatformRoleConflictPO.java
            │   │   ├── TenantRolePO.java
            │   │   ├── TenantRolePermissionPO.java
            │   │   ├── TenantUserRolePO.java
            │   │   ├── TenantUserDataAccessPO.java
            │   │   └── TenantDeptPO.java
            │   └── converter/               # PO-DO转换器
            │       ├── PermissionConverter.java
            │       ├── RoleConverter.java
            │       └── DataAccessConverter.java
            ├── cache/                       # 缓存实现
            │   ├── PermissionCacheManager.java
            │   └── DataScopeCacheManager.java
            ├── security/                    # 安全相关
            │   ├── DataScopeAspect.java     # 数据权限切面
            │   ├── DataScopeInterceptor.java# MyBatis拦截器
            │   ├── DataScopeContextHolder.java
            │   └── DataScopeFieldValidator.java
            └── annotation/                  # 自定义注解
                └── DataScope.java
    ```

    图 6.10.2.4-1 基础设施层权限包结构

#### 6.10.2.5 bc-10-iam-starter 模块（权限部分）

+   启动模块权限相关包结构：

    ```
    bc-10-iam-starter/
    └── src/
        ├── main/java/com/clarisphere/iam/interfaces/
        │   └── web/
        │       ├── provider/                # 运营用户群权限API
        │       │   └── ProviderPermissionController.java
        │       ├── tenant/                  # 租户用户群权限API
        │       │   ├── TenantPermissionController.java
        │       │   ├── TenantRoleController.java
        │       │   └── TenantDataAccessController.java
        │       ├── consumer/                # C端用户群权限API
        │       │   └── ConsumerPermissionController.java
        │       └── platform/                # 平台管理权限API
        │           └── PlatformPermissionController.java
        └── main/resources/
            └── mapper/
                ├── PlatformPermissionMapper.xml
                ├── PlatformRoleMapper.xml
                ├── PlatformRolePermissionMapper.xml
                ├── PlatformRoleConflictMapper.xml
                ├── TenantRoleMapper.xml
                ├── TenantRolePermissionMapper.xml
                ├── TenantUserRoleMapper.xml
                ├── TenantUserDataAccessMapper.xml
                └── TenantDeptMapper.xml
    ```

    图 6.10.2.5-1 启动模块权限包结构

### 6.10.3 关键类职责说明

+   权限管理关键类职责：

    | 类名                       | 所属层    | 职责                           |
    | -------------------------- | --------- | ------------------------------ |
    | Permission                 | Domain    | 权限定义聚合根，管理权限树结构 |
    | PlatformRole               | Domain    | 平台角色聚合根，系统预置角色   |
    | TenantRole                 | Domain    | 租户角色聚合根，租户自定义角色 |
    | UserDataAccess             | Domain    | 数据授权聚合根，跨部门授权     |
    | PermissionService          | Domain    | 权限计算领域服务               |
    | DataScopeService           | Domain    | 数据权限计算领域服务           |
    | PermissionAppService       | App       | 权限查询应用服务               |
    | RoleAppService             | App       | 角色管理应用服务               |
    | DataScopeAspect            | Infra     | 数据权限AOP切面                |
    | DataScopeInterceptor       | Infra     | MyBatis数据权限拦截器          |
    | PermissionCacheManager     | Infra     | 权限缓存管理                   |
    | TenantPermissionController | Interface | 租户用户群权限API控制器        |

    表 6.10.3-1 权限管理关键类职责

### 6.10.4 命名规范

+   权限管理特有的命名规范补充：

    | 类型         | 命名规范                                     | 示例                                |
    | ------------ | -------------------------------------------- | ----------------------------------- |
    | 权限常量     | {USER_SIDE}\_{CONTEXT}\_{RESOURCE}\_{ACTION} | PROVIDER_ACQUISITION_MANDATE_CREATE |
    | 数据权限注解 | @DataScope                                   | @DataScope(deptAlias="p")           |
    | 缓存Key      | {type}:{scope}:{id}                          | permission:user:ur:100:10001        |
    | 领域事件     | {Resource}{Action}Event                      | RolePermissionChangedEvent          |

    表 6.10.4-1 权限管理命名规范

## 6.11 前端工程结构设计

+   本节设计权限管理子领域的前端工程结构。
+   权限管理前端代码按功能模块组织，与用户管理共用iam目录。

### 6.11.1 目录结构设计

#### 6.11.1.1 API模块结构

+   权限相关API模块结构：

    ```
    src/api/
    └── iam/
        ├── permission.ts                # 权限相关API
        ├── role.ts                      # 角色管理API
        ├── data-access.ts               # 数据授权API
        └── types/
            ├── permission.ts            # 权限类型定义
            ├── role.ts                  # 角色类型定义
            └── data-access.ts           # 数据授权类型定义
    ```

    图 6.11.1.1-1 权限API模块结构

#### 6.11.1.2 页面组件结构

+   权限管理页面组件结构：

    ```
    src/views/
    └── iam/
        ├── provider/                    # 运营用户群
        │   └── permission/              # 权限管理
        │       ├── role/                # 角色管理
        │       │   ├── index.vue        # PG-P-PERM-01 角色列表页
        │       │   └── detail.vue       # PG-P-PERM-02 角色详情页
        │       └── components/
        │           ├── RoleEditDialog.vue
        │           └── PermissionTreeSelect.vue
        ├── tenant/                      # 租户用户群
        │   └── permission/              # 权限管理
        │       ├── role/                # 角色管理
        │       │   ├── index.vue        # PG-UR-PERM-01 角色列表页
        │       │   ├── create.vue       # PG-UR-PERM-02 角色创建页
        │       │   └── detail.vue       # PG-UR-PERM-03 角色详情页
        │       ├── data-access/         # 数据授权
        │       │   ├── index.vue        # PG-UR-PERM-04 数据授权列表页
        │       │   └── apply.vue        # PG-UR-PERM-05 数据授权申请页
        │       └── components/
        │           ├── RoleEditDialog.vue
        │           ├── PermissionTreeSelect.vue
        │           ├── DataScopeSelect.vue
        │           └── DeptTreeSelect.vue
        └── platform/                    # 平台管理
            └── permission/              # 权限配置
                ├── index.vue            # PG-UP-PERM-01 权限定义列表页
                ├── role-conflict/       # 角色互斥
                │   └── index.vue        # PG-UP-PERM-02 角色互斥配置页
                └── components/
                    └── PermissionEditDialog.vue
    ```

    图 6.11.1.2-1 权限页面组件结构

#### 6.11.1.3 公共组件结构

+   权限相关公共组件：

    ```
    src/components/
    └── permission/                      # 权限公共组件
        ├── PermissionTree.vue           # 权限树展示组件
        ├── PermissionTreeSelect.vue     # 权限树选择器
        ├── RoleSelect.vue               # 角色选择器
        ├── RoleTag.vue                  # 角色标签
        ├── DataScopeTag.vue             # 数据权限范围标签
        └── DeptTreeSelect.vue           # 部门树选择器
    ```

    图 6.11.1.3-1 权限公共组件结构

#### 6.11.1.4 权限控制模块结构

+   权限控制核心模块结构：

    ```
    src/permission/
    ├── index.ts                         # 权限模块入口
    ├── directive.ts                     # v-has-perm指令实现
    ├── check.ts                         # 权限检查函数
    └── constants/
        ├── index.ts                     # 常量导出
        ├── provider.ts                  # 运营用户群权限常量
        ├── tenant.ts                    # 租户用户群权限常量
        └── consumer.ts                  # C端用户群权限常量
    ```

    图 6.11.1.4-1 权限控制模块结构

#### 6.11.1.5 状态管理结构

+   权限相关Pinia Store：

    ```
    src/stores/
    ├── permission.ts                    # 权限状态（菜单、路由）
    └── modules/
        └── iam/
            ├── role.ts                  # 角色管理状态
            └── dataAccess.ts            # 数据授权状态
    ```

    图 6.11.1.5-1 权限状态管理结构

### 6.11.2 类型定义

+   权限相关TypeScript类型定义：

    ```
    src/types/
    └── iam/
        ├── permission.ts                # 权限类型
        │   ├── IPermission              # 权限定义
        │   ├── IPermissionTree          # 权限树
        │   └── IMenuItem                # 菜单项
        ├── role.ts                      # 角色类型
        │   ├── IRole                    # 角色
        │   ├── IRoleDetail              # 角色详情
        │   ├── ICreateRoleRequest       # 创建角色请求
        │   └── IRoleType                # 角色类型枚举
        └── data-access.ts               # 数据授权类型
            ├── IDataAccess              # 数据授权
            ├── IApplyDataAccessRequest  # 申请授权请求
            └── IApprovalStatus          # 审批状态枚举
    ```

    图 6.11.2-1 权限类型定义结构

### 6.11.3 路由配置

+   权限管理路由配置：

    ```
    src/router/modules/
    ├── provider.ts                      # 运营用户群路由
    │   └── /provider/permission/role    # 角色管理
    ├── tenant.ts                        # 租户用户群路由
    │   ├── /tenant/permission/role      # 角色管理
    │   └── /tenant/permission/data-access # 数据授权
    └── platform.ts                      # 平台管理路由
        ├── /platform/permission         # 权限定义
        └── /platform/role-conflict      # 角色互斥
    ```

    图 6.11.3-1 权限路由配置

### 6.11.4 页面与组件映射

+   权限管理页面编号与Vue组件映射：

    | 页面编号      | 页面名称       | 组件文件路径                                              |
    | ------------- | -------------- | --------------------------------------------------------- |
    | PG-P-PERM-01  | 角色列表页     | src/views/iam/provider/permission/role/index.vue          |
    | PG-P-PERM-02  | 角色详情页     | src/views/iam/provider/permission/role/detail.vue         |
    | PG-UR-PERM-01 | 角色列表页     | src/views/iam/tenant/permission/role/index.vue            |
    | PG-UR-PERM-02 | 角色创建页     | src/views/iam/tenant/permission/role/create.vue           |
    | PG-UR-PERM-03 | 角色详情页     | src/views/iam/tenant/permission/role/detail.vue           |
    | PG-UR-PERM-04 | 数据授权列表页 | src/views/iam/tenant/permission/data-access/index.vue     |
    | PG-UR-PERM-05 | 数据授权申请页 | src/views/iam/tenant/permission/data-access/apply.vue     |
    | PG-UP-PERM-01 | 权限定义列表页 | src/views/iam/platform/permission/index.vue               |
    | PG-UP-PERM-02 | 角色互斥配置页 | src/views/iam/platform/permission/role-conflict/index.vue |

    表 6.11.4-1 页面与组件映射

### 6.11.5 命名规范

+   权限管理前端命名规范：

    | 类型         | 命名规范              | 示例                            |
    | ------------ | --------------------- | ------------------------------- |
    | 权限API函数  | {action}Permission    | getPermissionTree、listRoles    |
    | 权限常量     | PERM_{SCOPE}_{ACTION} | PERM_ROLE_CREATE                |
    | 权限组件     | {Feature}组件类型     | PermissionTreeSelect            |
    | 权限检查函数 | has{Scope}            | hasPermission、hasAnyPermission |
    | 权限指令     | v-has-{type}          | v-has-perm、v-has-any           |

    表 6.11.5-1 权限前端命名规范

# 7 审计管理

+   本章详细设计审计管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   审计管理负责"记录做了什么"，核心职责是记录BC-10内部的登录行为、关键操作和安全事件，为合规审计、安全追溯、问题排查提供数据支撑。
+   审计管理贯穿用户管理、认证管理、授权管理三个子领域，以旁路方式记录各类操作，不影响主业务流程。

## 7.0 审计与其他子领域的关系

+   审计管理与其他子领域（用户管理、认证管理、授权管理、组织管理、配置管理）的关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      审计管理与其他子领域关系图                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
    │    │  用户管理   │ │  认证管理   │ │  授权管理   │ │  组织管理   │          │
    │    │   (User)    │ │   (Auth)    │ │  (AuthZ)    │ │   (Org)     │          │
    │    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘          │
    │           │               │               │               │                 │
    │           │ 用户创建/     │ 登录/登出/    │ 角色分配/     │ 组织/岗位/      │
    │           │ 删除/禁用/    │ Token刷新/    │ 权限变更/     │ 人员/任职/      │
    │           │ 密码/注销/    │ MFA验证/      │ 数据授权      │ 同步            │
    │           │ 三方账号      │ 异常登录                      │                 │
    │           │               │               │               │                 │
    │           └───────────────┼───────────────┼───────────────┘                 │
    │                           │               │                                 │
    │                     ┌─────────────┐       │                                 │
    │                     │  配置管理   │───────┘                                 │
    │                     │  (Config)   │ 配置变更                                │
    │                     └──────┬──────┘                                         │
    │                            │                                                │
    │                            ▼                                                │
    │               ┌────────────────────────────┐                                │
    │               │       审计管理             │                                │
    │               │        (Audit)             │                                │
    │               ├────────────────────────────┤                                │
    │               │                            │                                │
    │               │  • 登录日志 (LoginLog)     │                                │
    │               │  • 操作日志 (OperationLog) │                                │
    │               │  • 安全事件 (SecurityEvent)│                                │
    │               │                            │                                │
    │               │  【旁路记录，不阻塞业务】  │                                │
    │               │                            │                                │
    │               └────────────────────────────┘                                │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.0-1 审计管理与其他子领域关系图

+   关系说明：
    -   审计管理**被动接收**其他子领域的操作事件，不主动干预业务流程
    -   认证管理在登录成功/失败/MFA验证时**同步调用**审计服务记录登录日志
    -   用户管理、授权管理、组织管理、配置管理的关键操作通过**AOP切面**自动记录操作日志
    -   密码修改、MFA变更、账号注销、异常登录、数据授权变更等安全相关操作触发**安全事件**记录

+   V1.0实现范围说明：
    -   V1.0聚焦于**日志记录能力**，提供基础的日志查询接口
    -   审计分析、异常检测、统计报表等高级功能规划在V2.0实现

## 7.1 审计业务场景

+   本节分析审计管理的业务场景，明确各类日志的记录范围和查询需求。

### 7.1.1 审计日志分类

+   BC-10审计管理涉及三类日志，如下表所示。

    | 日志类型 | 英文标识       | 记录内容                                                  | 主要用途           |
    | -------- | -------------- | --------------------------------------------------------- | ------------------ |
    | 登录日志 | LOGIN_LOG      | 登录成功、登录失败、登出、Token刷新、MFA验证、会话过期    | 安全审计、异常追溯 |
    | 操作日志 | OPERATION_LOG  | 用户/角色/组织/岗位/人员/任职/权限/配置的增删改等关键操作 | 操作追溯、问题排查 |
    | 安全事件 | SECURITY_EVENT | 密码修改、MFA变更、权限变更、异常登录、账号注销等         | 安全合规、风险预警 |

    表 7.1.1-1 审计日志分类

+   三类日志的关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                           审计日志分类关系图                                │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │                           ┌─────────────────────┐                           │
    │                           │    BC-10 审计日志   │                           │
    │                           └──────────┬──────────┘                           │
    │                                      │                                      │
    │              ┌───────────────────────┼───────────────────────┐              │
    │              │                       │                       │              │
    │              ▼                       ▼                       ▼              │
    │    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐      │
    │    │   登录日志      │     │   操作日志      │     │   安全事件      │      │
    │    │  (LOGIN_LOG)    │     │ (OPERATION_LOG) │     │(SECURITY_EVENT) │      │
    │    ├─────────────────┤     ├─────────────────┤     ├─────────────────┤      │
    │    │ • 登录成功      │     │ • 用户创建/激活 │     │ • 密码修改      │      │
    │    │ • 登录失败      │     │ • 用户删除/禁用 │     │ • 密码重置      │      │
    │    │ • 登出          │     │ • 角色创建/删除 │     │ • MFA启用/禁用  │      │
    │    │ • Token刷新     │     │ • 权限分配/撤销 │     │ • 账号锁定/解锁 │      │
    │    │ • MFA验证       │     │ • 数据授权变更  │     │ • 异常登录      │      │
    │    │ • 强制下线      │     │ • 组织/岗位变更 │     │ • 权限提升      │      │
    │    │ • 会话过期      │     │ • 人员/任职变更 │     │ • 账号注销      │      │
    │    │                 │     │ • 配置变更      │     │ • 强制下线      │      │
    │    │                 │     │ • 同步操作      │     │ • 数据授权变更  │      │
    │    └─────────────────┘     └─────────────────┘     └─────────────────┘      │
    │           │                        │                        │               │
    │           │                        │                        │               │
    │           └────────────────────────┼────────────────────────┘               │
    │                                    │                                        │
    │                                    ▼                                        │
    │                     ┌───────────────────────────┐                           │
    │                     │     分库存储              │                           │
    │                     │  platform / tenant / uc   │                           │
    │                     └───────────────────────────┘                           │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.1.1-1 审计日志分类关系图

### 7.1.2 登录日志场景

+   登录日志记录所有认证相关的行为，覆盖三侧用户。

#### 7.1.2.1 登录日志记录场景

+   登录日志的记录场景如下表所示。

    | 场景编码 | 场景名称    | 触发时机              | 记录结果     | 适用用户群 |
    | -------- | ----------- | --------------------- | ------------ | ---------- |
    | LOG-L-01 | 登录成功    | 认证通过，签发Token后 | SUCCESS      | UP/UR/UC   |
    | LOG-L-02 | 登录失败    | 认证失败时            | FAILED       | UP/UR/UC   |
    | LOG-L-03 | 主动登出    | 用户点击登出时        | LOGOUT       | UP/UR/UC   |
    | LOG-L-04 | Token刷新   | 刷新Token成功时       | REFRESH      | UP/UR/UC   |
    | LOG-L-05 | 强制下线    | 被管理员或系统踢出时  | KICKED       | UP/UR/UC   |
    | LOG-L-06 | 会话过期    | 会话超时自动失效时    | EXPIRED      | UP/UR/UC   |
    | LOG-L-07 | MFA验证成功 | 双因素认证验证通过时  | MFA_VERIFIED | UP/UR/UC   |

    表 7.1.2.1-1 登录日志记录场景

+   **事件驱动的登录日志补充说明**：
    -   LOG-L-01至LOG-L-05由认证管理流程**同步调用**AuditLogService记录
    -   LOG-L-06（会话过期）由审计管理监听SessionTerminated领域事件触发记录（见7.3.8.3节）
    -   LOG-L-07（MFA验证成功）由审计管理监听MfaVerified领域事件触发记录（见7.3.8.3节）

#### 7.1.2.2 登录失败原因分类

+   登录失败需要记录具体原因，便于问题排查和安全分析。

    | 失败原因编码     | 失败原因    | 说明                       |
    | ---------------- | ----------- | -------------------------- |
    | WRONG_PWD        | 密码错误    | 用户名存在但密码不匹配     |
    | USER_NOT_FOUND   | 用户不存在  | 找不到该用户名             |
    | ACCOUNT_DISABLED | 账号已禁用  | 账号被管理员禁用           |
    | ACCOUNT_LOCKED   | 账号已锁定  | 密码错误次数超限，临时锁定 |
    | CAPTCHA_ERROR    | 验证码错误  | 图形验证码校验失败         |
    | MFA_FAILED       | MFA验证失败 | 多因素认证未通过           |
    | IP_BLOCKED       | IP被封禁    | 来源IP在黑名单中           |
    | TENANT_EXPIRED   | 租户已过期  | 租户订阅已到期             |

    表 7.1.2.2-1 登录失败原因分类

#### 7.1.2.3 登录日志查询场景

+   登录日志查询场景如下表所示。

    | 场景编码 | 查询场景       | 查询者           | 查询范围           | 典型用例               |
    | -------- | -------------- | ---------------- | ------------------ | ---------------------- |
    | QRY-L-01 | 管理员查询全部 | 运营用户群管理员 | 本用户群全部日志   | 审计平台用户登录行为   |
    | QRY-L-02 | 管理员查询全部 | 租户管理员       | 本租户全部日志     | 审计租户内用户登录行为 |
    | QRY-L-03 | 用户查询自己   | 任意用户         | 仅自己的登录记录   | 用户查看自己的登录历史 |
    | QRY-L-04 | 查询失败记录   | 管理员           | 失败的登录记录     | 排查异常登录、暴力破解 |
    | QRY-L-05 | 按IP查询       | 管理员           | 指定IP的登录记录   | 追溯某IP的登录行为     |
    | QRY-L-06 | 按时间段查询   | 管理员           | 指定时间范围的日志 | 审计特定时段的登录情况 |

    表 7.1.2.3-1 登录日志查询场景

### 7.1.3 操作日志场景

+   操作日志记录BC-10内部的关键业务操作，用于操作追溯和问题排查。

#### 7.1.3.1 操作日志记录范围

+   V1.0记录以下关键操作，如下表所示。

    | 模块     | 操作类型       | 日志级别  | 说明                         |
    | -------- | -------------- | --------- | ---------------------------- |
    | 用户管理 | 创建用户       | IMPORTANT | 新增系统主体                 |
    | 用户管理 | 激活用户       | IMPORTANT | 用户完成激活                 |
    | 用户管理 | 激活租户管理员 | IMPORTANT | 租户管理员完成激活           |
    | 用户管理 | 删除用户       | CRITICAL  | 删除系统主体                 |
    | 用户管理 | 禁用用户       | IMPORTANT | 影响用户登录                 |
    | 用户管理 | 启用用户       | IMPORTANT | 恢复用户登录                 |
    | 用户管理 | 更新用户信息   | NORMAL    | 修改用户基本信息             |
    | 用户管理 | 重置密码       | IMPORTANT | 管理员协助重置               |
    | 用户管理 | 申请注销       | CRITICAL  | 用户发起账号注销申请         |
    | 用户管理 | 绑定三方账号   | NORMAL    | 绑定OAuth/社交账号           |
    | 用户管理 | 解绑三方账号   | NORMAL    | 解绑OAuth/社交账号           |
    | 角色管理 | 创建角色       | IMPORTANT | 新增权限载体                 |
    | 角色管理 | 删除角色       | CRITICAL  | 删除权限载体                 |
    | 角色管理 | 修改角色权限   | IMPORTANT | 影响角色关联用户             |
    | 权限分配 | 分配用户角色   | IMPORTANT | 用户权限变更                 |
    | 权限分配 | 移除用户角色   | IMPORTANT | 用户权限变更                 |
    | 权限分配 | 授予数据权限   | IMPORTANT | 数据授权范围变更             |
    | 权限分配 | 撤销数据权限   | IMPORTANT | 数据授权范围变更             |
    | 权限分配 | 变更权限定义   | IMPORTANT | 功能权限定义新增/修改/删除   |
    | 组织管理 | 创建组织       | IMPORTANT | 新增组织节点                 |
    | 组织管理 | 更新组织       | NORMAL    | 修改组织基本信息             |
    | 组织管理 | 删除组织       | CRITICAL  | 删除组织节点                 |
    | 组织管理 | 调整组织架构   | IMPORTANT | 组织上下级变更               |
    | 岗位管理 | 创建岗位       | IMPORTANT | 新增岗位定义                 |
    | 岗位管理 | 更新岗位       | NORMAL    | 修改岗位信息                 |
    | 岗位管理 | 停用岗位       | IMPORTANT | 岗位停用，影响在岗人员       |
    | 人员管理 | 创建人员       | IMPORTANT | 新增人员档案                 |
    | 人员管理 | 更新人员       | NORMAL    | 修改人员信息                 |
    | 人员管理 | 人员离职       | CRITICAL  | 影响关联用户账号和权限       |
    | 人员管理 | 关联用户       | IMPORTANT | 建立人员与用户账号的绑定关系 |
    | 人员管理 | 解除关联       | IMPORTANT | 解除人员与用户账号的绑定关系 |
    | 任职管理 | 创建任职       | IMPORTANT | 新增任职记录                 |
    | 任职管理 | 任职调岗       | IMPORTANT | 影响数据权限范围             |
    | 任职管理 | 终止任职       | IMPORTANT | 影响组织归属和数据权限       |
    | 同步管理 | 组织同步完成   | IMPORTANT | 批量同步完成，记录同步报告   |
    | 同步管理 | 组织同步失败   | CRITICAL  | 同步异常，需排查             |
    | 系统配置 | 修改密码策略   | CRITICAL  | 影响安全策略                 |
    | 系统配置 | 修改登录策略   | CRITICAL  | 影响登录行为                 |
    | 系统配置 | 修改系统配置   | IMPORTANT | 其他系统级配置变更           |
    | 租户配置 | 修改租户配置   | CRITICAL  | 租户级策略参数变更           |
    | 租户配置 | 重置租户配置   | CRITICAL  | 恢复为系统默认值             |

    表 7.1.3.1-1 操作日志记录范围

+   日志级别说明：

    | 级别      | 英文 | 说明                             |
    | --------- | ---- | -------------------------------- |
    | NORMAL    | 普通 | 一般性操作，如更新信息           |
    | IMPORTANT | 重要 | 影响业务的关键操作，如创建、禁用 |
    | CRITICAL  | 关键 | 高风险操作，如删除、安全配置变更 |

    表 7.1.3.1-2 日志级别说明

#### 7.1.3.2 操作日志记录内容

+   操作日志需要记录的关键信息如下表所示。

    | 信息分类 | 记录字段                           | 说明               |
    | -------- | ---------------------------------- | ------------------ |
    | 操作人   | user_id, username                  | 谁执行的操作       |
    | 操作内容 | module, operation, target_type     | 做了什么操作       |
    | 操作对象 | target_id, target_name             | 操作的目标是什么   |
    | 操作结果 | result, error_msg                  | 操作是否成功       |
    | 操作详情 | request_data                       | 请求参数（脱敏后） |
    | 上下文   | client_ip, user_agent, duration_ms | 操作的环境和耗时   |

    表 7.1.3.2-1 操作日志记录内容

#### 7.1.3.3 操作日志查询场景

+   操作日志查询场景如下表所示。

    | 场景编码 | 查询场景       | 查询条件                | 典型用例                    |
    | -------- | -------------- | ----------------------- | --------------------------- |
    | QRY-O-01 | 按操作人查询   | username                | 查看某用户的操作历史        |
    | QRY-O-02 | 按模块查询     | module                  | 查看用户管理模块的操作      |
    | QRY-O-03 | 按目标查询     | target_type + target_id | 查看某用户/角色被操作的历史 |
    | QRY-O-04 | 按日志级别查询 | log_level = CRITICAL    | 只看高危操作                |
    | QRY-O-05 | 按结果查询     | result = FAILED         | 只看失败的操作              |
    | QRY-O-06 | 按时间段查询   | start_time ~ end_time   | 审计特定时段的操作          |

    表 7.1.3.3-1 操作日志查询场景

### 7.1.4 安全事件场景

+   安全事件记录与安全相关的重要行为，是安全审计的核心数据。

#### 7.1.4.1 安全事件类型

+   安全事件类型如下表所示。

    | 事件编码 | 事件类型     | 触发时机                       | 严重级别 |
    | -------- | ------------ | ------------------------------ | -------- |
    | SEC-01   | 密码修改     | 用户主动修改密码成功           | INFO     |
    | SEC-02   | 密码重置     | 通过重置验证码重置密码成功     | WARN     |
    | SEC-03   | 密码重置请求 | 请求发送密码重置邮件           | INFO     |
    | SEC-04   | MFA启用      | 用户启用多因素认证             | INFO     |
    | SEC-05   | MFA禁用      | 用户禁用多因素认证             | WARN     |
    | SEC-06   | 账号锁定     | 密码错误次数超限触发锁定       | WARN     |
    | SEC-07   | 账号解锁     | 管理员手动解锁或自动解锁       | INFO     |
    | SEC-08   | 异常登录     | 检测到异地登录、新设备登录     | WARN     |
    | SEC-09   | 权限提升     | 用户被授予高权限角色           | WARN     |
    | SEC-10   | 强制下线     | 用户被管理员强制踢出           | WARN     |
    | SEC-11   | 账号禁用     | 用户账号被管理员禁用           | HIGH     |
    | SEC-12   | 账号删除     | 用户账号被删除                 | HIGH     |
    | SEC-13   | 账号注销     | 用户注销完成（冷静期结束执行） | HIGH     |
    | SEC-14   | 权限降级     | 用户被移除高权限角色           | INFO     |
    | SEC-15   | 数据授权变更 | 数据访问权限被授予或撤销       | WARN     |

    表 7.1.4.1-1 安全事件类型

+   严重级别说明：

    | 级别 | 英文 | 说明                   |
    | ---- | ---- | ---------------------- |
    | INFO | 信息 | 正常的安全相关操作     |
    | WARN | 警告 | 需要关注的安全事件     |
    | HIGH | 高危 | 可能存在安全风险的事件 |

    表 7.1.4.1-2 安全事件严重级别

#### 7.1.4.2 安全事件查询场景

+   安全事件查询场景如下表所示。

    | 场景编码 | 查询场景       | 查询者 | 典型用例                 |
    | -------- | -------------- | ------ | ------------------------ |
    | QRY-S-01 | 按用户查询     | 管理员 | 查看某用户的安全事件历史 |
    | QRY-S-02 | 按事件类型查询 | 管理员 | 查看所有密码重置事件     |
    | QRY-S-03 | 按严重级别查询 | 管理员 | 只看HIGH级别事件         |
    | QRY-S-04 | 按时间段查询   | 管理员 | 审计特定时段的安全事件   |

    表 7.1.4.2-1 安全事件查询场景

### 7.1.5 日志存储策略

+   审计日志按用户群分库存储，与业务数据同库，保证事务一致性。

#### 7.1.5.1 分库存储策略

+   日志分库存储策略如下表所示。

    | 用户群   | 数据库                   | 日志表前缀 | 存储内容                 |
    | -------- | ------------------------ | ---------- | ------------------------ |
    | provider | clarisphere_platform     | iam_       | 运营用户群用户的审计日志 |
    | ur       | clarisphere_t{tenant_id} | iam_       | 租户用户的审计日志       |
    | uc       | clarisphere_consumer     | iam_       | 个人用户的审计日志       |

    表 7.1.5.1-1 日志分库存储策略

#### 7.1.5.2 日志保留策略

+   不同类型日志的保留策略如下表所示。

    | 日志类型 | 默认保留期限 | 最短保留期限 | 清理方式 | 说明                   |
    | -------- | ------------ | ------------ | -------- | ---------------------- |
    | 登录日志 | 180天        | 90天         | 物理删除 | 等保要求至少180天      |
    | 操作日志 | 180天        | 90天         | 物理删除 | 等保要求至少180天      |
    | 安全事件 | 365天        | 180天        | 物理删除 | 安全合规要求更长保留期 |

    表 7.1.5.2-1 日志保留策略

+   保留策略说明：
    -   超过保留期限的日志由**定时任务自动清理**
    -   清理前可选**同步至平台日志中心**（BC-12）进行长期归档
    -   租户可在合同中约定更长保留期限（付费增值服务）
    -   清理任务采用**分批删除**，避免长事务锁表

### 7.1.6 场景与流程映射

+   各业务场景对应的后续流程如下表所示。

    | 场景分类 | 业务场景     | 对应流程         | 流程编号  |
    | -------- | ------------ | ---------------- | --------- |
    | 登录日志 | 登录日志记录 | 登录日志记录流程 | FL-AUD-01 |
    | 登录日志 | 登录日志查询 | 登录日志查询流程 | FL-AUD-02 |
    | 操作日志 | 操作日志记录 | 操作日志记录流程 | FL-AUD-03 |
    | 操作日志 | 操作日志查询 | 操作日志查询流程 | FL-AUD-04 |
    | 安全事件 | 安全事件记录 | 安全事件记录流程 | FL-AUD-05 |
    | 安全事件 | 安全事件查询 | 安全事件查询流程 | FL-AUD-06 |
    | 日志清理 | 过期日志清理 | 日志清理流程     | FL-AUD-07 |

    表 7.1.6-1 场景与流程映射

## 7.2 业务流程设计

+   本节设计审计管理的业务流程，覆盖日志记录和日志查询两大类场景。
+   流程编号规则：FL-AUD-xx（审计流程）。

### 7.2.1 流程层级说明

+   审计管理流程分为三个层级。

    | 层级     | 说明               | 示例             |
    | -------- | ------------------ | ---------------- |
    | 业务流程 | 完整的审计业务流程 | 登录日志记录流程 |
    | 子流程   | 可复用的流程片段   | 日志持久化子流程 |
    | 活动     | 最小执行单元       | 写入数据库       |

    表 7.2.1-1 流程层级说明

+   审计流程清单如下表所示。

    | 流程编号  | 流程名称     | 触发方式 | 优先级 | 说明            |
    | --------- | ------------ | -------- | ------ | --------------- |
    | FL-AUD-01 | 登录日志记录 | 同步调用 | P1     | 认证模块调用    |
    | FL-AUD-02 | 登录日志查询 | API请求  | P1     | 管理员/用户查询 |
    | FL-AUD-03 | 操作日志记录 | AOP拦截  | P1     | 自动拦截记录    |
    | FL-AUD-04 | 操作日志查询 | API请求  | P1     | 管理员查询      |
    | FL-AUD-05 | 安全事件记录 | 事件驱动 | P1     | 领域事件触发    |
    | FL-AUD-06 | 安全事件查询 | API请求  | P1     | 管理员查询      |
    | FL-AUD-07 | 过期日志清理 | 定时任务 | P2     | 每日凌晨执行    |

    表 7.2.1-2 审计流程清单

### 7.2.2 FL-AUD-01 登录日志记录流程

+   本流程描述登录相关行为的日志记录过程。

#### 7.2.2.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                                                          |
    | ---------- | ------------------------------------------------------------- |
    | 流程名称   | 登录日志记录                                                  |
    | 流程编号   | FL-AUD-01                                                     |
    | 触发条件   | 认证模块完成登录验证（成功或失败），或MFA验证完成，或会话过期 |
    | 前置条件   | 用户发起登录请求，或会话存在                                  |
    | 后置条件   | 登录日志写入数据库                                            |
    | 适用用户群 | UP / UR / UC                                                  |
    | 调用方式   | 同步调用（认证流程中直接调用）+ 事件驱动（MFA验证、会话过期） |

    表 7.2.2.1-1 登录日志记录流程概述

#### 7.2.2.2 流程图

+   登录日志记录流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUD-01 登录日志记录流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 接收登录事件    │                                                      │
    │    │ (来自认证模块)  │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 解析请求上下文  │                                                      │
    │    │ • client_ip     │                                                      │
    │    │ • user_agent    │                                                      │
    │    │ • device_type   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 解析IP归属地    │                                                      │
    │    │ (可选，依赖IP库)│                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 构建日志实体    │                                                      │
    │    │ LoginLog        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 确定目标数据源  │                                                      │
    │    │ 根据user_pool   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 写入数据库      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────◇                                                           │
    │        ╱ 写入成功？╲    否    ┌─────────────────┐                           │
    │       ◇───────────◇─────────▶ │ 记录错误日志    │                           │
    │             │ 是              │ (不阻塞主流程)  │                           │
    │             │                 └─────────────────┘                           │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2.2.2-1 登录日志记录流程图

#### 7.2.2.3 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作           | 执行者   | 输入               | 输出         | 异常处理           |
    | ---- | -------------- | -------- | ------------------ | ------------ | ------------------ |
    | 1    | 接收登录事件   | 审计服务 | 登录结果、用户信息 | -            | -                  |
    | 2    | 解析请求上下文 | 审计服务 | HttpRequest        | IP、UA、设备 | 解析失败使用默认值 |
    | 3    | 解析IP归属地   | 审计服务 | client_ip          | location     | 解析失败留空       |
    | 4    | 构建日志实体   | 审计服务 | 上下文信息         | LoginLog     | -                  |
    | 5    | 确定目标数据源 | 审计服务 | user_pool          | DataSource   | -                  |
    | 6    | 写入数据库     | 审计服务 | LoginLog           | -            | 失败记录错误日志   |

    表 7.2.2.3-1 登录日志记录流程步骤

#### 7.2.2.4 异常处理

+   登录日志记录的异常处理策略：
    -   **不阻塞主流程**：日志记录失败不影响用户正常登录
    -   **降级处理**：数据库写入失败时，记录到本地错误日志
    -   **重试机制**：V1.0暂不实现重试，V2.0可考虑异步队列

### 7.2.3 FL-AUD-02 登录日志查询流程

+   本流程描述管理员或用户查询登录日志的过程。

#### 7.2.3.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                              |
    | ---------- | --------------------------------- |
    | 流程名称   | 登录日志查询                      |
    | 流程编号   | FL-AUD-02                         |
    | 触发条件   | 用户访问登录日志查询页面或调用API |
    | 前置条件   | 用户已登录且有查询权限            |
    | 后置条件   | 返回符合条件的登录日志列表        |
    | 适用用户群 | UP / UR / UC                      |

    表 7.2.3.1-1 登录日志查询流程概述

#### 7.2.3.2 流程图

+   登录日志查询流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUD-02 登录日志查询流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 接收查询请求    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 校验用户权限    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────◇                                                           │
    │        ╱ 有权限？ ╲    否    ┌─────────────────┐                            │
    │       ◇───────────◇─────────▶│ 返回403错误     │                            │
    │             │ 是              └─────────────────┘                           │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 解析查询参数    │                                                      │
    │    │ • username      │                                                      │
    │    │ • login_result  │                                                      │
    │    │ • time_range    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │         ◇─────────────◇                                                     │
    │        ╱ 是否查自己？  ╲                                                    │
    │       ◇───────────────◇                                                     │
    │        │ 是            │ 否（管理员查全部）                                 │
    │        ▼               ▼                                                    │
    │    ┌───────────┐   ┌──────────┐                                             │
    │    │添加user_id│   │不限制    │                                             │
    │    │过滤条件   │   │user_id   │                                             │
    │    └────┬──────┘   └────┬─────┘                                             │
    │         └───────┬──────┘                                                    │
    │                 │                                                           │
    │                 ▼                                                           │
    │    ┌─────────────────┐                                                      │
    │    │ 确定目标数据源  │                                                      │
    │    │ 根据user_pool   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 执行分页查询    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 组装响应DTO     │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 返回查询结果    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2.3.2-1 登录日志查询流程图

#### 7.2.3.3 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作           | 执行者   | 输入             | 输出       | 异常处理        |
    | ---- | -------------- | -------- | ---------------- | ---------- | --------------- |
    | 1    | 接收查询请求   | 控制器   | HTTP请求         | 查询参数   | -               |
    | 2    | 校验用户权限   | 安全框架 | 当前用户、权限码 | 校验结果   | 无权限返回403   |
    | 3    | 解析查询参数   | 应用服务 | 请求参数         | 查询条件   | 参数错误返回400 |
    | 4    | 添加数据范围   | 应用服务 | 当前用户         | 过滤条件   | -               |
    | 5    | 确定目标数据源 | 应用服务 | user_pool        | DataSource | -               |
    | 6    | 执行分页查询   | 仓储     | 查询条件         | 日志列表   | -               |
    | 7    | 组装响应DTO    | 组装器   | 日志实体列表     | DTO列表    | -               |
    | 8    | 返回查询结果   | 控制器   | DTO列表          | HTTP响应   | -               |

    表 7.2.3.3-1 登录日志查询流程步骤

### 7.2.4 FL-AUD-03 操作日志记录流程

+   本流程描述通过AOP自动记录操作日志的过程。

#### 7.2.4.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                              |
    | ---------- | --------------------------------- |
    | 流程名称   | 操作日志记录                      |
    | 流程编号   | FL-AUD-03                         |
    | 触发条件   | 带有@OperationLog注解的方法被调用 |
    | 前置条件   | 用户已登录并发起业务操作          |
    | 后置条件   | 操作日志写入数据库                |
    | 适用用户群 | provider / ur                     |
    | 调用方式   | AOP环绕通知自动拦截               |

    表 7.2.4.1-1 操作日志记录流程概述

#### 7.2.4.2 流程图

+   操作日志记录流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUD-03 操作日志记录流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ AOP拦截方法调用 │                                                      │
    │    │ @OperationLog   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 记录开始时间    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 解析注解参数    │                                                      │
    │    │ • module        │                                                      │
    │    │ • operation     │                                                      │
    │    │ • targetType    │                                                      │
    │    │ • logLevel      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 获取当前用户    │                                                      │
    │    │ 从SecurityContext│                                                     │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 提取请求参数    │                                                      │
    │    │ (脱敏处理)      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 执行目标方法    │                                                      │
    │    │ proceed()       │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │         ◇───────◇                                                           │
    │        ╱ 执行成功？╲                                                        │
    │       ◇───────────◇                                                         │
    │        │ 是        │ 否                                                     │
    │        ▼           ▼                                                        │
    │    ┌────────┐  ┌────────┐                                                   │
    │    │result= │  │result= │                                                   │
    │    │SUCCESS │  │FAILED  │                                                   │
    │    │提取返回│  │记录异常│                                                   │
    │    │值中的ID│  │信息    │                                                   │
    │    └───┬────┘  └───┬────┘                                                   │
    │        └─────┬─────┘                                                        │
    │              │                                                              │
    │              ▼                                                              │
    │    ┌─────────────────┐                                                      │
    │    │ 计算执行耗时    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 构建日志实体    │                                                      │
    │    │ OperationLog    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 异步写入数据库  │                                                      │
    │    │ (不阻塞主流程)  │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 返回/抛出原结果 │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2.4.2-1 操作日志记录流程图

#### 7.2.4.3 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作           | 执行者   | 输入            | 输出         | 异常处理         |
    | ---- | -------------- | -------- | --------------- | ------------ | ---------------- |
    | 1    | AOP拦截        | 切面     | 方法调用        | JoinPoint    | -                |
    | 2    | 记录开始时间   | 切面     | -               | startTime    | -                |
    | 3    | 解析注解参数   | 切面     | @OperationLog   | 模块、操作等 | -                |
    | 4    | 获取当前用户   | 切面     | SecurityContext | 用户信息     | 未登录则跳过记录 |
    | 5    | 提取请求参数   | 切面     | 方法参数        | 脱敏后的参数 | -                |
    | 6    | 执行目标方法   | 切面     | -               | 返回值/异常  | -                |
    | 7    | 计算执行耗时   | 切面     | startTime       | duration_ms  | -                |
    | 8    | 构建日志实体   | 切面     | 上下文信息      | OperationLog | -                |
    | 9    | 异步写入数据库 | 审计服务 | OperationLog    | -            | 失败记录错误日志 |
    | 10   | 返回原结果     | 切面     | 返回值/异常     | -            | -                |

    表 7.2.4.3-1 操作日志记录流程步骤

#### 7.2.4.4 参数脱敏规则

+   请求参数需要脱敏处理，防止敏感信息泄露。

    | 字段类型 | 脱敏规则             | 示例                                      |
    | -------- | -------------------- | ----------------------------------------- |
    | 密码     | 完全隐藏             | password → ******                         |
    | 手机号   | 中间4位隐藏          | 13812345678 → 138****5678                 |
    | 邮箱     | @前保留3位，其余隐藏 | <test@example.com> → <tes***@example.com> |
    | 身份证   | 中间10位隐藏         | 110101199001011234 → 1101****1234         |
    | 银行卡   | 只保留后4位          | 6222021234567890 → ************7890       |

    表 7.2.4.4-1 参数脱敏规则

### 7.2.5 FL-AUD-05 安全事件记录流程

+   本流程描述安全相关事件的记录过程。

#### 7.2.5.1 流程概述

+   流程基本信息如下。

    | 项目       | 内容                   |
    | ---------- | ---------------------- |
    | 流程名称   | 安全事件记录           |
    | 流程编号   | FL-AUD-05              |
    | 触发条件   | 发生安全相关的领域事件 |
    | 前置条件   | 安全相关操作执行完成   |
    | 后置条件   | 安全事件写入数据库     |
    | 适用用户群 | UP / UR / UC           |
    | 调用方式   | 领域事件监听           |

    表 7.2.5.1-1 安全事件记录流程概述

#### 7.2.5.2 流程图

+   安全事件记录流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUD-05 安全事件记录流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │  开始   │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌────────────────────┐                                                   │
    │    │ 监听领域事件       │                                                   │
    │    │ • UserPasswordChanged                                                  │
    │    │ • UserDisabled     │                                                   │
    │    │ • MfaEnabled       │                                                   │
    │    │ • UserCancelled    │                                                   │
    │    │ • SuspiciousLogin  │                                                   │
    │    │ • DataAccessChanged│                                                   │
    │    │ • ...              │                                                   │
    │    └────────┬───────────┘                                                   │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 映射事件类型    │                                                      │
    │    │ 领域事件 →      │                                                      │
    │    │ SecurityEventType                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 确定严重级别    │                                                      │
    │    │ INFO/WARN/HIGH  │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 提取事件数据    │                                                      │
    │    │ 从领域事件中    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 构建安全事件    │                                                      │
    │    │ SecurityEvent   │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────┐                                                      │
    │    │ 写入数据库      │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2.5.2-1 安全事件记录流程图

#### 7.2.5.3 领域事件与安全事件映射

+   领域事件与安全事件类型的映射关系如下表所示。

    | 领域事件                | 安全事件类型         | 严重级别 | 说明                       |
    | ----------------------- | -------------------- | -------- | -------------------------- |
    | UserPasswordChanged     | PASSWORD_CHANGED     | INFO     | 用户主动修改密码           |
    | UserPasswordReset       | PASSWORD_RESET       | WARN     | 通过重置验证码重置密码     |
    | PasswordResetRequested  | PASSWORD_RESET_REQ   | INFO     | 请求发送密码重置邮件       |
    | MfaEnabled              | MFA_ENABLED          | INFO     | 启用多因素认证             |
    | MfaDisabled             | MFA_DISABLED         | WARN     | 禁用多因素认证             |
    | AccountLocked           | ACCOUNT_LOCKED       | WARN     | 账号被锁定                 |
    | UserUnlocked            | ACCOUNT_UNLOCKED     | INFO     | 账号被解锁                 |
    | UserDisabled            | ACCOUNT_DISABLED     | HIGH     | 账号被禁用                 |
    | UserDeleted             | ACCOUNT_DELETED      | HIGH     | 账号被删除                 |
    | UserCancelled           | ACCOUNT_CANCELLED    | HIGH     | 用户注销完成               |
    | UserRoleAssignedEvent   | PRIVILEGE_ESCALATION | WARN     | 被授予角色（含高权限）     |
    | UserRoleRevokedEvent    | PRIVILEGE_REVOCATION | INFO     | 被移除角色                 |
    | DataAccessGrantedEvent  | DATA_ACCESS_GRANTED  | WARN     | 数据访问权限被授予         |
    | DataAccessRevokedEvent  | DATA_ACCESS_REVOKED  | WARN     | 数据访问权限被撤销         |
    | SessionKicked           | FORCE_LOGOUT         | WARN     | 被强制下线                 |
    | SuspiciousLoginDetected | SUSPICIOUS_LOGIN     | WARN     | 检测到异地登录、新设备登录 |

    表 7.2.5.3-1 领域事件与安全事件映射

### 7.2.6 FL-AUD-07 过期日志清理流程

+   本流程描述定时清理过期审计日志的过程。

#### 7.2.6.1 流程概述

+   流程基本信息如下。

    | 项目     | 内容                     |
    | -------- | ------------------------ |
    | 流程名称 | 过期日志清理             |
    | 流程编号 | FL-AUD-07                |
    | 触发条件 | 定时任务（每日凌晨3:00） |
    | 前置条件 | -                        |
    | 后置条件 | 超过保留期限的日志被删除 |
    | 执行频率 | 每日一次                 |

    表 7.2.6.1-1 过期日志清理流程概述

#### 7.2.6.2 流程图

+   过期日志清理流程如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      FL-AUD-07 过期日志清理流程                             │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │    ┌─────────┐                                                              │
    │    │定时触发 │                                                              │
    │    │03:00    │                                                              │
    │    └────┬────┘                                                              │
    │         │                                                                   │
    │         ▼                                                                   │
    │    ┌─────────────────┐                                                      │
    │    │ 获取所有数据源  │                                                      │
    │    │ platform +      │                                                      │
    │    │ 所有tenant +    │                                                      │
    │    │ consumer        │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────────────────────────────────────────────────────┐              │
    │    │ 循环处理每个数据源                                      │              │
    │    │  ┌───────────────────────────────────────────────────┐  │              │
    │    │  │                                                   │  │              │
    │    │  │    ┌─────────────────┐                            │  │              │
    │    │  │    │ 计算截止日期    │                            │  │              │
    │    │  │    │ 当前日期-180天  │                            │  │              │
    │    │  │    └────────┬────────┘                            │  │              │
    │    │  │             │                                     │  │              │
    │    │  │             ▼                                     │  │              │
    │    │  │    ┌─────────────────┐                            │  │              │
    │    │  │    │ 分批删除登录日志│                            │  │              │
    │    │  │    │ 每批1000条      │                            │  │              │
    │    │  │    └────────┬────────┘                            │  │              │
    │    │  │             │                                     │  │              │
    │    │  │             ▼                                     │  │              │
    │    │  │    ┌─────────────────┐                            │  │              │
    │    │  │    │ 分批删除操作日志│                            │  │              │
    │    │  │    │ 每批1000条      │                            │  │              │
    │    │  │    └────────┬────────┘                            │  │              │
    │    │  │             │                                     │  │              │
    │    │  │             ▼                                     │  │              │
    │    │  │    ┌─────────────────┐                            │  │              │
    │    │  │    │ 分批删除安全事件│                            │  │              │
    │    │  │    │ 截止日期-365天  │                            │  │              │
    │    │  │    └────────┬────────┘                            │  │              │
    │    │  │             │                                     │  │              │
    │    │  └─────────────┼─────────────────────────────────────┘  │              │
    │    └────────────────┼────────────────────────────────────────┘              │
    │                     │                                                       │
    │                     ▼                                                       │
    │    ┌─────────────────┐                                                      │
    │    │ 记录清理结果    │                                                      │
    │    │ 各表删除条数    │                                                      │
    │    └────────┬────────┘                                                      │
    │             │                                                               │
    │             ▼                                                               │
    │    ┌─────────┐                                                              │
    │    │  结束   │                                                              │
    │    └─────────┘                                                              │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.2.6.2-1 过期日志清理流程图

#### 7.2.6.3 流程步骤

+   流程步骤如下表所示。

    | 步骤 | 操作             | 执行者   | 输入         | 输出       | 异常处理           |
    | ---- | ---------------- | -------- | ------------ | ---------- | ------------------ |
    | 1    | 定时触发         | 调度器   | cron表达式   | -          | -                  |
    | 2    | 获取所有数据源   | 清理任务 | -            | 数据源列表 | -                  |
    | 3    | 计算截止日期     | 清理任务 | 保留天数     | 截止日期   | -                  |
    | 4    | 分批删除登录日志 | 清理任务 | 截止日期     | 删除条数   | 失败记录日志并继续 |
    | 5    | 分批删除操作日志 | 清理任务 | 截止日期     | 删除条数   | 失败记录日志并继续 |
    | 6    | 分批删除安全事件 | 清理任务 | 截止日期     | 删除条数   | 失败记录日志并继续 |
    | 7    | 记录清理结果     | 清理任务 | 各表删除条数 | -          | -                  |

    表 7.2.6.3-1 过期日志清理流程步骤

#### 7.2.6.4 分批删除策略

+   分批删除避免长事务锁表，策略如下：

    | 配置项         | 默认值 | 说明               |
    | -------------- | ------ | ------------------ |
    | batch_size     | 1000   | 每批删除的记录数   |
    | batch_interval | 100ms  | 批次间隔时间       |
    | max_batches    | 1000   | 单次任务最大批次数 |
    | timeout        | 30min  | 单次任务超时时间   |

    表 7.2.6.4-1 分批删除配置

+   分批删除伪代码：

    ```java
    int totalDeleted = 0;
    int batchCount = 0;
    while (batchCount < maxBatches) {
        int deleted = loginLogRepository.deleteByCreatedAtBefore(cutoffDate, batchSize);
        totalDeleted += deleted;
        if (deleted < batchSize) {
            break; // 已删除完毕
        }
        batchCount++;
        Thread.sleep(batchInterval);
    }
    log.info("登录日志清理完成，共删除{}条", totalDeleted);
    ```

[待续...]

## 7.3 领域模型设计

+   本节设计审计管理子领域的领域模型，包括聚合划分、实体、值对象、领域服务和领域事件。
+   审计管理的领域模型相对简单，主要是日志实体的记录和查询，不涉及复杂的业务规则。
+   日志实体创建后**不可修改**，只支持创建和查询操作。

### 7.3.1 聚合划分

+   审计管理子领域划分为以下聚合：

    | 聚合名称     | 聚合根        | 职责             | 所属数据库          |
    | ------------ | ------------- | ---------------- | ------------------- |
    | 登录日志聚合 | LoginLog      | 记录登录相关行为 | 按user_pool分库存储 |
    | 操作日志聚合 | OperationLog  | 记录关键业务操作 | 按user_pool分库存储 |
    | 安全事件聚合 | SecurityEvent | 记录安全相关事件 | 按user_pool分库存储 |

    表 7.3.1-1 审计管理聚合划分

+   聚合划分说明：
    -   三类日志相互独立，不存在跨聚合引用
    -   日志实体创建后**不可修改**，只支持创建和查询
    -   日志实体的生命周期由**保留策略**控制，到期自动删除
    -   聚合之间无直接引用，各自独立存储

### 7.3.2 聚合关系图

+   审计管理子领域聚合关系如下图所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                      审计管理子领域聚合关系图                               │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │   clarisphere_platform       clarisphere_t{tenant_id}   clarisphere_consumer│
    │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
    │  │     LoginLog        │    │     LoginLog        │    │   LoginLog      │  │
    │  │   (登录日志聚合)    │    │   (登录日志聚合)    │    │ (登录日志聚合)  │  │
    │  ├─────────────────────┤    ├─────────────────────┤    ├─────────────────┤  │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │ │ «聚合根»        │ │    │ │ «聚合根»        │ │    │ │ «聚合根»    │ │  │
    │  │ │ LoginLog        │ │    │ │ LoginLog        │ │    │ │ LoginLog    │ │  │
    │  │ └────────┬────────┘ │    │ └────────┬────────┘ │    │ └──────┬──────┘ │  │
    │  │          │          │    │          │          │    │        │        │  │
    │  │          ▼          │    │          ▼          │    │        ▼        │  │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │ │ «值对象»        │ │    │ │ «值对象»        │ │    │ │ «值对象»    │ │  │
    │  │ │ ClientInfo      │ │    │ │ ClientInfo      │ │    │ │ ClientInfo  │ │  │
    │  │ └─────────────────┘ │    │ └─────────────────┘ │    │ └─────────────┘ │  │
    │  └─────────────────────┘    └─────────────────────┘    └─────────────────┘  │
    │                                                                             │
    │  ┌─────────────────────┐    ┌─────────────────────┐                         │
    │  │   OperationLog      │    │   OperationLog      │     (C端无操作日志)     │
    │  │  (操作日志聚合)     │    │  (操作日志聚合)     │                         │
    │  ├─────────────────────┤    ├─────────────────────┤                         │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │                         │
    │  │ │ «聚合根»        │ │    │ │ «聚合根»        │ │                         │
    │  │ │ OperationLog    │ │    │ │ OperationLog    │ │                         │
    │  │ └────────┬────────┘ │    │ └────────┬────────┘ │                         │
    │  │          │          │    │          │          │                         │
    │  │          ▼          │    │          ▼          │                         │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │                         │
    │  │ │ «值对象»        │ │    │ │ «值对象»        │ │                         │
    │  │ │ Target          │ │    │ │ Target          │ │                         │
    │  │ │ ClientInfo      │ │    │ │ ClientInfo      │ │                         │
    │  │ └─────────────────┘ │    │ └─────────────────┘ │                         │
    │  └─────────────────────┘    └─────────────────────┘                         │
    │                                                                             │
    │  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
    │  │   SecurityEvent     │    │   SecurityEvent     │    │ SecurityEvent   │  │
    │  │  (安全事件聚合)     │    │  (安全事件聚合)     │    │(安全事件聚合)   │  │
    │  ├─────────────────────┤    ├─────────────────────┤    ├─────────────────┤  │
    │  │ ┌─────────────────┐ │    │ ┌─────────────────┐ │    │ ┌─────────────┐ │  │
    │  │ │ «聚合根»        │ │    │ │ «聚合根»        │ │    │ │ «聚合根»    │ │  │
    │  │ │ SecurityEvent   │ │    │ │ SecurityEvent   │ │    │ │SecurityEvent│ │  │
    │  │ └─────────────────┘ │    │ └─────────────────┘ │    │ └─────────────┘ │  │
    │  └─────────────────────┘    └─────────────────────┘    └─────────────────┘  │
    │                                                                             │
    │   共享值对象（跨聚合复用）                                                  │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │ LoginType │ LoginResult │ LogLevel │ Severity │ SecurityEventType   │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.3.2-1 审计管理聚合关系图

### 7.3.3 LoginLog 聚合（登录日志）

+   LoginLog聚合管理登录相关行为的日志，按用户群分库存储。

#### 7.3.3.1 聚合结构

+   LoginLog聚合包含以下元素：

    | 元素类型 | 元素名称    | 说明                          |
    | -------- | ----------- | ----------------------------- |
    | 聚合根   | LoginLog    | 登录日志实体                  |
    | 值对象   | LoginType   | 登录方式（密码/短信/OAuth等） |
    | 值对象   | LoginResult | 登录结果（成功/失败/登出等）  |
    | 值对象   | ClientInfo  | 客户端信息（IP/UA/设备等）    |
    | 值对象   | UserPool    | 用户群（UP/UR/UC）            |

    表 7.3.3.1-1 LoginLog聚合结构

#### 7.3.3.2 LoginLog 实体

+   LoginLog是聚合根，管理登录相关行为的日志（不可变对象），采用三表模型定义如下。

##### 属性清单表

| 属性名      | 类型        | 约束                   | 默认值         | 业务含义                            |
| ----------- | ----------- | ---------------------- | -------------- | ----------------------------------- |
| id          | Long        | 必填，主键             | AUTO_INCREMENT | 日志ID，自增主键                    |
| userId      | Long        | 可选                   | null           | 用户ID，登录失败时可能为空          |
| username    | String      | 必填，长度≤128         | -              | 登录账号（用户名/手机号/邮箱）      |
| userPool    | UserPool    | 必填，枚举             | -              | 用户群：UP/UR/UC                    |
| tenantCode  | String      | UR时必填，长度3-32位   | null           | 租户编码（仅UR用户）                |
| loginType   | LoginType   | 必填，枚举             | -              | 登录方式：PASSWORD/SMS_CODE/OAUTH等 |
| loginResult | LoginResult | 必填，枚举             | -              | 登录结果：SUCCESS/FAILED/LOGOUT等   |
| failReason  | String      | FAILED时填写，长度≤256 | null           | 失败原因描述                        |
| clientInfo  | ClientInfo  | 必填                   | -              | 客户端信息值对象                    |
| sessionId   | String      | SUCCESS时填写，长度≤64 | null           | 会话ID                              |
| createdAt   | DateTime    | 必填，不可变           | NOW()          | 记录时间                            |

表 7.3.3.2-1 LoginLog属性清单表

##### 业务规则表

| 规则编号 | 规则名称           | 规则简述                                             | 验证时机 | 违反后果     |
| -------- | ------------------ | ---------------------------------------------------- | -------- | ------------ |
| LL-R-01  | 不可变对象         | LoginLog创建后所有属性不可修改                       | 更新     | 拒绝操作     |
| LL-R-02  | ID自动生成         | id由数据库自动生成（AUTO_INCREMENT），不接受外部输入 | 创建     | -            |
| LL-R-03  | 时间自动设置       | createdAt由系统自动设置为当前时间                    | 创建     | -            |
| LL-R-04  | 失败时username必填 | loginResult=FAILED时userId可为空，但username必须记录 | 创建     | -            |
| LL-R-05  | 成功时userId必填   | loginResult=SUCCESS时userId必须记录                  | 创建     | -            |
| LL-R-06  | 按用户群分库存储   | 根据userPool路由到对应数据库存储                     | 创建     | -            |
| LL-R-07  | 记录失败不阻塞     | 日志记录失败不阻塞主登录流程，采用降级策略           | 创建     | 记录错误日志 |
| LL-R-08  | 保留期限           | 登录日志保留180天，超期由定时任务清理                | -        | -            |

表 7.3.3.2-2 LoginLog业务规则表

##### 业务方法表

| 方法名              | 方法简述            | 关联规则         | 异常 | 事件 |
| ------------------- | ------------------- | ---------------- | ---- | ---- |
| createSuccess()     | 创建登录成功日志    | LL-R-02,03,05,06 | -    | -    |
| createFailure()     | 创建登录失败日志    | LL-R-02,03,04,06 | -    | -    |
| createLogout()      | 创建主动登出日志    | LL-R-02,03,05,06 | -    | -    |
| createRefresh()     | 创建Token刷新日志   | LL-R-02,03,05,06 | -    | -    |
| createKicked()      | 创建会话被踢出日志  | LL-R-02,03,05,06 | -    | -    |
| createExpired()     | 创建会话过期日志    | LL-R-02,03,05,06 | -    | -    |
| createMfaVerified() | 创建MFA验证成功日志 | LL-R-02,03,05,06 | -    | -    |

表 7.3.3.2-3 LoginLog业务方法表

+   备注：
    -   LoginLog为不可变对象，创建后不提供任何修改方法
    -   所有创建方法均为静态工厂方法，确保对象创建的一致性
    -   clientInfo包含IP、UA、设备类型、地理位置等信息

#### 7.3.3.3 LoginType 值对象

+   LoginType值对象封装登录方式，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型          | 约束       | 默认值 | 业务含义     |
| ------ | ------------- | ---------- | ------ | ------------ |
| type   | LoginTypeEnum | 必填，枚举 | -      | 登录方式类型 |

表 7.3.3.3-1 LoginType属性清单表

##### 枚举值及特性表

| 枚举值         | 说明       | 适用用户群 | 需要凭证    | 需要二次验证 |
| -------------- | ---------- | ---------- | ----------- | ------------ |
| PASSWORD       | 用户名密码 | UP/UR/UC   | 密码        | 视MFA配置    |
| SMS_CODE       | 短信验证码 | UR/UC      | 验证码      | 否           |
| EMAIL_CODE     | 邮箱验证码 | UR/UC      | 验证码      | 否           |
| OAUTH_QQ       | QQ登录     | UC         | OAuth Token | 否           |
| OAUTH_WECHAT   | 微信登录   | UC         | OAuth Token | 否           |
| OAUTH_DINGTALK | 钉钉登录   | UR         | OAuth Token | 否           |
| SSO            | 企业SSO    | UR         | SSO Token   | 否           |
| SCAN_CODE      | 扫码登录   | UR/UC      | 二维码      | 否           |

表 7.3.3.3-2 LoginType枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称      | 规则简述                            | 验证时机 | 违反后果 |
| -------- | ------------- | ----------------------------------- | -------- | -------- |
| LT-R-01  | 用户群匹配    | 登录方式必须与用户群支持的方式匹配  | 登录     | 拒绝登录 |
| LT-R-02  | UP仅密码      | UP用户群仅支持PASSWORD方式          | 登录     | 拒绝登录 |
| LT-R-03  | SSO租户配置   | SSO登录需租户预先配置IdP            | 登录     | 拒绝登录 |
| LT-R-04  | OAuth绑定前提 | OAuth登录需用户预先绑定对应社交账号 | 登录     | 引导绑定 |

表 7.3.3.3-3 LoginType业务规则表

#### 7.3.3.4 LoginResult 值对象

+   LoginResult值对象封装登录结果，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型            | 约束       | 默认值 | 业务含义     |
| ------ | --------------- | ---------- | ------ | ------------ |
| result | LoginResultEnum | 必填，枚举 | -      | 登录结果类型 |

表 7.3.3.4-1 LoginResult属性清单表

##### 枚举值及特性表

| 枚举值       | 说明        | 是否成功 | 触发场景           | 关联会话操作     |
| ------------ | ----------- | -------- | ------------------ | ---------------- |
| SUCCESS      | 登录成功    | 是       | 认证通过           | 创建会话         |
| FAILED       | 登录失败    | 否       | 认证失败           | 无               |
| LOGOUT       | 主动登出    | -        | 用户主动登出       | 销毁会话         |
| REFRESH      | Token刷新   | 是       | 刷新Token成功      | 更新会话活跃时间 |
| KICKED       | 被踢出      | -        | 管理员强制下线     | 销毁会话         |
| EXPIRED      | 会话过期    | -        | 会话超时自动失效   | 标记会话过期     |
| MFA_VERIFIED | MFA验证成功 | 是       | 双因素认证验证通过 | 无（会话已存在） |

表 7.3.3.4-2 LoginResult枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称     | 规则简述                                      | 验证时机 | 违反后果 |
| -------- | ------------ | --------------------------------------------- | -------- | -------- |
| LR-R-01  | 成功需用户ID | result=SUCCESS时，LoginLog的userId必须记录    | 创建日志 | -        |
| LR-R-02  | 失败需原因   | result=FAILED时，LoginLog的failReason必须记录 | 创建日志 | -        |
| LR-R-03  | 会话关联     | SUCCESS需关联sessionId，其他不需要            | 创建日志 | -        |

表 7.3.3.4-3 LoginResult业务规则表

#### 7.3.3.5 ClientInfo 值对象

+   ClientInfo值对象封装客户端信息，采用三表模型定义如下。

##### 属性清单表

| 属性名     | 类型       | 约束           | 默认值  | 业务含义                     |
| ---------- | ---------- | -------------- | ------- | ---------------------------- |
| clientIp   | String     | 必填，IP格式   | -       | 客户端IP地址                 |
| userAgent  | String     | 可选，长度≤512 | null    | 浏览器User-Agent字符串       |
| deviceType | DeviceType | 可选，枚举     | UNKNOWN | 设备类型：PC/MOBILE/TABLET等 |
| location   | String     | 可选，长度≤128 | null    | IP归属地（国家-省-市）       |

表 7.3.3.5-1 ClientInfo属性清单表

##### DeviceType枚举值表

| 枚举值  | 说明 | User-Agent特征              |
| ------- | ---- | --------------------------- |
| PC      | 电脑 | Windows/Mac/Linux且非Mobile |
| MOBILE  | 手机 | iPhone/Android且非Tablet    |
| TABLET  | 平板 | iPad/Android Tablet         |
| UNKNOWN | 未知 | 无法识别                    |

表 7.3.3.5-2 DeviceType枚举值

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                           | 验证时机 | 违反后果 |
| -------- | -------------- | -------------------------------------------------- | -------- | -------- |
| CI-R-01  | IP必填         | clientIp为必填项，无法获取时使用"0.0.0.0"          | 创建     | -        |
| CI-R-02  | 设备类型解析   | deviceType从userAgent自动解析，无法识别时为UNKNOWN | 创建     | -        |
| CI-R-03  | 归属地异步解析 | location通过IP库异步解析，失败时留空               | 创建     | -        |
| CI-R-04  | 不可变性       | 值对象创建后不可修改                               | -        | -        |

表 7.3.3.5-3 ClientInfo业务规则表

+   ClientInfo核心行为：

    | 方法名        | 参数        | 返回值     | 说明                       |
    | ------------- | ----------- | ---------- | -------------------------- |
    | fromRequest() | HttpRequest | ClientInfo | 从HTTP请求中解析客户端信息 |
    | empty()       | -           | ClientInfo | 创建空的客户端信息         |

    表 7.3.3.5-4 ClientInfo核心行为

### 7.3.4 OperationLog 聚合（操作日志）

+   OperationLog聚合管理关键业务操作的日志，仅运营用户群和租户用户群使用。

#### 7.3.4.1 聚合结构

+   OperationLog聚合包含以下元素：

    | 元素类型 | 元素名称     | 说明                       |
    | -------- | ------------ | -------------------------- |
    | 聚合根   | OperationLog | 操作日志实体               |
    | 值对象   | Target       | 操作目标（类型/ID/名称）   |
    | 值对象   | LogLevel     | 日志级别（普通/重要/关键） |
    | 值对象   | ClientInfo   | 客户端信息                 |
    | 值对象   | UserPool     | 用户群                     |

    表 7.3.4.1-1 OperationLog聚合结构

#### 7.3.4.2 OperationLog 实体

+   OperationLog是聚合根，管理关键业务操作的日志（不可变对象），采用三表模型定义如下。

##### 属性清单表

| 属性名      | 类型       | 约束                        | 默认值         | 业务含义                                |
| ----------- | ---------- | --------------------------- | -------------- | --------------------------------------- |
| id          | Long       | 必填，主键                  | AUTO_INCREMENT | 日志ID，自增主键                        |
| userId      | Long       | 必填                        | -              | 操作人ID                                |
| username    | String     | 必填，长度≤128              | -              | 操作人用户名                            |
| userPool    | UserPool   | 必填，枚举                  | -              | 用户群：UP/UR（UC无操作日志）           |
| tenantCode  | String     | UR时必填，长度≤32           | null           | 租户编码（仅UR用户）                    |
| module      | String     | 必填，长度≤64               | -              | 功能模块标识（如UserManagement）        |
| operation   | String     | 必填，长度≤32               | -              | 操作类型：CREATE/UPDATE/DELETE/ENABLE等 |
| target      | Target     | 可选                        | null           | 操作目标值对象                          |
| requestData | String     | 可选，长度≤4000，脱敏后存储 | null           | 请求参数JSON                            |
| resultData  | String     | 可选，长度≤4000，脱敏后存储 | null           | 返回结果JSON                            |
| success     | Boolean    | 必填                        | true           | 操作是否成功                            |
| errorMsg    | String     | 失败时填写，长度≤512        | null           | 错误信息                                |
| clientInfo  | ClientInfo | 必填                        | -              | 客户端信息值对象                        |
| durationMs  | Long       | 必填                        | -              | 执行耗时（毫秒）                        |
| logLevel    | LogLevel   | 必填，枚举                  | NORMAL         | 日志级别：NORMAL/IMPORTANT/CRITICAL     |
| createdAt   | DateTime   | 必填，不可变                | NOW()          | 操作时间                                |

表 7.3.4.2-1 OperationLog属性清单表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                        | 验证时机 | 违反后果 |
| -------- | ---------------- | ----------------------------------------------- | -------- | -------- |
| OL-R-01  | 不可变对象       | OperationLog创建后所有属性不可修改              | 更新     | 拒绝操作 |
| OL-R-02  | 操作人必须记录   | userId和username必须记录，用于追溯操作人        | 创建     | -        |
| OL-R-03  | 参数必须脱敏     | requestData必须脱敏处理，不得包含密码等敏感信息 | 创建     | -        |
| OL-R-04  | AOP自动拦截      | 通过@OperationLog注解+AOP自动拦截记录           | 执行     | -        |
| OL-R-05  | 异步写入         | 操作日志异步写入数据库，不阻塞主业务流程        | 创建     | -        |
| OL-R-06  | 按用户群分库存储 | 根据userPool路由到对应数据库存储                | 创建     | -        |
| OL-R-07  | UC无操作日志     | C端用户群（UC）不记录操作日志                   | -        | -        |
| OL-R-08  | 保留期限         | 操作日志保留180天，超期由定时任务清理           | -        | -        |

表 7.3.4.2-2 OperationLog业务规则表

+   参数脱敏规则详细说明如下表所示。

| 字段类型 | 脱敏规则             | 示例                                    |
| -------- | -------------------- | --------------------------------------- |
| 密码     | 完全隐藏             | password → ******                       |
| 手机号   | 中间4位隐藏          | 13812345678 → 138****5678               |
| 邮箱     | @前保留3位，其余隐藏 | <test@example.com> → tes***@example.com |
| 身份证   | 中间10位隐藏         | 110101199001011234 → 1101****1234       |
| 银行卡   | 只保留后4位          | 6222021234567890 → ************7890     |

表 7.3.4.2-3 参数脱敏规则

##### 业务方法表

| 方法名          | 方法简述         | 关联规则         | 异常 | 事件 |
| --------------- | ---------------- | ---------------- | ---- | ---- |
| createSuccess() | 创建操作成功日志 | OL-R-02,03,05,06 | -    | -    |
| createFailure() | 创建操作失败日志 | OL-R-02,03,05,06 | -    | -    |

表 7.3.4.2-4 OperationLog业务方法表

+   备注：
    -   OperationLog为不可变对象，创建后不提供任何修改方法
    -   建议通过@OperationLog注解配合AOP实现自动记录
    -   异步写入失败时记录到本地错误日志，不影响主业务

#### 7.3.4.3 Target 值对象

+   Target值对象封装操作目标，采用三表模型定义如下。

##### 属性清单表

| 属性名     | 类型   | 约束           | 默认值 | 业务含义                   |
| ---------- | ------ | -------------- | ------ | -------------------------- |
| targetType | String | 必填，长度≤32  | -      | 目标类型：User/Role/Org等  |
| targetId   | Long   | 可选           | null   | 目标资源ID                 |
| targetName | String | 可选，长度≤128 | null   | 目标名称（冗余，便于展示） |

表 7.3.4.3-1 Target属性清单表

##### 常用targetType值表

| targetType  | 说明 | targetId示例 | 使用场景          |
| ----------- | ---- | ------------ | ----------------- |
| User        | 用户 | 用户ID       | 用户管理操作      |
| Role        | 角色 | 角色ID       | 角色管理操作      |
| Org         | 组织 | 组织单元ID   | 组织管理操作      |
| Position    | 岗位 | 岗位ID       | 岗位管理操作      |
| Person      | 人员 | 人员ID       | 人员管理操作      |
| Appointment | 任职 | 任职记录ID   | 任职管理操作      |
| Permission  | 权限 | 权限ID       | 权限管理操作      |
| Config      | 配置 | 配置项Key    | 系统配置操作      |
| Tenant      | 租户 | 租户编码     | 租户配置/同步操作 |
| Batch       | 批量 | 批次号       | 批量操作          |

表 7.3.4.3-2 常用targetType值

##### 业务规则表

| 规则编号 | 规则名称 | 规则简述                               | 验证时机 | 违反后果 |
| -------- | -------- | -------------------------------------- | -------- | -------- |
| TG-R-01  | 类型必填 | targetType为必填项，标识操作的资源类型 | 创建     | -        |
| TG-R-02  | ID可选   | 批量操作或创建操作时targetId可为空     | 创建     | -        |
| TG-R-03  | 名称冗余 | targetName冗余存储，资源删除后仍可追溯 | 创建     | -        |
| TG-R-04  | 不可变性 | 值对象创建后不可修改                   | -        | -        |

表 7.3.4.3-3 Target业务规则表

+   Target核心行为：

    | 方法名  | 参数                       | 返回值 | 说明               |
    | ------- | -------------------------- | ------ | ------------------ |
    | of()    | targetType, targetId, name | Target | 静态工厂，创建目标 |
    | empty() | -                          | Target | 创建空目标         |

    表 7.3.4.3-4 Target核心行为

#### 7.3.4.4 LogLevel 值对象

+   LogLevel值对象封装日志级别，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型         | 约束       | 默认值 | 业务含义   |
| ------ | ------------ | ---------- | ------ | ---------- |
| level  | LogLevelEnum | 必填，枚举 | NORMAL | 日志级别值 |

表 7.3.4.4-1 LogLevel属性清单表

##### 枚举值及特性表

| 枚举值    | 优先级 | 说明 | 典型操作           | 保留期限 | 是否告警 |
| --------- | ------ | ---- | ------------------ | -------- | -------- |
| NORMAL    | 1      | 普通 | 更新信息、查询     | 90天     | 否       |
| IMPORTANT | 2      | 重要 | 创建、禁用、启用   | 180天    | 否       |
| CRITICAL  | 3      | 关键 | 删除、安全配置变更 | 365天    | 是       |

表 7.3.4.4-2 LogLevel枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                 | 验证时机 | 违反后果 |
| -------- | -------------- | ---------------------------------------- | -------- | -------- |
| LL-R-01  | 自动判定       | 根据操作类型自动判定LogLevel             | 创建     | -        |
| LL-R-02  | 可手动覆盖     | 特殊情况可手动指定更高级别               | 创建     | -        |
| LL-R-03  | CRITICAL需告警 | level=CRITICAL的操作日志需触发告警通知   | 创建     | -        |
| LL-R-04  | 差异化保留     | 不同级别的日志保留期限不同，见枚举特性表 | 清理     | -        |

表 7.3.4.4-3 LogLevel业务规则表

### 7.3.5 SecurityEvent 聚合（安全事件）

+   SecurityEvent聚合管理安全相关的事件，用于安全审计和合规追溯。

#### 7.3.5.1 聚合结构

+   SecurityEvent聚合包含以下元素：

    | 元素类型 | 元素名称          | 说明                           |
    | -------- | ----------------- | ------------------------------ |
    | 聚合根   | SecurityEvent     | 安全事件实体                   |
    | 值对象   | SecurityEventType | 事件类型（密码修改/MFA变更等） |
    | 值对象   | Severity          | 严重级别（信息/警告/高危）     |
    | 值对象   | UserPool          | 用户群                         |

    表 7.3.5.1-1 SecurityEvent聚合结构

#### 7.3.5.2 SecurityEvent 实体

+   SecurityEvent是聚合根，管理安全相关的事件（不可变对象），采用三表模型定义如下。

##### 属性清单表

| 属性名     | 类型              | 约束              | 默认值         | 业务含义                       |
| ---------- | ----------------- | ----------------- | -------------- | ------------------------------ |
| id         | Long              | 必填，主键        | AUTO_INCREMENT | 事件ID，自增主键               |
| userId     | Long              | 必填              | -              | 被影响的用户ID                 |
| username   | String            | 必填，长度≤128    | -              | 被影响的用户名                 |
| userPool   | UserPool          | 必填，枚举        | -              | 用户群：UP/UR/UC               |
| tenantCode | String            | UR时必填，长度≤32 | null           | 租户编码（仅UR用户）           |
| eventType  | SecurityEventType | 必填，枚举        | -              | 事件类型                       |
| eventDesc  | String            | 可选，长度≤256    | null           | 事件描述                       |
| eventData  | String            | 可选，长度≤4000   | null           | 附加数据（JSON格式）           |
| severity   | Severity          | 必填，枚举        | -              | 严重级别：INFO/WARN/HIGH       |
| clientIp   | String            | 可选，IP格式      | null           | 客户端IP                       |
| operatorId | Long              | 可选              | null           | 操作人ID（被管理员操作时填写） |
| createdAt  | DateTime          | 必填，不可变      | NOW()          | 事件时间                       |

表 7.3.5.2-1 SecurityEvent属性清单表

+   安全事件类型与默认严重级别映射如下表所示。

    | 事件类型枚举           | 默认严重级别 | 说明         | 触发场景                   |
    | ---------------------- | ------------ | ------------ | -------------------------- |
    | PASSWORD_CHANGED       | INFO         | 密码修改     | 用户主动修改密码           |
    | PASSWORD_RESET         | WARN         | 密码重置     | 通过找回密码重置           |
    | PASSWORD_RESET_REQUEST | INFO         | 密码重置请求 | 用户发起找回密码请求       |
    | MFA_ENABLED            | INFO         | MFA启用      | 用户开启双因素认证         |
    | MFA_DISABLED           | WARN         | MFA禁用      | 用户关闭双因素认证         |
    | ACCOUNT_LOCKED         | WARN         | 账号锁定     | 登录失败超限自动锁定       |
    | ACCOUNT_UNLOCKED       | INFO         | 账号解锁     | 管理员解锁或自动解锁       |
    | SUSPICIOUS_LOGIN       | WARN         | 异常登录     | 异地登录、异常设备等       |
    | PRIVILEGE_ESCALATION   | WARN         | 权限提升     | 用户角色权限被提升         |
    | PRIVILEGE_REVOCATION   | INFO         | 权限降级     | 用户被移除高权限角色       |
    | DATA_ACCESS_GRANTED    | WARN         | 数据授权授予 | 数据访问权限被授予         |
    | DATA_ACCESS_REVOKED    | WARN         | 数据授权撤销 | 数据访问权限被撤销         |
    | FORCE_LOGOUT           | WARN         | 强制下线     | 管理员踢出用户会话         |
    | ACCOUNT_DISABLED       | HIGH         | 账号禁用     | 管理员禁用账号             |
    | ACCOUNT_DELETED        | HIGH         | 账号删除     | 账号被删除                 |
    | ACCOUNT_CANCELLED      | HIGH         | 账号注销     | 用户注销完成（冷静期结束） |

    表 7.3.5.2-2 安全事件类型映射表

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                           | 验证时机 | 违反后果 |
| -------- | ---------------- | -------------------------------------------------- | -------- | -------- |
| SE-R-01  | 不可变对象       | SecurityEvent创建后所有属性不可修改                | 更新     | 拒绝操作 |
| SE-R-02  | 默认严重级别     | severity默认由eventType决定，也可手动覆盖          | 创建     | -        |
| SE-R-03  | 区分操作人       | operatorId记录"谁对该用户执行了操作"，区别于userId | 创建     | -        |
| SE-R-04  | 领域事件触发     | 安全事件通过监听领域事件自动记录                   | 事件发布 | -        |
| SE-R-05  | 按用户群分库存储 | 根据userPool路由到对应数据库存储                   | 创建     | -        |
| SE-R-06  | 保留期限         | 安全事件保留365天（1年），满足合规要求             | -        | -        |
| SE-R-07  | 高危事件告警     | severity=HIGH的事件需触发告警通知                  | 创建     | -        |

表 7.3.5.2-3 SecurityEvent业务规则表

##### 业务方法表

| 方法名               | 方法简述                   | 关联规则      | 异常 | 事件 |
| -------------------- | -------------------------- | ------------- | ---- | ---- |
| create()             | 创建安全事件               | SE-R-02,03,05 | -    | -    |
| createWithOperator() | 创建由管理员触发的安全事件 | SE-R-02,03,05 | -    | -    |

表 7.3.5.2-4 SecurityEvent业务方法表

+   备注：
    -   SecurityEvent为不可变对象，创建后不提供任何修改方法
    -   安全事件主要通过监听领域事件自动记录，减少代码侵入
    -   高危安全事件（如账号禁用、删除）需同时触发告警通知
    -   保留期限1年满足等保合规要求

#### 7.3.5.3 SecurityEventType 值对象

+   SecurityEventType值对象封装安全事件类型，采用三表模型定义如下。

##### 属性清单表

| 属性名 | 类型                  | 约束       | 默认值 | 业务含义       |
| ------ | --------------------- | ---------- | ------ | -------------- |
| type   | SecurityEventTypeEnum | 必填，枚举 | -      | 安全事件类型值 |

表 7.3.5.3-1 SecurityEventType属性清单表

##### 枚举值及特性表

| 枚举值                 | 默认严重级别 | 说明         | 触发源          | 需要告警 | 合规要求 |
| ---------------------- | ------------ | ------------ | --------------- | -------- | -------- |
| PASSWORD_CHANGED       | INFO         | 密码修改     | 用户自助        | 否       | 等保二级 |
| PASSWORD_RESET         | WARN         | 密码重置     | 找回密码/管理员 | 否       | 等保二级 |
| PASSWORD_RESET_REQUEST | INFO         | 密码重置请求 | 用户发起        | 否       | -        |
| MFA_ENABLED            | INFO         | MFA启用      | 用户/管理员     | 否       | 等保三级 |
| MFA_DISABLED           | WARN         | MFA禁用      | 用户/管理员     | 是       | 等保三级 |
| ACCOUNT_LOCKED         | WARN         | 账号锁定     | 系统自动        | 是       | 等保二级 |
| ACCOUNT_UNLOCKED       | INFO         | 账号解锁     | 管理员/自动     | 否       | 等保二级 |
| SUSPICIOUS_LOGIN       | WARN         | 异常登录     | 系统检测        | 是       | 等保三级 |
| PRIVILEGE_ESCALATION   | WARN         | 权限提升     | 管理员操作      | 是       | 等保三级 |
| PRIVILEGE_REVOCATION   | INFO         | 权限降级     | 管理员操作      | 否       | 等保三级 |
| DATA_ACCESS_GRANTED    | WARN         | 数据授权授予 | 管理员操作      | 否       | 等保三级 |
| DATA_ACCESS_REVOKED    | WARN         | 数据授权撤销 | 管理员操作      | 否       | 等保三级 |
| FORCE_LOGOUT           | WARN         | 强制下线     | 管理员操作      | 否       | -        |
| ACCOUNT_DISABLED       | HIGH         | 账号禁用     | 管理员操作      | 是       | 等保二级 |
| ACCOUNT_DELETED        | HIGH         | 账号删除     | 管理员操作      | 是       | 等保二级 |
| ACCOUNT_CANCELLED      | HIGH         | 账号注销     | 用户发起        | 是       | 等保二级 |

表 7.3.5.3-2 SecurityEventType枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称       | 规则简述                                 | 验证时机 | 违反后果 |
| -------- | -------------- | ---------------------------------------- | -------- | -------- |
| SET-R-01 | 默认严重级别   | 创建事件时默认使用枚举定义的严重级别     | 创建     | -        |
| SET-R-02 | 级别可升不可降 | 可手动指定更高严重级别，但不能低于默认值 | 创建     | 自动调整 |
| SET-R-03 | 告警触发       | 需要告警的事件类型创建时自动触发告警通知 | 创建     | -        |
| SET-R-04 | 合规留痕       | 涉及等保要求的事件类型必须完整记录       | 创建     | -        |

表 7.3.5.3-3 SecurityEventType业务规则表

#### 7.3.5.4 Severity 值对象

+   Severity值对象封装严重级别，采用三表模型定义如下。

##### 属性清单表

| 属性名   | 类型         | 约束       | 默认值 | 业务含义   |
| -------- | ------------ | ---------- | ------ | ---------- |
| severity | SeverityEnum | 必填，枚举 | INFO   | 严重级别值 |

表 7.3.5.4-1 Severity属性清单表

##### 枚举值及特性表

| 枚举值 | 优先级 | 说明 | 典型事件                                   | 保留期限 | 告警方式       |
| ------ | ------ | ---- | ------------------------------------------ | -------- | -------------- |
| INFO   | 1      | 信息 | 密码修改、MFA启用、权限降级、账号解锁      | 365天    | 不告警         |
| WARN   | 2      | 警告 | 账号锁定、异常登录、数据授权变更、强制下线 | 365天    | 邮件通知       |
| HIGH   | 3      | 高危 | 账号禁用、账号删除、账号注销               | 365天    | 邮件+短信+站内 |

表 7.3.5.4-2 Severity枚举值及特性

##### 业务规则表

| 规则编号 | 规则名称         | 规则简述                                     | 验证时机 | 违反后果 |
| -------- | ---------------- | -------------------------------------------- | -------- | -------- |
| SV-R-01  | 级别继承         | 默认从SecurityEventType继承严重级别          | 创建     | -        |
| SV-R-02  | 可升级不可降级   | 可手动提升严重级别，但不能低于事件类型默认值 | 创建     | 自动调整 |
| SV-R-03  | HIGH级别强制告警 | severity=HIGH的事件必须触发多渠道告警        | 创建     | -        |
| SV-R-04  | 合规保留         | WARN和HIGH级别事件保留1年满足等保合规要求    | 清理     | -        |

表 7.3.5.4-3 Severity业务规则表

### 7.3.6 领域服务

+   审计管理子领域包含以下领域服务：

    | 服务名称          | 职责         | 说明                   |
    | ----------------- | ------------ | ---------------------- |
    | AuditLogService   | 审计日志记录 | 提供统一的日志记录入口 |
    | LogCleanupService | 日志清理     | 处理过期日志的清理逻辑 |

    表 7.3.6-1 领域服务清单

#### 7.3.6.1 AuditLogService

+   AuditLogService负责审计日志的记录，提供统一的日志记录入口：

    | 方法名              | 参数                         | 返回值 | 说明                |
    | ------------------- | ---------------------------- | ------ | ------------------- |
    | logLoginSuccess()   | 用户信息、登录方式、客户端等 | void   | 记录登录成功日志    |
    | logLoginFailure()   | 用户名、失败原因、客户端     | void   | 记录登录失败日志    |
    | logLogout()         | 用户信息、客户端             | void   | 记录登出日志        |
    | logMfaVerified()    | 用户信息、MFA方式、客户端    | void   | 记录MFA验证成功日志 |
    | logSessionExpired() | sessionId、userId、user_pool | void   | 记录会话过期日志    |
    | logOperation()      | OperationLog                 | void   | 记录操作日志        |
    | logSecurityEvent()  | SecurityEvent                | void   | 记录安全事件        |

    表 7.3.6.1-1 AuditLogService方法

+   AuditLogService设计要点：
    -   日志记录失败**不阻塞主流程**，采用降级策略
    -   自动根据user_pool路由到对应数据源
    -   操作日志支持异步写入，避免影响业务性能

#### 7.3.6.2 LogCleanupService

+   LogCleanupService负责过期日志的清理：

    | 方法名                  | 参数       | 返回值 | 说明                   |
    | ----------------------- | ---------- | ------ | ---------------------- |
    | cleanupExpiredLogs()    | -          | void   | 清理所有类型的过期日志 |
    | cleanupLoginLogs()      | cutoffDate | int    | 清理过期登录日志       |
    | cleanupOperationLogs()  | cutoffDate | int    | 清理过期操作日志       |
    | cleanupSecurityEvents() | cutoffDate | int    | 清理过期安全事件       |

    表 7.3.6.2-1 LogCleanupService方法

+   LogCleanupService设计要点：
    -   采用分批删除策略，避免长事务锁表
    -   每批删除后间隔一定时间，减少数据库压力
    -   支持跨数据源清理（platform/tenant/consumer）

### 7.3.7 仓储接口

+   审计管理子领域包含以下仓储接口：

    | 仓储名称                | 聚合根        | 说明         |
    | ----------------------- | ------------- | ------------ |
    | LoginLogRepository      | LoginLog      | 登录日志仓储 |
    | OperationLogRepository  | OperationLog  | 操作日志仓储 |
    | SecurityEventRepository | SecurityEvent | 安全事件仓储 |

    表 7.3.7-1 仓储接口清单

#### 7.3.7.1 LoginLogRepository

+   LoginLogRepository仓储方法：

    | 方法名                    | 参数                  | 返回值         | 说明                     |
    | ------------------------- | --------------------- | -------------- | ------------------------ |
    | save()                    | LoginLog              | void           | 保存登录日志             |
    | findByCondition()         | query, pageable       | Page<LoginLog> | 分页查询登录日志         |
    | findByUserId()            | userId, limit         | List<LoginLog> | 根据用户ID查询           |
    | deleteByCreatedAtBefore() | cutoffTime, batchSize | int            | 删除指定时间之前的日志   |
    | countByTimeRange()        | startTime, endTime    | long           | 统计指定时间段的登录次数 |

    表 7.3.7.1-1 LoginLogRepository方法

#### 7.3.7.2 OperationLogRepository

+   OperationLogRepository仓储方法：

    | 方法名                    | 参数                  | 返回值             | 说明                   |
    | ------------------------- | --------------------- | ------------------ | ---------------------- |
    | save()                    | OperationLog          | void               | 保存操作日志           |
    | findByCondition()         | query, pageable       | Page<OperationLog> | 分页查询操作日志       |
    | findByTargetId()          | targetType, targetId  | List<OperationLog> | 根据目标ID查询操作历史 |
    | deleteByCreatedAtBefore() | cutoffTime, batchSize | int                | 删除指定时间之前的日志 |

    表 7.3.7.2-1 OperationLogRepository方法

#### 7.3.7.3 SecurityEventRepository

+   SecurityEventRepository仓储方法：

    | 方法名                    | 参数                  | 返回值              | 说明                   |
    | ------------------------- | --------------------- | ------------------- | ---------------------- |
    | save()                    | SecurityEvent         | void                | 保存安全事件           |
    | findByCondition()         | query, pageable       | Page<SecurityEvent> | 分页查询安全事件       |
    | findByUserId()            | userId, limit         | List<SecurityEvent> | 根据用户ID查询         |
    | deleteByCreatedAtBefore() | cutoffTime, batchSize | int                 | 删除指定时间之前的事件 |

    表 7.3.7.3-1 SecurityEventRepository方法

### 7.3.8 领域事件

+   审计管理子领域主要是**接收**其他子领域的领域事件，根据事件性质将其转化为**安全事件**记录或**登录日志**记录。操作日志通过AOP切面记录，不依赖领域事件监听。

#### 7.3.8.1 监听的领域事件

+   审计管理监听以下领域事件：

    | 领域事件                | 来源子领域 | 转化为安全事件类型   | 说明                       |
    | ----------------------- | ---------- | -------------------- | -------------------------- |
    | UserPasswordChanged     | 用户管理   | PASSWORD_CHANGED     | 用户主动修改密码           |
    | UserPasswordReset       | 用户管理   | PASSWORD_RESET       | 通过重置验证码重置密码     |
    | PasswordResetRequested  | 认证管理   | PASSWORD_RESET_REQ   | 请求发送密码重置邮件       |
    | MfaEnabled              | 用户管理   | MFA_ENABLED          | 启用多因素认证             |
    | MfaDisabled             | 用户管理   | MFA_DISABLED         | 禁用多因素认证             |
    | AccountLocked           | 认证管理   | ACCOUNT_LOCKED       | 账号被锁定                 |
    | UserUnlocked            | 用户管理   | ACCOUNT_UNLOCKED     | 账号被解锁                 |
    | UserDisabled            | 用户管理   | ACCOUNT_DISABLED     | 账号被禁用                 |
    | UserDeleted             | 用户管理   | ACCOUNT_DELETED      | 账号被删除                 |
    | UserCancelled           | 用户管理   | ACCOUNT_CANCELLED    | 用户注销完成               |
    | UserRoleAssignedEvent   | 授权管理   | PRIVILEGE_ESCALATION | 被授予角色（含高权限）     |
    | UserRoleRevokedEvent    | 授权管理   | PRIVILEGE_REVOCATION | 被移除角色                 |
    | DataAccessGrantedEvent  | 授权管理   | DATA_ACCESS_GRANTED  | 数据访问权限被授予         |
    | DataAccessRevokedEvent  | 授权管理   | DATA_ACCESS_REVOKED  | 数据访问权限被撤销         |
    | SessionKicked           | 认证管理   | FORCE_LOGOUT         | 被强制下线                 |
    | SuspiciousLoginDetected | 认证管理   | SUSPICIOUS_LOGIN     | 检测到异地登录、新设备登录 |

    表 7.3.8.1-1 监听的领域事件

#### 7.3.8.2 事件处理说明

+   领域事件处理要点：
    -   事件监听采用**异步处理**，不影响主业务流程
    -   事件处理失败时记录错误日志，不抛出异常
    -   从领域事件中提取必要信息，转化为SecurityEvent实体

+   **事件名称统一规则**：
    -   审计管理统一按**事件发布侧的原始名称**进行监听，不做别名转换
    -   认证管理发布的AccountLocked、SessionKicked、SuspiciousLoginDetected等事件，审计管理按原始名称注册@EventListener
    -   用户管理发布的UserPasswordChanged与认证管理发布的PasswordChanged是同一业务动作的两个视角，审计管理仅监听UserPasswordChanged（用户管理侧），避免重复入库

#### 7.3.8.3 登录事件监听

+   审计管理还监听以下领域事件，将其转化为**登录日志**（LoginLog），而非安全事件（SecurityEvent）：

    | 领域事件          | 来源子领域 | 转化为登录日志结果 | 说明               |
    | ----------------- | ---------- | ------------------ | ------------------ |
    | MfaVerified       | 认证管理   | MFA_VERIFIED       | 双因素认证验证通过 |
    | SessionTerminated | 认证管理   | EXPIRED            | 会话超时自动失效   |

    表 7.3.8.3-1 登录事件监听清单

+   登录事件处理要点：
    -   MfaVerified事件转化为LoginLog（loginResult=MFA_VERIFIED），记录MFA验证通过的时间和方式
    -   SessionTerminated事件转化为LoginLog（loginResult=EXPIRED），记录会话过期的时间点
    -   处理方式与安全事件监听一致：异步处理，失败不抛出异常

### 7.3.9 协作关系

+   本节梳理审计管理子领域与其他子领域及共享服务之间的协作关系，包括领域内协作、跨领域协作和共享服务协作三个层面。

#### 7.3.9.1 领域内协作

+   审计管理子领域内部，领域服务与聚合之间的协作关系如下表所示。

    | 协作编号  | 调用方                    | 被调用方                | 协作方式 | 触发场景                   | 说明                                                                  |
    | --------- | ------------------------- | ----------------------- | -------- | -------------------------- | --------------------------------------------------------------------- |
    | INTRA-401 | AuditLogService           | LoginLog（聚合根）      | 方法调用 | 记录登录成功/失败/登出日志 | 调用LoginLog.create(cmd)创建登录日志实体                              |
    | INTRA-402 | AuditLogService           | LoginLog（聚合根）      | 方法调用 | 记录MFA验证/会话过期日志   | 调用LoginLog.create(cmd)，loginResult分别为MFA_VERIFIED和EXPIRED      |
    | INTRA-403 | AuditLogService           | OperationLog（聚合根）  | 方法调用 | 记录操作日志               | 调用OperationLog.create(cmd)创建操作日志实体                          |
    | INTRA-404 | AuditLogService           | SecurityEvent（聚合根） | 方法调用 | 记录安全事件               | 调用SecurityEvent.create(cmd)创建安全事件实体                         |
    | INTRA-405 | AuditLogService           | LoginLogRepository      | 仓储调用 | 持久化登录日志             | 调用LoginLogRepository.save()保存登录日志                             |
    | INTRA-406 | AuditLogService           | OperationLogRepository  | 仓储调用 | 持久化操作日志             | 调用OperationLogRepository.save()保存操作日志                         |
    | INTRA-407 | AuditLogService           | SecurityEventRepository | 仓储调用 | 持久化安全事件             | 调用SecurityEventRepository.save()保存安全事件                        |
    | INTRA-408 | LogCleanupService         | LoginLogRepository      | 仓储调用 | 清理过期登录日志           | 调用LoginLogRepository.deleteByCreatedAtBefore()分批删除过期日志      |
    | INTRA-409 | LogCleanupService         | OperationLogRepository  | 仓储调用 | 清理过期操作日志           | 调用OperationLogRepository.deleteByCreatedAtBefore()分批删除过期日志  |
    | INTRA-410 | LogCleanupService         | SecurityEventRepository | 仓储调用 | 清理过期安全事件           | 调用SecurityEventRepository.deleteByCreatedAtBefore()分批删除过期事件 |
    | INTRA-411 | OperationLogAspect（AOP） | AuditLogService         | 方法调用 | AOP拦截关键操作            | AOP切面拦截@OperationLog注解方法，调用logOperation()记录操作日志      |

    表 7.3.9.1-1 领域内协作关系

+   领域内协作说明：
    -   INTRA-401~407为AuditLogService作为统一入口，分别调用三类聚合根创建实体并通过对应仓储持久化
    -   INTRA-408~410为LogCleanupService的定时清理逻辑，采用分批删除策略避免长事务锁表
    -   INTRA-411为AOP切面自动拦截记录操作日志的协作关系，切面本身不属于领域服务，但作为操作日志的核心触发机制需纳入协作关系描述
    -   审计管理子领域的聚合间无跨聚合引用，三类日志相互独立

#### 7.3.9.2 跨领域协作

+   审计管理子领域与其他子领域的跨领域协作以**被动接收**为主，通过领域事件监听和同步调用两种方式实现。审计管理不主动发起对其他子领域的RPC调用。

##### 与用户管理子领域（第3章）的协作

+   审计管理与用户管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                                            | 说明                                                           |
    | --------- | ------------------- | -------- | -------------------------------------------------------- | -------------------------------------------------------------- |
    | CROSS-401 | 用户管理 → 审计管理 | 领域事件 | UserPasswordChanged                                      | 审计管理监听并记录安全事件（PASSWORD_CHANGED），见表7.3.8.1-1  |
    | CROSS-402 | 用户管理 → 审计管理 | 领域事件 | UserPasswordReset                                        | 审计管理监听并记录安全事件（PASSWORD_RESET），见表7.3.8.1-1    |
    | CROSS-403 | 用户管理 → 审计管理 | 领域事件 | MfaEnabled                                               | 审计管理监听并记录安全事件（MFA_ENABLED），见表7.3.8.1-1       |
    | CROSS-404 | 用户管理 → 审计管理 | 领域事件 | MfaDisabled                                              | 审计管理监听并记录安全事件（MFA_DISABLED），见表7.3.8.1-1      |
    | CROSS-405 | 用户管理 → 审计管理 | 领域事件 | UserUnlocked                                             | 审计管理监听并记录安全事件（ACCOUNT_UNLOCKED），见表7.3.8.1-1  |
    | CROSS-406 | 用户管理 → 审计管理 | 领域事件 | UserDisabled                                             | 审计管理监听并记录安全事件（ACCOUNT_DISABLED），见表7.3.8.1-1  |
    | CROSS-407 | 用户管理 → 审计管理 | 领域事件 | UserDeleted                                              | 审计管理监听并记录安全事件（ACCOUNT_DELETED），见表7.3.8.1-1   |
    | CROSS-408 | 用户管理 → 审计管理 | 领域事件 | UserCancelled                                            | 审计管理监听并记录安全事件（ACCOUNT_CANCELLED），见表7.3.8.1-1 |
    | CROSS-409 | 用户管理 → 审计管理 | AOP拦截  | 用户管理的全部CUD操作（创建/更新/删除/禁用/激活/注销等） | AOP切面自动拦截@OperationLog注解方法，记录操作日志             |

    表 7.3.9.2-1 与用户管理子领域的协作

+   协作说明：
    -   CROSS-401~408与第3章表3.3.8.2-4中CROSS-031、CROSS-032为同一组协作的双视角描述，此处从审计管理作为接收方的角度逐条展开
    -   CROSS-401~408均为异步领域事件监听，审计管理通过@EventListener监听事件并转化为SecurityEvent实体，处理失败不影响用户管理主流程
    -   CROSS-409为AOP切面方式，用户管理的关键操作方法标注@OperationLog注解，AOP自动拦截并调用AuditLogService.logOperation()记录操作日志
    -   审计管理仅监听UserPasswordChanged（用户管理侧），不监听认证管理侧的PasswordChanged，避免重复入库（见7.3.8.2节事件名称统一规则）

##### 与组织管理子领域（第4章）的协作

+   审计管理与组织管理之间的协作关系如下表所示。

    | 协作编号  | 方向                | 协作方式 | 触发事件/接口                                                       | 说明                                               |
    | --------- | ------------------- | -------- | ------------------------------------------------------------------- | -------------------------------------------------- |
    | CROSS-411 | 组织管理 → 审计管理 | 领域事件 | PersonResigned                                                      | 审计管理监听并记录人员离职安全审计日志             |
    | CROSS-412 | 组织管理 → 审计管理 | 领域事件 | OrgSyncFailed                                                       | 审计管理监听并记录同步失败安全事件                 |
    | CROSS-413 | 组织管理 → 审计管理 | AOP拦截  | 组织管理的全部CUD操作（组织/岗位/人员/任职的创建/更新/删除/同步等） | AOP切面自动拦截@OperationLog注解方法，记录操作日志 |

    表 7.3.9.2-2 与组织管理子领域的协作

+   协作说明：
    -   CROSS-411、412与第4章表4.3.9.2-3中CROSS-121~123为同一组协作的双视角描述，此处从审计管理作为接收方的角度列出
    -   CROSS-411为人员离职安全审计，PersonResigned事件转化为SecurityEvent记录，便于安全合规追溯
    -   CROSS-412为同步失败安全事件，OrgSyncFailed事件转化为SecurityEvent记录，用于运维告警和问题排查
    -   CROSS-413为AOP切面方式，组织管理的关键操作方法标注@OperationLog注解，AOP自动拦截记录操作日志

## 7.4 接口设计

+   本节设计审计管理子领域的API接口，按用户群分组。
+   接口设计遵循RESTful规范，路径按用户群区分以实现数据源路由。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 7.4.1 接口总览

+   审计管理子领域对外提供REST API接口，无RPC和消息接口。

#### 7.4.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明                                                          |
    | -------- | ---- | ------------------------------------------------------------- |
    | REST API | 14个 | 前端调用                                                      |
    | RPC接口  | 0个  | 审计管理无RPC接口（日志通过事件驱动异步写入）                 |
    | 消息接口 | 0个  | 审计管理为事件消费方，不发布事件（消费契约见3.4/4.4/5.4/6.4） |

    表 7.4.1.1-1 接口分类统计

+   说明：
    -   REST API按用户群分为运营方审计接口（6个）、租户审计接口（6个）、C端用户审计接口（2个）
    -   审计管理作为事件消费方，消费来自用户管理（第3章）、组织管理（第4章）、认证管理（第5章）、授权管理（第6章）的领域事件，并写入对应日志
    -   审计日志的写入通过事件监听器完成，不提供写入API

#### 7.4.1.2 REST API清单表

+   审计管理 REST API 清单如下表所示。

    | API编号   | API名称          | 方法 | 路径                                      | 权限                    | 领域方法                                 | 备注     |
    | --------- | ---------------- | ---- | ----------------------------------------- | ----------------------- | ---------------------------------------- | -------- |
    | P-AUD-01  | 查询登录日志     | GET  | /api/v1/up/iam/audit/login-logs           | provider:iam:audit:read | LoginLogQueryService.list()              | 支持分页 |
    | P-AUD-02  | 获取登录日志详情 | GET  | /api/v1/up/iam/audit/login-logs/{id}      | provider:iam:audit:read | LoginLogQueryService.getDetail()         | -        |
    | P-AUD-03  | 查询操作日志     | GET  | /api/v1/up/iam/audit/operation-logs       | provider:iam:audit:read | OperationLogQueryService.list()          | 支持分页 |
    | P-AUD-04  | 获取操作日志详情 | GET  | /api/v1/up/iam/audit/operation-logs/{id}  | provider:iam:audit:read | OperationLogQueryService.getDetail()     | -        |
    | P-AUD-05  | 查询安全事件     | GET  | /api/v1/up/iam/audit/security-events      | provider:iam:audit:read | SecurityEventQueryService.list()         | 支持分页 |
    | P-AUD-06  | 获取安全事件详情 | GET  | /api/v1/up/iam/audit/security-events/{id} | provider:iam:audit:read | SecurityEventQueryService.getDetail()    | -        |
    | UR-AUD-01 | 查询登录日志     | GET  | /api/v1/ur/iam/audit/login-logs           | ur:iam:audit:read       | LoginLogQueryService.list()              | 支持分页 |
    | UR-AUD-02 | 获取登录日志详情 | GET  | /api/v1/ur/iam/audit/login-logs/{id}      | ur:iam:audit:read       | LoginLogQueryService.getDetail()         | -        |
    | UR-AUD-03 | 查询操作日志     | GET  | /api/v1/ur/iam/audit/operation-logs       | ur:iam:audit:read       | OperationLogQueryService.list()          | 支持分页 |
    | UR-AUD-04 | 获取操作日志详情 | GET  | /api/v1/ur/iam/audit/operation-logs/{id}  | ur:iam:audit:read       | OperationLogQueryService.getDetail()     | -        |
    | UR-AUD-05 | 查询安全事件     | GET  | /api/v1/ur/iam/audit/security-events      | ur:iam:audit:read       | SecurityEventQueryService.list()         | 支持分页 |
    | UR-AUD-06 | 获取安全事件详情 | GET  | /api/v1/ur/iam/audit/security-events/{id} | ur:iam:audit:read       | SecurityEventQueryService.getDetail()    | -        |
    | UC-AUD-01 | 查询我的登录记录 | GET  | /api/v1/uc/iam/audit/my/login-logs        | authenticated           | LoginLogQueryService.listMyLogs()        | 支持分页 |
    | UC-AUD-02 | 查询我的安全事件 | GET  | /api/v1/uc/iam/audit/my/security-events   | authenticated           | SecurityEventQueryService.listMyEvents() | 支持分页 |

    表 7.4.1.2-1 审计管理REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   权限：四段式权限标识，格式为`{用户群}:{限界上下文}:{资源}:{操作}`，详见附录D.3；`authenticated`表示登录即可访问
    -   领域方法：关联到第7.3节领域模型设计中的查询服务方法
    -   备注：简要说明接口的特殊情况

### 7.4.2 REST接口设计

#### 7.4.2.1 运营方审计接口（P-AUD）

+   运营方审计接口用于查询平台级审计日志，需要管理员审计权限。

##### 7.4.2.1.1 接口清单

+   接口清单如下表：

    | API编号  | API名称          | 方法 | 路径                                      | 权限                    | 领域方法                              | 备注     |
    | -------- | ---------------- | ---- | ----------------------------------------- | ----------------------- | ------------------------------------- | -------- |
    | P-AUD-01 | 查询登录日志     | GET  | /api/v1/up/iam/audit/login-logs           | provider:iam:audit:read | LoginLogQueryService.list()           | 支持分页 |
    | P-AUD-02 | 获取登录日志详情 | GET  | /api/v1/up/iam/audit/login-logs/{id}      | provider:iam:audit:read | LoginLogQueryService.getDetail()      | -        |
    | P-AUD-03 | 查询操作日志     | GET  | /api/v1/up/iam/audit/operation-logs       | provider:iam:audit:read | OperationLogQueryService.list()       | 支持分页 |
    | P-AUD-04 | 获取操作日志详情 | GET  | /api/v1/up/iam/audit/operation-logs/{id}  | provider:iam:audit:read | OperationLogQueryService.getDetail()  | -        |
    | P-AUD-05 | 查询安全事件     | GET  | /api/v1/up/iam/audit/security-events      | provider:iam:audit:read | SecurityEventQueryService.list()      | 支持分页 |
    | P-AUD-06 | 获取安全事件详情 | GET  | /api/v1/up/iam/audit/security-events/{id} | provider:iam:audit:read | SecurityEventQueryService.getDetail() | -        |

    表 7.4.2.1.1-1 运营方审计REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第7.3节领域模型设计中的查询服务方法
    -   备注：简要说明接口的特殊情况

##### 7.4.2.1.2 P-AUD-01 查询登录日志

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | P-AUD-01                                                 |
    | 接口路径   | GET /api/v1/up/iam/audit/login-logs                      |
    | 功能简述   | 分页查询运营用户群的登录日志，支持多条件筛选             |
    | 所需权限   | provider:iam:audit:read                                  |
    | 关联功能   | F-AUD-01 登录日志查询                                    |
    | 关联用例   | UC-AUD-01 管理员查询登录日志                             |
    | 关联领域   | LoginLogQueryService.list()                              |
    | 关联规则   | AUD-R-01（日志保留期限180天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                       |
    | 关联错误码 | E-400001, E-401001, E-403001                             |

    表 7.4.2.1.2-1 P-AUD-01契约概述表

+   **请求契约表**

    | 参数名      | 位置  | 类型    | 必填 | 约束                              | 示例值                | 业务含义 |
    | ----------- | ----- | ------- | ---- | --------------------------------- | --------------------- | -------- |
    | username    | query | String  | 否   | 模糊匹配                          | "admin"               | 用户名   |
    | userId      | query | Long    | 否   | 正整数                            | 10001                 | 用户ID   |
    | loginResult | query | String  | 否   | 枚举：SUCCESS/FAILED/LOCKED       | "SUCCESS"             | 登录结果 |
    | loginType   | query | String  | 否   | 枚举：PASSWORD/SMS_CODE/SSO/OAUTH | "PASSWORD"            | 登录方式 |
    | clientIp    | query | String  | 否   | IP格式                            | "192.168.1.100"       | 客户端IP |
    | startTime   | query | String  | 否   | ISO8601格式                       | "2026-01-25T00:00:00" | 开始时间 |
    | endTime     | query | String  | 否   | ISO8601格式                       | "2026-01-26T23:59:59" | 结束时间 |
    | page        | query | Integer | 否   | ≥1，默认1                         | 1                     | 页码     |
    | size        | query | Integer | 否   | 1-100，默认20                     | 20                    | 每页大小 |

    表 7.4.2.1.2-2 P-AUD-01请求契约表

+   **响应契约表**

    | 参数名                      | 类型   | 必有 | 示例值                | 业务含义     |
    | --------------------------- | ------ | ---- | --------------------- | ------------ |
    | code                        | Number | 是   | 200                   | 响应码       |
    | message                     | String | 是   | "success"             | 响应消息     |
    | data.list[]                 | Array  | 是   | [...]                 | 日志列表     |
    | data.list[].id              | Long   | 是   | 10001                 | 日志ID       |
    | data.list[].userId          | Long   | 是   | 10001                 | 用户ID       |
    | data.list[].username        | String | 是   | "admin"               | 用户名       |
    | data.list[].loginType       | String | 是   | "PASSWORD"            | 登录方式     |
    | data.list[].loginTypeText   | String | 是   | "密码登录"            | 登录方式文本 |
    | data.list[].loginResult     | String | 是   | "SUCCESS"             | 登录结果     |
    | data.list[].loginResultText | String | 是   | "登录成功"            | 登录结果文本 |
    | data.list[].failReason      | String | 否   | null                  | 失败原因     |
    | data.list[].clientIp        | String | 是   | "192.168.1.100"       | 客户端IP     |
    | data.list[].location        | String | 否   | "北京市"              | IP归属地     |
    | data.list[].deviceType      | String | 是   | "PC"                  | 设备类型     |
    | data.list[].createdAt       | String | 是   | "2026-01-25T10:30:00" | 记录时间     |
    | data.total                  | Number | 是   | 1000                  | 总记录数     |
    | data.page                   | Number | 是   | 1                     | 当前页码     |
    | data.size                   | Number | 是   | 20                    | 每页大小     |
    | data.pages                  | Number | 是   | 50                    | 总页数       |

    表 7.4.2.1.2-3 P-AUD-01响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10001,
                "username": "admin",
                "loginType": "PASSWORD",
                "loginTypeText": "密码登录",
                "loginResult": "SUCCESS",
                "loginResultText": "登录成功",
                "failReason": null,
                "clientIp": "192.168.1.100",
                "location": "北京市",
                "deviceType": "PC",
                "createdAt": "2026-01-25T10:30:00"
              },
              {
                "id": 10002,
                "userId": 10002,
                "username": "operator",
                "loginType": "SMS_CODE",
                "loginTypeText": "短信验证码",
                "loginResult": "FAILED",
                "loginResultText": "登录失败",
                "failReason": "验证码错误",
                "clientIp": "192.168.1.101",
                "location": "上海市",
                "deviceType": "MOBILE",
                "createdAt": "2026-01-25T10:25:00"
              }
            ],
            "total": 1000,
            "page": 1,
            "size": 20,
            "pages": 50
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   日志保留期限为180天，超期数据由清理任务自动归档
    -   支持多条件组合查询
    -   时间范围查询默认最近7天，最大范围90天

##### 7.4.2.1.3 P-AUD-02 获取登录日志详情

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | P-AUD-02                                 |
    | 接口路径   | GET /api/v1/up/iam/audit/login-logs/{id} |
    | 功能简述   | 根据ID获取登录日志详细信息               |
    | 所需权限   | provider:iam:audit:read                  |
    | 关联功能   | F-AUD-01 登录日志查询                    |
    | 关联用例   | UC-AUD-02 管理员查看登录日志详情         |
    | 关联领域   | LoginLogQueryService.getDetail()         |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404009   |

    表 7.4.2.1.3-1 P-AUD-02契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 10001  | 日志ID   |

    表 7.4.2.1.3-2 P-AUD-02请求契约表

+   **响应契约表**

    | 参数名               | 类型   | 必有 | 示例值                             | 业务含义     |
    | -------------------- | ------ | ---- | ---------------------------------- | ------------ |
    | code                 | Number | 是   | 200                                | 响应码       |
    | message              | String | 是   | "success"                          | 响应消息     |
    | data.id              | Long   | 是   | 10001                              | 日志ID       |
    | data.userId          | Long   | 是   | 10001                              | 用户ID       |
    | data.username        | String | 是   | "admin"                            | 用户名       |
    | data.userPool        | String | 是   | "PROVIDER"                         | 用户群       |
    | data.loginType       | String | 是   | "PASSWORD"                         | 登录方式     |
    | data.loginTypeText   | String | 是   | "密码登录"                         | 登录方式文本 |
    | data.loginResult     | String | 是   | "SUCCESS"                          | 登录结果     |
    | data.loginResultText | String | 是   | "登录成功"                         | 登录结果文本 |
    | data.failReason      | String | 否   | null                               | 失败原因     |
    | data.clientIp        | String | 是   | "192.168.1.100"                    | 客户端IP     |
    | data.userAgent       | String | 是   | "Mozilla/5.0 (Windows NT 10.0...)" | 浏览器UA     |
    | data.deviceType      | String | 是   | "PC"                               | 设备类型     |
    | data.location        | String | 否   | "北京市"                           | IP归属地     |
    | data.sessionId       | String | 否   | "sess-ee0e8400-e29b-41d4-a716-..." | 会话ID       |
    | data.createdAt       | String | 是   | "2026-01-25T10:30:00"              | 记录时间     |

    表 7.4.2.1.3-3 P-AUD-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10001,
            "username": "admin",
            "userPool": "PROVIDER",
            "loginType": "PASSWORD",
            "loginTypeText": "密码登录",
            "loginResult": "SUCCESS",
            "loginResultText": "登录成功",
            "failReason": null,
            "clientIp": "192.168.1.100",
            "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "deviceType": "PC",
            "location": "北京市",
            "sessionId": "sess-ee0e8400-e29b-41d4-a716-446655440000",
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（日志不存在）

        ```json
        {
          "code": 404009,
          "message": "登录日志不存在",
          "data": {
            "logId": 99999
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.1.4 P-AUD-03 查询操作日志

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | P-AUD-03                                                 |
    | 接口路径   | GET /api/v1/up/iam/audit/operation-logs                  |
    | 功能简述   | 分页查询运营用户群的操作日志，支持多条件筛选             |
    | 所需权限   | provider:iam:audit:read                                  |
    | 关联功能   | F-AUD-02 操作日志查询                                    |
    | 关联用例   | UC-AUD-03 管理员查询操作日志                             |
    | 关联领域   | OperationLogQueryService.list()                          |
    | 关联规则   | AUD-R-01（日志保留期限180天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                       |
    | 关联错误码 | E-400001, E-401001, E-403001                             |

    表 7.4.2.1.4-1 P-AUD-03契约概述表

+   **请求契约表**

    | 参数名     | 位置  | 类型    | 必填 | 约束                             | 示例值                | 业务含义     |
    | ---------- | ----- | ------- | ---- | -------------------------------- | --------------------- | ------------ |
    | username   | query | String  | 否   | 模糊匹配                         | "admin"               | 操作人用户名 |
    | userId     | query | Long    | 否   | 正整数                           | 10001                 | 操作人ID     |
    | module     | query | String  | 否   | 枚举：USER/ROLE/ORG/CONFIG       | "USER"                | 模块         |
    | operation  | query | String  | 否   | 枚举：CREATE/UPDATE/DELETE/QUERY | "CREATE"              | 操作类型     |
    | targetType | query | String  | 否   | 目标类型                         | "User"                | 目标类型     |
    | targetId   | query | Long    | 否   | 正整数                           | 10002                 | 目标ID       |
    | logLevel   | query | String  | 否   | 枚举：NORMAL/IMPORTANT/CRITICAL  | "IMPORTANT"           | 日志级别     |
    | result     | query | String  | 否   | 枚举：SUCCESS/FAILED             | "SUCCESS"             | 操作结果     |
    | startTime  | query | String  | 否   | ISO8601格式                      | "2026-01-25T00:00:00" | 开始时间     |
    | endTime    | query | String  | 否   | ISO8601格式                      | "2026-01-26T23:59:59" | 结束时间     |
    | page       | query | Integer | 否   | ≥1，默认1                        | 1                     | 页码         |
    | size       | query | Integer | 否   | 1-100，默认20                    | 20                    | 每页大小     |

    表 7.4.2.1.4-2 P-AUD-03请求契约表

+   **响应契约表**

    | 参数名                    | 类型   | 必有 | 示例值                | 业务含义       |
    | ------------------------- | ------ | ---- | --------------------- | -------------- |
    | code                      | Number | 是   | 200                   | 响应码         |
    | message                   | String | 是   | "success"             | 响应消息       |
    | data.list[]               | Array  | 是   | [...]                 | 日志列表       |
    | data.list[].id            | Long   | 是   | 10001                 | 日志ID         |
    | data.list[].userId        | Long   | 是   | 10001                 | 操作人ID       |
    | data.list[].username      | String | 是   | "admin"               | 操作人用户名   |
    | data.list[].module        | String | 是   | "USER"                | 模块           |
    | data.list[].moduleText    | String | 是   | "用户管理"            | 模块文本       |
    | data.list[].operation     | String | 是   | "CREATE"              | 操作           |
    | data.list[].operationText | String | 是   | "创建"                | 操作文本       |
    | data.list[].targetType    | String | 是   | "User"                | 目标类型       |
    | data.list[].targetId      | Long   | 是   | 10002                 | 目标ID         |
    | data.list[].targetName    | String | 否   | "张三"                | 目标名称       |
    | data.list[].logLevel      | String | 是   | "IMPORTANT"           | 日志级别       |
    | data.list[].logLevelText  | String | 是   | "重要"                | 日志级别文本   |
    | data.list[].result        | String | 是   | "SUCCESS"             | 操作结果       |
    | data.list[].resultText    | String | 是   | "成功"                | 结果文本       |
    | data.list[].clientIp      | String | 是   | "192.168.1.100"       | 客户端IP       |
    | data.list[].durationMs    | Number | 是   | 125                   | 执行耗时(毫秒) |
    | data.list[].createdAt     | String | 是   | "2026-01-25T10:30:00" | 操作时间       |
    | data.total                | Number | 是   | 500                   | 总记录数       |
    | data.page                 | Number | 是   | 1                     | 当前页码       |
    | data.size                 | Number | 是   | 20                    | 每页大小       |
    | data.pages                | Number | 是   | 25                    | 总页数         |

    表 7.4.2.1.4-3 P-AUD-03响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10001,
                "username": "admin",
                "module": "USER",
                "moduleText": "用户管理",
                "operation": "CREATE",
                "operationText": "创建",
                "targetType": "User",
                "targetId": 10002,
                "targetName": "张三",
                "logLevel": "IMPORTANT",
                "logLevelText": "重要",
                "result": "SUCCESS",
                "resultText": "成功",
                "clientIp": "192.168.1.100",
                "durationMs": 125,
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 500,
            "page": 1,
            "size": 20,
            "pages": 25
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   日志保留期限为180天
    -   requestData字段含敏感信息脱敏处理，详见7.2.4.4
    -   时间范围查询默认最近7天，最大范围90天

##### 7.4.2.1.5 P-AUD-04 获取操作日志详情

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | P-AUD-04                                     |
    | 接口路径   | GET /api/v1/up/iam/audit/operation-logs/{id} |
    | 功能简述   | 根据ID获取操作日志详细信息                   |
    | 所需权限   | provider:iam:audit:read                      |
    | 关联功能   | F-AUD-02 操作日志查询                        |
    | 关联用例   | UC-AUD-04 管理员查看操作日志详情             |
    | 关联领域   | OperationLogQueryService.getDetail()         |
    | 关联规则   | 无                                           |
    | 幂等性     | 是                                           |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404010       |

    表 7.4.2.1.5-1 P-AUD-04契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 10001  | 日志ID   |

    表 7.4.2.1.5-2 P-AUD-04请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                                               | 业务含义         |
    | ------------------ | ------ | ---- | ---------------------------------------------------- | ---------------- |
    | code               | Number | 是   | 200                                                  | 响应码           |
    | message            | String | 是   | "success"                                            | 响应消息         |
    | data.id            | Long   | 是   | 10001                                                | 日志ID           |
    | data.userId        | Long   | 是   | 10001                                                | 操作人ID         |
    | data.username      | String | 是   | "admin"                                              | 操作人用户名     |
    | data.userPool      | String | 是   | "PROVIDER"                                           | 用户群           |
    | data.module        | String | 是   | "USER"                                               | 模块             |
    | data.moduleText    | String | 是   | "用户管理"                                           | 模块文本         |
    | data.operation     | String | 是   | "CREATE"                                             | 操作             |
    | data.operationText | String | 是   | "创建"                                               | 操作文本         |
    | data.targetType    | String | 是   | "User"                                               | 目标类型         |
    | data.targetId      | Long   | 是   | 10002                                                | 目标ID           |
    | data.targetName    | String | 否   | "张三"                                               | 目标名称         |
    | data.logLevel      | String | 是   | "IMPORTANT"                                          | 日志级别         |
    | data.logLevelText  | String | 是   | "重要"                                               | 日志级别文本     |
    | data.requestData   | String | 否   | "{\"username\":\"zhangsan\",\"email\":\"z****@..\"}" | 请求参数(脱敏后) |
    | data.result        | String | 是   | "SUCCESS"                                            | 操作结果         |
    | data.resultText    | String | 是   | "成功"                                               | 结果文本         |
    | data.errorMsg      | String | 否   | null                                                 | 错误信息         |
    | data.clientIp      | String | 是   | "192.168.1.100"                                      | 客户端IP         |
    | data.userAgent     | String | 是   | "Mozilla/5.0..."                                     | 浏览器UA         |
    | data.durationMs    | Number | 是   | 125                                                  | 执行耗时(毫秒)   |
    | data.createdAt     | String | 是   | "2026-01-25T10:30:00"                                | 操作时间         |

    表 7.4.2.1.5-3 P-AUD-04响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10001,
            "username": "admin",
            "userPool": "PROVIDER",
            "module": "USER",
            "moduleText": "用户管理",
            "operation": "CREATE",
            "operationText": "创建",
            "targetType": "User",
            "targetId": 10002,
            "targetName": "张三",
            "logLevel": "IMPORTANT",
            "logLevelText": "重要",
            "requestData": "{\"username\":\"zhangsan\",\"email\":\"zhang****@example.com\"}",
            "result": "SUCCESS",
            "resultText": "成功",
            "errorMsg": null,
            "clientIp": "192.168.1.100",
            "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
            "durationMs": 125,
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（日志不存在）

        ```json
        {
          "code": 404010,
          "message": "操作日志不存在",
          "data": {
            "logId": 99999
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.1.6 P-AUD-05 查询安全事件

+   **契约概述表**

    | 属性       | 值                                                           |
    | ---------- | ------------------------------------------------------------ |
    | API编号    | P-AUD-05                                                     |
    | 接口路径   | GET /api/v1/up/iam/audit/security-events                     |
    | 功能简述   | 分页查询运营用户群的安全事件，支持多条件筛选                 |
    | 所需权限   | provider:iam:audit:read                                      |
    | 关联功能   | F-AUD-03 安全事件查询                                        |
    | 关联用例   | UC-AUD-05 管理员查询安全事件                                 |
    | 关联领域   | SecurityEventQueryService.list()                             |
    | 关联规则   | AUD-R-02（安全事件保留期限365天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                           |
    | 关联错误码 | E-400001, E-401001, E-403001                                 |

    表 7.4.2.1.6-1 P-AUD-05契约概述表

+   **请求契约表**

    | 参数名    | 位置  | 类型    | 必填 | 约束                                         | 示例值                | 业务含义 |
    | --------- | ----- | ------- | ---- | -------------------------------------------- | --------------------- | -------- |
    | username  | query | String  | 否   | 模糊匹配                                     | "admin"               | 用户名   |
    | userId    | query | Long    | 否   | 正整数                                       | 10001                 | 用户ID   |
    | eventType | query | String  | 否   | 枚举：PASSWORD_CHANGED/ROLE_CHANGED/LOCKED等 | "PASSWORD_CHANGED"    | 事件类型 |
    | severity  | query | String  | 否   | 枚举：INFO/WARN/HIGH/CRITICAL                | "HIGH"                | 严重级别 |
    | startTime | query | String  | 否   | ISO8601格式                                  | "2026-01-25T00:00:00" | 开始时间 |
    | endTime   | query | String  | 否   | ISO8601格式                                  | "2026-01-26T23:59:59" | 结束时间 |
    | page      | query | Integer | 否   | ≥1，默认1                                    | 1                     | 页码     |
    | size      | query | Integer | 否   | 1-100，默认20                                | 20                    | 每页大小 |

    表 7.4.2.1.6-2 P-AUD-05请求契约表

+   **响应契约表**

    | 参数名                    | 类型   | 必有 | 示例值                | 业务含义     |
    | ------------------------- | ------ | ---- | --------------------- | ------------ |
    | code                      | Number | 是   | 200                   | 响应码       |
    | message                   | String | 是   | "success"             | 响应消息     |
    | data.list[]               | Array  | 是   | [...]                 | 事件列表     |
    | data.list[].id            | Long   | 是   | 10001                 | 事件ID       |
    | data.list[].userId        | Long   | 是   | 10001                 | 用户ID       |
    | data.list[].username      | String | 是   | "admin"               | 用户名       |
    | data.list[].eventType     | String | 是   | "PASSWORD_CHANGED"    | 事件类型     |
    | data.list[].eventTypeText | String | 是   | "密码变更"            | 事件类型文本 |
    | data.list[].eventDesc     | String | 是   | "用户修改了登录密码"  | 事件描述     |
    | data.list[].severity      | String | 是   | "HIGH"                | 严重级别     |
    | data.list[].severityText  | String | 是   | "高"                  | 严重级别文本 |
    | data.list[].clientIp      | String | 是   | "192.168.1.100"       | 客户端IP     |
    | data.list[].operatorId    | Long   | 否   | 10003                 | 操作人ID     |
    | data.list[].operatorName  | String | 否   | "管理员"              | 操作人用户名 |
    | data.list[].createdAt     | String | 是   | "2026-01-25T10:30:00" | 事件时间     |
    | data.total                | Number | 是   | 200                   | 总记录数     |
    | data.page                 | Number | 是   | 1                     | 当前页码     |
    | data.size                 | Number | 是   | 20                    | 每页大小     |
    | data.pages                | Number | 是   | 10                    | 总页数       |

    表 7.4.2.1.6-3 P-AUD-05响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10001,
                "username": "admin",
                "eventType": "PASSWORD_CHANGED",
                "eventTypeText": "密码变更",
                "eventDesc": "用户修改了登录密码",
                "severity": "HIGH",
                "severityText": "高",
                "clientIp": "192.168.1.100",
                "operatorId": null,
                "operatorName": null,
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 200,
            "page": 1,
            "size": 20,
            "pages": 10
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   安全事件保留期限为365天
    -   operatorId/operatorName仅在他人代操作时有值（如管理员重置密码），用户自操作时为null

##### 7.4.2.1.7 P-AUD-06 获取安全事件详情

+   **契约概述表**

    | 属性       | 值                                            |
    | ---------- | --------------------------------------------- |
    | API编号    | P-AUD-06                                      |
    | 接口路径   | GET /api/v1/up/iam/audit/security-events/{id} |
    | 功能简述   | 根据ID获取安全事件详细信息                    |
    | 所需权限   | provider:iam:audit:read                       |
    | 关联功能   | F-AUD-03 安全事件查询                         |
    | 关联用例   | UC-AUD-06 管理员查看安全事件详情              |
    | 关联领域   | SecurityEventQueryService.getDetail()         |
    | 关联规则   | 无                                            |
    | 幂等性     | 是                                            |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404011        |

    表 7.4.2.1.7-1 P-AUD-06契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义 |
    | ------ | ---- | ---- | ---- | ------ | ------ | -------- |
    | id     | path | Long | 是   | BIGINT | 10001  | 事件ID   |

    表 7.4.2.1.7-2 P-AUD-06请求契约表

+   **响应契约表**

    | 参数名             | 类型   | 必有 | 示例值                | 业务含义     |
    | ------------------ | ------ | ---- | --------------------- | ------------ |
    | code               | Number | 是   | 200                   | 响应码       |
    | message            | String | 是   | "success"             | 响应消息     |
    | data.id            | Long   | 是   | 10001                 | 事件ID       |
    | data.userId        | Long   | 是   | 10001                 | 用户ID       |
    | data.username      | String | 是   | "admin"               | 用户名       |
    | data.userPool      | String | 是   | "PROVIDER"            | 用户群       |
    | data.eventType     | String | 是   | "PASSWORD_CHANGED"    | 事件类型     |
    | data.eventTypeText | String | 是   | "密码变更"            | 事件类型文本 |
    | data.eventDesc     | String | 是   | "用户修改了登录密码"  | 事件描述     |
    | data.eventData     | Object | 否   | {...}                 | 事件附加数据 |
    | data.severity      | String | 是   | "HIGH"                | 严重级别     |
    | data.severityText  | String | 是   | "高"                  | 严重级别文本 |
    | data.clientIp      | String | 是   | "192.168.1.100"       | 客户端IP     |
    | data.operatorId    | Long   | 否   | null                  | 操作人ID     |
    | data.operatorName  | String | 否   | null                  | 操作人用户名 |
    | data.createdAt     | String | 是   | "2026-01-25T10:30:00" | 事件时间     |

    表 7.4.2.1.7-3 P-AUD-06响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10001,
            "username": "admin",
            "userPool": "PROVIDER",
            "eventType": "PASSWORD_CHANGED",
            "eventTypeText": "密码变更",
            "eventDesc": "用户修改了登录密码",
            "eventData": {
              "changedFields": ["password"],
              "sourceIp": "192.168.1.100"
            },
            "severity": "HIGH",
            "severityText": "高",
            "clientIp": "192.168.1.100",
            "operatorId": null,
            "operatorName": null,
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（事件不存在）

        ```json
        {
          "code": 404011,
          "message": "安全事件不存在",
          "data": {
            "eventId": 99999
          },
          "timestamp": 1737885600000
        }
        ```

#### 7.4.2.2 租户审计接口（UR-AUD）

+   租户审计接口用于查询租户级审计日志，通过X-Tenant-Code头部确定租户，数据范围自动限定为当前租户。

##### 7.4.2.2.1 接口清单

+   接口清单如下表：

    | API编号   | API名称          | 方法 | 路径                                      | 权限              | 领域方法                              | 备注     |
    | --------- | ---------------- | ---- | ----------------------------------------- | ----------------- | ------------------------------------- | -------- |
    | UR-AUD-01 | 查询登录日志     | GET  | /api/v1/ur/iam/audit/login-logs           | ur:iam:audit:read | LoginLogQueryService.list()           | 支持分页 |
    | UR-AUD-02 | 获取登录日志详情 | GET  | /api/v1/ur/iam/audit/login-logs/{id}      | ur:iam:audit:read | LoginLogQueryService.getDetail()      | -        |
    | UR-AUD-03 | 查询操作日志     | GET  | /api/v1/ur/iam/audit/operation-logs       | ur:iam:audit:read | OperationLogQueryService.list()       | 支持分页 |
    | UR-AUD-04 | 获取操作日志详情 | GET  | /api/v1/ur/iam/audit/operation-logs/{id}  | ur:iam:audit:read | OperationLogQueryService.getDetail()  | -        |
    | UR-AUD-05 | 查询安全事件     | GET  | /api/v1/ur/iam/audit/security-events      | ur:iam:audit:read | SecurityEventQueryService.list()      | 支持分页 |
    | UR-AUD-06 | 获取安全事件详情 | GET  | /api/v1/ur/iam/audit/security-events/{id} | ur:iam:audit:read | SecurityEventQueryService.getDetail() | -        |

    表 7.4.2.2.1-1 租户审计REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第7.3节领域模型设计中的查询服务方法
    -   备注：简要说明接口的特殊情况或限制条件

+   **与运营方接口的差异说明**
    -   路径前缀由`/up/`变为`/ur/`，数据源路由至租户库
    -   权限标识由`provider:iam:audit:read`变为`ur:iam:audit:read`
    -   数据范围自动限定为当前租户（tenantCode从Token中解析，无需显式传递）
    -   请求参数和响应结构与运营方接口保持一致，确保前后端复用

##### 7.4.2.2.2 UR-AUD-01 查询登录日志

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | UR-AUD-01                                                |
    | 接口路径   | GET /api/v1/ur/iam/audit/login-logs                      |
    | 功能简述   | 分页查询租户用户的登录日志，支持多条件筛选               |
    | 所需权限   | ur:iam:audit:read                                        |
    | 关联功能   | F-AUD-07 租户登录日志查询                                |
    | 关联用例   | UC-AUD-07 租户管理员查询登录日志                         |
    | 关联领域   | LoginLogQueryService.list()                              |
    | 关联规则   | AUD-R-01（日志保留期限180天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                       |
    | 关联错误码 | E-400001, E-401001, E-403001                             |

    表 7.4.2.2.2-1 UR-AUD-01契约概述表

+   **请求契约表**

    | 参数名      | 位置  | 类型    | 必填 | 约束                              | 示例值                | 业务含义 |
    | ----------- | ----- | ------- | ---- | --------------------------------- | --------------------- | -------- |
    | username    | query | String  | 否   | 模糊匹配                          | "zhang"               | 用户名   |
    | userId      | query | Long    | 否   | 正整数                            | 10001                 | 用户ID   |
    | loginResult | query | String  | 否   | 枚举：SUCCESS/FAILED/LOCKED       | "SUCCESS"             | 登录结果 |
    | loginType   | query | String  | 否   | 枚举：PASSWORD/SMS_CODE/SSO/OAUTH | "PASSWORD"            | 登录方式 |
    | clientIp    | query | String  | 否   | IP格式                            | "192.168.1.100"       | 客户端IP |
    | startTime   | query | String  | 否   | ISO8601格式                       | "2026-01-25T00:00:00" | 开始时间 |
    | endTime     | query | String  | 否   | ISO8601格式                       | "2026-01-26T23:59:59" | 结束时间 |
    | page        | query | Integer | 否   | ≥1，默认1                         | 1                     | 页码     |
    | size        | query | Integer | 否   | 1-100，默认20                     | 20                    | 每页大小 |

    表 7.4.2.2.2-2 UR-AUD-01请求契约表

+   **响应契约表**

    同P-AUD-01响应契约表（表 7.4.2.1.2-3），字段结构完全一致，仅数据范围限定为当前租户。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10001,
                "username": "zhangsan",
                "loginType": "PASSWORD",
                "loginTypeText": "密码登录",
                "loginResult": "SUCCESS",
                "loginResultText": "登录成功",
                "failReason": null,
                "clientIp": "192.168.1.100",
                "location": "北京市",
                "deviceType": "PC",
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 1000,
            "page": 1,
            "size": 20,
            "pages": 50
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.2.3 UR-AUD-02 获取登录日志详情

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | UR-AUD-02                                |
    | 接口路径   | GET /api/v1/ur/iam/audit/login-logs/{id} |
    | 功能简述   | 获取租户用户登录日志详细信息             |
    | 所需权限   | ur:iam:audit:read                        |
    | 关联功能   | F-AUD-07 租户登录日志查询                |
    | 关联用例   | UC-AUD-08 租户管理员查看登录日志详情     |
    | 关联领域   | LoginLogQueryService.getDetail()         |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404009   |

    表 7.4.2.2.3-1 UR-AUD-02契约概述表

+   **请求契约表**

    同P-AUD-02请求契约表（表 7.4.2.1.3-2）。

+   **响应契约表**

    同P-AUD-02响应契约表（表 7.4.2.1.3-3），字段结构完全一致，userPool字段值为"TENANT"。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10001,
            "username": "zhangsan",
            "userPool": "TENANT",
            "loginType": "PASSWORD",
            "loginTypeText": "密码登录",
            "loginResult": "SUCCESS",
            "loginResultText": "登录成功",
            "failReason": null,
            "clientIp": "192.168.1.100",
            "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0",
            "deviceType": "PC",
            "location": "北京市海淀区",
            "sessionId": "sess-cc0e8400-e29b-41d4-a716-446655440001",
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.2.4 UR-AUD-03 查询操作日志

+   **契约概述表**

    | 属性       | 值                                                       |
    | ---------- | -------------------------------------------------------- |
    | API编号    | UR-AUD-03                                                |
    | 接口路径   | GET /api/v1/ur/iam/audit/operation-logs                  |
    | 功能简述   | 分页查询租户用户的操作日志，支持多条件筛选               |
    | 所需权限   | ur:iam:audit:read                                        |
    | 关联功能   | F-AUD-08 租户操作日志查询                                |
    | 关联用例   | UC-AUD-09 租户管理员查询操作日志                         |
    | 关联领域   | OperationLogQueryService.list()                          |
    | 关联规则   | AUD-R-01（日志保留期限180天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                       |
    | 关联错误码 | E-400001, E-401001, E-403001                             |

    表 7.4.2.2.4-1 UR-AUD-03契约概述表

+   **请求契约表**

    同P-AUD-03请求契约表（表 7.4.2.1.4-2），字段结构完全一致。

+   **响应契约表**

    同P-AUD-03响应契约表（表 7.4.2.1.4-3），字段结构完全一致，仅数据范围限定为当前租户。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10003,
                "username": "zhangsan",
                "module": "USER",
                "moduleText": "用户管理",
                "operation": "CREATE",
                "operationText": "创建",
                "targetType": "User",
                "targetId": 10002,
                "targetName": "李四",
                "logLevel": "IMPORTANT",
                "logLevelText": "重要",
                "result": "SUCCESS",
                "resultText": "成功",
                "clientIp": "192.168.1.100",
                "durationMs": 125,
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 500,
            "page": 1,
            "size": 20,
            "pages": 25
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.2.5 UR-AUD-04 获取操作日志详情

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | UR-AUD-04                                    |
    | 接口路径   | GET /api/v1/ur/iam/audit/operation-logs/{id} |
    | 功能简述   | 获取租户用户操作日志详细信息                 |
    | 所需权限   | ur:iam:audit:read                            |
    | 关联功能   | F-AUD-08 租户操作日志查询                    |
    | 关联用例   | UC-AUD-10 租户管理员查看操作日志详情         |
    | 关联领域   | OperationLogQueryService.getDetail()         |
    | 关联规则   | 无                                           |
    | 幂等性     | 是                                           |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404010       |

    表 7.4.2.2.5-1 UR-AUD-04契约概述表

+   **请求契约表**

    同P-AUD-04请求契约表（表 7.4.2.1.5-2）。

+   **响应契约表**

    同P-AUD-04响应契约表（表 7.4.2.1.5-3），字段结构完全一致，userPool字段值为"TENANT"。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10003,
            "username": "zhangsan",
            "userPool": "TENANT",
            "module": "USER",
            "moduleText": "用户管理",
            "operation": "CREATE",
            "operationText": "创建",
            "targetType": "User",
            "targetId": 10002,
            "targetName": "李四",
            "logLevel": "IMPORTANT",
            "logLevelText": "重要",
            "requestData": "{\"username\":\"lisi\",\"email\":\"li****@tenant.com\"}",
            "result": "SUCCESS",
            "resultText": "成功",
            "errorMsg": null,
            "clientIp": "192.168.1.100",
            "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
            "durationMs": 125,
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.2.6 UR-AUD-05 查询安全事件

+   **契约概述表**

    | 属性       | 值                                                           |
    | ---------- | ------------------------------------------------------------ |
    | API编号    | UR-AUD-05                                                    |
    | 接口路径   | GET /api/v1/ur/iam/audit/security-events                     |
    | 功能简述   | 分页查询租户用户的安全事件，支持多条件筛选                   |
    | 所需权限   | ur:iam:audit:read                                            |
    | 关联功能   | F-AUD-09 租户安全事件查询                                    |
    | 关联用例   | UC-AUD-11 租户管理员查询安全事件                             |
    | 关联领域   | SecurityEventQueryService.list()                             |
    | 关联规则   | AUD-R-02（安全事件保留期限365天）, AUD-R-04（查询范围≤90天） |
    | 幂等性     | 是                                                           |
    | 关联错误码 | E-400001, E-401001, E-403001                                 |

    表 7.4.2.2.6-1 UR-AUD-05契约概述表

+   **请求契约表**

    同P-AUD-05请求契约表（表 7.4.2.1.6-2），字段结构完全一致。

+   **响应契约表**

    同P-AUD-05响应契约表（表 7.4.2.1.6-3），字段结构完全一致，仅数据范围限定为当前租户。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "userId": 10001,
                "username": "zhangsan",
                "eventType": "PASSWORD_CHANGED",
                "eventTypeText": "密码变更",
                "eventDesc": "用户修改了登录密码",
                "severity": "HIGH",
                "severityText": "高",
                "clientIp": "192.168.1.100",
                "operatorId": null,
                "operatorName": null,
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 200,
            "page": 1,
            "size": 20,
            "pages": 10
          },
          "timestamp": 1737885600000
        }
        ```

##### 7.4.2.2.7 UR-AUD-06 获取安全事件详情

+   **契约概述表**

    | 属性       | 值                                            |
    | ---------- | --------------------------------------------- |
    | API编号    | UR-AUD-06                                     |
    | 接口路径   | GET /api/v1/ur/iam/audit/security-events/{id} |
    | 功能简述   | 获取租户用户安全事件详细信息                  |
    | 所需权限   | ur:iam:audit:read                             |
    | 关联功能   | F-AUD-09 租户安全事件查询                     |
    | 关联用例   | UC-AUD-12 租户管理员查看安全事件详情          |
    | 关联领域   | SecurityEventQueryService.getDetail()         |
    | 关联规则   | 无                                            |
    | 幂等性     | 是                                            |
    | 关联错误码 | E-400001, E-401001, E-403001, E-404011        |

    表 7.4.2.2.7-1 UR-AUD-06契约概述表

+   **请求契约表**

    同P-AUD-06请求契约表（表 7.4.2.1.7-2）。

+   **响应契约表**

    同P-AUD-06响应契约表（表 7.4.2.1.7-3），字段结构完全一致，userPool字段值为"TENANT"。

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "id": 10001,
            "userId": 10001,
            "username": "zhangsan",
            "userPool": "TENANT",
            "eventType": "PASSWORD_CHANGED",
            "eventTypeText": "密码变更",
            "eventDesc": "用户修改了登录密码",
            "eventData": {
              "changedFields": ["password"],
              "sourceIp": "192.168.1.100"
            },
            "severity": "HIGH",
            "severityText": "高",
            "clientIp": "192.168.1.100",
            "operatorId": null,
            "operatorName": null,
            "createdAt": "2026-01-25T10:30:00"
          },
          "timestamp": 1737885600000
        }
        ```

#### 7.4.2.3 C端用户审计接口（UC-AUD）

+   C端用户只能查询自己的审计日志，不能查询他人数据。用户ID从Token中解析。

##### 7.4.2.3.1 接口清单

+   接口清单如下表：

    | API编号   | API名称          | 方法 | 路径                                    | 权限          | 领域方法                                 | 备注     |
    | --------- | ---------------- | ---- | --------------------------------------- | ------------- | ---------------------------------------- | -------- |
    | UC-AUD-01 | 查询我的登录记录 | GET  | /api/v1/uc/iam/audit/my/login-logs      | authenticated | LoginLogQueryService.listMyLogs()        | 支持分页 |
    | UC-AUD-02 | 查询我的安全事件 | GET  | /api/v1/uc/iam/audit/my/security-events | authenticated | SecurityEventQueryService.listMyEvents() | 支持分页 |

    表 7.4.2.3.1-1 C端用户审计REST API清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   API名称：接口的业务名称
    -   领域方法：关联到第7.3节领域模型设计中的查询服务方法
    -   备注：C端不提供操作日志查询（操作日志面向管理员），仅提供登录记录和安全事件

##### 7.4.2.3.2 UC-AUD-01 查询我的登录记录

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | UC-AUD-01                              |
    | 接口路径   | GET /api/v1/uc/iam/audit/my/login-logs |
    | 功能简述   | 个人用户查询自己的登录记录             |
    | 所需权限   | authenticated                          |
    | 关联功能   | F-AUD-04 个人登录记录查询              |
    | 关联用例   | UC-AUD-13 用户查看个人登录记录         |
    | 关联领域   | LoginLogQueryService.listMyLogs()      |
    | 关联规则   | AUD-R-03（个人日志保留期限90天）       |
    | 幂等性     | 是                                     |
    | 关联错误码 | E-400001, E-401001                     |

    表 7.4.2.3.2-1 UC-AUD-01契约概述表

+   **请求契约表**

    | 参数名    | 位置  | 类型    | 必填 | 约束         | 示例值                | 业务含义 |
    | --------- | ----- | ------- | ---- | ------------ | --------------------- | -------- |
    | startTime | query | String  | 否   | ISO8601格式  | "2026-01-01T00:00:00" | 开始时间 |
    | endTime   | query | String  | 否   | ISO8601格式  | "2026-01-26T23:59:59" | 结束时间 |
    | page      | query | Integer | 否   | ≥1，默认1    | 1                     | 页码     |
    | size      | query | Integer | 否   | 1-50，默认10 | 10                    | 每页大小 |

    表 7.4.2.3.2-2 UC-AUD-01请求契约表

+   **响应契约表**

    | 参数名                      | 类型   | 必有 | 示例值                | 业务含义     |
    | --------------------------- | ------ | ---- | --------------------- | ------------ |
    | code                        | Number | 是   | 200                   | 响应码       |
    | message                     | String | 是   | "success"             | 响应消息     |
    | data.list[]                 | Array  | 是   | [...]                 | 日志列表     |
    | data.list[].id              | Long   | 是   | 10001                 | 日志ID       |
    | data.list[].loginType       | String | 是   | "SMS_CODE"            | 登录方式     |
    | data.list[].loginTypeText   | String | 是   | "短信验证码"          | 登录方式文本 |
    | data.list[].loginResult     | String | 是   | "SUCCESS"             | 登录结果     |
    | data.list[].loginResultText | String | 是   | "登录成功"            | 登录结果文本 |
    | data.list[].clientIp        | String | 是   | "203.0.113.45"        | 客户端IP     |
    | data.list[].location        | String | 否   | "上海市"              | IP归属地     |
    | data.list[].deviceType      | String | 是   | "MOBILE"              | 设备类型     |
    | data.list[].createdAt       | String | 是   | "2026-01-25T10:30:00" | 登录时间     |
    | data.total                  | Number | 是   | 50                    | 总记录数     |
    | data.page                   | Number | 是   | 1                     | 当前页码     |
    | data.size                   | Number | 是   | 10                    | 每页大小     |
    | data.pages                  | Number | 是   | 5                     | 总页数       |

    表 7.4.2.3.2-3 UC-AUD-01响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "loginType": "SMS_CODE",
                "loginTypeText": "短信验证码",
                "loginResult": "SUCCESS",
                "loginResultText": "登录成功",
                "clientIp": "203.0.113.45",
                "location": "上海市",
                "deviceType": "MOBILE",
                "createdAt": "2026-01-25T10:30:00"
              }
            ],
            "total": 50,
            "page": 1,
            "size": 10,
            "pages": 5
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   个人日志保留期限90天
    -   不返回userId/username（查询者即本人，无需冗余展示）
    -   每页大小上限50条（低于管理端的100条）

##### 7.4.2.3.3 UC-AUD-02 查询我的安全事件

+   **契约概述表**

    | 属性       | 值                                          |
    | ---------- | ------------------------------------------- |
    | API编号    | UC-AUD-02                                   |
    | 接口路径   | GET /api/v1/uc/iam/audit/my/security-events |
    | 功能简述   | 个人用户查询与自己相关的安全事件            |
    | 所需权限   | authenticated                               |
    | 关联功能   | F-AUD-05 个人安全事件查询                   |
    | 关联用例   | UC-AUD-14 用户查看个人安全事件              |
    | 关联领域   | SecurityEventQueryService.listMyEvents()    |
    | 关联规则   | AUD-R-03（个人日志保留期限90天）            |
    | 幂等性     | 是                                          |
    | 关联错误码 | E-400001, E-401001                          |

    表 7.4.2.3.3-1 UC-AUD-02契约概述表

+   **请求契约表**

    | 参数名    | 位置  | 类型    | 必填 | 约束         | 示例值                | 业务含义 |
    | --------- | ----- | ------- | ---- | ------------ | --------------------- | -------- |
    | startTime | query | String  | 否   | ISO8601格式  | "2026-01-01T00:00:00" | 开始时间 |
    | endTime   | query | String  | 否   | ISO8601格式  | "2026-01-26T23:59:59" | 结束时间 |
    | page      | query | Integer | 否   | ≥1，默认1    | 1                     | 页码     |
    | size      | query | Integer | 否   | 1-50，默认10 | 10                    | 每页大小 |

    表 7.4.2.3.3-2 UC-AUD-02请求契约表

+   **响应契约表**

    | 参数名                    | 类型   | 必有 | 示例值                | 业务含义     |
    | ------------------------- | ------ | ---- | --------------------- | ------------ |
    | code                      | Number | 是   | 200                   | 响应码       |
    | message                   | String | 是   | "success"             | 响应消息     |
    | data.list[]               | Array  | 是   | [...]                 | 事件列表     |
    | data.list[].id            | Long   | 是   | 10001                 | 事件ID       |
    | data.list[].eventType     | String | 是   | "PASSWORD_CHANGED"    | 事件类型     |
    | data.list[].eventTypeText | String | 是   | "密码变更"            | 事件类型文本 |
    | data.list[].eventDesc     | String | 是   | "您修改了登录密码"    | 事件描述     |
    | data.list[].severity      | String | 是   | "HIGH"                | 严重级别     |
    | data.list[].severityText  | String | 是   | "高"                  | 严重级别文本 |
    | data.list[].clientIp      | String | 是   | "203.0.113.45"        | 客户端IP     |
    | data.list[].createdAt     | String | 是   | "2026-01-25T10:30:00" | 事件时间     |
    | data.total                | Number | 是   | 20                    | 总记录数     |
    | data.page                 | Number | 是   | 1                     | 当前页码     |
    | data.size                 | Number | 是   | 10                    | 每页大小     |
    | data.pages                | Number | 是   | 2                     | 总页数       |

    表 7.4.2.3.3-3 UC-AUD-02响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 200,
          "message": "success",
          "data": {
            "list": [
              {
                "id": 10001,
                "eventType": "PASSWORD_CHANGED",
                "eventTypeText": "密码变更",
                "eventDesc": "您修改了登录密码",
                "severity": "HIGH",
                "severityText": "高",
                "clientIp": "203.0.113.45",
                "createdAt": "2026-01-25T10:30:00"
              },
              {
                "id": 10002,
                "eventType": "DEVICE_ADDED",
                "eventTypeText": "新设备登录",
                "eventDesc": "您在新设备上登录了账号",
                "severity": "WARN",
                "severityText": "中",
                "clientIp": "203.0.113.50",
                "createdAt": "2026-01-24T15:20:00"
              }
            ],
            "total": 20,
            "page": 1,
            "size": 10,
            "pages": 2
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   不返回userId/username和operatorId/operatorName（查询者即本人）
    -   eventDesc使用第二人称描述（"您修改了…"而非"用户修改了…"）
    -   每页大小上限50条

### 7.4.3 追溯关联表

#### 7.4.3.1 API-功能-用例关联表

+   全部REST API的功能-用例追溯关系如下表所示。

    | API编号   | API名称          | 关联功能编号 | 关联功能名称     | 关联用例编号 | 关联用例名称               |
    | --------- | ---------------- | ------------ | ---------------- | ------------ | -------------------------- |
    | P-AUD-01  | 查询登录日志     | F-AUD-01     | 登录日志查询     | UC-AUD-01    | 管理员查询登录日志         |
    | P-AUD-02  | 获取登录日志详情 | F-AUD-01     | 登录日志查询     | UC-AUD-02    | 管理员查看登录日志详情     |
    | P-AUD-03  | 查询操作日志     | F-AUD-02     | 操作日志查询     | UC-AUD-03    | 管理员查询操作日志         |
    | P-AUD-04  | 获取操作日志详情 | F-AUD-02     | 操作日志查询     | UC-AUD-04    | 管理员查看操作日志详情     |
    | P-AUD-05  | 查询安全事件     | F-AUD-03     | 安全事件查询     | UC-AUD-05    | 管理员查询安全事件         |
    | P-AUD-06  | 获取安全事件详情 | F-AUD-03     | 安全事件查询     | UC-AUD-06    | 管理员查看安全事件详情     |
    | UR-AUD-01 | 查询登录日志     | F-AUD-07     | 租户登录日志查询 | UC-AUD-07    | 租户管理员查询登录日志     |
    | UR-AUD-02 | 获取登录日志详情 | F-AUD-07     | 租户登录日志查询 | UC-AUD-08    | 租户管理员查看登录日志详情 |
    | UR-AUD-03 | 查询操作日志     | F-AUD-08     | 租户操作日志查询 | UC-AUD-09    | 租户管理员查询操作日志     |
    | UR-AUD-04 | 获取操作日志详情 | F-AUD-08     | 租户操作日志查询 | UC-AUD-10    | 租户管理员查看操作日志详情 |
    | UR-AUD-05 | 查询安全事件     | F-AUD-09     | 租户安全事件查询 | UC-AUD-11    | 租户管理员查询安全事件     |
    | UR-AUD-06 | 获取安全事件详情 | F-AUD-09     | 租户安全事件查询 | UC-AUD-12    | 租户管理员查看安全事件详情 |
    | UC-AUD-01 | 查询我的登录记录 | F-AUD-04     | 个人登录记录查询 | UC-AUD-13    | 用户查看个人登录记录       |
    | UC-AUD-02 | 查询我的安全事件 | F-AUD-05     | 个人安全事件查询 | UC-AUD-14    | 用户查看个人安全事件       |

    表 7.4.3.1-1 API-功能-用例关联表

#### 7.4.3.2 API-领域-权限关联表

+   全部REST API的领域-权限追溯关系如下表所示。

    | API编号   | API名称          | 关联聚合 | 领域方法                                 | 权限标识                | 权限说明         |
    | --------- | ---------------- | -------- | ---------------------------------------- | ----------------------- | ---------------- |
    | P-AUD-01  | 查询登录日志     | -        | LoginLogQueryService.list()              | provider:iam:audit:read | 查看审计日志权限 |
    | P-AUD-02  | 获取登录日志详情 | -        | LoginLogQueryService.getDetail()         | provider:iam:audit:read | 查看审计日志权限 |
    | P-AUD-03  | 查询操作日志     | -        | OperationLogQueryService.list()          | provider:iam:audit:read | 查看审计日志权限 |
    | P-AUD-04  | 获取操作日志详情 | -        | OperationLogQueryService.getDetail()     | provider:iam:audit:read | 查看审计日志权限 |
    | P-AUD-05  | 查询安全事件     | -        | SecurityEventQueryService.list()         | provider:iam:audit:read | 查看审计日志权限 |
    | P-AUD-06  | 获取安全事件详情 | -        | SecurityEventQueryService.getDetail()    | provider:iam:audit:read | 查看审计日志权限 |
    | UR-AUD-01 | 查询登录日志     | -        | LoginLogQueryService.list()              | ur:iam:audit:read       | 查看审计日志权限 |
    | UR-AUD-02 | 获取登录日志详情 | -        | LoginLogQueryService.getDetail()         | ur:iam:audit:read       | 查看审计日志权限 |
    | UR-AUD-03 | 查询操作日志     | -        | OperationLogQueryService.list()          | ur:iam:audit:read       | 查看审计日志权限 |
    | UR-AUD-04 | 获取操作日志详情 | -        | OperationLogQueryService.getDetail()     | ur:iam:audit:read       | 查看审计日志权限 |
    | UR-AUD-05 | 查询安全事件     | -        | SecurityEventQueryService.list()         | ur:iam:audit:read       | 查看审计日志权限 |
    | UR-AUD-06 | 获取安全事件详情 | -        | SecurityEventQueryService.getDetail()    | ur:iam:audit:read       | 查看审计日志权限 |
    | UC-AUD-01 | 查询我的登录记录 | -        | LoginLogQueryService.listMyLogs()        | authenticated           | 登录即可访问     |
    | UC-AUD-02 | 查询我的安全事件 | -        | SecurityEventQueryService.listMyEvents() | authenticated           | 登录即可访问     |

    表 7.4.3.2-1 API-领域-权限关联表

+   权限标识说明：
    -   `authenticated`：需要登录，但无需特定权限
    -   `{四段式权限}`：需要登录且拥有对应权限，格式见附录D.3
    -   审计管理接口均为只读查询，关联聚合列标记为"-"（无写操作聚合）

#### 7.4.3.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。

    | API编号   | API名称          | 关联页面编号 | 页面名称       | 触发组件 | 触发时机      |
    | --------- | ---------------- | ------------ | -------------- | -------- | ------------- |
    | P-AUD-01  | 查询登录日志     | PG-P-AUD-01  | 登录日志列表页 | 搜索按钮 | 页面加载/搜索 |
    | P-AUD-02  | 获取登录日志详情 | PG-P-AUD-01  | 登录日志列表页 | 详情链接 | 点击查看      |
    | P-AUD-03  | 查询操作日志     | PG-P-AUD-02  | 操作日志列表页 | 搜索按钮 | 页面加载/搜索 |
    | P-AUD-04  | 获取操作日志详情 | PG-P-AUD-02  | 操作日志列表页 | 详情链接 | 点击查看      |
    | P-AUD-05  | 查询安全事件     | PG-P-AUD-03  | 安全事件列表页 | 搜索按钮 | 页面加载/搜索 |
    | P-AUD-06  | 获取安全事件详情 | PG-P-AUD-03  | 安全事件列表页 | 详情链接 | 点击查看      |
    | UR-AUD-01 | 查询登录日志     | PG-UR-AUD-01 | 登录日志列表页 | 搜索按钮 | 页面加载/搜索 |
    | UR-AUD-02 | 获取登录日志详情 | PG-UR-AUD-01 | 登录日志列表页 | 详情链接 | 点击查看      |
    | UR-AUD-03 | 查询操作日志     | PG-UR-AUD-02 | 操作日志列表页 | 搜索按钮 | 页面加载/搜索 |
    | UR-AUD-04 | 获取操作日志详情 | PG-UR-AUD-02 | 操作日志列表页 | 详情链接 | 点击查看      |
    | UR-AUD-05 | 查询安全事件     | PG-UR-AUD-03 | 安全事件列表页 | 搜索按钮 | 页面加载/搜索 |
    | UR-AUD-06 | 获取安全事件详情 | PG-UR-AUD-03 | 安全事件列表页 | 详情链接 | 点击查看      |
    | UC-AUD-01 | 查询我的登录记录 | PG-UC-USR-03 | 账号安全页     | -        | 页面加载      |
    | UC-AUD-02 | 查询我的安全事件 | PG-UC-USR-03 | 账号安全页     | -        | 页面加载      |

    表 7.4.3.3-1 API-页面-组件关联表

+   说明：
    -   关联页面编号对应7.6节前端设计中的页面编号
    -   UC-AUD-01/02嵌入在C端用户的账号安全页中展示

## 7.5 数据模型设计

+   本节设计审计管理子领域的数据模型，包括表结构、索引和分库策略。
+   审计日志按用户群分库存储，与业务数据同库，保证事务一致性。

### 7.5.1 数据模型总览

+   审计管理数据模型按用户群分布如下表所示。

    | 数据库                   | 表名               | 说明               | 数据量预估     |
    | ------------------------ | ------------------ | ------------------ | -------------- |
    | clarisphere_platform     | iam_login_log      | 运营用户群登录日志 | 较小           |
    | clarisphere_platform     | iam_operation_log  | 运营用户群操作日志 | 较小           |
    | clarisphere_platform     | iam_security_event | 运营用户群安全事件 | 较小           |
    | clarisphere_t{tenant_id} | iam_login_log      | 租户登录日志       | 中等（按租户） |
    | clarisphere_t{tenant_id} | iam_operation_log  | 租户操作日志       | 中等（按租户） |
    | clarisphere_t{tenant_id} | iam_security_event | 租户安全事件       | 较小（按租户） |
    | clarisphere_consumer     | iam_login_log      | C端登录日志        | 较大           |
    | clarisphere_consumer     | iam_security_event | C端安全事件        | 中等           |

    表 7.5.1-1 审计管理数据模型总览

+   数据模型ER图如下所示。

    ```
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                        审计管理数据模型ER图                                 │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                      iam_login_log (登录日志表)                     │    │
    │  ├─────────────────────────────────────────────────────────────────────┤    │
    │  │ PK  id               BIGINT AUTO_INCREMENT                          │    │
    │  │     user_id          BIGINT               可空，失败时可能无        │    │
    │  │     username         VARCHAR(64)          登录账号                  │    │
    │  │     user_pool        VARCHAR(16)          用户群                    │    │
    │  │     tenant_code      VARCHAR(32)          租户编码                  │    │
    │  │     login_type       VARCHAR(32)          登录方式                  │    │
    │  │     login_result     VARCHAR(16)          登录结果                  │    │
    │  │     fail_reason      VARCHAR(128)         失败原因                  │    │
    │  │     client_ip        VARCHAR(64)          客户端IP                  │    │
    │  │     user_agent       VARCHAR(512)         浏览器UA                  │    │
    │  │     device_type      VARCHAR(32)          设备类型                  │    │
    │  │     location         VARCHAR(128)         IP归属地                  │    │
    │  │     session_id       VARCHAR(64)          会话ID                    │    │
    │  │     created_at       DATETIME             记录时间                  │    │
    │  │ IDX idx_user_id      (user_id)                                      │    │
    │  │ IDX idx_username     (username)                                     │    │
    │  │ IDX idx_created_at   (created_at)                                   │    │
    │  │ IDX idx_login_result (login_result, created_at)                     │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                    iam_operation_log (操作日志表)                   │    │
    │  ├─────────────────────────────────────────────────────────────────────┤    │
    │  │ PK  id               BIGINT AUTO_INCREMENT                          │    │
    │  │     user_id          BIGINT               操作人ID                  │    │
    │  │     username         VARCHAR(64)          操作人用户名              │    │
    │  │     user_pool        VARCHAR(16)          用户群                    │    │
    │  │     tenant_code      VARCHAR(32)          租户编码                  │    │
    │  │     module           VARCHAR(64)          模块                      │    │
    │  │     operation        VARCHAR(64)          操作                      │    │
    │  │     target_type      VARCHAR(64)          目标类型                  │    │
    │  │     target_id        BIGINT               目标ID                    │    │
    │  │     target_name      VARCHAR(128)         目标名称                  │    │
    │  │     log_level        VARCHAR(16)          日志级别                  │    │
    │  │     request_data     TEXT                 请求参数                  │    │
    │  │     response_code    VARCHAR(16)          响应码                    │    │
    │  │     result           VARCHAR(16)          结果                      │    │
    │  │     error_msg        VARCHAR(256)         错误信息                  │    │
    │  │     client_ip        VARCHAR(64)          客户端IP                  │    │
    │  │     user_agent       VARCHAR(512)         浏览器UA                  │    │
    │  │     duration_ms      INT                  执行耗时                  │    │
    │  │     created_at       DATETIME             操作时间                  │    │
    │  │ IDX idx_user_id      (user_id)                                      │    │
    │  │ IDX idx_target       (target_type, target_id)                       │    │
    │  │ IDX idx_module_op    (module, operation)                            │    │
    │  │ IDX idx_created_at   (created_at)                                   │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    │  ┌─────────────────────────────────────────────────────────────────────┐    │
    │  │                   iam_security_event (安全事件表)                   │    │
    │  ├─────────────────────────────────────────────────────────────────────┤    │
    │  │ PK  id               BIGINT AUTO_INCREMENT                          │    │
    │  │     user_id          BIGINT               用户ID                    │    │
    │  │     username         VARCHAR(64)          用户名                    │    │
    │  │     user_pool        VARCHAR(16)          用户群                    │    │
    │  │     tenant_code      VARCHAR(32)          租户编码                  │    │
    │  │     event_type       VARCHAR(32)          事件类型                  │    │
    │  │     event_desc       VARCHAR(256)         事件描述                  │    │
    │  │     event_data       JSON                 附加数据                  │    │
    │  │     severity         VARCHAR(16)          严重级别                  │    │
    │  │     client_ip        VARCHAR(64)          客户端IP                  │    │
    │  │     operator_id      BIGINT               操作人ID                  │    │
    │  │     created_at       DATETIME             事件时间                  │    │
    │  │ IDX idx_user_id      (user_id)                                      │    │
    │  │ IDX idx_event_type   (event_type, severity)                         │    │
    │  │ IDX idx_created_at   (created_at)                                   │    │
    │  └─────────────────────────────────────────────────────────────────────┘    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.5.1-1 审计管理数据模型ER图

### 7.5.2 iam_login_log 登录日志表

#### 7.5.2.1 表结构

+   登录日志表结构定义：

    | 列名         | 数据类型     | 可空 | 默认值            | 说明                                                                |
    | ------------ | ------------ | ---- | ----------------- | ------------------------------------------------------------------- |
    | id           | BIGINT       | NO   | AUTO_INCREMENT    | 主键                                                                |
    | user_id      | BIGINT       | YES  | NULL              | 用户ID（失败时可能为空）                                            |
    | username     | VARCHAR(64)  | NO   | -                 | 登录账号                                                            |
    | user_pool    | VARCHAR(16)  | NO   | -                 | 用户群：UP/UR/UC                                                    |
    | tenant_code  | VARCHAR(32)  | YES  | NULL              | 租户编码（仅ur用户）                                                |
    | login_type   | VARCHAR(32)  | NO   | -                 | 登录方式                                                            |
    | login_result | VARCHAR(16)  | NO   | -                 | 登录结果：SUCCESS/FAILED/LOGOUT/REFRESH/KICKED/EXPIRED/MFA_VERIFIED |
    | fail_reason  | VARCHAR(128) | YES  | NULL              | 失败原因                                                            |
    | client_ip    | VARCHAR(64)  | NO   | -                 | 客户端IP                                                            |
    | user_agent   | VARCHAR(512) | YES  | NULL              | 浏览器UA                                                            |
    | device_type  | VARCHAR(32)  | YES  | NULL              | 设备类型                                                            |
    | location     | VARCHAR(128) | YES  | NULL              | IP归属地                                                            |
    | session_id   | VARCHAR(64)  | YES  | NULL              | 会话ID                                                              |
    | created_at   | DATETIME     | NO   | CURRENT_TIMESTAMP | 记录时间                                                            |

    表 7.5.2.1-1 iam_login_log表结构

+   字段约束说明：
    -   id：主键，使用BIGINT自增，由数据库自动生成
    -   user_id：登录失败时可能为空（找不到用户的情况）
    -   username：必填，即使登录失败也要记录尝试的账号
    -   login_type：枚举值，见7.3.3.3节
    -   login_result：枚举值（SUCCESS/FAILED/LOGOUT/REFRESH/KICKED/EXPIRED/MFA_VERIFIED），见7.3.3.4节

#### 7.5.2.2 索引设计

+   登录日志表索引设计：

    | 索引名           | 索引类型 | 索引列                   | 说明                   |
    | ---------------- | -------- | ------------------------ | ---------------------- |
    | PRIMARY          | 主键     | id                       | 主键索引               |
    | idx_user_id      | 普通     | user_id                  | 按用户查询             |
    | idx_username     | 普通     | username                 | 按用户名查询           |
    | idx_created_at   | 普通     | created_at               | 时间范围查询、数据清理 |
    | idx_login_result | 普通     | login_result, created_at | 查询失败记录           |
    | idx_client_ip    | 普通     | client_ip                | 按IP查询               |

    表 7.5.2.2-1 iam_login_log索引设计

### 7.5.3 iam_operation_log 操作日志表

#### 7.5.3.1 表结构

+   操作日志表结构定义：

    | 列名          | 数据类型     | 可空 | 默认值            | 说明               |
    | ------------- | ------------ | ---- | ----------------- | ------------------ |
    | id            | BIGINT       | NO   | AUTO_INCREMENT    | 主键               |
    | user_id       | BIGINT       | NO   | -                 | 操作人ID           |
    | username      | VARCHAR(64)  | NO   | -                 | 操作人用户名       |
    | user_pool     | VARCHAR(16)  | NO   | -                 | 用户群：UP/UR      |
    | tenant_code   | VARCHAR(32)  | YES  | NULL              | 租户编码           |
    | module        | VARCHAR(64)  | NO   | -                 | 模块               |
    | operation     | VARCHAR(64)  | NO   | -                 | 操作               |
    | target_type   | VARCHAR(64)  | YES  | NULL              | 目标类型           |
    | target_id     | BIGINT       | YES  | NULL              | 目标ID             |
    | target_name   | VARCHAR(128) | YES  | NULL              | 目标名称           |
    | log_level     | VARCHAR(16)  | NO   | 'NORMAL'          | 日志级别           |
    | request_data  | TEXT         | YES  | NULL              | 请求参数（脱敏后） |
    | response_code | VARCHAR(16)  | YES  | NULL              | 响应码             |
    | result        | VARCHAR(16)  | NO   | -                 | 结果               |
    | error_msg     | VARCHAR(256) | YES  | NULL              | 错误信息           |
    | client_ip     | VARCHAR(64)  | NO   | -                 | 客户端IP           |
    | user_agent    | VARCHAR(512) | YES  | NULL              | 浏览器UA           |
    | duration_ms   | INT          | YES  | NULL              | 执行耗时（毫秒）   |
    | created_at    | DATETIME     | NO   | CURRENT_TIMESTAMP | 操作时间           |

    表 7.5.3.1-1 iam_operation_log表结构

+   字段约束说明：
    -   user_id和username：必填，用于追溯操作人
    -   module：模块枚举值，如USER/ROLE/ORG/POSITION/PERSON/APPOINTMENT/PERMISSION/DATA_ACCESS/ORG_SYNC/CONFIG/TENANT_CONFIG
    -   operation：操作枚举值，如CREATE/UPDATE/DELETE/ENABLE/DISABLE/ACTIVATE/ASSIGN/REVOKE/GRANT/BIND_USER/RESIGN/TRANSFER/SYNC_COMPLETE/CANCEL_REQUEST/OAUTH_BIND/OAUTH_UNBIND/RESET
    -   log_level：日志级别枚举值，见7.3.4.4节
    -   request_data：存储脱敏后的请求参数，JSON格式

#### 7.5.3.2 索引设计

+   操作日志表索引设计：

    | 索引名         | 索引类型 | 索引列                 | 说明                   |
    | -------------- | -------- | ---------------------- | ---------------------- |
    | PRIMARY        | 主键     | id                     | 主键索引               |
    | idx_user_id    | 普通     | user_id                | 按操作人查询           |
    | idx_target     | 普通     | target_type, target_id | 按目标对象查询         |
    | idx_module_op  | 普通     | module, operation      | 按模块操作组合查询     |
    | idx_log_level  | 普通     | log_level, created_at  | 按日志级别查询         |
    | idx_created_at | 普通     | created_at             | 时间范围查询、数据清理 |

    表 7.5.3.2-1 iam_operation_log索引设计

### 7.5.4 iam_security_event 安全事件表

#### 7.5.4.1 表结构

+   安全事件表结构定义：

    | 列名        | 数据类型     | 可空 | 默认值            | 说明                                |
    | ----------- | ------------ | ---- | ----------------- | ----------------------------------- |
    | id          | BIGINT       | NO   | AUTO_INCREMENT    | 主键                                |
    | user_id     | BIGINT       | NO   | -                 | 用户ID                              |
    | username    | VARCHAR(64)  | NO   | -                 | 用户名                              |
    | user_pool   | VARCHAR(16)  | NO   | -                 | 用户群：UP/UR/UC                    |
    | tenant_code | VARCHAR(32)  | YES  | NULL              | 租户编码                            |
    | event_type  | VARCHAR(32)  | NO   | -                 | 事件类型（16种枚举值，见7.3.5.3节） |
    | event_desc  | VARCHAR(256) | YES  | NULL              | 事件描述                            |
    | event_data  | JSON         | YES  | NULL              | 附加数据                            |
    | severity    | VARCHAR(16)  | NO   | 'INFO'            | 严重级别                            |
    | client_ip   | VARCHAR(64)  | YES  | NULL              | 客户端IP                            |
    | operator_id | BIGINT       | YES  | NULL              | 操作人ID                            |
    | created_at  | DATETIME     | NO   | CURRENT_TIMESTAMP | 事件时间                            |

    表 7.5.4.1-1 iam_security_event表结构

+   字段约束说明：
    -   user_id：事件关联的用户，必填
    -   event_type：事件类型枚举值（16种：PASSWORD_CHANGED / PASSWORD_RESET / PASSWORD_RESET_REQUEST / MFA_ENABLED / MFA_DISABLED / ACCOUNT_LOCKED / ACCOUNT_UNLOCKED / SUSPICIOUS_LOGIN / PRIVILEGE_ESCALATION / PRIVILEGE_REVOCATION / DATA_ACCESS_GRANTED / DATA_ACCESS_REVOKED / FORCE_LOGOUT / ACCOUNT_DISABLED / ACCOUNT_DELETED / ACCOUNT_CANCELLED），见7.3.5.3节
    -   severity：严重级别枚举值，见7.3.5.4节
    -   event_data：JSON格式的附加数据，存储事件相关的上下文信息
    -   operator_id：当事件由管理员触发时，记录管理员ID

#### 7.5.4.2 索引设计

+   安全事件表索引设计：

    | 索引名         | 索引类型 | 索引列               | 说明                   |
    | -------------- | -------- | -------------------- | ---------------------- |
    | PRIMARY        | 主键     | id                   | 主键索引               |
    | idx_user_id    | 普通     | user_id              | 按用户查询             |
    | idx_event_type | 普通     | event_type, severity | 按事件类型和级别查询   |
    | idx_severity   | 普通     | severity, created_at | 按严重级别查询         |
    | idx_created_at | 普通     | created_at           | 时间范围查询、数据清理 |

    表 7.5.4.2-1 iam_security_event索引设计

### 7.5.5 分库策略

+   审计日志按用户群分库存储，策略如下表所示。

    | 用户群   | 数据库                   | 表名               | 说明               |
    | -------- | ------------------------ | ------------------ | ------------------ |
    | provider | clarisphere_platform     | iam_login_log      | 运营用户群登录日志 |
    | provider | clarisphere_platform     | iam_operation_log  | 运营用户群操作日志 |
    | provider | clarisphere_platform     | iam_security_event | 运营用户群安全事件 |
    | ur       | clarisphere_t{tenant_id} | iam_login_log      | 租户登录日志       |
    | ur       | clarisphere_t{tenant_id} | iam_operation_log  | 租户操作日志       |
    | ur       | clarisphere_t{tenant_id} | iam_security_event | 租户安全事件       |
    | uc       | clarisphere_consumer     | iam_login_log      | C端登录日志        |
    | uc       | clarisphere_consumer     | iam_security_event | C端安全事件        |

    表 7.5.5-1 审计日志分库策略

+   分库策略说明：
    -   运营用户群日志存储在平台库，数据量较小
    -   租户日志存储在各租户库，天然实现租户隔离
    -   C端日志存储在消费者库，无操作日志（C端无管理功能）
    -   所有库的表结构完全相同，便于统一维护

### 7.5.6 数据清理策略

+   审计日志的数据清理策略如下表所示。

    | 表名               | 默认保留期 | 最短保留期 | 清理条件                     |
    | ------------------ | ---------- | ---------- | ---------------------------- |
    | iam_login_log      | 180天      | 90天       | created_at < 当前日期-保留期 |
    | iam_operation_log  | 180天      | 90天       | created_at < 当前日期-保留期 |
    | iam_security_event | 365天      | 180天      | created_at < 当前日期-保留期 |

    表 7.5.6-1 数据清理策略

+   清理任务配置：

    | 配置项         | 默认值    | 说明                     |
    | -------------- | --------- | ------------------------ |
    | 执行时间       | 每日03:00 | cron表达式：0 0 3 ** ?   |
    | 单批删除数量   | 1000      | 每批次删除的记录数       |
    | 批次间隔       | 100ms     | 批次之间的等待时间       |
    | 单次最大批次数 | 1000      | 单次任务执行的最大批次数 |
    | 任务超时时间   | 30分钟    | 超时后中止当前任务       |

    表 7.5.6-2 清理任务配置

### 7.5.7 数据量估算

+   各表数据量估算如下表所示。

    | 场景           | 用户数 | 日均登录 | 日均操作 | 月增量（登录） | 月增量（操作） |
    | -------------- | ------ | -------- | -------- | -------------- | -------------- |
    | 供给侧         | 50     | 100      | 500      | 3,000          | 15,000         |
    | 单租户（中型） | 500    | 1,000    | 5,000    | 30,000         | 150,000        |
    | 单租户（大型） | 5,000  | 10,000   | 50,000   | 300,000        | 1,500,000      |
    | C端用户        | 100万  | 50万     | -        | 15,000,000     | -              |

    表 7.5.7-1 数据量估算

+   存储空间估算：
    -   单条登录日志：约500字节
    -   单条操作日志：约1KB
    -   单条安全事件：约500字节
    -   C端用户6个月登录日志：约45GB

### 7.5.8 性能优化建议

+   审计日志表的性能优化建议：

    | 优化措施   | 说明                         | 适用场景     |
    | ---------- | ---------------------------- | ------------ |
    | 按时间分区 | 按月分区，便于历史数据清理   | C端登录日志  |
    | 定期归档   | 超过保留期的数据归档到冷存储 | 合规要求场景 |
    | 异步写入   | 操作日志异步写入，不阻塞业务 | 所有操作日志 |
    | 批量写入   | 累积后批量插入，减少IO次数   | 高并发场景   |
    | 索引优化   | 根据实际查询模式调整索引     | 查询性能问题 |
    | 读写分离   | 查询走从库，写入走主库       | 大数据量场景 |

    表 7.5.8-1 性能优化建议

+   C端登录日志分区示例：

    ```sql
    ALTER TABLE iam_login_log PARTITION BY RANGE (TO_DAYS(created_at)) (
        PARTITION p202601 VALUES LESS THAN (TO_DAYS('2026-02-01')),
        PARTITION p202602 VALUES LESS THAN (TO_DAYS('2026-03-01')),
        PARTITION p202603 VALUES LESS THAN (TO_DAYS('2026-04-01')),
        PARTITION pmax VALUES LESS THAN MAXVALUE
    );
    ```

## 7.6 前端设计

+   本节设计审计管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   审计管理前端以查询展示为主，不涉及复杂的表单操作；运营用户群与租户用户群页面结构高度相似，详写运营用户群，租户用户群以差异对比表说明。

### 7.6.1 页面总览

+   审计管理子领域前端页面清单如下表所示。

    | 页面编号     | 页面名称     | 用户群   | 路由路径                          | 说明                                  |
    | ------------ | ------------ | -------- | --------------------------------- | ------------------------------------- |
    | PG-P-AUD-01  | 登录日志查询 | provider | /provider/system/login-logs       | 运营侧查询平台用户登录日志            |
    | PG-P-AUD-02  | 操作日志查询 | provider | /provider/system/operation-logs   | 运营侧查询平台用户操作日志            |
    | PG-P-AUD-03  | 安全事件查询 | provider | /provider/system/security-events  | 运营侧查询平台安全事件                |
    | PG-UR-AUD-01 | 登录日志查询 | ur       | /tenant/system/login-logs         | 租户侧查询本租户登录日志              |
    | PG-UR-AUD-02 | 操作日志查询 | ur       | /tenant/system/operation-logs     | 租户侧查询本租户操作日志              |
    | PG-UR-AUD-03 | 安全事件查询 | ur       | /tenant/system/security-events    | 租户侧查询本租户安全事件              |
    | PG-UC-AUD-01 | 我的登录记录 | uc       | /consumer/account/login-logs      | C端用户查看个人登录记录               |
    | PG-UC-AUD-02 | 我的安全事件 | uc       | /consumer/account/security-events | C端用户查看个人安全事件（异地登录等） |

    表 7.6.1-1 审计管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                        审计管理页面导航结构                              │
    ├──────────────────────────────────────────────────────────────────────────┤
    │                                                                          │
    │  运营管理后台                                                            │
    │  └── 系统管理 → 审计日志                                                 │
    │      ├── [PG-P-AUD-01] 登录日志查询                                      │
    │      ├── [PG-P-AUD-02] 操作日志查询                                      │
    │      └── [PG-P-AUD-03] 安全事件查询                                      │
    │                                                                          │
    │  租户管理后台                                                            │
    │  └── 系统管理 → 审计日志                                                 │
    │      ├── [PG-UR-AUD-01] 登录日志查询                                     │
    │      ├── [PG-UR-AUD-02] 操作日志查询                                     │
    │      └── [PG-UR-AUD-03] 安全事件查询                                     │
    │                                                                          │
    │  C端个人门户                                                             │
    │  └── 账号安全                                                            │
    │      ├── [PG-UC-AUD-01] 我的登录记录                                     │
    │      └── [PG-UC-AUD-02] 我的安全事件                                     │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.1-1 审计管理页面导航结构

### 7.6.2 运营用户群审计日志

#### 7.6.2.1 PG-P-AUD-01 登录日志查询

+   页面说明：
    -   用途：查询运营用户群全部用户的登录日志，支持按用户名、登录结果、登录方式、时间范围、IP地址筛选
    -   入口：运营管理后台 → 系统管理 → 审计日志 → 登录日志
    -   权限：provider:iam:login-log:list

+   页面布局：

    ```
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │  系统管理 / 审计日志 / 登录日志                                               │
    ├───────────────────────────────────────────────────────────────────────────────┤
    │                                                                               │
    │  ┌─ 搜索区域 ───────────────────────────────────────────────────────────────┐ │
    │  │                                                                          │ │
    │  │  用户名            登录结果          登录方式           时间范围         │ │
    │  │  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────────┐   │ │
    │  │  │            │   │ 全部     ▼ │   │ 全部     ▼ │   │ 选择日期范围   │   │ │
    │  │  └────────────┘   └────────────┘   └────────────┘   └────────────────┘   │ │
    │  │                                                                          │ │
    │  │  IP地址                                              ┌────┐   ┌────┐     │ │
    │  │  ┌────────────────────┐                              │搜索│   │重置│     │ │
    │  │  │                    │                              └────┘   └────┘     │ │
    │  │  └────────────────────┘                                                  │ │
    │  └──────────────────────────────────────────────────────────────────────────┘ │
    │                                                                               │
    │  ┌─ 数据列表 ───────────────────────────────────────────────────────────────┐ │
    │  │                                                                          │ │
    │  │  ┌────────┬────────┬────────┬────────┬──────────┬──────────┬───────────┐ │ │
    │  │  │ 用户名 │登录方式│  结果  │   IP   │  归属地  │ 设备类型 │   时间    │ │ │
    │  │  ├────────┼────────┼────────┼────────┼──────────┼──────────┼───────────┤ │ │
    │  │  │ admin  │密码登录│ ● 成功 │1.2.3.4 │ 北京市   │    PC    │01-25 10:30│ │ │
    │  │  ├────────┼────────┼────────┼────────┼──────────┼──────────┼───────────┤ │ │
    │  │  │ user01 │密码登录│ ● 失败 │5.6.7.8 │ 上海市   │  Mobile  │01-25 10:28│ │ │
    │  │  │        │        │密码错误│        │          │          │           │ │ │
    │  │  ├────────┼────────┼────────┼────────┼──────────┼──────────┼───────────┤ │ │
    │  │  │ admin  │密码登录│ ● 登出 │1.2.3.4 │ 北京市   │    PC    │01-25 09:00│ │ │
    │  │  └────────┴────────┴────────┴────────┴──────────┴──────────┴───────────┘ │ │
    │  │                                                                          │ │
    │  │  共 1,234 条记录                                    < 1 2 3 ... 62 >     │ │
    │  └──────────────────────────────────────────────────────────────────────────┘ │
    │                                                                               │
    └───────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.2.1-1 登录日志查询页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                                       | 关联API  | 前置条件                    |
    | -------- | -------- | ------------ | ---------------------------------------------------------- | -------- | --------------------------- |
    | F01      | 展示     | 加载登录日志 | 进入页面自动加载最近7天的登录日志列表，分页展示            | P-AUD-01 | provider:iam:login-log:list |
    | F02      | 操作     | 搜索         | 按用户名、登录结果、登录方式、时间范围、IP地址条件查询列表 | P-AUD-01 | provider:iam:login-log:list |
    | F03      | 操作     | 重置         | 清空搜索条件，恢复默认值（时间范围恢复为最近7天）          | -        | -                           |
    | F04      | 展示     | 分页切换     | 切换分页页码，加载对应页数据                               | P-AUD-01 | provider:iam:login-log:list |
    | F05      | 展示     | 列排序       | 点击时间列表头切换升序/降序                                | P-AUD-01 | provider:iam:login-log:list |
    | F06      | 展示     | 结果状态展示 | 登录结果列以颜色标签展示，失败时附加显示失败原因           | -        | -                           |

    表 7.6.2.1-1 登录日志查询页功能说明

+   搜索条件：

    | 字段名   | 组件类型  | 数据来源 | 默认值  | 说明                    |
    | -------- | --------- | -------- | ------- | ----------------------- |
    | 用户名   | Input     | 用户输入 | 空      | 模糊匹配                |
    | 登录结果 | Select    | 字典     | 全部    | SUCCESS/FAILED/LOGOUT等 |
    | 登录方式 | Select    | 字典     | 全部    | PASSWORD/SMS_CODE等     |
    | 时间范围 | DateRange | 用户选择 | 最近7天 | 开始时间~结束时间       |
    | IP地址   | Input     | 用户输入 | 空      | 精确匹配                |

    表 7.6.2.1-2 登录日志查询页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                   |
    | -------- | ---- | ---- | -------- | ---------------------- |
    | 用户名   | 120  | 左   | 否       | 显示登录账号           |
    | 登录方式 | 100  | 中   | 否       | 显示文本标签           |
    | 结果     | 100  | 中   | 否       | 状态标签，失败显示原因 |
    | IP地址   | 130  | 左   | 否       | 客户端IP               |
    | 归属地   | 100  | 左   | 否       | IP归属地               |
    | 设备类型 | 80   | 中   | 否       | PC/Mobile/Tablet       |
    | 时间     | 150  | 中   | 是       | 记录时间，默认降序     |

    表 7.6.2.1-3 登录日志查询页列表字段

+   状态/标签展示：

    | 结果值  | 标签文本 | 标签颜色 | 是否显示原因 |
    | ------- | -------- | -------- | ------------ |
    | SUCCESS | 成功     | 绿色     | 否           |
    | FAILED  | 失败     | 红色     | 是           |
    | LOGOUT  | 登出     | 灰色     | 否           |
    | REFRESH | 刷新     | 蓝色     | 否           |
    | KICKED  | 踢出     | 橙色     | 否           |
    | EXPIRED | 过期     | 灰色     | 否           |

    表 7.6.2.1-4 登录结果状态标签

#### 7.6.2.2 PG-P-AUD-02 操作日志查询

+   页面说明：
    -   用途：查询运营用户群全部用户的操作日志，支持多维度筛选和行点击查看详情
    -   入口：运营管理后台 → 系统管理 → 审计日志 → 操作日志
    -   权限：provider:iam:operation-log:list

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  系统管理 / 审计日志 / 操作日志                                              │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 搜索区域 ──────────────────────────────────────────────────────────────┐ │
    │  │                                                                         │ │
    │  │  操作人            模块              操作              日志级别         │ │
    │  │  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐      │ │
    │  │  │            │   │ 全部     ▼ │   │ 全部     ▼ │   │ 全部     ▼ │      │ │
    │  │  └────────────┘   └────────────┘   └────────────┘   └────────────┘      │ │
    │  │                                                                         │ │
    │  │  目标类型          目标ID/名称       结果              时间范围         │ │
    │  │  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────────┐  │ │
    │  │  │ 全部     ▼ │   │            │   │ 全部     ▼ │   │ 选择日期范围   │  │ │
    │  │  └────────────┘   └────────────┘   └────────────┘   └────────────────┘  │ │
    │  │                                                       ┌────┐   ┌────┐   │ │
    │  │                                                       │搜索│   │重置│   │ │
    │  │                                                       └────┘   └────┘   │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    │  ┌─ 数据列表 ──────────────────────────────────────────────────────────────┐ │
    │  │                                                                         │ │
    │  │  ┌──────┬──────┬──────┬──────────┬──────┬──────┬──────┬──────┬────────┐ │ │
    │  │  │操作人│ 模块 │ 操作 │ 操作对象 │ 级别 │ 结果 │  IP  │ 耗时 │  时间  │ │ │
    │  │  ├──────┼──────┼──────┼──────────┼──────┼──────┼──────┼──────┼────────┤ │ │
    │  │  │admin │用户  │ 创建 │张三      │ 重要 │ 成功 │1.2.. │ 45ms │01-25...│ │ │
    │  │  ├──────┼──────┼──────┼──────────┼──────┼──────┼──────┼──────┼────────┤ │ │
    │  │  │admin │角色  │ 修改 │系统管理员│ 重要 │ 成功 │1.2.. │ 32ms │01-25...│ │ │
    │  │  ├──────┼──────┼──────┼──────────┼──────┼──────┼──────┼──────┼────────┤ │ │
    │  │  │admin │用户  │ 删除 │李四      │ 关键 │ 失败 │1.2.. │ 12ms │01-25...│ │ │
    │  │  │      │      │      │          │      │无权限│      │      │        │ │ │
    │  │  └──────┴──────┴──────┴──────────┴──────┴──────┴──────┴──────┴────────┘ │ │
    │  │                                                                         │ │
    │  │  共 5,678 条记录                                    < 1 2 3 ... 284 >   │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.2.2-1 操作日志查询页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                                                          | 关联API  | 前置条件                          |
    | -------- | -------- | ------------ | ----------------------------------------------------------------------------- | -------- | --------------------------------- |
    | F01      | 展示     | 加载操作日志 | 进入页面自动加载最近7天的操作日志列表，分页展示                               | P-AUD-03 | provider:iam:operation-log:list   |
    | F02      | 操作     | 搜索         | 按操作人、模块、操作、日志级别、目标类型、目标ID/名称、结果、时间范围查询列表 | P-AUD-03 | provider:iam:operation-log:list   |
    | F03      | 操作     | 重置         | 清空搜索条件，恢复默认值（时间范围恢复为最近7天）                             | -        | -                                 |
    | F04      | 展示     | 分页切换     | 切换分页页码，加载对应页数据                                                  | P-AUD-03 | provider:iam:operation-log:list   |
    | F05      | 展示     | 列排序       | 点击耗时列或时间列表头切换升序/降序                                           | P-AUD-03 | provider:iam:operation-log:list   |
    | F06      | 展示     | 级别标签展示 | 日志级别列以颜色标签展示（普通/重要/关键）                                    | -        | -                                 |
    | F07      | 操作     | 查看详情     | 点击列表行打开操作日志详情弹窗                                                | P-AUD-04 | provider:iam:operation-log:detail |

    表 7.6.2.2-1 操作日志查询页功能说明

+   搜索条件：

    | 字段名      | 组件类型  | 数据来源 | 默认值  | 说明                      |
    | ----------- | --------- | -------- | ------- | ------------------------- |
    | 操作人      | Input     | 用户输入 | 空      | 用户名模糊匹配            |
    | 模块        | Select    | 字典     | 全部    | USER/ROLE/ORG/CONFIG      |
    | 操作        | Select    | 字典     | 全部    | CREATE/UPDATE/DELETE等    |
    | 日志级别    | Select    | 字典     | 全部    | NORMAL/IMPORTANT/CRITICAL |
    | 目标类型    | Select    | 字典     | 全部    | User/Role/Org等           |
    | 目标ID/名称 | Input     | 用户输入 | 空      | ID精确或名称模糊匹配      |
    | 结果        | Select    | 字典     | 全部    | SUCCESS/FAILED            |
    | 时间范围    | DateRange | 用户选择 | 最近7天 | 开始时间~结束时间         |

    表 7.6.2.2-2 操作日志查询页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明                    |
    | -------- | ---- | ---- | -------- | ----------------------- |
    | 操作人   | 100  | 左   | 否       | 操作人用户名            |
    | 模块     | 80   | 中   | 否       | 模块名称                |
    | 操作     | 80   | 中   | 否       | 操作类型                |
    | 操作对象 | 150  | 左   | 否       | 目标类型+名称           |
    | 级别     | 80   | 中   | 否       | 日志级别标签            |
    | 结果     | 80   | 中   | 否       | 成功/失败，失败显示原因 |
    | IP地址   | 100  | 左   | 否       | 客户端IP（截断显示）    |
    | 耗时     | 80   | 右   | 是       | 执行耗时（毫秒）        |
    | 时间     | 150  | 中   | 是       | 操作时间，默认降序      |

    表 7.6.2.2-3 操作日志查询页列表字段

+   状态/标签展示：

    | 级别值    | 标签文本 | 标签颜色 |
    | --------- | -------- | -------- |
    | NORMAL    | 普通     | 灰色     |
    | IMPORTANT | 重要     | 蓝色     |
    | CRITICAL  | 关键     | 红色     |

    表 7.6.2.2-4 日志级别状态标签

+   详情弹窗：

    +   点击列表行弹出操作日志详情弹窗，字段布局如下表所示。

    | 字段名   | 显示分组 | 说明                   |
    | -------- | -------- | ---------------------- |
    | 日志ID   | 基本信息 | 完整ID                 |
    | 操作人   | 基本信息 | 用户名                 |
    | 操作时间 | 基本信息 | 完整时间               |
    | 模块     | 操作信息 | 模块名称               |
    | 操作     | 操作信息 | 操作类型               |
    | 目标类型 | 操作信息 | 目标类型               |
    | 目标ID   | 操作信息 | 目标ID                 |
    | 目标名称 | 操作信息 | 目标名称               |
    | 日志级别 | 操作信息 | 级别标签               |
    | 结果     | 结果信息 | 成功/失败              |
    | 错误信息 | 结果信息 | 失败时显示             |
    | 请求参数 | 详情信息 | JSON格式展示（脱敏后） |
    | 客户端IP | 环境信息 | 完整IP                 |
    | 浏览器UA | 环境信息 | 完整UA                 |
    | 执行耗时 | 环境信息 | 毫秒                   |

    表 7.6.2.2-5 操作日志详情弹窗字段

+   交互规则：
    -   点击列表任意行（非文字选中操作）即弹出详情弹窗，弹窗右上角提供关闭按钮
    -   请求参数字段对密码、Token等敏感字段脱敏展示（显示为 `***`）
    -   弹窗内容只读，不支持编辑操作

#### 7.6.2.3 PG-P-AUD-03 安全事件查询

+   页面说明：
    -   用途：查询运营用户群范围内的安全事件，如密码修改、账号锁定、账号禁用等
    -   入口：运营管理后台 → 系统管理 → 审计日志 → 安全事件
    -   权限：provider:iam:security-event:list

+   页面布局：

    ```
    ┌───────────────────────────────────────────────────────────────────────────────┐
    │  系统管理 / 审计日志 / 安全事件                                               │
    ├───────────────────────────────────────────────────────────────────────────────┤
    │                                                                               │
    │  ┌─ 搜索区域 ───────────────────────────────────────────────────────────────┐ │
    │  │                                                                          │ │
    │  │  用户名            事件类型          严重级别          时间范围          │ │
    │  │  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────────┐   │ │
    │  │  │            │   │ 全部     ▼ │   │ 全部     ▼ │   │ 选择日期范围   │   │ │
    │  │  └────────────┘   └────────────┘   └────────────┘   └────────────────┘   │ │
    │  │                                                       ┌────┐   ┌────┐    │ │
    │  │                                                       │搜索│   │重置│    │ │
    │  │                                                       └────┘   └────┘    │ │
    │  └──────────────────────────────────────────────────────────────────────────┘ │
    │                                                                               │
    │  ┌─ 数据列表 ───────────────────────────────────────────────────────────────┐ │
    │  │                                                                          │ │
    │  │  ┌────────┬────────────┬────────┬──────────────────┬────────┬─────────┐  │ │
    │  │  │ 用户名 │  事件类型  │  级别  │     事件描述     │   IP   │   时间  │  │ │
    │  │  ├────────┼────────────┼────────┼──────────────────┼────────┼─────────┤  │ │
    │  │  │ admin  │ 密码修改   │  信息  │ 用户主动修改密码 │ 1.2.3.4│01-25... │  │ │
    │  │  ├────────┼────────────┼────────┼──────────────────┼────────┼─────────┤  │ │
    │  │  │ user01 │ 账号锁定   │  警告  │ 密码错误5次锁定  │ 5.6.7.8│01-25... │  │ │
    │  │  ├────────┼────────────┼────────┼──────────────────┼────────┼─────────┤  │ │
    │  │  │ user02 │ 账号禁用   │  高危  │ 被管理员禁用     │   -    │01-25... │  │ │
    │  │  └────────┴────────────┴────────┴──────────────────┴────────┴─────────┘  │ │
    │  │                                                                          │ │
    │  │  共 456 条记录                                       < 1 2 3 ... 23 >    │ │
    │  └──────────────────────────────────────────────────────────────────────────┘ │
    │                                                                               │
    └───────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.2.3-1 安全事件查询页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                               | 关联API  | 前置条件                         |
    | -------- | -------- | ------------ | -------------------------------------------------- | -------- | -------------------------------- |
    | F01      | 展示     | 加载安全事件 | 进入页面自动加载最近7天的安全事件列表，分页展示    | P-AUD-05 | provider:iam:security-event:list |
    | F02      | 操作     | 搜索         | 按用户名、事件类型、严重级别、时间范围条件查询列表 | P-AUD-05 | provider:iam:security-event:list |
    | F03      | 操作     | 重置         | 清空搜索条件，恢复默认值（时间范围恢复为最近7天）  | -        | -                                |
    | F04      | 展示     | 分页切换     | 切换分页页码，加载对应页数据                       | P-AUD-05 | provider:iam:security-event:list |
    | F05      | 展示     | 列排序       | 点击时间列表头切换升序/降序                        | P-AUD-05 | provider:iam:security-event:list |
    | F06      | 展示     | 级别标签展示 | 严重级别列以颜色标签+图标展示（信息/警告/高危）    | -        | -                                |

    表 7.6.2.3-1 安全事件查询页功能说明

+   搜索条件：

    | 字段名   | 组件类型  | 数据来源 | 默认值  | 说明               |
    | -------- | --------- | -------- | ------- | ------------------ |
    | 用户名   | Input     | 用户输入 | 空      | 模糊匹配           |
    | 事件类型 | Select    | 字典     | 全部    | PASSWORD_CHANGED等 |
    | 严重级别 | Select    | 字典     | 全部    | INFO/WARN/HIGH     |
    | 时间范围 | DateRange | 用户选择 | 最近7天 | 开始时间~结束时间  |

    表 7.6.2.3-2 安全事件查询页搜索条件

+   列表字段：

    | 字段名   | 列宽 | 对齐 | 是否排序 | 说明               |
    | -------- | ---- | ---- | -------- | ------------------ |
    | 用户名   | 120  | 左   | 否       | 事件关联用户       |
    | 事件类型 | 120  | 中   | 否       | 事件类型文本       |
    | 级别     | 80   | 中   | 否       | 严重级别标签       |
    | 事件描述 | 250  | 左   | 否       | 事件描述文本       |
    | IP地址   | 120  | 左   | 否       | 客户端IP           |
    | 时间     | 150  | 中   | 是       | 事件时间，默认降序 |

    表 7.6.2.3-3 安全事件查询页列表字段

+   状态/标签展示：

    | 级别值 | 标签文本 | 标签颜色 | 图标     |
    | ------ | -------- | -------- | -------- |
    | INFO   | 信息     | 蓝色     | 信息图标 |
    | WARN   | 警告     | 橙色     | 警告图标 |
    | HIGH   | 高危     | 红色     | 危险图标 |

    表 7.6.2.3-4 严重级别状态标签

### 7.6.3 租户用户群审计日志

+   租户用户群页面（PG-UR-AUD-01/02/03）与运营用户群页面（PG-P-AUD-01/02/03）结构完全相同，差异点如下表所示。

    | 差异项       | 运营用户群（PG-P-AUD-xx）          | 租户用户群（PG-UR-AUD-xx）         |
    | ------------ | ---------------------------------- | ---------------------------------- |
    | 数据范围     | 运营用户群全部用户的审计日志       | 当前租户全部用户的审计日志         |
    | 页面入口     | 运营管理后台 → 系统管理 → 审计日志 | 租户管理后台 → 系统管理 → 审计日志 |
    | 路由前缀     | /provider/system/                  | /tenant/system/                    |
    | 权限标识前缀 | provider:iam:                      | ur:iam:                            |
    | 调用API前缀  | P-AUD-xx                           | UR-AUD-xx                          |
    | 数据隔离方式 | 直接查询平台库                     | 通过数据源路由查询租户库           |

    表 7.6.3-1 运营用户群与租户用户群页面差异

+   租户用户群各页面的权限标识映射如下表所示。

    | 页面编号     | 页面名称     | 查询权限                   | 详情权限                    |
    | ------------ | ------------ | -------------------------- | --------------------------- |
    | PG-UR-AUD-01 | 登录日志查询 | ur:iam:login-log:list      | -                           |
    | PG-UR-AUD-02 | 操作日志查询 | ur:iam:operation-log:list  | ur:iam:operation-log:detail |
    | PG-UR-AUD-03 | 安全事件查询 | ur:iam:security-event:list | -                           |

    表 7.6.3-2 租户用户群页面权限标识

### 7.6.4 C端用户账号安全

#### 7.6.4.1 PG-UC-AUD-01 我的登录记录

+   页面说明：
    -   用途：C端用户查看个人登录记录，发现异常登录时可快速修改密码
    -   入口：C端个人门户 → 账号安全 → 登录记录
    -   权限：authenticated（登录即可，仅查看自己的记录）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  账号安全 > 登录记录                                                         │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 提示信息 ──────────────────────────────────────────────────────────────┐ │
    │  │  ℹ️ 这里显示您最近的登录记录，如发现异常登录请及时修改密码             │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    │  ┌─ 筛选条件 ──────────────────────────────────────────────────────────────┐ │
    │  │  结果：┌────────────┐  时间：┌────────────────┐   ┌────┐                │ │
    │  │        │ 全部     ▼ │        │ 最近7天      ▼ │   │筛选│                │ │
    │  │        └────────────┘        └────────────────┘   └────┘                │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    │  ┌─ 登录记录列表 ──────────────────────────────────────────────────────────┐ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ● 登录成功                                       2026-01-25 10:30 │ │ │
    │  │  │  密码登录 · 北京市 · 192.168.1.100 · PC浏览器                      │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ● 登录失败 - 密码错误                            2026-01-25 10:28 │ │ │
    │  │  │  密码登录 · 上海市 · 10.20.30.40 · 移动设备                        │ │ │
    │  │  │  ⚠️ 不是您本人操作？建议立即修改密码                  [修改密码]  │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ● 主动登出                                       2026-01-25 09:00 │ │ │
    │  │  │  北京市 · 192.168.1.100 · PC浏览器                                 │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │                          加载更多                                  │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.4.1-1 我的登录记录页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                                        | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | ----------------------------------------------------------- | --------- | ------------- |
    | F01      | 展示     | 加载登录记录 | 进入页面自动加载最近7天的个人登录记录，卡片列表式展示       | UC-AUD-01 | authenticated |
    | F02      | 操作     | 筛选         | 按登录结果和时间快捷筛选（最近7天/最近30天/最近90天）       | UC-AUD-01 | authenticated |
    | F03      | 展示     | 加载更多     | 点击"加载更多"按钮追加加载下一页数据                        | UC-AUD-01 | authenticated |
    | F04      | 展示     | 异常提示     | 登录失败记录卡片底部显示安全警示文案                        | -         | -             |
    | F05      | 操作     | 修改密码     | 登录失败记录卡片提供"修改密码"快捷链接，跳转修改密码页      | -         | authenticated |
    | F06      | 展示     | 结果状态展示 | 卡片左上角圆点标识登录结果：绿色-成功、红色-失败、灰色-登出 | -         | -             |

    表 7.6.4.1-1 我的登录记录页功能说明

+   交互规则：
    -   采用卡片列表式布局，非表格式，适配移动端响应式展示
    -   分页方式为下拉加载更多，非传统分页器
    -   信息密度简化，每张卡片仅显示登录结果、登录方式、归属地、IP、设备类型、时间
    -   登录失败卡片额外显示安全提示文案和修改密码快捷入口

#### 7.6.4.2 PG-UC-AUD-02 我的安全事件

+   页面说明：
    -   用途：C端用户查看个人安全事件，如异地登录提醒、密码修改记录、账号锁定记录等
    -   入口：C端个人门户 → 账号安全 → 安全提醒
    -   权限：authenticated（登录即可，仅查看自己的记录）

+   页面布局：

    ```
    ┌──────────────────────────────────────────────────────────────────────────────┐
    │  账号安全 > 安全提醒                                                         │
    ├──────────────────────────────────────────────────────────────────────────────┤
    │                                                                              │
    │  ┌─ 提示信息 ──────────────────────────────────────────────────────────────┐ │
    │  │  ℹ️ 这里显示与您账号相关的安全事件，请留意异常操作                     │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    │  ┌─ 筛选条件 ──────────────────────────────────────────────────────────────┐ │
    │  │  事件类型：┌────────────┐  时间：┌────────────────┐   ┌────┐            │ │
    │  │            │ 全部     ▼ │        │ 最近7天      ▼ │   │筛选│            │ │
    │  │            └────────────┘        └────────────────┘   └────┘            │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    │  ┌─ 安全事件列表 ──────────────────────────────────────────────────────────┐ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ● 密码修改                                       2026-01-25 14:20 │ │ │
    │  │  │  您的密码已被成功修改                                              │ │ │
    │  │  │  北京市 · 192.168.1.100                                            │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ⚠ 异地登录                                      2026-01-24 08:15  │ │ │
    │  │  │  检测到您的账号在新设备上登录                                      │ │ │
    │  │  │  上海市 · 10.20.30.40                          [不是我] [已知晓]   │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │  ● 账号锁定                                       2026-01-23 22:30 │ │ │
    │  │  │  密码错误次数过多，账号已被临时锁定                                │ │ │
    │  │  │  深圳市 · 172.16.0.50                                              │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
    │  │  │                          加载更多                                  │ │ │
    │  │  └────────────────────────────────────────────────────────────────────┘ │ │
    │  │                                                                         │ │
    │  └─────────────────────────────────────────────────────────────────────────┘ │
    │                                                                              │
    └──────────────────────────────────────────────────────────────────────────────┘
    ```

    图 7.6.4.2-1 我的安全事件页线框图

+   功能说明：

    | 功能编号 | 功能类型 | 功能名称     | 说明                                                       | 关联API   | 前置条件      |
    | -------- | -------- | ------------ | ---------------------------------------------------------- | --------- | ------------- |
    | F01      | 展示     | 加载安全事件 | 进入页面自动加载最近7天的个人安全事件，卡片列表式展示      | UC-AUD-02 | authenticated |
    | F02      | 操作     | 筛选         | 按事件类型和时间快捷筛选（最近7天/最近30天/最近90天）      | UC-AUD-02 | authenticated |
    | F03      | 展示     | 加载更多     | 点击"加载更多"按钮追加加载下一页数据                       | UC-AUD-02 | authenticated |
    | F04      | 展示     | 级别标识展示 | 卡片左上角图标按级别区分：●信息（蓝色）、⚠警告（橙色）     | -         | -             |
    | F05      | 操作     | 快捷处理     | 异地登录等警告级事件卡片提供"不是我"和"已知晓"快捷操作按钮 | -         | authenticated |

    表 7.6.4.2-1 我的安全事件页功能说明

+   交互规则：
    -   采用卡片列表式布局，与"我的登录记录"页保持一致的视觉风格
    -   分页方式为下拉加载更多，非传统分页器
    -   每张卡片显示事件类型、事件描述、归属地和IP
    -   警告级别事件卡片提供快捷操作按钮：点击"不是我"跳转修改密码页面，点击"已知晓"标记为已读

### 7.6.5 页面与接口映射

+   审计管理子领域页面与后端接口的映射关系如下表所示。

    | 页面编号     | 页面功能     | 调用接口                   |
    | ------------ | ------------ | -------------------------- |
    | PG-P-AUD-01  | 加载登录日志 | P-AUD-01 查询登录日志      |
    | PG-P-AUD-01  | 搜索         | P-AUD-01 查询登录日志      |
    | PG-P-AUD-02  | 加载操作日志 | P-AUD-03 查询操作日志      |
    | PG-P-AUD-02  | 搜索         | P-AUD-03 查询操作日志      |
    | PG-P-AUD-02  | 查看详情     | P-AUD-04 获取操作日志详情  |
    | PG-P-AUD-03  | 加载安全事件 | P-AUD-05 查询安全事件      |
    | PG-P-AUD-03  | 搜索         | P-AUD-05 查询安全事件      |
    | PG-UR-AUD-01 | 加载登录日志 | UR-AUD-01 查询登录日志     |
    | PG-UR-AUD-01 | 搜索         | UR-AUD-01 查询登录日志     |
    | PG-UR-AUD-02 | 加载操作日志 | UR-AUD-03 查询操作日志     |
    | PG-UR-AUD-02 | 搜索         | UR-AUD-03 查询操作日志     |
    | PG-UR-AUD-02 | 查看详情     | UR-AUD-04 获取操作日志详情 |
    | PG-UR-AUD-03 | 加载安全事件 | UR-AUD-05 查询安全事件     |
    | PG-UR-AUD-03 | 搜索         | UR-AUD-05 查询安全事件     |
    | PG-UC-AUD-01 | 加载登录记录 | UC-AUD-01 查询我的登录记录 |
    | PG-UC-AUD-01 | 筛选         | UC-AUD-01 查询我的登录记录 |
    | PG-UC-AUD-02 | 加载安全事件 | UC-AUD-02 查询我的安全事件 |
    | PG-UC-AUD-02 | 筛选         | UC-AUD-02 查询我的安全事件 |

    表 7.6.5-1 页面与接口映射

### 7.6.6 功能操作汇总

+   审计管理子领域所有功能操作汇总如下表所示。

    | 功能编号         | 所属页面     | 功能类型 | 功能名称     | 关联API   | 权限标识                          |
    | ---------------- | ------------ | -------- | ------------ | --------- | --------------------------------- |
    | PG-P-AUD-01.F01  | PG-P-AUD-01  | 展示     | 加载登录日志 | P-AUD-01  | provider:iam:login-log:list       |
    | PG-P-AUD-01.F02  | PG-P-AUD-01  | 操作     | 搜索         | P-AUD-01  | provider:iam:login-log:list       |
    | PG-P-AUD-01.F03  | PG-P-AUD-01  | 操作     | 重置         | -         | -                                 |
    | PG-P-AUD-01.F04  | PG-P-AUD-01  | 展示     | 分页切换     | P-AUD-01  | provider:iam:login-log:list       |
    | PG-P-AUD-01.F05  | PG-P-AUD-01  | 展示     | 列排序       | P-AUD-01  | provider:iam:login-log:list       |
    | PG-P-AUD-01.F06  | PG-P-AUD-01  | 展示     | 结果状态展示 | -         | -                                 |
    | PG-P-AUD-02.F01  | PG-P-AUD-02  | 展示     | 加载操作日志 | P-AUD-03  | provider:iam:operation-log:list   |
    | PG-P-AUD-02.F02  | PG-P-AUD-02  | 操作     | 搜索         | P-AUD-03  | provider:iam:operation-log:list   |
    | PG-P-AUD-02.F03  | PG-P-AUD-02  | 操作     | 重置         | -         | -                                 |
    | PG-P-AUD-02.F04  | PG-P-AUD-02  | 展示     | 分页切换     | P-AUD-03  | provider:iam:operation-log:list   |
    | PG-P-AUD-02.F05  | PG-P-AUD-02  | 展示     | 列排序       | P-AUD-03  | provider:iam:operation-log:list   |
    | PG-P-AUD-02.F06  | PG-P-AUD-02  | 展示     | 级别标签展示 | -         | -                                 |
    | PG-P-AUD-02.F07  | PG-P-AUD-02  | 操作     | 查看详情     | P-AUD-04  | provider:iam:operation-log:detail |
    | PG-P-AUD-03.F01  | PG-P-AUD-03  | 展示     | 加载安全事件 | P-AUD-05  | provider:iam:security-event:list  |
    | PG-P-AUD-03.F02  | PG-P-AUD-03  | 操作     | 搜索         | P-AUD-05  | provider:iam:security-event:list  |
    | PG-P-AUD-03.F03  | PG-P-AUD-03  | 操作     | 重置         | -         | -                                 |
    | PG-P-AUD-03.F04  | PG-P-AUD-03  | 展示     | 分页切换     | P-AUD-05  | provider:iam:security-event:list  |
    | PG-P-AUD-03.F05  | PG-P-AUD-03  | 展示     | 列排序       | P-AUD-05  | provider:iam:security-event:list  |
    | PG-P-AUD-03.F06  | PG-P-AUD-03  | 展示     | 级别标签展示 | -         | -                                 |
    | PG-UC-AUD-01.F01 | PG-UC-AUD-01 | 展示     | 加载登录记录 | UC-AUD-01 | authenticated                     |
    | PG-UC-AUD-01.F02 | PG-UC-AUD-01 | 操作     | 筛选         | UC-AUD-01 | authenticated                     |
    | PG-UC-AUD-01.F03 | PG-UC-AUD-01 | 展示     | 加载更多     | UC-AUD-01 | authenticated                     |
    | PG-UC-AUD-01.F04 | PG-UC-AUD-01 | 展示     | 异常提示     | -         | -                                 |
    | PG-UC-AUD-01.F05 | PG-UC-AUD-01 | 操作     | 修改密码     | -         | authenticated                     |
    | PG-UC-AUD-01.F06 | PG-UC-AUD-01 | 展示     | 结果状态展示 | -         | -                                 |
    | PG-UC-AUD-02.F01 | PG-UC-AUD-02 | 展示     | 加载安全事件 | UC-AUD-02 | authenticated                     |
    | PG-UC-AUD-02.F02 | PG-UC-AUD-02 | 操作     | 筛选         | UC-AUD-02 | authenticated                     |
    | PG-UC-AUD-02.F03 | PG-UC-AUD-02 | 展示     | 加载更多     | UC-AUD-02 | authenticated                     |
    | PG-UC-AUD-02.F04 | PG-UC-AUD-02 | 展示     | 级别标识展示 | -         | -                                 |
    | PG-UC-AUD-02.F05 | PG-UC-AUD-02 | 操作     | 快捷处理     | -         | authenticated                     |

    表 7.6.6-1 功能操作汇总

## 7.7 权限设计

+   本节设计审计管理子领域的权限控制，包括功能权限和数据权限。

### 7.7.1 功能权限

+   审计管理的功能权限定义：

    | 权限编码     | 权限名称     | 说明                     | 适用角色   |
    | ------------ | ------------ | ------------------------ | ---------- |
    | audit:read   | 查看审计日志 | 查询登录日志、操作日志等 | 管理员角色 |
    | audit:export | 导出审计日志 | 导出日志数据（V2.0）     | 管理员角色 |

    表 7.7.1-1 功能权限定义

+   权限说明：
    -   V1.0只实现audit:read权限
    -   audit:export权限规划在V2.0实现
    -   个人用户查看自己的登录记录不需要额外权限，登录即可

### 7.7.2 角色权限配置

+   各角色的审计权限配置：

    | 用户群   | 角色编码 | 角色名称       | audit:read | audit:export |
    | -------- | -------- | -------------- | ---------- | ------------ |
    | provider | UP-01    | 平台超级管理员 | ✓          | ✓            |
    | provider | UP-02    | 平台管理员     | ✓          | ✓            |
    | provider | UP-03    | 平台运营       | ✓          | ✗            |
    | provider | UP-04    | 平台客服       | ✗          | ✗            |
    | ur       | UR-01    | 租户超级管理员 | ✓          | ✓            |
    | ur       | UR-02    | 租户管理员     | ✓          | ✓            |
    | ur       | UR-03    | 安全管理员     | ✓          | ✓            |
    | ur       | UR-04    | 普通用户       | ✗          | ✗            |
    | uc       | UC-01    | 普通用户       | -          | -            |

    表 7.7.2-1 角色权限配置

+   权限说明：
    -   C端用户（UC-01）无需配置权限，只能查看自己的记录
    -   安全管理员（UR-03）默认拥有审计查看权限

### 7.7.3 数据权限

+   审计日志的数据权限规则：

    | 用户群   | 角色类型 | 数据范围                     |
    | -------- | -------- | ---------------------------- |
    | provider | 管理员   | 运营用户群全部用户的审计日志 |
    | ur       | 管理员   | 当前租户全部用户的审计日志   |
    | uc       | 普通用户 | 仅自己的登录日志和安全事件   |

    表 7.7.3-1 数据权限规则

+   数据隔离实现方式：
    -   运营用户群数据存储在平台库，查询时无需额外过滤
    -   租户用户群数据存储在租户库，通过数据源路由实现隔离
    -   C端用户查询时强制添加user_id过滤条件

### 7.7.4 菜单配置

+   审计管理的菜单配置：

    | 菜单编码        | 菜单名称 | 上级菜单 | 路由路径                          | 显示条件   |
    | --------------- | -------- | -------- | --------------------------------- | ---------- |
    | M-P-SYS-AUD     | 审计日志 | 系统管理 | -                                 | audit:read |
    | M-P-SYS-AUD-01  | 登录日志 | 审计日志 | /provider/system/login-logs       | audit:read |
    | M-P-SYS-AUD-02  | 操作日志 | 审计日志 | /provider/system/operation-logs   | audit:read |
    | M-P-SYS-AUD-03  | 安全事件 | 审计日志 | /provider/system/security-events  | audit:read |
    | M-UR-SYS-AUD    | 审计日志 | 系统管理 | -                                 | audit:read |
    | M-UR-SYS-AUD-01 | 登录日志 | 审计日志 | /tenant/system/login-logs         | audit:read |
    | M-UR-SYS-AUD-02 | 操作日志 | 审计日志 | /tenant/system/operation-logs     | audit:read |
    | M-UR-SYS-AUD-03 | 安全事件 | 审计日志 | /tenant/system/security-events    | audit:read |
    | M-UC-ACC-AUD    | 账号安全 | 个人中心 | -                                 | 登录即可   |
    | M-UC-ACC-AUD-01 | 登录记录 | 账号安全 | /consumer/account/login-logs      | 登录即可   |
    | M-UC-ACC-AUD-02 | 安全提醒 | 账号安全 | /consumer/account/security-events | 登录即可   |

    表 7.7.4-1 菜单配置

### 7.7.5 接口权限校验

+   各接口的权限校验规则：

    | 接口编号     | 接口路径                                | 权限校验规则               |
    | ------------ | --------------------------------------- | -------------------------- |
    | P-AUD-01~06  | /api/v1/up/iam/audit/**                 | Token有效 + audit:read权限 |
    | UR-AUD-01~06 | /api/v1/ur/iam/audit/**                 | Token有效 + audit:read权限 |
    | UC-AUD-01    | /api/v1/uc/iam/audit/my/login-logs      | Token有效，数据限定为自己  |
    | UC-AUD-02    | /api/v1/uc/iam/audit/my/security-events | Token有效，数据限定为自己  |

    表 7.7.5-1 接口权限校验规则

+   权限校验实现要点：
    -   使用Spring Security注解进行权限校验
    -   管理接口校验audit:read权限
    -   个人接口在Service层强制添加user_id过滤

## 7.8 后端工程结构设计

+   本节设计审计管理子领域的后端工程结构，遵循整体工程的DDD分层架构。
+   审计管理代码位于BC-10用户与权限上下文的iam模块中。

### 7.8.1 工程目录结构

+   审计管理后端工程目录结构如下所示。

    ```
    clarisphere-bc10-iam/
    ├── clarisphere-bc10-iam-domain/                    # 领域层
    │   └── src/main/java/
    │       └── com/clarisphere/bc10/iam/domain/
    │           └── audit/                              # 审计子领域
    │               ├── entity/                         # 实体
    │               │   ├── LoginLog.java               # 登录日志实体
    │               │   ├── OperationLog.java           # 操作日志实体
    │               │   └── SecurityEvent.java          # 安全事件实体
    │               ├── valueobject/                    # 值对象
    │               │   ├── LoginType.java              # 登录方式枚举
    │               │   ├── LoginResult.java            # 登录结果枚举
    │               │   ├── LogLevel.java               # 日志级别枚举
    │               │   ├── SecurityEventType.java      # 安全事件类型枚举
    │               │   ├── Severity.java               # 严重级别枚举
    │               │   ├── ClientInfo.java             # 客户端信息值对象
    │               │   └── Target.java                 # 操作目标值对象
    │               ├── repository/                     # 仓储接口
    │               │   ├── LoginLogRepository.java     # 登录日志仓储
    │               │   ├── OperationLogRepository.java # 操作日志仓储
    │               │   └── SecurityEventRepository.java# 安全事件仓储
    │               └── service/                        # 领域服务
    │                   ├── AuditLogService.java        # 审计日志服务接口
    │                   └── impl/
    │                       └── AuditLogServiceImpl.java# 审计日志服务实现
    │
    ├── clarisphere-bc10-iam-application/               # 应用层
    │   └── src/main/java/
    │       └── com/clarisphere/bc10/iam/application/
    │           └── audit/                              # 审计应用服务
    │               ├── LoginLogAppService.java         # 登录日志应用服务
    │               ├── OperationLogAppService.java     # 操作日志应用服务
    │               ├── SecurityEventAppService.java    # 安全事件应用服务
    │               ├── query/                          # 查询对象
    │               │   ├── LoginLogQuery.java          # 登录日志查询
    │               │   ├── OperationLogQuery.java      # 操作日志查询
    │               │   └── SecurityEventQuery.java     # 安全事件查询
    │               ├── dto/                            # 数据传输对象
    │               │   ├── LoginLogDTO.java            # 登录日志DTO
    │               │   ├── LoginLogDetailDTO.java      # 登录日志详情DTO
    │               │   ├── OperationLogDTO.java        # 操作日志DTO
    │               │   ├── OperationLogDetailDTO.java  # 操作日志详情DTO
    │               │   ├── SecurityEventDTO.java       # 安全事件DTO
    │               │   └── SecurityEventDetailDTO.java # 安全事件详情DTO
    │               ├── assembler/                      # 组装器
    │               │   ├── LoginLogAssembler.java      # 登录日志组装器
    │               │   ├── OperationLogAssembler.java  # 操作日志组装器
    │               │   └── SecurityEventAssembler.java # 安全事件组装器
    │               └── listener/                       # 事件监听器
    │                   ├── SecurityEventListener.java  # 安全事件监听器（16种领域事件→SecurityEvent）
    │                   └── LoginEventListener.java     # 登录事件监听器（MfaVerified→登录日志、SessionTerminated→登录日
    │
    ├── clarisphere-bc10-iam-infrastructure/            # 基础设施层
    │   └── src/main/java/
    │       └── com/clarisphere/bc10/iam/infrastructure/
    │           └── audit/                              # 审计基础设施
    │               ├── repository/                     # 仓储实现
    │               │   ├── LoginLogRepositoryImpl.java
    │               │   ├── OperationLogRepositoryImpl.java
    │               │   └── SecurityEventRepositoryImpl.java
    │               ├── mapper/                         # MyBatis Mapper
    │               │   ├── LoginLogMapper.java
    │               │   ├── OperationLogMapper.java
    │               │   └── SecurityEventMapper.java
    │               ├── converter/                      # 数据转换器
    │               │   ├── LoginLogConverter.java
    │               │   ├── OperationLogConverter.java
    │               │   └── SecurityEventConverter.java
    │               ├── po/                             # 持久化对象
    │               │   ├── LoginLogPO.java
    │               │   ├── OperationLogPO.java
    │               │   └── SecurityEventPO.java
    │               ├── aspect/                         # AOP切面
    │               │   └── OperationLogAspect.java     # 操作日志切面
    │               ├── annotation/                     # 注解
    │               │   └── OperationLog.java           # 操作日志注解
    │               └── job/                            # 定时任务
    │                   └── LogCleanupJob.java          # 日志清理任务
    │
    └── clarisphere-bc10-iam-interfaces/                # 接口层
        └── src/main/java/
            └── com/clarisphere/bc10/iam/interfaces/
                └── audit/                              # 审计接口
                    ├── web/                            # Web控制器
                    │   ├── ProviderAuditController.java    # 运营用户群审计控制器
                    │   ├── TenantAuditController.java      # 租户用户群审计控制器
                    │   └── ConsumerAuditController.java    # C端审计控制器
                    └── vo/                             # 视图对象
                        ├── LoginLogVO.java
                        ├── LoginLogDetailVO.java
                        ├── OperationLogVO.java
                        ├── OperationLogDetailVO.java
                        ├── SecurityEventVO.java
                        └── SecurityEventDetailVO.java
    ```

    图 7.8.1-1 审计管理后端工程目录结构

### 7.8.2 核心类说明

+   审计管理核心类说明如下表所示。

    | 类名                    | 所属层   | 职责说明                                   |
    | ----------------------- | -------- | ------------------------------------------ |
    | LoginLog                | 领域层   | 登录日志聚合根，封装登录日志业务逻辑       |
    | OperationLog            | 领域层   | 操作日志聚合根，封装操作日志业务逻辑       |
    | SecurityEvent           | 领域层   | 安全事件聚合根，封装安全事件业务逻辑       |
    | AuditLogService         | 领域层   | 审计日志领域服务，提供统一记录入口         |
    | LoginLogAppService      | 应用层   | 登录日志应用服务，处理查询编排             |
    | OperationLogAppService  | 应用层   | 操作日志应用服务，处理查询编排             |
    | SecurityEventAppService | 应用层   | 安全事件应用服务，处理查询编排             |
    | SecurityEventListener   | 应用层   | 领域事件监听器，转化为安全事件（16种事件） |
    | LoginEventListener      | 应用层   | 登录事件监听器，处理MFA验证和会话过期日志  |
    | OperationLogAspect      | 基础设施 | AOP切面，自动记录操作日志                  |
    | LogCleanupJob           | 基础设施 | 定时任务，清理过期日志                     |
    | ProviderAuditController | 接口层   | 运营用户群审计RESTful接口                  |
    | TenantAuditController   | 接口层   | 租户用户群审计RESTful接口                  |
    | ConsumerAuditController | 接口层   | C端审计RESTful接口                         |

    表 7.8.2-1 审计管理核心类说明

### 7.8.3 操作日志注解设计

+   @OperationLog注解用于声明式记录操作日志。

#### 7.8.3.1 注解属性

+   @OperationLog注解属性定义：

    | 属性名         | 类型     | 必填 | 默认值 | 说明                       |
    | -------------- | -------- | ---- | ------ | -------------------------- |
    | module         | String   | 是   | -      | 模块：USER/ROLE/ORG等      |
    | operation      | String   | 是   | -      | 操作：CREATE/UPDATE/DELETE |
    | targetType     | String   | 否   | ""     | 目标类型：User/Role等      |
    | targetIdExpr   | String   | 否   | ""     | 目标ID的SpEL表达式         |
    | targetNameExpr | String   | 否   | ""     | 目标名称的SpEL表达式       |
    | level          | LogLevel | 否   | NORMAL | 日志级别                   |
    | recordRequest  | boolean  | 否   | true   | 是否记录请求参数           |

    表 7.8.3.1-1 @OperationLog注解属性

#### 7.8.3.2 使用示例

+   操作日志注解使用示例：

    | 场景         | 注解配置                                                                                                                      |
    | ------------ | ----------------------------------------------------------------------------------------------------------------------------- |
    | 创建用户     | @OperationLog(module="USER", operation="CREATE", targetType="User", targetIdExpr="#result.id", level=IMPORTANT)               |
    | 删除用户     | @OperationLog(module="USER", operation="DELETE", targetType="User", targetIdExpr="#id", level=CRITICAL)                       |
    | 激活用户     | @OperationLog(module="USER", operation="ACTIVATE", targetType="User", targetIdExpr="#userId", level=IMPORTANT)                |
    | 申请注销     | @OperationLog(module="USER", operation="CANCEL_REQUEST", targetType="User", targetIdExpr="#userId", level=CRITICAL)           |
    | 绑定三方账号 | @OperationLog(module="USER", operation="OAUTH_BIND", targetType="User", targetIdExpr="#userId", level=NORMAL)                 |
    | 修改角色     | @OperationLog(module="ROLE", operation="UPDATE", targetType="Role", targetIdExpr="#command.id", level=IMPORTANT)              |
    | 分配权限     | @OperationLog(module="PERMISSION", operation="ASSIGN", targetType="User", targetIdExpr="#userId", level=IMPORTANT)            |
    | 授予数据权限 | @OperationLog(module="DATA_ACCESS", operation="GRANT", targetType="User", targetIdExpr="#userId", level=IMPORTANT)            |
    | 创建岗位     | @OperationLog(module="POSITION", operation="CREATE", targetType="Position", targetIdExpr="#result.id", level=IMPORTANT)       |
    | 停用岗位     | @OperationLog(module="POSITION", operation="DISABLE", targetType="Position", targetIdExpr="#id", level=IMPORTANT)             |
    | 创建人员     | @OperationLog(module="PERSON", operation="CREATE", targetType="Person", targetIdExpr="#result.id", level=IMPORTANT)           |
    | 人员离职     | @OperationLog(module="PERSON", operation="RESIGN", targetType="Person", targetIdExpr="#personId", level=CRITICAL)             |
    | 关联用户     | @OperationLog(module="PERSON", operation="BIND_USER", targetType="Person", targetIdExpr="#personId", level=IMPORTANT)         |
    | 创建任职     | @OperationLog(module="APPOINTMENT", operation="CREATE", targetType="Appointment", targetIdExpr="#result.id", level=IMPORTANT) |
    | 任职调岗     | @OperationLog(module="APPOINTMENT", operation="TRANSFER", targetType="Appointment", targetIdExpr="#id", level=IMPORTANT)      |
    | 组织同步完成 | @OperationLog(module="ORG_SYNC", operation="SYNC_COMPLETE", targetType="Tenant", targetIdExpr="#tenantId", level=IMPORTANT)   |
    | 修改租户配置 | @OperationLog(module="TENANT_CONFIG", operation="UPDATE", targetType="Tenant", targetIdExpr="#tenantCode", level=CRITICAL)    |
    | 重置租户配置 | @OperationLog(module="TENANT_CONFIG", operation="RESET", targetType="Tenant", targetIdExpr="#tenantCode", level=CRITICAL)     |

    表 7.8.3.2-1 操作日志注解使用示例

#### 7.8.3.3 SpEL表达式说明

+   SpEL表达式支持的变量：

    | 变量名  | 说明                     | 示例                   |
    | ------- | ------------------------ | ---------------------- |
    | #result | 方法返回值               | #result.id             |
    | #参数名 | 方法参数                 | #userId, #command.name |
    | #root   | 根对象（方法执行上下文） | #root.methodName       |

    表 7.8.3.3-1 SpEL表达式变量说明

### 7.8.4 AOP切面实现要点

+   OperationLogAspect切面实现要点：

    | 实现要点 | 说明                                    |
    | -------- | --------------------------------------- |
    | 切入点   | @annotation(OperationLog)               |
    | 通知类型 | @Around 环绕通知                        |
    | 执行顺序 | @Order(100) 在事务之后执行              |
    | 异常处理 | 目标方法异常时仍记录日志，result=FAILED |
    | 参数脱敏 | 调用脱敏服务处理敏感字段                |
    | 异步写入 | 日志写入采用异步方式，不阻塞主流程      |
    | SpEL解析 | 使用SpelExpressionParser解析表达式      |

    表 7.8.4-1 AOP切面实现要点

### 7.8.5 定时任务配置

+   日志清理定时任务配置：

    | 配置项       | 配置值         | 说明                         |
    | ------------ | -------------- | ---------------------------- |
    | 任务名称     | logCleanupJob  | 日志清理任务                 |
    | cron表达式   | 0 0 3 \* \* ?  | 每日凌晨3点执行              |
    | 是否允许并发 | false          | 不允许并发执行               |
    | 失败重试次数 | 3              | 失败后重试3次                |
    | 超时时间     | 30分钟         | 单次执行超时时间             |
    | 执行策略     | 遍历所有数据源 | platform+所有tenant+consumer |

    表 7.8.5-1 定时任务配置

### 7.8.6 数据源路由

+   审计日志的数据源路由策略：

    | 场景           | 路由规则                    | 说明                     |
    | -------------- | --------------------------- | ------------------------ |
    | 记录日志       | 根据当前用户的user_pool路由 | 从SecurityContext获取    |
    | 运营用户群查询 | 固定路由到platform库        | clarisphere_platform     |
    | 租户用户群查询 | 根据Token中的tenant_id路由  | clarisphere_t{tenant_id} |
    | C端查询        | 固定路由到consumer库        | clarisphere_consumer     |
    | 日志清理       | 遍历所有数据源              | 逐库清理                 |

    表 7.8.6-1 数据源路由策略

### 7.8.7 MyBatis Mapper配置

+   Mapper XML文件位置：

    | Mapper接口          | XML文件路径                           |
    | ------------------- | ------------------------------------- |
    | LoginLogMapper      | /mapper/audit/LoginLogMapper.xml      |
    | OperationLogMapper  | /mapper/audit/OperationLogMapper.xml  |
    | SecurityEventMapper | /mapper/audit/SecurityEventMapper.xml |

    表 7.8.7-1 Mapper XML配置

+   通用查询方法：

    | 方法名                    | 参数              | 返回值   | 说明             |
    | ------------------------- | ----------------- | -------- | ---------------- |
    | insert()                  | PO对象            | int      | 插入单条记录     |
    | selectById()              | id                | PO对象   | 根据ID查询       |
    | selectByCondition()       | 查询条件          | List<PO> | 条件查询         |
    | countByCondition()        | 查询条件          | long     | 条件统计         |
    | deleteByCreatedAtBefore() | cutoffTime, limit | int      | 批量删除过期数据 |

    表 7.8.7-2 通用Mapper方法

## 7.9 前端工程结构设计

+   本节设计审计管理子领域的前端工程结构。
+   前端采用Vue3 + TypeScript + Element Plus技术栈。

### 7.9.1 工程目录结构

+   审计管理前端工程目录结构如下所示。

    ```
    src/
    ├── views/                                          # 页面视图
    │   ├── provider/                                   # 运营用户群页面
    │   │   └── system/                                 # 系统管理
    │   │       └── audit/                              # 审计管理
    │   │           ├── LoginLogList.vue                # 登录日志列表
    │   │           ├── OperationLogList.vue            # 操作日志列表
    │   │           ├── SecurityEventList.vue           # 安全事件列表
    │   │           └── components/                     # 页面组件
    │   │               ├── LoginLogDetail.vue          # 登录日志详情
    │   │               ├── OperationLogDetail.vue      # 操作日志详情
    │   │               └── SecurityEventDetail.vue     # 安全事件详情
    │   ├── tenant/                                     # 租户用户群页面
    │   │   └── system/
    │   │       └── audit/
    │   │           ├── LoginLogList.vue
    │   │           ├── OperationLogList.vue
    │   │           ├── SecurityEventList.vue
    │   │           └── components/
    │   │               ├── LoginLogDetail.vue
    │   │               ├── OperationLogDetail.vue
    │   │               └── SecurityEventDetail.vue
    │   └── consumer/                                   # C端页面
    │       └── account/
    │           └── audit/
    │               ├── MyLoginLogList.vue              # 我的登录记录
    │               └── MySecurityEventList.vue         # 我的安全事件
    │
    ├── api/                                            # API接口
    │   └── audit/
    │       ├── index.ts                                # 接口导出
    │       ├── loginLog.ts                             # 登录日志接口
    │       ├── operationLog.ts                         # 操作日志接口
    │       └── securityEvent.ts                        # 安全事件接口
    │
    ├── types/                                          # 类型定义
    │   └── audit/
    │       ├── index.ts                                # 类型导出
    │       ├── loginLog.ts                             # 登录日志类型
    │       ├── operationLog.ts                         # 操作日志类型
    │       └── securityEvent.ts                        # 安全事件类型
    │
    ├── composables/                                    # 组合式函数
    │   └── audit/
    │       ├── useLoginLog.ts                          # 登录日志逻辑
    │       ├── useOperationLog.ts                      # 操作日志逻辑
    │       └── useSecurityEvent.ts                     # 安全事件逻辑
    │
    └── constants/                                      # 常量定义
        └── audit/
            ├── loginType.ts                            # 登录方式常量
            ├── loginResult.ts                          # 登录结果常量
            ├── logLevel.ts                             # 日志级别常量
            ├── securityEventType.ts                    # 安全事件类型常量
            └── severity.ts                             # 严重级别常量
    ```

    图 7.9.1-1 审计管理前端工程目录结构

### 7.9.2 路由配置

+   审计管理路由配置：

    | 路由路径                               | 组件                      | 权限       |
    | -------------------------------------- | ------------------------- | ---------- |
    | /provider/system/audit/login-logs      | ProviderLoginLogList      | audit:read |
    | /provider/system/audit/operation-logs  | ProviderOperationLogList  | audit:read |
    | /provider/system/audit/security-events | ProviderSecurityEventList | audit:read |
    | /tenant/system/audit/login-logs        | TenantLoginLogList        | audit:read |
    | /tenant/system/audit/operation-logs    | TenantOperationLogList    | audit:read |
    | /tenant/system/audit/security-events   | TenantSecurityEventList   | audit:read |
    | /consumer/account/login-logs           | MyLoginLogList            | 登录即可   |
    | /consumer/account/security-events      | MySecurityEventList       | 登录即可   |

    表 7.9.2-1 审计管理路由配置

### 7.9.3 API接口封装

+   登录日志API接口定义：

    | 方法名              | HTTP方法 | 路径                   | 说明             |
    | ------------------- | -------- | ---------------------- | ---------------- |
    | getLoginLogList()   | GET      | /audit/login-logs      | 查询登录日志列表 |
    | getLoginLogDetail() | GET      | /audit/login-logs/{id} | 获取登录日志详情 |
    | getMyLoginLogs()    | GET      | /audit/my/login-logs   | 查询我的登录记录 |

    表 7.9.3-1 登录日志API接口

+   操作日志API接口定义：

    | 方法名                  | HTTP方法 | 路径                       | 说明             |
    | ----------------------- | -------- | -------------------------- | ---------------- |
    | getOperationLogList()   | GET      | /audit/operation-logs      | 查询操作日志列表 |
    | getOperationLogDetail() | GET      | /audit/operation-logs/{id} | 获取操作日志详情 |

    表 7.9.3-2 操作日志API接口

+   安全事件API接口定义：

    | 方法名                   | HTTP方法 | 路径                        | 说明             |
    | ------------------------ | -------- | --------------------------- | ---------------- |
    | getSecurityEventList()   | GET      | /audit/security-events      | 查询安全事件列表 |
    | getSecurityEventDetail() | GET      | /audit/security-events/{id} | 获取安全事件详情 |
    | getMySecurityEvents()    | GET      | /audit/my/security-events   | 查询我的安全事件 |

    表 7.9.3-3 安全事件API接口

### 7.9.4 类型定义

+   登录日志类型定义：

    | 类型名         | 用途     | 主要字段                                                  |
    | -------------- | -------- | --------------------------------------------------------- |
    | LoginLogQuery  | 查询参数 | username, loginResult, loginType, timeRange               |
    | LoginLogVO     | 列表展示 | id, username, loginType, loginResult, clientIp, createdAt |
    | LoginLogDetail | 详情展示 | 包含所有字段                                              |

    表 7.9.4-1 登录日志类型定义

+   操作日志类型定义：

    | 类型名             | 用途     | 主要字段                                                             |
    | ------------------ | -------- | -------------------------------------------------------------------- |
    | OperationLogQuery  | 查询参数 | username, module, operation, logLevel, timeRange                     |
    | OperationLogVO     | 列表展示 | id, username, module, operation, target, logLevel, result, createdAt |
    | OperationLogDetail | 详情展示 | 包含所有字段，含requestData                                          |

    表 7.9.4-2 操作日志类型定义

+   安全事件类型定义：

    | 类型名              | 用途     | 主要字段                                                |
    | ------------------- | -------- | ------------------------------------------------------- |
    | SecurityEventQuery  | 查询参数 | username, eventType, severity, timeRange                |
    | SecurityEventVO     | 列表展示 | id, username, eventType, severity, eventDesc, createdAt |
    | SecurityEventDetail | 详情展示 | 包含所有字段，含eventData                               |

    表 7.9.4-3 安全事件类型定义

### 7.9.5 常量定义

+   登录方式常量：

    | 常量值       | 显示文本 | 标签颜色 |
    | ------------ | -------- | -------- |
    | PASSWORD     | 密码登录 | 默认     |
    | SMS_CODE     | 短信登录 | 蓝色     |
    | EMAIL_CODE   | 邮箱登录 | 蓝色     |
    | OAUTH_WECHAT | 微信登录 | 绿色     |
    | OAUTH_QQ     | QQ登录   | 蓝色     |
    | SSO          | 企业SSO  | 紫色     |
    | SCAN_CODE    | 扫码登录 | 橙色     |

    表 7.9.5-1 登录方式常量

+   登录结果常量：

    | 常量值  | 显示文本 | 标签颜色 | 图标     |
    | ------- | -------- | -------- | -------- |
    | SUCCESS | 成功     | 绿色     | 成功图标 |
    | FAILED  | 失败     | 红色     | 失败图标 |
    | LOGOUT  | 登出     | 灰色     | 退出图标 |
    | REFRESH | 刷新     | 蓝色     | 刷新图标 |
    | KICKED  | 踢出     | 橙色     | 警告图标 |
    | EXPIRED | 过期     | 灰色     | 时钟图标 |

    表 7.9.5-2 登录结果常量

+   日志级别常量：

    | 常量值    | 显示文本 | 标签颜色 |
    | --------- | -------- | -------- |
    | NORMAL    | 普通     | 灰色     |
    | IMPORTANT | 重要     | 蓝色     |
    | CRITICAL  | 关键     | 红色     |

    表 7.9.5-3 日志级别常量

+   严重级别常量：

    | 常量值 | 显示文本 | 标签颜色 | 图标     |
    | ------ | -------- | -------- | -------- |
    | INFO   | 信息     | 蓝色     | 信息图标 |
    | WARN   | 警告     | 橙色     | 警告图标 |
    | HIGH   | 高危     | 红色     | 危险图标 |

    表 7.9.5-4 严重级别常量

### 7.9.6 组件复用

+   审计管理可复用组件：

    | 组件名称        | 用途             | 复用场景                 |
    | --------------- | ---------------- | ------------------------ |
    | AuditSearchForm | 审计日志搜索表单 | 各类日志列表页           |
    | AuditTable      | 审计日志表格     | 登录、操作、安全事件列表 |
    | LogLevelTag     | 日志级别标签     | 操作日志列表             |
    | SeverityTag     | 严重级别标签     | 安全事件列表             |
    | LoginResultTag  | 登录结果标签     | 登录日志列表             |
    | DetailDrawer    | 详情抽屉组件     | 各类日志详情展示         |
    | TimeRangePicker | 时间范围选择器   | 搜索表单                 |

    表 7.9.6-1 可复用组件清单

### 7.9.7 运营用户群与租户用户群组件复用

+   运营用户群与租户用户群页面结构相同，通过以下方式实现复用：

    | 复用策略      | 说明                               |
    | ------------- | ---------------------------------- |
    | 共享组件      | 搜索表单、表格、详情弹窗等组件共享 |
    | API前缀参数化 | 通过props传入不同的API前缀         |
    | 路由元信息    | 通过route.meta区分用户群           |
    | 权限指令      | 使用相同的权限码audit:read         |

    表 7.9.7-1 组件复用策略

## 7.10 V2.0扩展规划

+   本节描述审计管理V2.0版本的扩展规划，供后续迭代参考。

### 7.10.1 功能扩展

+   V2.0计划新增功能：

    | 功能分类 | 功能名称     | 功能说明                     | 优先级 |
    | -------- | ------------ | ---------------------------- | ------ |
    | 异常检测 | 异地登录检测 | 检测与常用地点不同的登录行为 | P1     |
    | 异常检测 | 高频登录检测 | 检测短时间内的高频登录尝试   | P1     |
    | 异常检测 | 异常时间登录 | 检测非工作时间的登录行为     | P2     |
    | 异常检测 | 新设备登录   | 检测从新设备的首次登录       | P2     |
    | 统计分析 | 登录趋势统计 | 按天/周/月统计登录次数趋势   | P1     |
    | 统计分析 | 登录失败分析 | 分析登录失败原因分布         | P1     |
    | 统计分析 | 操作热力图   | 展示操作时间和类型的热力分布 | P2     |
    | 统计分析 | 用户活跃度   | DAU/MAU统计和趋势分析        | P2     |
    | 报表导出 | Excel导出    | 导出审计日志为Excel格式      | P1     |
    | 报表导出 | PDF报告      | 生成PDF格式的审计报告        | P2     |
    | 告警通知 | 邮件告警     | 高危事件触发邮件通知         | P1     |
    | 告警通知 | 短信告警     | 关键安全事件触发短信通知     | P2     |
    | 告警通知 | 企业IM告警   | 集成钉钉/企微推送告警        | P2     |
    | 合规支持 | 操作前后对比 | 记录操作前后的数据变化       | P1     |
    | 合规支持 | 审计报告模板 | 提供符合等保要求的报告模板   | P2     |

    表 7.10.1-1 V2.0功能扩展规划

### 7.10.2 技术优化

+   V2.0计划技术优化：

    | 优化方向 | 优化内容                  | 预期效果             |
    | -------- | ------------------------- | -------------------- |
    | 存储优化 | 引入Elasticsearch存储日志 | 提升大数据量查询性能 |
    | 存储优化 | 冷热数据分离              | 降低存储成本         |
    | 写入优化 | 消息队列异步写入          | 提升写入吞吐量       |
    | 查询优化 | 多维度聚合索引            | 支持复杂统计分析     |
    | 高可用   | 日志写入故障降级          | 保障业务不受影响     |

    表 7.10.2-1 V2.0技术优化规划

# 8 共享服务

+   本章对第2.7.4节列出的5个共享服务进行详细设计。
+   共享服务不属于任何单一子领域，而是被多个子领域复用的基础能力。
+   各服务的方法签名已分别出现在第3章（PasswordService）、第5章（TokenService、SessionService、VerificationCodeService、ConfigService）和第6章（PermissionLoader相关），本章将其汇总并补充跨子领域视角的设计约束与实现要点。

> **关于审计日志**：AuditLogService属于第7章审计管理子领域的领域服务，其他子领域通过领域事件或跨子领域调用使用审计能力，不纳入共享服务范畴。

## 8.1 共享服务总览

### 8.1.1 共享服务定位

+   共享服务位于子领域服务层与基础设施层之间，向上为四个子领域提供通用能力，向下依赖基础设施层的Redis、数据源路由等组件。
+   共享服务的核心设计原则如下表所示。

    | 原则         | 说明                                                                 |
    | ------------ | -------------------------------------------------------------------- |
    | 无状态       | 共享服务本身不持有业务状态，状态由调用方或基础设施层（Redis/DB）管理 |
    | 无副作用扩散 | 服务内部异常不向调用方传播业务异常以外的技术异常                     |
    | 可独立测试   | 每个共享服务可脱离子领域上下文进行单元测试                           |
    | 配置驱动     | 行为差异通过配置项（而非代码分支）控制                               |
    | 面向接口     | 调用方依赖接口，不依赖实现类，便于替换和测试                         |

    表 8.1.1-1 共享服务设计原则

### 8.1.2 共享服务与子领域关系

+   各共享服务的使用方及调用方向如下表所示。

    | 共享服务         | 用户管理 | 认证管理 | 授权管理 | 审计管理 | 调用场景                      |
    | ---------------- | :------: | :------: | :------: | :------: | ----------------------------- |
    | TokenService     |          |    ✓     |          |          | 登录签发、刷新、登出撤销      |
    | PasswordService  |    ✓     |    ✓     |          |          | 用户创建/改密、登录密码验证   |
    | CaptchaService   |    ✓     |    ✓     |          |          | 注册验证码、登录验证码        |
    | MfaService       |          |    ✓     |          |          | 双因素认证、MFA设备管理       |
    | PermissionLoader |          |          |    ✓     |          | 启动/刷新时加载权限资源点定义 |

    表 8.1.2-1 共享服务与子领域调用矩阵

### 8.1.3 代码包结构

+   共享服务统一位于 `com.clarisphere.iam.shared` 包下，各服务独占子包。

    | 包路径                                | 说明         |
    | ------------------------------------- | ------------ |
    | com.clarisphere.iam.shared            | 共享服务根包 |
    | com.clarisphere.iam.shared.token      | Token服务    |
    | com.clarisphere.iam.shared.password   | 密码服务     |
    | com.clarisphere.iam.shared.captcha    | 验证码服务   |
    | com.clarisphere.iam.shared.mfa        | MFA服务      |
    | com.clarisphere.iam.shared.permission | 权限加载服务 |

    表 8.1.3-1 共享服务包结构

## 8.2 TokenService

### 8.2.1 职责说明

+   TokenService负责JWT令牌的签发、验证、刷新和撤销。
+   该服务在第5章认证管理子领域中被定义为领域服务（5.3.12.2节），本节补充跨子领域视角的设计约束。

### 8.2.2 方法定义

+   TokenService方法如下表所示（完整定义见表5.3.12.2-1）。

    | 方法                | 参数                        | 返回值      | 说明               |
    | ------------------- | --------------------------- | ----------- | ------------------ |
    | issueTokens         | userId, context, deviceInfo | TokenPair   | 签发令牌对         |
    | refreshAccessToken  | refreshToken                | TokenPair   | 刷新访问令牌       |
    | revokeToken         | tokenId, reason             | void        | 撤销令牌           |
    | revokeAllUserTokens | userId, reason              | void        | 撤销用户所有令牌   |
    | validateAccessToken | accessToken                 | TokenClaims | 验证访问令牌       |
    | isTokenRevoked      | tokenId                     | boolean     | 检查令牌是否已撤销 |

    表 8.2.2-1 TokenService方法

### 8.2.3 设计约束

+   TokenService的设计约束如下。
    -   **令牌结构**：AccessToken采用JWT（Header.Payload.Signature），Payload中包含sub（userId）、user_pool、tenant_code、tenant_id（UR用户群时存在）、username、session_id、jti（tokenId）、iat、exp字段，不含roles等易变信息（见AT-R-05）
    -   **签名算法**：采用RS256非对称签名，密钥对由基础设施层SecurityComponent提供
    -   **令牌有效期**：AccessToken有效期按用户群差异化（UP=15分钟，UR=30分钟，UC=2小时，见AT-R-06），RefreshToken默认7天；具体值通过ConfigService读取，支持租户级覆盖
    -   **黑名单机制**：令牌撤销后将tokenId写入Redis黑名单，TTL等于该令牌原始过期时间；validateAccessToken时检查黑名单
    -   **并发安全**：refreshAccessToken采用Redis原子操作（SETNX）防止同一RefreshToken被并发刷新多次

### 8.2.4 Redis数据结构

+   TokenService使用的Redis键如下表所示（与5.5.4节保持一致）。

    | 键模式                         | 类型   | TTL           | 说明               |
    | ------------------------------ | ------ | ------------- | ------------------ |
    | iam:token:refresh:{tokenId}    | String | 7天（可配置） | RefreshToken元数据 |
    | iam:token:blacklist:{tokenId}  | String | 等于原始过期  | 撤销黑名单         |
    | iam:token:user_tokens:{userId} | Set    | 无过期        | 用户令牌集合       |

    表 8.2.4-1 TokenService Redis键

## 8.3 PasswordService

### 8.3.1 职责说明

+   PasswordService负责密码加密、密码强度校验和密码历史检查。
+   该服务在第3章用户管理子领域中被定义为领域服务（3.3.6.2节），本节补充跨子领域视角的设计约束。

### 8.3.2 方法定义

+   PasswordService方法如下表所示（完整定义见表3.3.6.2-1）。

    | 方法名               | 参数                | 返回值    | 说明                     |
    | -------------------- | ------------------- | --------- | ------------------------ |
    | hashPassword         | plainPassword       | hash+salt | 密码加密                 |
    | verifyPassword       | plainPassword, hash | boolean   | 验证密码                 |
    | checkPasswordPolicy  | password, policy    | result    | 检查密码策略             |
    | checkPasswordHistory | userId, newPassword | boolean   | 检查密码历史（不可重复） |

    表 8.3.2-1 PasswordService方法

    +   注：密码重置验证码的发送与校验由CaptchaService（8.4节）的sendSmsCode()/sendEmailCode()/verifyCode()方法负责，PasswordService不再包含重置令牌相关方法。

### 8.3.3 设计约束

+   PasswordService的设计约束如下。
    -   **哈希算法选择**：供给侧（UP）和租户用户群（UR）使用Argon2id，C端用户群（UC）使用BCrypt；算法选择通过userPool参数自动路由
    -   **Argon2id参数**：memory=65536KB, iterations=3, parallelism=4；参数在配置中心管理，可随硬件升级调整
    -   **BCrypt参数**：cost=12；选择BCrypt是因为C端用户量大，Argon2id的内存开销过高
    -   **密码策略**：最小长度、必须包含字符类型（大写/小写/数字/特殊字符）、不可与用户名相同等规则通过PasswordPolicy值对象封装，具体值由ConfigService读取
    -   **密码历史**：默认保留最近5次密码的哈希，新密码不可与历史密码重复；历史条数通过ConfigService可配置
    -   **密码重置验证码**：密码重置流程已改为验证码机制，验证码的发送、有效期（15分钟）、频率限制（60秒间隔）等约束由CaptchaService（8.4节）统一管理

### 8.3.4 跨子领域调用场景

+   PasswordService被两个子领域调用，调用场景如下表所示。

    | 调用方   | 调用方法             | 场景                         |
    | -------- | -------------------- | ---------------------------- |
    | 用户管理 | hashPassword         | 创建用户时加密初始密码       |
    | 用户管理 | checkPasswordPolicy  | 创建/改密/激活时校验密码强度 |
    | 用户管理 | checkPasswordHistory | 改密时检查是否与历史密码重复 |
    | 认证管理 | verifyPassword       | 密码登录时验证密码正确性     |

    表 8.3.4-1 PasswordService跨子领域调用场景

    +   注：密码重置和账号激活的验证码发送/校验场景已迁移至CaptchaService（8.4节），具体调用关系见表8.4.5-1。

## 8.4 CaptchaService

### 8.4.1 职责说明

+   CaptchaService负责图形验证码、短信验证码和邮件验证码的生成、发送与校验。
+   该服务在第5章认证管理子领域中以VerificationCodeService名称出现（5.3.12.4节）。VerificationCodeService聚焦于验证码的领域行为（发送、校验），CaptchaService在此基础上增加图形验证码能力和频率限制。

### 8.4.2 方法定义

+   CaptchaService方法如下表所示。

    | 方法                 | 参数                   | 返回值        | 说明                |
    | -------------------- | ---------------------- | ------------- | ------------------- |
    | generateImageCaptcha | width, height          | CaptchaResult | 生成图形验证码      |
    | verifyImageCaptcha   | captchaId, userInput   | boolean       | 校验图形验证码      |
    | sendSmsCode          | mobile, scene, context | SendResult    | 发送短信验证码      |
    | sendEmailCode        | email, scene, context  | SendResult    | 发送邮件验证码      |
    | verifyCode           | target, code, scene    | boolean       | 校验短信/邮件验证码 |
    | checkSendLimit       | target, scene          | boolean       | 检查发送频率限制    |

    表 8.4.2-1 CaptchaService方法

### 8.4.3 设计约束

+   CaptchaService的设计约束如下。
    -   **图形验证码**：采用随机字符+干扰线方式生成，有效期5分钟，校验后立即失效
    -   **短信验证码**：6位数字，有效期5分钟，同一手机号同一场景60秒内不可重发，24小时内同一手机号最多发送10条
    -   **邮件验证码**：6位数字，有效期15分钟，同一邮箱同一场景60秒内不可重发
    -   **场景隔离**：验证码按场景（scene）隔离，登录场景的验证码不可用于注册场景
    -   **外部依赖**：短信发送通过BC-12（通知上下文）的防腐层Gateway调用，CaptchaService不直接对接短信供应商
    -   **验证码存储**：所有验证码存储在Redis，不落库

### 8.4.4 Redis数据结构

+   CaptchaService使用的Redis键如下表所示（与5.5.4.4节保持一致）。

    | 键模式                             | 类型   | TTL      | 说明            |
    | ---------------------------------- | ------ | -------- | --------------- |
    | iam:captcha:image:{captchaId}      | String | 5分钟    | 图形验证码答案  |
    | iam:captcha:code:{scene}:{target}  | String | 5~15分钟 | 短信/邮件验证码 |
    | iam:captcha:limit:{scene}:{target} | String | 60秒     | 发送间隔限制    |
    | iam:captcha:daily:{target}         | String | 24小时   | 每日发送计数    |

    表 8.4.4-1 CaptchaService Redis键

### 8.4.5 跨子领域调用场景

+   CaptchaService被两个子领域调用，调用场景如下表所示。

    | 调用方   | 调用方法             | 场景                         |
    | -------- | -------------------- | ---------------------------- |
    | 认证管理 | generateImageCaptcha | 登录页面展示图形验证码       |
    | 认证管理 | verifyImageCaptcha   | 登录时校验图形验证码         |
    | 认证管理 | sendSmsCode          | 短信登录、双因素验证         |
    | 认证管理 | verifyCode           | 校验登录/双因素验证码        |
    | 用户管理 | sendSmsCode          | 手机号注册发送验证码         |
    | 用户管理 | sendEmailCode        | 邮箱注册、密码重置发送验证码 |
    | 用户管理 | verifyCode           | 注册/密码重置时校验验证码    |

    表 8.4.5-1 CaptchaService跨子领域调用场景

## 8.5 MfaService

### 8.5.1 职责说明

+   MfaService负责多因素认证（MFA）的设备绑定、解绑和TOTP验证。
+   当前版本仅支持TOTP（基于时间的一次性密码），V2.0规划支持WebAuthn/FIDO2。

### 8.5.2 方法定义

+   MfaService方法如下表所示。

    | 方法                | 参数                     | 返回值       | 说明                      |
    | ------------------- | ------------------------ | ------------ | ------------------------- |
    | generateSecret      | userId                   | MfaSetupInfo | 生成TOTP密钥和二维码      |
    | confirmBinding      | userId, totpCode         | boolean      | 确认绑定（首次验证）      |
    | verifyTotp          | userId, totpCode         | boolean      | 验证TOTP码                |
    | unbindDevice        | userId, verificationCode | void         | 解绑MFA设备               |
    | isUserMfaEnabled    | userId                   | boolean      | 查询用户MFA启用状态       |
    | generateBackupCodes | userId                   | List<String> | 生成备用恢复码            |
    | verifyBackupCode    | userId, backupCode       | boolean      | 验证备用恢复码            |
    | revokeMfaDevice     | userId, reason           | void         | 管理员强制解除用户MFA绑定 |

    表 8.5.2-1 MfaService方法

### 8.5.3 设计约束

+   MfaService的设计约束如下。
    -   **TOTP标准**：遵循RFC 6238，时间步长30秒，允许前后各1个时间窗口偏移
    -   **密钥存储**：TOTP密钥采用AES-256-GCM加密后存储在数据库，加密密钥由基础设施层SecurityComponent管理
    -   **备用恢复码**：生成8个一次性备用恢复码，每个恢复码仅可使用一次；恢复码哈希后存储
    -   **强制MFA**：平台管理员（admin类型）默认必须启用MFA，通过ConfigService读取配置控制
    -   **绑定流程**：generateSecret生成密钥 → 用户用Authenticator扫码 → confirmBinding验证首次TOTP码 → 绑定成功
    -   **安全策略**：连续5次TOTP验证失败锁定MFA验证15分钟

### 8.5.4 Redis数据结构

+   MfaService使用的Redis键如下表所示。

    | 键模式                      | 类型   | TTL    | 说明                 |
    | --------------------------- | ------ | ------ | -------------------- |
    | iam:mfa:setup:{userId}      | String | 10分钟 | 绑定过程中暂存的密钥 |
    | iam:mfa:fail_count:{userId} | String | 15分钟 | TOTP连续失败计数     |

    表 8.5.4-1 MfaService Redis键

## 8.6 PermissionLoader

### 8.6.1 职责说明

+   PermissionLoader负责从平台库（clarisphere_platform）加载权限资源点定义，并缓存到内存或Redis中供授权管理子领域使用。
+   权限资源点定义统一存储在平台库，所有用户群共享同一套权限定义（见2.5.2节）。

### 8.6.2 方法定义

+   PermissionLoader方法如下表所示。

    | 方法                    | 参数           | 返回值              | 说明                   |
    | ----------------------- | -------------- | ------------------- | ---------------------- |
    | loadAllPermissions      | -              | List<PermissionDef> | 加载全部权限资源点定义 |
    | loadPermissionsByModule | moduleCode     | List<PermissionDef> | 按模块加载权限定义     |
    | refreshCache            | -              | void                | 强制刷新缓存           |
    | getPermission           | permissionCode | PermissionDef       | 按编码获取单个权限定义 |
    | isPermissionValid       | permissionCode | boolean             | 检查权限编码是否有效   |

    表 8.6.2-1 PermissionLoader方法

### 8.6.3 设计约束

+   PermissionLoader的设计约束如下。
    -   **加载时机**：应用启动时全量加载，运行期通过定时任务（每5分钟）或管理接口触发增量刷新
    -   **缓存策略**：采用本地缓存（Caffeine）+ Redis二级缓存；本地缓存TTL 5分钟，Redis缓存TTL 30分钟
    -   **数据源**：固定读取平台库（clarisphere_platform），不受租户数据源路由影响
    -   **权限定义格式**：每个PermissionDef包含permissionCode、permissionName、module、resourceType（MENU/BUTTON/API）、parentCode等字段
    -   **一致性保障**：权限定义变更后，管理员通过运维接口调用refreshCache刷新全集群缓存

### 8.6.4 缓存数据结构

+   PermissionLoader使用的缓存键如下表所示。

    | 缓存层 | 键模式                             | TTL    | 说明                   |
    | ------ | ---------------------------------- | ------ | ---------------------- |
    | 本地   | permission_all                     | 5分钟  | 全量权限定义列表       |
    | 本地   | permission:{permissionCode}        | 5分钟  | 单个权限定义           |
    | Redis  | iam:permission:all                 | 30分钟 | 全量权限定义（序列化） |
    | Redis  | iam:permission:module:{moduleCode} | 30分钟 | 模块级权限定义         |

    表 8.6.4-1 PermissionLoader缓存键

## 8.7 共享服务依赖关系

### 8.7.1 共享服务间依赖

+   共享服务之间也存在依赖关系，如下表所示。

    | 调用方          | 被调用方      | 说明                                 |
    | --------------- | ------------- | ------------------------------------ |
    | TokenService    | ConfigService | 读取令牌有效期、签名算法等配置       |
    | PasswordService | ConfigService | 读取密码策略（最小长度、历史条数等） |
    | CaptchaService  | ConfigService | 读取验证码发送间隔、每日上限等配置   |
    | MfaService      | ConfigService | 读取MFA强制策略、TOTP时间窗口偏移    |

    表 8.7.1-1 共享服务间依赖关系

### 8.7.2 依赖关系图

+   共享服务与配置管理子领域的依赖关系如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────────┐
    │                  共享服务 → 配置管理子领域 依赖关系                  │
    ├──────────────────────────────────────────────────────────────────────┤
    │                                                                      │
    │   ┌───────────────┐                                                  │
    │   │ TokenService  │──────┐                                           │
    │   └───────────────┘      │                                           │
    │                          │   ┌────────────────────────────────────┐  │
    │   ┌───────────────┐      │   │  配置管理子领域（第9章）           │  │
    │   │PasswordService│──────┼──▶│  ┌───────────────┐                 │  │
    │   └───────────────┘      │   │  │ ConfigService │                 │  │
    │                          │   │  └───────────────┘                 │  │
    │   ┌───────────────┐      │   │  SystemConfig / TenantConfig       │  │
    │   │CaptchaService │──────┤   └────────────────────────────────────┘  │
    │   └───────────────┘      │                                           │
    │                          │                                           │
    │   ┌───────────────┐      │                                           │
    │   │  MfaService   │──────┘                                           │
    │   └───────────────┘                                                  │
    │                                                                      │
    │   ┌───────────────┐                                                  │
    │   │PermissionLoader  （无跨子领域依赖）                              │
    │   └───────────────┘                                                  │
    │                                                                      │
    └──────────────────────────────────────────────────────────────────────┘
    ```

    图 8.7.2-1 共享服务依赖关系图

+   **循环依赖防范**：ConfigService属于配置管理子领域，作为最底层的配置提供方，不依赖任何共享服务。PermissionLoader完全独立，无任何跨子领域依赖。

## 8.8 V2.0扩展规划

### 8.8.1 功能扩展

+   V2.0计划的共享服务功能扩展如下表所示。

    | 服务             | 扩展内容             | 说明                                      |
    | ---------------- | -------------------- | ----------------------------------------- |
    | TokenService     | 支持设备绑定令牌     | 令牌与设备指纹绑定，防止令牌被盗用        |
    | PasswordService  | 支持密码泄露检测     | 对接HaveIBeenPwned等服务检测已泄露密码    |
    | CaptchaService   | 支持行为验证码       | 引入滑块、拼图等行为验证方式              |
    | MfaService       | 支持WebAuthn/FIDO2   | 支持硬件安全密钥和平台认证器              |
    | PermissionLoader | 支持动态权限定义     | 运行时通过管理界面新增权限资源点          |
    | ConfigService    | 支持配置变更实时推送 | 通过WebSocket或长轮询实现配置变更实时生效 |

    表 8.8.1-1 V2.0功能扩展规划

### 8.8.2 技术优化

+   V2.0计划的共享服务技术优化如下表所示。

    | 优化方向 | 优化内容                             | 预期效果                   |
    | -------- | ------------------------------------ | -------------------------- |
    | 统一监控 | 共享服务方法级别的调用计数和耗时监控 | 及时发现性能瓶颈           |
    | 熔断降级 | CaptchaService外部短信通道熔断       | 短信通道故障不影响其他流程 |
    | 缓存预热 | PermissionLoader启动时全量预热       | 避免首次请求缓存穿透       |
    | 配置审计 | ConfigService配置变更记录审计日志    | 配置变更可追溯             |

    表 8.8.2-1 V2.0技术优化规划

# 9 配置管理

+   本章详细设计配置管理子领域，包括业务场景、业务流程、领域模型、接口设计和数据模型。
+   配置管理负责管理"按什么规则运行"，核心职责包括系统配置管理、租户配置管理、配置优先级合并。
+   配置管理是认证、用户管理、授权管理三个子领域的基础支撑，通过三级优先级合并机制（系统配置 → 租户配置 → 用户类型配置）为各子领域提供参数化能力。

## 9.0 职责与边界

### 9.0.1 职责范围

+   配置管理子领域的职责范围如下表所示。

    | 职责分类       | 具体职责                                   | 管理者        |
    | -------------- | ------------------------------------------ | ------------- |
    | 系统配置管理   | 平台级默认参数的查看、编辑、重置           | 平台管理员    |
    | 租户配置管理   | 租户级参数覆盖的查看、编辑、重置为系统默认 | 租户管理员    |
    | 配置优先级合并 | 系统 → 租户 → 用户类型的三级合并读取       | ConfigService |
    | 配置审计       | 配置变更记录审计日志                       | 系统自动      |

    表 9.0.1-1 职责范围

### 9.0.2 职责边界

+   配置管理只负责"配置参数"的存储和读取，不负责具体业务逻辑的执行。
+   认证策略的执行属于认证子领域，密码策略的校验属于用户管理子领域。
+   配置管理提供 ConfigService 作为共享服务供其他子领域调用。

## 9.1 业务流程设计

### 9.1.1 平台管理员管理系统配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    平台管理员管理系统配置流程                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────┐                                                              │
│    │  开始   │                                                              │
│    └────┬────┘                                                              │
│         │                                                                   │
│         ▼                                                                   │
│    ┌─────────────────────────────┐                                          │
│    │ 平台管理员进入"系统配置"页面│                                          │
│    └──────────────┬──────────────┘                                          │
│                   │                                                         │
│                   ▼                                                         │
│    ┌─────────────────────────────┐                                          │
│    │ 选择配置分类（Tab切换）     │                                          │
│    │ 认证通用/短信/密码策略/会话 │                                          │
│    └──────────────┬──────────────┘                                          │
│                   │                                                         │
│                   ▼                                                         │
│    ┌─────────────────────────────┐                                          │
│    │ 加载该分类下的配置项列表    │                                          │
│    │ 显示：键名/当前值/说明      │                                          │
│    └──────────────┬──────────────┘                                          │
│                   │                                                         │
│              ┌────┴────┐                                                    │
│              ▼         ▼                                                    │
│    ┌──────────────┐  ┌──────────────┐                                       │
│    │ 编辑配置值   │  │ 查看配置详情 │                                       │
│    └──────┬───────┘  └──────────────┘                                       │
│           │                                                                 │
│           ▼                                                                 │
│    ┌─────────────────────────────┐                                          │
│    │ 类型校验 + 不可编辑检查     │                                          │
│    └──────────────┬──────────────┘                                          │
│             通过  │  不通过→提示错误                                        │
│                   ▼                                                         │
│    ┌─────────────────────────────┐                                          │
│    │ 保存配置值                  │                                          │
│    │ 清除缓存、记录审计日志      │                                          │
│    │ 发布 SystemConfigChanged    │                                          │
│    └──────────────┬──────────────┘                                          │
│                   │                                                         │
│                   ▼                                                         │
│              ┌─────────┐                                                    │
│              │  结束   │                                                    │
│              └─────────┘                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

图 9.1.1-1 平台管理员管理系统配置流程

### 9.1.2 租户管理员管理租户配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    租户管理员管理租户配置流程                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────┐                                                              │
│    │  开始   │                                                              │
│    └────┬────┘                                                              │
│         │                                                                   │
│         ▼                                                                   │
│    ┌─────────────────────────────┐                                          │
│    │ 租户管理员进入"安全设置"页面│                                          │
│    └──────────────┬──────────────┘                                          │
│                   │                                                         │
│                   ▼                                                         │
│    ┌─────────────────────────────────────────────┐                          │
│    │ 加载当前租户配置（含系统默认值标记）        │                          │
│    │ 显示：配置项/当前值/系统默认值/是否已覆盖   │                          │
│    └──────────────┬──────────────────────────────┘                          │
│                   │                                                         │
│         ┌────────┬┴───────┐                                                 │
│         ▼        ▼        ▼                                                 │
│    ┌─────────┐ ┌────────┐ ┌──────────────┐                                  │
│    │编辑配置 │ │重置为  │ │按用户类型    │                                  │
│    │值       │ │系统默认│ │设置差异化配置│                                  │
│    └────┬────┘ └───┬────┘ └──────┬───────┘                                  │
│         │          │             │                                          │
│         ▼          ▼             ▼                                          │
│    ┌─────────────────────────────────────────────┐                          │
│    │ 安全下限校验（如密码长度不低于6）           │                          │
│    │ 类型校验 + 保存 + 清除缓存                  │                          │
│    │ 记录审计日志（含操作者）                    │                          │
│    │ 发布 TenantConfigChanged / TenantConfigReset│                          │
│    └──────────────┬──────────────────────────────┘                          │
│                   │                                                         │
│                   ▼                                                         │
│    ┌─────────┐                                                              │
│    │  结束   │                                                              │
│    └─────────┘                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

图 9.1.2-1 租户管理员管理租户配置流程

## 9.2 领域模型设计

### 9.2.1 聚合划分

+   配置管理子领域包含两个聚合，结构如下表所示。

    | 聚合名称     | 聚合根       | 存储位置                           | 核心职责           |
    | ------------ | ------------ | ---------------------------------- | ------------------ |
    | SystemConfig | SystemConfig | 平台库（clarisphere_platform）     | 平台级系统配置管理 |
    | TenantConfig | TenantConfig | 租户库（clarisphere_t{tenant_id}） | 租户级配置覆盖管理 |

    表 9.2.1-1 聚合结构总览

### 9.2.2 SystemConfig 聚合

#### 9.2.2.1 聚合结构

+   SystemConfig聚合包含以下元素：

    | 元素类型 | 元素名称     | 说明         |
    | -------- | ------------ | ------------ |
    | 聚合根   | SystemConfig | 系统配置实体 |

    表 9.2.2.1-1 SystemConfig聚合结构

#### 9.2.2.2 SystemConfig 实体

+   SystemConfig是聚合根，管理平台级系统配置，采用三表模型定义如下。

##### 属性清单表

| 属性名      | 类型          | 必填 | 约束                                                         | 默认值   | 业务含义                                |
| ----------- | ------------- | ---- | ------------------------------------------------------------ | -------- | --------------------------------------- |
| id          | Long          | 是   | BIGINT，自增主键                                             | 系统生成 | 配置记录唯一标识                        |
| configKey   | String        | 是   | 1-128字符，点号分隔，全局唯一                                | -        | 配置键名，如auth.password.minLength     |
| configValue | String        | 是   | ≤2000字符                                                    | -        | 配置值，统一存储为字符串                |
| configType  | ConfigType    | 是   | 枚举：STRING/NUMBER/BOOLEAN/JSON/ENCRYPTED                   | STRING   | 配置值类型，决定前端渲染方式和校验规则  |
| category    | String        | 是   | 1-64字符，如AUTH_GENERAL/AUTH_SMS/AUTH_PASSWORD/AUTH_SESSION | -        | 配置分类，用于Tab分组展示               |
| description | String        | 是   | ≤256字符                                                     | -        | 配置说明，面向管理员的可读描述          |
| isEncrypted | Boolean       | 是   | -                                                            | false    | 是否加密存储，加密项列表脱敏显示"*****" |
| isEditable  | Boolean       | 是   | -                                                            | true     | 是否允许编辑，系统内置项设为false       |
| sortOrder   | Integer       | 是   | ≥0                                                           | 0        | 同分类内排序序号                        |
| createdAt   | LocalDateTime | 是   | 不可变                                                       | NOW()    | 创建时间，审计用途                      |
| updatedAt   | LocalDateTime | 是   | -                                                            | NOW()    | 更新时间，审计用途                      |

表 9.2.2.2-1 SystemConfig属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 简述                                                          | 验证时机  | 违反后果                    |
| -------- | ------------ | ------------------------------------------------------------- | --------- | --------------------------- |
| SC-R-01  | 键名唯一     | configKey在sys_config表中全局唯一                             | 创建      | DuplicateConfigKeyException |
| SC-R-02  | 类型校验     | configValue必须符合configType指定的格式（如NUMBER必须为数字） | 创建/更新 | ConfigValueTypeException    |
| SC-R-03  | 键名不可变   | configKey创建后不可修改，防止关联引用断裂                     | 更新      | 忽略修改                    |
| SC-R-04  | 不可编辑保护 | isEditable=false的配置项不允许修改configValue                 | 更新      | ConfigNotEditableException  |
| SC-R-05  | 加密存储     | isEncrypted=true的配置项，写入时加密、读取时脱敏显示          | 读写      | -                           |

表 9.2.2.2-2 SystemConfig业务规则表

##### 业务方法表

| 方法                   | 简述                                 | 关联规则   | 异常                   | 事件                |
| ---------------------- | ------------------------------------ | ---------- | ---------------------- | ------------------- |
| create(cmd)            | 创建配置项，一般由系统初始化脚本调用 | SC-R-01,02 | 键名重复；类型校验失败 | -                   |
| setValue(configValue)  | 修改配置值，校验类型和可编辑性       | SC-R-02,04 | 类型校验失败；不可编辑 | SystemConfigChanged |
| batchSetValue(items[]) | 批量修改同一分类下的多个配置项       | SC-R-02,04 | 类型校验失败；不可编辑 | SystemConfigChanged |

表 9.2.2.2-3 SystemConfig业务方法表

+   备注：
    -   SC-R-01键名唯一性：需应用层调用仓储预检，聚合内不做唯一性校验
    -   SC-R-05加密存储：加密使用AES-256-GCM算法，密钥由配置中心管理
    -   setValue()成功后清除该配置项的Redis缓存，发布SystemConfigChanged领域事件

##### ConfigType枚举值

| 枚举值    | 说明       | 前端渲染方式 | 校验规则                 |
| --------- | ---------- | ------------ | ------------------------ |
| STRING    | 字符串     | 文本输入框   | 无特殊校验               |
| NUMBER    | 数字       | 数字输入框   | 必须为整数或小数         |
| BOOLEAN   | 布尔值     | Switch开关   | 必须为true/false         |
| JSON      | JSON对象   | JSON编辑器   | 必须为合法JSON           |
| ENCRYPTED | 加密字符串 | 密码输入框   | 输入明文，保存时后端加密 |

表 9.2.2.2-4 ConfigType枚举值

### 9.2.3 TenantConfig 聚合

#### 9.2.3.1 聚合结构

+   TenantConfig聚合包含以下元素：

    | 元素类型 | 元素名称     | 说明         |
    | -------- | ------------ | ------------ |
    | 聚合根   | TenantConfig | 租户配置实体 |

    表 9.2.3.1-1 TenantConfig聚合结构

#### 9.2.3.2 TenantConfig 实体

+   TenantConfig是聚合根，管理租户级配置覆盖，采用三表模型定义如下。

##### 属性清单表

| 属性名      | 类型          | 必填 | 约束                  | 默认值   | 业务含义                               |
| ----------- | ------------- | ---- | --------------------- | -------- | -------------------------------------- |
| id          | Long          | 是   | BIGINT，自增主键      | 系统生成 | 配置记录唯一标识                       |
| configKey   | String        | 是   | 1-128字符，租户内唯一 | -        | 配置键名，与SystemConfig.configKey对应 |
| configValue | String        | 是   | ≤2000字符             | -        | 租户覆盖的配置值                       |
| configType  | ConfigType    | 是   | 枚举                  | STRING   | 配置值类型，须与系统配置类型一致       |
| category    | String        | 是   | 1-64字符              | -        | 配置分类                               |
| description | String        | 否   | ≤256字符              | null     | 租户自定义说明                         |
| createdAt   | LocalDateTime | 是   | 不可变                | NOW()    | 创建时间，审计用途                     |
| updatedAt   | LocalDateTime | 是   | -                     | NOW()    | 更新时间，审计用途                     |

表 9.2.3.2-1 TenantConfig属性清单表

##### 业务规则表

| 规则编号 | 规则名称     | 简述                                                      | 验证时机  | 违反后果                        |
| -------- | ------------ | --------------------------------------------------------- | --------- | ------------------------------- |
| TC-R-01  | 键名唯一     | configKey在同一租户库tenant_config表中唯一                | 创建      | DuplicateConfigKeyException     |
| TC-R-02  | 安全下限     | 租户配置不能突破系统设定的安全下限（如密码最小长度 ≥ 6）  | 创建/更新 | SecurityFloorViolationException |
| TC-R-03  | 类型校验     | configValue必须符合configType指定的格式                   | 创建/更新 | ConfigValueTypeException        |
| TC-R-04  | 键名必须存在 | configKey必须在sys_config表中有对应记录，防止创建无效覆盖 | 创建      | InvalidConfigKeyException       |

表 9.2.3.2-2 TenantConfig业务规则表

##### 业务方法表

| 方法                   | 简述                               | 关联规则      | 异常                       | 事件                |
| ---------------------- | ---------------------------------- | ------------- | -------------------------- | ------------------- |
| setValue(configValue)  | 覆盖租户配置值，首次覆盖时创建记录 | TC-R-01,02,03 | 安全下限违反；类型校验失败 | TenantConfigChanged |
| resetToDefault()       | 将租户配置值重置为当前系统默认值   | -             | -                          | TenantConfigReset   |
| batchSetValue(items[]) | 批量覆盖同一分类下的多个配置项     | TC-R-02,03    | 安全下限违反；类型校验失败 | TenantConfigChanged |

表 9.2.3.2-3 TenantConfig业务方法表

+   备注：
    -   TC-R-02安全下限：由应用层在保存前从SystemConfig中读取对应key的安全下限值进行校验
    -   TC-R-04键名有效性：需应用层调用SystemConfig仓储校验，聚合内不做跨聚合校验
    -   resetToDefault()执行后该配置项的configValue被重置为当前sys_config对应键的值，记录保留
    -   修改/重置成功后清除该租户的配置缓存，发布对应领域事件

### 9.2.4 配置优先级与合并策略

+   配置读取采用三级优先级合并，优先级从高到低：

    | 优先级  | 配置来源   | 说明                     | 数据位置        |
    | ------- | ---------- | ------------------------ | --------------- |
    | 1（高） | 租户配置   | 租户管理员自定义的覆盖值 | tenant_config表 |
    | 2（中） | 系统配置   | 平台管理员维护的默认值   | sys_config表    |
    | 3（低） | 代码默认值 | 系统硬编码的兜底值       | 代码常量        |

    表 9.2.4-1 配置优先级

+   合并流程：读取时先查租户配置表，若无记录则查系统配置表，若仍无则使用代码默认值。

### 9.2.5 领域事件

+   配置管理子领域发布以下领域事件：

    | 事件名称            | 触发时机             | 消费者   | 说明                         |
    | ------------------- | -------------------- | -------- | ---------------------------- |
    | SystemConfigChanged | 系统配置修改成功     | 审计模块 | 记录操作日志、清除相关缓存   |
    | TenantConfigChanged | 租户配置覆盖修改成功 | 审计模块 | 记录操作日志、清除该租户缓存 |
    | TenantConfigReset   | 租户配置重置为默认   | 审计模块 | 记录操作日志、清除该租户缓存 |

    表 9.2.5-1 领域事件清单

## 9.3 接口设计

+   本节设计配置管理子领域的API接口，按管理对象分为系统配置管理和租户配置管理两组。
+   接口设计遵循RESTful规范，路径按用户群区分以实现数据源路由。

+   API三表原则说明：
    -   API清单表：一表纵览全局，提供快速索引，新增"领域方法"列关联领域设计
    -   API契约表：将请求参数、响应参数、示例值合并，通过"关联错误码"字段引用附录中的错误码
    -   API追溯关联表：建立接口与其他设计元素的追溯关系
+   错误码管理：
    -   错误码表在**附录**中全局统一定义，不在接口设计章节重复维护
    -   各API契约概述表通过"关联错误码"字段引用附录中的错误码编号
    -   开发人员从附录中选择适用的错误码，如需新增则按附录中的扩展规范申请

### 9.3.1 接口总览

+   配置管理接口按管理对象分为系统配置管理和租户配置管理两组，总览如下：

    | 接口分组   | 路径前缀              | 接口数量 | 说明                       |
    | ---------- | --------------------- | -------- | -------------------------- |
    | SYS-CFG    | /api/v1/up/iam/config | 4        | 系统配置管理（平台管理员） |
    | TENANT-CFG | /api/v1/ur/iam/config | 5        | 租户配置管理（租户管理员） |

    表 9.3.1-1 接口分组总览

#### 9.3.1.1 接口分类统计

+   本子领域对外接口统计如下表所示。

    | 接口类型 | 数量 | 说明           |
    | -------- | ---- | -------------- |
    | REST API | 9个  | 前端调用       |
    | RPC接口  | 2个  | 微服务内部调用 |
    | 消息接口 | 3个  | 事件发布       |

    表 9.3.1.1-1 接口分类统计

#### 9.3.1.2 REST API清单表

+   配置管理 REST API 清单如下表所示。

    | API编号       | API名称            | 方法   | 路径                        | 权限                            | 领域方法                          | 备注         |
    | ------------- | ------------------ | ------ | --------------------------- | ------------------------------- | --------------------------------- | ------------ |
    | SYS-CFG-01    | 查询系统配置列表   | GET    | /api/v1/up/iam/config       | provider:iam:sys-config:list    | SystemConfigQueryService.list()   | 支持分类筛选 |
    | SYS-CFG-02    | 查询系统配置详情   | GET    | /api/v1/up/iam/config/{id}  | provider:iam:sys-config:detail  | SystemConfigQueryService.detail() | -            |
    | SYS-CFG-03    | 修改系统配置值     | PUT    | /api/v1/up/iam/config/{id}  | provider:iam:sys-config:update  | SystemConfig.setValue()           | -            |
    | SYS-CFG-04    | 批量修改系统配置   | PUT    | /api/v1/up/iam/config/batch | provider:iam:sys-config:update  | SystemConfig.batchSetValue()      | 同分类多项   |
    | TENANT-CFG-01 | 查询租户配置列表   | GET    | /api/v1/ur/iam/config       | tenant:iam:tenant-config:list   | TenantConfigQueryService.list()   | 含系统默认值 |
    | TENANT-CFG-02 | 查询租户配置详情   | GET    | /api/v1/ur/iam/config/{key} | tenant:iam:tenant-config:detail | TenantConfigQueryService.detail() | -            |
    | TENANT-CFG-03 | 修改租户配置值     | PUT    | /api/v1/ur/iam/config/{key} | tenant:iam:tenant-config:update | TenantConfig.setValue()           | -            |
    | TENANT-CFG-04 | 重置租户配置为默认 | DELETE | /api/v1/ur/iam/config/{key} | tenant:iam:tenant-config:update | TenantConfig.resetToDefault()     | -            |
    | TENANT-CFG-05 | 批量修改租户配置   | PUT    | /api/v1/ur/iam/config/batch | tenant:iam:tenant-config:update | TenantConfig.batchSetValue()      | 同分类多项   |

    表 9.3.1.2-1 配置管理 REST API 清单表

+   **清单表字段说明**
    -   API编号：全局唯一标识，用于追溯和引用
    -   领域方法：关联到第9.2节领域模型设计中的聚合方法或查询服务方法
    -   备注：简要说明接口的特殊情况

#### 9.3.1.3 RPC接口清单表

+   配置管理提供的RPC接口清单如下表所示。

    | 接口编号   | 接口名称       | 调用方        | 接口类型 | 领域方法                   | 说明                   |
    | ---------- | -------------- | ------------- | -------- | -------------------------- | ---------------------- |
    | RPC-CFG-01 | 获取生效配置值 | BC-10认证子域 | Feign    | ConfigService.getEffective | 三级合并后的生效值     |
    | RPC-CFG-02 | 批量获取配置值 | BC-10认证子域 | Feign    | ConfigService.batchGet     | 批量获取多个配置键的值 |

    表 9.3.1.3-1 RPC接口清单表

#### 9.3.1.4 消息接口清单表

+   配置管理发布的消息接口清单如下表所示。

    | 接口编号   | 消息名称            | 消息类型 | Topic      | 触发领域方法                  | 消费方   |
    | ---------- | ------------------- | -------- | ---------- | ----------------------------- | -------- |
    | MSG-CFG-01 | SystemConfigChanged | 领域事件 | iam.events | SystemConfig.setValue()       | 审计模块 |
    | MSG-CFG-02 | TenantConfigChanged | 领域事件 | iam.events | TenantConfig.setValue()       | 审计模块 |
    | MSG-CFG-03 | TenantConfigReset   | 领域事件 | iam.events | TenantConfig.resetToDefault() | 审计模块 |

    表 9.3.1.4-1 消息接口清单表

### 9.3.2 RPC接口设计

+   配置管理子领域通过Feign向其他子领域提供内部RPC接口。

#### 9.3.2.1 ConfigFeignClient

+   **ConfigFeignClient 概述**

    | 属性     | 值                        |
    | -------- | ------------------------- |
    | 接口名称 | ConfigFeignClient         |
    | 职责     | 供BC-10其他子域获取配置值 |
    | 服务名   | svc-iam                   |
    | 路径前缀 | /internal/iam/config      |
    | 降级实现 | ConfigFeignClientFallback |
    | 默认超时 | 3秒                       |

    表 9.3.2.1-1 ConfigFeignClient概述

+   **方法清单表**

    | 方法                        | 简述                       | HTTP | 路径             | 入参                      | 返回               | 超时 | 降级返回   |
    | --------------------------- | -------------------------- | ---- | ---------------- | ------------------------- | ------------------ | ---- | ---------- |
    | getEffective(key, tenantId) | 获取三级合并后的配置生效值 | GET  | /{key}/effective | key, tenantId: Long       | String             | 3秒  | 代码默认值 |
    | batchGet(keys, tenantId)    | 批量获取多个配置键的生效值 | POST | /batch/effective | List<key>, tenantId: Long | Map<String,String> | 5秒  | 空Map      |

    表 9.3.2.1-2 ConfigFeignClient方法清单表

+   **备注**
    -   getEffective按三级优先级合并：根据tenantId路由到租户库优先取tenant_config，无则取sys_config，仍无则返回代码默认值
    -   调用方主要为认证子域，用于获取密码策略、登录策略、会话策略等配置

#### 9.3.2.2 降级策略

+   Feign调用降级策略定义如下表所示。

    | 接口         | 降级条件        | 降级返回值 | 日志级别 |
    | ------------ | --------------- | ---------- | -------- |
    | getEffective | 超时/服务不可用 | 代码默认值 | WARN     |
    | batchGet     | 超时/服务不可用 | 空Map      | WARN     |

    表 9.3.2.2-1 降级策略

### 9.3.3 消息接口设计

#### 9.3.3.1 消息通道配置

+   配置管理的消息通道配置如下表所示。

    | 通道名称   | Topic/Exchange | 类型  | 说明        |
    | ---------- | -------------- | ----- | ----------- |
    | iam-events | iam.events     | Topic | IAM领域事件 |

    表 9.3.3.1-1 消息通道配置

#### 9.3.3.2 MSG-CFG-01 SystemConfigChanged

+   **消息概述**

    | 属性     | 值                  |
    | -------- | ------------------- |
    | 消息编号 | MSG-CFG-01          |
    | 消息名称 | SystemConfigChanged |
    | Topic    | iam.events          |
    | 消费方   | 审计模块            |
    | 触发时机 | 系统配置修改成功后  |

    表 9.3.3.2-1 MSG-CFG-01消息概述

+   **Payload字段说明**

    | 字段名     | 类型   | 说明               |
    | ---------- | ------ | ------------------ |
    | configKey  | String | 修改的配置键名     |
    | oldValue   | String | 修改前的值         |
    | newValue   | String | 修改后的值         |
    | operatedBy | String | 操作人ID（BIGINT） |
    | operatedAt | String | 操作时间           |

    表 9.3.3.2-2 MSG-CFG-01 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑             | 幂等策略    | 失败处理      |
    | -------- | -------------------- | ----------- | ------------- |
    | 审计模块 | 记录配置变更审计日志 | eventId去重 | 重试3次后告警 |

    表 9.3.3.2-3 MSG-CFG-01消费方处理

#### 9.3.3.3 MSG-CFG-02 TenantConfigChanged

+   **消息概述**

    | 属性     | 值                     |
    | -------- | ---------------------- |
    | 消息编号 | MSG-CFG-02             |
    | 消息名称 | TenantConfigChanged    |
    | Topic    | iam.events             |
    | 消费方   | 审计模块               |
    | 触发时机 | 租户配置覆盖修改成功后 |

    表 9.3.3.3-1 MSG-CFG-02消息概述

+   **Payload字段说明**

    | 字段名     | 类型   | 说明               |
    | ---------- | ------ | ------------------ |
    | tenantId   | Number | 租户ID（BIGINT）   |
    | tenantCode | String | 租户编码           |
    | configKey  | String | 修改的配置键名     |
    | oldValue   | String | 修改前的值         |
    | newValue   | String | 修改后的值         |
    | operatedBy | String | 操作人ID（BIGINT） |
    | operatedAt | String | 操作时间           |

    表 9.3.3.3-2 MSG-CFG-02 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                             | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------ | ----------- | ------------- |
    | 审计模块 | 记录租户配置变更审计日志（含租户ID） | eventId去重 | 重试3次后告警 |

    表 9.3.3.3-3 MSG-CFG-02消费方处理

#### 9.3.3.4 MSG-CFG-03 TenantConfigReset

+   **消息概述**

    | 属性     | 值                   |
    | -------- | -------------------- |
    | 消息编号 | MSG-CFG-03           |
    | 消息名称 | TenantConfigReset    |
    | Topic    | iam.events           |
    | 消费方   | 审计模块             |
    | 触发时机 | 租户配置重置为默认后 |

    表 9.3.3.4-1 MSG-CFG-03消息概述

+   **Payload字段说明**

    | 字段名     | 类型   | 说明                 |
    | ---------- | ------ | -------------------- |
    | tenantId   | Number | 租户ID（BIGINT）     |
    | tenantCode | String | 租户编码             |
    | configKey  | String | 重置的配置键名       |
    | oldValue   | String | 重置前的租户自定义值 |
    | newValue   | String | 重置后的系统默认值   |
    | operatedBy | String | 操作人ID（BIGINT）   |
    | operatedAt | String | 操作时间             |

    表 9.3.3.4-2 MSG-CFG-03 Payload字段

+   **消费方处理契约**

    | 消费方   | 处理逻辑                             | 幂等策略    | 失败处理      |
    | -------- | ------------------------------------ | ----------- | ------------- |
    | 审计模块 | 记录租户配置重置审计日志（含租户ID） | eventId去重 | 重试3次后告警 |

    表 9.3.3.4-3 MSG-CFG-03消费方处理

### 9.3.4 REST接口设计

+   配置管理REST接口按管理对象分为系统配置管理和租户配置管理两组，分别服务于平台管理员和租户管理员。

#### 9.3.4.1 系统配置管理接口（SYS-CFG）

##### 9.3.4.1.1 SYS-CFG-01 查询系统配置列表

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | SYS-CFG-01                             |
    | 接口路径   | GET /api/v1/up/iam/config              |
    | 功能简述   | 按分类查询系统配置列表，加密项脱敏显示 |
    | 所需权限   | provider:iam:sys-config:list           |
    | 关联功能   | F-CFG-01 系统配置列表展示              |
    | 关联用例   | UC-CFG-01 平台管理员查看系统配置列表   |
    | 关联领域   | SystemConfigQueryService.list()        |
    | 关联规则   | 无                                     |
    | 幂等性     | 是（查询接口天然幂等）                 |
    | 关联错误码 | E-401001, E-403001                     |

    表 9.3.4.1.1-1 SYS-CFG-01 契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型   | 必填 | 约束                                                     | 示例值          | 业务含义                         |
    | -------- | ----- | ------ | ---- | -------------------------------------------------------- | --------------- | -------------------------------- |
    | category | query | String | 否   | 枚举：AUTH_GENERAL/AUTH_SMS/AUTH_PASSWORD/AUTH_SESSION等 | "AUTH_PASSWORD" | 配置分类过滤                     |
    | keyword  | query | String | 否   | ≤100字符                                                 | "password"      | 按configKey或description模糊搜索 |

    表 9.3.4.1.1-2 SYS-CFG-01 请求契约表

+   **响应契约表**

    | 参数名             | 类型    | 必有 | 示例值                    | 业务含义                     |
    | ------------------ | ------- | ---- | ------------------------- | ---------------------------- |
    | code               | Number  | 是   | 0                         | 响应码                       |
    | message            | String  | 是   | "success"                 | 响应消息                     |
    | data[]             | Array   | 是   | [...]                     | 配置列表                     |
    | data[].id          | Number  | 是   | 10001                     | 配置记录ID（BIGINT）         |
    | data[].configKey   | String  | 是   | "auth.password.minLength" | 配置键名                     |
    | data[].configValue | String  | 是   | "8"                       | 配置值（加密项返回"******"） |
    | data[].configType  | String  | 是   | "NUMBER"                  | 值类型                       |
    | data[].category    | String  | 是   | "AUTH_PASSWORD"           | 配置分类                     |
    | data[].description | String  | 是   | "密码最小长度"            | 配置说明                     |
    | data[].isEncrypted | Boolean | 是   | false                     | 是否加密                     |
    | data[].isEditable  | Boolean | 是   | true                      | 是否允许编辑                 |
    | data[].updatedAt   | String  | 是   | "2026-01-20T10:00:00"     | 最后更新时间                 |

    表 9.3.4.1.1-3 SYS-CFG-01 响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "success",
          "data": [
            {
              "id": 10001,
              "configKey": "auth.password.minLength",
              "configValue": "8",
              "configType": "NUMBER",
              "category": "AUTH_PASSWORD",
              "description": "密码最小长度",
              "isEncrypted": false,
              "isEditable": true,
              "updatedAt": "2026-01-20T10:00:00"
            },
            {
              "id": 10002,
              "configKey": "auth.password.requireUpper",
              "configValue": "true",
              "configType": "BOOLEAN",
              "category": "AUTH_PASSWORD",
              "description": "是否要求包含大写字母",
              "isEncrypted": false,
              "isEditable": true,
              "updatedAt": "2026-01-20T10:00:00"
            }
          ],
          "timestamp": 1737885600000
        }
        ```

##### 9.3.4.1.2 SYS-CFG-02 查询系统配置详情

+   **契约概述表**

    | 属性       | 值                                |
    | ---------- | --------------------------------- |
    | API编号    | SYS-CFG-02                        |
    | 接口路径   | GET /api/v1/up/iam/config/{id}    |
    | 功能简述   | 根据ID查询系统配置项详细信息      |
    | 所需权限   | provider:iam:sys-config:detail    |
    | 关联功能   | F-CFG-02 系统配置详情查看         |
    | 关联用例   | UC-CFG-02 平台管理员查看配置详情  |
    | 关联领域   | SystemConfigQueryService.detail() |
    | 关联规则   | 无                                |
    | 幂等性     | 是                                |
    | 关联错误码 | E-401001, E-403001, E-404001      |

    表 9.3.4.1.2-1 SYS-CFG-02 契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型 | 必填 | 约束   | 示例值 | 业务含义   |
    | ------ | ---- | ---- | ---- | ------ | ------ | ---------- |
    | id     | path | Long | 是   | BIGINT | 10001  | 配置记录ID |

    表 9.3.4.1.2-2 SYS-CFG-02 请求契约表

+   **响应契约表**

    | 参数名           | 类型    | 必有 | 示例值                    | 业务含义                     |
    | ---------------- | ------- | ---- | ------------------------- | ---------------------------- |
    | code             | Number  | 是   | 0                         | 响应码                       |
    | message          | String  | 是   | "success"                 | 响应消息                     |
    | data.id          | Number  | 是   | 10001                     | 配置记录ID（BIGINT）         |
    | data.configKey   | String  | 是   | "auth.password.minLength" | 配置键名                     |
    | data.configValue | String  | 是   | "8"                       | 配置值（加密项返回"******"） |
    | data.configType  | String  | 是   | "NUMBER"                  | 值类型                       |
    | data.category    | String  | 是   | "AUTH_PASSWORD"           | 配置分类                     |
    | data.description | String  | 是   | "密码最小长度"            | 配置说明                     |
    | data.isEncrypted | Boolean | 是   | false                     | 是否加密                     |
    | data.isEditable  | Boolean | 是   | true                      | 是否允许编辑                 |
    | data.createdAt   | String  | 是   | "2026-01-15T08:00:00"     | 创建时间                     |
    | data.updatedAt   | String  | 是   | "2026-01-20T10:00:00"     | 更新时间                     |

    表 9.3.4.1.2-3 SYS-CFG-02 响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "success",
          "data": {
            "id": 10001,
            "configKey": "auth.password.minLength",
            "configValue": "8",
            "configType": "NUMBER",
            "category": "AUTH_PASSWORD",
            "description": "密码最小长度",
            "isEncrypted": false,
            "isEditable": true,
            "createdAt": "2026-01-15T08:00:00",
            "updatedAt": "2026-01-20T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（配置不存在）

        ```json
        {
          "code": 404001,
          "message": "配置项不存在",
          "data": {
            "configId": 99999
          },
          "timestamp": 1737885600000
        }
        ```

##### 9.3.4.1.3 SYS-CFG-03 修改系统配置值

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | SYS-CFG-03                                   |
    | 接口路径   | PUT /api/v1/up/iam/config/{id}               |
    | 功能简述   | 修改指定系统配置项的值，校验类型和可编辑性   |
    | 所需权限   | provider:iam:sys-config:update               |
    | 关联功能   | F-CFG-03 系统配置修改                        |
    | 关联用例   | UC-CFG-03 平台管理员修改系统配置             |
    | 关联领域   | SystemConfig.setValue()                      |
    | 关联规则   | SC-R-02（类型校验）, SC-R-04（不可编辑保护） |
    | 幂等性     | 是（PUT幂等）                                |
    | 关联错误码 | E-401001, E-403001, E-404001, E-400001       |

    表 9.3.4.1.3-1 SYS-CFG-03 契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束      | 示例值 | 业务含义   |
    | ----------- | ---- | ------ | ---- | --------- | ------ | ---------- |
    | id          | path | Long   | 是   | BIGINT    | 10001  | 配置记录ID |
    | configValue | body | String | 是   | ≤2000字符 | "10"   | 新的配置值 |

    表 9.3.4.1.3-2 SYS-CFG-03 请求契约表

+   **响应契约表**

    | 参数名           | 类型   | 必有 | 示例值                    | 业务含义                         |
    | ---------------- | ------ | ---- | ------------------------- | -------------------------------- |
    | code             | Number | 是   | 0                         | 响应码                           |
    | message          | String | 是   | "修改成功"                | 响应消息                         |
    | data.id          | Number | 是   | 10001                     | 配置记录ID（BIGINT）             |
    | data.configKey   | String | 是   | "auth.password.minLength" | 配置键名                         |
    | data.configValue | String | 是   | "10"                      | 更新后的值（加密项返回"******"） |
    | data.updatedAt   | String | 是   | "2026-01-26T10:00:00"     | 更新时间                         |

    表 9.3.4.1.3-3 SYS-CFG-03 响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "configValue": "10"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "修改成功",
          "data": {
            "id": 10001,
            "configKey": "auth.password.minLength",
            "configValue": "10",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（不可编辑）

        ```json
        {
          "code": 400001,
          "message": "该配置项不允许编辑",
          "data": {
            "configId": 10099,
            "configKey": "auth.sms.provider",
            "isEditable": false
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   修改成功后自动清除该配置项的Redis缓存键 `iam:config:sys:{configKey}`
    -   发布 SystemConfigChanged 领域事件，审计模块记录变更日志

##### 9.3.4.1.4 SYS-CFG-04 批量修改系统配置

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | SYS-CFG-04                                   |
    | 接口路径   | PUT /api/v1/up/iam/config/batch              |
    | 功能简述   | 批量修改同一分类下的多个配置项，一次性提交   |
    | 所需权限   | provider:iam:sys-config:update               |
    | 关联功能   | F-CFG-03 系统配置修改                        |
    | 关联用例   | UC-CFG-03 平台管理员修改系统配置             |
    | 关联领域   | SystemConfig.batchSetValue()                 |
    | 关联规则   | SC-R-02（类型校验）, SC-R-04（不可编辑保护） |
    | 幂等性     | 是（PUT幂等）                                |
    | 关联错误码 | E-401001, E-403001, E-404001, E-400001       |

    表 9.3.4.1.4-1 SYS-CFG-04 契约概述表

+   **请求契约表**

    | 参数名              | 位置 | 类型     | 必填 | 约束           | 示例值 | 业务含义   |
    | ------------------- | ---- | -------- | ---- | -------------- | ------ | ---------- |
    | items               | body | Object[] | 是   | 数组，最多50项 | [...]  | 配置项数组 |
    | items[].id          | body | Long     | 是   | BIGINT         | 10001  | 配置记录ID |
    | items[].configValue | body | String   | 是   | ≤2000字符      | "10"   | 新的配置值 |

    表 9.3.4.1.4-2 SYS-CFG-04 请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值         | 业务含义     |
    | ----------------- | ------ | ---- | -------------- | ------------ |
    | code              | Number | 是   | 0              | 响应码       |
    | message           | String | 是   | "批量修改成功" | 响应消息     |
    | data.successCount | Number | 是   | 3              | 成功修改数量 |

    表 9.3.4.1.4-3 SYS-CFG-04 响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "items": [
            { "id": 10001, "configValue": "10" },
            { "id": 10002, "configValue": "true" },
            { "id": 10003, "configValue": "true" }
          ]
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "批量修改成功",
          "data": {
            "successCount": 3
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   批量操作为事务性操作，任一项校验失败则全部回滚
    -   批量修改后逐项清除Redis缓存，并为每项变更发布SystemConfigChanged事件

#### 9.3.4.2 租户配置管理接口（TENANT-CFG）

##### 9.3.4.2.1 TENANT-CFG-01 查询租户配置列表

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | TENANT-CFG-01                            |
    | 接口路径   | GET /api/v1/ur/iam/config                |
    | 功能简述   | 查询当前租户的配置列表，含系统默认值对比 |
    | 所需权限   | tenant:iam:tenant-config:list            |
    | 关联功能   | F-CFG-04 租户配置列表展示                |
    | 关联用例   | UC-CFG-04 租户管理员查看配置列表         |
    | 关联领域   | TenantConfigQueryService.list()          |
    | 关联规则   | 无                                       |
    | 幂等性     | 是                                       |
    | 关联错误码 | E-401001, E-403001                       |

    表 9.3.4.2.1-1 TENANT-CFG-01 契约概述表

+   **请求契约表**

    | 参数名   | 位置  | 类型   | 必填 | 约束         | 示例值          | 业务含义     |
    | -------- | ----- | ------ | ---- | ------------ | --------------- | ------------ |
    | category | query | String | 否   | 配置分类枚举 | "AUTH_PASSWORD" | 配置分类过滤 |

    表 9.3.4.2.1-2 TENANT-CFG-01 请求契约表

+   **响应契约表**

    | 参数名                    | 类型    | 必有 | 示例值                    | 业务含义                       |
    | ------------------------- | ------- | ---- | ------------------------- | ------------------------------ |
    | code                      | Number  | 是   | 0                         | 响应码                         |
    | message                   | String  | 是   | "success"                 | 响应消息                       |
    | data[]                    | Array   | 是   | [...]                     | 配置列表                       |
    | data[].configKey          | String  | 是   | "auth.password.minLength" | 配置键名                       |
    | data[].effectiveValue     | String  | 是   | "10"                      | 当前生效值（经优先级合并后）   |
    | data[].tenantValue        | String  | 否   | "10"                      | 租户自定义值（null表示未覆盖） |
    | data[].systemDefaultValue | String  | 是   | "8"                       | 系统默认值                     |
    | data[].isOverridden       | Boolean | 是   | true                      | 是否已由租户覆盖               |
    | data[].configType         | String  | 是   | "NUMBER"                  | 值类型                         |
    | data[].category           | String  | 是   | "AUTH_PASSWORD"           | 配置分类                       |
    | data[].description        | String  | 是   | "密码最小长度"            | 配置说明                       |

    表 9.3.4.2.1-3 TENANT-CFG-01 响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "success",
          "data": [
            {
              "configKey": "auth.password.minLength",
              "effectiveValue": "10",
              "tenantValue": "10",
              "systemDefaultValue": "8",
              "isOverridden": true,
              "configType": "NUMBER",
              "category": "AUTH_PASSWORD",
              "description": "密码最小长度"
            },
            {
              "configKey": "auth.password.requireUpper",
              "effectiveValue": "true",
              "tenantValue": null,
              "systemDefaultValue": "true",
              "isOverridden": false,
              "configType": "BOOLEAN",
              "category": "AUTH_PASSWORD",
              "description": "是否要求包含大写字母"
            }
          ],
          "timestamp": 1737885600000
        }
        ```

+   **备注**：
    -   tenantId从当前登录用户的Token中获取，无需前端传参
    -   响应中同时返回tenantValue和systemDefaultValue，前端可据此显示"已自定义"或"使用系统默认"状态

##### 9.3.4.2.2 TENANT-CFG-02 查询租户配置详情

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | TENANT-CFG-02                                |
    | 接口路径   | GET /api/v1/ur/iam/config/{key}              |
    | 功能简述   | 根据配置键名查询租户配置详情（含系统默认值） |
    | 所需权限   | tenant:iam:tenant-config:detail              |
    | 关联功能   | F-CFG-05 租户配置详情查看                    |
    | 关联用例   | UC-CFG-05 租户管理员查看配置详情             |
    | 关联领域   | TenantConfigQueryService.detail()            |
    | 关联规则   | 无                                           |
    | 幂等性     | 是                                           |
    | 关联错误码 | E-401001, E-403001, E-404001                 |

    表 9.3.4.2.2-1 TENANT-CFG-02 契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束                | 示例值                    | 业务含义 |
    | ------ | ---- | ------ | ---- | ------------------- | ------------------------- | -------- |
    | key    | path | String | 是   | 1-128字符，点号分隔 | "auth.password.minLength" | 配置键名 |

    表 9.3.4.2.2-2 TENANT-CFG-02 请求契约表

+   **响应契约表**

    | 参数名                  | 类型    | 必有 | 示例值                    | 业务含义         |
    | ----------------------- | ------- | ---- | ------------------------- | ---------------- |
    | code                    | Number  | 是   | 0                         | 响应码           |
    | message                 | String  | 是   | "success"                 | 响应消息         |
    | data.configKey          | String  | 是   | "auth.password.minLength" | 配置键名         |
    | data.effectiveValue     | String  | 是   | "10"                      | 当前生效值       |
    | data.tenantValue        | String  | 否   | "10"                      | 租户自定义值     |
    | data.systemDefaultValue | String  | 是   | "8"                       | 系统默认值       |
    | data.isOverridden       | Boolean | 是   | true                      | 是否已由租户覆盖 |
    | data.configType         | String  | 是   | "NUMBER"                  | 值类型           |
    | data.category           | String  | 是   | "AUTH_PASSWORD"           | 配置分类         |
    | data.description        | String  | 是   | "密码最小长度"            | 配置说明         |

    表 9.3.4.2.2-3 TENANT-CFG-02 响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "success",
          "data": {
            "configKey": "auth.password.minLength",
            "effectiveValue": "10",
            "tenantValue": "10",
            "systemDefaultValue": "8",
            "isOverridden": true,
            "configType": "NUMBER",
            "category": "AUTH_PASSWORD",
            "description": "密码最小长度"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（配置键不存在）

        ```json
        {
          "code": 404001,
          "message": "配置项不存在",
          "data": {
            "configKey": "auth.password.nonExist"
          },
          "timestamp": 1737885600000
        }
        ```

##### 9.3.4.2.3 TENANT-CFG-03 修改租户配置值

+   **契约概述表**

    | 属性       | 值                                           |
    | ---------- | -------------------------------------------- |
    | API编号    | TENANT-CFG-03                                |
    | 接口路径   | PUT /api/v1/ur/iam/config/{key}              |
    | 功能简述   | 修改当前租户的指定配置项，首次覆盖时创建记录 |
    | 所需权限   | tenant:iam:tenant-config:update              |
    | 关联功能   | F-CFG-06 租户配置修改                        |
    | 关联用例   | UC-CFG-06 租户管理员修改配置                 |
    | 关联领域   | TenantConfig.setValue()                      |
    | 关联规则   | TC-R-02（安全下限）, TC-R-03（类型校验）     |
    | 幂等性     | 是（PUT幂等）                                |
    | 关联错误码 | E-401001, E-403001, E-400001, E-400004       |

    表 9.3.4.2.3-1 TENANT-CFG-03 契约概述表

+   **请求契约表**

    | 参数名      | 位置 | 类型   | 必填 | 约束                | 示例值                    | 业务含义   |
    | ----------- | ---- | ------ | ---- | ------------------- | ------------------------- | ---------- |
    | key         | path | String | 是   | 1-128字符，点号分隔 | "auth.password.minLength" | 配置键名   |
    | configValue | body | String | 是   | ≤2000字符           | "10"                      | 新的配置值 |

    表 9.3.4.2.3-2 TENANT-CFG-03 请求契约表

+   **响应契约表**

    | 参数名           | 类型   | 必有 | 示例值                    | 业务含义   |
    | ---------------- | ------ | ---- | ------------------------- | ---------- |
    | code             | Number | 是   | 0                         | 响应码     |
    | message          | String | 是   | "修改成功"                | 响应消息   |
    | data.configKey   | String | 是   | "auth.password.minLength" | 配置键名   |
    | data.configValue | String | 是   | "10"                      | 更新后的值 |
    | data.updatedAt   | String | 是   | "2026-01-26T10:00:00"     | 更新时间   |

    表 9.3.4.2.3-3 TENANT-CFG-03 响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "configValue": "10"
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "修改成功",
          "data": {
            "configKey": "auth.password.minLength",
            "configValue": "10",
            "updatedAt": "2026-01-26T10:00:00"
          },
          "timestamp": 1737885600000
        }
        ```

    +   错误响应Mock（违反安全下限）

        ```json
        {
          "code": 400004,
          "message": "配置值不能低于系统安全下限",
          "data": {
            "configKey": "auth.password.minLength",
            "inputValue": "4",
            "securityFloor": "6",
            "suggestion": "密码最小长度不得低于6位"
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   修改成功后自动清除该租户的Redis缓存键 `iam:config:tenant:{tenantId}:{configKey}`
    -   首次覆盖时在 tenant_config 表中更新对应记录的 configValue

##### 9.3.4.2.4 TENANT-CFG-04 重置租户配置为默认

+   **契约概述表**

    | 属性       | 值                                     |
    | ---------- | -------------------------------------- |
    | API编号    | TENANT-CFG-04                          |
    | 接口路径   | DELETE /api/v1/ur/iam/config/{key}     |
    | 功能简述   | 删除租户自定义配置，恢复使用系统默认值 |
    | 所需权限   | tenant:iam:tenant-config:update        |
    | 关联功能   | F-CFG-07 租户配置重置                  |
    | 关联用例   | UC-CFG-07 租户管理员重置配置为默认     |
    | 关联领域   | TenantConfig.resetToDefault()          |
    | 关联规则   | 无                                     |
    | 幂等性     | 是（DELETE幂等）                       |
    | 关联错误码 | E-401001, E-403001, E-404001           |

    表 9.3.4.2.4-1 TENANT-CFG-04 契约概述表

+   **请求契约表**

    | 参数名 | 位置 | 类型   | 必填 | 约束                | 示例值                    | 业务含义 |
    | ------ | ---- | ------ | ---- | ------------------- | ------------------------- | -------- |
    | key    | path | String | 是   | 1-128字符，点号分隔 | "auth.password.minLength" | 配置键名 |

    表 9.3.4.2.4-2 TENANT-CFG-04 请求契约表

+   **响应契约表**

    | 参数名  | 类型   | 必有 | 示例值             | 业务含义 |
    | ------- | ------ | ---- | ------------------ | -------- |
    | code    | Number | 是   | 0                  | 响应码   |
    | message | String | 是   | "已重置为系统默认" | 响应消息 |
    | data    | null   | 是   | null               | 无数据   |

    表 9.3.4.2.4-3 TENANT-CFG-04 响应契约表

+   **Mock示例**

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "已重置为系统默认",
          "data": null,
          "timestamp": 1737885600000
        }
        ```

+   **备注**：调用后该配置项的configValue被重置为当前sys_config对应键的系统默认值，tenant_config记录保留。

##### 9.3.4.2.5 TENANT-CFG-05 批量修改租户配置

+   **契约概述表**

    | 属性       | 值                                       |
    | ---------- | ---------------------------------------- |
    | API编号    | TENANT-CFG-05                            |
    | 接口路径   | PUT /api/v1/ur/iam/config/batch          |
    | 功能简述   | 批量修改同一分类下的多个租户配置项       |
    | 所需权限   | tenant:iam:tenant-config:update          |
    | 关联功能   | F-CFG-06 租户配置修改                    |
    | 关联用例   | UC-CFG-06 租户管理员修改配置             |
    | 关联领域   | TenantConfig.batchSetValue()             |
    | 关联规则   | TC-R-02（安全下限）, TC-R-03（类型校验） |
    | 幂等性     | 是（PUT幂等）                            |
    | 关联错误码 | E-401001, E-403001, E-400001, E-400004   |

    表 9.3.4.2.5-1 TENANT-CFG-05 契约概述表

+   **请求契约表**

    | 参数名              | 位置 | 类型     | 必填 | 约束                | 示例值                    | 业务含义   |
    | ------------------- | ---- | -------- | ---- | ------------------- | ------------------------- | ---------- |
    | items               | body | Object[] | 是   | 数组，最多50项      | [...]                     | 配置项数组 |
    | items[].configKey   | body | String   | 是   | 1-128字符，点号分隔 | "auth.password.minLength" | 配置键名   |
    | items[].configValue | body | String   | 是   | ≤2000字符           | "10"                      | 新的配置值 |

    表 9.3.4.2.5-2 TENANT-CFG-05 请求契约表

+   **响应契约表**

    | 参数名            | 类型   | 必有 | 示例值         | 业务含义     |
    | ----------------- | ------ | ---- | -------------- | ------------ |
    | code              | Number | 是   | 0              | 响应码       |
    | message           | String | 是   | "批量修改成功" | 响应消息     |
    | data.successCount | Number | 是   | 3              | 成功修改数量 |

    表 9.3.4.2.5-3 TENANT-CFG-05 响应契约表

+   **Mock示例**

    +   请求Mock

        ```json
        {
          "items": [
            { "configKey": "auth.password.minLength", "configValue": "10" },
            { "configKey": "auth.password.requireUpper", "configValue": "true" },
            { "configKey": "auth.password.expireDays", "configValue": "90" }
          ]
        }
        ```

    +   成功响应Mock

        ```json
        {
          "code": 0,
          "message": "批量修改成功",
          "data": {
            "successCount": 3
          },
          "timestamp": 1737885600000
        }
        ```

+   **备注**
    -   批量操作为事务性操作，任一项安全下限校验失败则全部回滚
    -   批量修改后逐项清除该租户的Redis缓存，并为每项变更发布TenantConfigChanged事件

### 9.3.5 追溯关联表

#### 9.3.5.1 API-功能-用例关联表

+   全部REST API与RPC接口的功能-用例追溯关系如下表所示。

    | API编号       | API名称            | 关联功能编号 | 关联功能名称     | 关联用例编号 | 关联用例名称                 |
    | ------------- | ------------------ | ------------ | ---------------- | ------------ | ---------------------------- |
    | SYS-CFG-01    | 查询系统配置列表   | F-CFG-01     | 系统配置列表展示 | UC-CFG-01    | 平台管理员查看系统配置列表   |
    | SYS-CFG-02    | 查询系统配置详情   | F-CFG-02     | 系统配置详情查看 | UC-CFG-02    | 平台管理员查看配置详情       |
    | SYS-CFG-03    | 修改系统配置值     | F-CFG-03     | 系统配置修改     | UC-CFG-03    | 平台管理员修改系统配置       |
    | SYS-CFG-04    | 批量修改系统配置   | F-CFG-03     | 系统配置修改     | UC-CFG-03    | 平台管理员批量修改系统配置   |
    | TENANT-CFG-01 | 查询租户配置列表   | F-CFG-04     | 租户配置列表展示 | UC-CFG-04    | 租户管理员查看配置列表       |
    | TENANT-CFG-02 | 查询租户配置详情   | F-CFG-05     | 租户配置详情查看 | UC-CFG-05    | 租户管理员查看配置详情       |
    | TENANT-CFG-03 | 修改租户配置值     | F-CFG-06     | 租户配置修改     | UC-CFG-06    | 租户管理员修改配置           |
    | TENANT-CFG-04 | 重置租户配置为默认 | F-CFG-07     | 租户配置重置     | UC-CFG-07    | 租户管理员重置配置为默认     |
    | TENANT-CFG-05 | 批量修改租户配置   | F-CFG-06     | 租户配置修改     | UC-CFG-06    | 租户管理员批量修改配置       |
    | RPC-CFG-01    | 获取生效配置值     | F-RPC-CFG-01 | 配置生效值读取   | UC-AUTH-01   | 认证子域获取登录/密码策略    |
    | RPC-CFG-02    | 批量获取配置值     | F-RPC-CFG-02 | 配置批量读取     | UC-AUTH-01   | 认证子域批量获取认证策略参数 |

    表 9.3.5.1-1 API-功能-用例关联表

#### 9.3.5.2 API-领域-权限关联表

+   全部REST API与RPC接口的领域-权限追溯关系如下表所示。

    | API编号       | API名称            | 关联聚合     | 领域方法                          | 权限标识                        | 权限说明         |
    | ------------- | ------------------ | ------------ | --------------------------------- | ------------------------------- | ---------------- |
    | SYS-CFG-01    | 查询系统配置列表   | -            | SystemConfigQueryService.list()   | provider:iam:sys-config:list    | 查看系统配置权限 |
    | SYS-CFG-02    | 查询系统配置详情   | -            | SystemConfigQueryService.detail() | provider:iam:sys-config:detail  | 查看系统配置权限 |
    | SYS-CFG-03    | 修改系统配置值     | SystemConfig | SystemConfig.setValue()           | provider:iam:sys-config:update  | 修改系统配置权限 |
    | SYS-CFG-04    | 批量修改系统配置   | SystemConfig | SystemConfig.batchSetValue()      | provider:iam:sys-config:update  | 修改系统配置权限 |
    | TENANT-CFG-01 | 查询租户配置列表   | -            | TenantConfigQueryService.list()   | tenant:iam:tenant-config:list   | 查看租户配置权限 |
    | TENANT-CFG-02 | 查询租户配置详情   | -            | TenantConfigQueryService.detail() | tenant:iam:tenant-config:detail | 查看租户配置权限 |
    | TENANT-CFG-03 | 修改租户配置值     | TenantConfig | TenantConfig.setValue()           | tenant:iam:tenant-config:update | 修改租户配置权限 |
    | TENANT-CFG-04 | 重置租户配置为默认 | TenantConfig | TenantConfig.resetToDefault()     | tenant:iam:tenant-config:update | 修改租户配置权限 |
    | TENANT-CFG-05 | 批量修改租户配置   | TenantConfig | TenantConfig.batchSetValue()      | tenant:iam:tenant-config:update | 修改租户配置权限 |
    | RPC-CFG-01    | 获取生效配置值     | -            | ConfigService.getEffective()      | internal                        | 内部RPC          |
    | RPC-CFG-02    | 批量获取配置值     | -            | ConfigService.batchGet()          | internal                        | 内部RPC          |

    表 9.3.5.2-1 API-领域-权限关联表

+   权限标识说明：
    -   `internal`：内部RPC接口，通过服务间认证
    -   `{四段式权限}`：需要登录且拥有对应权限，格式见附录D.3

#### 9.3.5.3 API-页面-组件关联表

+   全部REST API的页面-组件追溯关系如下表所示。RPC接口无前端页面，不在此表中。

    | API编号       | API名称            | 关联页面编号 | 页面名称       | 触发组件      | 触发时机         |
    | ------------- | ------------------ | ------------ | -------------- | ------------- | ---------------- |
    | SYS-CFG-01    | 查询系统配置列表   | PG-P-CFG-01  | 系统配置管理页 | -             | 页面加载/Tab切换 |
    | SYS-CFG-02    | 查询系统配置详情   | PG-P-CFG-01  | 系统配置管理页 | 编辑按钮      | 点击编辑         |
    | SYS-CFG-03    | 修改系统配置值     | PG-P-CFG-01  | 系统配置管理页 | 保存按钮      | 点击保存         |
    | SYS-CFG-04    | 批量修改系统配置   | PG-P-CFG-01  | 系统配置管理页 | 批量保存按钮  | 点击批量保存     |
    | TENANT-CFG-01 | 查询租户配置列表   | PG-UR-CFG-01 | 安全策略配置页 | -             | 页面加载         |
    | TENANT-CFG-01 | 查询租户配置列表   | PG-UR-CFG-02 | 登录方式配置页 | -             | 页面加载         |
    | TENANT-CFG-02 | 查询租户配置详情   | PG-UR-CFG-01 | 安全策略配置页 | 配置卡片      | 点击编辑         |
    | TENANT-CFG-03 | 修改租户配置值     | PG-UR-CFG-01 | 安全策略配置页 | 保存按钮      | 点击保存         |
    | TENANT-CFG-03 | 修改租户配置值     | PG-UR-CFG-02 | 登录方式配置页 | 开关/保存按钮 | 切换开关/保存    |
    | TENANT-CFG-04 | 重置租户配置为默认 | PG-UR-CFG-01 | 安全策略配置页 | 重置按钮      | 点击确认重置     |
    | TENANT-CFG-05 | 批量修改租户配置   | PG-UR-CFG-01 | 安全策略配置页 | 批量保存按钮  | 点击批量保存     |

    表 9.3.5.3-1 API-页面-组件关联表

+   说明：
    -   关联页面编号对应9.5节前端设计中的页面编号
    -   TENANT-CFG-01和TENANT-CFG-03同时关联PG-UR-CFG-01和PG-UR-CFG-02两个页面，因为安全策略配置和登录方式配置共用同一套配置读写接口
    -   PG-UR-CFG-02中切换登录方式开关时，实际调用TENANT-CFG-03修改对应的auth.login.*配置项

## 9.4 数据模型设计

+   配置管理涉及的数据库表如下。

### 9.4.1 平台库表结构

#### 9.4.1.1 sys_config（系统配置表）

+   存储位置：平台数据库（clarisphere_platform）

+   表结构如下表所示。

    | 列名         | 类型          | 必填 | 默认值            | 说明                                         |
    | ------------ | ------------- | ---- | ----------------- | -------------------------------------------- |
    | id           | BIGINT        | 是   | AUTO_INCREMENT    | 主键，自增                                   |
    | config_key   | VARCHAR(128)  | 是   | -                 | 配置键名，全局唯一                           |
    | config_value | VARCHAR(2000) | 是   | -                 | 配置值，统一存储为字符串                     |
    | config_type  | VARCHAR(16)   | 是   | 'STRING'          | 值类型：STRING/NUMBER/BOOLEAN/JSON/ENCRYPTED |
    | category     | VARCHAR(64)   | 是   | -                 | 配置分类                                     |
    | description  | VARCHAR(256)  | 是   | -                 | 配置说明                                     |
    | is_encrypted | TINYINT(1)    | 是   | 0                 | 是否加密存储                                 |
    | is_editable  | TINYINT(1)    | 是   | 1                 | 是否允许编辑                                 |
    | sort_order   | INT           | 是   | 0                 | 排序序号                                     |
    | created_at   | DATETIME      | 是   | CURRENT_TIMESTAMP | 创建时间                                     |
    | updated_at   | DATETIME      | 是   | CURRENT_TIMESTAMP | 更新时间                                     |

    表 9.4.1.1-1 sys_config表结构

+   索引如下表所示。

    | 索引名            | 列                   | 类型 | 说明         |
    | ----------------- | -------------------- | ---- | ------------ |
    | PRIMARY           | id                   | 主键 | 自增主键     |
    | uk_config_key     | config_key           | 唯一 | 配置键唯一   |
    | idx_category      | category             | 普通 | 分类查询     |
    | idx_category_sort | category, sort_order | 复合 | 分类排序查询 |

    表 9.4.1.1-2 sys_config索引

### 9.4.2 租户库表结构

#### 9.4.2.1 tenant_config（租户配置表）

+   存储位置：各租户数据库（clarisphere_t{tenant_id}）

+   表结构如下表所示。

    | 列名         | 类型          | 必填 | 默认值            | 说明                 |
    | ------------ | ------------- | ---- | ----------------- | -------------------- |
    | id           | BIGINT        | 是   | AUTO_INCREMENT    | 主键，自增           |
    | config_key   | VARCHAR(128)  | 是   | -                 | 配置键名，租户内唯一 |
    | config_value | VARCHAR(2000) | 是   | -                 | 租户覆盖的配置值     |
    | config_type  | VARCHAR(16)   | 是   | 'STRING'          | 值类型               |
    | category     | VARCHAR(64)   | 是   | -                 | 配置分类             |
    | description  | VARCHAR(256)  | 否   | NULL              | 租户自定义说明       |
    | created_at   | DATETIME      | 是   | CURRENT_TIMESTAMP | 创建时间             |
    | updated_at   | DATETIME      | 是   | CURRENT_TIMESTAMP | 更新时间             |

    表 9.4.2.1-1 tenant_config表结构

+   索引如下表所示。

    | 索引名        | 列         | 类型 | 说明     |
    | ------------- | ---------- | ---- | -------- |
    | PRIMARY       | id         | 主键 | 自增主键 |
    | uk_config_key | config_key | 唯一 | 键名唯一 |
    | idx_category  | category   | 普通 | 分类查询 |

    表 9.4.2.1-2 tenant_config索引

### 9.4.3 数据迁移与初始化

#### 9.4.3.1 sys_config 预置数据

+   系统部署初始化时，需向 `sys_config` 表预置以下配置项。这些配置项为平台运行所需的基础安全策略与登录行为默认值，租户配置在无覆盖时将降级读取这些值。

    | configKey                     | configValue    | configType | category          | description                   | isEncrypted | isEditable | sortOrder |
    | ----------------------------- | -------------- | ---------- | ----------------- | ----------------------------- | ----------- | ---------- | --------- |
    | auth.password.minLength       | 8              | NUMBER     | AUTH_PASSWORD     | 密码最小长度                  | 0           | 1          | 100       |
    | auth.password.requireUpper    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含大写字母              | 0           | 1          | 101       |
    | auth.password.requireLower    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含小写字母              | 0           | 1          | 102       |
    | auth.password.requireDigit    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含数字                  | 0           | 1          | 103       |
    | auth.password.requireSpecial  | false          | BOOLEAN    | AUTH_PASSWORD     | 要求包含特殊字符              | 0           | 1          | 104       |
    | auth.password.expireDays      | 0              | NUMBER     | AUTH_PASSWORD     | 密码有效期（天），0表示不过期 | 0           | 1          | 105       |
    | auth.password.historyCount    | 5              | NUMBER     | AUTH_PASSWORD     | 历史密码检查次数              | 0           | 1          | 106       |
    | auth.session.timeout          | 8              | NUMBER     | AUTH_SESSION      | 会话超时时间（小时）          | 0           | 1          | 200       |
    | auth.session.idleTimeout      | 30             | NUMBER     | AUTH_SESSION      | 空闲超时时间（分钟）          | 0           | 1          | 201       |
    | auth.session.multiDevice      | KICK_SAME_TYPE | STRING     | AUTH_SESSION      | 多端登录策略                  | 0           | 1          | 202       |
    | auth.lockout.maxAttempts      | 5              | NUMBER     | AUTH_LOCKOUT      | 最大登录失败次数              | 0           | 1          | 300       |
    | auth.lockout.windowMinutes    | 5              | NUMBER     | AUTH_LOCKOUT      | 失败计数窗口（分钟）          | 0           | 1          | 301       |
    | auth.lockout.durationMinutes  | 15             | NUMBER     | AUTH_LOCKOUT      | 锁定时长（分钟）              | 0           | 1          | 302       |
    | auth.login.allowPassword      | true           | BOOLEAN    | AUTH_LOGIN        | 允许密码登录                  | 0           | 1          | 400       |
    | auth.login.allowSms           | true           | BOOLEAN    | AUTH_LOGIN        | 允许短信登录                  | 0           | 1          | 401       |
    | auth.login.allowSso           | false          | BOOLEAN    | AUTH_LOGIN        | 允许SSO单点登录               | 0           | 1          | 402       |
    | auth.login.allowEnterprise    | false          | BOOLEAN    | AUTH_LOGIN        | 允许企业身份源登录            | 0           | 1          | 403       |
    | auth.login.allowPasswordless  | false          | BOOLEAN    | AUTH_LOGIN        | 允许免密登录                  | 0           | 1          | 404       |
    | auth.mfa.required             | false          | BOOLEAN    | AUTH_MFA          | 强制双因素认证                | 0           | 1          | 500       |
    | auth.mfa.methods              | TOTP           | STRING     | AUTH_MFA          | 双因素认证方式                | 0           | 1          | 501       |
    | auth.captcha.required         | false          | BOOLEAN    | AUTH_CAPTCHA      | 登录强制验证码                | 0           | 1          | 600       |
    | auth.sso.protocol             | OIDC           | STRING     | AUTH_SSO          | SSO协议类型                   | 0           | 1          | 700       |
    | auth.sso.config               | {}             | JSON       | AUTH_SSO          | SSO配置参数（JSON）           | 0           | 1          | 701       |
    | auth.enterprise.config        | {}             | JSON       | AUTH_ENTERPRISE   | 企业身份源配置（JSON）        | 0           | 1          | 800       |
    | auth.passwordless.ipWhitelist | []             | JSON       | AUTH_PASSWORDLESS | 免密登录IP白名单              | 0           | 1          | 900       |
    | auth.ip.whitelistEnabled      | false          | BOOLEAN    | AUTH_IP           | 启用IP白名单访问控制          | 0           | 1          | 1000      |
    | auth.ip.whitelist             | []             | JSON       | AUTH_IP           | IP白名单列表                  | 0           | 1          | 1001      |

    表 9.4.3.1-1 sys_config 预置数据清单

+   **预置说明**：
    -   以上配置项在系统首次部署时通过 Flyway/Liquibase 迁移脚本写入 `sys_config` 表
    -   `sortOrder` 决定同一 `category` 内的前端展示排序
    -   `isEditable = 1` 表示平台管理员可在界面修改；若后续新增不可修改的系统常量，设为 `0`
    -   JSON 类型的空默认值使用 `{}` 或 `[]`，前端根据 `configType` 选择对应的编辑器组件
    -   `auth.password.expireDays = 0` 表示密码不过期，与前端页面"系统默认：不过期"的展示一致

#### 9.4.3.2 tenant_config 预置数据

+   新租户开通时，需向该租户库的 `tenant_config` 表预置以下配置项。预置值与 `sys_config` 系统默认值一致，租户管理员可在此基础上按需覆盖。

    | configKey                     | configValue    | configType | category          | description                   |
    | ----------------------------- | -------------- | ---------- | ----------------- | ----------------------------- |
    | auth.password.minLength       | 8              | NUMBER     | AUTH_PASSWORD     | 密码最小长度                  |
    | auth.password.requireUpper    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含大写字母              |
    | auth.password.requireLower    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含小写字母              |
    | auth.password.requireDigit    | true           | BOOLEAN    | AUTH_PASSWORD     | 要求包含数字                  |
    | auth.password.requireSpecial  | false          | BOOLEAN    | AUTH_PASSWORD     | 要求包含特殊字符              |
    | auth.password.expireDays      | 0              | NUMBER     | AUTH_PASSWORD     | 密码有效期（天），0表示不过期 |
    | auth.password.historyCount    | 5              | NUMBER     | AUTH_PASSWORD     | 历史密码检查次数              |
    | auth.session.timeout          | 8              | NUMBER     | AUTH_SESSION      | 会话超时时间（小时）          |
    | auth.session.idleTimeout      | 30             | NUMBER     | AUTH_SESSION      | 空闲超时时间（分钟）          |
    | auth.session.multiDevice      | KICK_SAME_TYPE | STRING     | AUTH_SESSION      | 多端登录策略                  |
    | auth.lockout.maxAttempts      | 5              | NUMBER     | AUTH_LOCKOUT      | 最大登录失败次数              |
    | auth.lockout.windowMinutes    | 5              | NUMBER     | AUTH_LOCKOUT      | 失败计数窗口（分钟）          |
    | auth.lockout.durationMinutes  | 15             | NUMBER     | AUTH_LOCKOUT      | 锁定时长（分钟）              |
    | auth.login.allowPassword      | true           | BOOLEAN    | AUTH_LOGIN        | 允许密码登录                  |
    | auth.login.allowSms           | true           | BOOLEAN    | AUTH_LOGIN        | 允许短信登录                  |
    | auth.login.allowSso           | false          | BOOLEAN    | AUTH_LOGIN        | 允许SSO单点登录               |
    | auth.login.allowEnterprise    | false          | BOOLEAN    | AUTH_LOGIN        | 允许企业身份源登录            |
    | auth.login.allowPasswordless  | false          | BOOLEAN    | AUTH_LOGIN        | 允许免密登录                  |
    | auth.mfa.required             | false          | BOOLEAN    | AUTH_MFA          | 强制双因素认证                |
    | auth.mfa.methods              | TOTP           | STRING     | AUTH_MFA          | 双因素认证方式                |
    | auth.captcha.required         | false          | BOOLEAN    | AUTH_CAPTCHA      | 登录强制验证码                |
    | auth.sso.protocol             | OIDC           | STRING     | AUTH_SSO          | SSO协议类型                   |
    | auth.sso.config               | {}             | JSON       | AUTH_SSO          | SSO配置参数（JSON）           |
    | auth.enterprise.config        | {}             | JSON       | AUTH_ENTERPRISE   | 企业身份源配置（JSON）        |
    | auth.passwordless.ipWhitelist | []             | JSON       | AUTH_PASSWORDLESS | 免密登录IP白名单              |
    | auth.ip.whitelistEnabled      | false          | BOOLEAN    | AUTH_IP           | 启用IP白名单访问控制          |
    | auth.ip.whitelist             | []             | JSON       | AUTH_IP           | IP白名单列表                  |

    表 9.4.3.2-1 tenant_config 预置数据清单

+   **预置说明**：
    -   以上数据在租户开通流程中由初始化脚本写入租户库 `tenant_config` 表
    -   预置值与 `sys_config` 系统默认值保持一致；租户管理员修改后，该条记录的 `configValue` 即为租户覆盖值
    -   `resetToDefault()` 操作将 `configValue` 重置为当前 `sys_config` 对应键的值，而非删除记录
    -   若平台管理员后续在 `sys_config` 新增配置项，需通过版本迁移脚本向所有已有租户库补写对应的 `tenant_config` 记录

### 9.4.4 Redis 数据结构

+   配置管理使用的 Redis 键如下表所示。

    | 键模式                                      | 类型   | TTL    | 说明             |
    | ------------------------------------------- | ------ | ------ | ---------------- |
    | iam:config:sys:{configKey}                  | String | 10分钟 | 系统配置缓存     |
    | iam:config:tenant:{tenantId}:{configKey}    | String | 5分钟  | 租户配置缓存     |
    | iam:config:sys:all:{category}               | String | 10分钟 | 系统配置分类缓存 |
    | iam:config:tenant:{tenantId}:all:{category} | String | 5分钟  | 租户配置分类缓存 |

    表 9.4.4-1 配置管理 Redis 键

## 9.5 前端设计

+   本节设计配置管理子领域的前端页面，包括页面清单、页面结构和交互设计。
+   配置管理前端分为供给侧（平台管理员管理系统配置）和租户侧（租户管理员管理租户配置）两个入口。

### 9.5.1 页面总览

+   配置管理前端页面清单如下表所示。

    | 页面编号     | 页面名称       | 用户群   | 路由路径                         | 说明                             |
    | ------------ | -------------- | -------- | -------------------------------- | -------------------------------- |
    | PG-P-CFG-01  | 系统配置管理页 | provider | /provider/settings/system-config | 平台管理员管理平台级系统配置     |
    | PG-UR-CFG-01 | 安全策略配置页 | ur       | /tenant/settings/security        | 租户管理员管理认证/密码/会话策略 |
    | PG-UR-CFG-02 | 登录方式配置页 | ur       | /tenant/settings/login-methods   | 租户管理员启停各登录方式         |

    表 9.5.1-1 配置管理页面清单

+   页面导航结构如下图所示。

    ```
    ┌──────────────────────────────────────────────────────────────────┐
    │                      供给侧后台导航                              │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │    系统管理（仅平台管理员可见）                                  │
    │    └── 系统配置                                                  │
    │        └── [PG-P-CFG-01] 系统配置管理页                          │
    │                                                                  │
    ├──────────────────────────────────────────────────────────────────┤
    │                      租户管理后台导航                            │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │    安全设置（仅租户管理员可见）                                  │
    │    ├── [PG-UR-CFG-01] 安全策略配置页                             │
    │    └── [PG-UR-CFG-02] 登录方式配置页                             │
    │                                                                  │
    └──────────────────────────────────────────────────────────────────┘
    ```

    图 9.5.1-1 配置管理页面导航结构

### 9.5.2 页面与接口映射

+   配置管理页面与接口的映射关系如下表所示。

    | 页面编号     | 页面名称       | 关联API                                                    |
    | ------------ | -------------- | ---------------------------------------------------------- |
    | PG-P-CFG-01  | 系统配置管理页 | SYS-CFG-01, SYS-CFG-02, SYS-CFG-03, SYS-CFG-04             |
    | PG-UR-CFG-01 | 安全策略配置页 | TENANT-CFG-01, TENANT-CFG-03, TENANT-CFG-04, TENANT-CFG-05 |
    | PG-UR-CFG-02 | 登录方式配置页 | TENANT-CFG-01, TENANT-CFG-03                               |

    表 9.5.2-1 页面与接口映射

### 9.5.3 功能操作汇总

+   配置管理全部功能操作汇总如下表所示。

    | 页面编号     | 功能编号 | 功能名称           | 功能类型 | 权限标识                        |
    | ------------ | -------- | ------------------ | -------- | ------------------------------- |
    | PG-P-CFG-01  | F01      | 加载配置列表       | 展示     | provider:iam:sys-config:list    |
    | PG-P-CFG-01  | F02      | 切换分类Tab        | 操作     | provider:iam:sys-config:list    |
    | PG-P-CFG-01  | F03      | 点击编辑           | 操作     | provider:iam:sys-config:detail  |
    | PG-P-CFG-01  | F04      | 保存配置           | 操作     | provider:iam:sys-config:update  |
    | PG-UR-CFG-01 | F01      | 加载安全策略       | 展示     | tenant:iam:tenant-config:list   |
    | PG-UR-CFG-01 | F04      | 编辑配置卡片       | 操作     | tenant:iam:tenant-config:update |
    | PG-UR-CFG-01 | F05      | 保存配置           | 操作     | tenant:iam:tenant-config:update |
    | PG-UR-CFG-01 | F06      | 重置为系统默认     | 操作     | tenant:iam:tenant-config:update |
    | PG-UR-CFG-02 | F01      | 加载登录方式状态   | 展示     | tenant:iam:tenant-config:list   |
    | PG-UR-CFG-02 | F02      | 切换登录方式开关   | 操作     | tenant:iam:tenant-config:update |
    | PG-UR-CFG-02 | F03      | 配置SSO详情        | 操作     | tenant:iam:tenant-config:update |
    | PG-UR-CFG-02 | F04      | 配置企业身份源详情 | 操作     | tenant:iam:tenant-config:update |

    表 9.5.3-1 配置管理功能操作汇总

## 9.6 权限设计

### 9.6.1 权限标识定义

+   配置管理模块权限标识采用四段式命名（参见附录D.3），定义如下表所示。

    | 权限标识                        | 名称             | 类型   | 适用用户群 |
    | ------------------------------- | ---------------- | ------ | ---------- |
    | provider:iam:sys-config:list    | 查看系统配置列表 | BUTTON | UP         |
    | provider:iam:sys-config:detail  | 查看系统配置详情 | BUTTON | UP         |
    | provider:iam:sys-config:update  | 修改系统配置     | BUTTON | UP         |
    | tenant:iam:tenant-config:list   | 查看租户配置列表 | BUTTON | UR         |
    | tenant:iam:tenant-config:detail | 查看租户配置详情 | BUTTON | UR         |
    | tenant:iam:tenant-config:update | 修改租户配置     | BUTTON | UR         |

    表 9.6.1-1 配置管理权限标识

### 9.6.2 预置角色权限分配

+   配置管理权限分配给以下预置角色。

    | 预置角色         | 权限                                                           |
    | ---------------- | -------------------------------------------------------------- |
    | UP-06 平台管理员 | sys-config:list, sys-config:detail, sys-config:update          |
    | UR-09 租户管理员 | tenant-config:list, tenant-config:detail, tenant-config:update |

    表 9.6.2-1 配置管理预置角色权限

# 附录A 错误码表

## 附录A.0 说明

+   错误码表全局定义本BC的所有错误码，避免分散在各API中。
+   错误码采用统一编号规则，便于前端统一处理和国际化。
+   各API通过"关联错误码"字段引用本节定义的错误码编号。

### A.0.1 设计原则

+   错误码设计应遵循以下原则：

    | 原则     | 说明                                         |
    | -------- | -------------------------------------------- |
    | 唯一性   | 每个错误码全局唯一，跨BC不重复（可加BC前缀） |
    | 自解释性 | 错误信息能让用户理解问题，避免技术术语       |
    | 可追溯性 | 错误码能关联到具体的业务规则或校验逻辑       |
    | 可国际化 | 错误信息支持i18n，错误码作为消息Key          |
    | 安全性   | 不暴露敏感信息（如SQL、堆栈、内部路径）      |

    表 A.0.1-1 错误码设计原则

### A.0.2 错误码命名规范

+   错误码采用"E-"前缀加6位数字：`E-XXXYYY`
    -   E-：错误码前缀，便于识别
    -   XXX：HTTP状态码（400、401、403、404、409、422、429、500、503）
    -   YYY：业务错误序号（000-999）

### A.0.3 错误码分段规划

+   错误码按HTTP状态码和业务类型分段，便于管理和扩展。

    | 错误码范围        | HTTP状态码 | 错误类型         | 说明                       |
    | ----------------- | ---------- | ---------------- | -------------------------- |
    | E-400001~E-400099 | 400        | 通用参数校验错误 | 缺失、格式、长度等通用校验 |
    | E-400100~E-400199 | 400        | 用户模块错误     | 用户参数校验               |
    | E-400200~E-400299 | 400        | 认证模块错误     | 认证参数校验               |
    | E-400300~E-400399 | 400        | 授权模块错误     | 权限参数校验               |
    | E-400400~E-400499 | 400        | 审计模块错误     | 审计参数校验               |
    | E-401001~E-401999 | 401        | 认证错误         | 登录、Token相关            |
    | E-403001~E-403999 | 403        | 权限错误         | 功能权限、数据权限         |
    | E-404001~E-404999 | 404        | 资源不存在       | 资源未找到                 |
    | E-409001~E-409999 | 409        | 冲突错误         | 并发冲突、乐观锁           |
    | E-422001~E-422999 | 422        | 业务逻辑错误     | 请求合法但业务不允许       |
    | E-429001~E-429999 | 429        | 限流错误         | 请求频率限制               |
    | E-500001~E-500499 | 500        | 系统内部错误     | 未预期异常                 |
    | E-500500~E-500599 | 500        | 依赖服务错误     | 外部服务调用失败           |
    | E-503001~E-503999 | 503        | 服务不可用       | 服务暂时不可用             |

    表 A.0.3-1 错误码分段规划

+   **分段分配原则**：
    -   每个业务模块预留100个错误码位
    -   新模块上线前由架构师分配错误码段
    -   跨模块公用的错误放在通用段（E-400001~E-400099）

+   错误码与API契约表关联说明

    +   错误码管理遵循以下原则：
        -   **全局统一定义**：所有错误码在本附录中集中定义，各接口设计章节不再重复维护错误码表
        -   **契约表引用**：各API契约概述表通过"关联错误码"字段引用本附录中的错误码编号
        -   **扩展规范**：新增业务场景需要新错误码时，按附录A.0.6节规范申请并更新本附录

    +   **API契约概述表示例**：

        | 属性           | 值                                         |
        | -------------- | ------------------------------------------ |
        | API编号        | UR-USR-01                                  |
        | 接口路径       | GET /api/v1/ur/iam/users/{id}              |
        | 功能简述       | 查询租户用户详情                           |
        | 所需权限       | ur:user:detail                             |
        | 关联功能       | F-USR-01 查询用户详情                      |
        | 关联用例       | UC-USR-01 管理员查看用户详情               |
        | 关联领域       | TenantUserQueryService.getDetail()         |
        | 关联规则       | -                                          |
        | 幂等性         | 是（查询接口天然幂等）                     |
        | **关联错误码** | **E-401001, E-401002, E-403001, E-404001** |

        表 A.0.3.1-1 API契约概述表示例

    +   **开发人员使用指南**：
        1.   设计新接口时，先查阅本附录确定可复用的错误码
        2.   在API契约概述表的"关联错误码"字段列出所有可能返回的错误码
        3.   如需新增错误码，按附录A.0.6节流程申请
        4.   前端开发人员根据契约表中的关联错误码实现对应的错误处理逻辑

### A.0.4 通用错误码参考

+   以下通用错误码可直接复用，无需重复定义。

+   **参数校验错误（400）**

    | 错误码   | HTTP状态码 | 错误名称            | 错误描述       |
    | -------- | ---------- | ------------------- | -------------- |
    | E-400001 | 400        | PARAM_INVALID       | 参数校验失败   |
    | E-400002 | 400        | BODY_EMPTY          | 请求体不能为空 |
    | E-400003 | 400        | TYPE_MISMATCH       | 参数类型错误   |
    | E-400004 | 400        | VALUE_OUT_OF_RANGE  | 参数值超出范围 |
    | E-400005 | 400        | LENGTH_EXCEEDED     | 参数长度超限   |
    | E-400006 | 400        | DATE_FORMAT_INVALID | 日期格式错误   |
    | E-400007 | 400        | DATE_RANGE_INVALID  | 日期范围无效   |
    | E-400008 | 400        | ENUM_INVALID        | 枚举值无效     |
    | E-400009 | 400        | JSON_PARSE_ERROR    | JSON格式错误   |
    | E-400010 | 400        | FILE_TYPE_INVALID   | 文件格式不支持 |
    | E-400011 | 400        | FILE_SIZE_EXCEEDED  | 文件大小超限   |
    | E-400012 | 400        | BATCH_SIZE_EXCEEDED | 批量数量超限   |
    | E-400013 | 400        | ID_FORMAT_INVALID   | ID格式错误     |
    | E-400014 | 400        | PAGE_PARAM_INVALID  | 分页参数无效   |
    | E-400015 | 400        | SORT_FIELD_INVALID  | 排序字段不支持 |

    表 A.0.4-1 参数校验错误码

+   **认证错误（401）**

    | 错误码   | HTTP状态码 | 错误名称              | 错误描述       |
    | -------- | ---------- | --------------------- | -------------- |
    | E-401001 | 401        | NOT_LOGGED_IN         | 未登录         |
    | E-401002 | 401        | TOKEN_EXPIRED         | Token已过期    |
    | E-401003 | 401        | TOKEN_INVALID         | Token格式无效  |
    | E-401004 | 401        | TOKEN_REVOKED         | Token已被吊销  |
    | E-401005 | 401        | ACCOUNT_DISABLED      | 账户已被禁用   |
    | E-401006 | 401        | ACCOUNT_LOCKED        | 账户已被锁定   |
    | E-401007 | 401        | SESSION_EXPIRED       | 会话已过期     |
    | E-401008 | 401        | MULTI_DEVICE_CONFLICT | 多设备登录冲突 |

    表 A.0.4-2 认证错误码

+   **权限错误（403）**

    | 错误码   | HTTP状态码 | 错误名称             | 错误描述           |
    | -------- | ---------- | -------------------- | ------------------ |
    | E-403001 | 403        | PERMISSION_DENIED    | 无操作权限         |
    | E-403002 | 403        | DATA_ACCESS_DENIED   | 无数据权限         |
    | E-403003 | 403        | CROSS_TENANT_DENIED  | 跨租户访问被拒绝   |
    | E-403004 | 403        | IP_RESTRICTED        | IP访问受限         |
    | E-403005 | 403        | TIME_RESTRICTED      | 操作时间受限       |
    | E-403006 | 403        | ROLE_INSUFFICIENT    | 角色权限不足       |
    | E-403007 | 403        | RESOURCE_LOCKED      | 资源已被锁定       |
    | E-403008 | 403        | APPROVAL_IN_PROGRESS | 审批流程中禁止修改 |

    表 A.0.4-3 权限错误码

+   **资源不存在错误（404）**

    | 错误码   | HTTP状态码 | 错误名称           | 错误描述       |
    | -------- | ---------- | ------------------ | -------------- |
    | E-404001 | 404        | RESOURCE_NOT_FOUND | 资源不存在     |
    | E-404002 | 404        | API_NOT_FOUND      | 接口不存在     |
    | E-404003 | 404        | REF_NOT_FOUND      | 关联资源不存在 |
    | E-404004 | 404        | FILE_NOT_FOUND     | 文件不存在     |

    表 A.0.4-4 资源不存在错误码

+   **冲突错误（409）**

    | 错误码   | HTTP状态码 | 错误名称            | 错误描述         |
    | -------- | ---------- | ------------------- | ---------------- |
    | E-409001 | 409        | OPTIMISTIC_LOCK     | 数据已被修改     |
    | E-409002 | 409        | CONCURRENT_CONFLICT | 并发操作冲突     |
    | E-409003 | 409        | DUPLICATE_SUBMIT    | 重复提交         |
    | E-409004 | 409        | RESOURCE_PROCESSING | 资源正在处理中   |
    | E-409005 | 409        | LOCK_ACQUIRE_FAILED | 分布式锁获取失败 |

    表 A.0.4-5 冲突错误码

+   **限流错误（429）**

    | 错误码   | HTTP状态码 | 错误名称            | 错误描述         |
    | -------- | ---------- | ------------------- | ---------------- |
    | E-429001 | 429        | RATE_LIMIT_EXCEEDED | 请求过于频繁     |
    | E-429002 | 429        | QUOTA_EXCEEDED      | API配额已用尽    |
    | E-429003 | 429        | EXPORT_RATE_LIMITED | 导出请求过于频繁 |
    | E-429004 | 429        | SMS_RATE_LIMITED    | 验证码发送受限   |

    表 A.0.4-6 限流错误码

+   **系统错误（500/503）**

    | 错误码   | HTTP状态码 | 错误名称            | 错误描述         |
    | -------- | ---------- | ------------------- | ---------------- |
    | E-500001 | 500        | INTERNAL_ERROR      | 系统内部错误     |
    | E-500002 | 500        | DATABASE_ERROR      | 数据库操作异常   |
    | E-500003 | 500        | CACHE_ERROR         | 缓存服务异常     |
    | E-500004 | 500        | MQ_ERROR            | 消息队列异常     |
    | E-500501 | 500        | SERVICE_CALL_FAILED | 依赖服务调用失败 |
    | E-500502 | 500        | SERVICE_TIMEOUT     | 依赖服务超时     |
    | E-503001 | 503        | SERVICE_UNAVAILABLE | 服务暂时不可用   |
    | E-503002 | 503        | SERVICE_OVERLOADED  | 服务过载         |

    表 A.0.4-7 系统错误码

### A.0.5 错误响应格式规范

+   错误响应统一格式如下：

    ```json
    {
      "code": 400002,
      "message": "编码已存在",
      "data": {
        "field": "code",
        "value": "xxx001",
        "suggestion": "请更换一个编码"
      },
      "timestamp": 1706000000000,
      "traceId": "trace-xxx-001"
    }
    ```

+   **响应字段说明**

    | 字段      | 类型   | 必有 | 说明                                                                                            |
    | --------- | ------ | ---- | ----------------------------------------------------------------------------------------------- |
    | code      | Number | 是   | 错误码（去掉E-前缀的数字部分），前端使用 `E-${code}` 作为 i18n 资源 key                         |
    | message   | String | 是   | 用户友好的错误信息                                                                              |
    | data      | Object | 否   | 错误详情，帮助定位问题                                                                          |
    | timestamp | Number | 是   | 错误发生时间戳                                                                                  |
    | traceId   | String | 是   | 分布式链路追踪ID，由网关或APM框架生成，格式为UUID或32位十六进制字符串，跨服务传递，便于排查问题 |

    表 A.0.5-1 错误响应字段说明

+   **data字段可选内容**

    | 字段           | 类型   | 说明                       |
    | -------------- | ------ | -------------------------- |
    | field          | String | 出错的字段名               |
    | value          | Any    | 出错的字段值               |
    | suggestion     | String | 建议的解决方案             |
    | details        | Array  | 多字段校验错误时的详情列表 |
    | allowedValues  | Array  | 允许的枚举值列表           |
    | min / max      | Number | 允许的最小/最大值          |
    | retryAfter     | Number | 限流时建议的重试等待秒数   |
    | currentVersion | Number | 乐观锁冲突时的当前版本     |

    表 A.0.5-2 data字段可选内容

+   **多字段校验错误示例**

    ```json
    {
      "code": 400001,
      "message": "参数校验失败",
      "data": {
        "details": [
          { "field": "code", "message": "编码不能为空" },
          { "field": "name", "message": "名称长度超过限制" }
        ]
      }
    }
    ```

+   **乐观锁冲突示例**

    ```json
    {
      "code": 409001,
      "message": "数据已被修改",
      "data": {
        "expectedVersion": 5,
        "actualVersion": 6,
        "modifiedBy": "张三",
        "suggestion": "请刷新页面获取最新数据后重新编辑"
      }
    }
    ```

### A.0.6 自定义错误码扩展

+   当通用错误码无法覆盖业务场景时，按以下规范自定义。

+   **何时需要自定义**

    | 场景                       | 是否自定义 | 说明                   |
    | -------------------------- | ---------- | ---------------------- |
    | 现有错误码完全匹配         | 否         | 直接复用               |
    | 错误信息需要调整           | 否         | 通过参数化消息定制     |
    | 新业务规则的校验失败       | 是         | 需要新增业务错误码     |
    | 前端需要区分处理的细分场景 | 是         | 同类错误需不同UI处理时 |

    表 A.0.6-1 自定义错误码判断标准

+   **自定义流程**

    | 步骤 | 操作                     | 责任人   |
    | ---- | ------------------------ | -------- |
    | 1    | 确认无法复用现有错误码   | 开发人员 |
    | 2    | 在模块对应的分段申请编号 | 开发人员 |
    | 3    | 更新错误码表并提交评审   | 开发人员 |
    | 4    | 架构师/Tech Lead评审     | 架构师   |
    | 5    | 通知前端同步更新         | 开发人员 |

    表 A.0.6-2 自定义错误码流程

+   **HTTP状态码选择指南**

    | HTTP状态码 | 适用场景                         | 示例                       |
    | ---------- | -------------------------------- | -------------------------- |
    | 400        | 请求格式错误、参数缺失、格式不对 | 必填字段为空、邮箱格式错误 |
    | 422        | 请求格式正确，但业务逻辑不允许   | 余额不足、状态不允许操作   |
    | 409        | 资源冲突、并发冲突               | 编码重复、乐观锁冲突       |

    表 A.0.6-3 HTTP状态码选择指南

+   **错误码命名规范**

    | 规则   | 说明                                   | 示例                         |
    | ------ | -------------------------------------- | ---------------------------- |
    | 前缀   | 统一使用"E-"前缀                       | E-400001                     |
    | HTTP段 | 第1-3位对应HTTP状态码                  | 400、401、403、404、409、422 |
    | 序号段 | 第4-6位为业务序号，按A.0.3分段规划分配 | 001~999                      |
    | 名称   | 全大写，下划线分隔，语义清晰           | USERNAME_DUPLICATE           |

    表 A.0.6-4 错误码命名规范

+   **与API契约表集成要点**：
    -   新增错误码后，必须更新所有引用该错误码的API契约概述表
    -   API契约概述表的"关联错误码"字段应列出所有可能返回的错误码，不遗漏
    -   建议建立错误码与API的双向追溯索引

### A.0.7 前端错误处理指南

+   **HTTP状态码处理策略**

    | HTTP状态码 | 处理策略                          |
    | ---------- | --------------------------------- |
    | 400        | 显示错误信息，高亮出错字段        |
    | 401        | 跳转登录页（可尝试刷新Token）     |
    | 403        | 显示无权限提示，隐藏/禁用操作按钮 |
    | 404        | 显示资源不存在提示，返回列表页    |
    | 409        | 显示冲突提示，引导刷新页面        |
    | 422        | 显示业务错误信息，引导用户修正    |
    | 429        | 显示限流提示和倒计时              |
    | 500/503    | 显示"系统繁忙"提示，提供重试按钮  |

    表 A.0.7-1 HTTP状态码处理策略

### A.0.8 错误码国际化

+   错误码支持国际化（i18n），错误信息从资源文件读取。

+   **资源文件示例**

    ```properties
    # error_messages.properties (中文)
    E-400001=参数校验失败
    E-400101=编码已存在
    E-400201=当前状态不允许激活，当前状态：{0}，目标状态：{1}

    # error_messages_en.properties (英文)
    E-400001=Parameter validation failed
    E-400101=Code already exists
    E-400201=Activation not allowed. Current: {0}, Target: {1}
    ```

## 附录A.1 用户管理子领域错误码

+   本节定义用户管理子领域的专属错误码，与附录A.0通用错误码表配合使用。
+   错误码段分配：E-400100~E-400199（用户参数校验）、E-409100~E-409199（用户冲突）、E-422100~E-422199（用户业务逻辑）。

### A.1.1 用户参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                | 错误描述         |
| -------- | ---------- | ----------------------- | ---------------- |
| E-400100 | 400        | USERNAME_FORMAT_INVALID | 用户名格式无效   |
| E-400101 | 400        | EMAIL_FORMAT_INVALID    | 邮箱格式无效     |
| E-400102 | 400        | MOBILE_FORMAT_INVALID   | 手机号格式无效   |
| E-400103 | 400        | PASSWORD_TOO_WEAK       | 密码强度不足     |
| E-400104 | 400        | PASSWORD_TOO_SHORT      | 密码长度不足     |
| E-400105 | 400        | EMPLOYEE_NO_INVALID     | 员工编号格式无效 |
| E-400106 | 400        | REAL_NAME_INVALID       | 真实姓名格式无效 |

表 A.1.1-1 用户参数校验错误码

### A.1.2 用户业务逻辑错误码（409/422）

| 错误码   | HTTP状态码 | 错误名称                  | 错误描述                   |
| -------- | ---------- | ------------------------- | -------------------------- |
| E-409100 | 409        | USERNAME_DUPLICATE        | 用户名已存在               |
| E-409101 | 409        | EMAIL_DUPLICATE           | 邮箱已被注册               |
| E-409102 | 409        | MOBILE_DUPLICATE          | 手机号已被注册             |
| E-409103 | 409        | EMPLOYEE_NO_DUPLICATE     | 员工编号已存在             |
| E-422100 | 422        | USER_STATUS_INVALID       | 用户状态不允许此操作       |
| E-422101 | 422        | USER_ALREADY_ACTIVATED    | 用户已激活                 |
| E-422102 | 422        | USER_NOT_ACTIVATED        | 用户未激活                 |
| E-422103 | 422        | ACTIVATION_TOKEN_EXPIRED  | 激活令牌已过期             |
| E-422104 | 422        | RESET_CODE_EXPIRED        | 重置验证码已过期           |
| E-422105 | 422        | TRIAL_USER_LIMIT_EXCEEDED | 试用用户数量已达上限       |
| E-422106 | 422        | SYNC_USER_MODIFY_DENIED   | 同步用户不允许本地修改     |
| E-422107 | 422        | SELF_CANCEL_NOT_ALLOWED   | 非自注册用户不允许自助注销 |

表 A.1.2-1 用户业务逻辑错误码

## 附录A.2 认证管理子领域错误码

+   本节定义认证管理子领域的专属错误码，与附录A.0通用错误码表配合使用。
+   错误码段分配：E-401009~E-401099（认证错误扩展）、E-400200~E-400299（认证参数校验）、E-422200~E-422299（认证业务逻辑）。

### A.2.1 认证错误码扩展（401）

| 错误码   | HTTP状态码 | 错误名称              | 错误描述                |
| -------- | ---------- | --------------------- | ----------------------- |
| E-401009 | 401        | SSO_USER_NOT_MAPPED   | SSO用户未映射到本地用户 |
| E-401010 | 401        | SSO_TOKEN_INVALID     | SSO令牌验证失败         |
| E-401011 | 401        | ENTERPRISE_IDP_FAILED | 企业身份源验证失败      |
| E-401012 | 401        | PASSWORDLESS_DENIED   | 免密登录被拒绝          |
| E-401013 | 401        | BIOMETRIC_FAILED      | 生物识别验证失败        |
| E-401014 | 401        | SOCIAL_AUTH_FAILED    | 社交账号验证失败        |
| E-401015 | 401        | SCAN_LOGIN_EXPIRED    | 扫码登录已过期          |
| E-401016 | 401        | SCAN_LOGIN_REJECTED   | 扫码登录被拒绝          |
| E-401017 | 401        | PASSWORD_INCORRECT    | 密码错误                |
| E-401018 | 401        | CAPTCHA_INCORRECT     | 验证码错误              |
| E-401019 | 401        | SMS_CODE_INCORRECT    | 短信验证码错误          |
| E-401020 | 401        | SMS_CODE_EXPIRED      | 短信验证码已过期        |
| E-401021 | 401        | MFA_REQUIRED          | 需要多因素认证          |
| E-401022 | 401        | MFA_TICKET_INVALID    | MFA票据无效             |
| E-401023 | 401        | MFA_TICKET_EXPIRED    | MFA票据已过期           |
| E-401024 | 401        | TENANT_NOT_FOUND      | 租户不存在              |
| E-401025 | 401        | TENANT_DISABLED       | 租户已被禁用            |

表 A.2.1-1 认证错误码扩展

### A.2.2 认证参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                | 错误描述         |
| -------- | ---------- | ----------------------- | ---------------- |
| E-400200 | 400        | SSO_PROTOCOL_INVALID    | 无效的SSO协议    |
| E-400201 | 400        | ENTERPRISE_IDP_INVALID  | 无效的企业身份源 |
| E-400202 | 400        | SOCIAL_PROVIDER_INVALID | 无效的社交平台   |
| E-400203 | 400        | CAPTCHA_REQUIRED        | 需要图形验证码   |
| E-400204 | 400        | CAPTCHA_EXPIRED         | 图形验证码已过期 |
| E-400205 | 400        | DEVICE_ID_INVALID       | 设备指纹无效     |
| E-400206 | 400        | TENANT_CODE_REQUIRED    | 租户编码不能为空 |
| E-400207 | 400        | LOGIN_TYPE_INVALID      | 登录类型无效     |

表 A.2.2-1 认证参数校验错误码

### A.2.3 认证业务逻辑错误码（422）

| 错误码   | HTTP状态码 | 错误名称                  | 错误描述                 |
| -------- | ---------- | ------------------------- | ------------------------ |
| E-422200 | 422        | LOGIN_METHOD_DISABLED     | 该登录方式已被禁用       |
| E-422201 | 422        | SMS_LOGIN_NOT_ENABLED     | 租户未开启短信登录       |
| E-422202 | 422        | PASSWORD_CHANGE_REQUIRED  | 需要修改密码             |
| E-422203 | 422        | PASSWORD_RECENTLY_USED    | 新密码与近期密码重复     |
| E-422204 | 422        | SOCIAL_ALREADY_BOUND      | 该社交账号已被绑定       |
| E-422205 | 422        | SOCIAL_UNBIND_LAST_METHOD | 不能解绑最后一种登录方式 |
| E-422206 | 422        | SESSION_LIMIT_EXCEEDED    | 会话数量已达上限         |
| E-422207 | 422        | REMEMBER_ME_NOT_ALLOWED   | 不允许记住登录           |

表 A.2.3-1 认证业务逻辑错误码

## 附录A.3 授权管理子领域错误码

+   本节定义授权管理子领域的专属错误码，与附录A.0通用错误码表配合使用。
+   错误码段分配：E-403020~E-403099（权限错误扩展）、E-400300~E-400399（权限参数校验）、E-409300~E-409399（权限冲突）、E-422300~E-422399（权限业务逻辑）。

### A.3.1 权限错误码扩展（403）

| 错误码   | HTTP状态码 | 错误名称                  | 错误描述                   |
| -------- | ---------- | ------------------------- | -------------------------- |
| E-403020 | 403        | ROLE_ASSIGN_DENIED        | 无权分配该角色             |
| E-403021 | 403        | PERMISSION_GRANT_DENIED   | 无权授予该权限             |
| E-403022 | 403        | DATA_SCOPE_EXCEEDED       | 超出数据权限范围           |
| E-403023 | 403        | SYSTEM_ROLE_MODIFY_DENIED | 系统预置角色不允许修改     |
| E-403024 | 403        | SYSTEM_PERM_MODIFY_DENIED | 系统预置权限不允许修改     |
| E-403025 | 403        | SELF_ROLE_REMOVE_DENIED   | 不能移除自身角色           |
| E-403026 | 403        | LAST_ADMIN_ROLE_DENIED    | 不能移除最后一个管理员角色 |

表 A.3.1-1 权限错误码扩展

### A.3.2 权限参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                | 错误描述         |
| -------- | ---------- | ----------------------- | ---------------- |
| E-400300 | 400        | ROLE_CODE_INVALID       | 角色编码格式无效 |
| E-400301 | 400        | ROLE_NAME_INVALID       | 角色名称格式无效 |
| E-400302 | 400        | PERMISSION_CODE_INVALID | 权限标识格式无效 |
| E-400303 | 400        | DATA_SCOPE_INVALID      | 数据权限范围无效 |
| E-400304 | 400        | MENU_PATH_INVALID       | 菜单路径格式无效 |

表 A.3.2-1 权限参数校验错误码

### A.3.3 权限业务逻辑错误码（409/422）

| 错误码   | HTTP状态码 | 错误名称                  | 错误描述             |
| -------- | ---------- | ------------------------- | -------------------- |
| E-409300 | 409        | ROLE_CODE_DUPLICATE       | 角色编码已存在       |
| E-409301 | 409        | PERMISSION_CODE_DUPLICATE | 权限标识已存在       |
| E-409302 | 409        | MENU_CODE_DUPLICATE       | 菜单编码已存在       |
| E-422300 | 422        | ROLE_IN_USE               | 角色正在使用中       |
| E-422301 | 422        | PERMISSION_IN_USE         | 权限正在使用中       |
| E-422302 | 422        | MENU_HAS_CHILDREN         | 菜单存在子菜单       |
| E-422303 | 422        | CIRCULAR_ROLE_REF         | 角色继承存在循环引用 |
| E-422304 | 422        | CIRCULAR_MENU_REF         | 菜单层级存在循环引用 |

表 A.3.3-1 权限业务逻辑错误码

## 附录A.4 审计管理子领域错误码

+   本节定义审计管理子领域的专属错误码，与附录A.0通用错误码表配合使用。
+   错误码段分配：E-400400~E-400499（审计参数校验）、E-422400~E-422499（审计业务逻辑）。

### A.4.1 审计参数校验错误码（400）

| 错误码   | HTTP状态码 | 错误名称                   | 错误描述         |
| -------- | ---------- | -------------------------- | ---------------- |
| E-400400 | 400        | AUDIT_DATE_RANGE_EXCEEDED  | 查询日期范围超限 |
| E-400401 | 400        | AUDIT_EXPORT_SIZE_EXCEEDED | 导出数据量超限   |
| E-400402 | 400        | AUDIT_TYPE_INVALID         | 审计类型无效     |

表 A.4.1-1 审计参数校验错误码

### A.4.2 审计业务逻辑错误码（422）

| 错误码   | HTTP状态码 | 错误名称                 | 错误描述           |
| -------- | ---------- | ------------------------ | ------------------ |
| E-422400 | 422        | AUDIT_LOG_NOT_DELETABLE  | 审计日志不允许删除 |
| E-422401 | 422        | AUDIT_EXPORT_IN_PROGRESS | 审计导出任务进行中 |

表 A.4.2-1 审计业务逻辑错误码

## A.5 自定义错误码扩展

+   当通用错误码无法覆盖业务场景时，按以下规范自定义。

+   **何时需要自定义**

    | 场景                       | 是否自定义 | 说明                   |
    | -------------------------- | ---------- | ---------------------- |
    | 现有错误码完全匹配         | 否         | 直接复用               |
    | 错误信息需要调整           | 否         | 通过参数化消息定制     |
    | 新业务规则的校验失败       | 是         | 需要新增业务错误码     |
    | 前端需要区分处理的细分场景 | 是         | 同类错误需不同UI处理时 |

    表 A.5-1 自定义错误码判断标准

+   **自定义流程**

    | 步骤 | 操作                     | 责任人   |
    | ---- | ------------------------ | -------- |
    | 1    | 确认无法复用现有错误码   | 开发人员 |
    | 2    | 在模块对应的分段申请编号 | 开发人员 |
    | 3    | 更新错误码表并提交评审   | 开发人员 |
    | 4    | 架构师/Tech Lead评审     | 架构师   |
    | 5    | 通知前端同步更新         | 开发人员 |

    表 A.5-2 自定义错误码流程

+   **HTTP状态码选择指南**

    | HTTP状态码 | 适用场景                         | 示例                       |
    | ---------- | -------------------------------- | -------------------------- |
    | 400        | 请求格式错误、参数缺失、格式不对 | 必填字段为空、邮箱格式错误 |
    | 422        | 请求格式正确，但业务逻辑不允许   | 余额不足、状态不允许操作   |
    | 409        | 资源冲突、并发冲突               | 编码重复、乐观锁冲突       |

    表 A.5-3 HTTP状态码选择指南

# 附录B 用户概念体系

## B.1 概述

本附录定义BC-10用户与权限上下文中与用户分类相关的核心概念，包括用户侧（UserSide）、用户群（UserPool）、用户类型（UserType）之间的层级关系和适用场景。

这些概念是理解本BC设计的基础，贯穿用户管理、认证、授权、审计四个子领域。

## B.2 概念层级关系

### B.2.1 三层概念体系

系统采用三层概念体系对用户进行分类，如下表所示。

| 层级 | 概念名称 | 英文名称 | 维度     | 说明                               |
| ---- | -------- | -------- | -------- | ---------------------------------- |
| L1   | 用户侧   | UserSide | 业务视角 | 从商业模式角度划分：供给侧、消费侧 |
| L2   | 用户群   | UserPool | 数据视角 | 从数据隔离角度划分：UP、UR、UC     |
| L3   | 用户类型 | UserType | 角色视角 | 从权限角度划分：管理员、普通用户等 |

表 B.2.1-1 用户概念层级

### B.2.2 概念关系图

三层概念的包含关系如下图所示。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户概念层级关系图                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  L1: 用户侧 (UserSide) - 业务视角                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   ┌─────────────────────┐          ┌─────────────────────────────┐  │    │
│  │   │      供给侧         │          │         消费侧              │  │    │
│  │   │    (PROVIDER)       │          │       (CONSUMER)            │  │    │
│  │   └──────────┬──────────┘          └──────────────┬──────────────┘  │    │
│  │              │                                    │                 │    │
│  └──────────────┼────────────────────────────────────┼─────────────────┘    │
│                 │                                    │                      │
│  L2: 用户群 (UserPool) - 数据视角                    │                      │
│  ┌──────────────┼────────────────────────────────────┼─────────────────┐    │
│  │              │                           ┌────────┴────────┐        │    │
│  │              ▼                           │                 │        │    │
│  │   ┌──────────────────┐          ┌────────┴───────┐  ┌──────┴─────┐  │    │
│  │   │        UP        │          │       UR       │  │     UC     │  │    │
│  │   │  (运营用户群)    │          │ (租户用户群)   │  │(C端用户群) │  │    │
│  │   │ clarisphere_     │          │clarisphere_    │  │ clarisphere│  │    │
│  │   │   platform       │          │ t{tenant_id}   │  │ _consumer  │  │    │
│  │   └──────────┬───────┘          └────────┬───────┘  └──────┬─────┘  │    │
│  │              │                           │                 │        │    │
│  └──────────────┼───────────────────────────┼─────────────────┼────────┘    │
│                 │                           │                 │             │
│  L3: 用户类型 (UserType) - 角色视角         │                 │             │
│  ┌──────────────┼───────────────────────────┼─────────────────┼────────┐    │
│  │         ┌────┴────┐                 ┌────┴────┐            │        │    │
│  │         ▼         ▼                 ▼         ▼            ▼        │    │
│  │   ┌──────────┐ ┌──────────┐   ┌──────────┐ ┌──────────┐ ┌────────┐  │    │
│  │   │PROVIDER_ │ │PROVIDER_ │   │UR_ADMIN  │ │UR_USER   │ │UC_USER │  │    │
│  │   │  ADMIN   │ │  USER    │   │          │ │          │ │        │  │    │
│  │   └──────────┘ └──────────┘   └──────────┘ └──────────┘ └────────┘  │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

图 B.2.2-1 用户概念层级关系图

## B.3 核心概念定义

### B.3.1 用户侧（UserSide）

用户侧是从**商业模式视角**对用户的二分法划分，定义如下表所示。

| 枚举值   | 编码     | 名称   | 说明                                     |
| -------- | -------- | ------ | ---------------------------------------- |
| PROVIDER | provider | 供给侧 | 平台运营方的用户，负责平台内容建设和运营 |
| CONSUMER | consumer | 消费侧 | 平台的客户和最终用户，消费平台提供的服务 |

表 B.3.1-1 UserSide 用户侧枚举

### B.3.2 用户群（UserPool）

用户群是从**数据隔离视角**对用户的划分，每个用户群对应独立的数据存储，定义如下表所示。

| 枚举值 | 编码 | 全称          | 中文名称   | 所属用户侧 | 对应数据库               |
| ------ | ---- | ------------- | ---------- | ---------- | ------------------------ |
| UP     | up   | User Provider | 运营用户群 | PROVIDER   | clarisphere_platform     |
| UR     | ur   | User Renter   | 租户用户群 | CONSUMER   | clarisphere_t{tenant_id} |
| UC     | uc   | User Consumer | C端用户群  | CONSUMER   | clarisphere_consumer     |

表 B.3.2-1 UserPool 用户群枚举

**用户群与URL路径的映射关系：**

| 用户群 | API路径前缀（标准） | API路径前缀（兼容） | 前端应用        |
| ------ | ------------------- | ------------------- | --------------- |
| UP     | /api/v1/up/**       | /api/v1/provider/** | 供给侧管理/运营 |
| UR     | /api/v1/ur/**       | /api/v1/tenant/**   | 租户管理/工作台 |
| UC     | /api/v1/uc/**       | /api/v1/consumer/** | 个人门户        |

表 B.3.2-2 用户群与URL路径映射

### B.3.3 用户类型（UserType）

用户类型是从**权限视角**对用户的细分，区分管理员和普通用户，定义如下表所示。

| 枚举值         | 编码           | 中文名称     | 所属用户群 | 说明                   |
| -------------- | -------------- | ------------ | ---------- | ---------------------- |
| PROVIDER_ADMIN | provider_admin | 运营方管理员 | UP         | 运营方系统管理人员     |
| PROVIDER_USER  | provider_user  | 运营方用户   | UP         | 运营方业务操作人员     |
| UR_ADMIN       | ur_admin       | 租户管理员   | UR         | 企业租户的IT管理人员   |
| UR_USER        | ur_user        | 租户用户     | UR         | 企业租户的业务使用人员 |
| UC_USER        | uc_user        | 个人用户     | UC         | 独立的C端个人用户      |

表 B.3.3-1 UserType 用户类型枚举

## B.4 概念间的完整映射

用户侧、用户群、用户类型三者的完整对应关系如下表所示。

| 用户侧   | 用户群 | 用户类型       | 数据库                   | 典型角色       | 典型人数  |
| -------- | ------ | -------------- | ------------------------ | -------------- | --------- |
| PROVIDER | UP     | PROVIDER_ADMIN | clarisphere_platform     | 系统管理员     | 十级      |
| PROVIDER | UP     | PROVIDER_USER  | clarisphere_platform     | 知识运营专员   | 百级      |
| CONSUMER | UR     | UR_ADMIN       | clarisphere_t{tenant_id} | 租户超级管理员 | 百级/租户 |
| CONSUMER | UR     | UR_USER        | clarisphere_t{tenant_id} | 合规专员       | 万级/租户 |
| CONSUMER | UC     | UC_USER        | clarisphere_consumer     | 个人学习者     | 百万级    |

表 B.4-1 用户概念完整映射表

## B.5 概念使用场景

不同场景下应使用的概念如下表所示。

| 场景           | 推荐使用概念 | 原因说明                         |
| -------------- | ------------ | -------------------------------- |
| 数据库路由决策 | UserPool     | 用户群直接对应数据库实例         |
| API路径设计    | UserPool     | 路径前缀按用户群划分             |
| 登录入口选择   | UserPool     | 不同用户群使用不同登录页面       |
| 前端应用区分   | UserSide     | 供给侧和消费侧使用不同的前端应用 |
| 角色权限分配   | UserType     | 不同用户类型对应不同预置角色     |
| 功能可见性控制 | UserType     | 管理员和普通用户看到不同功能     |

表 B.5-1 概念使用场景指南

# 附录C 枚举定义统一表

## C.1 概述

本附录汇总BC-10所有枚举的标准定义，作为各章节枚举使用的权威参照。当各章节枚举定义与本附录不一致时，以本附录为准。

## C.2 用户相关枚举

### C.2.1 UserSide 用户侧

| Java枚举值 | 数据库存储值 | API参数值 | 中文名称 |
| ---------- | ------------ | --------- | -------- |
| PROVIDER   | PROVIDER     | provider  | 供给侧   |
| CONSUMER   | CONSUMER     | consumer  | 消费侧   |

表 C.2.1-1 UserSide枚举定义

### C.2.2 UserPool 用户群

| Java枚举值 | 数据库存储值 | API路径前缀（标准） | API路径前缀（兼容） | API参数值 | 中文名称   |
| ---------- | ------------ | ------------------- | ------------------- | --------- | ---------- |
| UP         | UP           | /up/                | /provider/          | up        | 运营用户群 |
| UR         | UR           | /ur/                | /tenant/            | ur        | 租户用户群 |
| UC         | UC           | /uc/                | /consumer/          | uc        | C端用户群  |

表 C.2.2-1 UserPool枚举定义

### C.2.3 UserType 用户类型

| Java枚举值     | 数据库存储值   | API参数值      | 中文名称     | 所属UserPool |
| -------------- | -------------- | -------------- | ------------ | ------------ |
| PROVIDER_ADMIN | provider_admin | provider_admin | 运营方管理员 | UP           |
| PROVIDER_USER  | provider_user  | provider_user  | 运营方用户   | UP           |
| UR_ADMIN       | ur_admin       | ur_admin       | 租户管理员   | UR           |
| UR_USER        | ur_user        | ur_user        | 租户用户     | UR           |
| UC_USER        | uc_user        | uc_user        | 个人用户     | UC           |

表 C.2.3-1 UserType枚举定义

### C.2.4 UserStatus 用户状态

| Java枚举值 | 数据库存储值 | API参数值 | 中文名称 | 可流转至                     |
| ---------- | ------------ | --------- | -------- | ---------------------------- |
| PENDING    | PENDING      | pending   | 待激活   | ACTIVE                       |
| ACTIVE     | ACTIVE       | active    | 正常     | DISABLED, DELETED, CANCELLED |
| DISABLED   | DISABLED     | disabled  | 已禁用   | ACTIVE, DELETED              |
| DELETED    | DELETED      | deleted   | 已删除   | -（终态）                    |
| CANCELLED  | CANCELLED    | cancelled | 已注销   | -（终态）                    |

表 C.2.4-1 UserStatus枚举定义

### C.2.5 AuthSource 认证来源

| Java枚举值 | 数据库存储值 | API参数值 | 中文名称    | 适用UserPool |
| ---------- | ------------ | --------- | ----------- | ------------ |
| LOCAL      | LOCAL        | local     | 本地认证    | UP, UR, UC   |
| SSO        | SSO          | sso       | 企业SSO认证 | UR           |
| SYNC       | SYNC         | sync      | 企业同步    | UR           |
| LDAP       | LDAP         | ldap      | LDAP认证    | UR           |

表 C.2.5-1 AuthSource枚举定义

### C.2.6 SourceType 用户来源类型

| Java枚举值      | 数据库存储值    | API参数值       | 中文名称   | 适用UserPool |
| --------------- | --------------- | --------------- | ---------- | ------------ |
| ADMIN_CREATED   | ADMIN_CREATED   | admin_created   | 管理员创建 | UP, UR       |
| SELF_REGISTERED | SELF_REGISTERED | self_registered | 开放注册   | UR, UC       |
| SYNCED          | SYNCED          | synced          | 企业同步   | UR           |

表 C.2.6-1 SourceType枚举定义

## C.3 枚举命名规范

| 场景         | 命名规范                       | 示例             |
| ------------ | ------------------------------ | ---------------- |
| Java枚举值   | 大写下划线（UPPER_SNAKE_CASE） | PROVIDER_ADMIN   |
| 数据库存储值 | 与Java枚举值一致或小写下划线   | provider_admin   |
| API参数值    | 小写下划线（lower_snake_case） | provider_admin   |
| URL路径      | 小写英文单词                   | /up/, /ur/, /uc/ |

表 C.3-1 枚举命名规范

# 附录 D 权限相关参数

## D.1 系统预置角色清单

### D.1.1 运营用户群预置角色（UP）

+   运营用户群系统预置角色：

    | 角色编码 | 角色名称     | data_scope | 核心权限               |
    | -------- | ------------ | ---------- | ---------------------- |
    | UP-01    | 外规采集专员 | -          | 采集任务管理、落库管理 |
    | UP-02    | 外规编辑     | -          | 外规编辑、版本管理     |
    | UP-03    | 外规审核员   | -          | 外规审核、发布         |
    | UP-04    | 方案设计师   | -          | 方案设计、提交审核     |
    | UP-05    | 质检审核员   | -          | 方案质检、审核         |
    | UP-06    | 平台管理员   | -          | 用户管理、系统配置     |

    表 D.1.1-1 运营用户群预置角色

### D.1.2 租户用户群预置角色（UR）

+   租户用户群系统预置角色：

    | 角色编码 | 角色名称   | data_scope  | 核心权限                   |
    | -------- | ---------- | ----------- | -------------------------- |
    | UR-01    | CISO       | 4(全部)     | 全部数据读取、安全配置     |
    | UR-02    | 制度管理员 | 3(部门及下) | 制度CRUD、发布             |
    | UR-03    | 培训管理员 | 3(部门及下) | 培训CRUD、学员管理         |
    | UR-04    | 风险管理员 | 3(部门及下) | 风险CRUD、评估             |
    | UR-05    | 执行人     | 1(仅本人)   | 任务执行、自评             |
    | UR-06    | 内审员     | 4(全部)     | 审计计划、检查记录（只读） |
    | UR-07    | 安全经理   | 3(部门及下) | 部门安全管理               |
    | UR-08    | 合规经理   | 4(全部)     | 合规监控、报告             |
    | UR-09    | 租户管理员 | 4(全部)     | 用户管理、角色配置         |
    | UR-10    | 普通员工   | 1(仅本人)   | 查看指派任务、完成学习     |

    表 D.1.2-1 租户用户群预置角色

### D.1.3 C端用户群预置角色（UC）

+   C端用户群系统预置角色：

    | 角色编码 | 角色名称 | 配额限制          | 核心权限               |
    | -------- | -------- | ----------------- | ---------------------- |
    | UC-01    | 游客     | 搜索3次/天        | 外规搜索（摘要）       |
    | UC-02    | 免费用户 | 搜索10次/天       | 外规搜索（全文）、收藏 |
    | UC-03    | 基础会员 | 搜索50次/天,下载3 | 搜索、下载、历史       |
    | UC-04    | 高级会员 | 不限              | 全部功能、API访问      |

    表 D.1.3-1 C端用户群预置角色

## D.2 角色互斥配置清单

+   系统预置的角色互斥规则：

    | 角色A | 角色B | 互斥级别 | 互斥原因                   |
    | ----- | ----- | -------- | -------------------------- |
    | UR-06 | UR-07 | 禁止     | 内审员与安全经理职责冲突   |
    | UR-06 | UR-08 | 禁止     | 内审员与合规经理职责冲突   |
    | UP-04 | UP-05 | 禁止     | 方案设计师与质检审核员冲突 |
    | UR-02 | UR-06 | 警告     | 制度管理员与内审员不宜兼任 |

    表 D.2-1 角色互斥配置清单

## D.3 权限标识命名规范

+   四段式权限标识命名规范：

    | 段位   | 命名规则   | 示例值                               |
    | ------ | ---------- | ------------------------------------ |
    | 第一段 | 用户群编码 | up、ur、uc                           |
    | 第二段 | 限界上下文 | acquisition、landing、applying       |
    | 第三段 | 资源       | mandate、policy、task                |
    | 第四段 | 操作       | list、detail、create、update、delete |

    表 D.3-1 权限标识命名规范

+   完整示例：

    | 权限标识                      | 含义                      |
    | ----------------------------- | ------------------------- |
    | up:acquisition:mandate:list   | 运营用户群-采集-任务-列表 |
    | ur:landing:policy:create      | 租户用户群-落库-制度-创建 |
    | uc:search:regulation:download | C端用户群-搜索-外规-下载  |
    | up:permission:role:update     | 运营用户群-权限-角色-更新 |
    | ur:iam:org:create             | 租户用户群-IAM-组织-创建  |
    | ur:iam:position:list          | 租户用户群-IAM-岗位-列表  |
    | ur:iam:person:detail          | 租户用户群-IAM-人员-详情  |
    | ur:iam:appointment:update     | 租户用户群-IAM-任职-修改  |
    | ur:iam:sync:execute           | 租户用户群-IAM-同步-执行  |

    表 D.3-2 权限标识示例

## D.4 开发检查清单

### D.4.1 后端开发检查清单

+   后端权限开发检查项：

    | 检查项                          | 必须   | 说明                   |
    | ------------------------------- | ------ | ---------------------- |
    | Controller方法添加@PreAuthorize | 是     | 除公开接口外都需要     |
    | 权限标识使用常量类              | 是     | 禁止硬编码字符串       |
    | Service方法添加@DataScope       | 视情况 | 涉及租户数据的查询方法 |
    | 敏感操作记录审计日志            | 是     | 角色、权限变更操作     |
    | 接口返回统一错误码              | 是     | PERMISSION_DENIED等    |

    表 D.4.1-1 后端开发检查清单

### D.4.2 前端开发检查清单

+   前端权限开发检查项：

    | 检查项                 | 必须 | 说明               |
    | ---------------------- | ---- | ------------------ |
    | 按钮添加v-has-perm指令 | 是   | 需要权限控制的按钮 |
    | 权限标识与后端一致     | 是   | 前后端使用相同标识 |
    | 处理403响应            | 是   | 给用户友好提示     |
    | 处理401响应            | 是   | 跳转登录页         |

    表 D.4.2-1 前端开发检查清单

## D.5 性能指标要求

+   权限校验相关性能指标：

    | 指标项              | 目标值  | 告警阈值 | 说明           |
    | ------------------- | ------- | -------- | -------------- |
    | 权限校验耗时        | < 5ms   | > 20ms   | 缓存命中情况下 |
    | 缓存命中率          | > 95%   | < 90%    | L1 + L2合计    |
    | 数据权限SQL注入耗时 | < 10ms  | > 20ms   | 包含部门树查询 |
    | 多角色合并耗时      | < 3ms   | > 10ms   | 5个角色以内    |
    | 菜单加载耗时        | < 100ms | > 500ms  | 首次加载       |

    表 D.5-1 权限校验性能指标
