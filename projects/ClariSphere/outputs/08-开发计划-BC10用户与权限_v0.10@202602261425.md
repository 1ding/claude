# BC-10 用户与权限上下文 Sprint开发计划

## 项目信息

| 项目       | 内容                                             |
| ---------- | ------------------------------------------------ |
| 项目名称   | ClariSphere(透管云) BC-10 重构                   |
| 限界上下文 | BC-10 用户与权限上下文 (IAM)                     |
| Sprint周期 | 2周（2026-01-26 ~ 2026-02-06）                   |
| 团队配置   | 前端2人、UI 1人、后端1人、测试2人                |
| 项目背景   | 现有功能重构，基于新设计实现持续迭代能力         |
| 参考文档   | 《透管云-07-详细设计-BC10用户与权限上下文v0_40》 |

## 团队成员与职责

| 角色  | 人数 | 主要职责                                            |
| ----- | ---- | --------------------------------------------------- |
| 后端  | 1人  | 领域模型实现、API开发、数据库设计、认证授权核心逻辑 |
| 前端A | 1人  | 供给侧+租户侧页面开发                               |
| 前端B | 1人  | 个人侧+公共页面开发、组件封装                       |
| UI    | 1人  | 界面设计、设计规范、切图交付                        |
| 测试A | 1人  | 用户管理+认证管理测试                               |
| 测试B | 1人  | 授权管理+审计管理测试                               |

## Sprint 总览

### 第一周：核心基础（1月26日-1月30日）

-   **重点**：用户管理核心、认证管理核心
-   **目标**：完成三端用户CRUD和登录认证
-   **涉及章节**：第3章用户管理、第5章认证管理

### 第二周：权限与完善（2月2日-2月6日）

-   **重点**：授权管理、审计管理、联调测试
-   **目标**：完成角色权限、审计日志、端到端测试
-   **涉及章节**：第4章组织管理、第6章授权管理、第7章审计管理

---

## 第一周详细计划（1月26日-1月30日）

---

### 用户故事EP1-1: 用户管理基础架构

**故事名称**: 搭建用户管理子领域基础架构和数据模型
**故事点数**: 13
**优先级**: P0
**工作时间**: 2个工作日（1月26日-1月27日）
**设计文档参考**:
-   3.3节 领域模型设计
-   3.5节 数据模型设计
-   2.7节 架构总览

**验收标准**:
-   三库（platform/tenant/consumer）用户表结构创建完成
-   领域模型（PlatformUser/TenantUser/ConsumerUser）实现
-   仓储接口和实现类完成
-   动态数据源路由正常工作
-   共享服务（PasswordService、TokenService）完成

#### 任务1.1: 数据库表结构设计与创建

**责任人**: 后端
**估时**: 4小时
**工作日期**: 1月26日周一上午
**设计文档参考**: 3.5节 数据模型设计

**子任务1.1.1: 创建platform库用户相关表**
-   **参考**: 3.5.2节 平台库表结构
-   **表清单**:
    -   `iam_user` (表3.5.2.1-1)
    -   `iam_activation_token` (表3.5.2.2-1)
    -   `iam_password_history` (表3.5.2.3-1)

**子任务1.1.2: 创建tenant库用户相关表**
-   **参考**: 3.5.3节 租户库表结构
-   **表清单**:
    -   `iam_user` 租户版 (表3.5.3.1-1)
    -   `iam_activation_token`
    -   `iam_password_history`

**子任务1.1.3: 创建consumer库用户相关表**
-   **参考**: 3.5.4节 消费者库表结构
-   **表清单**:
    -   `iam_user` 个人版 (表3.5.4.1-1)
    -   `iam_oauth_binding` (表3.5.4.2-1)

**验收标准**:
-   DDL脚本与设计文档表结构一致
-   索引设计符合设计文档要求
-   支持逻辑删除(deleted_at字段)

#### 任务1.2: 领域模型实现

**责任人**: 后端
**估时**: 6小时
**工作日期**: 1月26日周一下午
**设计文档参考**: 3.3节 领域模型设计

**子任务1.2.1: 实现PlatformUser聚合根**
-   **参考**: 3.3.3节 PlatformUser聚合
-   **属性清单**: 表3.3.3.2-1
-   **业务规则**: 表3.3.3.2-2 (PU-R-01~PU-R-12)
-   **业务方法**: 表3.3.3.2-3

**子任务1.2.2: 实现TenantUser聚合根**
-   **参考**: 3.3.4节 TenantUser聚合
-   **属性清单**: 表3.3.4.2-1
-   **业务规则**: 表3.3.4.2-2 (TU-R-01~TU-R-09)
-   **业务方法**: 表3.3.4.2-3

**子任务1.2.3: 实现ConsumerUser聚合根**
-   **参考**: 3.3.5节 ConsumerUser聚合
-   **属性清单**: 表3.3.5.2-1
-   **业务规则**: 表3.3.5.2-2 (CU-R-01~CU-R-12)
-   **值对象**: OAuthBinding(3.3.5.3), SubscriptionLevel(3.3.5.4)

**验收标准**:
-   聚合根封装完整的业务规则
-   业务规则编号与设计文档一致
-   领域事件(表3.3.7-1)定义完成

#### 任务1.3: 仓储层实现

**责任人**: 后端
**估时**: 4小时
**工作日期**: 1月27日周二上午
**设计文档参考**: 3.8节 后端工程结构设计

**子任务1.3.1: 实现三端UserRepository**
-   **参考**: 3.8.2节 模块划分
-   **仓储接口**: PlatformUserRepository / TenantUserRepository / ConsumerUserRepository
-   **基础方法**: save(), findById(), findByEmail(), findByUsername(), existsByEmail()

**子任务1.3.2: 实现动态数据源路由**
-   **参考**: 2.7.3节 数据源路由 (表2.7.3-1)
-   **路由规则**:
    -   /api/v1/provider/** → clarisphere_platform
    -   /api/v1/tenant/** → clarisphere_<tenant_code>
    -   /api/v1/consumer/** → clarisphere_consumer

**验收标准**:
-   仓储正确映射到不同数据库
-   数据源路由根据请求自动切换

#### 任务1.4: 共享服务实现

**责任人**: 后端
**估时**: 4小时
**工作日期**: 1月27日周二下午
**设计文档参考**: 2.7.4节 共享服务、5.3节 领域模型

**子任务1.4.1: 实现PasswordService**
-   **参考**: 3.3.6.2节 PasswordService (表3.3.6.2-1)
-   **方法**: hashPassword(), verifyPassword(), checkPasswordPolicy(), checkPasswordHistory()
-   **密码策略**: 参考5.3.3.3节 PasswordPolicy (表5.3.3.3-2 用户群默认策略)

**子任务1.4.2: 实现TokenService**
-   **参考**: 5.3.5节 Token聚合
-   **令牌有效期**: 表5.3.5.2-3
-   **业务规则**: 表5.3.5.2-4 (TK-R-01~TK-R-08)

**子任务1.4.3: 实现CaptchaService**
-   **参考**: 5.3.9.4节 VerificationCodeService (表5.3.9.4-1)
-   **方法**: generateImageCaptcha(), sendSmsCode(), sendEmailCode(), verifyCode()

**验收标准**:
-   密码加密使用Argon2id/BCrypt (CRED-R-03)
-   Token包含userId, userPool, tenantId等声明
-   验证码有效期5分钟

#### 任务1.5: UI设计-用户管理页面

**责任人**: UI
**估时**: 8小时
**工作日期**: 1月26日周一-1月27日周二
**设计文档参考**: 3.6节 前端设计、3.9节 前端工程结构设计

**子任务1.5.1: 供给侧用户管理设计**
-   **页面编号**: PG-P-USR-01, PG-P-USR-02, PG-P-USR-03
-   **参考**: 表3.9.4-1 页面与组件映射

**子任务1.5.2: 租户侧用户管理设计**
-   **页面编号**: PG-UR-USR-01, PG-UR-USR-02, PG-UR-USR-03, PG-UR-USR-04
-   **参考**: 表3.9.4-1

**子任务1.5.3: 个人侧页面设计**
-   **页面编号**: PG-UC-USR-01, PG-UC-USR-02, PG-UC-USR-03, PG-UC-USR-04
-   **参考**: 表3.9.4-1

**验收标准**:
-   设计稿符合设计规范
-   页面编号与设计文档一致

---

### 用户故事EP1-2: 供给侧用户管理

**故事名称**: 实现供给侧用户的创建、查询、编辑、禁用功能
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（1月27日下午-1月28日）
**设计文档参考**:
-   流程: FL-P-01 (3.2.3节)
-   接口: P-USR-01~P-USR-09 (3.4.2节)

**验收标准**:
-   管理员可创建供给侧用户
-   支持用户列表查询（分页、筛选）
-   支持用户信息编辑
-   支持用户状态变更（禁用/启用）
-   创建用户时发送激活邮件

#### 任务2.1: 供给侧用户API开发

**责任人**: 后端
**估时**: 6小时
**工作日期**: 1月27日周二下午-1月28日周三上午
**设计文档参考**: 3.4.2节 供给侧用户接口

**子任务2.1.1: 实现用户创建API (P-USR-01)**
-   **接口**: POST /api/v1/provider/iam/users
-   **参考**: 3.4.2.2节 (表3.4.2.2-1, 表3.4.2.2-2)
-   **关联流程**: FL-P-01 供给侧用户创建流程 (3.2.3节)
-   **业务规则**: 用户名唯一、邮箱唯一、生成随机初始密码、发送激活邮件

**子任务2.1.2: 实现用户查询API (P-USR-02, P-USR-03)**
-   **接口**:
    -   GET /api/v1/provider/iam/users (列表分页)
    -   GET /api/v1/provider/iam/users/{id} (详情)
-   **支持筛选**: userType, status, keyword

**子任务2.1.3: 实现用户编辑API (P-USR-04)**
-   **接口**: PUT /api/v1/provider/iam/users/{id}
-   **可编辑**: realName, phone, roleIds
-   **不可编辑**: username, email

**子任务2.1.4: 实现用户状态变更API (P-USR-05~P-USR-07)**
-   **接口**:
    -   POST /api/v1/provider/iam/users/{id}/disable (P-USR-06)
    -   POST /api/v1/provider/iam/users/{id}/enable (P-USR-07)
    -   DELETE /api/v1/provider/iam/users/{id} (P-USR-05)

**验收标准**:
-   接口编号与设计文档一致
-   业务规则符合FL-P-01流程定义

#### 任务2.2: 供给侧用户页面开发

**责任人**: 前端A
**估时**: 8小时
**工作日期**: 1月28日周三
**设计文档参考**: 3.9节 前端工程结构设计

**子任务2.2.1: 用户列表页开发 (PG-P-USR-01)**
-   **路由**: /provider/system/users
-   **组件路径**: src/views/iam/provider/user/index.vue
-   **功能**: 表格展示、分页、搜索、筛选

**子任务2.2.2: 用户创建/编辑弹窗开发 (PG-P-USR-02)**
-   **组件路径**: src/views/iam/provider/user/create.vue
-   **表单验证、角色选择

**子任务2.2.3: 用户详情页开发 (PG-P-USR-03)**
-   **组件路径**: src/views/iam/provider/user/detail.vue

**验收标准**:
-   页面编号与设计文档对应
-   调用接口编号正确

---

### 用户故事EP1-3: 租户侧用户管理

**故事名称**: 实现租户侧用户的创建、查询、编辑功能
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（1月28日下午-1月29日）
**设计文档参考**:
-   流程: FL-UR-01 (3.2.7节)
-   接口: UR-USR-01~UR-USR-13 (3.4.3节)

**验收标准**:
-   租户管理员可创建用户
-   支持用户列表查询
-   支持用户信息编辑
-   支持设置用户组织岗位

#### 任务3.1: 租户侧用户API开发

**责任人**: 后端
**估时**: 5小时
**工作日期**: 1月28日周三下午
**设计文档参考**: 3.4.3节 租户用户接口

**子任务3.1.1: 实现租户用户创建API (UR-USR-01)**
-   **接口**: POST /api/v1/tenant/iam/users
-   **参考**: 3.4.3.2节 (表3.4.3.2-1)
-   **关联流程**: FL-UR-01 租户用户创建流程
-   **额外字段**: employeeNo, orgUnitId, positionId
-   **业务规则**: 试用租户最多5人、用户来源标记为ADMIN_CREATED

**子任务3.1.2: 实现租户用户查询API (UR-USR-02, UR-USR-03)**
-   **接口**:
    -   GET /api/v1/tenant/iam/users
    -   GET /api/v1/tenant/iam/users/{id}
-   **额外筛选**: orgUnitId, positionId, sourceType

**子任务3.1.3: 实现租户用户编辑和组织分配API (UR-USR-04, UR-USR-10)**
-   **接口**:
    -   PUT /api/v1/tenant/iam/users/{id} (UR-USR-04)
    -   POST /api/v1/tenant/iam/users/{id}/assign-org (UR-USR-10)
-   **参考**: 3.4.3.3节

**验收标准**:
-   租户数据隔离正确
-   接口编号与设计文档一致

#### 任务3.2: 租户侧用户页面开发

**责任人**: 前端A
**估时**: 6小时
**工作日期**: 1月29日周四
**设计文档参考**: 3.9节

**子任务3.2.1: 用户列表页开发 (PG-UR-USR-01)**
-   **路由**: /tenant/system/users
-   **组件路径**: src/views/iam/tenant/user/index.vue

**子任务3.2.2: 用户创建页开发 (PG-UR-USR-02)**
-   **组件路径**: src/views/iam/tenant/user/create.vue
-   **组织选择器组件**

**子任务3.2.3: 用户详情页开发 (PG-UR-USR-03)**
-   **组件路径**: src/views/iam/tenant/user/detail.vue

**验收标准**:
-   页面编号与设计文档对应

---

### 用户故事EP1-4: 个人侧用户注册

**故事名称**: 实现个人用户的手机/邮箱注册和三方登录注册
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（1月29日-1月30日上午）
**设计文档参考**:
-   流程: FL-UC-01 (3.2.10节), FL-UC-02 (3.2.11节)
-   接口: PUB-01~PUB-09 (3.4.5节)

**验收标准**:
-   支持手机号+验证码注册
-   支持邮箱+验证码注册
-   支持三方账号（微信/QQ）授权注册
-   注册成功后自动登录

#### 任务4.1: 个人用户注册API开发

**责任人**: 后端
**估时**: 5小时
**工作日期**: 1月29日周四上午-下午
**设计文档参考**: 3.4.5节 公共接口

**子任务4.1.1: 实现手机号注册API (PUB-01)**
-   **接口**: POST /api/v1/public/iam/register/mobile
-   **参考**: 3.4.5.1节 (表3.4.5.1-1, 表3.4.5.1-2)
-   **关联流程**: FL-UC-01 个人用户注册流程

**子任务4.1.2: 实现邮箱注册API (PUB-02)**
-   **接口**: POST /api/v1/public/iam/register/email
-   **参考**: 3.4.5.2节

**子任务4.1.3: 实现三方授权注册API (PUB-08, PUB-09)**
-   **接口**:
    -   GET /api/v1/public/iam/oauth/{provider}/url (PUB-08)
    -   POST /api/v1/public/iam/oauth/{provider}/callback (PUB-09)
-   **参考**: 3.4.5.9节, 3.4.5.10节
-   **关联流程**: FL-UC-02 三方账号注册流程
-   **支持**: 微信、QQ

**验收标准**:
-   接口编号与设计文档一致
-   业务规则符合FL-UC-01/FL-UC-02流程定义

#### 任务4.2: 个人侧注册页面开发

**责任人**: 前端B
**估时**: 6小时
**工作日期**: 1月29日周四-1月30日周五上午
**设计文档参考**: 3.9节

**子任务4.2.1: 注册页开发 (PG-UC-USR-01)**
-   **组件路径**: src/views/iam/consumer/register/index.vue
-   **功能**: 手机号/邮箱切换Tab、验证码输入、倒计时

**子任务4.2.2: 三方登录入口开发**
-   OAuth跳转处理
-   回调页面处理

**验收标准**:
-   页面编号与设计文档对应

---

### 用户故事EP1-5: 认证管理-登录

**故事名称**: 实现三端用户的登录认证和Token管理
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（1月29日下午-1月30日）
**设计文档参考**:
-   流程: FL-AUTH-* (5.2节)
-   接口: UP-AUTH-*, UR-AUTH-*, UC-AUTH-* (5.4节)

**验收标准**:
-   供给侧用户名+密码登录
-   租户侧用户名+密码登录
-   个人侧手机验证码登录
-   登录成功返回JWT Token
-   Token刷新机制正常
-   登出清理Token

#### 任务5.1: 登录认证API开发

**责任人**: 后端
**估时**: 6小时
**工作日期**: 1月29日周四下午-1月30日周五上午
**设计文档参考**: 5.4节 接口设计

**子任务5.1.1: 实现供给侧登录API (UP-AUTH-01, UP-AUTH-02)**
-   **接口**:
    -   POST /api/v1/up/auth/login (UP-AUTH-01)
    -   POST /api/v1/up/auth/login/verify-sms (UP-AUTH-02)
-   **参考**: 5.4.2.1节, 5.4.2.2节
-   **业务规则**: SaaS部署需短信验证、私有化部署直接签发

**子任务5.1.2: 实现租户侧登录API (UR-AUTH-01)**
-   **接口**: POST /api/v1/ur/auth/login/password
-   **参考**: 5.4.3.1节 (表5.4.3.1-1, 表5.4.3.1-2)
-   **支持**: tenantCode识别租户

**子任务5.1.3: 实现个人侧登录API (UC-AUTH-01, UC-AUTH-02)**
-   **接口**:
    -   POST /api/v1/uc/auth/login/sms (UC-AUTH-01)
    -   POST /api/v1/uc/auth/login/password (UC-AUTH-02)
-   **参考**: 5.4.4.1节
-   **业务规则**: 未注册自动注册

**子任务5.1.4: 实现Token管理API**
-   **接口**:
    -   POST /api/v1/{pool}/auth/token/refresh (UP-AUTH-04, UR-AUTH-09, UC-AUTH-06)
    -   POST /api/v1/{pool}/auth/logout (UP-AUTH-03, UR-AUTH-08, UC-AUTH-05)
-   **参考**: 5.3.5节 Token聚合

**验收标准**:
-   接口编号与设计文档一致
-   Token有效期符合表5.3.5.2-3配置

#### 任务5.2: 登录页面开发

**责任人**: 前端B
**估时**: 6小时
**工作日期**: 1月30日周五
**设计文档参考**: 5.7节 前端设计

**子任务5.2.1: 供给侧登录页**
-   用户名+密码表单、图形验证码、短信验证（SaaS）

**子任务5.2.2: 租户侧登录页**
-   租户选择/输入、SSO登录入口预留

**子任务5.2.3: 个人侧登录页**
-   手机验证码登录Tab、密码登录Tab、三方登录入口

**验收标准**:
-   调用接口编号正确

#### 任务5.3: UI设计-登录页面

**责任人**: UI
**估时**: 4小时
**工作日期**: 1月28日周三
**设计文档参考**: 5.7节

**验收标准**:
-   品牌风格一致

---

### 用户故事EP1-6: 公共功能-忘记密码

**故事名称**: 实现忘记密码和重置密码功能
**故事点数**: 5
**优先级**: P1
**工作时间**: 0.5个工作日（1月30日下午）
**设计文档参考**:
-   流程: FL-CMN-01 自助密码重置流程 (3.2.13节)
-   接口: PUB-04, PUB-05 (3.4.5节)

**验收标准**:
-   支持通过邮箱找回密码
-   发送重置链接到邮箱
-   重置链接有效期控制
-   新密码符合密码策略

#### 任务6.1: 密码重置API开发

**责任人**: 后端
**估时**: 3小时
**工作日期**: 1月30日周五上午
**设计文档参考**: 3.4.5节

**子任务6.1.1: 实现忘记密码API (PUB-04)**
-   **接口**: POST /api/v1/public/iam/password/forgot
-   **参考**: 3.4.5.5节 (表3.4.5.5-1, 表3.4.5.5-2)
-   **关联流程**: FL-CMN-01

**子任务6.1.2: 实现重置密码API (PUB-05)**
-   **接口**: POST /api/v1/public/iam/password/reset
-   **参考**: 3.4.5.6节

**验收标准**:
-   接口编号与设计文档一致

#### 任务6.2: 密码重置页面开发

**责任人**: 前端B
**估时**: 3小时
**工作日期**: 1月30日周五下午
**设计文档参考**: 3.9节

**子任务6.2.1: 忘记密码页 (PG-PUB-02)**
-   **组件路径**: src/views/iam/public/forgot-password/index.vue

**子任务6.2.2: 重置密码页 (PG-PUB-03)**
-   **组件路径**: src/views/iam/public/reset-password/index.vue

**验收标准**:
-   页面编号与设计文档对应

---

### 第一周测试任务

#### 任务T1: 用户管理功能测试

**责任人**: 测试A
**估时**: 持续
**工作日期**: 1月28日周三-1月30日周五
**设计文档参考**: 各流程和接口定义

**测试范围**:
-   FL-P-01 供给侧用户创建流程
-   FL-UR-01 租户用户创建流程
-   FL-UC-01 个人用户注册流程
-   FL-UC-02 三方账号注册流程
-   接口: P-USR-01~09, UR-USR-01~13, PUB-01~09

#### 任务T2: 认证功能测试

**责任人**: 测试A
**估时**: 持续
**工作日期**: 1月29日周四-1月30日周五
**设计文档参考**: 5.2节流程、5.4节接口

**测试范围**:
-   UP-AUTH-01~06 供给侧认证接口
-   UR-AUTH-01~12 租户侧认证接口
-   UC-AUTH-01~10 个人侧认证接口
-   FL-CMN-01 密码重置流程

---

## 第二周详细计划（2月2日-2月6日）

---

### 用户故事EP2-1: 授权管理-角色管理

**故事名称**: 实现角色的创建、查询、编辑、删除和权限分配
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（2月2日-2月3日上午）
**设计文档参考**:
-   第6章 授权管理
-   6.3节 领域模型设计
-   6.4节 接口设计

**验收标准**:
-   支持创建自定义角色（租户侧）
-   支持查看预置角色（只读）
-   支持为角色分配权限
-   支持角色启用/禁用

#### 任务7.1: 角色管理数据模型

**责任人**: 后端
**估时**: 3小时
**工作日期**: 2月2日周一上午
**设计文档参考**: 6.5节 数据模型设计

**子任务7.1.1: 创建角色相关表**
-   **platform库**: platform_role, platform_permission, platform_role_permission
-   **tenant库**: tenant_role, tenant_role_permission
-   **参考**: 6.5节表结构定义

**子任务7.1.2: 初始化预置角色数据**
-   **参考**: 2.5.3节 各用户群授权机制 (表2.5.3-1)
-   **供给侧角色**: 系统管理员、UP-01~UP-08
-   **租户侧角色**: 租户超管、UR-01~UR-09
-   **个人侧角色**: uc_guest, uc_free, uc_basic, uc_premium (表2.5.5-1)

**验收标准**:
-   表结构符合设计
-   预置数据与设计文档一致

#### 任务7.2: 角色管理API开发

**责任人**: 后端
**估时**: 5小时
**工作日期**: 2月2日周一下午
**设计文档参考**: 6.4节 接口设计

**子任务7.2.1: 实现角色CRUD API**
-   **接口编号**: 参考6.4节接口清单
-   GET /api/v1/{pool}/iam/roles (列表)
-   GET /api/v1/{pool}/iam/roles/{id} (详情)
-   POST /api/v1/tenant/iam/roles (仅租户可创建)
-   PUT /api/v1/tenant/iam/roles/{id}
-   DELETE /api/v1/tenant/iam/roles/{id}

**子任务7.2.2: 实现角色权限分配API**
-   PUT /api/v1/tenant/iam/roles/{id}/permissions
-   GET /api/v1/{pool}/iam/roles/{id}/permissions

**验收标准**:
-   预置角色不可修改删除
-   权限分配正确

#### 任务7.3: 角色管理页面开发

**责任人**: 前端A
**估时**: 5小时
**工作日期**: 2月3日周二
**设计文档参考**: 6.7节 前端设计

**子任务7.3.1: 角色列表页**
-   预置角色与自定义角色区分展示

**子任务7.3.2: 角色编辑页**
-   权限树选择组件

**验收标准**:
-   权限树正确展示

#### 任务7.4: UI设计-授权管理页面

**责任人**: UI
**估时**: 6小时
**工作日期**: 2月2日周一
**设计文档参考**: 6.7节

**验收标准**:
-   权限树交互清晰

---

### 用户故事EP2-2: 授权管理-用户角色分配

**故事名称**: 实现用户与角色的关联管理
**故事点数**: 5
**优先级**: P0
**工作时间**: 1个工作日（2月3日）
**设计文档参考**: 6.4节

**验收标准**:
-   支持为用户分配角色
-   支持为用户移除角色
-   角色变更实时生效

#### 任务8.1: 用户角色关联API开发

**责任人**: 后端
**估时**: 3小时
**工作日期**: 2月3日周二上午
**设计文档参考**: 6.4节

**子任务8.1.1: 实现用户角色管理API**
-   PUT /api/v1/{pool}/iam/users/{id}/roles
-   GET /api/v1/{pool}/iam/users/{id}/roles

**子任务8.1.2: 实现当前用户权限查询API**
-   GET /api/v1/{pool}/iam/me/permissions

**验收标准**:
-   角色关联正确
-   权限查询正确

#### 任务8.2: 用户角色分配页面开发

**责任人**: 前端A
**估时**: 3小时
**工作日期**: 2月3日周二下午

**验收标准**:
-   角色分配交互顺畅

---

### 用户故事EP2-3: 授权管理-权限校验

**故事名称**: 实现API权限校验和前端权限控制
**故事点数**: 5
**优先级**: P0
**工作时间**: 1个工作日（2月4日）
**设计文档参考**: 6.3节领域模型、6.6节权限校验机制

**验收标准**:
-   API接口权限校验生效
-   前端按钮/菜单权限控制生效
-   无权限时友好提示

#### 任务9.1: 后端权限校验实现

**责任人**: 后端
**估时**: 4小时
**工作日期**: 2月4日周三上午
**设计文档参考**: 6.6节

**子任务9.1.1: 实现权限拦截器**
-   解析Token中的用户信息
-   查询用户权限列表（缓存）
-   校验请求权限码

**子任务9.1.2: 实现权限注解**
-   @RequirePermission("user:create")

**验收标准**:
-   无权限返回403

#### 任务9.2: 前端权限控制实现

**责任人**: 前端B
**估时**: 4小时
**工作日期**: 2月4日周三下午
**设计文档参考**: 6.7节

**子任务9.2.1: 实现权限指令**
-   v-permission="'user:create'"

**子任务9.2.2: 实现路由权限守卫**
-   动态生成菜单

**验收标准**:
-   菜单动态生成

---

### 用户故事EP2-4: 审计管理-登录日志

**故事名称**: 实现登录日志的记录和查询
**故事点数**: 5
**优先级**: P1
**工作时间**: 1个工作日（2月4日-2月5日上午）
**设计文档参考**:
-   第7章 审计管理
-   7.3节 领域模型设计
-   7.4节 接口设计

**验收标准**:
-   登录成功/失败自动记录日志
-   支持登录日志查询
-   包含IP、设备、时间等信息

#### 任务10.1: 审计日志数据模型

**责任人**: 后端
**估时**: 2小时
**工作日期**: 2月4日周三下午
**设计文档参考**: 7.5节 数据模型设计

**子任务10.1.1: 创建审计日志表**
-   **三库均创建**: iam_login_log, iam_operation_log, iam_security_event
-   **参考**: 表7.5节表结构

**验收标准**:
-   表结构符合设计

#### 任务10.2: 登录日志API开发

**责任人**: 后端
**估时**: 3小时
**工作日期**: 2月5日周四上午
**设计文档参考**: 7.4节

**子任务10.2.1: 实现登录日志记录**
-   **参考**: 5.3.10节 领域事件 (表5.3.10-1 LoginSucceeded, LoginFailed)
-   切面自动记录

**子任务10.2.2: 实现登录日志查询API**
-   **参考**: 7.4节接口清单
-   GET /api/v1/{pool}/iam/audit/login-logs

**验收标准**:
-   日志自动记录

#### 任务10.3: 登录日志页面开发

**责任人**: 前端A
**估时**: 3小时
**工作日期**: 2月5日周四上午
**设计文档参考**: 7.9节 前端工程结构

**子任务10.3.1: 登录日志列表页**
-   **路由**: 参考表7.9.2-1 审计管理路由配置

**验收标准**:
-   列表展示正确

#### 任务10.4: UI设计-审计管理页面

**责任人**: UI
**估时**: 4小时
**工作日期**: 2月4日周三
**设计文档参考**: 7.9节

**验收标准**:
-   设计稿交付

---

### 用户故事EP2-5: 审计管理-操作日志

**故事名称**: 实现关键操作的日志记录和查询
**故事点数**: 5
**优先级**: P1
**工作时间**: 0.5个工作日（2月5日下午）
**设计文档参考**: 7.4节

**验收标准**:
-   用户CRUD操作自动记录
-   角色权限变更自动记录
-   支持操作日志查询

#### 任务11.1: 操作日志API开发

**责任人**: 后端
**估时**: 3小时
**工作日期**: 2月5日周四下午
**设计文档参考**: 7.4节

**子任务11.1.1: 实现操作日志注解**
-   @AuditLog(module="用户管理", operation="创建用户")

**子任务11.1.2: 实现操作日志查询API**
-   **参考**: 表7.9.3-2 操作日志API接口
-   GET /api/v1/{pool}/iam/audit/operation-logs

**验收标准**:
-   日志记录完整

#### 任务11.2: 操作日志页面开发

**责任人**: 前端A
**估时**: 2小时
**工作日期**: 2月5日周四下午

**验收标准**:
-   列表展示正确

---

### 用户故事EP2-6: 组织管理基础

**故事名称**: 实现组织单元和岗位的基础管理功能
**故事点数**: 8
**优先级**: P1
**工作时间**: 1个工作日（2月5日下午-2月6日上午）
**设计文档参考**:
-   第4章 组织管理
-   4.3节 领域模型设计
-   4.4节 接口设计
-   4.5节 数据模型设计

**验收标准**:
-   支持创建组织单元（树形）
-   支持创建岗位
-   组织树展示正确

#### 任务12.1: 组织管理数据模型

**责任人**: 后端
**估时**: 2小时
**工作日期**: 2月5日周四下午
**设计文档参考**: 4.5节

**子任务12.1.1: 创建组织相关表**
-   **tenant库**:
    -   org_organization (表4.5.2.1-1)
    -   org_position (表4.5.2.2-1)
    -   org_person (表4.5.2.3-1)
    -   org_appointment (表4.5.2.4-1)

**验收标准**:
-   表结构符合设计

#### 任务12.2: 组织管理API开发

**责任人**: 后端
**估时**: 4小时
**工作日期**: 2月5日周四下午-2月6日周五上午
**设计文档参考**: 4.4节

**子任务12.2.1: 实现组织单元API**
-   **参考**: 4.4.2节 组织单元接口
-   GET /api/v1/tenant/iam/org-units/tree
-   POST /api/v1/tenant/iam/org-units
-   PUT /api/v1/tenant/iam/org-units/{id}
-   DELETE /api/v1/tenant/iam/org-units/{id}

**子任务12.2.2: 实现岗位API**
-   **参考**: 4.4.3节 岗位接口
-   GET /api/v1/tenant/iam/positions
-   POST /api/v1/tenant/iam/positions
-   PUT /api/v1/tenant/iam/positions/{id}

**验收标准**:
-   组织树接口正确
-   层级限制生效(ORG-R-02 最大9级)

#### 任务12.3: 组织管理页面开发

**责任人**: 前端A
**估时**: 4小时
**工作日期**: 2月6日周五上午
**设计文档参考**: 4.9节

**子任务12.3.1: 组织架构页面**
-   **参考**: 表4.9.4-1 组件说明
-   组件: OrgTree.vue, OrgForm.vue

**验收标准**:
-   组织树交互流畅

---

### 用户故事EP2-7: 端到端联调测试

**故事名称**: 完成各模块联调和端到端测试
**故事点数**: 8
**优先级**: P0
**工作时间**: 1.5个工作日（2月5日下午-2月6日）

**验收标准**:
-   用户注册-登录-操作全流程通过
-   权限控制端到端通过
-   审计日志记录完整
-   无P0级Bug

#### 任务T3: 授权管理测试

**责任人**: 测试B
**估时**: 持续
**工作日期**: 2月3日周二-2月5日周四
**设计文档参考**: 第6章

**测试范围**:
-   角色CRUD测试
-   权限分配测试
-   权限校验测试（API+前端）

#### 任务T4: 审计管理测试

**责任人**: 测试B
**估时**: 持续
**工作日期**: 2月4日周三-2月5日周四
**设计文档参考**: 第7章

**测试范围**:
-   登录日志测试
-   操作日志测试

#### 任务T5: 端到端测试

**责任人**: 测试A + 测试B
**估时**: 8小时
**工作日期**: 2月6日周五

**子任务T5.1: 供给侧全流程测试**
-   FL-P-01 → UP-AUTH-01/02 → 操作 → 审计日志

**子任务T5.2: 租户侧全流程测试**
-   FL-UR-01 → UR-AUTH-01 → 权限校验

**子任务T5.3: 个人侧全流程测试**
-   FL-UC-01 → UC-AUTH-01 → 个人设置

**验收标准**:
-   全流程无阻断

---

### 用户故事EP2-8: Bug修复与优化

**故事名称**: 修复测试发现的问题并优化体验
**故事点数**: Buffer
**优先级**: P0
**工作时间**: 2月6日周五

**验收标准**:
-   P0/P1 Bug全部修复

#### 任务13.1: Bug修复

**责任人**: 后端 + 前端A + 前端B
**工作日期**: 2月6日周五

#### 任务13.2: 代码Review和文档更新

**责任人**: 全员
**估时**: 2小时
**工作日期**: 2月6日周五下午

---

## 设计文档章节与任务映射总表

| 设计文档章节     | 相关流程编号       | 相关接口编号                    | 相关页面编号    | 对应Sprint任务 |
| ---------------- | ------------------ | ------------------------------- | --------------- | -------------- |
| 3.3 领域模型     | -                  | -                               | -               | 任务1.2        |
| 3.5 数据模型     | -                  | -                               | -               | 任务1.1        |
| 3.2.3 FL-P-01    | FL-P-01            | P-USR-01~09                     | PG-P-USR-01~03  | 任务2.1, 2.2   |
| 3.2.7 FL-UR-01   | FL-UR-01           | UR-USR-01~13                    | PG-UR-USR-01~04 | 任务3.1, 3.2   |
| 3.2.10 FL-UC-01  | FL-UC-01, FL-UC-02 | PUB-01~09                       | PG-UC-USR-01~04 | 任务4.1, 4.2   |
| 3.2.13 FL-CMN-01 | FL-CMN-01          | PUB-04~05                       | PG-PUB-02~03    | 任务6.1, 6.2   |
| 5.4 认证接口     | FL-AUTH-*          | UP-AUTH-*, UR-AUTH-*, UC-AUTH-* | -               | 任务5.1, 5.2   |
| 6.4 授权接口     | -                  | 角色权限相关                    | -               | 任务7.2, 8.1   |
| 7.4 审计接口     | -                  | 审计日志相关                    | -               | 任务10.2, 11.1 |
| 4.4 组织接口     | FL-ORG-*, FL-PSN-* | 组织岗位相关                    | -               | 任务12.2       |

---

## Sprint 燃尽图规划

| 日期    | 星期 | 计划完成故事点 | 累计完成 | 剩余 |
| ------- | ---- | -------------- | -------- | ---- |
| 1月26日 | 一   | 6              | 6        | 72   |
| 1月27日 | 二   | 9              | 15       | 63   |
| 1月28日 | 三   | 10             | 25       | 53   |
| 1月29日 | 四   | 10             | 35       | 43   |
| 1月30日 | 五   | 8              | 43       | 35   |
| 2月2日  | 一   | 8              | 51       | 27   |
| 2月3日  | 二   | 8              | 59       | 19   |
| 2月4日  | 三   | 8              | 67       | 11   |
| 2月5日  | 四   | 6              | 73       | 5    |
| 2月6日  | 五   | 5              | 78       | 0    |

---

## 关键里程碑

| 日期        | 里程碑       | 验证标准                         |
| ----------- | ------------ | -------------------------------- |
| 1月27日周二 | 基础架构完成 | 数据模型、领域模型、共享服务就绪 |
| 1月30日周五 | 第一周交付   | 用户管理+认证管理功能可用        |
| 2月3日周二  | 授权管理完成 | 角色权限管理功能可用             |
| 2月5日周四  | 审计管理完成 | 日志记录和查询功能可用           |
| 2月6日周五  | Sprint完成   | 全部功能联调测试通过             |

---

## 风险管理

| 风险项             | 可能性 | 影响 | 应对措施                           |
| ------------------ | ------ | ---- | ---------------------------------- |
| 动态数据源路由复杂 | 中     | 高   | 参考2.7.3节设计，第一天优先解决    |
| 三方OAuth对接延迟  | 中     | 中   | 先实现PUB-01/02，PUB-08/09作为增强 |
| 权限树组件开发复杂 | 中     | 中   | 考虑使用成熟组件库                 |
| 测试发现大量Bug    | 中     | 高   | 预留Buffer时间，每日同步问题       |

---

## 交付物清单

### 代码交付

-   [ ] bc-10-iam-api 模块 (参考3.8.2.1节)
-   [ ] bc-10-iam-domain 模块 (参考3.8.2.2节)
-   [ ] bc-10-iam-application 模块 (参考3.8.2.3节)
-   [ ] bc-10-iam-infrastructure 模块 (参考3.8.2.4节)
-   [ ] bc-10-iam-starter 模块 (参考3.8.2.5节)
-   [ ] 前端 IAM 模块代码 (参考3.9节)

### 文档交付

-   [ ] API接口文档（与设计文档接口编号对应）
-   [ ] 数据库DDL脚本（与3.5/4.5/6.5/7.5节一致）
-   [ ] 部署说明文档
-   [ ] 测试报告（按流程编号组织）

### 设计交付

-   [ ] UI设计稿（页面编号与设计文档对应）
-   [ ] 切图资源
