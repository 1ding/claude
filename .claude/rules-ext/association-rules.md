# 关联规则与比对维度

## 约束类型

| 类型 | 来源 | 使用原则 |
| --- | --- | --- |
| 显性约束（规范文档） | 规范文档 | 内容必须符合；规范本身不可修改 |
| 隐性约束（关联文档） | 关联文档 | 比对一致性；关联文档本身不修改；矛盾由用户决定 |
| 参考材料 | 用户提供 | 提取事实信息、借鉴结构；不适用内容可忽略；矛盾由用户决定 |

## 关联类型与比对重点

| 关联类型 | 定义 | 比对重点 |
| --- | --- | --- |
| 上下游 | 输入/输出承接关系（如需求→设计→实现） | 接口、参数、数据流的传递一致性 |
| 总分 | 整体与局部包含关系（如总体设计→各子系统） | 范围覆盖、职责划分、约束继承 |
| 并行 | 同层级文档协作关系（如多子系统设计） | 共享术语、公共接口、协议约定 |

当用户未明确关联类型时，根据文档内容推断并在初始化阶段确认。

## 比对维度矩阵

| 比对维度 | 上下游 | 总分 | 并行 |
| --- | --- | --- | --- |
| 流程/状态转换 | ★重点（传递完整性） | ○一般 | ○一般 |
| 范围覆盖 | ○一般 | ★重点（是否遗漏） | ○一般 |
| 职责/模块划分 | ○一般 | ★重点（分解一致性） | ★重点（边界清晰性） |
| 共享协议/公共接口 | ○一般 | ○一般 | ★重点（契约一致性） |
| 约束/指标继承 | ★重点（向下传递） | ★重点（逐级分解） | ○一般 |
| 术语一致性 | ★重点 | ★重点 | ★重点 |

## 关联关系分层（概念）

关联关系按来源分为四层，逐层叠加。层级是概念分类，位置是惯例参考，**加载均通过显式指令触发**：

| 层级 | 惯例位置（参考） | 内容 | 加载方式 |
| --- | --- | --- | --- |
| 领域级背景约束 | specs/{领域}/context/ | 大背景文档（如研发过程规范） | `/load-context` |
| 领域级关联关系 | specs/{领域}/CLAUDE.md | 领域内文档类型的关联模式 | `/load-domain` |
| 项目内关联关系 | projects/{项目}/CLAUDE.md | 项目所属领域 + 项目内具体关联 | doc-write/doc-revise 初始化时读取 |
| 跨领域/跨项目关联 | 用户在消息中指定 | 不属于以上三层的额外关联 | 用户在消息中手动指定 |

## 项目级 CLAUDE.md

位于 `projects/{项目}/CLAUDE.md`，包含：
- **所属领域声明**：本项目遵从哪个领域的关联关系和规范
- **项目内文档关联关系表**：列出项目中实际存在的文档及其关联关系

声明格式：

```markdown
# 项目：{项目名}

## 所属领域

软件（遵从 specs/software/ 的领域关联关系和规范）

## 项目内文档关联关系

| 编号 | 文档 | 上游关联 | 并行关联 | 总分关联（上级） |
| --- | --- | --- | --- | --- |
| 01 | 需求规格 | - | - | - |
| 02 | 概要设计 | 01-需求规格 | - | - |
```

注意：纵向关系不一定是线性链条，须显式声明；编号相同不自动等于并行，需显式声明。

## 初始化阶段的加载职责

当任务涉及已知项目时，AI 在初始化阶段须主动读取（而非等待 load 指令触发）：

1. 读取 `projects/{项目}/CLAUDE.md` → 获取所属领域和项目内关联关系
2. 读取 `projects/{项目}/decisions.md` → 获取已有决策记录
3. 根据任务驱动类型决定是否需要进一步 load 关联文档内容

关联文档的实际位置优先从 `outputs/`（已完成终稿）加载，其次从 `drafts/`（编写中文档）加载。
