# 容量管理规范

## 基准参数

| 参数             | 值                                       |
| ---------------- | ---------------------------------------- |
| 度量单位         | 汉字数（含标点/Markdown）                |
| 换算             | 200K tokens ≈ 8-10 万汉字（技术文档）    |
| 规划基准         | 200K tokens ≈ 12 万汉字                  |
| Claude Code 特性 | 按需读取文件片段，不需一次性加载全部文件 |

容量管理适用场景：单文档超 5 万字需同时理解全文、同时比对 3+ 大型文档（每份 > 2 万字）、单次会话累计编写/修订超 3 万字。

## 固定框架开销

每次会话自动加载的固定内容：

| 加载项                                              | tokens    |
| --------------------------------------------------- | --------- |
| 系统 prompt（Claude Code 内置）                     | ~4K       |
| version-management.md（`.claude/rules/` 自动加载）  | ~2K       |
| claude.md（根目录工作规则，如有）                   | ~0.5K     |
| **框架合计**                                        | **~6-7K** |

执行 `/doc-write` 或 `/doc-revise` 时额外读取的辅助规范（始终加载项，不产生 `[LOADED *]` 标记，由 `/cap-status` 作为"辅助规范开销"行项单独统计）：

| 加载项                                            | tokens    |
| ------------------------------------------------- | --------- |
| capacity-management.md + structure-constraints.md | ~3.5K     |
| quality-checklist.md                              | ~1K       |
| **辅助规范合计**                                  | **~4.5K** |

可用容量 = 200K − 框架开销 ≈ 193-194K tokens。执行 doc-write/doc-revise 时实际起点约 189-190K。

> `.claude/rules/` 下的文件由 Claude Code 自动加载（固定开销）。`.claude/rules-ext/` 规范文件均为按需加载（上述辅助规范除外）。项目规范文档（领域规范、风格规范、排版规范等）同样按需 `/load-*` 加载。

## 输入侧

默认判定充足，跳过评估。仅以下情况报告瓶颈：单文档 > 5 万字且需同时理解全文；同时比对 3+ 大型文档（每份 > 2 万字）。

不足时：建议按章节拆分文档，分次加载。

## 输出侧

| 目标规模 | 判定   | 策略                               |
| -------- | ------ | ---------------------------------- |
| ≤ 1 万字 | 充裕   | 一次完成，不建立计划文件           |
| 1-3 万字 | 可控   | 分批执行，阶段零建立计划文件       |
| > 3 万字 | 需评估 | 大概率需多会话，阶段零建立计划文件 |

修订补充：修订项 > 20 条或涉及全文改写时，即使文档不大，也判定为"可控"并分批。

不足时拆分策略：

| 场景 | 拆分方式                                  |
| ---- | ----------------------------------------- |
| 编写 | 按章节组分多次对话，每次交付部分章节      |
| 修订 | 按驱动类型分多次对话，每次处理 1-2 种类型 |

## 综合判定

| 等级 | 条件                      | 策略                                |
| ---- | ------------------------- | ----------------------------------- |
| 充裕 | 读得下 + 写得完（有余量） | 不分批，不建立计划文件              |
| 可控 | 读得下 + 能完成若干批     | 分批 + 动态监控，阶段零建立计划文件 |
| 不足 | 读不下，或连一批都写不完  | 拆分处理，立即中止                  |

判定倾向可控：能开始就先开始，动态监控兜底。空间节省措施：精简批次报告、合并关联紧密的处理项。

## 计划文件（可控/不足时必须）

容量判定为**可控**或**不足**时，在阶段零输出编写/修订方案的同时，创建计划文件：

-   路径：`projects/{项目}/plans/编写计划_{文档名}.md` 或 `修订计划_{文档名}.md`
-   内容：任务分解（按章节组或驱动类型）、各批预估字数、状态（待处理/进行中/已完成）

每批完成后更新计划文件状态。中断时保留完整计划供恢复使用（配合交接文件 `.claude/rules-ext/handoff-template.md`）。

## 动态监控（可控状态下）

触发"不足"的任一条件：
-   累计编写/修订 > 3 万字且剩余项较多
-   AI 响应出现截断或重复
-   单批质量明显下降（遗漏约束、术语漂移等）

状态变为"不足"时，立即停止并输出：

```text
[!]容量状态：不足
已将当前进度写入 drafts/ 和 plans/ 目录。
请在新会话中说"请按 plans/XXX计划_XXX.md 继续"。
```

## 输出格式

充裕/可控：

```text
---容量评估---
容量判定：[充裕/可控]
目标文档预估：约X万字
处理策略：{一句话}
```

不足：

```text
---容量评估---
瓶颈：{输入侧/输出侧/两侧均不足}
输入侧：{一句话}
输出侧：目标文档预估约X万字，{超出单次会话可控范围 / 修订项X条需分批}
容量判定：[不足]
拆分方案：{具体建议}
```
