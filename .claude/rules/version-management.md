# 版本管理规范

## 文件命名格式

+   **临时版本命名**（工作过程中）：`{文件名}_v{版本号}_R{修订号}@{时间戳}.md`
    +   示例：`01-战略规划_v0.11_R07@202602271430.md`
+   **常规版本命名**（R转正后）：`{文件名}_v{版本号}@{时间戳}.md`（不带R修订号）
    +   示例：`01-战略规划_v0.14@202602271430.md`
+   **版本号格式**：`主版本.次版本`（如 v0.10, v1.00, v1.23）
    +   主版本：重大结构变更或内容重写时递增（需明确指令）
    +   次版本：常规修订时递增，每次递增0.01（如 v0.10 → v0.11 → v0.12）
    +   **重要**：R转常规版本号时，版本号只能按0.01递增（如 v0.13 → v0.14），除非用户明确指令跳版本或升主版本
+   **修订号格式**：`R{数字}`（如 R01, R07, R10, R99, R999），仅用于临时版本
    +   修订号从 R01 开始，无上限，按实际修订次数连续递增，不限位数
    +   修订号与文件内修订记录表中的最新 R.xx 编号一致
    +   示例：文件内修订记录最新为 R.07，则文件名为 `_v0.11_R07@...`；最新为 R.12，则为 `_v0.11_R12@...`
    +   **重要**：R 编号增长不触发版本号递增；版本号递增仅由"R转常规版本号"指令触发
+   **时间戳格式**：`YYYYMMDDHHmm`（如 202602271430 表示 2026年2月27日14:30）
+   **重要**：文件名中的版本号必须与文件内修订记录表中的版本号一致

## 目录结构与版本流转

```
projects/{项目}/
├── drafts/                    # 工作区（所有版本历史）
│   ├── 01-战略规划_v0.10_R01@202602201000.md
│   ├── 01-战略规划_v0.10_R02@202602211500.md
│   ├── 01-战略规划_v0.11@202602221200.md      ← 已转常规版本号
│   ├── 01-战略规划_v0.11_R03@202602231000.md  ← 基于v0.11继续修订
│   └── ...
├── outputs/                   # 正式版本区（仅最新正式版）
│   ├── 01-战略规划_v0.11@202602221200.md  ← 当前正式版
│   └── ...
└── history/                   # 历史正式版本归档
    ├── 01-战略规划_v0.01@202601151000.md
    ├── 01-战略规划_v0.05@202602011200.md
    └── ...
```

## 版本管理流程

### 1. 初始编写

+   **操作**：在 drafts/ 中创建初始版本
+   **命名**：`{文件名}_v0.01_R01@{时间戳}.md`（临时版本）
+   **修订记录**：创建修订记录表，记录 R.01 条目

### 2. 日常修订（在 drafts/ 中进行）

+   **操作步骤**：
    1.  读取 drafts/ 中该文档的最新版本（按文件名排序取最后一个）
    2.  判断最新版本类型：
        +   如果是R版本（如 `v0.10_R02@...`）→ 继续递增R（创建 `v0.10_R03@...`）
        +   如果是常规版本（如 `v0.11@...`）→ 从R01开始（创建 `v0.11_R01@...`）
    3.  复制内容，创建新版本文件
    4.  更新时间戳为当前时间
    5.  在新文件中执行修订
    6.  在修订记录中新增 R.xx 条目
+   **文件命名**：
    +   临时版本：`{文件名}_v{版本号}_R{修订号}@{时间戳}.md`
    +   版本号保持不变，修订号递增
+   **所有历史版本保留在 drafts/ 中**，不删除

### 3. R转常规版本号（需明确指令）

+   **触发条件**：用户明确说"R转常规版本号"、"转常规版本"、"去掉R" 等指令
+   **操作步骤**：
    1.  读取 drafts/ 中该文档的最新临时版本（如 `v0.13_R07@...`）
    2.  创建新文件，版本号按0.01递增，去掉R修订号（如 `v0.14@...`）
    3.  复制内容，在修订记录中将所有 R.xx 条目归并为新版本号
    4.  更新时间戳为当前时间
+   **版本号递增规则**：
    +   默认：次版本按0.01递增（v0.13 → v0.14，v0.19 → v0.20）
    +   明确指令：可跳版本（如用户说"升到v0.20"）或升主版本（如用户说"升到v1.00"）
+   **重要**：R转常规版本号后，文件名不再带 `_R{修订号}`

### 4. 提交到 outputs（需明确指令）

+   **触发条件**：用户明确说"提交到 outputs"、"发布正式版"、"转正式版本" 等指令
+   **操作步骤**：
    1.  确认 drafts/ 中的最新版本（必须是常规版本号，不能带R）
    2.  如果 outputs/ 中存在同名文档的旧正式版：
        +   将旧正式版移动到 history/
    3.  将 drafts/ 中的最新版本**复制**（不是移动）到 outputs/
    4.  在修订记录中标注该版本为正式版本
+   **重要**：drafts/ 中的文件不删除，保留完整版本历史

## 文件查找规则

### 读取最新版本

+   **drafts/ 中的最新版本**：
    ```bash
    ls drafts/{文件名前缀}_v*.md | sort | tail -1
    ```
    （可能是临时版本 `_R{修订号}@...` 或常规版本 `@...`）
+   **outputs/ 中的正式版本**：
    ```bash
    ls outputs/{文件名前缀}_v*.md
    ```
    （outputs/ 中每个文档只有一个文件，即当前正式版，必须是常规版本号）

### 关联文档加载

+   从项目 CLAUDE.md 读取关联关系时：
    +   优先从 outputs/ 加载关联文档（正式版本）
    +   如果 outputs/ 中不存在，则从 drafts/ 加载最新版本
    +   如果两处都不存在，报告缺失，**不自动从 history/ 降级**
+   **history/ 不参与日常加载**：AI 正常工作流程中不访问 history/，除非用户明确指示"查看历史版本"

## 修订记录管理

### R.xx 编号规则

+   每次 AI 修订在文档的修订记录表中新增一行，编号为 R.01, R.02, R.03...
+   R.xx 编号在同一版本号下连续递增
+   当R转常规版本号时，所有 R.xx 条目归并为新版本号，R编号重新从 R.01 开始
+   **修订逻辑**：
    +   如果最新文件是R版本（如 `v0.10_R02@...`）→ 继续递增R（创建 `v0.10_R03@...`）
    +   如果最新文件是常规版本（如 `v0.11@...`）→ 从R01开始（创建 `v0.11_R01@...`）
+   **文件系统示例**（drafts/ 中可能同时存在）：
    +   `v0.10_R01@...` 文件内记录：R.01
    +   `v0.10_R02@...` 文件内记录：R.01, R.02
    +   `v0.11@...` 文件内记录：v0.11（归并了R.01-R.02）
    +   `v0.11_R01@...` 文件内记录：v0.11, R.01（新修订）
+   **重要**：文档内修订记录表中，两个常规版本号之间不会有R版本记录（R版本只存在于常规版本号之后）

### 修订记录格式

```markdown
## 修订记录

| 版本号 | 日期       | 修订内容 | 修订人 |
| ------ | ---------- | -------- | ------ |
| R.01   | 2026-02-20 | 初始版本 | AI     |
| R.02   | 2026-02-21 | 修订术语 | AI     |
| R.03   | 2026-02-22 | 补充章节 | AI     |
```

### R转常规版本号示例

用户指令"R转常规版本号"后，将 R.01-R.03 归并为常规版本号：

```markdown
| 版本号 | 日期       | 修订内容                     | 修订人 |
| ------ | ---------- | ---------------------------- | ------ |
| v0.11  | 2026-02-22 | 初始版本；修订术语；补充章节 | AI     |
```

后续修订从 R.01 重新开始：

```markdown
| 版本号 | 日期       | 修订内容                     | 修订人 |
| ------ | ---------- | ---------------------------- | ------ |
| v0.11  | 2026-02-22 | 初始版本；修订术语；补充章节 | AI     |
| R.01   | 2026-02-23 | 增加风险分析                 | AI     |
```

## 工作流示例

### 场景1：首次编写

```
用户：编写 01-战略规划
AI：
1. 在 drafts/ 创建 01-战略规划_v0.01_R01@202602271000.md
2. 编写内容，修订记录中记录 R.01
```

### 场景2：修订临时版本

```
用户：修订 01-战略规划，补充第3章
AI：
1. 读取 drafts/01-战略规划_v0.01_R01@202602271000.md
2. 创建 drafts/01-战略规划_v0.01_R02@202602271500.md
3. 复制内容并执行修订
4. 修订记录中新增 R.02
```

### 场景3：继续修订

```
用户：修订 01-战略规划，调整术语
AI：
1. 读取 drafts/ 中最新版本（v0.01_R02@...）
2. 创建 drafts/01-战略规划_v0.01_R03@202602271800.md
3. 执行修订
4. 修订记录中新增 R.03
```

### 场景4：R转常规版本号

```
用户：将 01-战略规划 R转常规版本号
AI：
1. 读取 drafts/ 最新版本 v0.01_R03@202602271800.md
2. 创建 drafts/01-战略规划_v0.02@202602272000.md（版本号从v0.01递增到v0.02）
3. 复制内容，在修订记录中将 R.01-R.03 归并为 v0.02
4. 文件名不再带 _R{修订号}
```

### 场景5：基于常规版本号继续修订

```
用户：修订 01-战略规划，增加风险分析
AI：
1. 读取 drafts/ 中最新版本（v0.02@...）
2. 创建 drafts/01-战略规划_v0.02_R01@202602281000.md（R编号重新从R.01开始）
3. 执行修订
4. 修订记录中新增 R.01
```

### 场景6：提交到 outputs

```
用户：将 01-战略规划 提交到 outputs
AI：
1. 确认 drafts/ 最新版本为 v0.02@202602272000.md（常规版本号，不带R）
2. 检查 outputs/ 中是否存在旧版本
3. 如存在，将 outputs/01-战略规划_v0.01@...md 移动到 history/
4. 复制 drafts/01-战略规划_v0.02@202602272000.md 到 outputs/
5. 在修订记录中标注 v0.02 为正式版本
```

## 注意事项

+   **drafts/ 是唯一的工作区**：所有编写和修订都在 drafts/ 中进行
+   **outputs/ 只存放正式版本**：每个文档只有一个文件，代表当前正式版，必须是常规版本号（不带R）
+   **history/ 是归档区**：内容不受约束，放什么都合理；AI 正常工作流程中不访问 history/，除非用户明确指示"查看历史版本"
+   **版本号递增规则**：
    +   日常修订：修订号递增（R.01 → R.02 → R.03），版本号不变
    +   R转常规版本号：版本号按0.01递增（v0.13 → v0.14），除非明确指令
    +   提交到 outputs：必须先R转常规版本号，不能直接提交临时版本
+   **时间戳真实性**：时间戳反映文件实际创建时间，不可伪造或回溯
+   **文件名与内容一致性**：文件名中的版本号和修订号必须与文件内修订记录表一致
