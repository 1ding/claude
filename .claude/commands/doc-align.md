# 跨文档一致性对齐

对目标文档与已加载的关联文档进行系统性一致性比对，输出差异报告，可选自动修正。

## 适用场景

-   编写或修订了上游文档后，检查下游文档是否仍一致
-   并行文档之间的术语、接口、协议对齐
-   总体设计修改后，检查各子系统设计是否同步

## 不适用场景（请改用对应 skill）

-   只修改文档内部内容，不涉及跨文档 → `/doc-fix` 或 `/doc-revise`
-   系统性修订（多种驱动类型混合） → `/doc-revise`
-   只检查格式问题 → `/doc-fmt`

## 输入

$ARGUMENTS

用户可指定：
-   **关联类型**（可选）：上下游 / 总分 / 并行
-   **比对范围**（可选）：全文 / 指定章节

## 先决条件检查

**在执行任何步骤前，先完成以下检查：**

扫描当前会话历史中的 `[LOADED *]` 记录，确认：
-   [ ] 已存在 `[LOADED target]` 记录
-   [ ] 至少存在一条关联文档记录（`[LOADED upstream]`、`[LOADED downstream]` 或 `[LOADED parallel]` 任一）

如未满足，输出以下提示并**立即中止**，不执行后续任何步骤：

> ⚠️ 缺少必要的加载：
> -   无 `[LOADED target]`：请先执行 `/load-target /path/to/目标文档`
> -   无关联文档：请先执行 `/load-upstream`、`/load-downstream` 或 `/load-parallel` 中至少一项

## 执行步骤

### 1. 确认文档与关联类型

-   从会话历史获取目标文档（最近一条 `[LOADED target]`）
-   从会话历史获取全部关联文档（`[LOADED upstream]`、`[LOADED downstream]`、`[LOADED parallel]`）
-   确认关联类型（用户指定 > 会话中加载的角色标记 > 询问用户）

### 2. 确定比对维度

根据关联类型确定比对重点（维度定义详见 `.claude/rules-ext/association-rules.md`）：

| 比对维度 | 上下游 | 总分 | 并行 |
| --- | --- | --- | --- |
| 流程/状态转换 | ★重点（传递完整性） | ○一般 | ○一般 |
| 范围覆盖 | ○一般 | ★重点（是否遗漏） | ○一般 |
| 职责/模块划分 | ○一般 | ★重点（分解一致性） | ★重点（边界清晰性） |
| 共享协议/公共接口 | ○一般 | ○一般 | ★重点（契约一致性） |
| 约束/指标继承 | ★重点（向下传递） | ★重点（逐级分解） | ○一般 |
| 术语一致性 | ★重点 | ★重点 | ★重点 |

### 3. 执行比对

-   通读目标文档和关联文档（均已在会话上下文中）
-   按比对维度逐项检查
-   区分实质差异和层级适配差异（不同层级文档的详略程度天然不同，不视为不一致）

### 4. 输出差异报告

```
---一致性比对报告---

目标文档：{文档名}
关联文档：{文档名}（{关联类型}）
比对范围：{全文 / 指定章节}

差异汇总：
| 序号 | 比对维度 | 目标文档位置 | 关联文档位置 | 差异描述 | 差异程度 | 修订方向 |
| ---- | -------- | ------------ | ------------ | -------- | -------- | -------- |
| 1    | 术语     | 3.2          | 2.1          | ...      | 中等     | 以关联文档为准 |

总计：严重 X 项，中等 X 项，轻微 X 项
```

### 5. 可选修正

```
是否需要自动修正？
- 回复"修正" → 按修订方向自动修正目标文档，创建新版本
- 回复"修正 + 序号" → 只修正指定的差异项
- 回复"不修正" → 仅保留报告
```

## 不执行

-   **不加载**规范文档（使用会话中已加载的规范）
-   **不执行**容量评估
-   **不执行**全面质量检查
