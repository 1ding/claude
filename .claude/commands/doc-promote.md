# 晋升文档为正式版本

将 `drafts/` 中的草稿晋升为正式版本：R 版本自动执行 R 转常规版本号，然后复制到 `outputs/`，旧正式版移入 `history/`。

## 用法

```
/doc-promote [{新版本号}]
```

**参数**：

-   `{新版本号}`（可选）：目标常规版本号（如 `v0.20`、`v1.00`）；未提供时自动 +0.01

**示例**：

```
/doc-promote           ← 自动从 load-target 获取目标文档，版本号 +0.01
/doc-promote v1.00     ← 指定升级到 v1.00
```

## 先决条件检查

从会话历史中查找最近一条 `[LOADED target]` 记录：

-   **找到记录**：提取目标文档的完整文件路径
-   **未找到记录**：输出以下提示并**立即中止**：

> ⚠️ 未找到目标文档，请先使用 `/load-target` 加载要晋升的文档
>
> 示例：
> ```
> /load-target projects/ClariSphere/drafts/02-宏观需求_v0.12_R09@202602271800.md
> /doc-promote
> ```

## 执行步骤

### 1. 定位目标文件

-   从 $ARGUMENTS 解析文件路径或前缀
-   若为前缀（不以 `.md` 结尾），执行：
    ```bash
    ls {drafts目录}/{前缀}_v*.md | sort | tail -1
    ```
    取最新版本
-   读取目标文件，确认可访问
-   从文件路径提取：
    -   `项目路径`：从文件路径向上找到含 `drafts/` 的父目录（即 `projects/{项目}/`）
    -   `文档名前缀`：文件名中 `_v` 之前的部分（如 `02-宏观需求`）

### 2. 判断版本类型

-   **R 版本**（文件名含 `_R{数字}@`）→ 执行步骤 3（R 转常规版本号）
-   **常规版本**（文件名不含 `_R{数字}@`）→ 跳至步骤 4

### 3. R 转常规版本号

1.   **确定新版本号**：

     **自动递增规则**（未提供 `{新版本号}` 时）：

     版本号格式固定为 `vX.YY`，次版本（YY）始终保持两位，不省略前导零：

     | 当前版本 | 递增后 | 说明                              |
     | -------- | ------ | --------------------------------- |
     | v0.09    | v0.10  | 不是 v0.1                         |
     | v0.12    | v0.13  | —                                 |
     | v0.19    | v0.20  | 不是 v0.2                         |
     | v0.99    | v1.00  | 次版本溢出，主版本 +1，次版本归零 |

     操作：将文件名中 `_v` 后的次版本数字取整数加 1，再格式化为两位（不足两位补零）。

     **指定版本号**（提供 `{新版本号}` 时）：直接使用，格式须符合 `vX.YY`（两位次版本）。

     -   已指定（如 `v1.00`）：使用指定版本号
2.   **新文件名**：`{文档名前缀}_{新版本号}@{当前时间戳}.md`（去掉 `_R{修订号}`，时间戳格式 YYYYMMDDHHmm）
3.   **归并修订记录**：将文件内修订记录表中所有 R.xx 条目合并为一行：

     ```
     | v{新版本号} | {今日日期} | {合并所有R.xx修订内容，分号分隔} | AI |
     ```

4.   **写入新文件**（使用 python 脚本，避免直接写大文件）：

     ```bash
     python3 write_helper.py   # 在 drafts/ 生成新文件
     wc -c {新文件路径}         # 验证文件大小
     ```

5.   验证新文件：确认文件名中版本号与文件内修订记录一致

### 4. 晋升到 outputs/

```bash
bash .claude/scripts/promote-to-official.sh {项目路径} {文档名前缀}
```

脚本将：

-   若 `outputs/` 已有旧正式版 → 移动到 `history/`
-   将 `drafts/` 中的常规版本文件复制到 `outputs/`

> 注：脚本自动取 `drafts/` 中按文件名排序的最新文件，因此步骤 3 创建的新常规版本会被正确识别。

### 5. 清理 drafts 中的历史版本

晋升完成后，清理 drafts/ 中该文档的所有历史版本，仅保留最新的正式版本文件：

```bash
# 列出 drafts/ 中该文档的所有版本文件（按时间排序）
ls -t {项目路径}/drafts/{文档名前缀}_v*.md

# 保留最新文件（即刚创建的常规版本），删除其他所有历史版本
ls -t {项目路径}/drafts/{文档名前缀}_v*.md | tail -n +2 | xargs -r rm -v
```

**清理逻辑**：
- `ls -t` 按修改时间倒序排列（最新文件在最前）
- `tail -n +2` 跳过第一行（最新文件），输出其余所有历史版本
- `xargs -r rm -v` 删除这些历史文件，`-v` 显示删除的文件名，`-r` 确保列表为空时不执行
- 最终 drafts/ 中只保留最新的常规版本文件

**输出清理结果**：
```
已清理 drafts/ 历史版本：
  - {文档名前缀}_v0.10_R01@...md
  - {文档名前缀}_v0.10_R02@...md
  - {文档名前缀}_v0.11_R01@...md
  ...
保留最新版本：drafts/{文档名前缀}_{新版本号}@{时间戳}.md
```

### 6. 输出结果报告

```
---晋升完成---
文档：{文档名前缀}
操作：R 转常规版本号（{旧版本+R} → {新版本}）+ 晋升    ← R 版本时
      直接晋升（{版本号}）                               ← 已是常规版本时
新正式版：outputs/{文件名}
归档旧版：history/{旧文件名}（若无旧版则省略）
已清理 drafts/ 历史版本 {数量} 个，保留最新版本
```
