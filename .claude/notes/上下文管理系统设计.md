# 工作区上下文管理系统设计

> 版本：v0.1 | 日期：2026-02-28

---

## 1. 背景

### 1.1 问题描述

原系统在每次调用 doc-* skill 时自动加载文件。以 `/doc-write` 为例（最优化的 schema 模式）：

| 加载项                                             | 估算 tokens |
| -------------------------------------------------- | ----------- |
| 固定开销（系统 prompt + claude.md + 版本管理规则） | ~8,000      |
| 通用规范 schema × 4（C01/C02/C11/C99）             | ~4,860      |
| 领域规范 schema × 3（P01/P02/N00）                 | ~5,980      |
| 文档类型规范 schema（如 S02）                      | ~9,260      |
| 容量管理规范 + 主提示词 a01                        | ~11,600     |
| **合计基础开销**                                   | **~39,700** |

对于大型文档（如 02-宏观需求 ~114K tokens），加上上游文档（01-战略规划 ~115K tokens），单次会话开始即超出 200K 软基准。更严重的是：**用户对加载内容和容量消耗完全没有可见性**。

### 1.2 根本原因

-   加载决策由 AI 自动执行，无法按任务类型精细控制
-   每次 skill 调用重新加载所有规范，跨会话无复用
-   关联文档按类型规则自动加载，无视当前容量状态

---

## 2. 设计目标

1.   **用户显式控制**：所有文件加载由用户通过 `/load-*` 命令触发，无隐式默认加载
2.   **容量实时可见**：每次加载后显示估算 tokens 和容量占比，加载前可查询
3.   **最小基础开销**：无任务时仅保留固定系统开销（~8K tokens）
4.   **操作语义不变**：doc-* 命令的功能和输出格式保持不变，仅去掉自动加载步骤

---

## 3. 架构

### 3.1 核心变化对比

| 维度             | 旧系统             | 新系统              |
| ---------------- | ------------------ | ------------------- |
| 加载触发         | skill 调用时自动   | 用户显式 /load-*    |
| 容量可见性       | 无                 | 每次加载后即时显示  |
| claude.md 规模   | 140 行（~5KB）     | 28 行（~1KB）       |
| doc-* 前置条件   | 无（自动加载兜底） | 必须先 /load-target |
| 会话节省（典型） | 基准               | ~30,000 tokens/次   |

### 3.2 会话状态机制

每个 `/load-*` 命令执行后输出标准格式的加载确认标记：

```
[LOADED {type}] {路径} | ~{tokens} tokens
```

`type` 可取值：`target`、`outline`、`upstream`、`downstream`、`parallel`、`context`、`refs`、`layout`、`style`、`domain`、`spec`

doc-* 命令通过扫描会话历史中的 `[LOADED *]` 标记来：
-   验证先决条件是否满足（缺少则中止并提示）
-   获知哪些文件已在上下文中，无需重复读取
-   推断可用的规范和关联文档

### 3.3 容量阈值（以 200K 为软基准，1M 为硬兜底）

| 区间                 | 状态   | 建议行为                 |
| -------------------- | ------ | ------------------------ |
| < 120K（< 60%）      | ✅ 充裕 | 可继续加载               |
| 120K–160K（60%–80%） | ⚠️ 谨慎 | 避免加载大文档           |
| > 160K（> 80%）      | 🔴 紧张 | 停止加载，仅执行必要操作 |

---

## 4. 命令体系

### 4.1 加载命令（/load-*）

| 命令             | 参数格式           | 功能                                     |
| ---------------- | ------------------ | ---------------------------------------- |
| /load-target     | 文件路径（必填）   | 加载目标文档，标记为 target              |
| /load-outline    | 文件路径（必填）   | 加载大纲文件，标记为 outline             |
| /load-upstream   | 文件或目录（必填） | 加载上游文档（用户明确关系类型）         |
| /load-downstream | 文件或目录（必填） | 加载下游文档（用户明确关系类型）         |
| /load-parallel   | 文件或目录（必填） | 加载并行关联文档（用户明确关系类型）     |
| /load-context    | 文件或目录（必填） | 加载背景约束文档（用户明确关系类型）     |
| /load-refs       | 文件路径（必填）   | 加载参考材料（可注明用途），标记为 refs  |
| /load-layout     | 文件路径（必填）   | 排版格式规范（标题/列表/表格等视觉呈现） |
| /load-style      | 文件路径（必填）   | 语言风格+逻辑规范                        |
| /load-domain     | 文件或目录（必填） | 文档骨架/领域框架                        |
| /load-spec       | 文件或目录（必填） | 约束规范，AI读取后判断标记类型           |
| /load-relations  | 文件或目录（必填） | 关联文档，AI读取后判断关系类型           |

**目录模式说明**：`/load-upstream/downstream/parallel` 在目录模式下，需先有 `[LOADED target]` 以确定目标文档，再读取项目 `CLAUDE.md` 解析关联关系。

> **doc-write / doc-revise 内部自动加载**：执行时会自动读取 `.claude/rules/capacity-management.md`（始终）和 `.claude/rules/structure-constraints.md`（始终）；doc-revise 在一致性驱动时还会自动读取 `.claude/rules/association-rules.md`。这些文件无需用户手动 `/load-*`，但会计入会话 token 消耗。

### 4.2 状态查询命令

| 命令         | 功能                                       |
| ------------ | ------------------------------------------ |
| /load-status | 列出已加载文件清单、各自估算 tokens 及合计 |
| /cap-status  | 估算会话总体容量（已加载文件 + 对话开销）  |

### 4.3 doc-* 先决条件要求

| 命令         | 必须加载                    | 建议加载                                 |
| ------------ | --------------------------- | ---------------------------------------- |
| /doc-fix     | [target]                    | —                                        |
| /doc-review  | [target]                    | /load-layout、/load-style                |
| /doc-fmt     | [target]                    | /load-layout                             |
| /doc-write   | [target] 或 [outline]       | /load-domain、/load-upstream、/load-refs |
| /doc-revise  | [target]                    | /load-layout、/load-style、/load-refs    |
| /doc-align   | [target] + 至少一个关联文档 | —                                        |
| /doc-outline | 无强制要求                  | /load-spec、/load-upstream               |
| /doc-resume  | 无（自恢复）                | 自动加载工作文档                         |
| /doc-status  | 无                          | —                                        |
| /doc-init    | 无                          | —                                        |

---

## 5. Token 估算方法

-   **估算公式**：文件字节数 ÷ 3.5（中英混合内容经验值）
-   **估算精度**：±20%
-   **固定开销**：系统 prompt + 版本管理规则 + claude.md ≈ 6,500 tokens（~6-7K）
-   **对话开销**：约 500 tokens/轮，累计随会话增长

---

## 6. 约束与已知局限

| 局限                   | 说明                                           |
| ---------------------- | ---------------------------------------------- |
| 状态仅在会话内有效     | [LOADED] 标记不跨会话，新会话需重新 /load-*    |
| /unload-file 不可行    | Claude 上下文窗口只追加，已读入内容无法删除    |
| token 估算为近似值     | 实际计量以 Anthropic API 为准                  |
| 目录模式依赖 CLAUDE.md | /load-relations 目录模式需要项目已配置关联关系 |

---

## 7. 典型工作流

### 场景 A：局部快修（最小加载）

```
/load-target projects/ClariSphere/drafts/02-宏观需求_v0.12.md
/doc-fix 将第3章的"用例"统一改为"使用场景"
```

预计开销：~8K（固定）+ ~32K（目标文档）= **~40K tokens**

### 场景 B：规范驱动修订

```
/load-target projects/ClariSphere/drafts/02-宏观需求_v0.12.md
/load-layout specs/common/C01-排版规范_v0.10.md   ← 按需加载对应规范文件
/load-style  specs/common/C02-语言风格_v0.10.md
/cap-status               ← 确认容量（充裕）
/doc-revise 规范驱动修订，对标 C01/C02 要求
```

### 场景 C：一致性对齐（大文档需注意容量）

```
/cap-status               ← 会话初始容量确认
/load-target projects/ClariSphere/drafts/02-宏观需求_v0.12.md    ← ~32K
/load-upstream projects/ClariSphere/outputs/01-战略规划_v0.11.md  ← ~115K
/cap-status               ← 合计 ~155K（~77%）→ 接近 80%，停止加载
/doc-align
```

---

## 8. 迁移说明

-   **doc-* 调用方式不变**，但必须在调用前完成对应 /load-* 操作
-   原有自动加载逻辑已从所有 doc-* 命令中移除
-   项目 `CLAUDE.md` 和领域 `CLAUDE.md`（`specs/software/CLAUDE.md`）仍需维护，供 /load-relations 目录模式解析关联关系
